---
title: "Death Tests and Exception Assertions"
description: "API reference for tests that verify abnormal process termination, crashes, and exception handling. Explains macros and helpers for death tests and their safe usage in cross-platform environments."
---

# Death Tests and Exception Assertions

This page provides an in-depth API reference on how to write, use, and understand death tests and exception assertions in GoogleTest. These tests verify that code runs correctly when it aborts or terminates abnormally, ensuring your code's robustness against crashes and unrecoverable errors. It also explains how to assert correct exception behavior while maintaining safe, cross-platform test execution.

---

## Overview

Death tests verify that a piece of code causes the process to terminate, for example due to a failed assertion or explicit exit. Exception assertions check for thrown exceptions and their proper handling.

GoogleTest provides macros to write these test types safely across various platforms, with support for different death test styles and detailed diagnostics.

---

## Death Tests

A *death test* verifies that executing a statement causes the program to terminate in an expected manner, typically with a failure message matching a pattern or a specific exit code.

### Key Macros

- `EXPECT_DEATH(statement, matcher)` / `ASSERT_DEATH(statement, matcher)`

  Verifies that the statement terminates the process with a nonzero exit status and outputs to `stderr` a string matching `matcher`. `EXPECT_` allows subsequent tests to run, while `ASSERT_` aborts on failure.

- `EXPECT_DEATH_IF_SUPPORTED(statement, matcher)` / `ASSERT_DEATH_IF_SUPPORTED(statement, matcher)`

  Same semantics as above, but if death tests are not supported on the platform, they are disabled gracefully.

- `EXPECT_DEBUG_DEATH(statement, matcher)` / `ASSERT_DEBUG_DEATH(statement, matcher)`

  Asserts death in debug builds; in release builds the statement executes normally without asserting.

- `EXPECT_EXIT(statement, predicate, matcher)` / `ASSERT_EXIT(statement, predicate, matcher)`

  Verifies the program terminates with an exit status satisfying the given `predicate` (e.g., exited with a specific code or killed by a signal), and outputs matching `matcher`.

### Using Death Test Matchers and Predicates

- The `matcher` parameter can be a regular expression string or a gMock matcher matching the `stderr` output.
  - Bare string regex uses a restricted syntax subset compatible across platforms.

- Common exit status predicates provided by GoogleTest:
  - `ExitedWithCode(exit_code)`: checks the process exited normally with the given exit code.
  - `KilledBySignal(signal_number)`: checks the process was terminated by the given signal (POSIX only).

### Best Practices and Behavior

- Death tests run the tested code in a child process to isolate the effects of process termination.
- Two styles of death tests can be selected using the `--gtest_death_test_style` flag:
  - `fast`: simpler, faster fork-then-run style.
  - `threadsafe`: more robust style that re-executes the test binary in the child process to avoid thread-safety hazards.
- If a statement in a death test returns or throws an exception, it is considered a failure as the process did not end as expected.
- Side effects inside a death test are isolated from the parent process.

### Example

```cpp
TEST(FooDeathTest, DiesOnInvalidInput) {
  // Verify that calling Process(-1) causes the program to die
  // with an error message matching the regex "Invalid input".
  EXPECT_DEATH(Process(-1), "Invalid input");
}

TEST(FooDeathTest, ExitsWithZeroCode) {
  EXPECT_EXIT(QuickExit(), testing::ExitedWithCode(0), "success");
}
```

### Common Pitfalls

- Ensure the death test statement does not use `return` or throw.
- Mock objects leaked during death tests can cause false errors — use `Mock::AllowLeak()` if needed.
- Only one death test can appear per line due to implementation constraints.
- Confirm the test binary is invoked by a path containing directory separators for threadsafe death tests.
- Be mindful of threads: death tests emit warnings if multiple threads are detected at test start.

---

## Exception Assertions

GoogleTest supports assertions to verify whether code throws exceptions as expected.

### Key Macros

- `EXPECT_THROW(statement, exception_type)` / `ASSERT_THROW(statement, exception_type)`

  Verifies that `statement` throws an exception of the specified type.

- `EXPECT_ANY_THROW(statement)` / `ASSERT_ANY_THROW(statement)`

  Verifies that `statement` throws any exception.

- `EXPECT_NO_THROW(statement)` / `ASSERT_NO_THROW(statement)`

  Verifies that `statement` does not throw any exception.

### Behavior

- These macros support compound statements.
- When exceptions escape death test macros, it is considered a failure.
- When `catch_exceptions` flag is enabled (default), exceptions are caught and reported as failures.
- Special handling exists on Windows for SEH exceptions.

### Example

```cpp
TEST(ExceptionDeathTest, ReportsThrownExceptions) {
  EXPECT_NONFATAL_FAILURE(
      EXPECT_DEATH(throw std::runtime_error("fail"), ""),
      "threw an exception");
}

class MyException : public std::exception {
 public:
  const char* what() const noexcept override { return "special message"; }
};

TEST(ExceptionDeathTest, PrintsExceptionMessages) {
  EXPECT_NONFATAL_FAILURE(
      EXPECT_DEATH(throw MyException(), ""),
      "special message");
}
```

---

## Under the Hood: How Death Tests Work

GoogleTest implements death tests by spawning subprocesses and monitoring their exit status and `stderr` output.

### Platform Specifics

- On POSIX systems, typically fork or clone is used to create the child process.
- On Windows, child processes are launched via `CreateProcess` and re-execute the test binary.
- GoogleTest uses pipes or other OS-specific IPC to communicate status and error messages between child and parent.

### Reporting and Diagnostics

- The test framework captures the child process's standard error output.
- It interprets exit status codes and signals to determine test success.
- Detailed failure messages include whether the tested statement did not die, returned unexpectedly, threw exceptions, or died without matching expected messages.

### Internal API

The core abstraction is the `DeathTest` interface providing:

- `AssumeRole()` to differentiate between parent and child processes.
- `Wait()` to wait for test completion and get exit status.
- `Passed()` to verify whether the test succeeded based on status and output.
- `Abort()` to signal test failures like illegal returns or uncaught exceptions.

The factory `DefaultDeathTestFactory` creates platform-appropriate `DeathTest` implementations.

For detailed internal mechanics, see [`gtest-death-test.h`](https://github.com/google/googletest/blob/main/googletest/include/gtest/gtest-death-test.h) and [`gtest-death-test.cc`](https://github.com/google/googletest/blob/main/googletest/src/gtest-death-test.cc).

---

## Troubleshooting Death Tests

### Common Issues

- Death tests silently failing due to missing proper path to the test executable in threadsafe mode.
- Warnings about multi-threaded environment; consider using `threadsafe` death test style or test isolation.
- Mismatched expected output regex causing test to fail.
- Unexpected exits due to premature return or exceptions inside the death test statement.

### Tips

- Use `ASSERT_EXIT` with custom predicates to refine exit status matching.
- Stream additional messages to death test assertions for richer diagnostics.
- Use `EXPECT_DEATH_IF_SUPPORTED` to maintain cross-platform compatibility.

---

## Related Assertions

GoogleTest also provides rich assertion macros to aid in writing expressive tests:

- See the [Assertions Reference](reference/assertions.md#death) for full details on death assertions and others.
- Exception assertions are documented at [Exception Assertions](reference/assertions.md#exceptions).
- Learn about [Catch Failures](docs/advanced.md#catching-failures) for verifying expected failure behavior.

---

## Summary

Death tests empower you to verify that your code properly terminates upon fatal errors, and exception assertions let you check for correct exception throwing. Together, they help boost the reliability and robustness of your C++ applications using GoogleTest.

Use the provided macros carefully, taking advantage of platform-specific styles, predicates, and matchers. Leverage the detailed diagnostic feedback on failure to quickly resolve issues.

---

## Additional Resources

- [GoogleTest Primer](docs/primer.md) — beginner-friendly introduction.
- [Death Tests Guide](guides/gtest-core-workflows/death-tests.md) — tutorial with examples.
- [Assertions Reference](reference/assertions.md) — comprehensive coverage of assertion macros.
- [Advanced GoogleTest Topics](docs/advanced.md#death-tests) — deep dive on death tests and related features.
- GoogleTest source code:
  - [`gtest-death-test.h`](https://github.com/google/googletest/blob/main/googletest/include/gtest/gtest-death-test.h)
  - [`gtest-death-test.cc`](https://github.com/google/googletest/blob/main/googletest/src/gtest-death-test.cc)

---

<AccordionGroup title="Death Test Workflow">
<Accordion title="How Death Test Macros Work Internally">
When a death test macro like `EXPECT_DEATH` is invoked, GoogleTest:

1. Checks for multiple active threads and warns if applicable.
2. Creates a child process using fork/clone or equivalent.
3. In `fast` style, the child executes the death test statement directly after fork.
4. In `threadsafe` style, the child re-executes the entire test binary but runs only the targeted death test.
5. The parent waits for the child termination, reads the status and captures child's stderr.
6. Determines if the test passed by matching exit code and stderr output.
7. Reports success or failure to the user with detailed diagnostics.
</Accordion>
<Accordion title="Best Practices for Writing Death Tests">
- Use `EXPECT_DEATH` and `ASSERT_DEATH` to verify abnormal termination.
- Use compound statements to group code when needed.
- Avoid side effects that depend on surviving the death test.
- When testing exit codes, prefer `EXPECT_EXIT` with appropriate predicates.
- Name your death test suites with the suffix `DeathTest` to help GoogleTest reorder tests.
- Set the flag `--gtest_death_test_style=threadsafe` for safer execution in multi-threaded programs.
- Use `EXPECT_DEATH_IF_SUPPORTED` to write portable tests.
</Accordion>
</AccordionGroup>

<AccordionGroup title="Exception Assertions Details">
<Accordion title="Capturing Exceptions in Death Tests">
When `catch_exceptions` is enabled, exceptions thrown inside death test statements are caught and cause the death test to detect failure rather than propagate the exception outside.

This ensures death tests report exceptions appropriately without crashing the test framework.
</Accordion>
<Accordion title="Using Exception Assertion Macros">
- Use `EXPECT_THROW` and `ASSERT_THROW` to validate that code throws a specific exception.
- Use `EXPECT_ANY_THROW` and `ASSERT_ANY_THROW` to validate that code throws any exception.
- Use `EXPECT_NO_THROW` and `ASSERT_NO_THROW` to ensure code does not throw.
- You can test compound statements within these macros.
</Accordion>
</AccordionGroup>

<AccordionGroup title="Common Issues and Warnings">
<Accordion title="Warning: Multiple Threads Active">
Death tests are safest when only one thread is active. If multiple threads exist, GoogleTest logs a warning as `fork()` and `clone()` are not thread-safe and can result in deadlocks or hangs.

Consider initializing threads after main or use `threadsafe` death test mode.
</Accordion>
<Accordion title="Failure Due to Message Mismatch">
If the death test stderr output does not match the provided regex, the test fails.

Verify the regex syntax and adjust to match expected output.
</Accordion>
<Accordion title="Death Test Unexpected Return or Life">
If the tested statement returns instead of dying, or if the process lives through it, the test fails.

Ensure the tested code aborts or exits the process.
</Accordion>
<Accordion title="Handling Mock Leaks in Death Tests">
Mocks may be leaked in death tests due to forced process termination. Mark them allowable leaks with `Mock::AllowLeak` if this arises.
</Accordion>
</AccordionGroup>

<Info>
Death tests spawn child processes and thus have some overhead. Use judiciously for crucial failure-path testing.
</Info>

---

## Diagram: Death Test Process Flow

```mermaid
flowchart TD
  Start([Start Death Test]) --> CheckThreads{Number of Threads > 1?}
  CheckThreads -->|Yes| WarnThreads[Log Warning About Threads]
  WarnThreads --> ForkChild[Create Child Process: fork()/clone() or CreateProcess()]
  CheckThreads -->|No| ForkChild

  ForkChild --> DeathTestStyle{Death Test Style}
  DeathTestStyle -->|fast| ExecuteFast[Child Executes Test Immediately]
  DeathTestStyle -->|threadsafe| ExecuteThreadsafe[Child Re-executes Test Binary]

  ExecuteFast --> ChildExit[Child Terminates]
  ExecuteThreadsafe --> ChildExit

  ChildExit --> ParentWait[Parent Waits for Child Exit]
  ParentWait --> ReadStatus[Read Child Exit Status & Stderr]
  ReadStatus --> CheckExit[Exit Status Matches Expectation?]
  CheckExit -->|No| FailExit[Test Fails: Exit Code Mismatch]
  CheckExit -->|Yes| CheckOutput[Does Output Match Regex?]
  CheckOutput -->|No| FailOutput[Test Fails: Output Mismatch]
  CheckOutput -->|Yes| Pass[Test Passes]

  FailExit & FailOutput --> ReportFailure[Report Detailed Failure Message]
  ReportFailure --> End([End])
  Pass --> End

  classDef decision fill:#f9f,stroke:#333,stroke-width:2px;
  class CheckThreads,DeathTestStyle,CheckExit,CheckOutput decision;
```

---

## Code Examples

<CodeGroup>
```cpp
// Simple ASSERT_DEATH example
TEST(FooDeathTest, TerminatesOnBadInput) {
  ASSERT_DEATH(Foo::DoBadThing(-1), "Expected failure message");
}
```
```python
# Python example using ctypes to trigger a death test
import ctypes
import unittest

class FooDeathTest(unittest.TestCase):
    def test_death(self):
        with self.assertRaises(SystemExit):
            ctypes.CDLL('libfoo.so').DangerousFunction(-1)
```
</CodeGroup>

<Note>
Remember that death tests spawn subprocesses; side effects will not be visible outside the test code.
</Note>

---

## Troubleshooting Tips

- Always confirm your death test regular expressions use supported syntax.
- Use `--gtest_death_test_style=threadsafe` if encountering hangs or deadlocks.
- For flaky deaths, ensure no other threads interfere and cleaned up correctly.
- Avoid multiple death tests on the same source file line.

---

## Summary

Death tests in GoogleTest let you confidently verify that critical code aborts as expected, improving test coverage for fatal failures. Exception assertions complement this by verifying proper exception handling.

They provide powerful macros, style flags, predicates, and matching options to tailor testing to your needs across platforms. Leverage these tools to build robust and reliable C++ codebases.

For complete information, consult the related Assertion macros reference and working guides.

---

## Related Links

- [Assertions Reference: Death Assertions](reference/assertions.md#death)
- [Assertions Reference: Exception Assertions](reference/assertions.md#exceptions)
- [Advanced GoogleTest Topics: Death Tests](docs/advanced.md#death-tests)
- [Guides: Writing Death Tests](guides/gtest-core-workflows/death-tests.md)
- [GoogleTest Primer](docs/primer.md)
- [GoogleTest Source on Death Tests](https://github.com/google/googletest/tree/main/googletest/include/gtest)

---

## Navigation

This page is part of Advanced Features documentation and fits within the following navigation hierarchy:

- API Reference > Advanced Features and Platform Integration > Death Tests and Exception Assertions
- Guides > GoogleTest Core Workflows > Death Tests: Testing for Expected Failures

Explore other parts of the documentation for building test suites, using assertions, and real-world integration for a comprehensive testing experience.
