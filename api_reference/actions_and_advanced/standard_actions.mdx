---
title: "Standard and Custom Actions"
description: "Comprehensive guide to built-in actions—such as Return, Throw, SetArgReferee, Invoke—and instructions for defining reusable custom actions. Illustrates their role in shaping mock method return behaviors and side effects."
---

# Standard and Custom Actions

Actions in GoogleMock define what happens when a mock function is invoked. They specify the behavior or side effects that the mock should perform upon being called. This documentation provides a comprehensive guide to the standard set of built-in actions and the ways users can define their own custom actions.

All actions reside in the `::testing` namespace.

---

## Built-in Actions Overview

GoogleMock offers a rich set of pre-defined actions for common scenarios, including:

- Returning values or references
- Setting output argument values or pointers
- Throwing exceptions
- Invoking real functions or methods
- Composite actions combining multiple steps

These actions empower you to precisely control what your mock methods do, shaping the behavior of your test doubles with clarity and precision.

---

## Returning a Value

Mock methods commonly return values. GoogleMock supports various actions to specify what is returned.

| Action                     | Description                                                                                           |
|----------------------------|---------------------------------------------------------------------------------------------------|
| `Return()`                 | Returns from a `void` mock function (no value).
| `Return(value)`            | Copies and returns `value`. The value is converted to the mock function's return type - this conversion happens at the time the action is created, not when invoked.
| `ReturnArg<N>()`           | Returns the `N`-th (0-based) argument passed to the mock method.
| `ReturnNew<T>(...)`        | Returns a pointer to a new heap-allocated object of type `T`, constructed with the specified arguments each time the action is invoked.
| `ReturnNull()`             | Returns a null pointer.
| `ReturnPointee(ptr)`       | Returns the value pointed to by `ptr`.
| `ReturnRef(variable)`      | Returns a reference to `variable`. Useful when the mock method return type is a reference.
| `ReturnRefOfCopy(value)`   | Returns a reference to a **copy** of `value`. The copy is owned by the action and its lifetime matches that of the action.
| `ReturnRoundRobin({v1,...,vn})` | Returns successive elements from the provided collection in order, looping back to the start after the last element.

### Example: Returning Different Values Sequentially

```cpp
using ::testing::Return;
EXPECT_CALL(mock_obj, GetValue())
    .WillOnce(Return(100))
    .WillOnce(Return(200))
    .WillRepeatedly(Return(300));
```

The above specifies that: calls 1 and 2 return 100 and 200 respectively; from the third call onward, 300 is returned.

---

## Actions for Side Effects

Sometimes the effect of a mock method is not its return value, but its effect on arguments or global state. GoogleMock provides actions to model these effectively.

| Action                              | Description                                                                                      |
|-----------------------------------|------------------------------------------------------------------------------------------------|
| `Assign(&var, value)`              | Assigns `value` to the variable pointed to by `var`.
| `DeleteArg<N>()`                   | Deletes the `N`-th (0-based) argument; the argument must be a pointer.
| `SaveArg<N>(pointer)`              | Copies the `N`-th argument into `*pointer`.
| `SaveArgByMove<N>(pointer)`        | Moves the `N`-th argument into `*pointer`.
| `SaveArgPointee<N>(pointer)`       | Copies the value pointed to by the `N`-th argument into `*pointer`.
| `SetArgReferee<N>(value)`          | Assigns `value` to the variable referenced by the `N`-th argument (argument must be a reference).
| `SetArgPointee<N>(value)`          | Assigns `value` to the variable pointed to by the `N`-th argument.
| `SetArrayArgument<N>(first, last)`| Copies elements from the range `[first, last)` into the array or iterator pointed to by the `N`-th argument.
| `SetErrnoAndReturn(error, value)` | Sets the global `errno` to `error` and returns `value`.
| `Throw(exception)`                 | Throws the specified exception. Requires exceptions to be enabled.

### Example: Setting Output Value

```cpp
using ::testing::SetArgPointee;
EXPECT_CALL(mock_obj, Mutate(_, _))
    .WillOnce(SetArgPointee<1>(42));
```

Here, when `Mutate()` is called, the second argument (index 1) is set to 42.

---

## Invoking Real Functions, Methods, or Callables

You can specify actions that forward calls to real functions or methods, or invoke any callable.

| Action                                  | Description                                                                                                                |
|---------------------------------------|----------------------------------------------------------------------------------------------------------------------------|
| `f`                                   | Invokes a free function, functor, or lambda `f` with the mock arguments.
| `Invoke(f)`                           | Invokes function or functor `f` passing the mock's arguments.
| `Invoke(object_ptr, &Class::method)` | Invokes a member method on the given object, passing the mock's arguments.
| `InvokeWithoutArgs(f)`                | Invokes `f` without forwarding any arguments.
| `InvokeWithoutArgs(object_ptr, &Class::method)` | Invokes a method without arguments on the specified object.
| `InvokeArgument<N>(args...)`          | Invokes the `N`-th argument (which must be a callable) with supplied `args...`.

### Example: Using Invoke to Call a Helper Function

```cpp
using ::testing::Invoke;
EXPECT_CALL(mock_obj, Compute(_, _))
    .WillOnce(Invoke(ActualComputeFunction));
```

This routes the call to `Compute` to `ActualComputeFunction` during the test.

---

## Default and Composite Actions

### DoDefault()

Performs the default action for the mock method, as specified by `ON_CALL()` or the built-in default. Cannot be used inside composite actions.

### Composite Actions

These allow combining multiple actions to perform sequentially.

| Action                    | Description                                                                                     |
|---------------------------|------------------------------------------------------------------------------------------------|
| `DoAll(a1, a2, ..., an)`  | Performs actions `a1` through `an` in order each call, returning the result of the last action. The first `n-1` sub-actions must return void.
| `IgnoreResult(a)`         | Performs action `a` but ignores its result. Useful when `a` returns a value but a `void` action is required.
| `WithArg<N>(a)`           | Passes the `N`-th argument to action `a` and performs it.
| `WithArgs<N1, N2, ..., Nk>(a)` | Passes selected arguments to action `a` and performs it.
| `WithoutArgs(a)`          | Performs action `a` without any arguments.

### Example: Using `DoAll`

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;

EXPECT_CALL(mock_obj, Compute(_))
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)));
```

This sets the first argument to 10 and returns `true`.

---

## Defining Custom Actions

If built-in actions do not meet your needs, you can create custom actions in several ways.

### Using ACTION* Macros

You can define simple or parameterized actions at namespace scope using macros:

- `ACTION(name) { /* statements */ }` — Defines an action named `name()`.
- `ACTION_P(name, param) { /* statements */ }` — Defines an action `name(param)`.
- Similarly, `ACTION_P2`, ..., `ACTION_P10` allow multiple parameters.

Inside the action body, you can refer to:

- Mock function arguments as `arg0`, `arg1`, ..., and their types as `arg0_type`, `arg1_type`, ...
- The whole argument tuple as `args` and its type as `args_type`.
- The mock function type as `function_type`.
- The return type as `return_type`.

Example:

```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}
EXPECT_CALL(mock_obj, ...).WillOnce(IncrementArg1());
```

### Implementing ActionInterface

For more control and stronger typing, implement `::testing::ActionInterface<F>` for the mock function type `F`. Implement the `Perform(const ArgumentTuple& args)` method where you write the action logic.

Example:

```cpp
class IncrementArgAction : public ::testing::ActionInterface<int(int*)> {
 public:
  int Perform(const std::tuple<int*>& args) override {
    int* p = std::get<0>(args);
    return ++(*p);
  }
};

::testing::Action<int(int*)> IncrementArg() {
  return ::testing::MakeAction(new IncrementArgAction);
}
```

### Creating Polymorphic Actions

If your action should be usable with different mock function types, write a polymorphic implementation class with a templated `Perform<Result>(const ArgumentTuple& args)` method and convert it into a polymorphic action using `MakePolymorphicAction()`.

Example:

```cpp
class ReturnSecondArgumentAction {
 public:
  template <typename Result, typename ArgumentTuple>
  Result Perform(const ArgumentTuple& args) const {
    return std::get<1>(args);
  }
};

auto ReturnSecondArgument() {
  return ::testing::MakePolymorphicAction(ReturnSecondArgumentAction());
}
```

Use it in tests:

```cpp
EXPECT_CALL(mock_obj, Func(_, _)).WillOnce(ReturnSecondArgument());
```

---

## Practical Tips and Best Practices

- Prefer built-in actions for simplicity and performance.
- Use `DoAll` to combine side effects and returns.
- If returning references, use `ReturnRef` instead of `Return`.
- Use `Invoke` and its variants to call real code.
- `Throw(exception)` is handy to simulate exceptions in mock calls.
- Avoid using `DoDefault()` inside composite actions as it induces runtime errors.
- When defining custom actions with `ACTION*` macros, ensure they are at the namespace scope.
- Use `SetArgPointee` and `SetArgReferee` to mock output arguments.
- Sharing actions with state among multiple expectations leads to shared state; consider if this is desired.
- Move-aware actions can use rvalue-qualified call operators and are compatible with `WillOnce`.

---

## Troubleshooting Common Pitfalls

- Using `Return` with move-only objects in `WillRepeatedly` causes runtime errors - prefer lambda actions.
- Using `DoDefault()` inside `ON_CALL` leads to failures; it's only allowed in `EXPECT_CALL`.
- Passing references or pointers to temporary objects in `ReturnRef` or `ReturnPointee` can lead to dangling references.
- `SetArgPointee<N>()` alone does not specify a return value; combine it with `DoAll` and `Return`.
- For overloaded mock methods, disambiguate actions and expectations carefully.

---

## Example Usage

```cpp
using ::testing::Return;
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Invoke;
using ::testing::Throw;

class MockFoo {
 public:
  MOCK_METHOD(int, Compute, (int input, int* output), (override));
};

TEST(FooTest, ComputeBehavesAsExpected) {
  MockFoo mock;

  // When Compute is called, set output to 42 and return 10.
  EXPECT_CALL(mock, Compute(_, _))
      .WillOnce(DoAll(SetArgPointee<1>(42), Return(10)));

  int output = 0;
  EXPECT_EQ(10, mock.Compute(5, &output));
  EXPECT_EQ(42, output);

  // Throw an exception on subsequent calls.
  EXPECT_CALL(mock, Compute(_, _))
      .WillRepeatedly(Throw(std::runtime_error("Error")));

  EXPECT_THROW(mock.Compute(1, &output), std::runtime_error);
}

// Define a custom action to multiply first argument by a parameter.
ACTION_P(MultiplyBy, factor) {
  return arg0 * factor;
}

TEST(FooTest, MultiplyByAction) {
  MockFoo mock;
  EXPECT_CALL(mock, Compute(_, _))
      .WillOnce(MultiplyBy(5));

  int output = 0;
  // Ignores second argument, returns first argument multiplied by 5.
  EXPECT_EQ(15, mock.Compute(3, &output));
}
```

---

## Summary

This document covers GoogleMock's built-in actions and how to define custom ones, crucial for shaping the behavior and side effects of mock methods in tests. It explains actions related to return values, side effects, invocation of real functions, default and composite actions, and advanced custom action definitions.

For a practical and efficient use of GoogleMock, understanding and employing these actions empowers you to express complex mocking behavior succinctly and correctly.

---

# Additional Resources

- [gMock for Dummies](../gmock_for_dummies.md) — for introductory concepts
- [Actions Reference](../reference/actions.md) — tabular quick guide
- [gMock Cookbook](../gmock_cook_book.md#QuickNewActions) — practical recipes
- [Mocking Reference](../reference/mocking.md) — for `EXPECT_CALL` and related
- [Writing New Actions](../googletest-guides/advanced-testing-patterns/mocking-techniques.md#Writing-New-Actions)

---

# See Also

- `EXPECT_CALL` and `ON_CALL` for setting expectations and default behaviors ([Mocking Reference](../reference/mocking.md#EXPECT_CALL))
- `MOCK_METHOD` macros for defining mock methods ([Mock Method Macros](../api_reference/mocking_core/mock_method_macros))
- Matchers for argument matching ([Matchers Reference](../api_reference/matchers_assertions/builtin_matchers))

---