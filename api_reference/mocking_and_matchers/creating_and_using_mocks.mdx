---
title: "Creating and Using Mocks"
description: "API details and usage guide for declaring mock classes and methods using MOCK_METHOD, controlling constness, noexcept, and other C++ signatures. Shows integration with GoogleTest and outlines mock object lifecycles and behaviors."
---

# Creating and Using Mocks

This documentation page provides a comprehensive reference and practical guide for defining mock classes and methods using GoogleMock's `MOCK_METHOD` macro. It covers the syntax, qualifiers, handling complex method signatures, lifecycle of mock objects, and integration with GoogleTest. Users will gain a thorough understanding of how to declare mocks, control method behaviors, and leverage advanced features like constness, `noexcept`, calling conventions, and reference qualifiers.

---

## Overview of Mock Classes in GoogleMock

Mock classes simulate the behavior of real classes, enabling controlled and observable interactions during testing. GoogleMock automates mock generation through macros, focusing on virtual methods but also allowing mocking of non-virtual methods through specialized patterns.

### Defining a Mock Class

To create a mock class:

1. Derive your mock from the interface or base class.
2. Use the `MOCK_METHOD` macro within the **public** section to declare mock methods corresponding to the methods you want to mock.
3. Include qualifiers that match the overridden method's signature (e.g., `const`, `override`, `noexcept`).

**Example:**
```cpp
class MockFoo : public Foo {
 public:
   MOCK_METHOD(int, GetSize, (), (const, override));
   MOCK_METHOD(std::string, Describe, (int type), (override));
};
```

> The destructor of the base class must be virtual for safe mocking.

---

## MOCK_METHOD Macro

The heart of mocking methods in GoogleMock is the `MOCK_METHOD` macro, which has the following syntax:

```cpp
MOCK_METHOD(ReturnType, MethodName, (ArgumentTypes...), (Qualifiers...));
```

### Parameters
- **ReturnType**: The return type of the method.
- **MethodName**: The method name as declared in the original class.
- **ArgumentTypes**: A parenthesized comma-separated list of argument types.
- **Qualifiers** (optional): A comma-separated list of specifiers affecting the method signature.

### Supported Qualifiers
| Qualifier             | Description                                               |
|-----------------------|-----------------------------------------------------------|
| `const`               | Makes the mocked method a `const` method. Required to override `const` methods. |
| `override`            | Specifies that the method overrides a virtual method. Recommended for clarity and safety. |
| `noexcept`            | Marks method as `noexcept`. Required when overriding `noexcept` methods. |
| `Calltype(...)`       | Sets call type (e.g., `Calltype(STDMETHODCALLTYPE)`) for non-standard calling conventions. Useful on Windows. |
| `ref(&)` or `ref(&&)` | Specifies reference qualifier when overriding methods with ref qualifiers. |

### Handling Commas in Types
When the return type or arguments contain commas (e.g., `std::pair<int, int>`), `MOCK_METHOD` needs extra parentheses around the complex type or the use of a type alias.

```cpp
// Incorrect - causes compilation error due to comma
MOCK_METHOD(std::pair<bool, int>, GetResult, ());

// Correct approaches:
MOCK_METHOD((std::pair<bool, int>), GetResult, ());
// or
using BoolIntPair = std::pair<bool, int>;
MOCK_METHOD(BoolIntPair, GetResult, ());
```

### Placement of MOCK_METHOD

Always place `MOCK_METHOD` declarations inside the public interface of a mock class regardless of the base class's access specifiers. This is necessary so that `ON_CALL` and `EXPECT_CALL` macros can refer to the mocked methods freely.

---

## Mocking Specific Method Types

### Const Methods
When mocking methods declared `const` in the base class, include the `(const)` qualifier:

```cpp
MOCK_METHOD(int, GetValue, (), (const, override));
```

### Overloaded Methods
Mock each overload separately with matching signatures and qualifiers:

```cpp
MOCK_METHOD(int, Add, (int x), (override));
MOCK_METHOD(int, Add, (int times, int x), (override));
MOCK_METHOD(const Bar&, GetBar, (), (const, override));
MOCK_METHOD(Bar&, GetBar, (), (override));
```

If you do not mock all overloads, use `using BaseClass::MethodName;` to bring the unmocked versions into scope to prevent hiding warnings.

### Methods with noexcept
Indicate `noexcept` if the original method has it:

```cpp
MOCK_METHOD(void, Process, (), (noexcept, override));
```

### Methods with Call Type
To handle special calling conventions (mostly for Windows COM interfaces):

```cpp
MOCK_METHOD(bool, Query, (int code), (Calltype(STDMETHODCALLTYPE), override));
```

### Reference Qualified Methods
Mock methods with lvalue or rvalue reference qualifiers allowing method resolution on references:

```cpp
MOCK_METHOD(void, RefLValueMethod, (), (ref(&), override));  // & qualifier
MOCK_METHOD(void, RefRValueMethod, (), (ref(&&), override)); // && qualifier
```

---

## Mocking Class Templates

Mock class templates just like regular classes:

```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

---

## Mocking Non-Virtual Methods

Though non-virtual methods cannot be mocked using polymorphic dispatch, GoogleMock supports mocking non-virtual methods for high-performance dependency injection by creating unrelated mock classes with matching methods:

```cpp
class ConcreteUser {
 public:
  void DoWork();
};

class MockUser {
 public:
  MOCK_METHOD(void, DoWork, (), ());
};
```

Call selection between real and mock implementation happens at compile time (e.g., via template specialization).

---

## Mocking Private and Protected Methods

Mock methods must always be declared `public` in the mock class, even if the original method is protected or private. This allows `ON_CALL` and `EXPECT_CALL` to access mocking infrastructure:

```cpp
class Foo {
 protected:
   virtual void Resume();
 private:
   virtual int GetTimeout();
};

class MockFoo : public Foo {
 public:
   MOCK_METHOD(void, Resume, (), (override));
   MOCK_METHOD(int, GetTimeout, (), (override));
};
```

---

## Mocking Free Functions

GoogleMock cannot directly mock free functions. To work around this:

- Create an interface class with virtual methods.
- Wrap calls to free functions in a concrete implementation of that interface.
- Mock the interface in tests.

```cpp
class FileInterface {
 public:
   virtual bool Open(const char* path, const char* mode) = 0;
};

class File : public FileInterface {
 public:
   bool Open(const char* path, const char* mode) override {
     return OpenFile(path, mode);  // Free function call inside.
   }
};
```

Alternatively, use `std::function` injection with `MockFunction` helper classes.

---

## Mock Lifecycle and Behaviors

### Setting Expectations and Default Actions

- `EXPECT_CALL(mock, Method(...))` sets an expectation and optionally behavior for calls.
- `ON_CALL(mock, Method(...))` sets default behavior but does not imply any expectation on calls.

Use `EXPECT_CALL` sparsely to verify behavior and prefer `ON_CALL` to specify default mock responses.

### Nice, Naggy, and Strict Mocks

Mock objects can have different severity levels for uninteresting calls:

| Mock Type        | Behavior on Calls without Expectations                   |
|------------------|----------------------------------------------------------|
| **NiceMock<T>**  | Suppresses warnings on uninteresting calls.              |
| **NaggyMock<T>** | Default behavior; warns on uninteresting calls.          |
| **StrictMock<T>**| Treats uninteresting calls as test failures.             |

Example of using a nice mock:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_foo;
EXPECT_CALL(nice_foo, DoThis());
nice_foo.DoThis();
```

### Verifying Mock Expectations

The mock object automatically verifies all expectations when it is destructed. To verify earlier or if the mock object might live outside the test scope, use:

```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(&mock_obj));
```

### Allowing Leaked Mocks

Inform GoogleMock that a mock object may be deliberately leaked to avoid failure on exit:

```cpp
::testing::Mock::AllowLeak(&mock_obj);
```

---

## Best Practices and Tips

- Use type aliases or extra parentheses to handle complex types with commas in `MOCK_METHOD`.
- Always declare `MOCK_METHOD` in `public` regardless of original method access modifiers.
- Prefer `override` qualifier in mocked methods for clarity and compiler checks.
- Use `NiceMock` during development to reduce noise, and switch to `StrictMock` for stricter verification once stable.
- Avoid mocking non-virtual methods unless necessary; prefer interfaces and dependency injection.
- When mocking overloaded methods, mock all overloads or bring unmocked ones into scope using `using`.
- If the mock class is large, consider moving constructor and destructor out-of-line to improve compile times.

---

## Sample Code

```cpp
#include <gmock/gmock.h>

class FooInterface {
 public:
   virtual ~FooInterface() {}
   virtual int Compute(int x) const = 0;
   virtual void Reset() = 0;
};

class MockFoo : public FooInterface {
 public:
   MOCK_METHOD(int, Compute, (int x), (const, override));
   MOCK_METHOD(void, Reset, (), (override));
};

// Usage in a test
TEST(FooTest, ComputeTest) {
   MockFoo mock;

   ON_CALL(mock, Compute).WillByDefault(::testing::Return(42));
   EXPECT_CALL(mock, Reset()).Times(1);

   // Code that uses mock
   EXPECT_EQ(mock.Compute(10), 42);
   mock.Reset();
}
```

---

## Troubleshooting

- **Compilation errors with commas:** Ensure complex return or argument types in `MOCK_METHOD` are wrapped in parentheses or aliased.
- **Overloaded method ambiguity:** Mock all overloads or bring unmocked overloads into scope.
- **Unexpected warnings about uninteresting calls:** Incorporate `EXPECT_CALL` or use `NiceMock` to suppress warnings.
- **Virtual destructor missing:** Always declare virtual destructors in interfaces to avoid undefined behavior in mocks.

---

## Related Documentation

- [Creating and Using Mocks Guide](https://google.github.io/googletest/gmock_cook_book.html#creating-mocks)
- [Mocking and Matchers API Reference](/api_reference/mocking_and_matchers/creating_and_using_mocks)
- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [gMock Matchers Reference](/api_reference/mocking_and_matchers/matchers_and_custom_matchers)
- [Mock Behavior Control](/guides/gmock-mocking-patterns/controlling-mock-behavior)
- [Mocking Best Practices](/guides/gmock-mocking-patterns/best-practices-mocking)


---

For detailed examples and advanced patterns, including delegation to real or fake objects, managing expectations with sequences and cardinalities, and integration tips, please consult the gMock Cookbook and the Mocking Reference sections linked above.
