---
title: "Actions and Return Values"
description: "Explains how to use and define actions to control mock method responses, side effects, and sequencing. Includes documentation on ACTION and ACTION_TEMPLATE macros and common return value patterns."
---

# Actions and Return Values

This page explains how to use and define **actions** in GoogleMock to precisely control the behavior of mock methods. Actions allow you to specify the response, side effects, sequencing, and return values that a mock function should produce when it is called during tests.

This guide covers the use of the `ACTION` and `ACTION_TEMPLATE` macros for defining custom actions, the common built-in actions for return values and side effects, and practical patterns for combining actions with expectations.

---

## Understanding Actions in GoogleMock

When you write a test with mocks, actions define *what happens* when a mock method is invoked:

- What value is returned?
- What side effects take place?
- Which functions or functors get called?

You specify actions primarily through the `WillOnce()`, `WillRepeatedly()`, and `WillByDefault()` clauses linked to `EXPECT_CALL()` or `ON_CALL()` statements.

Actions are function objects or lambdas that match the signature of the mocked method. You can use built-in actions, provide your own lambdas, or define reusable actions via the `ACTION` macros.

---

## Built-in Actions for Return Values and Side Effects

GoogleMock provides many common actions out of the box to return values, modify arguments, invoke callbacks, and more.

### Returning Values

| Action                  | Description                                  |
|-------------------------|----------------------------------------------|
| `Return()`              | Return from a `void` function (no value).     |
| `Return(value)`         | Return the specified value.                    |
| `ReturnArg<N>()`        | Return the N-th argument (0-based) as value. |
| `ReturnNew<T>(args...)` | Return a new object allocated with `new T(...)`. |
| `ReturnNull()`          | Return a null pointer.                         |
| `ReturnPointee(ptr)`    | Return the value pointed to by `ptr`.         |
| `ReturnRef(variable)`   | Return reference to the specified variable.  |
| `ReturnRefOfCopy(value)`| Return a reference to a copy of `value`.     |
| `ReturnRoundRobin(...)` | Cycle through and return the values in a list on successive calls. |

### Side Effects

| Action                       | Description                                                                                     |
|------------------------------|-------------------------------------------------------------------------------------------------|
| `Assign(&var, value)`         | Assign `value` to `var`.                                                                        |
| `DeleteArg<N>()`             | Delete (delete operator) the N-th argument, which must be a pointer.                             |
| `SaveArg<N>(pointer)`         | Copy the N-th argument to the variable pointed by `pointer`.                                   |
| `SaveArgByMove<N>(pointer)`  | Move the N-th argument to the variable pointed by `pointer`.                                   |
| `SetArgReferee<N>(value)`    | Assign `value` to the variable referenced by the N-th argument.                                |
| `SetArgPointee<N>(value)`    | Assign `value` to the variable pointed to by the N-th argument.                               |
| `SetArrayArgument<N>(first, last)` | Copy values from [first, last) to the array pointed by the N-th argument.                    |
| `SetErrnoAndReturn(error, value)` | Set `errno` to `error` and return `value`.                                                  |
| `Throw(exception)`           | Throw the specified exception when the mock is called.                                         |

### Using Callables as Actions

You can supply functions, functors, or lambdas as actions:

- `f` directly invokes `f` with the mock function arguments.
- `Invoke(f)` invokes a function or functor `f` with the arguments.
- `Invoke(object_ptr, &Class::method)` calls a member function on an object.
- `InvokeWithoutArgs(f)` calls `f` with no arguments, ignoring mock arguments.
- `InvokeArgument<N>(args...)` invokes the N-th argument as a callable, passing it the provided arguments.

For callables that do not use all arguments, declare unused parameters as `Unused` to avoid warnings.

### Default Actions

- `DoDefault()` runs the default behavior of the mocked function (either specified via `ON_CALL()` or the built-in default). Note: `DoDefault()` cannot be used inside composite actions.

### Composite Actions

GoogleMock provides utilities to chain or modify actions:

- `DoAll(a1, a2, ..., an)` runs all actions in the list sequentially and returns the result of `an`. The first n-1 must return void.
- `IgnoreResult(a)` runs action `a` but ignores its return value (useful for calling an action returning a value in a void context).
- `WithArg<N>(a)` runs action `a` with the N-th argument of the mock function.
- `WithArgs<N1, N2, ...>(a)` runs action `a` with multiple selected arguments.
- `WithoutArgs(a)` runs action `a` with no arguments.

---

## Defining Custom Actions

Sometimes the built-in actions are not enough. You can write custom actions via macros or by implementing interfaces:

### The `ACTION` Macro

Define a simple action:

```cpp
ACTION(Name) {
  // Use arg0, arg1, ... to access mock function arguments.
  // Return the value to be given back to the caller.
  return arg0 + arg1; // example: sum arguments
}
```

Example usage:

```cpp
EXPECT_CALL(mock, Sum(_, _))
    .WillOnce(Name());
```

Inside the macro body, these predefined symbols are available:

| Symbol           | Description                                    |
|------------------|-----------------------------------------------|
| `argK`           | Value of the K-th argument, zero-based index. |
| `argK_type`      | Type of the K-th argument.                     |
| `args`           | Tuple of all arguments.                        |
| `args_type`      | Type of the `args` tuple.                      |
| `return_type`    | Return type of the mock function.              |
| `function_type`  | Full mocked function type.                      |


### Parameterized Actions

If your action needs parameters, use `ACTION_P` or `ACTION_Pk` macros:

```cpp
ACTION_P(Plus, n) {
  return arg0 + n;
}

EXPECT_CALL(mock, Sum(_))
    .WillOnce(Plus(5));  // Returns arg0 + 5
```

Supports up to 10 parameters with macros `ACTION_P2`, `ACTION_P3`, ..., `ACTION_P10`.

### Template Actions: `ACTION_TEMPLATE`

If you need actions with explicit template parameters (e.g., types or integral constants that cannot be deduced from function arguments), use `ACTION_TEMPLATE`. 

Syntax:

```cpp
ACTION_TEMPLATE(ActionName,
                HAS_m_TEMPLATE_PARAMS(kind1, name1, ..., kind_m, name_m),
                AND_n_VALUE_PARAMS(p1, ..., p_n)) {
  // statements, can use template parameters and values
}
```

Example:

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(DuplicateArg<1, unsigned char>(&n));
```

### Important Notes on Defining Actions

- These macros *cannot* be used inside functions or classes; define them in a namespace scope.
- Custom actions must match the mock function signature.
- Use `argK`, `args`, and `return_type` appropriately.

---

## Practical Tips and Best Practices

- Use built-in actions whenever possible for readability and performance.
- For side effects that modify output arguments, e.g., use `SetArgPointee` or `SetArrayArgument`.
- Combine multiple actions using `DoAll`, returning a final value.
- Use lambdas or functors for complex or stateful behaviors.
- When mocking functions returning move-only types (e.g., `unique_ptr`), use `WillOnce` with appropriate lambdas or `Return(ByMove(...))`.
- Provide clear and maintainable actions by avoiding side effects in argument evaluation.
- Avoid duplicating actions shared across expectations unless state sharing is intended.
- Use sequences and expectation ordering (.InSequence(), .After()) to define ordered action execution when needed.

---

## Troubleshooting Common Issues

- **Action count mismatch warnings:** When specifying multiple `WillOnce` or `WillRepeatedly` clauses, ensure their count fits the expected number of calls or specify `Times` correctly.
- **Using `DoDefault()` inside composite actions:** `DoDefault()` cannot be nested inside `DoAll()` or similar; this results in runtime errors.
- **Uninteresting calls warnings:** Use `NiceMock` or explicitly expect calls with `.Times(AnyNumber())` to suppress warnings.
- **Incorrect return value:** Remember that `Return(value)` converts `value` at the time the expectation is set; use lambdas or `ReturnPointee` to use live data.
- **Compiling actions with move-only types:** For move-only types, prefer lambdas or actions that support rvalue-qualified operators.

---

## Example: Defining and Using a Custom ACTION

```cpp
#include <gmock/gmock.h>
using ::testing::ACTION;

// Defines an action that returns the sum of the first two arguments.
ACTION(SumFirstTwo) {
  return arg0 + arg1;
}

// In your test:
EXPECT_CALL(mock, Add(_, _)).WillOnce(SumFirstTwo());
```

## Example: Using ACTION_TEMPLATE

```cpp
#include <gmock/gmock.h>
using ::testing::ACTION_TEMPLATE;

ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

// In your test:
int extracted;
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(DuplicateArg<1, unsigned char>(&extracted));
```

---

## Summary

Actions provide an expressive and powerful way to dictate how mocks respond to method calls, enabling robust and precise unit tests that can return complex values, produce side effects, or invoke other functions. Understanding built-in actions, custom `ACTION` macros, and functional patterns is key to mastering GoogleMock mock behaviors.

---

## Further Reading

- [GoogleMock Cheat Sheet](../docs/gmock_cheat_sheet.md) for quick syntax reference
- [Mocking Reference](../docs/reference/mocking.md) for general mocking API details
- [Actions Reference](../docs/reference/actions.md) for comprehensive built-in actions
- [gMock Cookbook](../docs/gmock_cook_book.md) for practical usage recipes and advanced patterns
- [Using Matchers and Custom Actions Guide](../guides/mocking-advanced/matchers-and-actions.mdx) for integrating actions with argument matchers

---

## Related Pages in This Documentation Set

- **Defining and Using Mocks:** `/api_reference/mocking_api/defining_mocks`
- **Setting Expectations and Behaviors:** `/api_reference/mocking_api/expectations_and_behaviors`
- **Matchers Reference:** `/api_reference/mocking_api/matchers_reference`
- **Mock Class Modes (Nice, Strict, Naggy):** `/api_reference/mocking_api/strict_nice_mocks`

---