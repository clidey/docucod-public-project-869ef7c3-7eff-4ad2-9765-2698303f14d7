---
title: "Setting Expectations and Behaviors"
description: "Reference for ON_CALL, EXPECT_CALL, and related APIs to specify method call expectations, ordering, and response behaviors on mocks. Highlights assertion patterns and real test interaction setups."
---

# Setting Expectations and Behaviors

Reference for ON_CALL, EXPECT_CALL, and related APIs to specify method call expectations, ordering, and response behaviors on mocks. Highlights assertion patterns and real test interaction setups.

---

## Overview

In Google Mock, setting up **expectations** and **behaviors** on mock methods is essential to precisely control and verify how your mock objects interact with the code under test. This documentation covers the core APIs:

- `ON_CALL()` — to specify default behaviors without enforcing call expectations
- `EXPECT_CALL()` — to set expectations on method calls including argument matchers, call counts, call order, and responses

These facilities together form the foundation for defining fine-grained interaction specifications and robust unit tests.

---

## ON_CALL: Specifying Default Behaviors

Use `ON_CALL(mock_object, Method(matchers...))` to define the **default action** of a mock method, i.e., what happens when the method is called but no explicit expectation is set.

### Syntax:
```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);        // Required
```

- `.With()` restricts the default action to calls matching a tuple matcher on *all* arguments collectively.
- `.WillByDefault()` defines the behavior (return values, side effects, etc.) executed on matching calls.

### Important:

- `ON_CALL` does **not** create an expectation that the method will be called.
- If multiple `ON_CALL`s match a call, the **last one declared takes precedence**.
- Generally placed in test fixture setup to provide common default behaviors.

### Example:
```cpp
using ::testing::_;
using ::testing::Lt;
using ::testing::Return;

ON_CALL(my_mock, SetPosition(_, _))
    .With(Lt())
    .WillByDefault(Return(true));

// By default, calls to SetPosition where the first argument is less than the second return true.
```

---

## EXPECT_CALL: Defining Call Expectations

`EXPECT_CALL(mock_object, Method(matchers...))` defines an **expectation** that a method will be called with arguments matching specified matchers.

### Syntax:
```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // Optional, must be first clause
    .Times(cardinality)            // Optional, at most once
    .InSequence(sequences...)      // Optional, can appear multiple times
    .After(expectations...)        // Optional, can appear multiple times
    .WillOnce(action)              // Optional, can appear multiple times
    .WillRepeatedly(action)        // Optional, at most once
    .RetiresOnSaturation();        // Optional, at most once
```

### Clauses and Their Meaning

- **With**: Restricts matching to calls whose full argument tuple matches the supplied tuple matcher.

- **Times**: Specifies how many times the call is expected:

  | Cardinality         | Description                                       |
  | ------------------- | ------------------------------------------------|
  | `AnyNumber()`       | Any number of calls (including zero)             |
  | `AtLeast(n)`        | At least *n* calls                               |
  | `AtMost(n)`         | At most *n* calls                               |
  | `Between(m, n)`     | Between *m* and *n* calls (inclusive)           |
  | `Exactly(n)` or `n` | Exactly *n* calls (0 means must never be called) |

  If omitted, inferred based on presence of `WillOnce` and `WillRepeatedly`:
  - No `WillOnce`/`WillRepeatedly` → exactly one call
  - n `WillOnce`s, no `WillRepeatedly` → exactly n calls
  - n `WillOnce`s and one `WillRepeatedly` → at least n calls

- **InSequence**: Organizes expectations into one or more `Sequence` objects. Expectations within a sequence must be met in the order declared.

- **After**: Specifies prerequisite expectations or expectation sets, the current expectation must occur after all prerequisites are satisfied. Allows representing partial orders.

- **WillOnce**: Defines the behavior for the next call matching this expectation. Can be called multiple times to specify a specific sequence of return values, side effects, or actions.

- **WillRepeatedly**: Defines the behavior for all subsequent calls after `WillOnce` actions are exhausted.

- **RetiresOnSaturation**: Automatically retires the expectation when it reaches its upper call bound, preventing further matches.

### Best Practices

- Use `EXPECT_CALL` only when you want to verify that a call occurs.
- Use `_` (wildcard matcher) to ignore argument values.
- Combine `EXPECT_CALL` with `Times()` when you need precise cardinality enforcement.
- Use sequences or `After()` to enforce call order when relevant.

### Example:
```cpp
using ::testing::_, ::testing::Return, ::testing::Sequence;

Sequence s;
EXPECT_CALL(mock, Reset())
    .InSequence(s);
EXPECT_CALL(mock, GetSize())
    .InSequence(s);
EXPECT_CALL(mock, Describe())
    .InSequence(s)
    .WillOnce(Return("Mock object"));

// This sets the order: Reset(), then GetSize(), then Describe() with a return value.
```

---

## Additional Concepts

### Expectation and ExpectationSet

- An `Expectation` is a handle to a single mocked method call expectation created by `EXPECT_CALL`.
- `ExpectationSet` is a collection of expectations and can be used in `After()` to specify that an expectation depends on multiple prerequisite calls.

### Sequences and InSequence

- A `Sequence` object represents a partial order: expectations added to a sequence must be matched in the order added.
- The `InSequence` RAII helper creates an anonymous sequence that applies to all `EXPECT_CALL` statements within its scope.

### Uninteresting vs Unexpected Calls

- An **uninteresting call** occurs when a method with no matching `EXPECT_CALL` is invoked. By default, this emits a warning but permits the call.
- An **unexpected call** is a call to a method with expectations set, but with arguments that do not match any expectation. This results in a test failure.

### Mock Strictness Levels

- By default mocks are *naggy*: warn on uninteresting calls.
- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Use `StrictMock<T>` to treat uninteresting calls as failures.

### Default Actions and Overrides

- `ON_CALL` defines the default behavior invoked on calls not covered by `EXPECT_CALL` or when expectations are not matched.
- Actions specified in `EXPECT_CALL` (`WillOnce`, `WillRepeatedly`) take precedence over `ON_CALL` actions.

### Best Use of ON_CALL and EXPECT_CALL

- Use `ON_CALL` to define broad, common default behaviors.
- Use `EXPECT_CALL` sparingly to specify and verify key interactions.
- Avoid over-specifying expectations to prevent brittle tests.

---

## Common Usage Patterns with Examples

### Basic EXPECT_CALL with default return
```cpp
EXPECT_CALL(mock_obj, Foo(5))
    .WillOnce(Return(10));  // Return 10 only on first call.

// If called more than once, default action or WillRepeatedly is used.
```

### Setting expectations for multiple sequential returns
```cpp
EXPECT_CALL(mock_obj, Foo())
    .WillOnce(Return(100))
    .WillOnce(Return(200))
    .WillRepeatedly(Return(300));
```

### Restricting calls with `.With` on tuple matcher
```cpp
EXPECT_CALL(mock_obj, SetCoordinates(_, _))
    .With(Lt())  // Only calls where first arg < second arg
    .WillOnce(Return(true));
```

### Ordering calls with sequences
```cpp
Sequence s1, s2;
EXPECT_CALL(mock_obj, Init()).InSequence(s1);
EXPECT_CALL(mock_obj, Start()).InSequence(s1, s2);
EXPECT_CALL(mock_obj, Stop()).InSequence(s2);
```

### Using `.After` clause
```cpp
Expectation e1 = EXPECT_CALL(mock_obj, FooA());
Expectation e2 = EXPECT_CALL(mock_obj, FooB());
EXPECT_CALL(mock_obj, FooC()).After(e1, e2);
```

### Using `.RetiresOnSaturation` to auto-retire expectations
```cpp
EXPECT_CALL(mock_obj, GetNext())
    .Times(2)
    .RetiresOnSaturation()
    .WillRepeatedly(Return(42));
```

---

## Troubleshooting and Common Pitfalls

- **Uninteresting call warnings**: If you see warnings about uninteresting calls despite defining `ON_CALL` behaviors, consider if you should add an `EXPECT_CALL` or use `NiceMock` to silence irrelevant warns.
- **Too few or too many actions**: gMock warns when the number of `WillOnce` clauses does not match cardinality.
- **Order violations**: Verify that sequences and `.After()` clauses are correctly set; out-of-order calls cause failures.
- **Leaked mocks**: Mock objects must be deleted properly to ensure expectations are verified at destruction; use `Mock::AllowLeak()` if intentional.

---

## Related APIs

- [`MOCK_METHOD` macro](./defining_mocks.md#MOCK_METHOD) for defining mock methods.
- [Matchers Reference](./matchers_reference.md) for using argument matching in `EXPECT_CALL` and `ON_CALL`.
- [Actions and Return Values](./mock_actions_and_return_values.md) for defining function call behaviors.
- [Mock Class Strictness](./strict_nice_mocks.md) for controlling warnings and failure behavior on uninteresting calls.

---

## Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — beginner-friendly introduction to gMock and mocking concepts.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — recipes and best practices.
- [Using Matchers and Custom Actions](../guides/mocking-advanced/matchers-and-actions.md) — detailed guide on argument constraints and actions.

---

## Summary

Setting expectations and behaviors is the core of specifying mock interactions in GoogleMock. `ON_CALL` allows setting default method behaviors without enforcing call counts, while `EXPECT_CALL` defines precise call expectations, call counts, and call ordering. Using these APIs effectively supports robust and maintainable unit tests that verify correct interactions with dependencies.

---

For full usage, refer to the official [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) and tutorials in the GoogleTest documentation.

---