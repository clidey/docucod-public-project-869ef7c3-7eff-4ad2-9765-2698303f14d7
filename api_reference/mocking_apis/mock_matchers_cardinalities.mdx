---
title: "Matchers & Cardinalities"
description: "Reference for GoogleMock's extensive matcher library for flexible argument validation, as well as cardinalities for expressing how many times a method is expected to be called. Covers built-in matchers, custom matcher creation, and practical usage scenarios."
---

# Matchers & Cardinalities

Reference for GoogleMock's extensive matcher library for flexible argument validation, as well as cardinalities for expressing how many times a method is expected to be called. Covers built-in matchers, custom matcher creation, and practical usage scenarios.

---

## Overview

In unit testing with GoogleMock, verifying *how* and *how many times* methods are called is as vital as *what* arguments they receive. The foundation of this verification lies in **matchers** and **cardinalities**.

- **Matchers**: Define flexible conditions to validate function arguments.
- **Cardinalities**: Describe the expected number of calls to mocked methods.

This page provides a comprehensive reference to GoogleMock's matcher library and cardinality constructs, including built-in variants, custom extensions, and practical usage tips.

---

## Matchers: Validating Arguments

Matchers allow you to express detailed criteria that method arguments must satisfy during testing. They are key to achieving precise yet maintainable expectations.

### Using Built-In Matchers

GoogleMock offers a broad array of built-in matchers for common types and scenarios:

- **Wildcard matcher `_`**: Matches any argument.
- **Value matchers**: `Eq()`, `Ne()`, `Lt()`, `Gt()`, `Le()`, `Ge()`, etc., to compare with specific values.
- **Container matchers**: `ElementsAre()`, `UnorderedElementsAre()`, and `Contains()` for STL containers.
- **Pointer matchers**: `IsNull()`, `NotNull()`, `Pointee()` to inspect pointer contents.
- **String matchers**: `HasSubstr()`, `StartsWith()`, `EndsWith()`.

For extensive matchers and examples, see the [Matchers Reference](reference/matchers.md).

### Writing Custom Matchers

For complex conditions not covered by built-in matchers, create custom matcher classes by implementing:

- `MatchAndExplain()` - to evaluate argument validity;
- `DescribeTo()` - to describe the matcher for user messages.

Alternatively, use the succinct `MATCHER` and `MATCHER_P` macros to define reusable matchers quickly.

Example:
```cpp
MATCHER(IsEven, "checks if the number is even") {
  return (arg % 2) == 0;
}
```
Then use:
```cpp
EXPECT_CALL(mock_obj, Foo(IsEven()));
```

Refer to [Defining Custom Matchers](guides/mocking-and-advanced-techniques/defining-custom-matchers-actions.mdx#CustomMatcherClass) for comprehensive guidance.

### Combining Matchers

Compose complex conditions using combinators like `AllOf()`, `AnyOf()`, and `Not()`:

```cpp
EXPECT_CALL(mock_obj, Method(AllOf(Ge(0), Le(100))));
```

You can also combine matchers to validate tuples or multiple arguments as a whole.

---

## Cardinalities: Expressing Expected Call Counts

Cardinalities specify expectations about the number of times a mock method is invoked. They help capture both strict and fuzzy constraints effectively.

### Built-in Cardinalities

GoogleMock provides these cardinalities in the `testing` namespace:

| Cardinality      | Meaning                                                 |
|------------------|---------------------------------------------------------|
| `AnyNumber()`    | The call can occur zero or more times (no upper bound). |
| `AtLeast(n)`    | The call is expected at least `n` times.                |
| `AtMost(n)`     | The call is expected at most `n` times.                 |
| `Between(m, n)` | The call count is expected between `m` and `n` times, inclusive. |
| `Exactly(n)`    | The call is expected exactly `n` times. With `n=0`, the call should never occur. |

These cardinalities integrate seamlessly with `EXPECT_CALL(...).Times()`.

### Examples

```cpp
using ::testing::AtLeast;
using ::testing::Exactly;
using ::testing::AnyNumber;

EXPECT_CALL(mock_obj, Foo())
    .Times(Exactly(3)); // Expect Foo() exactly 3 times

EXPECT_CALL(mock_obj, Bar(_))
    .Times(AtLeast(1)); // Expect Bar(...) at least once

EXPECT_CALL(mock_obj, Baz())
    .Times(AnyNumber()); // No limit on Baz() calls
```

### Key Methods of Cardinality

- `IsSatisfiedByCallCount(int count)`: Returns true if the actual call count satisfies the cardinality.
- `IsSaturatedByCallCount(int count)`: Returns true if the upper bound (if any) is reached.
- `IsOverSaturatedByCallCount(int count)`: True if called more times than allowed.

These help GoogleMock provide immediate feedback during test execution if call expectations break.

### Describing Cardinalities

GoogleMock uses human-friendly descriptions:

| Calls | Description Example         |
|-------|----------------------------|
| 0     | never called               |
| 1     | called once                |
| 2     | called twice               |
| n > 2 | called n times             |

Cardinalities also describe expectations, e.g., "called at least twice", "called between 3 and 5 times".

### Creating Custom Cardinalities

Advanced users can define custom call count policies by implementing `CardinalityInterface`. Implement these methods:

- `IsSatisfiedByCallCount(int)`
- `IsSaturatedByCallCount(int)`
- `DescribeTo(std::ostream*)`

Wrap your class with `MakeCardinality()` to create a usable `Cardinality` object.

Example - an even call count cardinality:

```cpp
class EvenCardinality : public CardinalityInterface {
 public:
  bool IsSatisfiedByCallCount(int call_count) const override {
    return (call_count % 2) == 0;
  }

  bool IsSaturatedByCallCount(int) const override {
    return false;  // can never be saturated
  }

  void DescribeTo(std::ostream* os) const override {
    *os << "called even number of times";
  }
};

Cardinality EvenNumber() {
  return MakeCardinality(new EvenCardinality);
}

EXPECT_CALL(mock_obj, Foo())
    .Times(EvenNumber());
```

---

## Practical Usage Scenarios

### Defining Expectations with Cardinalities

The `Times()` clause on the `EXPECT_CALL()` macro uses cardinalities to define how often a call is expected.

```cpp
EXPECT_CALL(mock_obj, Method(_)).Times(AtLeast(2));
```

If omitted, cardinalities are inferred: if you have `n` `WillOnce()` clauses and no `WillRepeatedly()`, then `Times(n)` is inferred; if you have `WillRepeatedly()`, cardinality is inferred as `AtLeast(n)`.

### Managing Method Call Order

Use `Sequence` and `InSequence` to impose call ordering, so cardinalities apply in context:

```cpp
Sequence s;
EXPECT_CALL(mock_obj, First()).InSequence(s);
EXPECT_CALL(mock_obj, Second()).InSequence(s);
```

### Retiring Expectations on Saturation

By default, expectations remain active even after their invocation limits, potentially causing overlapping matches and test failures. Use `.RetiresOnSaturation()` to deactivate the expectation once saturated:

```cpp
EXPECT_CALL(mock, DoSomething())
    .Times(2)
    .RetiresOnSaturation();
```

This avoids conflicts by letting other expectations handle subsequent calls.

### Combining Matchers and Cardinalities

```cpp
EXPECT_CALL(mock_obj, Process(DataType(Eq(5), Lt(10))))
    .Times(Between(1, 3));
```

This expects calls with specific argument conditions between 1 and 3 times.

---

## Troubleshooting & Best Practices

### Common Pitfalls

- **Ignoring cardinality errors**: If your expectations fail with "too many calls", check for overlapping expectations or missing `.RetiresOnSaturation()`.
- **Incomplete expectations**: Ensure all expected calls are covered; otherwise, non-fatal failures will indicate the shortfall.
- **Overuse of `AnyNumber()`**: This can mask bugs by allowing unlimited calls; use judiciously.

### Tips & Recommendations

- Always set expectations *before* exercising mocks.
- Prefer `AtLeast()` or `Between()` to express flexible call counts.
- Use custom cardinalities to express domain-specific invocation patterns.
- Use descriptive `.Description()` on expectations to produce clear failure messages.
- Use `Mock::VerifyAndClearExpectations()` to force verification at specific points.

---

## Related Documentation

- [Matchers Reference](reference/matchers.md)
- [EXPECT_CALL Clause - Times()](docs/reference/mocking.md#EXPECT_CALL.Times)
- [Writing Custom Matchers and Cardinalities](guides/mocking-and-advanced-techniques/defining-custom-matchers-actions.mdx)
- [GoogleMock Cookbook](docs/gmock_cook_book.md)

---

## Mermaid Diagram: Cardinality Call Evaluation Flow

```mermaid
flowchart TD
  Start([Method Invocation]) --> CheckMatch[Is there a matching expectation?]
  CheckMatch -->|No| UninterestingCall[Handle Uninteresting Call]
  UninterestingCall --> End
  CheckMatch -->|Yes| EvaluateCardinality{Call count within allowed range?}
  EvaluateCardinality -->|No, Over Upper Bound| FailOverCall[Report Over-saturation Error]
  FailOverCall --> DefaultAction[Perform Default or ON_CALL Action]
  DefaultAction --> End
  EvaluateCardinality -->|Yes| UpdateCallCount[Increment Call Count]
  UpdateCallCount --> CheckSaturation{Is upper bound reached?}
  CheckSaturation -->|Yes| CheckRetire[Is RetireOnSaturation set?]
  CheckSaturation -->|No| ProceedActions
  CheckRetire -->|Yes| RetireExpectation[Deactivate Current Expectation]
  CheckRetire -->|No| ProceedActions
  RetireExpectation --> ProceedActions
  ProceedActions[Invoke associated action(s)] --> End
```

---

## Code Snippet: Using Cardinalities in EXPECT_CALL

```cpp
using ::testing::AtLeast;
using ::testing::Exactly;
using ::testing::Between;

class MockFoo {
 public:
  MOCK_METHOD(void, Bar, (int));
};

TEST(MockFooTest, CallsWithCardinalities) {
  MockFoo mock;

  // Expect Bar() to be called exactly 3 times.
  EXPECT_CALL(mock, Bar).Times(Exactly(3));

  mock.Bar(1);
  mock.Bar(2);
  mock.Bar(3);
}

TEST(MockFooTest, CallsWithBetweenCardinality) {
  MockFoo mock;

  // Bar() expected between 1 and 4 times.
  EXPECT_CALL(mock, Bar).Times(Between(1, 4));

  mock.Bar(1);
  mock.Bar(2);
}

TEST(MockFooTest, InfiniteCalls) {
  MockFoo mock;

  // Bar() can be called any number of times.
  EXPECT_CALL(mock, Bar).Times(AnyNumber());

  for (int i = 0; i < 1000; ++i) {
    mock.Bar(i);
  }
}
```

## Summary

This page equips you with detailed understanding and usage of GoogleMock's matchers and cardinalities – essential tools for expressive and reliable testing of mock interactions. By mastering these, you can confidently specify argument constraints and expected call frequencies, tailor expectations precisely, and write maintainable, robust tests.

---
