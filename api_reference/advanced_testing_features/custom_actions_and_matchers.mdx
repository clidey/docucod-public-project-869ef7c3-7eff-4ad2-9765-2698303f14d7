---
title: "Custom Actions and Matchers"
description: "Extend GoogleMock and GoogleTest with user-defined matchers and actions to precisely fit your testing needs. Learn the API details, registration, and best practices for making your own extensions."
---

# Custom Actions and Matchers

Extend GoogleMock and GoogleTest with user-defined matchers and actions to precisely fit your testing needs. This reference guides you through the API details, registration, and best practices for creating your own custom extensions.

---

## Introduction

GoogleMock provides a powerful framework for mocking and verification in C++. Beyond built-in matchers and actions, you can extend its capabilities by defining custom matchers and actions tailored to your domain logic or complex scenarios. This page focuses on how to write, register, and use these user-defined extensions to express your expectations and behaviors more precisely.

Custom matchers allow you to describe complex argument validation beyond what built-in matchers provide. Custom actions enable you to specify bespoke mock method behaviors, including side effects and return values.

---

## Why Create Custom Actions and Matchers?

- **Expressiveness:** Some test scenarios require validating intricate conditions on function arguments or simulating complex behaviors impossible with default matchers or actions.
- **Reusability:** By encapsulating common test logic in custom matchers or actions, your tests become more readable, maintainable, and consistent.
- **Maintainability:** Custom extensions help you decouple test expectations from internal mock structures, allowing clearer intent and easier updates.


## Custom Matchers

Custom matchers let you define predicates that test whether function arguments satisfy your specific conditions.

### Defining a Simple Custom Matcher

The simplest approach uses the `MATCHER` macro:

```cpp
MATCHER(NameOfMatcher, "description") {
  // 'arg' contains the argument to match.
  return /* return true if arg matches condition, false otherwise */;
}
```

Example:

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

// Usage in expectation
EXPECT_CALL(mock_obj, SomeMethod(IsEven()));
```

This matcher will provide clear matching messages and participate gracefully in composite matchers.

### Parameterized Matchers

If your matcher needs parameters, use `MATCHER_P` or `MATCHER_P2` up to `MATCHER_P10`:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "checks divisibility") {
  return (arg % divisor) == 0;
}

EXPECT_CALL(mock_obj, SomeMethod(IsDivisibleBy(3)));
```

The description can be customized to include parameter values for better diagnostic messages.

### Creating Matcher Classes for More Control

For advanced cases, define a matcher class with the following methods:

- `bool MatchAndExplain(const T& arg, std::ostream* os) const;`
- `void DescribeTo(std::ostream* os) const;`
- `void DescribeNegationTo(std::ostream* os) const;`

Example:

```cpp
class ComplexMatcher {
public:
  explicit ComplexMatcher(int expected) : expected_(expected) { }

  bool MatchAndExplain(const MyType& arg, std::ostream* os) const {
    bool matches = (arg.GetValue() == expected_);
    if (!matches && os) {
      *os << "value was " << arg.GetValue();
    }
    return matches;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "has value equal to " << expected_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "has value not equal to " << expected_;
  }

private:
  const int expected_;
};

::testing::Matcher<MyType> IsValueEqualTo(int expected) {
  return ::testing::Matcher<MyType>(new ::testing::internal::MatcherBase<ComplexMatcher>(ComplexMatcher(expected)));
}
```

This method provides the best error reporting and flexibility.

---

## Custom Actions

Actions specify what happens when a mock method is invoked. GoogleMock provides many built-in actions, but defining custom ones lets you simulate side effects, complex stateful responses, or domain-specific behavior.

### Defining an Action with `ACTION` Macros

Simplest way is to use the `ACTION` macro to define an action in namespace scope:

```cpp
ACTION(MyCustomAction) {
  // Access arguments as arg0, arg1, ...
  // Return a value compatible with the mock method's return type.
  return arg0 + 10;  // Example logic for first argument
}

EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce(MyCustomAction());
```

Parameterized actions:

```cpp
ACTION_P(MyAddAction, to_add) {
  return arg0 + to_add;
}

EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce(MyAddAction(5));
```

You can define up to 10 parameters with `ACTION_P2`, ..., `ACTION_P10`.

### Implementing More Complex Actions

For complex or reusable actions, implement the `testing::ActionInterface<F>` interface:

```cpp
template <typename F>
class MyAction : public testing::ActionInterface<F> {
public:
  // F is the mocked function signature.
  // typedefs provided: Result and ArgumentTuple.

  MyAction(/* constructor params */) { /* store state */ }

  typename testing::internal::Function<F>::Result
  Perform(const typename testing::internal::Function<F>::ArgumentTuple& args) override {
    // Extract arguments with std::get and perform your logic
    // Return the corresponding value
  }
};

// Factory function
template <typename F>
testing::Action<F> MakeMyAction(/* params */) {
  return testing::Action<F>(new MyAction<F>(/* params */));
}
```

Use `MakeMyAction<F>` in your test expectations.

### Adapting Callables or Lambdas as Actions

You can use any callable compatible with the mock method signature as an action directly, including lambdas:

```cpp
EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce([](int x) { return x * 10; });
```

This method is preferred for simple custom behavior.

---

## Registering and Using Custom Matchers and Actions

- **Use namespace `testing`** or alias `using ::testing::...;` for cleaner syntax.
- Define the matcher/action before usage, preferably in test common headers or source files.
- Use custom matchers in `EXPECT_CALL` or assertions like `EXPECT_THAT`.
- Use custom actions in `WillOnce()`, `WillRepeatedly()`, or `ON_CALL(...).WillByDefault()`.

Example:

```cpp
EXPECT_CALL(mock_obj, SomeMethod(IsEven()))
    .WillOnce(MyCustomAction());
```

---

## Best Practices

- **Keep matchers pure:** Matchers must not have side effects or change external state.
- **Be specific but flexible:** Match only what your test cares about to avoid brittle tests.
- **Use parameterized matchers:** For reusable matchers with varying parameters.
- **Leverage lambdas for simple actions:** Lambdas are concise and readable.
- **For stateful or complex actions, use `ActionInterface`:** Gives full control over behavior.
- **Document your custom matchers and actions:** Clear intent accelerates test understanding and maintenance.
- **Avoid overusing strict matchers:** Excessive specificity leads to fragile tests.

---

## Troubleshooting

**Q:** My custom matcher isn't matching as expected.

**A:** Ensure your matcher returns `true` only when conditions are met; verify argument types; use `MatchAndExplain()` to debug by streaming explanatory messages.


**Q:** The action I wrote doesn't compile with my mock method.

**A:** Confirm your action's callable signature matches the mock method signature; use lambdas to test simple cases and increment complexity.

---

## References & Related Documentation

- [GoogleMock Cookbook - Writing New Matchers and Actions](https://google.github.io/googletest/gmock_cook_book.html#WritingNewMatchers)
- [Actions Reference](../api_reference/utilities_and_lowlevel/gmock-actions.md)
- [Matchers Reference](../api_reference/mocking_and_matchers/argument_matching.md)
- [Mocking Reference](../api_reference/mocking_and_matchers/mocking.md)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)

---

## Example: Custom Matcher and Action

```cpp
#include <gmock/gmock.h>
using ::testing::Matcher;
using ::testing::MatchResultListener;

// Custom matcher class
class IsPositiveMatcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, MatchResultListener* listener) const {
    if (n > 0) return true;
    if (listener) *listener << "which is not positive";
    return false;
  }

  void DescribeTo(std::ostream* os) const { *os << "is positive"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is not positive"; }
};

Matcher<int> IsPositive() {
  return Matcher<int>(new testing::PolymorphicMatcher<IsPositiveMatcher>(IsPositiveMatcher()));
}

// Custom action
ACTION_P(AddValue, to_add) {
  return arg0 + to_add;
}

// Usage
TEST(MyTest, CustomMatcherAndAction) {
  class MockClass {
   public:
    MOCK_METHOD(int, Compute, (int), ());
  } mock;

  EXPECT_CALL(mock, Compute(IsPositive()))
      .WillOnce(AddValue(10));

  EXPECT_EQ(mock.Compute(5), 15);  // 5 + 10
  EXPECT_EQ(mock.Compute(0), 0);   // Fails matching IsPositive
}
```

---

_Source and reference code can be found in the [GoogleTest repository](https://github.com/google/googletest) under paths like `gmock/include/gmock/gmock-actions.h` and [gmock_cook_book.md](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)._
