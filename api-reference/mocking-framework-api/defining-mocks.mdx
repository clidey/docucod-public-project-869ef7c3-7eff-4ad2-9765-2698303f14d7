---
title: "Defining and Using Mocks"
description: "Guides users through creating mock classes using the MOCK_METHOD macros, specifying mock signatures, and integrating with test code. Illustrates with sample mock objects and common mocking patterns."
---

# Defining and Using Mocks

This page guides you through the essential process of creating mock classes in GoogleTest using the `MOCK_METHOD` macros. It teaches you how to correctly specify mock method signatures, integrate these mocks into your test code, and leverage common mocking patterns to verify interactions and behaviors in your C++ codebase.

---

## 1. Introduction to Mock Classes

Mock objects act as stand-ins for real classes, allowing your tests to observe and control interactions without needing the actual implementation. To create a mock class, derive from your interface or base class and define mock methods using the `MOCK_METHOD` macro.

### Example: Defining a Mock Class

```cpp
#include <gmock/gmock.h>

class Turtle {
 public:
  virtual ~Turtle() = default;
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual void GoTo(int x, int y) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

### Key Points:

- `MOCK_METHOD(ReturnType, MethodName, (Args), (Specs));` defines a mock method.
- The mock methods *must* be declared in the `public:` section, regardless of the base class method access specifiers.
- Use `(override)` in the 4th parameter to indicate overriding a virtual base method.
- Add `(const)` if the mocked method is `const`; combine multiple specs like `(const, override)`.

<Note>
Using `MOCK_METHOD` automates generating mocks, eliminating manual boilerplate and ensuring consistent behavior.
</Note>

## 2. Using MOCK_METHOD Qualifiers and Specifiers

The optional fourth parameter lets you specify method qualifiers that precisely match the method you are mocking.

| Qualifier             | Description                                                          |
| --------------------- | -------------------------------------------------------------------- |
| `const`               | Marks the method as `const`.                                         |
| `override`            | Mark the method with `override`. Recommended when overriding a virtual method.
|
| `noexcept`            | Marks the method with `noexcept`. Required if the base method is `noexcept`.
|
| `Calltype(...)`       | Specifies calling convention (e.g., `Calltype(STDMETHODCALLTYPE)` on Windows).
|
| `ref(&)` or `ref(&&)` | Adds reference qualifier to the method (for overloaded ref-qualified methods).

### Example: Mocking a `const` and `noexcept` method

```cpp
MOCK_METHOD(int, GetSize, (), (const, override, noexcept));
```

<Warning>
If your method contains commas within argument types (e.g., `std::pair<int, int>`), wrap the entire type in parentheses or use a type alias to avoid macro parsing errors.
</Warning>

## 3. Handling Overloaded Methods

When mocking overloaded methods, `MOCK_METHOD` calls must exactly match the target method's signature, including `const` and reference qualifiers, to avoid ambiguity.

### Example:

```cpp
class Foo {
 public:
  virtual int GetValue() = 0;
  virtual int GetValue() const = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (override));
  MOCK_METHOD(int, GetValue, (), (const, override));
};
```

Use the `Const()` wrapper when setting expectations on `const` overloaded methods:

```cpp
EXPECT_CALL(Const(mock_foo), GetValue()).WillOnce(Return(5));
```

## 4. Creating Mock Objects and Setting Expectations

Once you have your mock class, instantiate mock objects and define behavior and expectations.

### Typical Workflow:

1. **Create** mock objects.
2. **Set default actions** for methods using `ON_CALL()` (no expectations implied).
3. **Set expectations** using `EXPECT_CALL()` specifying expected calls, matchers, number of calls, and actions.
4. **Exercise** code that uses the mocks.
5. **Test framework verifies** expectations on destruction.

### Example:

```cpp
using ::testing::Return;

TEST(PainterTest, CanDrawCircle) {
  MockTurtle turtle;

  // Set a default action
  ON_CALL(turtle, GetX()).WillByDefault(Return(0));

  // Expect PenDown is called exactly once
  EXPECT_CALL(turtle, PenDown()).Times(1);

  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

<Note>
Set expectations before calling the code under test. Setting expectations afterwards leads to undefined behavior.
</Note>

## 5. Common Mocking Patterns

### 5.1 Specifying Argument Matchers

Use matchers (`_`, `Eq(value)`, `Ge(value)`, etc.) inside `EXPECT_CALL` and `ON_CALL` to restrict expected arguments.

```cpp
EXPECT_CALL(mock, Foo(Ge(10), _)); // First arg >= 10, second arg anything
```

### 5.2 Using Wildcards for Any Arguments

To ignore argument values, omit matcher list for non-overloaded methods or use `_` for specific arguments.

```cpp
EXPECT_CALL(mock, Foo);       // Any arguments (non-overloaded only)
EXPECT_CALL(mock, Foo(_, _)); // Any two arguments
```

### 5.3 Specifying Call Cardinalities

Use `.Times()` clause to specify expected call counts:

| Cardinality     | Meaning                                      |
|-----------------|----------------------------------------------|
| `Times(AnyNumber())`   | Any number of calls allowed                    |
| `Times(AtLeast(n))`    | At least `n` times                              |
| `Times(AtMost(n))`     | At most `n` times                               |
| `Times(Between(m, n))`| Between `m` and `n` times (inclusive)          |
| `Times(Exactly(n))` or `Times(n)` | Exactly `n` times expected                    |

If omitted, cardinality will be inferred based on `WillOnce` and `WillRepeatedly` clauses.

### 5.4 Defining Behaviors with Actions

Use `.WillOnce()` and `.WillRepeatedly()` to define method behaviors when called:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(5))
    .WillOnce(Return(10))
    .WillRepeatedly(Return(0));
```

- `WillOnce` specifies behavior for the next matching call.
- `WillRepeatedly` specifies behavior after all `WillOnce` clauses are exhausted.

### 5.5 Sequences and Call Ordering

Use `InSequence` or `.InSequence()` clauses and `Sequence` objects to enforce order of mock calls.

```cpp
Sequence s;
EXPECT_CALL(mock, First()).InSequence(s);
EXPECT_CALL(mock, Second()).InSequence(s);
```

Or group multiple calls with `InSequence` scope:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
```

### 5.6 Expectations with Prerequisites Using `.After()`

Define calls that must happen after some other expectations:

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Use()).After(e1);
```

### 5.7 Retiring Expectations on Saturation

By default, expectations remain active even after expected calls complete. Use `.RetiresOnSaturation()` to retire them immediately.

```cpp
EXPECT_CALL(mock, Foo(7)).Times(2).RetiresOnSaturation();
```

This allows fallbacks for later calls without violating cardinality.

## 6. Setting Default Behaviors with ON_CALL

Use `ON_CALL()` to specify behavior without requiring calls or enforcing expectations.

Syntax:

```cpp
ON_CALL(mock, Method(matchers...))
    .WillByDefault(action);
```

Example:

```cpp
ON_CALL(turtle, GetX())
    .WillByDefault(Return(0));
```

`ON_CALL` can include a `.With()` clause for finer control.

## 7. Best Practices and Tips

- Always put `MOCK_METHOD` declarations in `public:` to allow access by gMock.
- Add `override` and `const` specifiers as per original method signature.
- Use type aliases or wrap complex types in parentheses to avoid macro parse errors.
- Set general default behavior in `ON_CALL` inside test fixture setup.
- Add precise `EXPECT_CALL`s in each test to verify interactions.
- Use `NiceMock`, `NaggyMock`, or `StrictMock` wrappers to control uninteresting call reporting.
- Ensure virtual destructors in interfaces being mocked to avoid undefined behavior.
- For move-only types, use lambdas or `WillOnce(Return(std::move(...)))` carefully.
- Use sequences and `After` clauses to test call order where relevant.

## 8. Troubleshooting

<Warning>
- Setting expectations after exercising the mock objects leads to undefined behavior.
- Unintentional hiding of overloaded methods: mock all overloads or use `using` to bring base overloads into scope.
- Beware of unprotected commas in templates and method signatures causing compilation errors.
- If unexpected calls occur with no matching `EXPECT_CALL`, gMock reports errors; use catch-all expectations if necessary.
</Warning>

## 9. Additional Examples

### Simplified Mock Class with Complex Return Type Aliases

```cpp
using BoolAndInt = std::pair<bool, int>;
using MapIntDouble = std::map<int, double>;

class MockFoo {
 public:
  MOCK_METHOD(BoolAndInt, GetPair, ());
  MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
};
```

### Mocking Const and Non-Const Overloads

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), (override));
  MOCK_METHOD(int, GetValue, (), (const, override));
};
```

### Using EXPECT_CALL with Matchers and Actions

```cpp
EXPECT_CALL(mock, Process(_))
    .Times(3)
    .WillOnce(Return(true))
    .WillRepeatedly(Return(false));
```

### Using ON_CALL for Default Behavior

```cpp
ON_CALL(mock, GetX())
    .WillByDefault(Return(42));
```

---

The above structured approach empowers you to write clear, maintainable mocks and expectations that closely mirror your test design intent.

---

## References

- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [MOCK_METHOD Macro Details](../reference/mocking.md#MOCK_METHOD)
- [EXPECT_CALL Macro Details](../reference/mocking.md#EXPECT_CALL)
- [Using Matchers and Actions](../guides/core-testing-patterns/using-assertions-and-matchers.md)

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googlemock/include/gmock/gmock-spec-builders.h", "range": "1-287"},{"path": "docs/reference/mocking.md", "range": "1-555"},{"path": "docs/gmock_cheat_sheet.md", "range": "1-360"}]} />
