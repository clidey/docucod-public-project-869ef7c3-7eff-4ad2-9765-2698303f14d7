---
title: "Internal Helpers and Extensibility"
description: "Details on internal utility APIs and templates that advanced users or contributors might employ to extend mocking, assertions, or behavior. Not generally needed for standard test authors, but crucial for framework customization and contributor tasks."
---

# Internal Helpers and Extensibility

This page provides detailed insights into key internal utilities and extensibility mechanisms within GoogleMock. Designed primarily for advanced users, contributors, and framework customizers, this documentation equips you with the knowledge to extend behavior, manipulate mocking internals, and implement custom matchers and actions. While standard test authors typically do not require this, mastering these elements empowers effective framework customization and contributes to robust test design.

---

## Macros and Utilities for Mock Creation

GoogleMock offers internal macros and templates that automate mock class and method generation. The central macro `MOCK_METHOD` enables easy mocking of virtual or non-virtual methods by declaring mocked signatures. It supports method qualifiers such as `const`, `override`, `noexcept`, calling conventions (`Calltype`), and reference qualifiers (`ref(&)` or `ref(&&)`).

### `MOCK_METHOD` Usage and Customization

Define mocked methods inside the `public:` section of a mock class regardless of the original access modifier of the method in the base class. This guarantees that both `ON_CALL` and `EXPECT_CALL` can properly reference the mock method.

If your types or method signatures contain commas (e.g., templated types like `std::pair` or `std::map`), you must wrap these types inside parentheses or use `using` aliases to prevent macro parsing errors.

```cpp
class MyMock {
 public:
  MOCK_METHOD((std::pair<int, int>), GetPair, ());          // correct
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));  // correct

  using IntPair = std::pair<int, int>;
  MOCK_METHOD(IntPair, GetPairAlias, ());                    // alternative
};
```

### Internal Mechanism Highlights

- `MOCK_METHOD` internally validates method signatures and qualifiers during compilation.
- It generates both the mock method and a method allowing setting expectations using GoogleMock’s spec builder syntax.
- The mock methods forward calls through the GoogleMock runtime and maintain state about expectations and call counts, enabling internal verification and reporting.

## Custom Matchers: Extending Argument Validation

GoogleMock matchers provide expressive and composable ways to specify argument expectations. For sophisticated testing scenarios, custom matchers allow you to define criteria beyond the built-in matchers.

### Defining Matchers with `MATCHER` Macros

The `MATCHER` and `MATCHER_P` family of macros simplify creating polymorphic and parameterized matchers respectively.

Basic polymorphic matcher example:

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}
// Usage:
EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

Parameterized matcher example:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}
// Usage:
EXPECT_THAT(x, HasAbsoluteValue(10));
```

These macros provide the following benefits:

- Access to the matched value as `arg` and its type as `arg_type` (auto-inferred).
- Optional streaming of diagnostic messages to explain match failures via a `result_listener`.
- The description string can be dynamic based on matcher parameters and negation state.

### Implementing Monomorphic or Polymorphic Matchers Manually

For advanced usage, define matcher classes implementing `MatchAndExplain`, `DescribeTo`, and `DescribeNegationTo`. Polymorphic matchers use templates or template methods allowing use with many types.

Example:

```cpp
class NotNullMatcher {
 public:
  using is_gtest_matcher = void;

  template <typename T>
  bool MatchAndExplain(T* p, std::ostream* /* listener */) const {
    return p != nullptr;
  }

  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

PolymorphicMatcher<NotNullMatcher> NotNull() {
  return MakePolymorphicMatcher(NotNullMatcher());
}
```

### Composite and Container Matchers

You can define matchers that accept other matchers as parameters — for instance, a `DistanceFrom(target, matcher)` matcher that tests the distance between the matched value and a target using another matcher. Use the `Matcher<T>` type internally to store sub-matchers, enabling them to describe themselves properly.

GoogleMock ships with numerous container matchers (`ElementsAre`, `UnorderedElementsAre`, `Contains`, `Each`, etc.) that you can compose with custom matchers for fine-grained container validation.

## Custom Actions: Defining Mock Behavior

Actions define what a mock method does when called. While GoogleMock offers a variety of built-in actions (`Return`, `ReturnRef`, `SetArgPointee`, `DoAll`, `Invoke`, etc.), sometimes writing custom actions lets you simulate complex behaviors.

### Defining Actions via Macros

Legacy macros like `ACTION` and `ACTION_P` provide an easy way to write functor-like objects inline:

```cpp
ACTION(IncrementArg1) { return ++(*arg1); }
// Usage:
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg1());
```

This binds the mock function arguments as `arg0`, `arg1`, and so forth, and you can access their types as `arg0_type` etc.

### Defining Actions as Callable Objects or Lambdas

Modern C++ allows actions to be plain objects with `operator()`, lambdas, or function pointers, supporting complex state and logic.

```cpp
struct MultiplyBy {
  int factor;
  int operator()(int x) const { return x * factor; }
};
EXPECT_CALL(mock, Foo(_)).WillOnce(MultiplyBy{7});
```

### Polymorphic Actions

Implement actions usable across different mock function signatures by defining `Perform` templates, then use helper templates like `MakePolymorphicAction` to enable broad applicability.

### Built-in Action Utilities

GoogleMock also provides utilities to manipulate arguments (`SaveArg`, `SetArgPointee`, `SetArrayArgument`), ignore return values (`IgnoreResult`), or forward calls to real or fake objects (`Invoke`, `InvokeWithoutArgs`) for maximal flexibility.

## Managing Call Expectations: Specification Helpers

GoogleMock allows elaborate control over expected calls using modifiers chained onto `EXPECT_CALL`:

- `.Times()`: Cardinalities like `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`
- `.InSequence()`: To specify call order
- `.After()`: To enforce partial orders and ordering dependencies
- `.WillOnce()` and `.WillRepeatedly()`: To specify sequences of actions executed upon matched calls
- `.With()`: To specify a multi-argument matcher over the entire call tuple
- `.RetiresOnSaturation()`: To retire expectations once saturated

## Internal Utilities and Type Traits

GoogleMock includes a suite of internal helpers useful for extending its functionality or diagnosing problems:

- Type traits to identify arithmetic types, container support, recursive containers, and type safety in casting
- Utilities to handle smart pointers, references, and raw pointers uniformly
- Internal match result listeners for enhanced error message construction
- Facilities to stringify identifiers, join and compose matcher parameter logs

These internal components enable the design of advanced features, complex custom matchers, and actions.

## Troubleshooting & Best Practices

- Use `NiceMock` to suppress warnings for uninteresting calls with no expectations.
- Use `StrictMock` to make such warnings fatal failures, enforcing stricter tests.
- Always place `MOCK_METHOD` macros in the `public:` section to avoid access level issues.
- Beware of wrapping return or argument types containing commas — use parentheses or type aliases.
- Use `SafeMatcherCast<T>(matcher)` to safely cast matcher types when necessary.
- Place `EXPECT_CALL` statements correctly and chain clauses in the recommended order.
- Set `WillByDefault(...)` exactly once per `ON_CALL`.
- Avoid mixing too many expectations that overlap and cause ambiguity or unexpected saturation.

## References & Further Reading

- The [Mocking Reference](./mocking.md) for detailed API and class descriptions.
- The [gMock Cookbook](../gmock_cook_book.md) for hands-on recipes and advanced tips.
- The [Matchers Reference](./matchers-reference.md) to explore expressive argument validation.
- The [Action APIs](./actions-reference.md) to understand built-in and custom action usage.
- [Writing Custom Matchers](../guides/real-world-integration/custom-actions-and-matchers.mdx) for step-by-step guidance.

---

This page integrates deeply with core testing components, mocking APIs, and matcher mechanisms. Advanced users extending GoogleMock's internals will find it invaluable for tailor-making mocks, assertions, and behavioral customizations to fit complex testing demands.

<Source url="https://github.com/google/googletest" />