---
title: "Internal Utilities and Porting APIs"
description: "For power users and maintainers: documentation on utility types, low-level configuration macros, and portability helpers that support building, adapting, and optimizing GoogleTest/GoogleMock across different environments or platforms."
---

# Internal Utilities and Porting APIs

This documentation details the internal utilities, low-level configuration macros, and portability helpers used to support building, adapting, and optimizing GoogleTest and GoogleMock across different platforms and environments. These utilities enable the framework to work efficiently and portably on diverse operating systems and toolchains.

---

## 1. Portability and Platform Detection

The porting layer abstracts environment particulars and platform-dependent behavior, ensuring consistent operation across supported operating systems and compilers.

### Key Components

- **Platform Macros**: Compile-time constants detect operating systems (Linux, Windows, MacOS, etc.) and toolchain capabilities.

- **Compiler Feature Detection**: Checks for compiler versions and supported C++ language features (e.g., C++17 required).

- **Threading Support**: Enables mutexes, thread-local storage, and condition variables where supported, using different implementations for Windows, POSIX, or platforms without threading.

- **Regular Expression Engines**: Chooses between RE2, POSIX regex, or a simple regex engine based on availability.

- **Exception Support**: Detects if exceptions are enabled.

### Example Usage

```cpp
#if defined(GTEST_OS_WINDOWS)
  // Windows-specific functionality
#elif defined(GTEST_OS_LINUX)
  // Linux-specific functionality
#else
  // Fallback implementation
#endif
```

### Practical Benefits

- Users don't need to write conditional compilation checks throughout their tests.
- The framework internally handles environment differences, reducing compatibility bugs.

---

## 2. Synchronization Primitives

To support multi-threaded tests and internal thread safety, GoogleTest and GoogleMock provide synchronization utilities:

- **Mutex**: Provides mutual exclusion for shared data.
- **MutexLock**: RAII-style lock guarding a mutex.
- **ThreadLocal**: Thread-local storage for per-thread data.
- **Notification**: Thread coordination primitive allowing threads to wait for signals.

These classes have platform-specific implementations:

- Windows uses native critical sections.
- POSIX platforms use pthread mutexes and pthread keys.
- Single-threaded or unsupported platforms have dummy no-op versions.

### Usage Patterns

```cpp
// Protect shared resource
Mutex mu;

void ThreadSafeFunction() {
  MutexLock lock(&mu);
  // access shared resource
}

// Thread-local storage
ThreadLocal<int> tls_counter(0);

void ThreadFunction() {
  tls_counter.set(tls_counter.get() + 1);
}
```

### Tips

- On multi-threaded tests, ensure expectation setup and mock object destruction happen without concurrent access to avoid undefined behavior.
- ThreadLocal objects should outlive all threads using them to prevent leaks.

---

## 3. Command Line Flags and Logging

The port layer defines flag handling macros and logging utilities:

- **Flag Declaration/Definition Macros**: Allow defining and declaring configuration flags that control mock behavior.

- **Verbose Levels**:
  - `info`: Print all messages including detailed call traces.
  - `warning`: Default, prints warnings and errors.
  - `error`: Prints only errors.

- **Logging Macros**: Enables controlled logging at different severity levels.

### Example

```cpp
GMOCK_DEFINE_bool_(catch_leaked_mocks, true, "Catch leaked mocks flag");

if (GMOCK_FLAG_GET(catch_leaked_mocks)) {
  // Catch leaked mocks
}
```

---

## 4. Low-Level Utilities

A variety of useful utility templates and functions underlie GoogleTest and GoogleMock:

- **Type Traits**: Categorize types by kind (bool, integer, floating-point, other) to ensure safe matcher conversions.

- **Safe Cast Checks**: Ensure arithmetic conversions in matchers are lossless.

- **Failure Reporting**: A `FailureReporterInterface` for unified assertion and expectation failure reporting without causing recursion.

- **Universal Print and Match Helpers**: Functions to abstract printing and matching behavior, including handling of references, constness, and tuples.

- **Tuple Utilities**: Implement tuple unpacking, iteration, and transformation helpers.

- **Compile-time Assert Helpers**: Static assertions to enforce type safety within actions and matchers.

---

## 5. Platform-specific File and I/O Utilities

Encapsulated functions abstract platform differences for file system and I/O operations:

- File descriptor operations compatible with Windows and POSIX.
- File status checks, directory manipulations.
- Safe wrapping of C functions that may have different names or behavior across platforms.

### Example

```cpp
namespace posix {
  inline int FileNo(FILE* file) {
    // Implementation varies by platform
  }
}
```

---

## 6. Exception and RTTI Support Detection

GoogleTest and GoogleMock internally detect whether exceptions and RTTI are enabled on a platform, adapting to situations where these features are unavailable.

This detection affects:

- Whether exception-based matchers are enabled.
- Dynamic casting capabilities used in polymorphic matchers.

---

## 7. Thread Count Utility

Provides a platform-dependent mechanism to query the number of threads running in the process or returns zero if unsupported.

---

## Additional Notes

- All macros and symbols ending with an underscore (`_`) are internal and subject to change; user code must not use them directly.
- Many utility classes and functions are only exposed internally and do not provide user-facing API.
- Users should direct themselves to the higher-level testing and mocking APIs unless porting or extending the framework.

---

## References to Usage and Further Reading

- See the [Mocking Reference](../reference/mocking.md) for how to use mocking macros and expectations.
- Refer to the [Matchers API](../matchers-actions/matchers.md) to learn about the expressive matchers.
- Consult the [Actions API](../matchers-actions/actions.md) for specifying mock method behaviors.
- For customizing and extending GoogleMock, see the Customization Points
  ([custom/gmock-port.h](googlemock/include/gmock/internal/custom/README.md))
- Explore the [Getting Started Guides](../../guides/getting-started/basic-mocking.md) for practical mock creation and usage.

---

<Source url="https://github.com/google/googletest" paths='[{"path": "googlemock/include/gmock/internal/gmock-port.h", "range": "1-163"}, {"path": "googletest/include/gtest/internal/gtest-port.h", "range": "1-780"}, {"path": "googlemock/include/gmock/internal/gmock-internal-utils.h", "range": "1-202"}, {"path": "googletest/include/gtest/internal/custom/README.md", "range": "1-31"}, {"path": "googlemock/include/gmock/internal/custom/README.md", "range": "1-22"}]' />