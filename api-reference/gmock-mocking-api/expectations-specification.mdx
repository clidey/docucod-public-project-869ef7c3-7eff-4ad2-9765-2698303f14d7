---
title: "Specifying Mock Expectations"
description: "Describes the APIs for writing expectations (EXPECT_CALL, ON_CALL), configuring default actions, and enforcing call ordering and argument matching behaviors. Includes practical snippets and tips for typical workflows."
---

# Specifying Mock Expectations

This page details the APIs and syntax for specifying expectations on mock objects in GoogleMock. You'll learn how to write `EXPECT_CALL` and `ON_CALL` statements to define when and how mocked methods are called, what actions they perform by default, and how to enforce ordering and argument matching behavior. Practical examples, value-oriented guidance, and tips for typical workflows are included to help you use these APIs effectively.

---

## Overview of Mock Expectations

Mock expectations are the foundation of behavior verification in tests. They let you specify how mock methods should be called, how often, with which arguments, and what they should do in response.

GoogleMock uses two primary macros:

- `EXPECT_CALL` — defines an expectation that a method *will* be called, with constraints on arguments, order, and times.
- `ON_CALL` — defines a default behavior for a method when no explicit expectation is set, *without* requiring that the method is called.

The key difference is that `EXPECT_CALL` asserts *that* the call will occur, while `ON_CALL` simply sets the default behavior if the call does occur.

Understanding when to use which is critical for robust and maintainable tests.

---

## Using `EXPECT_CALL` to Specify Call Expectations

`EXPECT_CALL` lets you declare that a mock method is expected to be called with arguments matching specified matchers, how many times, and in what order.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, Method(argument_matchers...))
    .Times(cardinality)               // optional
    .WillOnce(action)                 // optional
    .WillRepeatedly(action)           // optional
    .InSequence(sequences...)
    .After(expectations...)
    .With(multi_argument_matcher)    // optional
    .RetiresOnSaturation();           // optional
```

### Example: Expecting a specific call

```cpp
using ::testing::Return;

EXPECT_CALL(turtle, GetX())
    .Times(3)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This expectation means:

- `GetX()` is expected to be called exactly 3 times.
- On the first call, it returns 100.
- On the second call, it returns 150.
- On the third and any subsequent calls, it returns 200.

### Argument Matchers

You specify expected arguments by using matchers inside the `EXPECT_CALL` macro.

```cpp
EXPECT_CALL(turtle, GoTo(50, _));  // The first arg must be 50, second is anything
```

If you omit the argument list entirely for a non-overloaded method, it matches any arguments.

### Cardinalities (Times Clause)

Controls how many times the method is expected to be called. Some built-in cardinalities:

| Cardinality         | Meaning                                    |
|---------------------|--------------------------------------------|
| `AnyNumber()`       | Call can occur any number of times.        |
| `AtLeast(n)`        | Call expected at least `n` times.          |
| `AtMost(n)`         | Call expected at most `n` times.           |
| `Between(m,n)`      | Call expected between `m` and `n` times.   |
| `Exactly(n)` or `n` | Call expected exactly `n` times (0 means never called). |

If you omit `.Times()`, GoogleMock infers it based on your use of `.WillOnce()` and `.WillRepeatedly()`:
- No `.WillOnce()` or `.WillRepeatedly()` : `Times(1)`
- `n` `.WillOnce()` clauses, no `.WillRepeatedly()` : `Times(n)`
- `n` `.WillOnce()` clauses and one `.WillRepeatedly()` : `Times(AtLeast(n))`


### Actions (WillOnce, WillRepeatedly)

Define the behavior of methods when called. Built-in actions include:

- `Return(value)` — returns a copy of `value`.
- `ReturnRef(variable)` — returns a reference to a variable.
- `Invoke(function)` — calls a function or lambda.
- `DoAll(...)` — sequences multiple actions.

Example:

```cpp
EXPECT_CALL(mock, DoSomething()).WillOnce(Return(true));
```

Multiple actions can be chained with `WillOnce()`, and a fallback action with `WillRepeatedly()`.

### Ordering Calls

By default, mock function calls can occur in any order. To enforce call order:

- Use `InSequence` to group expectations into a strict sequence:

```cpp
{
  InSequence seq;
  EXPECT_CALL(foo, Step1());
  EXPECT_CALL(foo, Step2());
}
```
- Use `.After()` clause to specify partial order based on other expectations.

These clauses let you express precise call order constraints.

### Other Clauses

- `.With(matcher)` — Matches all arguments together using `matcher`, which must be a matcher for a tuple of the function arguments.
- `.RetiresOnSaturation()` — This expectation retires as soon as it reaches its call limit, allowing later expectations to be matched.

---

## Using `ON_CALL` to Configure Default Behavior

`ON_CALL` defines the *default action* of a mock method when no matching `EXPECT_CALL` is found or no explicit action is specified. It does not verify whether the method is called.

### Basic Syntax

```cpp
ON_CALL(mock_object, Method(argument_matchers...))
    .WillByDefault(action);
```

Just like `EXPECT_CALL`, `ON_CALL` supports `.With()` to match all arguments as a tuple.

### Example: Setting Default Return Values

```cpp
using ::testing::Return;

ON_CALL(turtle, GetX()).WillByDefault(Return(42));
```

If no `EXPECT_CALL` describes a call to `GetX()`, then calling it returns 42.

### Using `ON_CALL` for Default Setup and `EXPECT_CALL` for Verification

- Use `ON_CALL` to set up common or default behaviors in test fixtures or mock constructors.
- Use `EXPECT_CALL` in test bodies for the important interactions you want to verify.

This approach balances expressiveness and maintainability of tests.

---

## Managing Call Ordering and Argument Matching Behavior

GoogleMock provides mechanisms to enforce call order and define complex argument conditions:

### Enforcing Order

- Use `InSequence` to impose a strict order for expectations within its scope.
- Use `.After()` to require an expectation only matches after other expectations are satisfied.
- Multiple sequences and expectation sets allow describing partial orders and DAGs of expectations.

### Complex Argument Matching

- Use `_` to wildcard-match any argument.
- Use built-in matchers for ranges, string substrings, pointers, etc.
- Use `.With()` with multi-argument matchers to enforce relationships among multiple arguments.

Example:

```cpp
using ::testing::_;
using ::testing::Lt;
EXPECT_CALL(mock, SetRange(_, _)).With(Lt());  // first arg < second arg
```

### Retiring Expectations

By default, expectations remain sticky (active) even after their call limit is reached, possibly causing failures for calls that match but exceed the limit.

Use `.RetiresOnSaturation()` to retire an expectation when saturated, allowing other expectations to match later calls.

---

## Tips and Best Practices

- Prefer `ON_CALL` for default behavior and `EXPECT_CALL` only for calls you want to verify precisely.
- Put the most general expectations *before* more specific ones. GoogleMock matches the last matching expectation.
- For overloaded methods, specify argument lists to resolve ambiguity.
- Use sequences and `.After()` clauses to control call ordering without over-constraining.
- Use `.RetiresOnSaturation()` to avoid brittle tests caused by sticky expectations.
- Use matchers smartly to avoid overspecification and brittle tests.
- Suppress warnings on uninteresting calls with `NiceMock`, or treat them as errors with `StrictMock`.

---

## Advanced Usage

### Expectation Sets for Partial Ordering

You can group multiple expectations and impose that another expectation runs only after all are satisfied:

```cpp
ExpectationSet init_calls;
init_calls += EXPECT_CALL(mock, InitA());
init_calls += EXPECT_CALL(mock, InitB());
EXPECT_CALL(mock, UseData()).After(init_calls);
```

### Mixing `.WillOnce()` and `.WillRepeatedly()`

`.WillOnce()` defines actions for the first calls; `.WillRepeatedly()` defines the fallback for further calls.

If fewer `.WillOnce()` clauses than expected calls exist, default action is used unless `.WillRepeatedly()` is set.

### Setting Multiple `.InSequence()` Clauses

An expectation can be assigned to multiple sequences. It must be called in all orders where the sequences overlap:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Foo()).InSequence(s1, s2);
EXPECT_CALL(mock, Bar()).InSequence(s1);
EXPECT_CALL(mock, Baz()).InSequence(s2);
```

This means `Foo()` happens before both `Bar()` and `Baz()`, but `Bar()` and `Baz()` can happen in any order.

---

## Common Pitfalls

- **Setting expectations after calls**: `EXPECT_CALL` must be called before exercising code that calls the mock.

- **Overly sticky expectations**: Without `.RetiresOnSaturation()`, expectations remain active after fulfillment, possibly causing errors on subsequent calls.

- **Ambiguous calls for overloaded methods**: Always specify argument matchers or overload resolvers.

- **Ignoring uninteresting calls by adding empty `EXPECT_CALL`s**: Instead, use `NiceMock` or truly set default actions via `ON_CALL`.

---

## Sample Workflow

A typical usage pattern in a test would look like:

```cpp
using ::testing::_;          // Wildcard matcher
using ::testing::Return;
using ::testing::InSequence;

TEST(SomeTest, Example) {
  MockTurtle turtle;

  // Default behavior
  ON_CALL(turtle, GetX()).WillByDefault(Return(0));

  {
    InSequence seq;                  // enforce order
    EXPECT_CALL(turtle, PenDown()); // must be called first
    EXPECT_CALL(turtle, Forward(10));
    EXPECT_CALL(turtle, PenUp());
  }

  MyPainter painter(&turtle);
  painter.PaintLine();              // exercise code
}
```

---

## Troubleshooting

- If tests complain about **unexpected calls**, verify that you have set appropriate `EXPECT_CALL` or `ON_CALL` for those methods.
- If you get warnings about **uninteresting mock function calls**, consider:
  - Using `NiceMock` to suppress warnings on uninteresting calls.
  - Adding `ON_CALL` to specify a default action.
- If a call fails due to **call order**, check if your expectations need to use `InSequence` or `After` to enforce expected order.
- If you see errors related to **too many or too few actions** in `EXPECT_CALL`, ensure the number of `.WillOnce()` and `.WillRepeatedly()` clauses matches your expected number of calls or use `.Times()` to specify cardinality explicitly.

---

## Related APIs and Concepts

- [`MOCK_METHOD`](reference/mocking.md#MOCK_METHOD) — Macro to define mock methods.
- [`IN_SEQUENCE`](reference/mocking.md#IN_SEQUENCE), [`Sequence`](reference/mocking.md#Sequence) — Classes and macros to specify call ordering.
- [`Matcher`](reference/matchers.md) — Expressions to specify argument constraints.
- [`Actions`](reference/mock-actions.md) — Built-in and custom behaviors for mock calls.
- [`NiceMock`, `StrictMock`, `NaggyMock`](reference/mocking.md#NiceMock) — Wrappers controlling warnings/errors on uninteresting calls.
- [`DefaultValue`](reference/mocking.md#DefaultValue) — Specify default return values for mock methods.

---

## Source Links for Deep Dive

- [gmock-spec-builders.h](https://github.com/google/googletest/blob/main/googlemock/include/gmock/gmock-spec-builders.h)
- [gmock-spec-builders.cc](https://github.com/google/googletest/blob/main/googlemock/src/gmock-spec-builders.cc)
- [gmock-spec-builders_test.cc](https://github.com/google/googletest/blob/main/googlemock/test/gmock-spec-builders_test.cc)


---