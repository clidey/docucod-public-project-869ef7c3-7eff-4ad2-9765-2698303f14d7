---
title: "Defining and Using Mocks"
description: "Covers the creation of mock classes and methods using the MOCK_METHOD macro. Provides templates and guidance for quickly setting up test doubles for interfaces and virtual methods."
---

# Defining and Using Mocks

This page guides you through creating mock classes and methods using the `MOCK_METHOD` macro within GoogleMock. You will learn how to quickly set up test doubles for interfaces and virtual methods, specify expectations, and define default behaviors that help you write effective and maintainable unit tests.

---

## Overview of Mock Classes and Methods

Mock classes substitute real dependencies in your tests by simulating their behavior. GoogleMock provides the `MOCK_METHOD` macro to conveniently and declaratively define mock methods that mimic virtual methods of interfaces or base classes.

### Defining a Mock Class

To define a mock class:

1. Derive your mock class from the interface or abstract base class you want to mock.
2. Use `MOCK_METHOD` in the `public` section of your mock class to generate mock methods.
3. Copy the method's signature into the macro parameters.
4. Add optional qualifiers like `const`, `override`, `noexcept`, or `Calltype(...)` as needed.

Example:

```cpp
#include <gmock/gmock.h>  // Required for GoogleMock macros

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual void GoTo(int x, int y) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

**Important:** Always place `MOCK_METHOD` declarations in the `public` section, even if the base class methods are `protected` or `private`. This allows gMock to access them properly for expectation and default behavior setup.

---

## Using the `MOCK_METHOD` Macro

The macro signature is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- `ReturnType`: The return type of the mocked method.
- `MethodName`: The method name.
- `(Args...)`: The parameter list enclosed in parentheses.
- `(Qualifiers)`: Optional. Includes method qualifiers such as `(const)`, `(override)`, `(noexcept)`, `Calltype(...)`, and reference qualifiers like `ref(&)` or `ref(&&)`.

### Handling Commas in Types

If your return type or argument type contains commas (such as template types), wrap the entire type in parentheses to avoid parsing issues. For example:

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, (), (override));
MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool), (override));
```

Alternatively, use type aliases:

```cpp
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD(BoolAndInt, GetPair, (), (override));
```

### Qualifiers

- `const`: Required if overriding a `const` method.
- `override`: Recommended to mark overrides of virtual methods.
- `noexcept`: Required if overriding a `noexcept` method.
- `Calltype(...)`: Used to specify calling conventions, useful in Windows environments.
- `ref(qualifier)`: Specifies reference qualifiers (`ref(&)` or `ref(&&)`).

---

## Setting Up Mock Behavior

Once a mock class is defined, you create instances and specify behavior using `EXPECT_CALL` and `ON_CALL` macros.

### Expectations with `EXPECT_CALL`

`EXPECT_CALL(mock_object, method_name(matchers...))` sets the behavior and the expectation that a specific method is called.

Basic usage:

```cpp
EXPECT_CALL(turtle, Forward(100))  // Expect Forward called with 100
  .Times(1)                       // Expected exactly once
  .WillOnce(Return());            // Specify what happens when called
```

### Default Behaviors with `ON_CALL`

`ON_CALL(mock_object, method_name(matchers...))` defines default behavior when the mock method is called but does not require the call to happen. Use `.WillByDefault` to specify behavior.

Example:

```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(5));
```

`ON_CALL` is typically used to define fallback behaviors, often in test setup or fixtures, enabling tests to focus on the interesting aspects.

---

## Specifying Matchers and Arguments

Matchers describe the expected arguments values.

- Use `_` as a wildcard matching any value.
- Use built-in matchers like `Eq()`, `Ge()`, `NotNull()` etc.
- Omit argument list entirely (only on non-overloaded methods) to match any arguments.

Example:

```cpp
EXPECT_CALL(foo, Bar(_, Ge(10)))  // First arg anything, second arg >= 10
  .Times(AnyNumber());
```

---

## Control Call Frequency with `Times`

The `.Times()` clause controls how many times the expectation is expected to be called. Examples:

- `Times(1)` — expected to be called once.
- `Times(AnyNumber())` — zero or more times.
- `Times(AtLeast(n))` — at least n times.
- `Times(AtMost(n))` — at most n times.
- `Times(Between(m, n))` — between m and n times inclusive.

If omitted, the cardinality is inferred from other clauses:

- Without `.WillOnce` or `.WillRepeatedly`, defaults to `Times(1)`.
- With n `.WillOnce` clauses but no `.WillRepeatedly`, defaults to `Times(n)`.
- With n `.WillOnce` clauses and `.WillRepeatedly`, defaults to `Times(AtLeast(n))`.

---

## Ordering Calls with Sequences and After

GoogleMock supports specifying call orders for expectations.

### Using `InSequence`

Use the `InSequence` object to group expectations that must be satisfied in order.

Example:

```cpp
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(obj, Foo());
  EXPECT_CALL(obj, Bar());
}
```

Calls to `Foo()` must occur before calls to `Bar()`.

### Using the `InSequence` Clause

You can associate an expectation with one or more `Sequence` objects to specify partial ordering.

Example:

```cpp
using ::testing::Sequence;
Sequence s1, s2;
EXPECT_CALL(mock, Reset()).InSequence(s1, s2);
EXPECT_CALL(mock, GetSize()).InSequence(s1);
EXPECT_CALL(mock, Describe()).InSequence(s2);
```

This means `Reset()` occurs before both `GetSize()` and `Describe()`. The latter two can occur in any order relative to each other.

### Using the `After` Clause

Specify that an expectation happens only after certain other expectations.

Example:

```cpp
using ::testing::Expectation;
Expectation e1 = EXPECT_CALL(mock, InitX());
Expectation e2 = EXPECT_CALL(mock, InitY());
EXPECT_CALL(mock, Describe()).After(e1, e2);
```

The call to `Describe()` must happen after `InitX()` and `InitY()`.

---

## Specifying Actions: What Your Mock Does When Called

### `WillOnce` and `WillRepeatedly`

Actions determine the behavior of the mock when invoked.

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

- `.WillOnce(action)` specifies behavior for the next call only.
- `.WillRepeatedly(action)` specifies behavior for all subsequent calls after the `.WillOnce` actions are exhausted.

### Built-in Actions

`Return()`, `ReturnRef()`, `ReturnPointee()`, `Invoke()`, `DoAll()`, `SetArgPointee()`, `DeleteArg()`, and many others are predefined actions to simplify common behaviors.

For example, to mock a method modifying an output argument:

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

---

## Retiring Expectations with `RetiresOnSaturation`

An expectation normally remains active even after it has been fully satisfied, making it "sticky". Sometimes, you want it to be considered inactive (retired) once saturated so that older expectations do not match further calls.

Example:

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
```

After two calls matching this expectation, it retires, and further calls will be matched by other expectations.

---

## Simplified Usage with `MockFunction`

When you need to mock standalone callbacks or `std::function` objects, you can use `MockFunction<F>` to quickly create a mock function with a single method `Call`. This helps mock callback invocations easily.

Example:

```cpp
#include <gmock/gmock.h>
using ::testing::MockFunction;

MockFunction<int(std::string)> mock_callback;
EXPECT_CALL(mock_callback, Call("hello")).WillOnce(Return(42));

int result = mock_callback.AsStdFunction()("hello");
EXPECT_EQ(result, 42);
```

---

## Tips and Best Practices

- **Always mock virtual methods**; mocking non-virtual functions requires advanced techniques.
- **Specify expectations before exercising mocks** to ensure correct verification.
- **Use `ON_CALL` for default behaviors** and reserve `EXPECT_CALL` for specifying actual expectations.
- **Employ `NiceMock`, `NaggyMock`, or `StrictMock`** for different behaviors on uninteresting calls.
- **Use sequences or `.After()` to enforce call order** when important.
- **Retire expectations when appropriate** to avoid sticky expectations causing unexpected failures.
- **Wrap argument-heavy methods in simpler mock methods** if needed to make mocking easier.
- **Prefer lambdas or functors in actions when you need custom behavior.**

---

## Common Pitfalls and Troubleshooting

- **Ignoring to mark methods as `virtual` in base classes**: Only virtual methods can be mocked.
- **Not adding `override` or `const` qualifiers in mocks**: Must match the base method's qualifier set.
- **Incorrect matcher use leading to unexpected misses**: Use `_` wildcard to loosen argument matching.
- **Overly strict expectations causing brittle tests**: Use `ON_CALL` and `Times(AnyNumber())` to allow uninteresting calls.
- **Unintended ambiguous overloads**: Explicitly specify overloads or use type-safe disambiguation.
- **Forgetting to verify mocks**: GoogleMock does this at destruction but can be forced early via `Mock::VerifyAndClearExpectations()`.

---

## Summary

You now know how to define mock classes and methods using `MOCK_METHOD`, set expectations with `EXPECT_CALL`, specify default behaviors with `ON_CALL`, control call counts and order, and fine-tune mock object behavior using GoogleMock. These capabilities allow precise and flexible control of mock objects to write robust and expressive tests.

---

## Further Reading and References

- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — comprehensive API reference
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — beginner-friendly introduction
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) — quick syntax overview
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — practical recipes
- [Specifying Mock Expectations](./expectations-specification) — detailed explanation of `EXPECT_CALL` clauses
- [Nice, Naggy, and Strict Mocks](./nice-strict-mocks) — controlling uninteresting call behaviors

---

<AccordionGroup title="Example: Defining a Mock Class and Setting Expectations">
<Accordion title="Mock class definition and usage">
```cpp
#include <gmock/gmock.h>  // Brings in GoogleMock

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

// Usage
TEST(TurtleTest, PenUpGetsCalled) {
  MockTurtle mock_turtle;
  EXPECT_CALL(mock_turtle, PenUp()).Times(1);
  // Use mock_turtle in code under test
  mock_turtle.PenUp();  // Will satisfy the expectation
}
```
</Accordion>
<Accordion title="Using ON_CALL for default behavior">
```cpp
MockTurtle mock_turtle;
ON_CALL(mock_turtle, GetX()).WillByDefault(Return(5));
EXPECT_CALL(mock_turtle, PenUp());

// Any call to GetX that is not expected explicitly will return 5.
int x = mock_turtle.GetX();
EXPECT_EQ(x, 5);
```
</Accordion>
</AccordionGroup>

---

## Troubleshooting

- **Mocked method calls real method instead**: Confirm the method is declared `virtual` in the base class.
- **Compile errors on const methods**: Ensure proper placement of `const` qualifier in `MOCK_METHOD`.
- **Warnings about uninteresting calls**: Use `NiceMock` to suppress or add explicit `EXPECT_CALL` with `.Times(AnyNumber())`.
- **Failure due to order or cardinality not met**: Use `InSequence` or `After` clauses to define order and adjust `Times` accordingly.
- **Ambiguity with overloaded methods**: Disambiguate using argument matchers or `Const()` wrapper for `const` overloads.

---

## Summary Diagram

```mermaid
flowchart TD
  User[Test Code] -->|Defines Mock Class with MOCK_METHOD| MockClass[Mock Class]
  MockClass -->|Sets default behavior| ONCALL[ON_CALL()]
  MockClass -->|Sets expectations| EXPECTCALL[EXPECT_CALL()]
  TestCode -->|Calls Mock Methods| MockClass
  EXPECTCALL -->|Defines expected method calls, with cardinality, sequences, etc.| Behavior[Expected Behavior]
  ONCALL -->|Defines fallback action| Behavior
```

---

## Summary

You are equipped to define mock classes using the `MOCK_METHOD` macro, specify expectations with `EXPECT_CALL`, and set default behaviors using `ON_CALL`. Use matchers to express argument expectations and clauses like `Times()`, `InSequence()`, and `After()` to control invocation frequency and order. These tools empower you to create precise, readable, and maintainable mocks that seamlessly integrate into your unit testing workflows.

---

## See Also
- [Specifying Mock Expectations](https://google.github.io/googletest/reference/gmock-mocking-api/expectations-specification.html)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Actions and Side Effects](https://google.github.io/googletest/reference/gmock-mocking-api/mock-actions.html)
- [Nice, Naggy, and Strict Mocks](https://google.github.io/googletest/reference/gmock-mocking-api/nice-strict-mocks.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

---

<Tip>
The heart of GoogleMock's mock definition lies in `MOCK_METHOD`. Adopt a style that balances specific expectations (`EXPECT_CALL`) with general default behaviors (`ON_CALL`). Use sequences and expectation sets to model complex call order constraints.
</Tip>

<Note>
Because `MOCK_METHOD` generates method declarations for virtual functions, make sure the base class methods are declared virtual and the mock methods correctly mirror qualifiers like `const` and `noexcept`.
</Note>

<Warning>
Setting expectations after exercising mocks leads to undefined behavior and hard-to-debug failures. Always specify `EXPECT_CALL`s before your test code invokes mock methods.
</Warning>
