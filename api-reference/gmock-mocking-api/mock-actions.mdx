---
title: "Actions and Side Effects"
description: "Explores GoogleMock's actions framework, showing how to prescribe return values, trigger code, and set side effects when a mock function is called. Includes extension patterns for custom actions."
---

# Actions and Side Effects

Dive into GoogleMock's powerful actions framework that lets you control what happens when a mock function is called. This reference focuses exclusively on specifying return values, triggering callbacks, and setting side effects for mock functions, enabling you to create precise and flexible tests. Additionally, learn how to extend this framework to craft custom actions tailored to your unique testing needs.

---

## Understanding Actions

Actions in GoogleMock define the behavior of mocked methods upon invocation. Instead of simply verifying that a call was made, actions specify *what* the mock should do when called—such as returning a value, throwing exceptions, modifying outputs, or invoking callbacks.

Typically, you specify actions in your expectations via `.WillOnce()` or `.WillRepeatedly()` clauses, or set default behaviors with `ON_CALL`.

---

## Commonly Used Built-in Actions

### Returning Values

Actions that set return values are the most fundamental. Use these to control the output of your mock methods reliably.

| Action                 | Description                                                                                                                  |
|------------------------|------------------------------------------------------------------------------------------------------------------------------|
| `Return(value)`         | Return the specified `value`. The conversion to the mock method's return type happens at expectation *set* time, **not** at call time.
| `ReturnRef(variable)`   | Return a reference to an existing variable. Use when your mock method returns a reference.
| `ReturnPointee(ptr)`    | Return the value pointed to by the given pointer at the time the action executes.
| `ReturnNew<T>(args...)`| Return a newly constructed object of type `T` with the given constructor arguments. Creates a new object on every call.
| `ReturnNull()`          | Returns a null pointer.
| `ReturnRoundRobin({v1, v2, ...})` | Returns values from the list in a round-robin fashion.

#### Example:
```cpp
using ::testing::Return;

EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### Triggering Side Effects

Sometimes methods don’t just return a value but modify arguments or have other side effects. GoogleMock provides a suite of handy actions for this:

| Action                          | Description                                                                                          |
|--------------------------------|----------------------------------------------------------------------------------------------------|
| `SetArgPointee<N>(value)`       | Assign `value` to the pointer/dereferenced value of the N-th argument (0-indexed).
| `SetArrayArgument<N>(first, last)` | Copies values in `[first, last)` range to an array pointed to by the N-th argument.
| `Assign(&variable, value)`      | Assigns `value` to the given variable.
| `SaveArg<N>(pointer)`            | Saves a copy of the N-th argument to `*pointer`.
| `SaveArgByMove<N>(pointer)`     | Moves the N-th argument into `*pointer`.
| `DeleteArg<N>()`                | Deletes the pointer passed as the N-th argument.
| `SetErrnoAndReturn(error, value)` | Sets the global `errno` to `error` and returns `value`.
| `Throw(exception)`              | Throws the given exception object.

#### Example:
```cpp
using ::testing::SetArgPointee;

EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(SetArgPointee<1>(42));  // Sets second arg to 42 when called
```

### Composite Actions

Actions can be combined to perform multiple side effects or steps in sequence. Only the last action's return value is used.

| Action            | Description                                                                         |
|-------------------|-------------------------------------------------------------------------------------|
| `DoAll(a1, ..., an)` | Executes all specified actions in order; returns the result of the last one.
| `IgnoreResult(a)`   | Performs action `a` and discards its return value, useful when mocking void methods or combining with `DoAll`.
| `WithArg<N>(a)`    | Passes only the N-th mock argument to action `a`.
| `WithArgs<N1,...,Nk>(a)` | Passes selected arguments to `a` in order.
| `WithoutArgs(a)`   | Calls action `a` with no arguments.

### Example of DoAll chaining:
```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(DoAll(
      SetArgPointee<0>(5),
      Return(true)
    ));
```
This sets the first argument pointer to `5` and returns `true`.

---

## Using Callables as Actions

You can specify any callable (function, lambda, functor) compatible with the mock method signature as an action using `Invoke` or by passing the callable directly.

- `Invoke(f)` calls `f` with the mock arguments.
- `InvokeWithoutArgs(f)` calls `f` without arguments, ignoring the mock arguments.
- You can also invoke a method on an object, e.g., `Invoke(obj, &Class::Method)`.

### Invoking function parameters

If your mock function takes another callable as an argument, you can invoke the callable argument using `InvokeArgument<N>(args...)` where `N` is the index of the callable argument.

Example:
```cpp
EXPECT_CALL(mock, DoSomething(_, _))
    .WillOnce(InvokeArgument<1>(5));  // Calls the second argument as a function with 5
```

---

## Defining Custom Actions

When built-in actions are insufficient, write your own actions.

### Simple custom actions via lambdas or functors:
```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int x) { return x * 2; });
```

### Using the `ACTION` macro for parameterized actions:
```cpp
ACTION_P(Add, n) { return arg0 + n; }
EXPECT_CALL(mock, Foo(_)).WillOnce(Add(5));
```

### Writing polymorphic actions for multiple function signatures:
Implement a class with a template `Perform<Result, ArgsTuple>` method and wrap with `MakePolymorphicAction()`.

For detailed guidelines, see GoogleMock's extensibility documentation.

---

## Best Practices & Tips

- **Prefer `ON_CALL` for default behaviors** and `EXPECT_CALL` only when you want to verify interaction.
- **Use `NiceMock` to suppress warnings** for uninteresting calls when appropriate.
- **Use `StrictMock` to catch unexpected calls as errors** during tight verification.
- **When returning references, use `ReturnRef()` instead of `Return()`.**
- **Be mindful of the action evaluation timing:** `Return(value)` captures `value` at the time of setting the expectation.
- **Use `ReturnPointee()` to return up-to-date values pointed by pointers at the call time.**
- To set side effects and return values, use `DoAll()` to combine multiple actions.
- Use `SaveArg` or `SaveArgPointee` to capture arguments for later verifications.

---

## Troubleshooting Common Issues

- **Unexpected or uninteresting calls warnings:** Use `NiceMock` or add catch-all expectations (`EXPECT_CALL(foo, Bar(_)).Times(AnyNumber())`).
- **Mock method returns always the same value even if you want it dynamic:** Use `ReturnPointee()` or write a lambda to generate the return value dynamically.
- **Deleting mock arguments:** Use `DeleteArg<N>()` to safely delete pointer arguments.
- **Infinite recursion when delegating to parent classes:** Use the fully qualified call syntax (e.g., `foo.Foo::Concrete()` inside a lambda).

---

## Summary

GoogleMock's actions framework is your toolkit for prescribing precise mock behavior. Returning values, triggering side effects on output arguments, invoking callbacks, chaining multiple steps, or customizing your own actions: all are supported with flexible, easy-to-use APIs.

Mastering these lets you craft tests that not only verify interaction but also simulate realistic, context-aware behaviors of dependencies, leading to robust, maintainable, and expressive tests.

---

## Related Topics & Further Reading

- [Mocking Reference](../gmock-mocking-api/mock-object-definition)
- [Specifying Mock Expectations](../gmock-mocking-api/expectations-specification)
- [Matchers Library](../gmock-mocking-api/matchers-library)
- [Custom Actions, Matchers, and Extensions](../integration-environment/customization-extension)
- [gMock Cookbook](../gmock_cook_book.html) — practical recipes including actions
- [gMock for Dummies](../gmock_for_dummies.html) — beginner friendly guide to mocking

---