---
title: "Matchers and Actions"
description: "Utilize the rich library of built-in and extensible matchers for argument matching, and actions for controlling mock behavior in response to invocations. Includes advanced matching, combinatorial matchers, and custom matcher/action creation."
---

# Matchers and Actions

Harness the power of GoogleMock's built-in and customizable matchers for precisely validating mock method arguments and controlling mock behaviors through actions upon invocation. Whether you need straightforward equality checks, complex argument patterns, or bespoke matching logic, combined with flexible behaviors on mocks, this guide covers the full range of capabilities.

---

## 1. Matchers: Validating Mock Arguments

Matchers serve as predicates that specify the expected properties or values of mock method arguments. They allow you to express intent clearly and concisely when setting expectations. GoogleMock provides a rich set of matchers, composable to build sophisticated criteria.

### 1.1 Basic Usage

- **Exact Values:** Use plain values directly, e.g., `EXPECT_CALL(mock, Foo(5));` implicitly uses equality matcher `Eq(5)`.
- **Wildcard Matcher:** The underscore `_` matches any value, e.g., `EXPECT_CALL(mock, Foo(_));`.

```cpp
using ::testing::_;
EXPECT_CALL(mock, Process(_));  // Matches any argument
```

### 1.2 Built-in Matchers

GoogleMock offers matchers for numeric comparisons, string contents, containers, pointer states, and more:

- Comparison: `Ge()`, `Le()`, `Gt()`, `Lt()`, `Eq()`, `Ne()`
- String: `HasSubstr()`, `StartsWith()`, `EndsWith()`
- Container: `ElementsAre()`, `UnorderedElementsAre()`, `Contains()`
- Pointer Checks: `NotNull()`, `IsNull()`, `Pointee()`

### 1.3 Composing Matchers

Build complex requirements with combinators:

- `AllOf(m1, m2, ...)` — all must match.
- `AnyOf(m1, m2, ...)` — any must match.
- `Not(m)` — negates matcher.

```cpp
using ::testing::AllOf;
EXPECT_CALL(mock, Foo(AllOf(Ge(5), Ne(10)))); // Argument >= 5 and != 10
```

### 1.4 Matching Multiple Arguments as a Whole

Use `.With()` clause on expectations to apply a matcher over all arguments in a tuple:

```cpp
EXPECT_CALL(mock, SetPosition(_, _)).With(Lt()); // first arg less than second arg
```

You can also select specific arguments using `Args<k1, ..., kn>(matcher)` to match argument tuples.

### 1.5 Custom Matchers

Define reusable custom matchers using `MATCHER` and `MATCHER_P` macros for expressive and descriptive matching.

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}
EXPECT_CALL(mock, Bar(IsDivisibleBy7()));
```

For more detailed control, implement matcher classes with `MatchAndExplain()`, `DescribeTo()`, and `DescribeNegationTo()` methods.

### 1.6 Advanced Predicate and Member Matching

- Wrap arbitrary predicates with `Truly()` for flexible behavioral checks.
- Use `Field(&Class::member, matcher)` and `Property(&Class::getter, matcher)` to validate object members or getter results within arguments.
- Use `Pointee(matcher)` to match values pointed to by pointers/smart pointers.

### 1.7 Matchers with Containers

Matchers like `ElementsAre()` and `UnorderedElementsAre()` accommodate STL containers and support complex element value patterns, including nested container matching.

---

## 2. Actions: Controlling Mock Behavior

Actions define what a mock method does when called, such as returning specified values, modifying arguments, or invoking user code.

### 2.1 Returning Values

| Action                   | Description                                                  |
|-------------------------|--------------------------------------------------------------|
| `Return()`              | Return from a void mock function.                             |
| `Return(value)`         | Return the specified value (evaluated when expectation set). |
| `ReturnRef(var)`        | Return a reference to a variable.                            |
| `ReturnPointee(ptr)`    | Return the value pointed to by `ptr`.                        |
| `ReturnNew<T>(args...)` | Return a new object created each call by `new T(args...)`.  |

### 2.2 Side Effects on Arguments

Modify or capture arguments using these actions:

- `SetArgPointee<N>(value)`: Assign a value to the pointer argument at position N.
- `SetArrayArgument<N>(first, last)`: Copy elements into array argument.
- `SaveArg<N>(pointer)`: Save the N-th argument by copy into `*pointer`.
- `DeleteArg<N>()`: Deletes the pointer passed as argument N.

```cpp
EXPECT_CALL(mock, Mutate(true, _))
    .WillOnce(SetArgPointee<1>(5));
```

### 2.3 Combining Multiple Actions

Use `DoAll(a1, a2, ..., an)` to perform multiple actions sequentially, returning the result of the last action.

```cpp
EXPECT_CALL(mock, Foo())
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

### 2.4 Using Callables as Actions

Invoke functions, functors, or lambdas on mock calls with `Invoke()`, `InvokeWithoutArgs()`, or `InvokeArgument<N>()` to simulate complex behaviors.

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(Invoke([](int x) { return x * 2; }));
```

### 2.5 Ignoring Action Result

`IgnoreResult(action)` discards the return value of an action if a void return is needed.

### 2.6 Action Argument Selection

Use `WithArg<N>(action)` or `WithArgs<N1, ...>(action)` to pass selected arguments to another action.

### 2.7 Default and Repeated Actions

- Use `ON_CALL()` to set default behavior without expectation.
- Use `WillOnce()` and `WillRepeatedly()` for specifying sequential or ongoing actions.

### 2.8 Return Live or Move-Only Values

Use lambdas or `ReturnPointee()` for returning live-updated values. Maneuver move-only types (e.g., `std::unique_ptr`) seamlessly using lambdas and `MOCK_METHOD` support.

### 2.9 Writing Custom Actions

Define new actions with:

- `ACTION` and `ACTION_P` macros for concise templated actions.
- Functors or lambdas with call operators.
- Implementing `ActionInterface` for detailed control.

### 2.10 Common Action Recipes

- Changing mock behavior through call sequences using `InSequence`.
- Delegating calls to a real or fake object.
- Triggering side-effect actions like notifications or deletion inside actions.

---

## 3. Using Matchers and Actions Together

Matchers and actions combine to specify expected calls and their outcomes in tests:

```cpp
using ::testing::Return;
using ::testing::_;

EXPECT_CALL(mock, Compute(_))
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

This specifies that `Compute` is called three times, returning `10`, `20`, then `30` every subsequent call.

---

## 4. Best Practices

- Prefer `ON_CALL` for default behaviors and use `EXPECT_CALL` sparingly to verify specific interactions.
- Use `NiceMock` to suppress warnings on uninteresting calls when you do not care about all calls.
- Use sequences (`InSequence`, `Sequence`) to enforce call order where needed.
- Avoid over-constraining with excessive expectations; keep tests resilient and easy to maintain.
- Leverage custom matchers/actions for domain-specific accuracy in tests.

---

## 5. Troubleshooting

- Use `--gmock_verbose=info` CLI flag to get detailed logs of matcher matches and mock calls.
- If a test fails due to unexpected calls, check argument matchers carefully.
- Make sure the mock class has virtual destructors to avoid leaking failures.
- Suppress spurious warnings by explicitly expecting or allowing calls via `EXPECT_CALL(...).Times(AnyNumber())` or using `NiceMock`.

---

## 6. Additional Resources

- [GoogleMock for Dummies](../gmock_for_dummies.md): Beginner-friendly introduction.
- [Mocking Reference](docs/reference/mocking.md): Core concepts on mocks.
- [Actions Reference](docs/reference/actions.md): Detailed list of built-in actions.
- [Matchers Reference](reference/matchers.md): Comprehensive matcher catalog.
- [gMock Cookbook](docs/gmock_cook_book.md): Recipes and common patterns.

---

Developing a fluent command of GoogleMock's matchers and actions empowers precise, readable, and maintainable tests. Use this combined knowledge to write mocks that rigorously verify your code's interactions without becoming brittle or cumbersome.

---

```mermaid
graph TD
  A[Define Mock Class]
  B[Set Expectations with EXPECT_CALL]
  C[Specify Argument Matchers]
  D[Specify Actions (WillOnce(), WillRepeatedly())]
  E[Use ON_CALL for Defaults]
  F[Execute Code Under Test]
  G[Verify Expectations Automatically on Mock Destruction]

  A --> B
  B --> C
  C --> D
  D --> F
  E --> F
  F --> G
```
