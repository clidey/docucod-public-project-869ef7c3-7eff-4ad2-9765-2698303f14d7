---
title: "Actions, Sequences, and Cardinalities"
description: "API details for assigning behaviors to mocked methods, specifying call counts (cardinalities), and sequencing expectations. Covers built-in and custom actions, with practical usage of ON_CALL and EXPECT_CALL macros. Empower users to express nuanced interaction patterns and result stubbing."
---

# Actions, Sequences, and Cardinalities

GoogleMock empowers you to finely control and verify mocked methods' behaviors through the use of **actions**, **sequences**, and **cardinalities**. This documentation page dives deep into these constructs, equipping you to:

- Assign behaviors to mocked methods with built-in and custom actions.
- Precisely specify how many times a method should be called using cardinalities.
- Define ordering constraints on calls with sequences.

Mastering these APIs lets you express complex interaction patterns and stateful behaviors in your tests, making mocks both expressive and reliable.

---

## 1. Assigning Behaviors to Mocked Methods: Actions

When you write a mock class, by default, methods return built-in default values or do nothing. To make your mocks meaningful, **actions** specify what a mocked method should do when invoked.

### 1.1 Using ON_CALL and EXPECT_CALL

- `ON_CALL(mock_obj, Method(args))` *sets the default behavior* of the mocked method when called with matching arguments. It does **not** set an expectation that the method must be called.

- `EXPECT_CALL(mock_obj, Method(args))` *sets an expectation* that the method will be called with matching arguments. It also optionally defines the action to perform.

### 1.2 Built-in Actions

GoogleMock provides many built-in actions that you can chain via `.WillOnce()` and `.WillRepeatedly()` clauses:

- `Return(value)`: Returns a value. For reference types, use `ReturnRef(variable)`.

- `ReturnPointee(pointer)`: Returns the value pointed to by `pointer` at call time.

- `Invoke(callable)`: Invokes a function, method, or lambda.

- `DoAll(actions...)`: Executes multiple actions sequentially; only the last action's return value is used.

- `SetArgPointee<N>(value)`: Sets the *N*-th (0-based) pointer argument to `value`.

- `SetArrayArgument<N>(first, last)`: Copies an array to the pointer argument.

- `IgnoreResult(action)`: Ignores an action's return value (useful when the function expects `void`).

- `InvokeArgument<N>(args...)`: Invokes the *N*-th argument if it is callable, passing the given args.

### 1.3 Defining Custom Actions

For behaviors beyond built-ins, you can provide any callable compatible with the mocked method's signature, including lambdas or functors:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int x) { return x * 2; });
```

Use `ACTION` macros or implement `ActionInterface` for more complex reusable actions.

### 1.4 Important Usage Patterns and Tips

- The *last* matching `EXPECT_CALL` takes precedence.
- Use `ON_CALL` to specify default behaviors common to many tests.
- Use `EXPECT_CALL` for calls you want to verify.
- Avoid over-specifying expectations; too many expectations make tests brittle.
- You can chain multiple `.WillOnce()` clauses followed by optionally one `.WillRepeatedly()`.
- When mocking methods that accept or return move-only types (e.g., `unique_ptr`), use lambdas or callable objects for actions.

### 1.5 Example

```cpp
using ::testing::Return;

class MockTurtle {
 public:
  MOCK_METHOD(int, GetX, (), (const));
  MOCK_METHOD(void, Forward, (int distance));
};

MockTurtle turtle;

ON_CALL(turtle, GetX()).WillByDefault(Return(42));
EXPECT_CALL(turtle, Forward(100))
    .Times(1)
    .WillOnce([](int distance) {
      std::cout << "Moving forward " << distance << " units\n";
    });

turtle.Forward(100);  // Prints message
int x = turtle.GetX();  // Returns 42
```

---

## 2. Controlling Invocation Count: Cardinalities

A **cardinality** specifies how many times a mocked method call is expected to occur.

### 2.1 Using the `.Times()` Clause

Add `.Times(cardinality)` after `EXPECT_CALL()` to define call count expectations.

If omitted, GoogleMock infers the cardinality based on `WillOnce` and `WillRepeatedly` clauses:

- No `.WillOnce()` or `.WillRepeatedly()` → `Times(1)`
- *n* `.WillOnce()` and no `.WillRepeatedly()` → `Times(n)`
- *n* `.WillOnce()` and `.WillRepeatedly()` → `Times(AtLeast(n))`

### 2.2 Built-in Cardinalities

All cardinality functions are in the `testing` namespace:

| Cardinality       | Meaning                                      |
| ----------------- | -------------------------------------------- |
| `AnyNumber()`     | Any number of calls allowed.                  |
| `AtLeast(n)`      | At least `n` calls.                           |
| `AtMost(n)`       | At most `n` calls.                            |
| `Between(m, n)`   | Between `m` and `n` calls inclusive.         |
| `Exactly(n)` or `n` | Exactly `n` calls. If `n == 0`, the call should never happen. |

### 2.3 Custom Cardinalities

You can define your own cardinalities by implementing the `CardinalityInterface`:

```cpp
class EvenNumberCardinality : public CardinalityInterface {
 public:
  bool IsSatisfiedByCallCount(int call_count) const override {
    return call_count % 2 == 0;
  }
  bool IsSaturatedByCallCount(int /*call_count*/) const override {
    return false;
  }
  void DescribeTo(std::ostream* os) const override {
    *os << "called even number of times";
  }
};

Cardinality EvenNumber() {
  return Cardinality(new EvenNumberCardinality);
}
```

Then use `.Times(EvenNumber())` in your expectations.

### 2.4 Example

```cpp
using ::testing::AtLeast;
using ::testing::Return;

EXPECT_CALL(turtle, Forward(100))
    .Times(AtLeast(2))
    .WillRepeatedly(Return());

// The Forward(100) call must happen two or more times.
```

---

## 3. Ordering Calls: Sequences

Sometimes your test depends not only on *which* calls happen, but also *when* in relation to others. GoogleMock provides sequences to express such ordering.

### 3.1 Using the `InSequence` Object

Wrap expected calls in an `InSequence` object scope to require that calls happen in the order declared.

```cpp
using ::testing::InSequence;

{
  InSequence s;

  EXPECT_CALL(mock1, Foo());
  EXPECT_CALL(mock2, Bar());
}

// Now Foo() must be called before Bar().
```

### 3.2 Named Sequences with `Sequence`

For more complex partial ordering, create `Sequence` objects and assign expectations to them with `.InSequence()`:

```cpp
using ::testing::Sequence;

Sequence seq1, seq2;

EXPECT_CALL(mock1, A()).InSequence(seq1, seq2);
EXPECT_CALL(mock2, B()).InSequence(seq1);
EXPECT_CALL(mock3, C()).InSequence(seq2);
EXPECT_CALL(mock4, D()).InSequence(seq2);
```

This means `A()` must occur before `B()` and `C()`, and `C()` before `D()`. There is no ordering between `B()` and `C()`.

### 3.3 The `.After()` Clause

Alternatively, use `.After()` to specify that one expectation must occur after others:

```cpp
Expectation e1 = EXPECT_CALL(mock, Foo());
EXPECT_CALL(mock, Bar()).After(e1);
```

You can chain `.After()` clauses and specify up to five expectations or sets.

### 3.4 Retiring Expectations

By default, expectations remain *sticky*, even after they are saturated. To retire an expectation immediately when saturated, add `.RetiresOnSaturation()`.

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
```

This allows subsequent calls not to match the retired expectation.

---

## 4. Practical Usage Patterns

This section highlights best practices when using actions, sequences, and cardinalities together.

### 4.1 Specifying Multiple Actions

You can use multiple `.WillOnce()` clauses followed by one optional `.WillRepeatedly()`:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

This sets up specific return values for the first two calls and a default thereafter.

### 4.2 Ordering with Sequences

Use `InSequence` or `Sequence` for tests where call order matters. Combine with `.RetiresOnSaturation()` on expectations in sequences to avoid sticky expectations interfering.

### 4.3 Controlling Call Counts

Use cardinalities deliberately:

- Use `Times(0)` to ensure a method is *never* called.
- Use `AtLeast` or `Between` to express flexible counts.
- Avoid over-constraining your tests to reduce brittleness.

### 4.4 Avoiding Common Pitfalls

- Set expectations before code execution; setting them after is undefined behavior.
- Be aware that newer `EXPECT_CALL` overrides older; order your expectations accordingly.
- Use `ON_CALL` to specify defaults that apply when no expectations exist.
- Be cautious when mocking overloaded methods; specify argument types or use `Const()` helper.

### 4.5 Debugging Tips

- Use `--gmock_verbose=info` to see detailed traces of expectations and calls.
- If tests unexpectedly fail on call counts or order, check the specified sequences and cardinalities.

---

## 5. Summary

Actions define *what* the mock does when called.
Cardinalities define *how many times* the calls occur.
Sequences define *in what order* the calls should happen.

Mastering these constructs brings expressive power and precision to your mock-based tests.

---

## 6. Reference Links

- [gMock Cookbook - Using Actions](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#using-actions)
- [Mocking Reference - ON_CALL and EXPECT_CALL](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#expect_call)
- [Built-in Cardinalities](https://github.com/google/googletest/blob/main/include/gmock/gmock-cardinalities.h)
- [Sequences and Ordering](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#ordered-calls)

---