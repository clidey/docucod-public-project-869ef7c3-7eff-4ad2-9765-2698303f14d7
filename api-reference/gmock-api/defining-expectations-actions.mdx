---
title: "Defining Expectations and Actions"
description: "Outlines ON_CALL and EXPECT_CALL macros for specifying mock object expectations, default and custom actions, and call sequences. Details how to express invocation criteria and behaviors, including advanced action templates and customization hooks."
---

# Defining Expectations and Actions

This documentation details the `ON_CALL` and `EXPECT_CALL` macros in GoogleMock, which enable precise specification of mock object expectations, default and custom actions, and the sequencing of calls. It guides you in expressing invocation criteria and behaviors, including advanced use cases with action templates and customization hooks.

---

## Overview of Mock Expectations and Actions

GoogleMock allows you to finely control how mock objects behave and what calls are expected on them. This is primarily achieved using two macros:

- `ON_CALL` specifies the default behavior of mock methods when they are called but not explicitly expected.
- `EXPECT_CALL` sets expectations on mock method calls, including how many times and in what order they occur, and defines the actions performed when these calls happen.

Both macros accept method names along with argument matchers to express fine-grained conditions.

## `ON_CALL` Macro

`ON_CALL(mock_object, method_name(matchers...))` defines default behavior for calls matching the argument matchers on a mock object **without** setting any expectation that such calls will happen.

### Typical Usage

```cpp
ON_CALL(my_mock, SomeMethod(_))
    .WillByDefault(Return(42));
```

This states that whenever `SomeMethod` is called on `my_mock`, it returns `42` by default, without requiring such calls to be verified.

### Important Properties

- Default behavior can be further restricted using `.With(multi_argument_matcher)` which matches the entire argument tuple.
- `.WillByDefault(action)` is mandatory for `ON_CALL` and specifies the action taken when the call matches.
- Multiple `ON_CALL`s can be declared; the last matching one will be used.
- `ON_CALL` **does not** set expectations. Calls matching only `ON_CALL` specifications are called "uninteresting" in gMock terminology and will not cause test failures.

### Usage Notes

- Use `ON_CALL` in test setup or in mock constructor to specify the common default mock behavior that applies to all tests.
- Avoid setting expectations with `ON_CALL`. For verification, use `EXPECT_CALL`.

### Example With `.With()` Clause

```cpp
ON_CALL(my_mock, SetPosition(_, _))
    .With(Lt())
    .WillByDefault(Return(true));
```

This states the default behavior when the first argument is less than the second.


## `EXPECT_CALL` Macro

`EXPECT_CALL(mock_object, method_name(matchers...))` creates an expectation that the method *must* be invoked with arguments matching the matchers. It also allows specifying the number of expected calls, call order, and the actions to perform.

### Basic Syntax

```cpp
EXPECT_CALL(my_mock, SomeMethod(arg_matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action)
    .InSequence(sequence_objs...)
    .After(expectations...)
    .RetiresOnSaturation();
```

### Ordering Restrictions on Clauses

Clauses must appear in this order, and can appear multiple times as noted:

- `.With(...)` - at most once, must be first clause
- `.Times(...)` - at most once
- `.InSequence(...)` - zero or more times
- `.After(...)` - zero or more times
- `.WillOnce(...)` - zero or more times
- `.WillRepeatedly(...)` - at most once
- `.RetiresOnSaturation()` - at most once, must be last clause

### Clause Details

| Clause                | Description |
|-----------------------|-------------|
| `.With(matcher)`      | Restricts expectation to calls whose arguments as a tuple match the matcher.
| `.Times(cardinality)` | Specifies how many times the call is expected; supports `AnyNumber()`, `AtLeast(n)`, `AtMost(n)`, etc.
| `.InSequence(sequences...)` | Specifies that calls occur in order defined by sequence(s).
| `.After(expectations...)` | Call must occur after given expectations are satisfied.
| `.WillOnce(action)`   | Defines action for one matching call; multiple may be chained.
| `.WillRepeatedly(action)` | Defines action for remaining calls after `WillOnce` actions exhausted.
| `.RetiresOnSaturation()` | Expectation becomes inactive after the upper call count is reached, useful to avoid "sticky" expectations.

### Call Cardinalities

If `Times()` is omitted, GoogleMock infers it:

- No `WillOnce` or `WillRepeatedly` => `Times(1)`
- `n` `WillOnce`s, no `WillRepeatedly` => `Times(n)`
- `n` `WillOnce`s and one `WillRepeatedly` => `Times(AtLeast(n))`

Use `Times(0)` to disallow calls.

### Defining Actions

Each matching call triggers the next `WillOnce` action if available, or the `WillRepeatedly` action thereafter. Actions define the callâ€™s behavior such as returning values, throwing exceptions, or executing functions.

#### Example of multiple `WillOnce`

```cpp
EXPECT_CALL(my_mock, Compute())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));
```

#### Example of `WillRepeatedly`

```cpp
EXPECT_CALL(my_mock, GetName())
    .WillOnce(Return("Alice"))
    .WillRepeatedly(Return("Bob"));
```

Calls will return "Alice" once, then "Bob".

### Call Expectations and Ordering

To specify call order:

- Use `InSequence` objects and `.InSequence()` clause to define a partial ordering.
- Use the `.After()` clause to specify that an expectation is valid only after others have been satisfied.

### Controlling Expectation Retiring

By default, expectations stay "sticky" after their upper call bound is reached, causing failures if called again. Use `.RetiresOnSaturation()` to make them inactive once saturated.

### Tips for `EXPECT_CALL`

- Order your `EXPECT_CALL`s so that more specific cases come after more general ones for proper matching.
- Use sequences and `.After()` to declare ordering without over-constraining tests.
- Avoid setting expectations after the mock has been exercised.

### Example: Partial Order

```cpp
using ::testing::Sequence;
Sequence seq1, seq2;

EXPECT_CALL(mock, Start()).InSequence(seq1, seq2);
EXPECT_CALL(mock, Load()).InSequence(seq1);
EXPECT_CALL(mock, Execute()).InSequence(seq2);
```

This means `Start()` happens before both `Load()` and `Execute()`. `Load()` and `Execute()`'s order is unconstrained.

## Key Concepts in Expectations

- **Argument Matchers:** Specify which call arguments the expectation matches
- **Cardinality:** How many times an expectation should be called
- **Sequences:** Enforce ordering constraints on calls
- **Actions:** Define what happens when a call matches the expectation

## Advanced Concepts

### Multi-Argument Matchers

Use `.With(matcher_of_tuple)` to match multiple arguments as a whole. Useful for conditions that involve relationships among arguments.

Example:

```cpp
EXPECT_CALL(foo, Func(_, _)).With(Lt());  // First arg is less than second
```

### Chaining Actions

Use multiple `.WillOnce()` clauses to specify different actions on successive calls. Combine with `.RetiresOnSaturation()` if needed.

### Retiring Expectations

Use `.RetiresOnSaturation()` to retire an expectation after it has been called the maximum number of times. This is useful to avoid expectation conflicts and "sticky" behavior.

### Defining Default Actions per Method

Use `ON_CALL` to set method-wide default behavior that applies when no matching `EXPECT_CALL` exists.

### Tips for Writing stable Tests Using Expectations

- Prefer `ON_CALL` for common default behavior.
- Use `EXPECT_CALL` only where you want to verify interaction.
- Avoid excessive use of ordering constraints to keep tests flexible.
- Name your expectations or provide descriptions with `.Description()` to aid debugging.

## Troubleshooting Common Issues

### Unexpected Calls

When a call doesn't match any `EXPECT_CALL`, GoogleMock reports an error showing all expectations tested. Check argument matchers and call order.

### Too Few or Too Many Calls

GoogleMock warns if the number of calls does not match cardinality. Consider adjusting `.Times()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()` accordingly.

### Sticky Expectations

If calls are rejected after the expected count, but logically should have passed, consider adding `.RetiresOnSaturation()`.

### Order Violations

Use sequences (`InSequence`) and `.After()` carefully. Ensure test logic matches the call partial order expressed.

## Code Examples

### Setting Default Action with `ON_CALL`

```cpp
ON_CALL(my_mock, Save(_))
    .WillByDefault(Return(true));
```

### Expecting Specific Calls with `EXPECT_CALL`

```cpp
using ::testing::Return;
EXPECT_CALL(my_mock, GetNum())
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### Sequencing Calls

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(my_mock, Init());
  EXPECT_CALL(my_mock, Process());
  EXPECT_CALL(my_mock, Cleanup());
}
```

### Partial Ordering Using Sequences

```cpp
using ::testing::Sequence;
Sequence s1, s2;
EXPECT_CALL(my_mock, Start()).InSequence(s1, s2);
EXPECT_CALL(my_mock, Load()).InSequence(s1);
EXPECT_CALL(my_mock, Run()).InSequence(s2);
```

## Summary

`ON_CALL` and `EXPECT_CALL` enable clear, expressive, and fine-grained control over how your mock objects behave and are verified in your tests. By mastering these macros along with clauses like `.With()`, `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()`, you create robust mocks that reflect your test intent precisely and flexibly.

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googlemock/include/gmock/gmock-spec-builders.h", "range": "25-456"},{"path": "googlemock/src/gmock-spec-builders.cc", "range": "50-655"}]} />

---

## References for Further Mastery

- [GoogleTest Mocking Reference: EXPECT_CALL](https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL)
- [gMock Cookbook: Setting Expectations](https://google.github.io/googletest/gmock_cook_book.html#setting-expectations)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html#Using_Mocks)

---

## Practical Tip

Remember, `EXPECT_CALL` statements must be set *before* exercising the code under test. Use `ON_CALL` for default mock behavior that applies across many tests without verification. Over-specifying expectations can lead to brittle tests; favor readability and intent clarity over complex call order constraints.

<Callout title="Tip">
Always combine `.WillOnce()` and `.WillRepeatedly()` to define both specific and default mock behaviors, and prefer `RetiresOnSaturation` in scenarios with multiple expected calls to avoid failures due to sticky expectations.
</Callout>


