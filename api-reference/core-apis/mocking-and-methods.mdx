---
title: "Mock Objects and Methods"
description: "API reference for defining mock classes and methods, using the MOCK_METHOD macros, and integrating mock objects into tests. Includes examples for strictness settings and key patterns for simulating dependencies."
---

# Mock Objects and Methods

This reference page provides comprehensive information on creating mock classes and defining mock methods using GoogleTest’s `MOCK_METHOD` macros, along with guidance on integrating mock objects into tests. It covers how to specify mock behavior, enforce strictness levels, and simulate dependencies effectively.

---

## Defining Mock Methods with `MOCK_METHOD`

GoogleTest uses the `MOCK_METHOD` macro to declare mock methods inside mock classes. This macro simplifies mocking method signatures with various qualifiers.

### Basic Syntax

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers...));
```

- **ReturnType**: The method’s return type.
- **MethodName**: The name of the method being mocked.
- **Args...**: The method’s argument types enclosed in parentheses.
- **Qualifiers...**: Optional method qualifiers such as `const`, `override`, `noexcept`, `Calltype(...)` for calling conventions, and reference qualifiers (`ref(&)`, `ref(&&)`).

> Note: `MOCK_METHOD` must be placed in the `public:` section of your mock class even if the original method was `private` or `protected` to allow expectations to be set.

#### Handling Commas in Types

Types that contain commas (e.g., `std::pair<bool,int>`) require extra care to avoid parsing errors. Wrap the entire type in parentheses or use type aliases:

```cpp
class MyMock {
 public:
  // Wrapping with parentheses
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());

  // Using type aliases
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
};
```

### Mocking Const and Overloaded Methods

For const methods, include `(const, override)` in the qualifier list:

```cpp
MOCK_METHOD(int, GetValue, (), (const, override));
```

Overloaded methods should be mocked with full signatures to avoid ambiguity. Use `using Base::Method;` if not mocking all overloads to prevent base-class method hiding.

### Mocking Non-Virtual Methods

To mock non-virtual methods for compile-time dependency injection, provide mock methods with the same signatures without the `override` qualifier:

```cpp
class MockStream {
 public:
   MOCK_METHOD(size_t, NumberOfPackets, (), (const));
};
```

Use templating or other design patterns to switch between real and mock implementations at compile time.

### Mocking Class Templates

Template classes are mocked like regular classes with `MOCK_METHOD` in the template definition.

```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

### Mocking Private and Protected Methods

Always place `MOCK_METHOD` definitions in the public section to enable mocking of private and protected methods.

### Old-style `MOCK_METHODn` Macros

Legacy macros like `MOCK_METHOD1`, `MOCK_CONST_METHOD1` are supported but migrating to `MOCK_METHOD` is recommended for consistency and flexibility.

---

## Setting Expectations with `EXPECT_CALL`

Use `EXPECT_CALL` to specify that a mock method is expected to be called with certain arguments and behaviors.

### Basic Usage

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- The method call arguments can be exact values or matchers (`_` for wildcard).
- `Times()` defines how many times the call is expected (e.g., `Exactly(n)`, `AtLeast(n)`).
- `WillOnce` and `WillRepeatedly` specify behavior for the single-call and repetitive calls, respectively.

If no `Times()` is specified, GoogleMock infers it from the number of `WillOnce()` and presence of `WillRepeatedly()`.

### Call Modifier Clauses

Clauses can be chained to refine the expectations:

| Clause                  | Purpose                                                                                          |
|-------------------------|------------------------------------------------------------------------------------------------|
| `.With(matcher)`        | Restricts expectation to calls whose argument tuple matches a multi-argument matcher.           |
| `.Times(cardinality)`   | Specifies the expected number of calls.                                                        |
| `.InSequence(seq...)`   | Enforces call ordering according to one or more `Sequence` objects.                            |
| `.After(expec...)`      | Specifies this call must happen after one or more `Expectation` or `ExpectationSet` objects.   |
| `.WillOnce(action)`     | Specifies action performed on exactly one matching call.                                      |
| `.WillRepeatedly(action)` | Specifies action performed on all subsequent matching calls beyond `WillOnce`s.              |
| `.RetiresOnSaturation()`| Retires expectation after it has been saturated (highest call limit reached).                  |

---

## Setting Default Behavior with `ON_CALL`

`ON_CALL` defines the default behavior of a mock method without setting expectations:

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // optional
    .WillByDefault(action);
```

- Use `ON_CALL` to specify usual behavior when you don't want to require calls.
- Default actions are overridden by `EXPECT_CALL`'s `WillOnce` or `WillRepeatedly` if specified.

---

## Managing Mock Object Strictness

GoogleTest provides decorators to control how uninteresting calls (calls with no matching expectation) are handled.

| Strictness         | Behavior on Uninteresting Calls          | Use Case                                              |
|--------------------|-----------------------------------------|-------------------------------------------------------|
| `NiceMock<T>`      | Suppresses warnings                     | When you don't care about extra calls and want cleaner output.
| `NaggyMock<T>`     | Prints warnings (default)                | Useful for discovering unexpected calls.
| `StrictMock<T>`    | Treats uninteresting calls as failures | When you want to tightly control and verify all calls.

Use these by wrapping your mock object:

```cpp
NiceMock<MockClass> nice_mock;
StrictMock<MockClass> strict_mock;
```

**Important:**

- `NiceMock` and `StrictMock` only affect uninteresting calls, not unexpected calls.
- They only apply to mock methods declared **directly** in `MockClass` (not inherited).
- Mocks should generally have a virtual destructor.

---

## Sequences and Ordering

GoogleTest supports strict and partial ordering of mock method calls.

- Use the `Sequence` class and `.InSequence()` clause to specify that certain calls occur in a strict order.

- Use `.After()` clause to specify dependencies so that a call happens after other specified expectations.

- `InSequence` blocks automatically arrange contained expectations in order.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Reset())
    .InSequence(s1, s2);
EXPECT_CALL(mock, GetSize())
    .InSequence(s1);
EXPECT_CALL(mock, Describe())
    .InSequence(s2);
```

This ensures `Reset()` is called before `GetSize()` and `Describe()`. `GetSize()` and `Describe()` can be called in any order relative to each other.

---

## Mocking Side Effects and Actions

You can specify how mock methods behave when invoked using built-in actions or custom ones.

### Common Built-in Actions

| Action                          | Description                          |
|--------------------------------|------------------------------------|
| `Return(value)`                | Return a specified value.           |
| `ReturnRef(variable)`          | Return a reference to a variable.  |
| `ReturnPointee(pointer)`       | Return value pointed-to by `pointer` at call time.
| `SetArgPointee<N>(value)`      | Set the `N`th argument's pointee to `value`.
| `DoDefault()`                  | Perform the default action.         |
| `Invoke(function)`             | Call a user function or lambda.
| `DoAll(a1, a2, ..., an)`       | Perform multiple actions in order.
| `IgnoreResult(action)`         | Ignore the action's return value for `void` functions.

### Combining Actions

Chain multiple actions using `DoAll()`. When mixing side effects and return values, put return-value actions last.

Example:

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

### Custom Behavior

Use lambdas, function pointers or functors with `Invoke()` to define sophisticated behavior.

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce(Invoke([](int x) { return x*x; }));
```

---

## Delegating Calls

You can delegate mock calls to fakes or real objects for realistic behavior with verification:

### Delegation to a Fake

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, DoSomething, (int), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoSomething).WillByDefault([this](int x) {
      return fake_.DoSomething(x);
    });
  }

 private:
  FakeFoo fake_;
};
```

### Delegation to a Real Object

```cpp
ON_CALL(*this, SomeMethod).WillByDefault([this](Args... args) {
  return real_.SomeMethod(args...);
});
```

---

## Advanced Usage and Tips

- **Verifying expectations early:** Call `Mock::VerifyAndClearExpectations(&mock)` before destruction if the mock's lifespan is uncertain.

- **Speeding up compilation:** Define mock class constructors and destructors out-of-line in `.cc` files to improve compile performance.

- **Mocking destructors:** Mock destructor calls by adding a mock method (e.g., `Die()`) called inside the destructor.

- **Asserting calls never occur:** Use `.Times(0)` in `EXPECT_CALL`.

- **Suppressing uninteresting call warnings:** Use `NiceMock` or add catch-all expectations with `Times(AnyNumber())`.

- **Handling overloaded methods:** Use `Const()` wrapper or specify exact argument types to resolve ambiguities.

- **Matchers:** Use built-in or custom matchers to specify argument constraints (see Matchers Reference).

---

## Examples

### Defining a Mock Class

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Setting Expectations and Default Actions

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::AtLeast;

MockTurtle turtle;

ON_CALL(turtle, GetX())   // Default behavior
    .WillByDefault(Return(0));

EXPECT_CALL(turtle, PenDown())  // Expect the call
    .Times(AtLeast(1));
EXPECT_CALL(turtle, Forward(100))  // Expect call with specific arg
    .WillOnce(Return());

// Exercise your code using 'turtle'
```

### Using Strictness Classes

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockTurtle> relaxed_mock;
StrictMock<MockTurtle> strict_mock;
```

### Ordering Calls

```cpp
using ::testing::InSequence;

{
  InSequence seq;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
```

Calls to `First()` must occur before `Second()`.

---

For extended examples and deep dives, refer to the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) and [Mocking Workflows Guide](../guides/effective-testing-techniques/mocking-workflows.html).

---

## Troubleshooting Common Issues

- If you encounter compilation errors related to commas in types, apply parentheses or type aliases for complex types.
- Ensure virtual destructors in base classes to avoid leaks and undefined behavior.
- If you see "Uninteresting mock function call" warnings, consider using `NiceMock` or adding a default catch-all expectation.
- When mocking overloaded methods, disambiguate with argument lists or `Const()` wrapper.
- If your mock methods don’t behave as expected, verify the sequence and cardinalities of your `EXPECT_CALL`s.

---

## References and Further Reading

- [Mocking Reference](../api-reference/core-apis/mocking-and-methods.html)
- [Matchers Reference](../api-reference/advanced-behaviors/argument-matchers.html)
- [Actions Reference](../api-reference/advanced-behaviors/mock-actions.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [GoogleTest Primer](https://google.github.io/googletest/primer.html)

---

## Source

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "docs/reference/mocking.md", "range": "1-677"}]} />
<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googlemock/include/gmock/gmock-spec-builders.h", "range": "1-555"}]} />

