---
title: "Mock Class APIs and Expectations"
description: "Introduces mock class generation using MOCK_METHOD macros and describes how to set method expectations, specify default actions, and verify interactions using GoogleMock. Includes guidance for strict, nice, and naggy mock types."
---

# Mock Class APIs and Expectations

GoogleMock provides powerful macros and constructs for generating mock classes and setting expectations on method calls. This page guides you through defining mock classes with the `MOCK_METHOD` macro, setting expectations via `EXPECT_CALL`, managing default actions with `ON_CALL`, and controlling mock strictness using specialized mock wrappers like `NiceMock`, `NaggyMock`, and `StrictMock`.

---

## Defining Mock Classes with `MOCK_METHOD`

At the heart of GoogleMock’s mocking capabilities is the `MOCK_METHOD` macro. It enables you to define a mock method inside your mock class that simulates the behavior of the real method interface.

### Syntax

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- **ReturnType**: The return type of the method being mocked.
- **MethodName**: The method's name.
- **Args**: The method arguments enclosed in parentheses.
- **Qualifiers (optional)**: Method qualifiers such as `const`, `override`, `noexcept`, `Calltype(...)`, or reference qualifiers `ref(&)`.

### Usage

- Must be declared **publicly** in the mock class, regardless of the original method’s access specifier.
- Supports mocking virtual member functions.
- Correct handling of overloads and method qualifiers ensures seamless substitution.

### Handling Complex Types and Commas

If argument or return types contain commas (like `std::pair<bool, int>` or `std::map<int, double>`), wrap the type in parentheses or use a type alias.

Example using parentheses:

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
```

Example using type aliases:

```cpp
using BoolAndInt = std::pair<bool, int>;
using MapIntDouble = std::map<int, double>;

MOCK_METHOD(BoolAndInt, GetPair, ());
MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
```

### Example: Mocking a Simple Interface

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```


## Setting Expectations with `EXPECT_CALL`

To verify interactions with your mock, specify expectations on method calls using `EXPECT_CALL`. This macro sets both the expected invocation count and behavior.

### Syntax Overview

```cpp
EXPECT_CALL(mock_object, MethodName(ArgumentMatchers...))
    .Times(Cardinality)
    .WillOnce(Action)
    .WillRepeatedly(Action)
    .InSequence(Sequences...)
    .After(Expectations...)
    .RetiresOnSaturation();
```

### Key Clauses

- **Argument Matchers:** Specify expectations for method arguments. Use specific matchers or `_` wildcard.
- **Times:** Controls how many times the expectation should be matched (e.g., `Times(1)`, `Times(AnyNumber())`, `AtLeast(n)`).
- **WillOnce/WillRepeatedly:** Define actions executed upon calls.
- **InSequence:** Enforces strict order when combined with other expectations.
- **After:** Specifies call ordering dependencies.
- **RetiresOnSaturation:** Causes the expectation to retire once call count upper bound is reached.

### Setting Flexible or Strict Expectations

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::AtLeast;

MockTurtle turtle;

// Expect PenDown to be called at least once.
EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));

// Expect Forward to be called with 100 exactly twice.
EXPECT_CALL(turtle, Forward(100)).Times(2);

// Return fixed value when GetX() is called.
EXPECT_CALL(turtle, GetX()).WillRepeatedly(Return(10));
```

### Tips

- Multiple expectations can be combined for the same method to express complex scenarios.
- The last matching expectation takes precedence.
- Use sequences or `After` to enforce call order.

## Controlling Default Behavior with `ON_CALL`

Sometimes you want to specify default behavior for mock methods *without* requiring calls. Use `ON_CALL` to set up such default actions.

### Syntax

```cpp
ON_CALL(mock_object, MethodName(ArgumentMatchers...))
    .WillByDefault(Action);
```

### Example

```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(0));
```

This means any call to `GetX()` that does not match an `EXPECT_CALL` will return 0 by default.

### Best Practices

- Use `ON_CALL` to set shared default behavior in test fixtures or mock constructors.
- Do *not* use `ON_CALL` to set expectations; use `EXPECT_CALL` for that.
- To suppress warnings about uninteresting calls, use `NiceMock` or add expectations where needed.

## Strictness Levels: Nice, Naggy, and Strict Mocks

GoogleMock provides three mock behaviors to control how uninteresting calls are handled:

| Mock Type        | Meaning | Behavior on Uninteresting Calls |
|------------------|---------|---------------------------------|
| `NiceMock<T>`    | Suppresses warnings on uninteresting calls | No warnings, flexible |
| `NaggyMock<T>`   | Default mock behavior, warns on uninteresting calls | Warnings printed |
| `StrictMock<T>`  | Treats uninteresting calls as test failures | Errors on unexpected calls |

### Usage Example

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockTurtle> nice_turtle;    // Ignores uninteresting calls
StrictMock<MockTurtle> strict_turtle;  // Fails on uninteresting calls

EXPECT_CALL(strict_turtle, PenDown());  // Must be called

strict_turtle.PenDown();  // Passes
strict_turtle.PenUp();    // Fails, as no expectation set
```

### Important Notes

- You can construct strictness wrappers passing the same arguments as the underlying mock class.
- They only affect mock methods declared directly in your mock class using `MOCK_METHOD`.
- `NiceMock` is recommended for most cases to reduce noisy warnings.
- Use `StrictMock` to catch unexpected calls during development or debug phases.

## Common Challenges and Tips

### Mocking Overloaded Methods

Mock all overloads explicitly or bring base class overloads in scope with `using`.

```cpp
class MockFoo : public Foo {
 public:
  using Foo::Add;  // Bring other overloads into scope.
  MOCK_METHOD(int, Add, (int x), (override));  
};
```

### Mocking Const Methods

Add `(const, override)` in the macro's qualifier list.

```cpp
MOCK_METHOD(int, GetX, (), (const, override));
```

### Returning References

Use `ReturnRef` instead of `Return` to return by reference:

```cpp
EXPECT_CALL(mock, GetBar()).WillOnce(ReturnRef(bar));
```

### Simplifying Mock Interfaces

If the real method has many parameters but testing needs only a subset, define a helper method and mock that instead.

### Delegating to Real or Fake Objects

Use the `ON_CALL` default action to forward calls to real or fake implementations for parts of the interface.

### Beware of Side Effects

Actions and expectations are evaluated once at set-up time. Use lambdas or functors to defer computation until invocation.

---

## Complete Example: Defining and Using a Mock

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;

class Foo {
 public:
  virtual ~Foo() {}
  virtual int Add(int x, int y) = 0;
  virtual std::string Name() const = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (int x, int y), (override));
  MOCK_METHOD(std::string, Name, (), (const, override));
};

TEST(FooTest, Basic) {
  MockFoo mock;

  // Set default behavior
  ON_CALL(mock, Add(_, _)).WillByDefault(Return(0));
  ON_CALL(mock, Name()).WillByDefault(Return("default"));

  // Expectations
  EXPECT_CALL(mock, Add(3, 4)).WillOnce(Return(7));
  EXPECT_CALL(mock, Name()).Times(2);

  EXPECT_EQ(mock.Add(3, 4), 7);      // Matches expectation
  EXPECT_EQ(mock.Name(), "default");
  EXPECT_EQ(mock.Name(), "default");
}
```

---

## Troubleshooting Common Issues

- **Unexpected Calls:** Ensure you have set `EXPECT_CALL` for the methods you expect to invoke in the test.
- **Uninteresting Call Warnings:** Use `NiceMock<T>` to suppress or add loose `EXPECT_CALL`s with `Times(AnyNumber())`.
- **Overloaded Methods Ambiguity:** Use `Const()` wrapper or fully specify argument types to resolve ambiguous overloads.
- **Mock Method Not Called as Expected:** Verify method signature in `MOCK_METHOD` matches exactly, including qualifiers.
- **Returning Move-Only Types:** Use lambdas instead of `Return` to return fresh move-only values on each call.

---

## References

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Advanced recipes and tips.
- [Mocking Basics](https://google.github.io/googletest/gmock_for_dummies.html) — Introductory guide to mocking.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — Complete API reference.
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) — Built-in argument matchers.

---

## See Also

- **Strictness Modifiers:** Behavior and usage of `NiceMock`, `NaggyMock`, and `StrictMock` for uninteresting call handling.
- **Setting Expectations:** Detailed syntax and options for `EXPECT_CALL` and `ON_CALL`.
- **Writing Custom Actions:** For more complex mock behaviors.

---

This page equips you with all you need to define and use GoogleMock mock classes effectively, set expectations precisely, and handle mock object behaviors for robust C++ unit testing.
