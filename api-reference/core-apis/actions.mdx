---
title: "Actions"
description: "Explains the use of actions to specify what mocks should do when called, including returning specific values, invoking callbacks, or performing custom logic. Details both built-in and user-defined actions, chaining, and advanced patterns."
---

# Actions

Actions define what a mock function does when called. They specify how the mock responds, including returning values, modifying arguments, invoking callbacks, or performing custom logic. GoogleMock provides a rich set of built-in actions and supports user-defined ones with flexible parameterizations and composition.

---

## Overview of Actions

An *action* in GoogleMock is an object representing the behavior of a mock function upon invocation. Actions can be:

- **Returning a value** (immediate or computed)
- **Performing side effects** like modifying output arguments or deleting pointers
- **Invoking callbacks or functions**
- **Throwing exceptions**
- **Composing multiple sub-actions** in a sequence

Actions are used in conjunction with `EXPECT_CALL` and `ON_CALL` to define mock behavior for specific calls or for default fallbacks.

---

## Built-in Actions

### Returning Values

| Action | Description |
| --- | --- |
| `Return()` | Returns from a `void` mock function.
| `Return(value)` | Returns `value`. Conversion to the mock function's return type happens at expectation setup, not at call time.
| `ReturnArg<N>()` | Returns the N-th argument of the mock function.
| `ReturnNew<T>(a1, ..., ak)` | Returns a new instance of type `T` constructed with constructor arguments `a1` through `ak`. A fresh object is created each call.
| `ReturnNull()` | Returns a null pointer.
| `ReturnPointee(ptr)` | Returns the value pointed to by `ptr`. Evaluated when action executes.
| `ReturnRef(variable)` | Returns a reference to the specified variable.
| `ReturnRefOfCopy(value)` | Returns a reference to a copy of `value` stored internally in the action.
| `ReturnRoundRobin({a1, ..., ak})` | Returns elements from the list in turn, restarting at the beginning after the last.

### Side-Effect Actions

| Action | Description |
| --- | --- |
| `Assign(&variable, value)` | Assigns `value` to the variable pointed to by the pointer.
| `DeleteArg<N>()` | Deletes the N-th argument (must be a pointer).
| `SaveArg<N>(pointer)` | Saves the N-th argument by copy-assignment into `*pointer`.
| `SaveArgByMove<N>(pointer)` | Moves the N-th argument into `*pointer`.
| `SaveArgPointee<N>(pointer)` | Saves the value pointed to by the N-th argument into `*pointer`.
| `SetArgReferee<N>(value)` | Assigns `value` to the variable referenced by the N-th argument.
| `SetArgPointee<N>(value)` | Assigns `value` to the variable pointed to by the N-th argument.
| `SetArrayArgument<N>(first, last)` | Copies elements from range `[first, last)` into the array or iterator pointed to by the N-th argument.
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value`.
| `Throw(exception)` | Throws the given exception when called. Available if exceptions are enabled.

### Function / Callback Invocation Actions

| Action | Description |
| --- | --- |
| `f` | Invokes the callable `f` with the mock function's arguments.
| `Invoke(f)` | Invokes the global/function/functor `f` similarly.
| `Invoke(object_ptr, &Class::method)` | Invokes the method on the object with the mock function's arguments.
| `InvokeWithoutArgs(f)` | Invokes the callable `f` with no arguments.
| `InvokeWithoutArgs(object_ptr, &method)` | Invokes the method with no arguments.
| `InvokeArgument<N>(args...)` | Invokes the N-th argument (a callable) with the provided arguments.

#### Notes on using `InvokeArgument<N>`
- If the callable takes arguments by reference, use `std::ref()` to pass by reference.
- Temporary values passed are copied internally, allowing safe delayed execution.

### Composite and Adapted Actions

| Action | Description |
| --- | --- |
| `DoAll(a1, a2, ..., an)` | Performs actions `a1` through `an` sequentially, returning the result of the last. The first `n-1` must return void.
| `IgnoreResult(a)` | Performs action `a` and discards its result. Useful when `a` returns non-void but the mock function expects void.
| `WithArg<N>(a)` | Passes the N-th argument of the mock function to action `a`.
| `WithArgs<N1, N2, ..., Nk>(a)` | Passes selected arguments to action `a`.
| `WithoutArgs(a)` | Calls `a` without any arguments.

---

## Defining Custom Actions

GoogleMock allows defining custom actions for specialized or complex behavior.

### Convenience Macros

- `ACTION(name) { ... }` defines a simple action.
- `ACTION_P(name, param) { ... }` defines a parameterized action.
- Similarly, `ACTION_P2`, ..., `ACTION_P10` for multiple parameters.

In the body, special variables are accessible:
- `arg0`, `arg1`, ...: The arguments to the mocked function.
- `arg0_type`, `arg1_type`, ...: Their types.
- `args` and `args_type`: The entire argument tuple.
- `return_type`: The mock function's return type.
- `function_type`: The full mock function type.

Example:
```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}
// Usage:
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg1());
```

### ACTION_P Example with Parameter:
```cpp
ACTION_P(Add, n) { return arg0 + n; }
// Usage:
EXPECT_CALL(mock, Foo(_)).WillOnce(Add(5));
```

### Advanced: ACTION_TEMPLATE

For actions needing explicit template parameters (e.g., non-deducible ones), `ACTION_TEMPLATE` can be used.

Example:
```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}
```

Usage:
```cpp
int n;
EXPECT_CALL(mock, Foo).WillOnce(DuplicateArg<1, unsigned char>(&n));
```

### Using Functors and Lambdas as Actions

Any callable object compatible with the mock function signature can be used as an action, including lambdas and structs with `operator()`.

Example:
```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int x) { return x * 2; });
```

### OnceAction and Move-Only Actions

`WillOnce()` accepts *OnceAction* instances, allowing move-only actions with `&&`-qualified call operators, which cannot be copied, enabling complex actions that consume resources.

---

## Best Practices & Tips

- **Use `ReturnRef()` for returning references:** Always use `ReturnRef(variable)` for mock functions with reference return types.
- **Use `ReturnPointee()` for live values:** To return the current value pointed to by a pointer.
- **Chain multiple effects using `DoAll()`:** When mocking side effects and returning values, e.g., `DoAll(SetArgPointee<0>(value), Return(true))`.
- **Pass callables to `Invoke()` for flexibility:** Use lambdas or existing functions for custom behavior.
- **Avoid sharing stateful actions unless intentional:** Stateful actions shared across expectations may lead to surprising shared state.
- **Wrap callable arguments with `std::ref()` when needed:** Ensures passing by reference in `InvokeArgument<N>`.
- **Use `IgnoreResult()` to adapt return types:** When action returns a value but mock expects void.
- **Mind action order in `EXPECT_CALL()`:** Last matching expectation applies.

---

## Troubleshooting Common Issues

- **Uninteresting calls produce warnings:** Use `NiceMock` or add `EXPECT_CALL(...).Times(AnyNumber())` to suppress.
- **Move-only type actions and returns:** Use lambdas or `Return(ByMove())` for move-only return types. Avoid using `Return()` repeatedly on move-only types.
- **Mismatch between expected and actual calls:** Run tests with `--gmock_verbose=info` for detailed call trace.
- **`DoDefault()` limitations:** Cannot be used inside composite actions like `DoAll()`, will cause runtime errors.

---

## Example Usage

### Returning Different Values on Sequential Calls

```cpp
using ::testing::Return;
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));
```

### Setting Side Effect on Argument & Returning Value

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

### Invoking a Callback Argument

```cpp
using ::testing::InvokeArgument;
EXPECT_CALL(mock, DoThis(_, _))
    .WillOnce(InvokeArgument<1>(5));  // Calls the second argument with 5.
```

### Defining a Simple Custom Action

```cpp
ACTION(IncrementArg0) { return arg0 + 1; }
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg0());
```

### Parameterized Custom Action

```cpp
ACTION_P(MultiplyBy, factor) {
  return arg0 * factor;
}
EXPECT_CALL(mock, Foo(_)).WillOnce(MultiplyBy(10));
```

---

## Related Concepts

- For specifying **mock method behavior**, see [`EXPECT_CALL()`](../core-apis/mocking#EXPECT_CALL) and [`ON_CALL()`](../core-apis/mocking#ON_CALL).
- To create **custom actions** with explicit types, refer to [`ACTION_TEMPLATE`](#WritingCustomActionTemplates).
- To handle **side effects on arguments**, utilize actions such as `SetArgPointee`, `SaveArg`, `Assign`, and related.
- For composing multiple actions, use `DoAll()`.
- For invoking callbacks passed as mock arguments, utilize `InvokeArgument<N>()`.

---

## See Also

- [Mocking Reference](../core-apis/mocking)
- [Matchers Reference](../core-apis/matchers)
- [gMock Cookbook - Actions Section](../guides/writing-and-running-tests/basic-unit-tests#actions)
- [Legacy gMock FAQ - Custom Actions](../faq/general-usage/mocking-faq#writing-new-actions)

---