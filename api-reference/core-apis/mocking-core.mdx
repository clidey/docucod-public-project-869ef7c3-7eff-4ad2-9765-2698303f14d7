---
title: "Mocking Fundamentals"
description: "Covers the core mechanisms and APIs for creating, configuring, and using mocks in testsâ€”defining mock classes, leveraging MOCK_METHOD macros, and working with actions and expectations. Describes how to initialize mocks, set and verify expectations, and leverage advanced features for strictness and flexibility."
---

# Mocking Fundamentals

Mocking is a cornerstone of effective C++ testing with GoogleTest, empowering you to isolate components, verify interactions, and build robust unit tests. This document presents the essential mechanisms and APIs to define, configure, and use mock objects confidently.

---

## Defining Mock Classes with `MOCK_METHOD`

Mock classes simulate real interfaces by overriding virtual methods with mocked versions, enabling precise control over method invocations and return values.

### Basic Usage

Use the `MOCK_METHOD` macro inside your mock class's public section to declare mocked methods:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(bool, Process, (Bar elem, int count), (override));
};
```

Key points:
- The macro parameters represent the return type, method name, and argument list.
- Qualifiers like `const` and `override` must be specified if overriding such methods.
- Place `MOCK_METHOD` declarations in the `public:` section regardless of original method visibility.

### Dealing with Complex Types

When argument or return types contain commas (e.g., templates), wrap the full type in parentheses or create a type alias to avoid parsing errors:

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
using MapIntDouble = std::map<int, double>;
MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
```

### Mocking Overloaded Methods

Mock all overloads individually to avoid hiding base class methods:

```cpp
MOCK_METHOD(int, Add, (Element x), (override));
MOCK_METHOD(int, Add, (int times, Element x), (override));
```

Use `using BaseClass::Method` to bring unmocked overloads into scope.

### Mocking Non-Virtual Methods (Hi-perf Dependency Injection)

You can mock non-virtual methods by defining mock classes unrelated to the real class but with matching method signatures. This requires static polymorphism (via templates) at compile time.

```cpp
class MockPacketStream {
 public:
  MOCK_METHOD(const Packet*, GetPacket, (size_t packet_number), (const));
  MOCK_METHOD(size_t, NumberOfPackets, (), (const));
};
```

---

## Creating and Using Mock Objects in Tests

Mock objects are the tools you'll inject into your code under test to validate the interactions.

### Typical Workflow

1. Include the relevant gMock headers.
2. Create instances of mock classes.
3. Set expectations using `EXPECT_CALL()`.
4. Run your code that uses the mock objects.
5. Let gMock automatically verify expectations on mock destruction or verify explicitly.

### Setting Expectations with `EXPECT_CALL`

`EXPECT_CALL(mock_obj, Method(matchers))` defines the calls you expect your mock method to receive.

```cpp
EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
```

### Matching Arguments

Matchers describe argument constraints:
- Use literals for exact matches.
- Use `_` to accept any value.
- Use built-in or custom matchers for range or property checks.

Examples:

```cpp
EXPECT_CALL(turtle, Forward(100));        // Exactly 100
EXPECT_CALL(turtle, GoTo(50, _));          // X=50, Y=anything
EXPECT_CALL(turtle, GoTo);                  // Any arguments (non-overloaded methods only)
```

### Specifying Call Cardinality

Specify how many times each call is expected using `.Times()` clauses:
- `Times(0)` means the call should never happen.
- Built-in cardinalities like `AnyNumber()`, `AtLeast(n)`, `Between(m,n)`, etc., allow flexible constraints.

If `.Times()` is omitted, gMock infers cardinality based on `WillOnce()`/`WillRepeatedly()` usage.

### Controlling Call Order

Use `InSequence` or `Sequence` objects to enforce that calls happen in a particular order:

```cpp
{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

You may also express partial ordering using `Sequence` objects across multiple expectations.

### Defining Actions with `WillOnce` and `WillRepeatedly`

Actions determine what the mock method does when called:
- Return preset values using `Return()` or `ReturnRef()`.
- Delegate to user-defined functions, lambdas, or functors with `Invoke()`.
- Chain actions with `DoAll()`.

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

### Using `ON_CALL` for Default Behavior

`ON_CALL(mock_obj, Method(matchers)).WillByDefault(action);` sets the fallback behavior without adding an expectation.

---

## Mock Object Strictness: Nice, Naggy, and Strict

GoogleMock lets you control how strictly mock objects handle unexpected and uninteresting calls.

| Modifier      | Behavior on Uninteresting Calls                             |
|---------------|-------------------------------------------------------------|
| `NiceMock<T>` | Suppresses warnings (quiet)                                 |
| `NaggyMock<T>`| Prints warnings (default behavior)                          |
| `StrictMock<T>`| Treats uninteresting calls as test failures (strict mode) |

Usage example:

```cpp
NiceMock<MockFoo> nice_mock;
StrictMock<MockFoo> strict_mock;
```

`NiceMock` and `StrictMock` inherit constructors from the base mock class and work with mocks defined via `MOCK_METHOD`.

<Warning>
Never nest `NiceMock`, `NaggyMock`, or `StrictMock` inside each other (e.g. `NiceMock<StrictMock<MockFoo>>` is unsupported).
</Warning>

---

## Advanced Mocking Features

### Retiring Expectations

Use `.RetiresOnSaturation()` to indicate that once an expectation is met the matching stops, allowing fall-through to more general expectations.

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
```

### Delegating Calls to Fakes or Real Objects

Mock classes can delegate calls to a fake implementation or original object for default behavior, allowing interaction verification while preserving logic.

### Mocking Destructors

C++ destructors cannot be mocked directly. Instead, define a mock method (e.g., `Die()`), call it inside the destructor, and set expectations on `Die()`.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(void, Die, ());
  ~MockFoo() override { Die(); }
};
```

### Thread Safety

Use mocks in multi-threaded tests by ensuring:
- Test code runs in one thread.
- Expectations are set and verified safely without concurrent access.
- Mock methods are called safely concurrently.

---

## Troubleshooting and Best Practices

- Always declare virtual destructors in base interfaces to avoid resource leaks.
- Set expectations before exercising mock objects; late `EXPECT_CALL` leads to undefined behavior.
- Use `--gmock_verbose=info` to debug mismatches and trace mock interactions.
- Use NiceMock to reduce noise from uninteresting calls during development.
- Use StrictMock when you want to ensure no unexpected calls occur.

---

## Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html): Beginner-friendly conceptual guide.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Recipes and advanced usage.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html): Complete API and syntax details.
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html): Quick reference of common commands and idioms.
- [Mock Object Strictness Modes Guide](https://google.github.io/googletest/guides/advanced-and-integrations/mock-object-strictness.html): In-depth look at NiceMock, NaggyMock, and StrictMock.

For step-by-step tutorials, examples, and troubleshooting, please consult the navigation structure in the GoogleTest documentation or the interactive guides under the "Getting Started" and "Core Testing Workflows" sections.
