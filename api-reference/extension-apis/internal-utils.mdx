---
title: "Internal Utilities and Porting"
description: "Description of utilities for internal development, porting, and extending GoogleMock's low-level behavior. Intended as a guide for contributors and advanced integrators seeking insight into type utilities, platform abstraction, and failure reporting."
---

# Internal Utilities and Porting

This documentation details the internal utilities of GoogleMock, focusing on components that facilitate testing, portability, type introspection, and failure reporting. Although these utilities are primarily intended for GoogleMock's internal use and contributors, understanding them offers valuable insight into advanced usage and platform abstraction.

---

## Overview

GoogleMock relies on a collection of low-level utility functions and classes defined in its `internal` namespace to support robust mocking, type safety, diagnostic messaging, and portability across platforms. These utilities handle:

- Type kind classification and safe conversions
- String manipulation and formatting
- Wrapper classes for native and STL-like arrays
- Failure reporting integration with GoogleTest
- Platform-specific logging and warning suppression


## Type Utilities

### KindOf: Categorizing Types

GoogleMock classifies C++ types into these categories:

- **kBool**: Boolean types
- **kInteger**: Integral types excluding `bool`
- **kFloatingPoint**: Floating-point types
- **kOther**: All other types

Users don't interact directly with `KindOf`, but it plays a central role in enabling safe casting and matching of expectations. For example, it helps enforce that arithmetic conversions are lossless where expected.

### LosslessArithmeticConvertible

A compile-time predicate that determines if one arithmetic type can be safely converted to another without loss. This template relies on `KindOf` values and size/signedness comparisons to enforce conversions such as:

- `bool` to any arithmetic type (always allowed)
- Smaller unsigned integer to larger signed or unsigned of equal or higher size
- Floating point conversions only allowed if the target is at least as wide as the source


## STL and Native Array Adaptors

To handle native C-style arrays and STL-like containers uniformly:

- `StlContainerView<RawContainer>` provides a container-like interface, including:
  - `type`: A type alias for a suitable container view (e.g., native arrays wrapped in `NativeArray`)
  - `ConstReference(raw_container)`: Returns a const reference to a container view
  - `Copy(raw_container)`: Returns a container view that copies the underlying data


### `NativeArray<Element>`

This class adapts native arrays into read-only STL-style containers, implementing essential container functions:

- `size()`
- `begin()` and `end()`
- Equality comparison (`operator==`)

It supports reference and copy semantics, enabling safe passing of arrays in GoogleMock’s matchers.


## String Utilities

GoogleMock includes internal functions to process strings for diagnostic output and matcher descriptions:

- `JoinAsKeyValueTuple(names, values)`: Formats pairs of names and string values as a tuple-like `(name1: value1, name2: value2, ...)` string.
- `ConvertIdentifierNameToWords(const char* id_name)`: Converts C++ identifier names into space-separated lowercase words, splitting at camel case boundaries and digits. For example, `FooBar123` becomes `foo bar 123`.


## Raw Pointer Extraction

`GetRawPointer(p)` extracts the raw pointer from smart pointers, reference wrappers, or returns the raw pointer itself if already raw. This facilitates uniform pointer processing in matchers involving pointer-like types.


## Failure Reporting Integration

To report failures from GoogleMock into GoogleTest's assertion framework, the class `GoogleTestFailureReporter` implements an interface `FailureReporterInterface` and maps failures as follows:

- Fatal failures invoke GoogleTest’s fatal failure reporting and abort the program.
- Non-fatal failures invoke GoogleTest’s non-fatal reporting.

`GetFailureReporter()` returns the singleton instance of this reporter.


## Logging and Verbosity

GoogleMock supports logging with built-in support for verbosity flags. Functions include:

- `LogIsVisible(LogSeverity severity)`: Checks if a message at a certain severity level (`info` or `warning`) should be visible depending on the verbosity flag.
- `Log(LogSeverity severity, const std::string& message, int stack_frames_to_skip)`: Prints the log message if the severity passes visibility checks, optionally including stack trace details.

A mutex protects concurrent logging to avoid interleaved output.


## Warning Suppression Macros

For smoother compilation across multiple compilers, GoogleMock defines macros to suppress specific warnings (like MSVC C4100 and C4805) during the compilation of internal utilities.


## Base64 Unescape

GoogleMock implements a utility `Base64Unescape(encoded, &decoded)` that decodes a base64-encoded string, supporting both standard and URL-safe encodings. This is used internally for string matching and diagnostics.


## Source Code Links

The internal utilities heavily rely on `gmock-port.h` and `gtest.h` and provide foundational support for mocking and matching in GoogleMock. Changes or extensions here can affect the overall mocking infrastructure.


---

## Example: Using JoinAsKeyValueTuple

```cpp
std::vector<const char*> names = {"foo", "bar"};
Strings values = {"42", "true"};
std::string result = JoinAsKeyValueTuple(names, values);
// result: "(foo: 42, bar: true)"
```

## Example: Converting Identifier Names

```cpp
std::string words = ConvertIdentifierNameToWords("FooBar123");
// words: "foo bar 123"
```

## Example: Reporting a Failure

```cpp
internal::Assert(false, __FILE__, __LINE__, "Expected failure message");
// Triggers GoogleTest fatal failure with message.
```

---

## Helpful Tips and Best Practices

- **Do not use internal utilities directly in tests or production code.** These are for advanced customization and should be considered unstable.
- Use the public API in GoogleMock for matcher and action creation.
- Understand your compiler's warning levels; GoogleMock tries to suppress only necessary warnings around internal code.
- Use `GetRawPointer` when working with pointers uniformly to avoid surprises.
- For diagnostics, consider creating readable matcher descriptions using the included string utilities.

---

## Troubleshooting & Common Pitfalls

- Ensure type conversions in matchers are lossless where required to avoid unexpected failures.
- When extending GoogleMock, respect the visibility and intended use of internal components.
- Watch out for memory ownership and lifetime when adapting arrays or handling pointers.

---

## Further Exploration

- See [Defining Custom Actions and Matchers](./custom-actions.md) for APIs that build on these internal utilities.
- Refer to [Mocking Workflow with GoogleMock](../guides/mocking-best-practices/mocking-workflow.md) for practical use of mocking features.
- Consult the [Matchers Reference](core-apis/matchers.md) for user-facing matcher patterns.


---

## Mermaid Diagram: Relation of Core Internal Utilities

```mermaid
classDiagram
    class FailureReporterInterface {
      <<interface>>
      +ReportFailure(FailureType, const char*, int, const std::string&)
    }
    class GoogleTestFailureReporter {
      +ReportFailure(FailureType, const char*, int, const std::string&)
    }
    FailureReporterInterface <|.. GoogleTestFailureReporter

    class NativeArray {
      +size()
      +begin()
      +end()
      +operator==()
    }

    class StlContainerView {
      +type
      +ConstReference()
      +Copy()
    }

    class JoinAsKeyValueTuple {
      +static std::string Join(names, values)
    }

    class ConvertIdentifierNameToWords {
      +static std::string Convert(const char*)
    }

    class TypeKind {
      <<enum>>
      kBool
      kInteger
      kFloatingPoint
      kOther
    }

    class LosslessArithmeticConvertible {
      +value
    }

    GoogleTestFailureReporter --> FailureReporterInterface
    NativeArray ..> StlContainerView : adapts
    JoinAsKeyValueTuple ..> std::string : returns
    ConvertIdentifierNameToWords ..> std::string : returns

```


---

## Source

<Source url="https://github.com/google/googletest" branch="main" path="googlemock/include/gmock/internal/gmock-internal-utils.h" range="1-142" />
<Source url="https://github.com/google/googletest" branch="main" path="googlemock/src/gmock-internal-utils.cc" range="1-138" />