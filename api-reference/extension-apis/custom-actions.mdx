---
title: "Defining Custom Actions and Matchers"
description: "API and macro reference for authoring user-defined actions and matchers, enabling expressive and reusable testing patterns tailored to your code base. Covers extension macros and registration mechanisms."
---

# Defining Custom Actions and Matchers

API and macro reference for authoring user-defined actions and matchers, enabling expressive and reusable testing patterns tailored to your code base. Covers extension macros and registration mechanisms.

---

## Overview

This page details how to extend GoogleMock by defining **custom actions** and **custom matchers**. These extensions let you write precise and reusable testing utilities that go beyond the built-in matchers and actions provided by GoogleMock. Using these facilities, you can tailor behavior and argument verification to the unique needs of your codebase, creating highly expressive yet maintainable test code.

You’ll find references for:

- Writing new actions via macros and functors.
- Creating parameterized and polymorphic matchers.
- Registering custom matchers for convenient reuse.

This empowers you to create domain-specific testing patterns that integrate seamlessly with GoogleMock’s expectations and call verification system.

---

## Custom Actions

Actions specify what a mock method does when it is invoked. While GoogleMock offers rich built-in actions for common use cases, custom actions allow you to extend this behavior with your own logic.

### Writing Custom Actions with Macros

GoogleMock provides `ACTION` family macros for quickly defining new actions in namespace scope.

- **`ACTION(name)`**: Create a non-parameterized action `name()`.
- **`ACTION_P(name, param)`**: Create an action `name(param)`, parametrized by one argument.
- **`ACTION_Pk(name, p1, ..., pk)`**: Supports up to 10 parameters.

Inside the action body, you can:

- Access mock function arguments as `arg0`, `arg1`, ...
- Refer to argument types as `arg0_type`, `arg1_type`, ...
- Access the entire argument tuple as `args`
- Use `return_type` and `function_type` to access mock method return type and signature.

#### Example

```cpp
ACTION(IncrementArg1) {
  arg1_type temp = arg1;
  return ++(*temp);
}
```

Use in an expectation:

```cpp
EXPECT_CALL(mock, SomeMethod(_)).WillOnce(IncrementArg1());
```

### Writing Parameterized Actions

Parameterized actions receive parameters to customize their behavior:

```cpp
ACTION_P(Add, n) {
  return arg0 + n;
}
```

Usage:

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce(Add(5));
```

Use multiple parameters with `ACTION_P2`, `ACTION_P3`, etc.

### Writing Actions as Functors or Lambdas

For more complex scenarios or local definitions, create custom actions as callable objects or lambdas:

```cpp
struct MultiplyBy {
  int factor;
  template <typename T>
  T operator()(T arg) { return arg * factor; }
};
...
EXPECT_CALL(mock, Foo(_)).WillOnce(MultiplyBy{7});
```

---

## Custom Matchers

Matchers help validate mock method arguments elegantly. When built-in matchers don’t fit your scenario, custom matchers let you define new, reusable predicates for argument verification.

### Defining Simple Matchers with MATCHER Macros

GoogleMock’s `MATCHER` family of macros simplify writing concise, expressive matchers:

- **`MATCHER(name, description_string)`**: Defines a matcher named `name()`.
- **`MATCHER_P(name, param, description_string)`**: Parameterized matcher.
- Supports `MATCHER_Pk` for up to 10 parameters.

Inside the macro, the value being matched is accessible as `arg`. You should return a boolean indicating whether the match succeeds.

The description string should include how the matcher or its negation describe themselves.

#### Example — Basic Matcher

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}
```

Usage:

```cpp
EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
EXPECT_THAT(value, IsDivisibleBy7());
```

This will print meaningful error messages on failures.

### Detailed Matcher Implementation

For advanced control, implement a matcher class providing:

- `MatchAndExplain(const T& value, std::ostream* os)` returning `bool`
- `DescribeTo(std::ostream* os)` to describe the matcher
- `DescribeNegationTo(std::ostream* os)` for negative descriptions

Wrap the implementation with a matcher factory function returning `testing::Matcher<T>`.

### Polymorphic Matchers

Define polymorphic matchers that can be used for multiple argument types by templating the match function:

```cpp
class NotNullMatcher {
 public:
  using is_gtest_matcher = void;
  template <typename T>
  bool MatchAndExplain(T* p, std::ostream*) const {
    return p != nullptr;
  }
  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

inline testing::PolymorphicMatcher<NotNullMatcher> NotNull() {
  return testing::MakePolymorphicMatcher(NotNullMatcher());
}
```

Usage:

```cpp
EXPECT_CALL(mock, Method(NotNull()));
```

### Composite and Parameterized Matchers

Matchers that take other matchers as parameters can be implemented by holding their sub-matchers and delegating matching and description to those.

### Registration Mechanisms

Custom actions and matchers can be organized, documented, and shared through registration utilities (not covered explicitly here but supported by macros and internal APIs).

---

## Best Practices

- Use `ACTION` macros for simple, reusable actions with minimal dependencies.
- Prefer functors or lambdas for inline or complex actions.
- Write custom matchers to encapsulate argument validation logic; keep matchers pure and side-effect free.
- Use polymorphic matchers to increase matcher reusability across types.
- Avoid over-specifying expectations to keep tests robust and maintainable.
- Use `ON_CALL` to set default behaviors, reserving `EXPECT_CALL` for actual expectation enforcement.

---

## Troubleshooting Tips

- When your custom matcher fails to compile, check argument and parameter types carefully.
- Ensure matchers are pure functions with no side effects.
- Use logging or the `--gmock_verbose=info` flag to trace matcher and action evaluation.
- When actions do not behave as expected, verify they implement the compatible signature for the mocked method.

---

For detailed syntax, examples, and advanced usage, refer to the following documents:

- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)
- [Actions Reference](https://github.com/google/googletest/blob/main/docs/reference/actions.md)
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md)
- [Matchers Reference](https://github.com/google/googletest/blob/main/docs/api-reference/core-apis/matchers.md)

---

## See Also

- [Defining and Using Mock Methods](https://github.com/google/googletest/blob/main/docs/api-reference/mocking-apis/mock-methods.md)
- [Call Expectations & Sequences](https://github.com/google/googletest/blob/main/docs/api-reference/mocking-apis/call-expectations.md)
- [Actions & Return Value Control](https://github.com/google/googletest/blob/main/docs/api-reference/mocking-apis/mock-actions.md)
- [Advanced Mocking: Actions, Matchers, and Customizations Guide](https://github.com/google/googletest/blob/main/guides/mocking-best-practices/advanced-mocking-actions.md)

---

<Callout>
**Note:** All the macros and classes described here must be used in namespace scope or appropriate class scope as indicated in GoogleMock documentation. Do not define these inside functions or local scopes.
</Callout>
