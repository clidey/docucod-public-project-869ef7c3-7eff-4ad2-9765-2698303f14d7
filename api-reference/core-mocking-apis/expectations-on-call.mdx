---
title: "Declaring Expectations (EXPECT_CALL & ON_CALL)"
description: "This page details how to use EXPECT_CALL and ON_CALL macros for specifying expectations and default behaviors on mocked methods. Understand the difference between strict and loose expectations, controlling return values, and chaining actions to test interactions precisely."
---

# Declaring Expectations with EXPECT_CALL & ON_CALL

This page details how to use the `EXPECT_CALL` and `ON_CALL` macros in Google Mock for specifying expectations and default behaviors on mocked methods. Learn how to precisely control the behavior of mock methods, distinguish between strict and loose expectations, chain actions, and manage call ordering to thoroughly test interactions.

---

## Overview

Google Mock allows you to create **mock objects** and specify how they should behave and be called within your tests. Two main macros help you declare these behaviors:

- `EXPECT_CALL`: Defines an expectation that a mock method will be called with particular arguments, a specified number of times, and optionally in a defined order.
- `ON_CALL`: Defines a default behavior for a mock method without requiring the method to be called.

`EXPECT_CALL` both sets **expectations** and optionally default behaviors, while `ON_CALL` only sets default behaviors without causing any test failures if the method is not called.

### User Workflow

1. **Create mock objects** from mock classes that use `MOCK_METHOD` to declare mock methods.
2. Use **`ON_CALL`** to set common default behaviors shared across multiple test cases.
3. Use **`EXPECT_CALL`** in specific test cases to set precise expectations on mock calls you want to verify.
4. Invoke the production code that uses these mocks.
5. At test teardown, Google Mock automatically verifies that all expectations have been met.

---

## Using `EXPECT_CALL`

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)      // Optional; must be first clause
    .Times(cardinality)                // Optional; specify expected call count
    .InSequence(sequences...)          // Optional; constrain call order
    .After(expectations...)            // Optional; enforce partial order
    .WillOnce(action)                  // Optional; specify single call behavior
    .WillRepeatedly(action)            // Optional; specify repeated call behavior
    .RetiresOnSaturation();            // Optional; retire expectation when saturated
```

- **Purpose**: Declare that `Method` will be called with arguments matching `matchers...`.
- **Matchers**: Specify conditions each argument must satisfy (use `_` for "anything").
- **With Clause**: Additional predicate on the entire argument tuple; can only be used once and must be first.
- **Times Clause**: Indicates how many times the call is expected. Various predefined cardinalities are available like `Exactly(n)`, `AnyNumber()`, or `AtLeast(n)`.
- **InSequence Clause**: Indicate that this expectation is part of one or more sequences enforcing call order.
- **After Clause**: Specify other expectations that must be satisfied before this one.
- **WillOnce/WillRepeatedly Clauses**: Define actions for one-time and repeat calls respectively. If omitted, default actions apply.
- **RetiresOnSaturation Clause**: Marks that an expectation becomes inactive once saturated.

### Example - Setting Expectations & Actions

```cpp
using ::testing::Return;

EXPECT_CALL(foo, Bar(5))               // Expect Bar to be called with 5
    .Times(3)                         // Exactly 3 times
    .WillOnce(Return(10))             // First call returns 10
    .WillOnce(Return(20))             // Second call returns 20
    .WillRepeatedly(Return(30));     // Subsequent calls return 30

foo.Bar(5);  // returns 10
foo.Bar(5);  // returns 20
foo.Bar(5);  // returns 30
```

### Best Practices for EXPECT_CALL

- Use `EXPECT_CALL` **only when you want to verify that the call actually occurs**.
- Avoid unnecessary strictness to keep tests maintainable — prefer using `ON_CALL` for default behavior.
- The last matching `EXPECT_CALL` takes precedence, so place more specific expectations **after** general ones.
- If the call order matters, use `InSequence` or `After` to enforce it explicitly.
- Use `.RetiresOnSaturation()` when you want an expectation to become inactive after reaching its call limit, helpful for chaining calls.
- Never set new expectations after the mock has been exercised; it causes undefined behavior.

### Testing Call Ordering with `InSequence` and `After`

```cpp
using ::testing::Sequence;

Sequence seq1, seq2;

EXPECT_CALL(mock, Foo()).InSequence(seq1);
EXPECT_CALL(mock, Bar()).InSequence(seq1, seq2);
EXPECT_CALL(mock, Baz()).InSequence(seq2);
```

This sets up a partial order where `Foo()` must happen before `Bar()`, and `Bar()` must happen before `Baz()`. `After` works similarly, using `Expectation` or `ExpectationSet` objects to specify dependencies.

### Handling Unexpected Calls

If the method is called with arguments that don't match any `EXPECT_CALL`, or it is called more times than expected, Google Mock reports an error and optionally executes a default action if available.

To explicitly disallow calls, set:

```cpp
EXPECT_CALL(mock, Method(_)).Times(0);
```

---

## Using `ON_CALL`

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)    // Optional; may appear once
    .WillByDefault(action);           // Required
```

- **Purpose**: Set the **default action** executed on calls to `Method` matching the argument matchers.
- **Does not create an expectation**: no verification is performed if the method is or isn't called.
- Typically used in test fixture setup or mock constructor to provide a baseline behavior.
- Can be overridden by matching `EXPECT_CALL`s.

### Example - Setting Default Behavior

```cpp
using ::testing::Return;

ON_CALL(foo, Size())              // When Size() is called
    .WillByDefault(Return(99));   // Return 99 by default

// Further in tests
EXPECT_CALL(foo, Describe(_)).Times(AnyNumber()); // Set some expectation

EXPECT_EQ(foo.Size(), 99);        // Returns 99
```

### Combining `ON_CALL` and `EXPECT_CALL`

- `ON_CALL` provides the fallback actions for uninteresting calls and unexpected calls.
- `EXPECT_CALL` overrides the action and creates an expectation with verification.
- If no matching `EXPECT_CALL` is found, Google Mock uses the **last matching** `ON_CALL` action.
- Helpful to set `ON_CALL`s for behavior shared by many tests and narrow `EXPECT_CALL` in specific tests.

### Rules & Restrictions

- `.WillByDefault()` is mandatory in `ON_CALL`.
- `.With()` can appear only once and must be before `.WillByDefault()`.
- `ON_CALL` does not support `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, or `.RetiresOnSaturation()`.

---

## Common Patterns & Tips

### Order of Clause Usage

Both `EXPECT_CALL` and `ON_CALL` support clauses that **must be used in a specific order**. For example, in `EXPECT_CALL`, `.With()` must come first, `.Times()` comes before `.InSequence()`, and `.RetiresOnSaturation()` must be last.

### Sticky Expectations

Expectations are "sticky" by default, meaning an expectation remains active even after saturation. Use `.RetiresOnSaturation()` to disable stickiness and allow other expectations to match after saturation.

### Actions for Callbacks or Side Effects

You can specify complex behaviors using `WillOnce()` and `WillRepeatedly()`. Combine multiple actions using `DoAll()`, or invoke callable arguments using `InvokeArgument<N>(args...)`.

### Handling Overloaded Methods

To disambiguate overloaded methods in `EXPECT_CALL` or `ON_CALL`, specify the argument list explicitly or use objects like `Const()` on const-qualified methods.

### Ignore Uninteresting Calls

Use `NiceMock<>` to suppress warnings about uninteresting calls or explicitly allow calls with `EXPECT_CALL(...).Times(AnyNumber())`.

### Troubleshooting

If gMock reports unexpected calls:

- Ensure all expected calls are set before exercising mocks.
- Use `--gmock_verbose=info` for detailed mock call tracing.
- Confirm argument matchers are correct and specific enough.

---

## Example Summary

```cpp
using ::testing::Return;
using ::testing::_;  // Wildcard matcher

class MockFoo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (int), (override));
};

MockFoo foo;

// Default behavior for GetSize
ON_CALL(foo, GetSize()).WillByDefault(Return(42));

// Expect Describe(5) exactly twice, returning "Five"
EXPECT_CALL(foo, Describe(5))
    .Times(2)
    .WillRepeatedly(Return("Five"));

int size = foo.GetSize();              // Returns 42
std::string desc = foo.Describe(5);   // Returns "Five"
foo.Describe(5);                      // Second call returns "Five"
```

---

## Links & Further Reading

- [GoogleMock Cheat Sheet](docs/gmock_cheat_sheet.md) — Quick reference for mock usage
- [gMock Cookbook](docs/gmock_cook_book.md#UseOnCall) — In-depth recipes for using `ON_CALL` and `EXPECT_CALL`
- [Core Mocking APIs](api-reference/core-mocking-apis/mock-method-macros.md) — Defining mock classes and `MOCK_METHOD`
- [Matchers Reference](api-reference/matchers-and-actions/argument-matching.md) — Argument matching and custom matchers
- [Actions Reference](api-reference/matchers-and-actions/actions-for-mocks.md) — Defining mock actions
- [Understanding Uninteresting vs Unexpected Calls](docs/gmock_cook_book.md#uninteresting-vs-unexpected)

---

## Summary

| Clause               | Purpose                                                | Notes                                 |
| -------------------- | ------------------------------------------------------|------------------------------------- |
| `EXPECT_CALL`        | Declares an expectation and optionally an action       | Verifiable; affects test pass/fail  |
| `ON_CALL`            | Sets default behavior without expectation              | No verification; fallback action     |
| `.With()`            | Matches entire argument tuple                           | Must be first for both macros        |
| `.Times()`           | Sets expected call count                                | Optional, inferred if omitted        |
| `.InSequence()`      | Specifies call ordering                                 | Can be multiple; ensures strict order|
| `.After()`           | Specifies partial order dependencies                    | Accepts `Expectation` or `ExpectationSet`              |
| `.WillOnce()`        | Action for the next matching call                       | Multiple calls allowed with multiple clauses            |
| `.WillRepeatedly()`  | Action for subsequent matching calls                    | Optional, only one allowed            |
| `.RetiresOnSaturation()` | Retires expectation once saturated                   | Optional; disallow 'stickiness'        |

## Common Issues & Prevention

- **Failure to set expectations before exercising mocks** leads to undefined behavior.
- **Unexpected calls due to argument mismatches** can be debugged with `--gmock_verbose=info`.
- **Ordering errors**: use sequences to clearly define call order.
- **Uninteresting calls warnings**: use `NiceMock<>` or explicit `EXPECT_CALL(...).Times(AnyNumber())`.

---

Use this reference as a definitive guide to mastering mock method behavior specification via `EXPECT_CALL` and `ON_CALL`, ensuring precise, maintainable, and effective mock-driven tests.