---
title: "Matchers and Customization"
description: "Explains the matcher framework for writing readable, advanced checks on test values. Describes built-in polymorphic matchers, regular expression matchers, and how to extend them for custom needs."
---

# Matchers and Customization

## Overview

In GoogleMock, matchers are a powerful and expressive framework that lets you specify advanced, readable checks on the values passed to mock methods. They form the core of verifying function arguments by enabling detailed validation beyond exact value comparisons. This page reveals the inner workings of the matcher framework, including the built-in polymorphic matchers that match any type, regular expression matchers for string pattern validation, and guidance on extending the matcher system to suit your project's specific needs.

By mastering matchers, you will write more expressive and maintainable tests, easily specify complex argument constraints, and extend GoogleMock seamlessly with your own customized matchers.

---

## 1. Matcher Framework Basics

Matchers are objects or functions that represent predicates verifying whether a value meets certain criteria. In GoogleMock, matchers are used inside `EXPECT_CALL` and `ON_CALL` to specify expectations or default behaviors for mock methods.

- They can be polymorphic, meaning a single matcher (like `Eq(5)`) can be applied to arguments of different but compatible types.
- Matchers support rich descriptions that help produce clear, informative test failure messages.
- Matchers must be purely functional without side effects because GoogleMock may invoke them multiple times during mock verification.

### Key Features of GoogleMock Matchers

- **Declarative and Readable:** Use expressive syntax like `IsNull()`, `StartsWith("prefix")`, or `AllOf(Gt(5), Lt(10))` to specify what you expect.
- **Composable:** Combine simpler matchers into compound ones using `AllOf()`, `AnyOf()`, `Not()`, making constraints highly flexible.
- **Explain Match Results:** Matchers can provide detailed explanations about why a match succeeded or failed, aiding diagnostics.

### Polymorphic Matchers

GoogleMock’s polymorphic matchers can be implicitly converted to matchers for any compatible type, e.g., `Eq(5)` can match integers, unsigned longs, etc. This polymorphism enhances code reuse and reduces boilerplate.

Example:
```cpp
EXPECT_CALL(mock, Foo(Eq(42)));  // Matches Foo called with 42 of any compatible integral type.
```

---

## 2. Using Built-in Matchers

GoogleMock offers a rich set of built-in matchers, enabling powerful argument validations out of the box. Here are some primary categories:

### Wildcard Matchers

- **`_` or `A<T>()` or `An<T>()`**: Match any argument of type `T`.
- **Example:**
  ```cpp
  EXPECT_CALL(mock, Foo(_));  // Foo can be called with any argument.
  EXPECT_CALL(mock, Bar(A<int>()));  // Bar called with any int.
  ```

### Null Pointer Matchers

- **`IsNull()`**: Matches any null pointer.
- **`NotNull()`**: Matches any non-null pointer.
- Treats raw and smart pointers uniformly.

### Equality/Comparison Matchers

- **`Eq(value)`**: Matches values equal to `value`.
- **`Ne(value)`**: Matches values not equal to `value`.
- **`Lt(value)`, `Le(value)`, `Gt(value)`, `Ge(value)`**: Less-than and greater-than comparisons.
- Support polymorphic type conversions.

### String Matchers

- **`StrEq(expected)`** / **`StrNe(expected)`**: Exact, case-sensitive string equality/inequality for C and C++ strings.
- **`StrCaseEq(expected)` / `StrCaseNe(expected)`**: Case-insensitive string equality/inequality.
- **`StartsWith(prefix)` / `EndsWith(suffix)`**: Matches strings that start or end with the given substring.
- **`HasSubstr(substring)`**: Matches strings containing the substring.

### Regular Expression Matchers

- **`MatchesRegex(regex)`**: Matches strings that exactly match the given regular expression.
- **`ContainsRegex(regex)`**: Matches strings that contain a substring matching the regexp.

### Container and Sequence Matchers

- **`ElementsAre(...)`**: Matches containers with elements matching given matchers in order.
- **`UnorderedElementsAre(...)`**: Matches containers with elements matching the given matchers, order doesn't matter.
- **`Contains(matcher)`**: Matches containers containing at least one element satisfying the matcher.

### Compound Matchers

- **`AllOf(m1, m2, ...)`**: Matches if all matchers match.
- **`AnyOf(m1, m2, ...)`**: Matches if at least one matcher matches.
- **`Not(matcher)`**: Matches if the inner matcher does not match.

### Member and Property Matchers

- **`Field(&Class::member, matcher)`**: Matches objects whose member variable satisfies matcher.
- **`Property(&Class::method, matcher)`**: Matches objects whose property method returns a value that matches.

### Pointwise and Pair Matchers

- **`Pair(m1, m2)`**: Matches a pair whose first and second elements match `m1` and `m2` respectively.
- Useful for testing maps or associative containers.

---

## 3. Customizing Matchers

GoogleMock allows you to define your own matchers quickly and flexibly. This empowers you to express domain-specific logic cleanly and descriptively.

### Quick Custom Matchers Using `MATCHER` Macros

Defining a simple polymorphic matcher can be done in a few lines:

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}
```

This defines `IsEven()` matcher that you can use like:

```cpp
EXPECT_CALL(mock, Foo(IsEven()));
EXPECT_THAT(value, IsEven());
```

**Tip:** Use the `result_listener` argument to provide additional explanations on match failures or successes, improving diagnostic messages.

```cpp
MATCHER(IsDivisibleBy7, "") {
  if (arg % 7 == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

### Parameterized Matchers

Use `MATCHER_P`, `MATCHER_P2`, ..., `MATCHER_P10` to create matchers with one or more parameters.

Example:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}
```

Usage:

```cpp
EXPECT_THAT(number, HasAbsoluteValue(10));
```

### Writing New Monomorphic Matchers

For more control and explicitness, implement the matcher interface directly:

```cpp
template <typename T>
class DivisibleBy7Matcher : public MatcherInterface<T> {
 public:
  bool MatchAndExplain(T n, MatchResultListener* os) const override {
    return (n % 7) == 0;
  }

  void DescribeTo(std::ostream* os) const override {
    *os << "is divisible by 7";
  }

  void DescribeNegationTo(std::ostream* os) const override {
    *os << "is not divisible by 7";
  }
};

Matcher<int> DivisibleBy7() {
  return MakeMatcher(new DivisibleBy7Matcher<int>());
}
```

### Writing New Polymorphic Matchers

Define classes with templated `MatchAndExplain` method to support matching multiple types:

```cpp
class NotNullMatcher {
 public:
  template <typename T>
  bool MatchAndExplain(T* p, MatchResultListener* /* listener */) const {
    return p != nullptr;
  }
  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

inline PolymorphicMatcher<NotNullMatcher> NotNull() {
  return MakePolymorphicMatcher(NotNullMatcher());
}
```

### Composite Matchers

When a matcher takes other matchers as parameters, it can delegate descriptions and matching to them, building expressive combined behaviors.

An example is the `DistanceFrom` matcher, which stores an inner matcher and delegates description to it while operating on computed distances.

---

## 4. Using Matchers with `EXPECT_CALL` and `ON_CALL`

Matchers are fundamental to specifying call expectations and default behaviors:

- **`EXPECT_CALL(mock, Method(matcher1, matcher2, ...))`** asserts that a call will happen with arguments that satisfy the matchers.
- **`ON_CALL(mock, Method(matcher1, matcher2, ...))`** sets a default behavior when matching arguments.

### Multiple Matchers

For method calls with multiple arguments, you specify a matcher for each argument position. If omitted, the matcher `_` (wildcard) is assumed.

Example:
```cpp
EXPECT_CALL(foo, DoSomething(Ge(5), StrEq("hello")));
```

### Combining Argument Matchers

You can also match multiple arguments as a whole using the `.With()` clause containing a multi-argument matcher for all arguments as a tuple.

Example:
```cpp
EXPECT_CALL(foo, DoSomething(_, _))
    .With(Lt());  // Expects first arg < second arg
```

### Sharing Matchers

Matchers are lightweight objects that can be copied efficiently and shared among expectations.

---

## 5. Tips, Best Practices, and Common Pitfalls

- **Write Pure Matchers:** Matchers must be pure functions with no side effects.
- **Use `EXPECT_CALL` Wisely:** Use `ON_CALL` to specify default behaviors and `EXPECT_CALL` only when you want to set explicit expectations.
- **Be Careful With Types:** Use `SafeMatcherCast<T>` to ensure type safety when matching arguments of different but compatible types.
- **Match Containers Thoughtfully:** Use `ElementsAre`, `UnorderedElementsAre`, and `Contains` to express constraints on collections.
- **Add Descriptions:** Use `DescribeTo` and `DescribeNegationTo` in custom matchers for clearer diagnostics.
- **Explain Match Failures:** When defining own matchers, stream explanations to `result_listener` for highlighted failure reasons.

---

## 6. Troubleshooting Matchers

- If a matcher does not compile, verify that the matcher’s type matches the expected argument type or try casting with `SafeMatcherCast`.
- Ensure that polymorphic matchers are used in appropriate contexts.
- When tests fail unexpectedly, use verbose options to print matcher explanations (`--gmock_verbose=info`).

---

## 7. Further Resources

- [Matchers Reference](https://google.github.io/googletest/gmock_cook_book.html#using-matchers) for detailed matcher lists.
- [Writing New Matchers Quickly](https://google.github.io/googletest/gmock_cook_book.html#WritingNewMatchers) for extending matchers.
- Related documentation: [Setting Expectations](https://google.github.io/googletest/gmock_for_dummies.html#setting-expectations), [Actions Reference](https://google.github.io/googletest/gmock_for_dummies.html#actions), and [Assertions Reference](https://google.github.io/googletest/reference/assertions.html).

---

<Source url="https://github.com/google/googletest" paths={[{"path": "googlemock/include/gmock/gmock-matchers.h", "range": "1-455"}]} branch="main" />

