---
title: "Defining and Using Mocks"
description: "Explains how to declare mock classes and methods, use the MOCK_METHOD macro, and initialize the mocking environment for your tests. Provides step-by-step guides and idiomatic examples for typical mocking scenarios."
---

# Defining and Using Mocks

This document explains how to declare mock classes and methods using the `MOCK_METHOD` macro in GoogleMock (gMock). It guides you through creating mock classes, setting up expectations, defining default behaviors, and initializing mocks for your tests — all essential practices for effective interaction-based testing in C++.

---

## 1. Understanding Mocks and Mock Classes

A **mock object** mimics a real object's interface but allows you to specify **expectations** at runtime on the methods called and their behavior. This enables rigorous verification of interactions between your code and its dependencies.

### Why Use Mocks?
- Isolate units under test by replacing collaborators.
- Control behavior and output of dependencies.
- Verify method calls, call counts, and argument values.
- Simulate error conditions.

### Defining a Mock Class

To define a mock class in gMock:

1. Inherit from the interface or base class you want to mock.
2. Use `MOCK_METHOD` to define mock methods.
3. Place all `MOCK_METHOD` declarations in the `public` section, regardless of the method visibility in the base class.

### Syntax for `MOCK_METHOD`

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- **ReturnType**: The method's return type.
- **MethodName**: The method name.
- **(Args...)**: The argument list in parentheses.
- **(Qualifiers)** (optional): Method specifiers like `const`, `override`, `noexcept`, or calling conventions using `Calltype(...)`.

**Example:**

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, SetName, (const std::string& name), (override));
};
```

### Handling Types with Commas

Types like `std::pair<int, int>` contain commas, which confuse macro parsing. To fix this:

- Wrap the type in an extra pair of parentheses.
- Or use type aliases.

**Example:**

```cpp
using IntPair = std::pair<int, int>;
class MockFoo {
 public:
  MOCK_METHOD((IntPair), ProducePair, ());
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
};
```

### Mocking Const and Overloaded Methods

- Add `(const)` to specifiers for const methods.
- For overloaded methods, mock each overload separately and use `Const()` wrapper to mock const versions.

```cpp
MOCK_METHOD(Bar&, GetBar, (), (override));
MOCK_METHOD(const Bar&, GetBar, (), (const, override));
EXPECT_CALL(foo, GetBar());         // non-const
EXPECT_CALL(Const(foo), GetBar()); // const
```

### Mocking Class Templates

Templates are mocked similarly:

```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

---

## 2. Using Mocks in Tests

After defining mocks, use them in your tests to set expectations and specify behavior:

### Typical Workflow

1. Create mock objects.
2. Use `ON_CALL` to set default behavior (optional).
3. Use `EXPECT_CALL` to set expectations.
4. Exercise the system under test.
5. Verification happens automatically when mocks are destroyed.

### Creating and Setting Expectations

- **`ON_CALL(mock, Method(args))`** sets the default action when a method is called but does not assert on whether it is called or how many times.
- **`EXPECT_CALL(mock, Method(args))`** sets an expectation that the method *will* be called with matching arguments. It also allows defining actions and call counts.

**Example:**

```cpp
using ::testing::_;        // wildcard matcher
using ::testing::Return;

MockFoo mock;

ON_CALL(mock, GetSize())
    .WillByDefault(Return(5));   // Default behavior

EXPECT_CALL(mock, SetValue(_))   // Expect to be called any number of times
    .Times(::testing::AnyNumber());

EXPECT_CALL(mock, DoSomething(42))
    .Times(1)                  // Expect exactly one call
    .WillOnce(Return(true));   // Return true once

// Exercise
int size = mock.GetSize();        // returns 5
mock.SetValue(10);                // allowed any times
mock.DoSomething(42);             // returns true
```

### Ordering Expectations

By default, calls can occur in any order. To specify order:

- Use the `InSequence` helper for strict order.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, Init());
  EXPECT_CALL(mock, Run());
}
```

### Ignoring Uninteresting Calls

- By default, calls to mock methods without expectations will generate warnings.
- Use `NiceMock<T>` to suppress such warnings.
- Use `StrictMock<T>` to make uninteresting calls fail.

### Disallowing Calls

To assert that a function is never called:

```cpp
EXPECT_CALL(mock, Method(_))
    .Times(0);
```

---

## 3. Setting Default Behaviors with ON_CALL

- Use `ON_CALL` to declare default behaviors that apply whenever the mock method is called (usually in your test fixture setup).
- `ON_CALL` does not set expectations — the mock method can be called zero or more times.

```cpp
ON_CALL(mock, Compute(_)).WillByDefault(Return(42));
```

Note: If you do not specify an action for a method, gMock provides a default action:

- `void` methods do nothing
- Functions return 0, `false`, or default-constructed values

---

## 4. Macros for Declaring and Using Mocks

### `MOCK_METHOD`

Declares a mock method inside a mock class.

**Syntax:**
```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

**Examples:**
```cpp
MOCK_METHOD(void, Resize, (int width, int height), (override));
MOCK_METHOD(int, GetSize, (), (const, override));
```

### `EXPECT_CALL`

Creates an expectation that a mock method will be called with certain parameters.

**Basic Syntax:**
```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

Flags and chained clauses must be in a specific order.

### `ON_CALL`

Sets default actions for calls but does *not* set expectations.

**Example:**
```cpp
ON_CALL(mock, MethodName(matchers...)).WillByDefault(action);
```

---

## 5. Practical Mocking Tips and Best Practices

### Always Put `MOCK_METHOD` in Public Section

Mocks must be public so that testing code can set expectations and default actions on them.

### Use `NiceMock` to Silence Uninterested Call Warnings

```cpp
NiceMock<MockFoo> mock;
```
Suppresses warnings for uninteresting calls for tidier output.

### Avoid Over-specifying Expectations

Use `EXPECT_CALL` only for calls you *really* want to verify.
Overuse leads to brittle tests.

### Use `RetiresOnSaturation()` to Make Expectations Non-Sticky

By default, expectations are "sticky" and remain active after reaching their max call count. Use:
```cpp
EXPECT_CALL(mock, Method()).RetiresOnSaturation();
```
to deactivate after use.

### Lazy Evaluation of Lambdas and Return Values

`WillOnce(Return(...))` evaluates `Return(...)` exactly once at expectation setup. To return fresh values on each call, use lambdas:

```cpp
EXPECT_CALL(mock, Generate()).WillRepeatedly([]() {
  return MakeFreshObject();
});
```

### Mocking Move-only Types

`MOCK_METHOD` works with move-only types like `std::unique_ptr`. When returning such types, use lambdas with explicit construction rather than `Return` with moved values.

### Dealing with Overloaded and Const Methods

Use `Const()` to specify const overloads. Mock all overloads you need to use to avoid hiding base class methods.

---

## 6. Initializing GoogleMock in Tests

Before running tests with mocks, initialize GoogleMock: 

```cpp
int main(int argc, char** argv) {
  ::testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This sets up internal gMock flags and integration with GoogleTest.

---

## 7. Example: Mocking and Using a Simple Interface

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual void SetName(const std::string& name) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, SetName, (const std::string& name), (override));
};

TEST(FooTest, MockExample) {
  MockFoo mock_foo;

  // Default behavior
  ON_CALL(mock_foo, GetSize()).WillByDefault(::testing::Return(10));

  // Set expectations
  EXPECT_CALL(mock_foo, SetName(::testing::_))
      .Times(1);
  EXPECT_CALL(mock_foo, GetSize())
      .Times(::testing::AnyNumber())
      .WillRepeatedly(::testing::Return(10));

  // Exercise
  mock_foo.SetName("Test");
  int size = mock_foo.GetSize();

  EXPECT_EQ(size, 10);
}
```

---

## 8. Summary of Main Macros and Classes

| Macro / Class           | Purpose                                              |
|------------------------|------------------------------------------------------|
| `MOCK_METHOD`          | Defines a mocked method inside a mock class           |
| `EXPECT_CALL`          | Sets an expectation on a mock method call              |
| `ON_CALL`              | Sets a default behavior for a mock method              |
| `NiceMock<T>`          | Suppresses warnings for uninteresting calls           |
| `StrictMock<T>`        | Fails test on uninteresting calls                      |
| `Sequence`             | Represents a call sequence                              |
| `InSequence`           | Scoped helper to enforce call ordering                 |
| `Expectation`          | Represents a single call expectation                    |
| `ExpectationSet`       | Represents a set of expectations for ordering with `.After()` |

---

## 9. Additional Resources

- [Using Mocks in Tests](https://google.github.io/googletest/gmock_for_dummies.html#UsingMocks)
- [The Nice, the Strict, and the Naggy](https://google.github.io/googletest/docs/gmock_cook_book.html#NiceStrictNaggy)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)

---

## 10. Troubleshooting

### Common Issues

- Mocking non-virtual functions: gMock requires methods to be virtual to be mocked unless using specialized techniques.
- Ambiguous overloads in `ON_CALL` or `EXPECT_CALL`: always specify the parameter types or use disambiguation helpers.
- Uninteresting call warnings: use `NiceMock` or add `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` for catch-all.
- Mock objects not verified: ensure mocks are destroyed or call `Mock::VerifyAndClearExpectations()` explicitly.

<Tip>
Always place `EXPECT_CALL` before exercising code that invokes the mock methods to avoid undefined behavior.
</Tip>
<Tip>
Use `InSequence` or `.InSequence()` to control call order when needed.
</Tip>
<Tip>
Wrap complex expectations and actions with lambdas or custom matchers for clarity and maintainability.
</Tip>
