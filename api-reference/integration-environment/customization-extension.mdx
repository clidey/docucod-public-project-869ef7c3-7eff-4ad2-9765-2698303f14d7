---
title: "Custom Actions, Matchers, and Extensions"
description: "Shows how to extend GoogleTest and GoogleMock with user-defined actions, matchers, and internal utilities for advanced and non-standard testing needs."
---

# Custom Actions, Matchers, and Extensions

Extend your GoogleTest and GoogleMock capabilities by defining custom actions, matchers, and leveraging internal utilities tailored for advanced and non-standard testing scenarios. This page guides you through how to enhance your tests beyond the built-in features to handle unique behaviors and complex validation logic.

---

## Understanding the Purpose of Custom Extensions

While GoogleMock provides a rich set of matchers and actions out of the box, there are cases where your domain-specific requirements or complex data structures call for more tailored solutions. Custom extensions allow you to:

- Define new matchers to validate arguments beyond the standard predicates.
- Create actions that perform specific side effects or intricate behaviors on mock calls.
- Utilize internal utilities to fine-tune or hook into GoogleMock's workings.

Through these, you maintain expressive, maintainable, and powerful tests.

---

## Custom Actions

Actions define how a mock method behaves when called. When built-in actions do not suffice, you can implement custom ones.

### Defining Custom Actions

Custom actions are implemented as callable objects with a call operator matching the mocked method's signature. This can be done via lambdas, functor structs, or using the `ACTION` macros.

#### Example: Lambda-Based Custom Action
```cpp
EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce([](int x) {
      // Custom behavior
      return x * 2;
    });
```

#### Example: Using ACTION Macro
```cpp
ACTION(DoubleValue) { return arg0 * 2; }
...
EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce(DoubleValue());
```

**Tips:**
- For actions involving side effects or complex processing, lambdas or functors provide clear and concise code.
- Use `ACTION_P`, `ACTION_P2`, etc., macros to define parameterized actions for flexibility.

### Using Polymorphic Actions

For actions applicable across different function signatures, implement `Perform()` method templates and wrap them with `MakePolymorphicAction()`. This gives an action usable in multiple mock function types.


---

## Custom Matchers

Matchers let you specify complex conditions that mock method arguments must satisfy.

### Defining Simple Custom Matchers

The easiest way is to use the `MATCHER` or `MATCHER_P` macros for parameterized matchers.

#### Basic Example
```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock_obj, SomeMethod(IsEven()));
```

#### Parameterized Matcher Example
```cpp
MATCHER_P(IsMultipleOf, base, "checks if divisible by base") {
  return (arg % base) == 0;
}

EXPECT_CALL(mock_obj, SomeMethod(IsMultipleOf(3)));
```

### Defining Matcher Classes

For more control, define a class with `MatchAndExplain()`, `DescribeTo()`, and optionally `DescribeNegationTo()`.

```cpp
class PositiveMatcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    if (n > 0) return true;
    if (os) *os << "which is not positive";
    return false;
  }
  void DescribeTo(std::ostream* os) const { *os << "is positive"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is non-positive"; }
};

::testing::Matcher<int> IsPositive() { return PositiveMatcher(); }
```

### Best Practices
- Ensure matchers are **pure functions** without side effects.
- Provide meaningful failure messages to help diagnose test failures.
- Parameterize matchers when useful to increase reusability.

---

## Internal Utilities and User-Defined Extensions

The `gmock/internal/custom/` directory is an injection point for user customization, including flags and internal macros.

### Configuring via `gmock-port.h`

You can define macros to configure GoogleMock's behavior, such as:

- `GMOCK_DECLARE_bool_(name)`
- `GMOCK_DECLARE_int32_(name)`
- `GMOCK_DECLARE_string_(name)`
- `GMOCK_DEFINE_bool_(name, default_val, doc)`
- `GMOCK_DEFINE_int32_(name, default_val, doc)`
- `GMOCK_DEFINE_string_(name, default_val, doc)`
- `GMOCK_FLAG_GET(flag_name)`
- `GMOCK_FLAG_SET(flag_name, value)`

These macros let you declare, define, get, and set flags that control GoogleMock internals. Use these to customize runtime behavior, verbosity, and other internal settings.

**Note:** Modifying flags can affect test diagnostics and mock behavior globally.

---

## Extending Matchers and Actions: User Workflow

### Step 1: Identify the Need

Determine when built-in matchers or actions don't fully express the condition or behavior you want to test.

### Step 2: Choose Implementation Technique

- Use `MATCHER` macros for simple, declarative matchers.
- Write matcher classes for more detailed control and advanced features.
- Define actions as lambdas, functors, or using `ACTION` macros.

### Step 3: Integrate into Tests

Add your custom matcher or action to `EXPECT_CALL` or `ON_CALL` clauses.

```cpp
EXPECT_CALL(mock_obj, Method(CustomMatcher()))
    .WillOnce(CustomAction());
```

### Step 4: Document and Maintain

Maintain readable failure/error messages for easier debugging.

---

## Practical Example: Custom 'IsInRange' Matcher and Logging Action

```cpp
MATCHER_P2(IsInRange, low, high, "checks if value is in [low, high]") {
  return arg >= low && arg <= high;
}

ACTION(LogCall) {
  std::cout << "Mock method called with arg0 = " << arg0 << std::endl;
}

TEST(MyTest, UsesCustomMatcherAndAction) {
  MockFoo foo;
  EXPECT_CALL(foo, Bar(IsInRange(5, 10)))
      .WillOnce(LogCall());
  foo.Bar(7);  // Matches and logs.
}
```

---

## Troubleshooting

- **Matcher or Action not invoked?** Check signature compatibility and ensure the custom object can be called with the mock method's arguments.
- **Compilation errors:** Verify macro parameters and types; avoid unprotected commas in `MOCK_METHOD` macros.
- **Unexpected calls or warnings:** Review usage of `NiceMock` vs `StrictMock` wrappers.

---

## Summary

Custom actions and matchers unlock the full expressiveness of GoogleMock, enabling precise and maintainable tests even for complex scenarios. Leveraging internal utilities allows configuration and tailoring of mock behavior to your specific needs.

For comprehensive guidelines, visit the [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers) and the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html#NewMatchers).

---

## Related Documentation

- [gMock Cookbook: Creating Custom Matchers and Actions](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers)
- [Mocking Reference - Defining Custom Matchers and Actions](https://google.github.io/googletest/reference/mocking.html#NewMatchers)
- [Using Parameterized Matchers and Actions](https://google.github.io/googletest/gmock_cook_book.html#ParameterizedMatchers)
- [Nice, Naggy, and Strict Mocks](https://google.github.io/googletest/reference/mocking.html#NiceMock) for managing mock warnings and errors
- `gmock/internal/custom/` directory for advanced customizations

---

<Source url="https://github.com/google/googletest" paths={[{"path": "googlemock/include/gmock/internal/custom/README.md", "range": "1-24"}]} />