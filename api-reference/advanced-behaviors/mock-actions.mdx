---
title: "Specifying Actions for Mocks"
description: "Covers the action macros and facilities for specifying what a mock should do when called—default returns, side effects, and custom behaviors—using both built-in and user-defined actions."
---

# Specifying Actions for Mocks

This page covers how to specify what a mock should do when it is called using **actions** in Google Mock (gMock). Actions define the behavior of mock methods—what values they return, side effects they produce, or custom code they execute. You will learn to use built-in action macros as well as how to define your own actions to control mock behaviors precisely.

---

## Understanding Actions

When you write tests with mocks, you want not only to assert what methods are called, but also what those methods do when called. Actions let you declare this behavior.

### Types of Actions

- **Default return values** — what a mock returns if you don't specify otherwise.
- **Predefined side effects** — e.g., modifying an out parameter or setting errno.
- **Custom behavior** — like running a lambda or forwarding calls.

### How Actions Are Specified

Two primary macros govern actions:

- `ON_CALL()` — Defines default behaviors of mock methods without requiring calls.
- `EXPECT_CALL()` with `.WillOnce()` or `.WillRepeatedly()` — Defines expected calls and their behaviors.


## Predefined Built-in Actions

Google Mock ships with a rich set of built-in actions for common use cases.

### Returning Values

| Action                             | Description                                                                |
|-----------------------------------|----------------------------------------------------------------------------|
| `Return()`                        | Returns from a `void` mock function.                                       |
| `Return(value)`                   | Returns a copy or converted form of `value`.                              |
| `ReturnRef(variable)`             | Returns a reference to a variable. Useful when method return type is a reference. |
| `ReturnPointee(ptr)`              | Returns the value pointed to by a pointer. Useful for proxying live values. |
| `ReturnRefOfCopy(value)`          | Returns a reference to a stored copy of the value (lives as long as the action). |
| `ReturnRoundRobin({a1, ..., an})`| Cycles through the given list, returning each on successive calls, looping back. |
| `ReturnNull()`                    | Returns a null pointer.                                                    |
| `ReturnNew<T>(a1, ..., ak)`       | Returns a newly `new`-allocated object constructed with given arguments (caller owns it). |

### Side Effects

| Action                           | Description                                                                   |
|---------------------------------|-------------------------------------------------------------------------------|
| `SetArgPointee<N>(value)`       | Sets the N-th argument's pointed-to value to `value`.                        |
| `SetArrayArgument<N>(first, last)` | Copies elements from `[first, last)` into the N-th argument array or iterator. |
| `Assign(ptr, value)`            | Assigns `value` to the variable pointed to by `ptr`.                         |
| `DeleteArg<N>()`                | Deletes the N-th argument pointer (helps manage ownership in mocks).          |
| `SaveArg<N>(pointer)`           | Saves a copy of the N-th argument to the location pointed by `pointer`.      |
| `SaveArgByMove<N>(pointer)`     | Moves the N-th argument into the location pointed by `pointer`.              |
| `SaveArgPointee<N>(pointer)`    | Saves the pointed-to value of the N-th argument to `*pointer`.               |
| `SetArgReferee<N>(value)`       | Assigns `value` to the variable referenced by the N-th argument.             |
| `SetErrnoAndReturn(error, value)`| Sets `errno` and returns `value`.                                            |
| `Throw(exception)`              | Throws a specified exception. Available if exceptions are enabled.          |

### Using Functions, Lambdas, and Functors

You can provide any callable compatible with the mock method's signature using:

- `Invoke(function_or_functor)` — invoke with the mock method's arguments.
- `InvokeWithoutArgs(function_or_functor)` — invoke ignoring arguments.
- `Invoke(object_ptr, &Class::Method)` — invoke method on an object.
- `InvokeArgument<N>(args...)` — invoke the N-th argument (which must be callable) with given args.

```cpp
using ::testing::Invoke;

EXPECT_CALL(mock, DoWork(_, _))
    .WillOnce(Invoke([](int x, int y) { return x + y; }));
```

Declare uninteresting arguments as `Unused` in your callable if you want to ignore them for cleaner code.

### Combining Multiple Actions

`DoAll(a1, a2, ..., an)` runs all listed actions sequentially when the mock is called, returning the result of the last action.

Remember: only the last action in `DoAll` sets the return value of the call.

### Controlling Arguments for Actions

- `WithArg<N>(action)` — runs `action` passing only the N-th argument.
- `WithArgs<N1, N2, ...>(action)` — runs `action` using selected arguments.
- `WithoutArgs(action)` — runs `action` with no arguments.

This allows adapting actions/functions to the exact arguments they need, even if the mock method has a complex signature.

## Custom Actions

If built-in actions don’t suit your needs, define custom actions using:

### `ACTION` macros

- `ACTION(Name) { ... }` — defines an action with no parameters.
- `ACTION_P(Name, param) { ... }` — defines an action that takes one parameter.
- `ACTION_Pk(Name, p1, ..., pk) { ... }` — defines parameterized actions with k params.

Inside the body you can access mock arguments as `arg0`, `arg1`, … and their types as `arg0_type`, `arg1_type`, etc.

Example:

```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}
// Usage:
EXPECT_CALL(mock, Func(_)).WillOnce(IncrementArg1());
```

Use `param` and `param_type` similarly inside parameterized actions.

### Functors, Lambdas, and Method Calls

You can pass any callable with compatible signatures directly in `WillOnce()` and `WillRepeatedly()`:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 2; });
```

Or invoke a method on an object:

```cpp
EXPECT_CALL(mock, Clear())
    .WillOnce(Invoke(&someObject, &SomeClass::Clear));
```


### Important Notes

- Actions are evaluated once when the expectation is set, not each time the action runs, so be wary of side effects.
- You can chain multiple actions using `DoAll()`.
- `DoDefault()` triggers the default action set by `ON_CALL()` or returns the built-in default.

## Setting Default and Per-Method Actions

- Use `ON_CALL(mock, Method(args))` to specify default behavior without enforcing call expectations.
- Use `EXPECT_CALL(mock, Method(args))` with `.WillOnce()`, `.WillRepeatedly()`, or `.WillByDefault()` clauses to specify expected behavior.


## Example Scenarios

### Returning Values from Mock Methods

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42));

int v = mock.GetValue();  // v == 42
```

### Changing Output Arguments

```cpp
EXPECT_CALL(mock, FillBuffer(_))
    .WillOnce(SetArgPointee<0>(123)); // Sets *arg0 = 123

int val;
mock.FillBuffer(&val);
EXPECT_EQ(val, 123);
```

### Invoking Custom Code

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 2; });

int v = mock.Compute(21);  // v == 42
```

### Setting Multiple Side Effects

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(DoAll(SetArgPointee<0>(100), Return(true)));
```

### Invoking a Callable Argument

```cpp
EXPECT_CALL(mock, RunCallback(_))
    .WillOnce(InvokeArgument<0>(5)); // Invokes the first argument as a callable passing 5
```

### Delegating to a Real or Fake Object

You can use actions to delegate calls to an underlying object while still verifying interactions.


## Troubleshooting & Best Practices

- **Beware of Uninteresting Calls:** Calls to mock methods without expectations cause warnings; use `NiceMock` to suppress, or add an `EXPECT_CALL` with broad matchers.
- **Order of Actions:** Later `EXPECT_CALL` overrides earlier expectations — order your expectations carefully.
- **Proper Use of `RetiresOnSaturation()`:** Use to make expectations retire immediately after saturation to avoid sticky behaviors causing unexpected errors.
- **Use `DoAll()` to Combine Side Effects and Returns:** Always put the return action last.
- **Move-only Types:** Use lambdas or `Return(ByMove(std::move(x)))` for move-only return types.
- **Avoid Over-specification:** Only specify what is necessary, to keep tests maintainable and robust.

## Summary

Effective mock behaviors are enabled by specifying accurate actions. Google Mock offers declarative, composable ways to define these actions—from simple returns to complex custom behaviors—empowering you to simulate any interaction precisely.

---

## References and Further Reading

- [gMock Cookbook - Actions and Expectations](https://google.github.io/googletest/gmock_cook_book.html#using-actions)
- [Mocking Reference - EXPECT_CALL and ON_CALL](https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html#actions-what-should-it-do)

---

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "docs/gmock_cook_book.md", "range": "251-555"},{"path": "docs/reference/mocking.md", "range": "47-340"},{"path": "docs/reference/actions.md", "range": "4-143"},{"path": "googlemock/include/gmock/gmock-actions.h", "range": "20-525"},{"path": "googlemock/include/gmock/gmock-more-actions.h", "range": "26-186"}]} />