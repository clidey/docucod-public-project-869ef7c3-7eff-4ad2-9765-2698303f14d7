---
title: "Custom Matchers & Actions"
description: "How to define and register custom matchers and actions to handle domain-specific logic and complex test requirements. Features recipes, common patterns, and integration touchpoints."
---

# Custom Matchers & Actions

Explore how to define and register custom matchers and actions in GoogleMock to handle domain-specific logic and complex testing requirements effectively. This page guides you through practical recipes, common patterns, and integration points to extend your mocking capabilities beyond built-in matchers and actions.

---

## Overview

Sometimes, built-in GoogleMock matchers and actions are not enough to express your exact testing intent or to handle specialized domains and complex scenarios. This is where custom matchers and actions come into play. They empower you to:

- Validate intricate properties of arguments passed to mock methods.
- Define reusable predicates encapsulating domain-specific logic.
- Perform complex behaviors or side effects during mock invocations.

This page walks you through writing custom matcher classes, creating parameterized matchers and actions, registering them for reuse, and integrating them with your test code.

---

## Creating Custom Matchers

Custom matchers allow you to specify detailed expectations on mock method arguments that go beyond simple equality or basic comparisons.

### Using `MATCHER` and `MATCHER_P` Macros

These macros provide a concise way to create custom matchers.

```cpp
MATCHER(IsDivisibleBy7, "") { 
  return (arg % 7) == 0;
}

// Usage in EXPECT_CALL
EXPECT_CALL(mock_foo, Bar(IsDivisibleBy7()));
```

Parameterized matchers can accept arguments:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}

EXPECT_THAT(number, HasAbsoluteValue(10));
```

**Tips:**

- Use `result_listener` inside the matcher body to provide richer failure messages.
- The `arg` variable represents the value being matched.

### Defining Matcher Classes for Advanced Cases

When you need more control or expect to reuse the matcher extensively, define a matcher class implementing:

- `bool MatchAndExplain(const T& value, std::ostream* os) const` - returns match success and optionally logs details.
- `void DescribeTo(std::ostream* os) const` - describes what the matcher expects.
- `void DescribeNegationTo(std::ostream* os) const` - describes the negation.

Example:

```cpp
class BarPlusBazEqMatcher {
 public:
  using is_gtest_matcher = void;
  explicit BarPlusBazEqMatcher(int expected_sum) : expected_sum_(expected_sum) {}

  bool MatchAndExplain(const Foo& foo, std::ostream* /*listener*/) const {
    return (foo.bar() + foo.baz()) == expected_sum_;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "bar() + baz() equals " << expected_sum_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "bar() + baz() does not equal " << expected_sum_;
  }

 private:
  const int expected_sum_;
};

::testing::Matcher<const Foo&> BarPlusBazEq(int expected_sum) {
  return BarPlusBazEqMatcher(expected_sum);
}
```

### Best Practices for Custom Matchers

- Keep matchers pure functional—avoid side effects.
- Provide helpful descriptions for both positive and negative matches.
- Use parameterized matchers to enhance reusability.

---

## Writing Custom Actions

Actions define what happens when a mock method is called. You can create custom actions when built-in ones do not fit your needs.

### Using Lambdas or Functors as Actions

You can define an action as a C++ lambda or callable:

```cpp
EXPECT_CALL(mock, Method(_))
    .WillOnce([](int value) { return value * 10; });
```

Actions may return a value matching the method's return type or be `void`.

### Defining New Actions with `ACTION` Macros

GoogleMock provides macros to define parameterized actions conveniently:

```cpp
ACTION(IncrementArg0) {
  return ++(*arg0);
}

EXPECT_CALL(mock, DoSomething(_))
    .WillOnce(IncrementArg0());
```

Parameterized actions:

```cpp
ACTION_P(Add, n) {
  return arg0 + n;
}

EXPECT_CALL(mock, Compute(_))
    .WillOnce(Add(5));  // Returns arg0 + 5
```

### Composing Multiple Actions

Use `DoAll()` to perform multiple actions in sequence, returning the last action's result:

```cpp
EXPECT_CALL(mock, Do(_))
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)));
```

### Using Action Adaptors

- `WithArg<N>(action)` – Passes only the N-th argument to the inner action.
- `WithArgs<N1, N2, ..., Nk>(action)` – Passes selected arguments.
- `WithoutArgs(action)` – Calls the inner action without arguments.

This helps adapt actions to the mock's signature.

---

## Registering and Reusing Custom Matchers and Actions

Once defined, custom matchers and actions can be re-used across tests.

- Define them in headers within your test utility libraries.
- Use meaningful names and provide descriptive messages.
- For polymorphic usage, ensure templates or macros are carefully crafted.

Example of reusing a polymorphic matcher:

```cpp
MATCHER_P(IsCloseTo, value, "") {
  return fabs(arg - value) < 0.001;
}

EXPECT_CALL(mock, SetTemperature(IsCloseTo(21.5)));
```

---

## Common Patterns and Recipes

### Delegating to a Real or Fake Implementation

Sometimes you want your mock to forward calls to a real or fake object while still verifying calls:

```cpp
class MockFoo : public Foo {
 public:
  MockFoo() {
    ON_CALL(*this, DoThis).WillByDefault(
        [this](int n) { return real_.DoThis(n); });
  }

  MOCK_METHOD(char, DoThis, (int n), (override));

 private:
  Foo real_;
};
```


### Handling Move-Only Types

Mocking methods returning or accepting move-only types (like `std::unique_ptr`) is supported naturally with `MOCK_METHOD`. Use lambdas for custom behavior. See recipes in the Cookbook for details.

### Combining Multiple Matchers

To match complex conditions across arguments, use `.With()` clause with tuple-based matchers:

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .With(AllOf(Args<0, 1>(Gt(0)), Args<1>(Lt(100))));
```

---

## Tips and Troubleshooting

- **Use `ON_CALL` for default behavior and `EXPECT_CALL` for expectations.** Overuse of `EXPECT_CALL` makes tests brittle.

- **Beware of uninteresting calls warnings.** Use `NiceMock` to suppress expected uninteresting calls.

- **Check matcher purity.** Matchers must be side-effect free.

- **For overloaded methods, disambiguate with `Const()` or explicit matchers.**

- **To avoid infinite recursion when delegating to base class methods, call base implementation explicitly.**

- **Use sequences and `.After` to specify call order constraints where needed.**

- **Use `RetiresOnSaturation()` for expectations that become inactive once saturated to avoid conflicts.**

---

## Additional Resources

- [gMock Cookbook - Writing New Matchers](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#NewMatchers)
- [gMock Actions Reference](https://github.com/google/googletest/blob/main/docs/reference/actions.md)
- [gMock Cheat Sheet](https://github.com/google/googletest/blob/main/docs/gmock_cheat_sheet.md)
- [gMock For Dummies](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md)

Explore these resources for detailed examples, common pitfalls, and advanced patterns.

---

## Summary

Custom matchers and actions give you powerful tools to tailor GoogleMock behavior for your domain's needs and complex test scenarios. This guide introduced the essentials of defining custom matcher classes and parameterized macros, crafting custom actions via lambdas or functors, chaining multiple actions, and composing argument selectors. It also outlined best practices, common recipes, troubleshooting advice, and resources for further learning. By mastering custom matchers and actions, you can create more expressive, maintainable, and precise tests that truly verify your system's behavior.
