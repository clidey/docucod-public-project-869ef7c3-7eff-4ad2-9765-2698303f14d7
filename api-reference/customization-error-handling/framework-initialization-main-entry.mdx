---
title: "Framework Initialization and Main Entry Point"
description: "Documents the API for initializing the framework and customizing startup/shutdown flows, including providing a custom main function and embedded usage patterns."
---

# Framework Initialization and Main Entry Point

This document guides you through initializing the GoogleTest and GoogleMock testing frameworks and customizing their startup and shutdown flows. It explains how to embed the framework in your own main function, manage command-line flag processing, and use predefined main entry points, ensuring seamless integration into your C++ test programs.

---

## Overview

GoogleTest and GoogleMock provide robust, flexible mechanisms to initialize and execute your tests. Understanding initialization and main entry points is essential for effectively configuring test programs to run reliably across platforms.

- Initialization involves parsing command-line arguments for framework-specific flags.
- The main entry point runs tests, manages global setup/teardown, and returns a status indicating success or failure.
- Customizing these steps allows integration into complex environments or workflows.

## Initialization Functions

### `InitGoogleTest` and `InitGoogleMock`

These functions prepare your test framework for execution:

- **Purpose**: Parse and remove recognized GoogleTest/GoogleMock flags from the command line.
- **Usage**: Should be called before running any tests to ensure correct flag handling.

**Function Signatures**:
```cpp
// Initialize GoogleTest with argc/argv pointers
void InitGoogleTest(int* argc, char** argv);

// Initialize GoogleMock (which also initializes GoogleTest) with argc/argv pointers
void InitGoogleMock(int* argc, char** argv);
```

**Key Points:**
- Both functions must be called with pointers to argument count and argument vector to modify them in place.
- On Windows in Unicode mode, wide string overloads are supported.
- `InitGoogleMock` internally calls `InitGoogleTest`; calling both separately is unnecessary.

### Behavior

- Parses `argc` and `argv` for test framework flags (e.g., `--gtest_filter`, `--gmock_verbose`).
- Removes recognized flags from `argv`, adjusting `argc` accordingly.
- Leaves unrecognized flags intact for use by your program or other libraries.

### Practical Example

```cpp
int main(int argc, char** argv) {
  testing::InitGoogleTest(&argc, argv);

  // Your custom initialization here

  return RUN_ALL_TESTS();
}
```

### Handling Unrecognized Flags

Unrecognized flags are preserved in the command line arguments. This ensures your application can interpret or forward them appropriately.

<Tip>
Always call initialization functions before invoking `RUN_ALL_TESTS()` to guarantee flags are set up properly.
</Tip>

## Using the Main Function Provided by Libraries

### `gtest_main` and `gmock_main` Libraries

These packages provide default implementations of the `main()` function, enabling quick setup without writing boilerplate code:

- `gtest_main` initializes GoogleTest and runs all tests.
- `gmock_main` initializes GoogleMock (and GoogleTest) and runs all tests.

### Behavior of Default `main()`

- Prints a startup message indicating its origin file.
- Calls the appropriate initialization function.
- Calls `RUN_ALL_TESTS()` and returns its status.

### When to Use

- Ideal for straightforward test programs.
- Avoid if you need to perform custom initialization, parse other arguments, or control test execution more granularly.

### Example of Linking Default Main

When linking, choose one of:
```sh
# Link with googletest's main:
TARGET_LINK_LIBRARIES(my_test gtest_main)

# Or link with googlemock's main:
TARGET_LINK_LIBRARIES(my_mock_test gmock_main)
```

## Writing a Custom Main Function

If you need to customize your test startup or shutdown flow, GoogleTest allows you to write your own `main`:

### Step-by-step

<Steps>
<Step title="Declare main function with argc and argv">
Define your main function with the standard signature:

```cpp
int main(int argc, char** argv);
```
</Step>
<Step title="Call testing::InitGoogleTest or InitGoogleMock">
Pass `argc` and `argv` by pointer to initialize the test framework and parse its flags:

```cpp
testing::InitGoogleTest(&argc, argv);
```
</Step>
<Step title="Add any custom startup logic">
Perform necessary setup (e.g., logging, environment configuration) after framework initialization.
</Step>
<Step title="Run all tests">
Invoke `RUN_ALL_TESTS()` to execute all registered tests:

```cpp
return RUN_ALL_TESTS();
```
</Step>
</Steps>

### Complete minimal example

```cpp
#include <gtest/gtest.h>

int main(int argc, char** argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

### Important Notes

- Always return the result of `RUN_ALL_TESTS()`; this informs your build system or CI whether tests succeeded.
- Call initialization functions *only once*.
- On platforms with Unicode support (e.g., Windows), `InitGoogleTest` supports wide strings.

## Embedded and Platform-Specific Usage

### Arduino and ESP Platforms

- Entry points are `setup()` and `loop()` instead of `main()`.
- Call `InitGoogleTest()` or `InitGoogleMock()` inside `setup()`.
- Invoke `RUN_ALL_TESTS()` in `loop()`.

Example for Arduino-like devices:

```cpp
void setup() {
  testing::InitGoogleTest();
}

void loop() {
  RUN_ALL_TESTS();
}
```

### QuRT Platform

- Main function has no arguments; `InitGoogleTest()` initializes without parameters.

### Windows Mobile

- Uses `_tmain()` instead of `main()` with `TCHAR` arguments.

These platform adaptations handle platform-specific constraints and bootstrapping.

## Command-Line Flag Processing

GoogleTest and GoogleMock use command-line flags to configure test runs:

- Flags specify filters, output format, mock behavior, verbosity, repetitions, etc.
- The `InitGoogleTest` and `InitGoogleMock` functions recognize and parse these flags.
- Flags are removed from `argv` after parsing.

### Examples of Flags Recognized

- `--gtest_filter=TestSuite.TestName`
- `--gtest_repeat=5`
- `--gmock_verbose=info`

### Flag Behavior

- Unrecognized flags remain in `argv` for your program.
- Some flags affect mock default behaviors and verbosity.

### Practical Guideline

Use `InitGoogleMock` if your tests include mocks â€” it initializes both GoogleMock and GoogleTest properly.

## Handling Setup and TearDown Failures at Framework Level

GoogleTest's global environments let you register setup and teardown routines that run before and after all tests.

- Fatal failures in global `SetUp()` will cause no tests to run.
- Non-fatal failures allow tests to run but affect overall result.
- `TearDown()` is always run if `SetUp()` ran, even if failures were recorded.

This process is handled internally by the framework upon invocation of `RUN_ALL_TESTS()`.

## Best Practices and Common Pitfalls

- **Do not ignore the return value of `RUN_ALL_TESTS()`**; always return it from `main()`.
- **Avoid calling `RUN_ALL_TESTS()` multiple times**; this can interfere with advanced features.
- **Initialize the framework early**, before any application-specific setup that relies on flags.
- **Use default main() libraries** if no custom behavior is required to reduce boilerplate.
- **Preserve unrecognized flags** for your program's own use by relying on the framework's flag parsing.

<Warning>
Failing to call `InitGoogleTest()` before `RUN_ALL_TESTS()` can lead to unexpected behavior or ignored flags.
</Warning>

## Summary Diagram of Initialization and Test Execution Flow

```mermaid
flowchart TD

  A[Start main() or setup()] --> B[Call InitGoogleTest/InitGoogleMock]
  B --> C[Parse & Remove Framework Flags from argv]
  C --> D{Initialization success?}
  D -->|Yes| E[Run RUN_ALL_TESTS()]
  D -->|No| F[Report Initialization Failure]
  E --> G[Global Environments SetUp() Called]
  G --> H{SetUp Fatal Failure?}
  H -->|No| I[Run All Registered Tests]
  H -->|Yes| J[Skip Tests]
  I --> K[Global Environments TearDown() Called]
  J --> K
  K --> L[Report Test Results & Exit]

  %% Styling
  classDef decision fill:#f96,stroke:#333,stroke-width:2px;
  class D,H decision;
```

## Reference Links

- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md)
- [GoogleMock README](https://github.com/google/googletest/blob/main/googlemock/README.md)
- [Writing Your Main Function](https://github.com/google/googletest/blob/main/docs/primer.md#writing-the-main-function)
- [gtest_main Source](https://github.com/google/googletest/blob/main/googletest/src/gtest_main.cc)
- [gmock_main Source](https://github.com/google/googletest/blob/main/googlemock/src/gmock_main.cc)

---

## Troubleshooting Common Startup Issues

| Problem | Cause | Solution |
|---------|-------|----------|
| Flags not recognized or ignored | Called `RUN_ALL_TESTS()` before `InitGoogleTest()` | Ensure `InitGoogleTest()` is called first with correct pointers |
| Duplicate definition of `main()` | Linked with both `gtest_main` and custom `main` | Remove one definition or use only one main implementation |
| Tests not running on embedded platform | Missing setup/loop entry points | Use platform-specific hooks like `setup()` and `loop()` and call Init functions appropriately |

<Tip>
Use verbose flags (`--gmock_verbose=info`) during startup to diagnose initialization issues.
</Tip>

---

This page fits within the broader customization and error handling API reference and works alongside test fixture management and execution configuration documentation.



