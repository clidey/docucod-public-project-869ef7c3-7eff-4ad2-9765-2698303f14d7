---
title: "Setting Expectations & Cardinalities"
description: "Explains how to specify and check expectations on mock calls, including cardinality (ONCE, ANY, etc.), ordered/sequence expectations, and failure diagnostics. Includes code snippets showing typical expectation flows in unit tests."
---

# Setting Expectations & Cardinalities

Understand how to specify, control, and verify expectations on mock calls using GoogleMock. This guide explains cardinalities such as `ONCE`, `ANY`, and others that define how many times a mocked function is expected to be called. It also covers controlling call order via sequences, setting failure diagnostics, and presents real-world C++ code snippets illustrating typical use patterns in unit tests.

---

## Overview

GoogleMock's powerful expectation system lets you precisely control what mock methods should be called, how often, in what order, and their behavior. Setting expectations correctly ensures your tests validate the interactions between components, not just the final state.

When writing tests, the following are primary goals:

- Specify **which mock methods** should be called
- Define **how many times** each will be called (cardinality)
- Control **call ordering** when needed
- Customize **mocked behavior** and returned values
- Diagnose failures with detailed messages when expectations don't match

GoogleMock provides declarative macros `EXPECT_CALL()` and modifiers like `.Times()`, `.InSequence()`, `.After()`, to help accomplish this.

---

## Expectation Basics

Expectations are created with the `EXPECT_CALL(mock_object, method(matchers...))` macro. This establishes that the specified method is expected to be called with arguments matching the provided matchers.

### Typical Expectation Flow

1. **Create a mock object**.
2. **Set expectations** on mock methods to specify expected calls.
3. **Exercise the tested code** that uses those mocks.
4. **Automatic verification** happens on mock destruction or on explicit calls.

```cpp
MockTurtle turtle;
EXPECT_CALL(turtle, PenDown())
    .Times(AtLeast(1));

// ... code that exercises turtle ...

// Verification happens when 'turtle' is destroyed
```

If the method is called fewer or more times than expected or with incorrect args, GoogleMock immediately reports an error.

---

## Cardinalities: Controlling Call Counts

The core way to specify how many times a mock method should be called is the `.Times()` clause. Cardinalities express exact counts or flexible bounds on the number of calls.

| Cardinality       | Meaning                                                                             |
|-------------------|-------------------------------------------------------------------------------------|
| `AnyNumber()`     | The method can be called any number of times, including zero.                       |
| `AtLeast(n)`      | The method must be called *at least* `n` times.                                    |
| `AtMost(n)`       | The method can be called *at most* `n` times (including zero).                      |
| `Between(m, n)`   | The method must be called between `m` and `n` times (inclusive).                    |
| `Exactly(n)` or `n` | The method must be called exactly `n` times. If `n` is zero, the method must never be called. |

### Examples

```cpp
EXPECT_CALL(turtle, Forward(100))
    .Times(Exactly(1));        // Exactly once
EXPECT_CALL(turtle, Turn(_))
    .Times(AtLeast(2));        // At least twice
EXPECT_CALL(turtle, GoTo(_, _))
    .Times(AnyNumber());       // Any number of times
EXPECT_CALL(turtle, PenDown())
    .Times(Between(3, 5));    // Between 3 and 5 times
```

### Cardinality Without `.Times()`

GoogleMock can infer cardinalities based on `.WillOnce()` and `.WillRepeatedly()` clauses when `.Times()` is omitted:

- No `.WillOnce()` or `.WillRepeatedly()`: default cardinality is `Times(1)`.
- `n` `.WillOnce()` clauses and no `.WillRepeatedly()`: cardinality `Times(n)`.
- `n` `.WillOnce()` clauses and one `.WillRepeatedly()`: cardinality `Times(AtLeast(n))`.

### Failure Diagnostics on Cardinality Violations

When an expectation is violated, GoogleMock reports:

- The expected number of calls
- The actual number of calls
- Whether the expectation is satisfied, saturated (upper bound met), or over-saturated (called too many times)

```text
Expected: to be called once
  Actual: called twice - over-saturated and active
```

---

## Ordering Expectations

By default, expectations can match calls in any order. You can impose order using:

- **Sequences**: Use `Sequence` objects to enforce total or partial order on expectations.
- **InSequence scope**: Enforces that all expectations declared within the scope occur in order.
- **After clause**: Specifies that an expectation can only be triggered after other expectations have happened.

### Using `InSequence`

```cpp
using ::testing::InSequence;
{
  InSequence seq;

  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

All calls must happen in this order: `PenDown()`, then `Forward(100)`, then `PenUp()`.

### Using `Sequence` with `InSequence`

```cpp
using ::testing::Sequence;
Sequence seq1, seq2;

EXPECT_CALL(turtle, Reset())
    .InSequence(seq1, seq2);
EXPECT_CALL(turtle, GetSize())
    .InSequence(seq1);
EXPECT_CALL(turtle, Describe())
    .InSequence(seq2);
```

This sets up a partial order DAG where `Reset()` must happen before both `GetSize()` and `Describe()` but the latter two can be unordered.

### Using `After`

If you want an expectation to occur only after some other expectations:

```cpp
using ::testing::Expectation;
Expectation init_x = EXPECT_CALL(turtle, InitX());
Expectation init_y = EXPECT_CALL(turtle, InitY());
EXPECT_CALL(turtle, Describe())
    .After(init_x, init_y);
```

Call to `Describe()` is allowed only after `InitX()` and `InitY()` are called.

---

## Sticking and Retiring Expectations

Expectations in GoogleMock are "sticky" — they remain active even after their upper bound has been reached, meaning they continue matching calls and can fail if over-invoked.

If you want an expectation to become inactive (retire) after saturation:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(10))
    .RetiresOnSaturation();
```

This means once the expected call count is met, the expectation won't match further calls.

### Behavior in Sequences

Expectations part of a sequence retire automatically after the next expectation in sequence is satisfied.

---

## Typical Expectation Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)   // Optional
    .Times(cardinality)        // Optional
    .InSequence(sequences...)  // Optional
    .After(expectations...)    // Optional
    .WillOnce(action)          // Optional (can repeat multiple times)
    .WillRepeatedly(action)    // Optional
    .RetiresOnSaturation();    // Optional
```

Example:

```cpp
EXPECT_CALL(turtle, Forward(100))
    .Times(Exactly(3))
    .WillOnce(Return())
    .WillOnce(Return())
    .WillOnce(Return())
    .RetiresOnSaturation();
```

---

## Realistic Example: Mocking Turtle

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(DrawTest, DrawsSquare) {
  MockTurtle turtle;

  {
    InSequence seq;
    EXPECT_CALL(turtle, PenDown())
        .Times(Once());
    EXPECT_CALL(turtle, Forward(100))
        .Times(4);
    EXPECT_CALL(turtle, PenUp())
        .Times(Once());
  }

  // Code under test here exercises turtle
  DrawSquare(&turtle, 100);
}
```

This test asserts `PenDown()` occurs once before exactly four `Forward(100)` calls, followed by one `PenUp()`. The `InSequence` object enforces this call order.

---

## Failure Diagnostics

When a mock call fails to meet expectations, GoogleMock produces detailed diagnostics including:

- Actual vs expected call counts
- Which expectations are active or retired
- Ordering violations (calls happening out of defined sequence)
- Argument mismatches, showing expected vs actual argument values

Example message for too few calls:

```text
Actual function call count doesn't match this expectation:
  Expected: to be called at least twice
  Actual: called once - unsatisfied and active
```

Example message for out-of-order call:

```text
Unexpected mock function call - returning directly.
Function call: Forward(50)
Google Mock tried the following expectations, but none matched:
  Expected: Forward(100)
  Actual: Forward(50)
```

---

## Best Practices

- **Set expectations before using mock objects.** Calling methods before `EXPECT_CALL` can cause undefined behavior.
- **Avoid over-specification.** Use matchers or wildcards `_` for arguments where exact values are not important.
- **Use `RetiresOnSaturation()`** when you want sequential expectations or to avoid sticky expectation pitfalls.
- **Control call order with `InSequence` or `Sequence` objects** only if order matters. Otherwise, keep tests flexible.
- **Leverage `AnyNumber()` when you want to allow a method to be called zero or more times.**

---

## Troubleshooting

### Common Issues

- **Unexpected call error:** Occurs if a mock method is called that matches no active expectation. Review that all expected calls and matchers are set correctly.

- **Too many calls error:** When calls exceed the upper bound specified by `.Times()`. Consider using `RetiresOnSaturation()` or relaxing cardinality.

- **Order violation:** Calling mock methods in an order that violates `InSequence` or `After` constraints. Confirm order expectations and sequences.

- **Uninteresting call warning:** Mock method called without any expectation. Add an `EXPECT_CALL(...).Times(AnyNumber())` or use `NiceMock` to suppress warnings.

### Diagnostic Tips

Run tests with `--gmock_verbose=info` to see detailed logs of expectation matching and mock call traces.

---

## Summary

GoogleMock's expectation system empowers you to specify mock method call counts with precise cardinalities and control call order through sequences and dependencies. Use `EXPECT_CALL` with `.Times()`, `.InSequence()`, `.After()`, and `.RetiresOnSaturation()` to build robust interaction tests that clearly express your intent and help pinpoint mismatches during test failures.

---

## Related Documentation

- [Mocking Reference](../reference/mocking.md#EXPECT_CALL) — Detailed syntax and semantics of `EXPECT_CALL()` and expectation clauses.
- [gMock for Dummies](../docs/gmock_for_dummies.md) — Beginner-friendly introduction to mocking.
- [gMock Cookbook](../docs/gmock_cook_book.md) — Recipes including sequences, cardinalities, and actions.
- [Matchers Reference](../api-reference/matchers-actions/matchers-reference.md) — Argument matching techniques.
- [Actions Reference](../api-reference/matchers-actions/actions-reference.md) — How to specify behavior of mocked methods.
