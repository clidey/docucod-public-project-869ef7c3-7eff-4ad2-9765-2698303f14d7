---
title: "Expectations, Actions, and Cardinalities"
description: "Comprehensive reference for specifying, verifying, and controlling mock interactions: setting up expected calls (EXPECT_CALL, ON_CALL), handling cardinalities, defining custom actions, and advanced stubbing techniques."
---

# Expectations, Actions, and Cardinalities

Comprehensive reference for specifying, verifying, and controlling mock interactions: setting up expected calls (`EXPECT_CALL`, `ON_CALL`), handling cardinalities, defining custom actions, and advanced stubbing techniques.

---

## Overview

This section guides you through the core mechanisms that let you specify and control how mock objects behave in your tests using GoogleMock. You will learn how to:

- Specify **expected calls** precisely with `EXPECT_CALL`.
- Set **default behaviors** without strict expectations using `ON_CALL`.
- Describe **how many times** a function should be called using **cardinalities**.
- Define **custom actions** to control what happens when a mock method is invoked.
- Use **advanced stubbing techniques** for flexible and powerful mock behavior.

Together, these tools allow you to create tests that precisely verify the interaction between components, tailoring mock behavior to your testing needs.

---

## Specifying Expected Calls with `EXPECT_CALL`

`EXPECT_CALL` is your primary tool to express *what* calls to a mock method are expected during a test.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .Times(cardinality)
    .WillOnce(action)...
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

- **`mock_object`**: The mock instance.
- **`Method(matchers...)`**: The method name with argument matchers specifying the expected call parameters.
- **Chaining clauses**: Customize the expectation with cardinality, actions, ordering, and retirement.

### Key Clauses

- **`Times()`**: Specifies how many times this call is expected. See [Cardinalities](#cardinalities-handling-in-expectations).
- **`WillOnce()`**: Specifies the action to take on the first matching call.
- **`WillRepeatedly()`**: Specifies actions for subsequent calls after `WillOnce`s are exhausted.
- **`RetiresOnSaturation()`** *(optional)*: Causes the expectation to retire once fully satisfied, allowing subsequent expectations to match calls.

### Example

```cpp
using ::testing::Return;  

EXPECT_CALL(foo, GetSize())
    .Times(3)
    .WillRepeatedly(Return(42));
```
This says `foo.GetSize()` is expected to be called exactly three times, and returns 42 every time.

### Important Notes

- If no `Times()` is specified, gMock infers one based on actions specified.
- If no actions are specified, gMock returns a *default value* appropriate for the method's return type.
- Newer `EXPECT_CALL`s override older matching expectations, making order important.

---

## Setting Default Behavior with `ON_CALL`

`ON_CALL` sets up default behaviors **without** strict call count expectations.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .WillByDefault(action);
```

- Unlike `EXPECT_CALL`, it doesn't require the method to actually be called.
- `.With()` clause refines which calls the default behavior applies to.

### When to Use `ON_CALL`

- When you want the mock method to provide canned responses but are not strictly verifying call counts or ordering.
- Define common or fallback behavior shared across tests.

### Interaction with `EXPECT_CALL`

`EXPECT_CALL` expectations take precedence over `ON_CALL` defaults.

### Example

```cpp
using ::testing::Return;

ON_CALL(foo, GetSize()).WillByDefault(Return(10));
```
`foo.GetSize()` will return 10 unless an `EXPECT_CALL` overrides it.

---

## Handling Cardinalities in Expectations

Cardinalities specify **how many times** a mock method is expected to be called.

### Built-in Cardinalities

| Cardinality     | Meaning                                     |
|-----------------|---------------------------------------------|
| `AnyNumber()`   | May be called any number of times (including zero). |
| `AtLeast(n)`   | At least `n` calls expected.                  |
| `AtMost(n)`    | No more than `n` calls.                        |
| `Between(m, n)`| Between `m` and `n` calls, inclusive.          |
| `Exactly(n)` or `n` | Exactly `n` calls.                            |

### Behavior and Checks

- Calls exceeding **upper bounds** cause errors.
- Calls fewer than **lower bounds** cause errors at verification.
- Cardinalities can be combined with `.RetiresOnSaturation()` to automatically retire expectations once saturated.

### Example

```cpp
EXPECT_CALL(foo, Bar())
    .Times(AtLeast(2))
    .WillRepeatedly(Return(true));
```
The `foo.Bar()` method must be called two or more times.

### Defining Custom Cardinalities

You can define your own cardinalities by implementing the `CardinalityInterface`, allowing for advanced call count semantics.

---

## Defining and Using Actions

Actions specify **what to do** when a mock method is invoked.

### Built-in Actions

- `Return(value)`: Return a specified value.
- `ReturnRef(variable)`: Return a reference to a variable.
- `ReturnPointee(pointer)`: Return the value pointed to by a pointer.
- `Invoke(callable)`: Call a function, method, or lambda.
- `SetArgPointee<N>(value)`: Set output argument #N to a value.
- `DoAll(a1, a2, ..., an)`: Combines multiple actions; only the last action's return is used.
- `DeleteArg<N>()`: Deletes a pointer argument.

### Custom Actions

You can define custom actions using lambdas, functors, or by implementing the ActionInterface.

### Chaining Actions

Use `DoAll()` to perform multiple side effects in one call.

### Example

```cpp
EXPECT_CALL(mock, Process(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```
When `Process` is called, this sets the second argument to 42 and returns true.

### Invoking Callbacks Passed as Function Arguments

Use `InvokeArgument<N>(args...)` to invoke a callable argument at position N with given arguments.

### Ignoring Action Return

Use `IgnoreResult()` to use an action that returns a value in a context that expects void.

---

## Advanced Stubbing and Behavior Control

### Ordering Expectation Calls

- Use `InSequence` to enforce call order:

  ```cpp
  {
    InSequence s;
    EXPECT_CALL(mock, First());
    EXPECT_CALL(mock, Second());
  }
  ```

- Use `After()` clause to specify that an expectation must occur after other ones.
- You can specify partial orders with multiple sequences.

### Controlling Expectation Lifetimes

- Expectations are *sticky* by default: they remain active after saturation.
- Use `.RetiresOnSaturation()` to retire an expectation once it is saturated.

### Fine-tuning Matchers

- Use argument matchers (`_`, `Eq()`, `Ge()`, custom ones) to specify which calls are expected.
- Use `.With()` to apply a matcher over the entire argument tuple for complex relations between arguments.

### Defining Default Return Values

- Use `DefaultValue<T>::Set()` to specify default returns for types.
- Override default actions in `ON_CALL` to customize behavior without imposing call expectations.

---

## Verifying and Resetting Mocks

### Automatic Verification

When a mock object is destructed, gMock automatically verifies that all expectations have been satisfied.

### Forcing Verification

Call `Mock::VerifyAndClearExpectations(&mock_obj)` to explicitly verify and clear expectations before destruction.

### Resetting Mocks

- `Mock::VerifyAndClear(&mock_obj)` verifies and clears both expectations and default actions.

### Allowing Mock Leaks

Use `Mock::AllowLeak(&mock_obj)` if you intentionally want to leak a mock and skip verification.

---

## Best Practices and Common Pitfalls

- **Set expectations before exercising code**; setting expectations after usage leads to undefined behavior.
- **Avoid overly strict expectations**; be as general as possible to reduce test brittleness.
- Use `NiceMock<T>` and `StrictMock<T>` for controlling uninteresting call warnings and errors.
- **Use `.RetiresOnSaturation()`** in sequences or consecutive expectations to avoid upper-bound violations.
- Use the `--gmock_verbose=info` flag to gain detailed insight into expectation matching during test failures.

---

## Example User Flow

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::AtLeast;
using ::testing::InSequence;

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(bool, Process, (int), (override));
};

void TestFunctionWithMock() {
  MockFoo mock_foo;

  ON_CALL(mock_foo, GetSize()).WillByDefault(Return(10));

  {
    InSequence seq;
    EXPECT_CALL(mock_foo, Process(5)).Times(AtLeast(1)).WillRepeatedly(Return(true));
    EXPECT_CALL(mock_foo, Process(10)).Times(1).WillOnce(Return(false)).RetiresOnSaturation();
  }

  CodeUnderTest(&mock_foo);

  Mock::VerifyAndClearExpectations(&mock_foo);  // Optional explicit verification
}
```

---

## Troubleshooting

### Unexpected Calls

If a mock method is called but no matching `EXPECT_CALL` matches, gMock reports an error.

- Use the `--gmock_verbose=info` flag to trace which expectations are set and which calls are made.
- Add a general expectation with `.Times(AnyNumber())` to allow calls that you are not interested in.

### Over-saturated Calls

If a method call exceeds the maximum specified in `Times()`, gMock immediately fails the test.

- Use `.RetiresOnSaturation()` if you want expectations to automatically retire once fulfilled to avoid this.

### Uninteresting Calls and Their Warnings

Calls to mock methods without `EXPECT_CALL` are uninteresting calls. They trigger warnings by default.

- Use `NiceMock` wrapper to suppress uninteresting call warnings when appropriate.

---

## See Also

- [Mocking Reference](reference/mocking.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference (in gMock Cookbook)](docs/gmock_cook_book.md#using-actions)
- [Nice, Naggy, and Strict Mocks](guides/core-scenarios/working-with-mocks.md)

---

## Additional Resources

- GoogleMock source code for expectations and actions: `googlemock/include/gmock/gmock-spec-builders.h`, `googlemock/src/gmock-spec-builders.cc`
- Tests illustrating cardinalities: `googlemock/test/gmock-cardinalities_test.cc`

---