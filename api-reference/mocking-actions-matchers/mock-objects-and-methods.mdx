---
title: "Mock Objects and Methods"
description: "Details the API for defining mock classes and methods using GoogleMock, including the MOCK_METHOD macros and best practices for replacing real dependencies. Walks through how to mock out interfaces, add strictness, and leverage inheritance for flexible test doubles."
---

# Mock Objects and Methods

This documentation details the API for defining mock classes and methods using GoogleMock, focusing on `MOCK_METHOD` macros, strategies for replacing real dependencies, and best practices for flexible test doubles. It covers mocking interfaces, configuring method strictness, and leveraging inheritance.

---

## Defining Mock Methods with `MOCK_METHOD`

To replace real dependencies in your tests, you define mock classes that implement the same interfaces as the real classes. GoogleMock provides the `MOCK_METHOD` macro to generate mocked methods in these classes with ease.

### Syntax

```cpp
MOCK_METHOD(return_type, method_name, (args...), (specs...));
```

- `return_type`: The return type of the mocked method.
- `method_name`: The name of the method to mock.
- `(args...)`: The list of argument types inside parentheses. For methods with multiple or templated arguments containing commas, wrap the whole argument list in extra parentheses or define type aliases to avoid parsing issues.
- `(specs...)` (optional): Qualifiers like `const`, `override`, `noexcept`, `Calltype(...)` (for calling conventions), or `ref(&)` for reference qualifiers.

### Important Usage Notes

- Always put `MOCK_METHOD` declarations in the `public` section of your mock class regardless of the access level of the original method.
- For methods with complex argument types containing commas (e.g., `std::pair<bool, int>`), you must either wrap the return or argument type with parentheses or use a `using` alias to avoid macro parsing errors.

### Example

```cpp
#include <gmock/gmock.h>

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual void GoTo(int x, int y) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

## Setting Expectations with `EXPECT_CALL`

Once you have a mock class, you control its behavior and verify interactions by setting expectations using the `EXPECT_CALL` macro.

### Syntax Overview

```cpp
EXPECT_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)  // Optional, applies to the arguments tuple
    .Times(cardinality)            // Optional, how many times the call is expected
    .InSequence(sequences...)      // Optional, enforce call order
    .After(expectations...)        // Optional, specify prerequisites
    .WillOnce(action)              // Optional, defines behavior for calls
    .WillRepeatedly(action)        // Optional, defines fallback behavior
    .RetiresOnSaturation();        // Optional, retire expectation once saturated
```

- `mock_object`: The instance of your mock class.
- `method_name`: The mocked method name.
- `matchers...`: Argument matchers, which can be values or matcher objects (e.g., `_` for any value).

### Key Modifiers

- **With**: Allows you to apply a matcher over the entire arguments tuple.
- **Times**: Specifies the call count cardinality (e.g., `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`). If omitted, inferred from action clauses.
- **InSequence**: Ensures the calls happen in the specified sequence(s).
- **After**: Declares prerequisite expectations that must be satisfied before this one.
- **WillOnce**: Defines the behavior for a single matching call.
- **WillRepeatedly**: Defines the behavior for all subsequent calls after `WillOnce`s are exhausted.
- **RetiresOnSaturation**: Deactivates the expectation once its call count is reached.

### Example - Simple Expectation

```cpp
using ::testing::AtLeast;
using ::testing::_;
using ::testing::Return;

MockTurtle turtle;

EXPECT_CALL(turtle, PenDown())
    .Times(AtLeast(1));

Painter painter(&turtle);
EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
```

This ensures `PenDown()` is called at least once during the test.

### Tips for Using `EXPECT_CALL`

- Set expectations *before* the mock is exercised to ensure gMock can verify calls correctly.
- Use argument matchers to specify flexible or exact argument expectations. `_` matches any argument.
- `EXPECT_CALL` statements are searched in *reverse order* to match more specific expectations last.
- Use catch-all expectations to allow other calls without failures:

  ```cpp
  EXPECT_CALL(mock, SomeMethod(_)).Times(AnyNumber());
  EXPECT_CALL(mock, SomeMethod(5))  // more specific expectation
      .Times(Exactly(2));
  ```

- Combine `InSequence` with `EXPECT_CALL` to enforce call order.

### Handling Overloaded Methods

When mocking overloaded methods, specify the method signature clearly using `MOCK_METHOD` with the correct parameters and optional `const` qualifiers. To disambiguate overloaded methods in `EXPECT_CALL`, use the `Const()` helper to match const overloads.

## Default Behavior with `ON_CALL`

Use `ON_CALL` to specify default actions for mock methods without setting explicit call count expectations. This keeps tests flexible while defining how the mock behaves when called.

### Syntax

```cpp
ON_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);        // Required
```

Default actions are overridden by matching `EXPECT_CALL`s.

### Example

```cpp
using ::testing::Return;

MockTurtle turtle;
ON_CALL(turtle, GetX())
    .WillByDefault(Return(10));
```

Now, if `GetX()` is called without a specific expectation, it returns 10.

## Managing Mock Object Strictness: Nice, Naggy, and Strict Mocks

GoogleMock provides three ways to control how uninteresting calls (calls without expectations) are treated:

| Mock Type           | Behavior on Uninteresting Calls                   |
| ------------------- | ------------------------------------------------ |
| `NiceMock<T>`       | Silences warnings; calls allowed and ignored       |
| `NaggyMock<T>`      | Prints warnings for uninteresting calls (default behavior) |
| `StrictMock<T>`     | Treats uninteresting calls as test failures       |

### How to Use

Wrap your mock class:

```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockTurtle> nice_turtle;
NaggyMock<MockTurtle> naggy_turtle;
StrictMock<MockTurtle> strict_turtle;
```

They behave like subclasses of your mock class and inherit its constructors.

### When to Use

- Use **NiceMock** to reduce noise when you don't care about uninteresting calls.
- The default mock is **NaggyMock**, which warns to alert you of unexpected calls.
- Use **StrictMock** to enforce strict interface contracts in tests, failing on any unexpected call.

### Important Caveats

- These wrappers only affect mock methods declared directly inside the mock class using `MOCK_METHOD`.
- Nesting these wrappers (e.g., `NiceMock<StrictMock<T>>`) is not supported.
- The mock class should have a virtual destructor for correct behavior.

## Best Practices When Using Mock Classes and Methods

- Define mock classes for interfaces you *own* or control to avoid maintenance overhead.
- When mocking third-party interfaces, prefer creating adaptor interfaces that you own.
- Set expectations early and precisely to catch interaction bugs effectively.
- Use `NiceMock` or `StrictMock` to customize behavior depending on test requirements.
- Wrap expectations in sequences (`InSequence`) for strict call order verification.
- Prefer `ON_CALL` for default behavior and reserve `EXPECT_CALL` for actual verification.
- Test with `--gmock_verbose=info` for detailed call tracing if expectations fail.
- Use `Mock::VerifyAndClearExpectations()` to explicitly verify and clear expectations before mock destruction when required.

## Advanced Mocking Techniques

### Mocking Methods with Move-only Types

GoogleMock fully supports mocking methods that accept or return move-only types such as `std::unique_ptr`. Define these methods as usual using `MOCK_METHOD`. Use lambdas or callable objects for `WillOnce` or `WillRepeatedly` to create new move-only objects on demand.

### Delegating Calls to Fakes or Real Objects

To combine mocks with real or fake implementations:

- Use `ON_CALL(mock, Method()).WillByDefault(...)` to delegate to a fake or real instance.
- This helps ensure realistic behavior while verifying interactions.

### Delegating Calls to Parent Class Implementations

When mocking virtual methods with existing implementations, forward calls inside actions to the base class to reuse behavior:

```cpp
EXPECT_CALL(mock, ConcreteMethod(_))
    .WillByDefault([&mock](Args... args) {
      return mock.BaseClass::ConcreteMethod(args...);
    });
```

### Using Sequences and Partial Orders

- Use the `InSequence` class to enforce strict call ordering within a scope.
- Use `EXPECT_CALL(...).InSequence(seq1, seq2)` to assign expectations to multiple sequences and build partial orderings.
- Use `.After()` clauses to specify fine-grained call dependencies between expectations.

### Retiring Expectations

- Use `.RetiresOnSaturation()` to make an expectation inactive after it has been matched the specified number of times.
- This allows overlapping expectations to handle calls appropriately without exceeding limits.

### Mocking Destructors

You can mock destructor calls indirectly by:

- Adding a mock method like `Die()` to your mock class.
- Calling `Die()` from the destructor.
- Setting expectations on `Die()` to verify destruction timing in tests.

## Troubleshooting and Common Pitfalls

- If uninteresting calls flood warnings, consider switching to `NiceMock` or add catch-all expectations with `.Times(AnyNumber())`.
- Always declare destructors virtual in interfaces to avoid undefined behavior.
- Remember `EXPECT_CALL`s must be set before the calls are made; setting them later causes undefined behavior.
- For overloaded method ambiguity, help compiler with `Const()` wrappers or explicit matchers.
- When dealing with complicated argument types, use type aliases or wrap types in parentheses in `MOCK_METHOD`.
- If default actions run out, explicit `.WillRepeatedly()` is recommended to avoid fallback to default return values.

## Verifying and Resetting Mock Objects

GoogleMock automatically verifies expectations when a mock object is destroyed. You can force verification at any point with:

```cpp
bool success = ::testing::Mock::VerifyAndClearExpectations(&mock_obj);
```

This returns `true` if all expectations were satisfied. After verification, avoid setting new expectations on the same mock instance.

To also clear default actions and expectations, use:

```cpp
bool success = ::testing::Mock::VerifyAndClear(&mock_obj);
```

## Code Example Putting It All Together

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class MyInterface {
public:
  virtual ~MyInterface() {}
  virtual int Compute(int x) const = 0;
};

class MockMyInterface : public MyInterface {
public:
  MOCK_METHOD(int, Compute, (int x), (const, override));
};

TEST(MyTest, ComputesCorrectly) {
  using ::testing::Return;
  using ::testing::_;

  MockMyInterface mock;

  // Provide a default behavior
  ON_CALL(mock, Compute(_)).WillByDefault(Return(42));

  // Expect that Compute(5) is called once and returns 10
  EXPECT_CALL(mock, Compute(5)).WillOnce(Return(10));

  EXPECT_EQ(mock.Compute(5), 10);
  EXPECT_EQ(mock.Compute(9), 42);  // Uses default action
}
```

This test shows how to define a mock, set default and exact expectations, and verify call outcomes.

---

For detailed options on expectations, argument matchers, and actions, consult the related gMock Cookbook and Reference documentation.

---

## References

- [gMock Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md)
- [gMock for Dummies](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md)
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)
- [gMock Cheat Sheet](https://github.com/google/googletest/blob/main/docs/gmock_cheat_sheet.md)

---

## Source Code

See GoogleTest repository for full implementation and tests:

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googlemock/include/gmock/gmock-nice-strict.h", "range": "1-113"},{"path": "googlemock/src/gmock-spec-builders.cc", "range": "1-372"}]} />

