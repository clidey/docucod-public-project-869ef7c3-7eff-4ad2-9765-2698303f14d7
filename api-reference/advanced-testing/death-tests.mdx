---
title: "Death Tests and Exception Handling"
description: "Documents death testing (verifying process termination and assertions on errors), including style choices, macros, and exception-handling support. Outlines best practices for validating error paths and abnormal exits."
---

# Death Tests and Exception Handling

## Overview

Death tests allow you to verify that your code triggers the expected termination behavior — for example, when an assertion fails, an error causes the process to exit, or a fatal signal is raised. This page focuses on how to write, style, and manage death tests within GoogleTest, including macros, style options, and exception handling support.

Death tests are vital for validating error paths and abnormal exits. They give you confidence that your code fails loudly and early on invalid inputs or unexpected conditions, preventing silent corruption or undefined behavior.

---

## Death Tests: Core Concepts and Macros

### What Are Death Tests?

- Death tests are tests that verify your program *dies* (terminates abnormally or exits with a specific error code) on certain statements.
- These tests spawn a child process to execute the lethal statement, isolating the parent test process from termination.
- The child process's stderr output and exit status are checked against user-defined expectations.

### Key Macros

GoogleTest provides several macros for death tests that you can use in your tests:

| Macro                     | Behavior                                                                                                    |
|---------------------------|-------------------------------------------------------------------------------------------------------------|
| `ASSERT_DEATH(statement, matcher)`  | Abort current function if the statement does not cause death matching *matcher*; fatal failure on mismatch. |
| `EXPECT_DEATH(statement, matcher)`  | Similar to ASSERT_DEATH, but continues on failure (nonfatal failure).                                         |
| `ASSERT_EXIT(statement, predicate, matcher)` | Checks that the statement terminates with an exit status satisfying *predicate* and stderr matches *matcher*. |
| `EXPECT_EXIT(statement, predicate, matcher)` | Non-fatal variant of ASSERT_EXIT.                                                                        |
| `EXPECT_DEATH_IF_SUPPORTED(statement, matcher)` | Runs death test only if death tests are supported, otherwise logs a warning but does not fail.                |
| `ASSERT_DEATH_IF_SUPPORTED(statement, matcher)` | Fatal variant of the above.                                                                                  |
| `EXPECT_DEBUG_DEATH(statement, matcher)` | Runs death test only in debug builds; in release, executes statement without death checking.                    |
| `ASSERT_DEBUG_DEATH(statement, matcher)` | Fatal variant of the above.                                                                                  |

### Assertions on Exit Status

- `ASSERT_EXIT` and `EXPECT_EXIT` support passing a predicate on the exit code, such as:
  - `testing::ExitedWithCode(code)` to match normal exit with a specific code.
  - `testing::KilledBySignal(signal_number)` (POSIX only) to match processes terminated by signals.

### Matcher Parameter

- The `matcher` parameter accepts either a GoogleTest matcher for `const std::string&` or a regular expression string.
- Plain strings are treated as regex patterns matching the child's stderr output.
- Regular expressions support a limited subset depending on platform, documented below.

---

## How Death Tests Work Internally

1. GoogleTest forks or clones the current process.
2. The child process executes the test statement that is expected to cause death.
3. After the statement runs, the child process either:
    - Exits or crashes (expected), or
    - Returns or throws an exception (unexpected, treated as failure).
4. The parent waits for the child to finish, capturing exit status and output.
5. The parent checks output against the provided regex and exit code against the predicate.

### Death Test Styles

Two styles control how the child process is spawned and executes the test:

| Style       | Description                                                                                                   |
|-------------|---------------------------------------------------------------------------------------------------------------|
| `fast`      | Child process immediately executes death test code after fork. Faster but less thread-safe.                   |
| `threadsafe`| Child re-execs the test binary with a filter to run only the death test. Safer in multi-threaded contexts but slower. |

- The default style is `fast`, but `threadsafe` is recommended for multithreaded environments.
- On Windows and Fuchsia, death tests always behave like `threadsafe`.
- You can specify style via `--gtest_death_test_style` flag or programmatically.

### Thread Safety Considerations

- Death tests **fork** or clone processes, which is unsafe when multiple threads are running.
- GoogleTest warns if multiple threads exist when running death tests.
- Name test suites containing death tests with `DeathTest` suffix to ensure earlier execution.

### Handling Returns and Exceptions in Death Tests

- If the death test statement executes a `return` instead of dying, the test fails.
- GoogleTest protects you from exceptions escaping the death test by converting them to failures.
- If exceptions are thrown, their messages are captured and reported in failure output.
- You can configure GoogleTest to catch or not catch exceptions via the `catch_exceptions` flag.

---

## Writing Effective Death Tests

### Basic Usage Example

```cpp
TEST(MyDeathTest, CausesAbort) {
  ASSERT_DEATH({
    // Statement expected to cause death
    AbortIfInvalid(-1);
  }, "error.*invalid input");
}

TEST(MyDeathTest, ExitsWithSuccess) {
  EXPECT_EXIT(ExitNow(), testing::ExitedWithCode(0), "Success");
}
```

### Common Patterns

- Use compound statements `{ ... }` for multi-line death test code.
- Stream extra failure info after the macro:

```cpp
EXPECT_DEATH(DoSomethingBad(), "Fatal error") << "Should die on invalid input";
```

- Use loops to test death under multiple conditions:

```cpp
for (int i = 0; i < 5; ++i) {
  EXPECT_DEATH(Process(i), "process.*failed") << "Iteration " << i;
}
```

### Testing Methods, Functions, Lambdas

- Death test statements can be static member functions, instance methods (with flags to control death), or global functions.
- Functions with parameters can be tested by invoking them in the death test statement.

### Using Matchers for Output

- You can pass any matcher convertible to `Matcher<const std::string&>`.
- Regular expression strings allow partial or multiline matches.

### Best Practices for Death Tests

- Death tests run in isolated child processes, so side effects like memory changes won't persist.
- Avoid complex side effects in death test statements.
- Beware that mocks may need to be leaked when used in death test code to avoid false leak detection.
- Use `SCOPED_TRACE` to add context to failures in death tests inside loops or helper functions.

---

## Regular Expression Syntax Supported in Death Tests

- On POSIX systems, POSIX Extended Regex are supported.
- On Windows and Mac, a limited simple regex syntax is supported. Features include:

| Expression | Meaning                                      |
|------------|----------------------------------------------|
| `c`        | Match literal character `c`                   |
| `\d`      | Match any decimal digit                        |
| `\D`      | Match any non-digit character                  |
| `\f`, `\n`, `\r`, `\s`, `\S`, `\t`, `\v` | Match respective whitespace or control characters |
| `\w`      | Match letter, digit or underscore              |
| `\W`      | Match any char not matched by `\w`           |
| `.`        | Match any single character except newline     |
| `A?`       | Match zero or one of `A`                       |
| `A*`       | Match zero or more of `A`                      |
| `A+`       | Match one or more of `A`                       |
| `^`        | Beginning of string                            |
| `$`        | End of string                                  |
| `xy`       | Sequence of x followed by y                    |

- Unsupported syntax includes unions (`x|y`), groupings (`(xy)`), repetition counts (`x{n,m}`), and brackets (`[xy]`).

---

## Exception Handling in Death Tests

GoogleTest supports detecting exceptions thrown inside death tests and reports them as failures instead of allowing them to escape:

- With exceptions enabled (`GTEST_HAS_EXCEPTIONS`), exceptions derived from `std::exception` are caught, and the message is printed in the failure output.
- Non-`std::exception` exceptions are also caught and cause failure.
- Structured exceptions on Windows (SEH) are handled properly.

Example:

```cpp
TEST(CxxExceptionDeathTest, ExceptionIsFailure) {
  EXPECT_NONFATAL_FAILURE(
    EXPECT_DEATH(throw std::runtime_error("fail"), ""),
    "threw an exception");
}
```

You can configure whether GoogleTest catches exceptions or lets them escape via the `catch_exceptions` flag.

---

## Common Issues and Troubleshooting

- Death tests **must not** contain statements that `return` or throw exceptions, as these cause test failure.
- Multiple death test macros on the same line cause compilation errors.
- Threads existing at death test time trigger warnings due to unsafe fork behavior.
- Using mocks inside death tests requires allowing leaks via `Mock::AllowLeak`.
- On systems without death test support, `EXPECT_DEATH_IF_SUPPORTED` macros produce warnings but do not fail.

---

## Example: Simple Death Test

```cpp
#include <gtest/gtest.h>

void DieNow() {
  fprintf(stderr, "fatal error\n");
  _Exit(1);
}

TEST(MyDeathTest, DiesWithMessage) {
  EXPECT_DEATH(DieNow(), "fatal error");
}
```

---

## Detailed Behavior

### Child Process Execution

In `fast` style, the death test child executes the test statement immediately after fork. In `threadsafe` style, the child re-executes the whole test binary but filters to run only the death test.

In either case, if the statement completes without terminating, or if it returns or throws, the death test fails.

### Result Matching

GoogleTest reads the child's stderr output and exit status. It then:

- Verifies the exit status against the predicate (or nonzero for ASSERT_DEATH).
- Verifies the stderr output matches the matcher or regex pattern.

If either check fails, it reports detailed failure messages, including actual vs expected outputs.

---

## Related Flags

- `--gtest_death_test_style`: Choose between `fast` or `threadsafe` death test style.
- `--gtest_internal_run_death_test`: Used internally to pass death test context during re-execution.
- `catch_exceptions`: Enable or disable catching exceptions.

---

## Additional Resources

- See [Assertions Reference](reference/assertions.md#death) for all related macros.
- Consult [Advanced Guide](advanced.md#death-tests) for practical usage patterns and best practices.
- Review example death tests in `googletest` test suite (`googletest-death-test-test.cc`).

---

## Troubleshooting Tips

- **Unexpected non-fatal failure in death test:** Ensure the statement truly terminates the process.
- **Regex does not match output:** Use simpler or appropriately escaped expressions within the supported subset.
- **Thread warnings:** If multiple threads exist, use `threadsafe` death test style.
- **Death test skipped or no death test support:** Check platform and build configuration support.

---

## Summary

Death tests are a critical feature for verifying that your program properly fails under invalid conditions. Use provided macros like `ASSERT_DEATH` and `EXPECT_EXIT` with predicates and matchers to precisely control and verify process termination and error output. The available styles let you balance speed and thread safety, and built-in exception handling ensures that exception escapes are reported as failures.

Remember to carefully design statements to cause process death without returning or throwing unexpectedly, and use appropriate regex matchers for validating error output.

---

## Code Snippet: Death Test for Function Throwing an Exception

```cpp
#if GTEST_HAS_EXCEPTIONS

class TestException : public std::exception {
 public:
  const char* what() const noexcept override { return "exceptional message"; }
};

TEST(CxxExceptionDeathTest, ThrowsExceptionCausesFailure) {
  EXPECT_NONFATAL_FAILURE(
      EXPECT_DEATH(throw TestException(), ""),
      "exceptional message");
}

#endif
```

---

## Notes

- Death tests are necessarily slower because of process spawning.
- They do not preserve changes to in-memory state in the parent process.
- Avoid placing multiple assertions in a single death test statement to maintain clear failure reports.

---

## Learn More

- [GoogleTest Primer](docs/primer.md) – Introduces test basics.
- [Assertions Reference](reference/assertions.md#death) – Details on death test assertions.
- [Advanced Guide](docs/advanced.md#death-tests) – In-depth style and usage recommendations.
- `googletest/test/googletest-death-test-test.cc` – Real death test examples.

---
