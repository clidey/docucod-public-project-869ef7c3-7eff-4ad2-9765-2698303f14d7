---
title: "Using Matchers in Mock Expectations"
description: "Discusses how to use matchers in conjunction with mock expectations, leveraging built-in and custom matchers to fully specify argument constraints and behaviors."
---

# Using Matchers in Mock Expectations

Matchers are at the heart of expressive, flexible mocking in gMock. This page explains how to leverage both built-in and custom matchers to declaratively specify constraints and behaviors on mock method arguments, ensuring your tests accurately capture realistic and complex interaction patterns.

---

## Why Use Matchers in Mock Expectations?

When writing mock expectations, you often want to specify not only *that* a method will be called, but *how* it will be called—precisely what argument values it accepts, rejects, or processes differently. Matchers allow you to express these argument constraints clearly and succinctly.

Without matchers, you must match arguments exactly, which is often brittle and inflexible. Matchers let you specify properties of arguments rather than exact values, leading to more readable, maintainable, and robust tests.

---

## Basic Syntax

Matchers appear inside the `EXPECT_CALL()` or `ON_CALL()` macros as argument matchers that specify how each argument should be matched. If a method has *n* arguments, you provide *n* matchers, each corresponding to an argument. If omitted, `_` is implied, matching anything.

Example:

```cpp
using ::testing::_;
using ::testing::Gt;

EXPECT_CALL(mock_object, DoSomething(Gt(10), _));  // Matches DoSomething called with first argument > 10, second any value.
```

---

## Common Built-in Matchers

The following categories are frequently used when matching mock call arguments:

### Wildcards

- `_` matches any value.
- `A<T>()` or `An<T>()` matches any value of the specified type.

### Generic Comparison

- `Eq(value)` or just `value` (implicitly converted)
- `Ne(value)`, `Gt(value)`, `Ge(value)`, `Lt(value)`, `Le(value)`
- `IsTrue()`, `IsFalse()` for Boolean context checks

### Pointer Matchers

- `IsNull()` matches null pointers (raw or smart).
- `NotNull()` matches non-null pointers.
- `Pointee(matcher)` matches a pointer whose pointee matches `matcher`.
- `Pointer(matcher)` matches the pointer itself.

### String Matchers

- `StartsWith(prefix)`, `EndsWith(suffix)`, `HasSubstr(substring)`
- `StrEq(string)`, `StrCaseEq(string)`, `ContainsRegex(regex)`, etc.

### Container Matchers

- `Contains(elem_or_matcher)` checks presence of an element.
- `Each(matcher)` validates that every element matches.
- `ElementsAre(...)` validates the exact order and matchers.
- `UnorderedElementsAre(...)` validates presence regardless of order.
- `SizeIs(matcher)` checks container size.
- `Pointwise(matcher, container)` compares element-wise with another container.

### Exception Matchers

- `Throws<ExceptionType>()` verifies that a callable throws a specific exception.
- `Throws<ExceptionType>(matcher)` matches exceptions with properties.

More built-in matchers and advanced combinators are documented fully in the [Matchers Reference](reference/matchers.md).

---

## Using Matchers with Mock Expectations

Matchers empower you to write *expectations* that check arguments with expressive constraints. Here are fundamental approaches:

### Exact Value Matching

```cpp
EXPECT_CALL(mock, Foo(5));  // Expects argument equal to 5.
```

### Using Wildcards

```cpp
EXPECT_CALL(mock, Bar(_, _));  // Matches any arguments.
```

### Using Built-in Matchers for Conditions

```cpp
EXPECT_CALL(mock, Process(Gt(0), Le(10)));  // Argument 0 > 0, argument 1 <= 10.
```

### Combining Matchers

Use combinators like `AllOf()`, `AnyOf()`, and `Not()` to build compound conditions:

```cpp
using ::testing::AllOf;
using ::testing::Not;

EXPECT_CALL(mock, Bar(AllOf(Ge(5), Not(Eq(7)))));  // Argument >= 5 and not 7.
```

### Matching Multiple Arguments As a Tuple

Use `.With()` in an expectation to match multiple arguments together with a multi-argument matcher, e.g.,

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // Args tuple should satisfy Lt(), i.e. first < second
```

### Using Matchers with Move-Only Arguments

Matchers work seamlessly with move-only types like `std::unique_ptr`, typically via matchers like `NotNull()` or custom matchers you define.

---

## Custom Matchers

When built-in matchers are insufficient, define your own using `MATCHER` macros or manual matcher classes.

### Quick Custom Matcher with the `MATCHER` Macro

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock, Foo(IsEven()));
```

### Parameterized Matchers

Use `MATCHER_P(name, param_name, description)` to define matchers with parameters:

```cpp
MATCHER_P(IsDivisibleBy, n, "") {
  return (arg % n) == 0;
}

EXPECT_CALL(mock, Foo(IsDivisibleBy(3)));
```

### Enhancing Descriptions and Failure Messages

You can add streaming of extra failure info inside the matcher body:

```cpp
MATCHER_P(IsDivisibleBy, n, "") {
  if ((arg % n) == 0) return true;
  *result_listener << "remainder is " << (arg % n);
  return false;
}
```

This will show both what was expected and why a match failed.

### Writing Matcher Classes for More Control

Implement `MatchAndExplain()`, `DescribeTo()`, and `DescribeNegationTo()` for fine-grained matcher behavior, including polymorphic matchers.

See the detailed examples in the [gMock Cookbook](docs/gmock_cook_book.md#WritingNewMatchersQuickly) and the [Matchers Reference](reference/matchers.md#DefiningMatchers).

---

## Best Practices and Tips

- Use matchers to avoid brittle tests that break on minor value changes.
- Prefer `EXPECT_THAT(value, matcher)` assertions for clearer failure messages.
- Combine matchers for precise but flexible expectations.
- Use `SafeMatcherCast<T>(matcher)` to cast matchers safely when type mismatches occur.
- Use meaningful matcher descriptions to improve debug output.
- Write pure, side-effect-free matchers to avoid unpredictable test behaviors.
- When matching containers, use `ElementsAre*` for order sensitivity, and `UnorderedElementsAre*` for order independence.
- Use `With()` carefully to match multiple arguments combined.

---

## Troubleshooting

- **Issue:** Expectation does not match the argument despite providing a matcher.
  - **Solution:** Ensure the matcher type matches the argument type. Use `SafeMatcherCast` if necessary.

- **Issue:** Tests fail with unclear messages on argument mismatch.
  - **Solution:** Improve matcher description strings or stream additional diagnostic info in custom matchers.

- **Issue:** Using custom matcher inside `.With()` seems complicated.
  - **Solution:** Ensure `.With()` gets a matcher on a tuple of arguments. Use `Args<>` selectors if matching only subsets.

- **Issue:** Move-only types can be tricky with some actions or matchers.
  - **Solution:** Use lambdas or functions returning unique_ptrs in `WillOnce` or `WillRepeatedly`, and use matchers like `NotNull()` to validate arguments.

See also the [Guides on Writing Effective Tests](guides/writing-effective-tests/using-mocks-effectively) and [Troubleshooting and Common Pitfalls](guides/integration-real-world/troubleshooting-common-issues).

---

## Example: Using Matchers in an Expectation

```cpp
#include <gmock/gmock.h>
using ::testing::Eq;
using ::testing::Gt;
using ::testing::_;

class MockCalculator {
 public:
  MOCK_METHOD(int, Add, (int a, int b), ());
};

...

MockCalculator mock_calc;

EXPECT_CALL(mock_calc, Add(Gt(0), Eq(5)))
    .WillOnce(Return(10));

int result = mock_calc.Add(7, 5);  // Matches and returns 10
```


## Example: Custom Matcher with Descriptions

```cpp
MATCHER_P(IsMultipleOf, factor, "") {
  if (arg % factor == 0) return true;
  *result_listener << "whose remainder when divided by " << factor << " is " << (arg % factor);
  return false;
}

...
EXPECT_CALL(mock, Process(IsMultipleOf(3)));
```

On failure, the output will explain how the argument fails the match.

---

For full details on matchers and examples, see the [Matchers Reference](reference/matchers.md) and the [gMock Cookbook](docs/gmock_cook_book.md#UsingMatchers).

---

<Callout type="tip">
Start with simple matchers like `_` and `Eq()` and gradually compose more complex and custom matchers as your verification demands increase.
</Callout>

<Callout type="note">
Using matchers improves test expressiveness and maintainability by clearly stating the intent of argument constraints and allowing flexible verification against dynamic values.
</Callout>

---

## Related Pages

- [Matchers Reference](reference/matchers.md) for detailed matcher list and explanation
- [gMock Cookbook — Writing New Matchers Quickly](docs/gmock_cook_book.md#WritingNewMatchersQuickly) for how to create custom matchers
- [Mocking Reference](reference/mocking.md) for details on mocks, expectations, and mocking syntax
- [Assertions Reference](reference/assertions.md#EXPECT_THAT) for integrating matchers in test assertions
- [Using Matchers in GoogleTest](api-reference/gtest-api-core/using-matchers.mdx) for matcher usage in GoogleTest

---

## Source Reference

<Source url="https://github.com/google/googletest" paths={[{"path": "googlemock/include/gmock/gmock-matchers.h", "range": "1-1019"}]} branch="main" />

---