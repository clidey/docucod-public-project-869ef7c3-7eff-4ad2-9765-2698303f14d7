---
title: "Advanced Actions"
description: "Comprehensive documentation for built-in and custom actions, illustrating how to control mock responses more granularly. Covers primary and advanced cases, including variadic and templated actions."
---

# Advanced Actions

Comprehensive documentation for built-in and custom actions, illustrating how to control mock responses more granularly. This page covers the primary built-in actions, advanced use cases including variadic and templated actions, and guidance on creating custom actions to tailor mock behaviors with precision.

---

## Overview

An **action** in GoogleMock is what a mock method performs when it is invoked during a test. Actions can:

- Return values (including references, pointers, or live values)
- Modify output or input arguments
- Invoke functions, functors, lambdas
- Throw exceptions

You use actions to define a mock's behavior in response to method calls, either through `EXPECT_CALL` or `ON_CALL` statements.

GoogleMock offers a comprehensive set of built-in actions to cover common scenarios, and also allows you to create fully custom, parameterized, and templated actions when these are insufficient.

---

## Built-in Actions

### Returning Values

| Action | Description |
| ------ | ----------- |
| `Return()` | Return from a `void` mock function. Simply returns if the mock is void.
| `Return(value)` | Returns `value` converted to the mock function's return type. Note the conversion happens when expectation is set (not when called).
| `ReturnArg<N>()` | Returns the `N`th argument passed to the mocked method.
| `ReturnNew<T>(a1, ..., ak)` | Returns `new T(a1, ..., ak)` - a new object on each invocation.
| `ReturnNull()` | Returns a null pointer.
| `ReturnPointee(ptr)` | Returns the value pointed to by `ptr` at call time (not set time).
| `ReturnRef(variable)` | Returns a reference to `variable`.
| `ReturnRefOfCopy(value)` | Returns a reference to a copy of `value`; the copy's lifetime matches the action's.
| `ReturnRoundRobin({a1, ..., ak})` | Returns values from the list in order, cycling back to the start after the last element.

### Side Effects on Arguments

| Action | Description |
| ------ | ----------- |
| `Assign(&variable, value)` | Assigns `value` to `variable`.
| `DeleteArg<N>()` | Deletes the pointer passed as the `N`th argument.
| `SaveArg<N>(pointer)` | Saves the `N`th argument by copy to `*pointer`.
| `SaveArgByMove<N>(pointer)` | Saves the `N`th argument by move to `*pointer`.
| `SaveArgPointee<N>(pointer)` | Saves the value pointed to by the `N`th argument to `*pointer`.
| `SetArgReferee<N>(value)` | Sets the object referenced by the `N`th argument to `value`.
| `SetArgPointee<N>(value)` | Sets the object pointed to by the `N`th argument to `value`.
| `SetArrayArgument<N>(first, last)` | Copies elements from the range `[first, last)` into the argument pointer or iterator at the `N`th position.
| `SetErrnoAndReturn(error, value)` | Sets errno to `error` and returns `value`.
| `Throw(exception)` | Throws the given exception object (must be copyable).

### Using Functions, Functors, or Lambdas as Actions

| Action | Description |
| ------ | ----------- |
| `f` | Invokes callable `f` with the same arguments as passed to the mock function.
| `Invoke(f)` | Invokes a function or functor `f` with the mock function's arguments.
| `Invoke(object_pointer, &class::method)` | Invokes a method on `object_pointer` with mock function's arguments.
| `InvokeWithoutArgs(f)` | Invokes `f` which must take no arguments.
| `InvokeWithoutArgs(object_pointer, &class::method)` | Invokes a zero-argument method on `object_pointer`.
| `InvokeArgument<N>(arg1, arg2, ..., argk)` | Invokes the `N`th argument of the mock function, which must be callable, with the provided arguments.

**Note:** To pass arguments by reference to `InvokeArgument`, wrap them with `std::ref()`.

### Combining Actions

| Action | Description |
| ------ | ----------- |
| `DoAll(a1, a2, ..., an)` | Performs a sequence of actions `a1` through `an` each time the mock method is called; returns the result of the last action. The first `n-1` actions must return `void`.
| `IgnoreResult(a)` | Performs action `a` but ignores its result, useful when `a` returns a value but the mock method is `void` or chained.
| `WithArg<N>(a)` | Passes only the `N`th argument of the mock function to action `a`.
| `WithArgs<N1, N2, ..., Nk>(a)` | Passes selected arguments to action `a`.
| `WithoutArgs(a)` | Calls action `a` without any arguments.

---

## Defining New Actions

When the built-in actions don't fit your needs, you can define your own custom actions in several ways:

### Using the ACTION Macros

GoogleMock provides convenient macros to define new actions quickly:

- `ACTION(name)` - defines a simple action without parameters.
- `ACTION_P(name, param)` - defines a parameterized action with one parameter.
- `ACTION_Pk(name, p1, ..., pk)` - supports multiple parameters.
- `ACTION_TEMPLATE(name, template_params, value_params)` - defines templated action classes for advanced scenarios.

**Example:**

```cpp
ACTION(IncrementArg1) { ++(*arg1); }
```

This action increments the second argument of the mock function (index 1).

### Using Callable Objects

You can use any callable objects (functions, lambdas, functors) with compatible signatures as actions directly:

```cpp
EXPECT_CALL(mock, Foo())
    .WillOnce([](int x) { return x + 5; });
```

### Implementing ActionInterface

For the most control, implement the `::testing::ActionInterface<F>` template where `F` is the mocked function signature. It provides a `Perform` method that executes the action.

```cpp
class MyAction : public ::testing::ActionInterface<MyMockedFunction> {
 public:
  Result Perform(const ArgumentTuple& args) override {
    // Your implementation here
  }
};
```

### Creating Polymorphic Actions

Use `MakePolymorphicAction()` with an implementation class having a templated `Perform` method to make an action usable with different mock function signatures.

---

## Best Practices & Tips

- **Use `ON_CALL` for default behavior**, and `EXPECT_CALL` for setting verifiable expectations.
- **Actions are evaluated once** at setup, not per call - use lambdas for dynamic behavior.
- **Combine multiple side effects** with `DoAll()`, but ensure only the final action returns a non-void value.
- **Use `RetiresOnSaturation()`** to retire expectations when they saturate and prevent sticking.
- **Beware of copy vs move semantics** when mocking methods using move-only types.
- **Suppress uninteresting call warnings** with `NiceMock` or explicit expectations with `.Times(AnyNumber())`.

---

## Troubleshooting

### Compilation Errors with Complex Types
Unprotected commas in template types may cause parsing errors in `MOCK_METHOD`. Use type aliases or parenthesize the entire type in parentheses.

### Runtime Errors with Return Actions
Returning a moved-from value multiple times causes runtime errors. Prefer lambdas that create new objects for each call.

### Multiple Actions vs Cardinality Mismatch
If too many or too few actions are specified compared to `Times()`, GoogleMock issues warnings or errors. Align `WillOnce` or `WillRepeatedly` correspondingly.

### Deleting Mock Objects in Actions
To delete a mock from within an action, use the `Delete(ptr)` action macro.

---

## Advanced Examples

### Returning Move-only Types

```cpp
class MockBuzzer : public Buzzer {
 public:
  MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
};

EXPECT_CALL(mock_buzzer_, MakeBuzz("hello"))
    .WillOnce(Return(std::make_unique<Buzz>(AccessLevel::kInternal)));
```

### Delegating to a Fake for Default Behavior

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(char, DoThis, (int n), (override));
  MOCK_METHOD(void, DoThat, (const char* s, int* p), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault(
        [this](int n) { return fake_.DoThis(n); });
    ON_CALL(*this, DoThat).WillByDefault(
        [this](const char* s, int* p) { fake_.DoThat(s, p); });
  }

 private:
  FakeFoo fake_;
};
```

### Complex Composite Action

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

---

## Related Documentation

- [gMock Cookbook](gmock_cook_book.md) for practical recipes
- [Actions Reference](reference/actions.md) for built-in actions
- [Mocking Reference](reference/mocking.md#EXPECT_CALL) for expectations syntax
- [Matchers Reference](reference/matchers.md) for argument matching
- [gMock for Dummies](gmock_for_dummies.md) for an introduction

---

Explore further in the Mocking and Test APIs section for integrating advanced mocking patterns into your testing workflow.

---