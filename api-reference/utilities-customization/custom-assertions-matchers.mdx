---
title: "Custom Assertions and Matchers"
description: "Guides users through the process of implementing custom assertions and matchers for use in both GoogleTest and GoogleMock. Covers the relevant base classes, required interfaces, and extension best practices."
---

# Custom Assertions and Matchers

This guide walks you through implementing custom assertions and matchers for use in both GoogleTest and GoogleMock. It highlights the key base classes and macros for defining matchers, details the required interfaces, and presents best practices for extending the framework effectively.

---

## Understanding the Role of Custom Assertions and Matchers

GoogleTest and GoogleMock provide a wide array of built-in assertion macros and matchers that cover many common testing scenarios. However, there are times when your testing needs surpass what the standard library offers:

- You want to assert complex conditions with rich, meaningful error messages.
- Your code uses domain-specific types and semantics requiring specialized validation.
- You desire more expressive and readable tests that reflect your application's logic clearly.

Custom assertions and matchers empower you to encapsulate such domain logic, enabling reusable, clear, and maintainable test code.

---

## Basics of Writing Custom Matchers

GoogleMock's matcher API enables writing **matchers**—predicates that check whether a value meets particular conditions—and integrates them into assertions like `EXPECT_THAT()` and mock expectations like `EXPECT_CALL()`.

### Using the `MATCHER` Macros

For most use cases, defining a matcher is clean and easy with the `MATCHER` family of macros.

#### 1. Simple Parameterless Matcher

Use `MATCHER(name, description)`, where:

- `name` is the matcher identifier,
- `description` is a string literal documenting the matcher for failure messages,
- inside the macro, the variable `arg` corresponds to the value being matched.

Example:

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

// Usage examples:
EXPECT_THAT(value, IsEven());
EXPECT_CALL(mock, Method(IsEven()));
```

If the matcher fails, GoogleMock will print informative output, automatically using the matcher name to generate the failure description if the `description` is empty.

#### 2. Parameterized Matcher

When your matcher needs parameters, use `MATCHER_P` or `MATCHER_Pn` (up to 10 parameters).

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}

// Usage:
EXPECT_THAT(my_value, HasAbsoluteValue(10));
```

The parameters are available inside the macro, and you can also customize the description string with references to `value` and the special variable `negation`.

### Tips for Writing Matchers

- **Pure Functionality**: Matchers must not have side effects or depend on external variables that can change.
- **Provide Descriptions**: Use the description string and optionally the `result_listener` to add detailed failure info.
- **Use `MatchAndExplain`**: Instead of a plain boolean return, you can stream explanations to help diagnose mismatches.

---

## Implementing Matcher Classes Directly

For advanced scenarios or for improved type checking and compilation messages, implement a matcher class manually.

### Required Interface

A matcher class must:

1. Define type alias `using is_gtest_matcher = void;` to mark it as a matcher.
2. Implement `bool MatchAndExplain(const T& value, std::ostream* listener) const` or a similar overload.
3. Implement `void DescribeTo(std::ostream* os) const` to describe the matcher at a high level.
4. Optionally implement `void DescribeNegationTo(std::ostream* os) const`.

Example:

```cpp
class BarPlusBazEqMatcher {
 public:
  using is_gtest_matcher = void;

  explicit BarPlusBazEqMatcher(int expected_sum) : expected_sum_(expected_sum) {}

  bool MatchAndExplain(const Foo& foo, std::ostream* /* listener */) const {
    return (foo.bar() + foo.baz()) == expected_sum_;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "bar() + baz() equals " << expected_sum_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "bar() + baz() does not equal " << expected_sum_;
  }

 private:
  const int expected_sum_;
};

::testing::Matcher<const Foo&> BarPlusBazEq(int expected_sum) {
  return BarPlusBazEqMatcher(expected_sum);
}
```

---

## Extending gMock with Custom Matchers

GoogleMock matchers are designed to integrate with mock expectations effortlessly. You can use your custom matchers anywhere GoogleMock expects a matcher, including `EXPECT_CALL` and `ON_CALL` clauses.

### Example: Custom Matcher with Additional Explanation

```cpp
MATCHER(IsDivisibleBy7, "") {
  if ((arg % 7) == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}

EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

The matcher will print richer diagnostic messages, showing the remainder when the match fails.

---

## Practical Best Practices

- **Use `ON_CALL` by default**: Reserve `EXPECT_CALL` for when you want to verify that a mock method is *actually called*. `ON_CALL` defines behavior without strict verification.
- **Avoid Over-specification**: Only match and verify the arguments you care about to keep tests robust.
- **Use compound matchers**: Combine matchers with `AllOf()`, `AnyOf()`, `Not()`, and related combinators to write expressive logic.
- **Test your matchers**: Use `EXPECT_THAT()` in unit tests of your matcher to validate the correctness and the descriptive output.
- **Custom failure messages**: Always add explanations when matchers fail to assist in debugging.

---

## Integrating Custom Assertions

Though GoogleTest's assertion macros like `EXPECT_TRUE()`, `EXPECT_EQ()` cover most needs, custom assertions let you express domain-specific validations with clear feedback.

Consider writing predicate assertions returning `Testing::AssertionResult` to get finely-controlled success/failure messages:

```cpp
testing::AssertionResult IsEven(int n) {
  if (n % 2 == 0)
    return testing::AssertionSuccess() << n << " is even";
  else
    return testing::AssertionFailure() << n << " is odd";
}

EXPECT_TRUE(IsEven(value));
```

---

## Debugging and Troubleshooting Custom Matchers

- Ensure **matcher purity**; do not make matchers with side effects.
- Be cautious with **lifetime** of objects referenced in matchers.
- For matchers taking pointers, **check for nullptr** to prevent crashes.
- When using parameterized matchers, ensure the **description string references all parameters** for meaningful errors.
- Use `EXPECT_THAT()` with your matcher independently in tests to verify behavior before integrating with mocks.

---

## Summary

Custom assertions and matchers allow you to extend GoogleTest and GoogleMock with domain-aware validations and expressive test constructs. Using the provided macro-based or class-based interfaces, you can build powerful, reusable predicates that improve your test code quality and diagnostic capabilities.

---

## Additional Resources

- [GoogleMock CookBook: NewMatchers](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers)
- [Matchers Reference](../reference/matchers.md) — In-depth guide on built-in matchers and usage
- [EXPECT_THAT Assertion](../reference/assertions.md#EXPECT_THAT) — How to use matchers in assertions
- [Mocking Patterns](../guides/core-testing-workflows/working-with-mocks.md) — Using matchers with mocks
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [GoogleMock README](https://github.com/google/googletest/blob/main/googlemock/README.md)

---

_For implementation, always refer to the GoogleMock source and test files, such as `gmock-matchers.h` and `gmock_matchers_test.h`._
