---
title: "Portability and Environment Support"
description: "Documents internal APIs for cross-platform compatibility, such as feature detection macros, synchronization primitives, and platform abstraction utilities. Intended for contributors, advanced users, and integrators who need to ensure correct framework operation across setups."
---

# Portability and Environment Support

This page details the internal APIs and utilities designed to maintain **cross-platform compatibility** within GoogleTest. It documents essential macros, feature detection mechanisms, synchronization primitives, and platform abstraction tools that enable GoogleTest to operate consistently across diverse OSes and environments.

Intended primarily for contributors, advanced users, and integrators, this documentation explains how GoogleTest detects environment properties and adapts to them internally, ensuring that users can understand and troubleshoot portability concerns.

---

## 1. Environment Detection Macros

GoogleTest dynamically detects platform capabilities using a suite of macros that describe the environment. These macros are always defined to either `1` (true) or `0` (false) after inclusion of the portability headers. They guide conditional compilation and feature availability without manual intervention in most cases.

### Key User-Configurable Macros

You may override the automatic detection by defining these macros explicitly in your build scripts if GoogleTest's heuristics do not match your environment:

| Macro                     | Meaning                                                   |
|---------------------------|-----------------------------------------------------------|
| `GTEST_HAS_CLONE`         | Whether Linux-style `clone(2)` syscall is available      |
| `GTEST_HAS_EXCEPTIONS`    | Whether C++ exceptions are enabled                        |
| `GTEST_HAS_POSIX_RE`      | Whether POSIX Extended Regular Expressions are supported |
| `GTEST_HAS_PTHREAD`       | Whether POSIX threads (`<pthread.h>`) are available       |
| `GTEST_HAS_RTTI`          | Whether Run-Time Type Identification is enabled          |
| `GTEST_HAS_STD_WSTRING`   | Whether `std::wstring` is supported                       |
| `GTEST_HAS_FILE_SYSTEM`   | Whether the platform supports a file system               |
| `GTEST_HAS_SEH`           | Whether Microsoft's Structured Exception Handling is supported|
| `GTEST_HAS_STREAM_REDIRECTION` | Whether I/O stream redirection via `dup()`/`dup2()` is supported |
| `GTEST_LINKED_AS_SHARED_LIBRARY` | Whether linking GoogleTest as shared library (DLL)      |
| `GTEST_CREATE_SHARED_LIBRARY` | Whether GoogleTest itself is built as a shared library    |
| `GTEST_DEFAULT_DEATH_TEST_STYLE` | Default style for death tests (`fast` or `threadsafe`)    |

---

## 2. Platform Identification Macros

GoogleTest automatically defines macros corresponding to the detected platform. These are for internal use but help conditionally compile platform-specific implementations.

Macro definitions are always either `1` (defined) on their platform or not defined at all.

Supported platform macros include but are not limited to:

- `GTEST_OS_WINDOWS`, `GTEST_OS_WINDOWS_DESKTOP`, `GTEST_OS_WINDOWS_MINGW`, `GTEST_OS_WINDOWS_MOBILE`, `GTEST_OS_WINDOWS_PHONE`, `GTEST_OS_WINDOWS_RT`
- `GTEST_OS_LINUX`, `GTEST_OS_LINUX_ANDROID`
- `GTEST_OS_MAC`, `GTEST_OS_IOS`
- `GTEST_OS_CYGWIN`
- `GTEST_OS_FREEBSD`, `GTEST_OS_NETBSD`, `GTEST_OS_OPENBSD`, `GTEST_OS_DRAGONFLY`
- `GTEST_OS_SOLARIS`, `GTEST_OS_AIX`, `GTEST_OS_ZOS`, `GTEST_OS_QNX`, `GTEST_OS_FUCHSIA`
- Embedded targets like `GTEST_OS_ESP32`, `GTEST_OS_XTENSA`, `GTEST_OS_QURT`

> **Note:** Code outside the GoogleTest framework *must not* define these macros.

---

## 3. Feature Detection and Selection

GoogleTest selects among different implementations of features based on these macros:

- **Regular Expressions:** Chooses between RE2, POSIX extended regex, or a built-in simple regex implementation.
  - If compiled with Abseil, RE2 (`GTEST_USES_RE2`) is mandatory.
  - If POSIX regex is present, uses POSIX (`GTEST_USES_POSIX_RE`).
  - Otherwise, falls back to a custom simple regex engine (`GTEST_USES_SIMPLE_RE`).

- **Thread Safety:** Enabled when mutexes & thread-local storage are supported.
  - `GTEST_IS_THREADSAFE` set to `1` if POSIX threads or Windows threading primitives are available.
  - Mutex and thread-local types are implemented accordingly.

- **Stream Redirection:** Support for capturing stdout/stderr via dup/dup2 is conditional on platform/file-system capabilities.

- **Exception Support:** Enables usage of C++ exceptions based on compiler definitions.

- **Run-Time Type Identification (RTTI):** Detected or user-overridden to enable RTTI-related features.

- **Wide String Support:** Whether `std::wstring` works correctly on the platform.

---

## 4. Synchronization Primitives

GoogleTest provides cross-platform synchronization types and utilities critical to thread-safety and multi-threaded test execution.

### 4.1 Mutex and MutexLock

- **Mutex:** Encapsulates platform-specific mutexes (`CRITICAL_SECTION` on Windows, `pthread_mutex_t` on POSIX).
- **MutexLock:** RAII-style scoped lock that locks on construction and unlocks on destruction.

> Both static and dynamic mutexes are supported, with macros available for static mutex declaration.

### 4.2 Thread Local Storage

- Template class `ThreadLocal<T>` provides thread-local storage support:
  - Uses Windows TLS APIs or `pthread_key_t` depending on platform.
  - Supports default value construction and value initialization.
  - Thread-local data is cleaned up when the thread exits.

### 4.3 Thread Helpers

- `ThreadWithParam<T>` allows launching and managing threads running user-supplied functions with parameters, supporting synchronization with a controller thread via `Notification` object.

- `Notification` provides simple thread notification primitives internally.

---

## 5. Portability Utilities

Some utilities encapsulate platform-specific details to provide uniform behavior:

- **File and Directory Operations:**
  - `FileNo(FILE*)`: Returns file descriptor, handles differences on Windows and other platforms.
  - `Stat()`, `RmDir()`, `IsDir()`: For file system info and directory removal, wrappers over native APIs.

- **Character Utilities:**
  - Functions like `IsAlpha()`, `IsDigit()`, `IsSpace()`, work consistently across platforms, always casting input to `unsigned char` for safety.
  - Specialized digit and whitespace checks are tailored for ASCII compatibility.

- **Environment Variables:**
  - `GetEnv(const char*)` abstracts the availability of environment variables; stub returns nullptr on embedded platforms.

- **String Case-Insensitive Comparison:**
  - `StrCaseCmp()` wraps platform-specific implementations.

- **Exit and Abort:**
  - `posix::Abort()` calls platform-specific abort behavior; on Windows Mobile, it's custom implemented.

---

## 6. Regular Expression Wrapper

GoogleTest exposes an internal class `RE` for regular expressions that adapts to the platform configuration:

- When using Abseil and RE2, `RE` uses `RE2` internally.
- When `GTEST_HAS_POSIX_RE` is true, `RE` wraps POSIX regex functions.
- Otherwise, `RE` provides a basic regex parser supporting a subset of commonly used patterns.

This allows portable tests to use regex-based features like death tests seamlessly.

---

## 7. Logging and Assertion Support

Internal logging macros and classes facilitate uniform severity-based logging:

- `GTEST_LOG_(severity)` - logs messages at `[INFO]`, `[WARNING]`, `[ERROR]`, or `[FATAL]` levels.
- Fatal logs abort the program execution immediately.

Additionally, the `GTEST_CHECK_` macro performs an all-mode assertion that aborts on failure with detailed error messages.

---

## 8. Thread Counting

To support advanced features like death tests and thread safety verification, GoogleTest provides a platform-specific `GetThreadCount()` utility that returns the number of currently active threads in the process.

Implementations query OS APIs like `/proc` on Linux, `task_threads` on Mac, `sysctl` on BSDs, or other platform-specific process inspection mechanisms.

If unavailable, `GetThreadCount()` returns 0.

---

## 9. Stream Capture Support

GoogleTest can capture `stdout` and `stderr` for tests that check output correctness or support death tests.

- Capturing is implemented by redirecting output streams to temporary files.
- APIs:
  - `CaptureStdout()` / `CaptureStderr()` - begin capturing
  - `GetCapturedStdout()` / `GetCapturedStderr()` - stop capturing and retrieve contents

On platforms without file system support or certain embedded targets, stream redirection is disabled.

---

## 10. Environment Variable Utilities for Flags

GoogleTest reads test configuration flags from environment variables if not set explicitly.

- Internally maps flag names (e.g., `foo`) to environment variable names (`GTEST_FOO`).
- Supports parsing Boolean, integer, and string flag values gracefully with validation and fallback defaults.

These utilities empower flexible test configuration in CI and cross-platform environments.

---

## Practical Tips and Best Practices

- When integrating GoogleTest in custom or exotic environments, be prepared to manually define or override environment macros handling threading or exceptions.

- Use the macros documented here for conditional compilation instead of your own platform checks.

- For thread-safe tests, ensure `GTEST_IS_THREADSAFE` is checked or set accordingly.

- For capturing output or using death tests, verify that `GTEST_HAS_STREAM_REDIRECTION` and `GTEST_HAS_DEATH_TEST` are enabled.

- Don't use internal macros or classes directly if you are writing normal tests; they serve the framework backend.

- To extend GoogleTest for a new platform, understand and adapt these porting utilities to your environment.

---

## Code Snippet: Checking Wide String Support

```cpp
#if GTEST_HAS_STD_WSTRING
  // Use wide string test code features
#else
  // Provide alternative implementations
#endif
```

---

## Troubleshooting Common Issues

- **Build failures related to missing threading support:** Define `-DGTEST_HAS_PTHREAD=1` or `-DGTEST_HAS_PTHREAD=0` as needed.

- **Link errors when using shared libraries on Windows:** Use `-DGTEST_CREATE_SHARED_LIBRARY=1` when building GoogleTest and `-DGTEST_LINKED_AS_SHARED_LIBRARY=1` when compiling tests.

- **Regex failures on some platforms:** Verify which regex implementation is selected (`GTEST_USES_RE2`, `GTEST_USES_POSIX_RE`, or `GTEST_USES_SIMPLE_RE`) and adapt your regex accordingly.

- **Incorrect environment detection:** Override macros in build scripts as needed.

- **Stream capturing fails or is unsupported:** Confirm `GTEST_HAS_STREAM_REDIRECTION` is enabled on your platform.

---

## References and Further Reading

- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [Requirements and Supported Platforms](https://google.github.io/googletest/getting-started/prerequisites-installation/requirements-supported-platforms)
- [GoogleTest API Reference: Initialization and Main](https://google.github.io/googletest/api/reference/infrastructure-support/initialization-and-main.html)
- [Customization Points](https://google.github.io/googletest/customization.html)
- Source header: [`gtest/internal/gtest-port.h`](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-port.h)

---

This documentation section empowers contributors and integrators to understand and work with the foundational portability layer of GoogleTest, maintaining robust behavior across environments from desktops to embedded systems.