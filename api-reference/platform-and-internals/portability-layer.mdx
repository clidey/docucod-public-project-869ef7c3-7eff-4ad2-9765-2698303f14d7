---
title: "Portability Layer"
description: "Documents the platform abstraction, feature detection, low-level macros, and configuration touchpoints that ensure GoogleTest and GoogleMock work across various operating systems and compilers."
---

# Portability Layer

The Portability Layer is the foundational abstraction within GoogleTest and GoogleMock that ensures seamless operation across a broad spectrum of operating systems and compilers. This layer manages environment detection, feature availability, low-level macros, and configuration points that adapt the framework to platform-specific nuances without sacrificing the simplicity and reliability users expect.

---

## Overview

At its core, the Portability Layer provides a uniform interface hiding the complexities of platform differences such as threading support, exception handling, regular expression availability, logging mechanisms, and environment capabilities. By exploiting compile-time feature detection and allowing user customization, this layer guarantees that GoogleTest and GoogleMock function reliably whether you build on Linux, Windows, macOS, or more specialized environments.

This documentation explains how the Portability Layer:

* Detects system and compiler features.
* Provides configurable macros for customization.
* Abstracts low-level threading and synchronization primitives.
* Manages logging and error handling infrastructure.

## Key Components

### Feature Detection and Environment Macros

GoogleTest internally defines a comprehensive set of macros indicating platform and compiler capabilities. These macros are deterministically set as 1 (enabled) or 0 (disabled), letting the framework tailor itself to your environment.

Notable macros include:

- **Platform Identification** (defined automatically):
  - `GTEST_OS_LINUX`, `GTEST_OS_WINDOWS`, `GTEST_OS_MAC`, etc.

- **Feature Availability**:
  - `GTEST_HAS_PTHREAD` — Indicates the presence of POSIX threads.
  - `GTEST_HAS_EXCEPTIONS` — Whether C++ exceptions are enabled.
  - `GTEST_HAS_DEATH_TEST` — Whether death tests are supported on the platform.
  - `GTEST_HAS_RTTI` — Whether Runtime Type Information is enabled.
  - `GTEST_HAS_STD_WSTRING` — Availability of wide string support.
  - `GTEST_HAS_FILE_SYSTEM` — File system accessibility.

Users can override some macros when detection is imperfect or for specialized needs by defining them in user-customization headers.

### Synchronization and Threading Primitives

The portability layer provides abstractions for cross-platform synchronization:

- `Mutex` and `MutexLock` classes encapsulate mutex features compatible with Windows critical sections or pthread mutexes.
- `ThreadLocal<T>` provides thread-local variables implementation for platforms that support it.
- `Notification` for simple thread coordination.

The availability of these primitives depends on the detected threading support via `GTEST_IS_THREADSAFE`.

### Logging and Error Checking

Low-level logging macros and error checking are centralized for consistency:

- `GTEST_LOG_(severity)` macro streams a message with the given severity.
- `GTEST_CHECK_(condition)` asserts conditions with immediate abort on failure.
- Functions like `LogToStderr()` and `FlushInfoLog()` control logging output.

These can be customized or overridden via user macros for integrating with custom logging backends.

### Platform-specific Utilities

Functions and macros for platform abstraction of operations such as:

- File handling: `FileNo()`, `Stat()`, `RmDir()`, `IsDir()`
- Standard I/O handling and redirection
- Environment variable access
- Character utilities with safe casting to unsigned

These utilities ensure consistent behavior on Windows, POSIX, and embedded platforms.

### Customization Points

GoogleTest offers designated injection points allowing advanced users to tweak platform integration and replace components:

- Within `gtest/internal/custom/gtest-port.h`, users may define macros such as:
  - `GTEST_OS_STACK_TRACE_GETTER_` to specify a custom stack trace getter implementation.
  - `GTEST_CUSTOM_TEMPDIR_FUNCTION_` to override the `TempDir()` function.
  - `GTEST_LOG_` and `GTEST_CHECK_` for custom logging and assertion mechanisms.
  - Threading macros like `GTEST_HAS_NOTIFICATION_`, `GTEST_HAS_MUTEX_AND_THREAD_LOCAL_` to indicate presence of threading components.
  - `GTEST_API_` to adjust symbol exporting/importing.

These enable tailoring the framework for special environments or integration with custom infrastructure.

---

## Using the Portability Layer Effectively

### Checking Feature Support

Before relying on platform-dependent functionality like death tests or multi-threaded tests, consult these macros:

```cpp
#if GTEST_HAS_DEATH_TEST
  // Death test code here
#endif

#if GTEST_IS_THREADSAFE
  // Thread-safe test code here
#else
  // Single-threaded fallback or alternative
#endif
```

This ensures your tests adapt gracefully to the compiling environment.

### Overriding Defaults

If GoogleTest's automatic detection does not suit your scenario (e.g., cross-compilation, embedded systems), override configuration macros by creating a `gtest/internal/custom/gtest-port.h` file in your include path. For example:

```cpp
#define GTEST_HAS_PTHREAD 0  // Disable pthread support explicitly
#define GTEST_LOG_(severity) CustomLogFunction(severity)
```

The build system or compiler flags should incorporate these customizations.

### Thread-Safe Programming

If your platform is thread-safe (`GTEST_IS_THREADSAFE == 1`), you can confidently write multi-threaded tests. Use the synchronized primitives (`Mutex`, `MutexLock`, `ThreadLocal`) defined in this layer to coordinate test threads and avoid race conditions.

### API Symbols Exporting

To build and link GoogleTest as a shared library, macros like `GTEST_CREATE_SHARED_LIBRARY` and `GTEST_API_` control symbol visibility. Adjust these in your build to match platform conventions (e.g., `__declspec(dllexport)` on Windows).

---

## Build System Integration

The Portability Layer works transparently with your build system, detecting and configuring compiler flags accordingly.

### CMake

CMake scripts define flags like `-DGTEST_HAS_PTHREAD=1` automatically when pthread is available and handle compiler-specific adjustments to optimize portability.

### Bazel

Bazel configurations in `BUILD.bazel` incorporate these flags and platform constraint settings to ensure portability across supported operating systems.

---

## Troubleshooting

- **Compilation Errors Related to Feature Macros:** Verify your platform’s support for the relevant features and consider overriding macros via `gtest/internal/custom/gtest-port.h`.

- **Threading Issues:** Confirm `GTEST_IS_THREADSAFE` is enabled. Add `-DGTEST_HAS_PTHREAD=1` if necessary and link against pthread.

- **Symbol Export Issues:** When building shared libraries, ensure `GTEST_API_` is properly defined for your platform.

- **Macro Name Conflicts:** If GoogleTest macros clash with other libraries, use `-DGTEST_DONT_DEFINE_<MACRO_NAME>=1` to avoid conflicts and prepend `GTEST_` manually.

---

## Example: Checking if Death Tests are Supported

Use the portability macros to conditionally compile tests:

```cpp
#include <gtest/gtest.h>

TEST(MyDeathTest, DeathTestSupported) {
#if GTEST_HAS_DEATH_TEST
  EXPECT_DEATH({ exit(1); }, "");
#else
  GTEST_SKIP() << "Death tests not supported on this platform.";
#endif
}
```

---

## Related Customization in GoogleMock

GoogleMock extends the portability layer with additional macros for managing flags (`GMOCK_DEFINE_bool_`, `GMOCK_DECLARE_int32_`, etc.) and depends heavily on the GoogleTest portability utilities to maintain consistent behavior across platforms.

For details, see `googlemock/include/gmock/internal/gmock-port.h` and `googlemock/internal/custom/gmock-port.h`.

---

## Summary

The Portability Layer is the backbone that allows GoogleTest and GoogleMock to operate reliably across platforms by detecting environment features, abstracting low-level system differences, and offering customization touchpoints. Understanding this layer empowers you to adapt the testing framework to specialized environments, ensure compatibility, and troubleshoot platform-specific issues effectively.

---

## References

- Full portability macro definitions and customizations: [gtest-port.h](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-port.h)
- Platform detection logic: [gtest-port-arch.h](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-port-arch.h)
- Customization points: [custom/gtest-port.h README](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/custom/README.md)
- GoogleMock portability extension: [gmock-port.h](https://github.com/google/googletest/blob/main/googlemock/include/gmock/internal/gmock-port.h)
- Supported platforms overview: [/overview/features-integration/supported-platforms](https://github.com/google/googletest/blob/main/docs/platforms.md)
- Build system integration details: [/guides/integration-and-patterns/build-system-integration](https://github.com/google/googletest/blob/main/docs/guides/integration-and-patterns/build-system-integration.mdx)

---

## Next Steps

- Explore the [Test Output and Configuration API Reference](/api-reference/core-testing-apis/test-output-and-configuration) to learn how portability affects test execution.
- Review the [Getting Started Setup Overview](/getting-started/setup-overview/installation) to set up GoogleTest with your platform correctly.
- Consult [Supported Platforms](/overview/features-integration/supported-platforms) for details on compatibility.

---