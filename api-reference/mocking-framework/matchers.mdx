---
title: "Matchers"
description: "Complete guide to matcher APIs for argument constraints and pattern matching in mock expectations and assertions. Explains built-in matchers, matcher composition, and custom matcher creation, with code snippets for effective test readability."
---

# Matchers

A comprehensive guide to GoogleMock's matcher APIs, designed to help you apply argument constraints and pattern matching effectively in your mock expectations and assertions. This documentation covers the gamut from using built-in matchers, composing complex matchers, to creating custom matchers, all with practical code snippets for improved test readability.

---

## Overview

Matchers define the rules for validating values passed as arguments to mock functions or verified in assertions. They provide expressive and flexible ways to specify what arguments your mocks expect or what values your tests verify.

Matchers can be used in:

- `EXPECT_CALL(mock_object, method(matchers...))` to set expectations on mock methods
- `ON_CALL(mock_object, method(matchers...))` to specify default mock behavior
- Assertions like `EXPECT_THAT(actual_value, matcher)` to verify values

This guide helps you understand and utilize:

- Built-in matchers for common types and conditions
- Composite matchers to combine simple matchers logically
- Multi-argument and tuple matchers
- Member and pointer matchers
- Custom matcher creation using macros and classes

---

## Built-in Matchers

GoogleMock includes a rich set of matchers out of the box. These matchers cover generic comparisons, string patterns, containers, pointers, optionals, and more.

### Wildcard Matchers

- `_`: Matches any value of the expected type.
- `A<type>()` or `An<type>()`: Matches any value of a specific type.

Example:
```cpp
EXPECT_CALL(mock, Func(_));  // Matches any argument.
EXPECT_CALL(mock, Func(A<int>()));  // Matches any int.
```

### Generic Comparison Matchers

| Matcher        | Description                       |
|----------------|---------------------------------|
| `Eq(value)` or just `value` | Matches exact equality (`==`). |
| `Ne(value)`    | Matches inequality (`!=`).       |
| `Lt(value)`    | Matches less than (`<`).         |
| `Le(value)`    | Matches less than or equal (`<=`). |
| `Gt(value)`    | Matches greater than (`>`).      |
| `Ge(value)`    | Matches greater than or equal (`>=`). |
| `IsTrue()`     | Matches if value converts to true. |
| `IsFalse()`    | Matches if value converts to false. |
| `IsNull()`     | Matches any null pointer (raw or smart). |
| `NotNull()`    | Matches any non-null pointer.    |
| `Optional(m)`  | Matches engaged optional whose value matches `m`. |
| `VariantWith<T>(m)` | Matches variant holding alternative of type T matching `m`. |
| `Ref(var)`     | Matches an argument that is a reference to `var`. |
| `TypedEq<type>(value)` | Matches equality but only for type exactly `type`. Useful for overloaded methods. |

Example:
```cpp
EXPECT_CALL(mock, DoSomething(Eq(5)));
EXPECT_CALL(mock, DoSomething(NotNull()));
EXPECT_CALL(mock, DoSomething(Optional(Ge(10))));
```

### Floating Point Matchers

Specialized matchers handle approximate equality and NaN checks for floating-point values, using ULP-based comparisons for reliability.

| Matcher                   | Description                          |
| ------------------------- | ---------------------------------- |
| `DoubleEq(a_double)`      | Approximate equality for double, NaNs not equal. |
| `FloatEq(a_float)`        | Approximate equality for float, NaNs not equal. |
| `NanSensitiveDoubleEq(a_double)` | Approximate equality with NaNs equal. |
| `NanSensitiveFloatEq(a_float)` | Approximate equality with NaNs equal. |
| `IsNan()`                 | Matches any floating-point NaN value. |
| `DoubleNear(val, max_abs_error)` | Approximate with given absolute error, NaNs unequal. |
| `FloatNear(val, max_abs_error)` | Same for float. |
| `NanSensitiveDoubleNear(val, max_abs_error)` | Approximate with absolute error, NaNs equal. |
| `NanSensitiveFloatNear(val, max_abs_error)` | Same for float. |

Example:
```cpp
EXPECT_THAT(value, DoubleNear(3.14, 0.01));
EXPECT_THAT(value, IsNan());
```

### String Matchers

Matchers for strings (both narrow and wide) support equality, case-insensitive comparison, substring, prefix, and suffix checks, plus regex matching and base64-decoding support.

| Matcher               | Description                          |
|-----------------------|------------------------------------|
| `StrEq(str)`          | Exact string equality (case sensitive). |
| `StrNe(str)`          | String inequality.                  |
| `StrCaseEq(str)`      | Case-insensitive equality.         |
| `StrCaseNe(str)`      | Case-insensitive inequality.       |
| `HasSubstr(substring)`| Contains substring.                 |
| `StartsWith(prefix)`  | Starts with prefix string.         |
| `EndsWith(suffix)`    | Ends with suffix string.           |
| `MatchesRegex(regex)` | Matches entire regex pattern.      |
| `ContainsRegex(regex)`| Contains regex substring.          |
| `WhenBase64Unescaped(m)` | Matches base64-encoded string after unescaping. |

Example:
```cpp
EXPECT_THAT(s, StartsWith("Hello"));
EXPECT_THAT(s, MatchesRegex("^[0-9]+$"));
```

### Container Matchers

Matchers for inspecting STL-style containers, with powerful element-wise and size checks.

| Matcher                  | Description                                          |
|--------------------------|------------------------------------------------------|
| `IsEmpty()`              | Means container is empty.                            |
| `SizeIs(matcher)`        | Container size matches matcher.                      |
| `BeginEndDistanceIs(matcher)` | Matches container whose begin/end iterator distance matches matcher. |
| `ContainerEq(container)` | Equivalence with enhanced failure messages.         |
| `Contains(element_matcher)` | Container has at least one element matching matcher.|
| `Contains(element_matcher).Times(count_matcher)` | Number of matches satisfies the count matcher.       |
| `Each(element_matcher)`  | All elements match.                                  |
| `ElementsAre(m0, m1, ..., mn)` | Container has elements matching matchers in order.  |
| `ElementsAreArray(seq)`  | Same as `ElementsAre()` but takes sequence container or array. |
| `UnorderedElementsAre(m0, ..., mn)` | Matches container with elements matching matchers in any order. |
| `UnorderedElementsAreArray(seq)` | Variant of `UnorderedElementsAre` for container or array. |
| `IsSubsetOf(seq)`        | Container matches some subset of matchers.          |
| `IsSupersetOf(seq)`      | Container has a superset of matches.                 |
| `Pointwise(pair_matcher, container)` | Matches element pairs in order with pair matcher.   |
| `UnorderedPointwise(pair_matcher, container)` | Like `Pointwise` but ignores order.                  |
| `WhenSorted(matcher)`    | Matches container sorted with `<` operator.          |
| `WhenSortedBy(comparator, matcher)` | Matches container sorted by comparator.               |

Example:
```cpp
EXPECT_THAT(vec, Contains(Ge(5)));
EXPECT_THAT(vec, ElementsAre(1, Gt(2), _));
EXPECT_THAT(map, UnorderedElementsAre(Pair("a", 1), Pair("b", 2)));
```

### Member Matchers

Matchers that target members or properties of objects.

| Matcher                  | Description                                           |
|--------------------------|------------------------------------------------------|
| `Field(&Class::field, m)` | Matches objects whose field matches `m`.              |
| `Field(field_name, &Class::field, m)` | Same as above, with field name for better error messages. |
| `Property(&Class::property, m)` | Matches objects whose property (getter method) matches `m`. The method must be `const`. |
| `Property(property_name, &Class::property, m)` | Same with property name.                              |
| `Key(m)`                 | Matches std::pair whose `.first` matches `m`.         |
| `Pair(m1, m2)`           | Matches std::pair whose `.first` matches `m1` and `.second` matches `m2`. |

Example:
```cpp
EXPECT_THAT(obj, Field(&MyClass::foo, Ge(10)));
EXPECT_THAT(map, Contains(Key(Eq(5))));
```

### Pointer Matchers

Matchers for pointer arguments and references.

| Matcher                 | Description                                           |
|-------------------------|------------------------------------------------------|
| `Pointee(m)`            | Pointer or smart pointer points to value that matches `m`. Null pointers never match. |
| `Pointer(m)`            | Pointer or smart pointer matches `m` (raw pointer match). |
| `Address(m)`            | The address of the argument matches `m`.             |
| `WhenDynamicCastTo<T>(m)` | Matches after dynamic_cast to `T`. Provides customized matching of the casted value; returns false immediately if cast fails for references. Requires RTTI. |

Example:
```cpp
EXPECT_CALL(mock, Func(Pointee(Eq(42))));
EXPECT_THAT(ptr, Pointer(NotNull()));
EXPECT_THAT(obj, Address(Eq(&expected)));
EXPECT_THAT(base_ptr, WhenDynamicCastTo<Derived*>(NotNull()));
```

### Multi-Argument Matchers

Match tuples of values, handy in `.With()` clauses and for matching multiple arguments collectively.

| Matcher           | Description                                  |
|-------------------|----------------------------------------------|
| `Eq()`            | Matches pair with equal elements.
| `Ne()`            | Matches pair with unequal elements.
| `Lt()`, `Le()`, `Gt()`, `Ge()` | Matches pair respects comparison.
| `AllArgs(m)`      | Matches entire argument list with `m`.
| `Args<N1, ..., Nk>(m)` | Matches a tuple of selected argument indices against matcher `m`.

Example:
```cpp
EXPECT_CALL(mock, Func(_, _)).With(Lt());  // First argument < second
EXPECT_CALL(mock, Func(_, _, _)).With(Args<0, 2>(Eq()));  // arguments #0 and #2 match
```

---

## Using Matchers Effectively

### Matcher Composition

Combine matchers with logical operations for richer constraints:

- `AllOf(m1, m2, ...)`: All matchers must satisfy.
- `AnyOf(m1, m2, ...)`: Any matcher satisfies.
- `Not(m)`: Negates matcher.
- `Conditional(cond, m1, m2)`: Chooses matcher based on condition.

Example:
```cpp
EXPECT_CALL(mock, Func(AllOf(Gt(5), Ne(10))));
EXPECT_THAT(value, Not(StartsWith("Foo")));
```

### Casting Matchers

`SafeMatcherCast<T>(m)` safely casts matcher `m` to `Matcher<T>` ensuring type safety and preventing lossy casts.

Example:
```cpp
Matcher<Base*> base_matcher = ...;
EXPECT_CALL(mock, Func(SafeMatcherCast<Derived*>(base_matcher)));
```

### Creating Custom Matchers

Custom matchers let you define your own argument constraints when built-ins aren't enough. The `MATCHER*` macros provide a simple syntax:

- `MATCHER(name, "description") { ... }`
- `MATCHER_P(name, param, "description") { ... }`

Inside the matcher body, the value being matched is `arg` and description can use the `negation` flag to customize failure messages.

Example:
```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}
EXPECT_CALL(mock, Func(IsEven()));
```

For more complex control or reusability, implement matcher classes conforming to the MatcherInterface.

### Writing Matchers With Parameterized Descriptions

Include custom dynamic descriptions based on parameters and negation state:

```cpp
MATCHER_P2(InClosedRange, low, hi,
          std::string(negation ? "isn't" : "is") + " in range [" +
          PrintToString(low) + ", " + PrintToString(hi) + "]") {
  return low <= arg && arg <= hi;
}
```

### Additional Tips

- Use `EXPLAIN_MATCH_RESULT()` to explain matcher failures with context.
- Matchers must be side-effect-free and purely functional.
- You can match references to variables using `Ref(variable)`.
- Use `Truly(predicate)` to wrap arbitrary predicate functions as matchers.

---

## Example Usage

```cpp
#include <gmock/gmock.h>
using ::testing::Eq;
using ::testing::Not;
using ::testing::Gt;
using ::testing::StartsWith;
using ::testing::Pointee;
using ::testing::Field;
using ::testing::ElementsAre;

class MyMock {
 public:
  MOCK_METHOD(void, Process, (int value, const std::string& text), ());
  MOCK_METHOD(void, Handle, (const std::unique_ptr<int>& ptr), ());
};

MATCHER(IsOdd, "is odd") {
  return (arg % 2) == 1;
}

MyMock mock;

// Simple matcher usage
EXPECT_CALL(mock, Process(Gt(0), StartsWith("test")));

// Complex composed matcher
EXPECT_CALL(mock, Process(AllOf(Gt(10), Not(Eq(42))), _));

// Matching pointer values
EXPECT_CALL(mock, Handle(Pointee(Eq(5))));

// Using custom matcher
EXPECT_CALL(mock, Process(IsOdd(), _));

// Matching fields of complex types
struct Data { int id; std::string name; };
Data d = {5, "data"};
EXPECT_THAT(d, Field(&Data::id, Eq(5)));

// Matching containers
std::vector<int> vec = {1, 2, 3};
EXPECT_THAT(vec, ElementsAre(1, 2, 3));
```

---

## Troubleshooting Common Issues

- **Type mismatches in matchers:** Use `SafeMatcherCast` to cast to correct matcher types.
- **Matcher side-effects:** Ensure matchers are pure and without observable side-effects.
- **Passing wrong argument types:** Match parameter types exactly or use parameterized matchers.
- **Null pointer dereferencing:** Use `Pointee()` safely as it fails on null pointers.
- **Ambiguous matcher usage with overloaded functions:** Use `TypedEq` or static casts to resolve.

---

## See Also

- [Mocking Reference](../mocking.md): Learn about mock classes, EXPECT_CALL, and ON_CALL.
- [Matchers Reference](../matchers.md): Complete list and details of built-in matchers.
- [gMock Cookbook](../../docs/gmock_cook_book.md): Practical recipes for effective mock usage.
- [Assertions Reference](../assertions.md): How to use matchers in assertions like EXPECT_THAT.


<Source url="https://github.com/google/googletest" paths={[{"path": "googlemock/include/gmock/gmock-matchers.h", "range": "1-5000"}]} />
