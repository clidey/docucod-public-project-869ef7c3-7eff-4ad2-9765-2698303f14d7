---
title: "Setting Expectations and Actions"
description: "Details the API for specifying expected calls, argument patterns, cardinalities, sequencing constraints, and return values or behaviors for mock objects. Covers the full range of ON_CALL/EXPECT_CALL macros, and introduces action composition for effective test logic."
---

# Setting Expectations and Actions

GoogleMockâ€™s expectation and action framework lets you specify precisely how mock methods should behave and be verified during tests. This chapter details how to use the `ON_CALL` and `EXPECT_CALL` macros to set default actions and strict expectations respectively, how to define argument matching patterns, control call counts, enforce call ordering, and specify return values or side effects via actions.

---

## Core Concepts

- **Expectations:** Define which mock method calls are expected, how many times, with what arguments, and in what order.
- **Default Actions:** Define the behavior of mock methods when expectations are not explicitly set.
- **Matchers:** Specify patterns to match argument values for mock calls.
- **Cardinalities:** Control how many times a call is allowed or expected.
- **Sequences and Ordering:** Enforce order and dependencies among expected calls.
- **Actions:** Define what a mock method does when called (return values, side effects, callbacks, etc).

---

## Using `ON_CALL` and `EXPECT_CALL`

### `ON_CALL`

Use `ON_CALL` to set **default behavior** of a mock method when it is invoked, without imposing **expectations** on how often it must be called.

**Syntax:**

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)  // optional
    .WillByDefault(action);
```

- `.With()` restricts this default behavior to calls whose entire argument tuple matches the given matcher.
- `.WillByDefault()` sets the action executed for matching calls.

`ON_CALL` is essential for defining fallback default behaviors, reducing the need to specify expectations on every method call.

### `EXPECT_CALL`

Use `EXPECT_CALL` for setting **expectations** on mock method calls: verifying they occur with specified arguments, a certain number of times, in order, and what actions to perform when called.

**Syntax:**

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)        // Optional, exact once
    .Times(cardinality)             // Optional, exact once
    .InSequence(sequence_objects...) // Optional, any number
    .After(expectations...)          // Optional, any number
    .WillOnce(action)               // Optional, any number
    .WillRepeatedly(action)         // Optional, exact once
    .RetiresOnSaturation();         // Optional, exact once
```

- `.With()` restricts the calls that meet the expectation to those matching a multi-argument matcher on the full argument tuple.
- `.Times()` controls call counts with flexible cardinalities.
- `.InSequence()` and `.After()` enforce call order and dependencies.
- `.WillOnce()` and `.WillRepeatedly()` specify what happens when matched calls occur.
- `.RetiresOnSaturation()` causes the expectation to become inactive after its call count is met.

---

## Writing Expectations

### Matchers: Fine-Grained Argument Matching

When setting expectations, specify matchers for each argument to describe valid call criteria.

```cpp
using ::testing::_;  // Matches anything
using ::testing::Ge; // Matches >= some value

EXPECT_CALL(mock, Foo(Ge(10), _)); // Argument 0 >= 10, arg1 any
```

If you want to ignore arguments entirely, omit them in `EXPECT_CALL` for non-overloaded methods, or use `_` to wildcard matching.

### Multi-Argument Matchers with `.With()`

Use `.With()` to evaluate all arguments as a whole tuple:

```cpp
using ::testing::Lt;
EXPECT_CALL(mock, SetRange(_, _)).With(Lt());
// Matches calls where first arg < second arg
```

### Cardinalities: How Many Calls?

Control call frequency with `Times()`:

| Cardinality       | Meaning                                       |
|-------------------|-----------------------------------------------|
| `AnyNumber()`     | Unlimited calls                               |
| `AtLeast(n)`      | At least `n` calls                            |
| `AtMost(n)`       | At most `n` calls                             |
| `Between(m, n)`   | Between `m` and `n` calls inclusive          |
| `Exactly(n)` or `n` | Exactly `n` calls (0 means never call)       |

`Times()` can be omitted:

- No `WillOnce` or `WillRepeatedly`: `Times(1)` inferred
- `n` `WillOnce` but no `WillRepeatedly`: `Times(n)` inferred
- `n` `WillOnce` and one `WillRepeatedly`: `Times(AtLeast(n))`

### Call Ordering

By default, calls can occur in any order. Use these tools to enforce order:

- **`InSequence`**: Within scope, expectations must match calls in the order declared.

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
```

- **`Sequence` and `.InSequence(...)`**:
Create named sequences for partial ordering. Expectations in the same sequence must call in order.

- **`.After(...)`**: Specify that an expectation must be matched only after one or more other expectations have been satisfied.

### Retiring Expectations

`.RetiresOnSaturation()` marks an expectation as inactive after its call count reaches the specified limit, allowing other expectations to match further calls.


---

## Specifying Actions

Determine what happens when a mock method matching an expectation or default call occurs.

### Built-in Actions

| Action                | Description                                                           |
|----------------------|-----------------------------------------------------------------------|
| `Return(value)`      | Return a copy of `value` (evaluated once at expectation set).         |
| `ReturnRef(variable)`| Return a reference to the supplied variable.                         |
| `ReturnPointee(ptr)` | Return the value pointed by `ptr` at time of call.
| `DoDefault()`        | Perform the default action defined by `ON_CALL` or built-in behavior. |
| `Invoke(...)`        | Calls a function/functor/lambda with mock args.                      |
| `InvokeWithoutArgs(...)`| Calls a function/functor with no args.
| `InvokeArgument<N>(...)`| Invokes the N-th argument if callable.                              |
| `SetArgPointee<N>(value)` | Sets the pointed-to value of argument N to `value`.                |
| `SetArrayArgument<N>(first, last)` | Copies a range into the argument N array.

### Combining Actions

- `DoAll(a1, a2, ..., an)`: Performs all `a1` to `an` actions sequentially and returns the result of `an`. Useful for side effects plus return value.
- `IgnoreResult(a)`: Ignores the return value of action `a`.
- `WithArg<N>(a)`: Performs action `a` with only argument N.
- `WithArgs<N1, ..., Nk>(a)`: Performs action `a` with selected arguments.
- `WithoutArgs(a)`: Performs `a` with no arguments.

### Defining Custom Actions

Actions can be:

- Lambdas
- Functors with `operator()`
- `ACTION` or `ACTION_P*` macros (legacy)
- Classes implementing `ActionInterface`

Example lambda:

```cpp
EXPECT_CALL(mock, Func(_))
    .WillOnce([](int x) { return x * 2; });
```

### Returning Move-Only Types

Support for move-only arguments and return types (e.g., `std::unique_ptr`) is built-in. Use lambdas in `WillOnce` / `WillRepeatedly` to return fresh move-only objects.

Example:

```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
      return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

### Delegating Calls

You can delegate mock method actions to:

- A **Fake** object for default behavior.
- A **Real** object to replicate production behavior.
- The **Parent class method** to call the original implementation from a mock.

This ensures consistency and code reuse.

Example of delegating to a fake:

```cpp
void DelegateToFake() {
  ON_CALL(*this, Method()).WillByDefault([this](Args...) {
    return fake_.Method(...);
  });
}
```

---

## Best Practices

- Always put mocked methods declared with `MOCK_METHOD` inside the `public:` section of your mock class.
- Use `ON_CALL()` for defining generic default behaviors shared across tests.
- Use `EXPECT_CALL()` for specifying and verifying actual expected calls.
- Favor `NiceMock` over naggy mocks to suppress warnings about uninteresting calls.
- Use `.RetiresOnSaturation()` to prevent expectations from lingering after reaching call limits.
- Use matchers to precisely specify interesting arguments and avoid over-specifying tests.
- Use sequences or `.After()` for call ordering constraints only when needed, to keep tests simpler.
- When mocking overloaded methods, define expectations for all relevant overloads or use `using Base::Method` to avoid hiding them.
- For mocking non-virtual methods, use template-based mocking with unrelated classes and dependency injection.

---

## Troubleshooting

- **Warnings about uninteresting calls?**
  Use `NiceMock<T>` or add general `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());` to silence.

- **Unexpected call errors?**
  Check that all expected calls are correctly specified and that no calls are made outside expectations.

- **`MOCK_METHOD` parsing errors with commas?**
  Wrap types containing commas (e.g., template types) in extra parentheses or typedef using aliases.

- **Overloaded method confusion?**
  Make sure to specify all relevant overloads, or explicitly bring base methods into scope.

- **Mock does not verify expectations?**
  Ensure mock objects are destroyed at test end, or explicitly call `Mock::VerifyAndClearExpectations(&mock);`.

- **Compilation slowness?**
  Move mock class constructors and destructors out of headers to `.cc` files.

---

## Example Summary

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(void, Process, (const std::string& s), (override));
};

// Setting expectations and default behaviors.
MockFoo mock;

// Default: Add returns 0.
ON_CALL(mock, Add(_)).WillByDefault(Return(0));

// Expect Add(42) called once, will return 100.
EXPECT_CALL(mock, Add(42))
     .Times(1)
     .WillOnce(Return(100));

// Expect Process called any number of times, no action needed.
EXPECT_CALL(mock, Process(_)).Times(AnyNumber());

// Use in test code
EXPECT_EQ(mock.Add(42), 100);
EXPECT_EQ(mock.Add(1), 0); // Uses default action
```

---

## Additional Resources

- [gMock Cookbook](gmock_cook_book.md): Comprehensive recipes including advanced usage.
- [gMock for Dummies](gmock_for_dummies.md): Beginner-friendly tutorial.
- [Matchers Reference](matchers.md): Detailed list of argument matchers.
- [Actions Reference](actions.md): Built-in actions and how to implement your own.
- [Mocking Reference](mocking.md): API specifications and usage patterns.
- [Core Concepts Overview](overview/architecture-concepts/key-terminology.md).

---

For ease of reference, the macros:

```cpp
ON_CALL(obj, method).With().WillByDefault();
EXPECT_CALL(obj, method).With().Times().InSequence().After().WillOnce().WillRepeatedly().RetiresOnSaturation();
```

are implemented behind the scenes via the GoogleMock Spec Builder framework allowing powerful compile-time and runtime verification with descriptive error reporting.

----

## Mermaid Diagram: Mock Expectation Call Flow

```mermaid
sequenceDiagram
    participant Test as Test Code
    participant Mock as Mock Object
    participant Spec as Spec Builder

    Test->>Mock: Call mock method with args
    Mock->>Spec: Find matching expectation
    alt Expectation matched
        Spec->>Mock: Return expected action
        Mock->>Test: Perform action & return
    else No expectation
        Spec->>Mock: Find ON_CALL default action
        alt Default action found
            Mock->>Test: Perform default action & return
        else No action
            Mock->>Test: Return default value or error
        end
    end

    Note over Test,Mock,Spec: Expectation verification happens at mock destruction
```
