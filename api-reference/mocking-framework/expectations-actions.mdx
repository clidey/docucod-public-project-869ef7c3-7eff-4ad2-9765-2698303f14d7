---
title: "Setting Expectations & Actions"
description: "Explores the core APIs for setting call expectations, specifying invocation counts, and providing actions (return values, side effects, exceptions) for mock methods. Illustrates ON_CALL(), EXPECT_CALL(), and flexible action composition."
---

# Setting Expectations & Actions

This documentation explores the core GoogleMock APIs for specifying how mock methods behave, the expected calls on them, and the actions they perform when invoked. Understanding these APIs lets you finely control your mock objects to verify interactions precisely and simulate real behavior effectively.

---

## Overview

When writing tests with mock objects, you use GoogleMock’s macros and functions to:

- Set **default behaviors** of mock methods when called (`ON_CALL`).
- Establish **expectations** that certain method calls *must* happen (`EXPECT_CALL`).
- Specify **how often** methods are expected to be called.
- Define **the actions** (return values, side effects, exceptions, etc.) mock methods take when invoked.

This guide walks through `ON_CALL()`, `EXPECT_CALL()`, the rich qualifiers and clauses you can use with them, and how to compose actions for flexible, expressive test specifications.

---

## Using ON_CALL: Setting Default Behavior

`ON_CALL(mock_object, method_name(matchers))` lets you define **default behavior** for a mock method when called with matching arguments, without asserting that the call must happen.

```cpp
ON_CALL(my_mock, DoSomething(_))
    .WillByDefault(Return(true));
```

- **Purpose:** Specify what the mock method does if called.
- **Matchers:** Argument matchers narrow the scope of this behavior.
- **Chaining:** Use `.With()` once to restrict arguments considered as a tuple.
- **Required Clause:** Must end with `.WillByDefault(action)`, specifying the behavior.

### ON_CALL Clauses

| Clause        | Description                                                                   |
| ------------- | ----------------------------------------------------------------------------- |
| `.With(m)`    | Restricts call to those whose *all* arguments (as a tuple) match `m`.         |
| `.WillByDefault(action)` | Specifies the behavior (action) for matching calls.                         |

### Important Notes

- Multiple `ON_CALL` statements are applied in order; **the last matching one takes precedence**.
- `ON_CALL` does **not** set expectations on call counts or enforce calls—it just specifies behavior.

---

## Using EXPECT_CALL: Setting Expectations

`EXPECT_CALL(mock_object, method_name(matchers))` creates an **expectation** that a mock method will be called with matching arguments.

```cpp
EXPECT_CALL(my_mock, Compute(Ge(0)))
    .Times(AtLeast(1))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

- **Purpose:** Verify that the mock method is called as expected.
- **Matchers:** Specify which arguments are expected.
- **Chaining modifiers:** Customize call count, order, and behavior.

### Chaining Clauses and Their Order

| Clause                 | Purpose | Constraints |
|------------------------|---------|-------------|
| `.With(multi_arg_matcher)` | Restricts matches to calls whose argument tuple matches `m` (can be used once and must be first)
| `.Times(cardinality)`        | Sets the expected call count (use once max)
| `.InSequence(sequences...)` | Specifies sequences this call participates in (can be used multiple times)
| `.After(expectations...)`   | Specifies calls that must precede this one (can be used multiple times)
| `.WillOnce(action)`         | Specifies one-time behaviors (can be used multiple times, each action used once)
| `.WillRepeatedly(action)`   | Specifies behavior after all `WillOnce`s are exhausted (use once max)
| `.RetiresOnSaturation()`    | Indicates expectation becomes inactive after reaching its upper call limit (use once and last)

### Call Cardinalities

GoogleMock provides cardinalities to specify how many times calls are expected:

| Cardinality         | Description                                  |
|---------------------|----------------------------------------------|
| `Exactly(n)` or `n` | Expect exactly *n* calls (0 means never called).
| `AtLeast(n)`        | Expect at least *n* calls.
| `AtMost(n)`         | Expect at most *n* calls.
| `Between(m, n)`     | Expect calls between *m* and *n*, inclusive.
| `AnyNumber()`       | Zero or more calls allowed.

If `.Times()` is omitted, the cardinality is **inferred** from the presence of `.WillOnce()` and `.WillRepeatedly()` clauses:

- No `WillOnce` or `WillRepeatedly`: inferred as `Times(1)`
- *n* `WillOnce`s and no `WillRepeatedly`: inferred as `Times(n)`
- *n* `WillOnce`s and one `WillRepeatedly`: inferred as `Times(AtLeast(n))`

### Ordering Expectations

gMock matches expectations in **reverse definition order**, so later expectations override earlier ones. For call ordering enforcement:

- Use `InSequence` objects to define sequences where calls must occur in declaration order.
- Use `.After()` to build custom partial orders.

Example of sequence usage:

```cpp
Sequence seq1, seq2;
EXPECT_CALL(my_mock, Foo()).InSequence(seq1);
EXPECT_CALL(my_mock, Bar()).InSequence(seq1, seq2);
EXPECT_CALL(my_mock, Baz()).InSequence(seq2);
```

This establishes partial ordering of expectations.

### Retiring Expectations

Normally, expectations remain active even after being satisfied, causing errors on excess calls matching the same expectation. To avoid this, use `.RetiresOnSaturation()` to retire an expectation after its upper bound is reached, allowing other expectations to match later calls.

## Actions: Controlling What Mock Methods Do

An **action** defines what a mock method does when called, including returning values, throwing exceptions, or side effects. Use actions with `ON_CALL` and `EXPECT_CALL` with `.WillOnce()`, `.WillRepeatedly()`, or `.WillByDefault()`.

### Common Built-in Actions

| Action                          | Description                                         |
|--------------------------------|-----------------------------------------------------|
| `Return(value)`                | Returns a fixed value (copied at expectation creation). |
| `ReturnRef(variable)`          | Returns a reference to a variable (live value changes).  |
| `ReturnPointee(ptr)`           | Returns the value pointed to by `ptr` at call time.     |
| `ReturnNew<T>(args...)`        | Returns a new `T` instance allocated on heap every call. |
| `DeleteArg<N>()`               | Deletes the N-th argument, which must be a pointer.      |
| `SetArgPointee<N>(value)`      | Sets the pointed-to value of the N-th argument.          |
| `DoAll(action1, action2, ...)` | Executes several actions in sequence; return value of last. |
| `Invoke(f)`                   | Calls function/functor/lambda with the mock call's args. |
| `InvokeWithoutArgs(f)`        | Calls a zero-arg function/functor when mock method invoked. |
| `InvokeArgument<N>(args...)`  | Calls the N-th function argument with provided args.     |
| `Throw(exception)`            | Throws the given exception on call.                      |
| `DoDefault()`                 | Performs the default action (specified by `ON_CALL` or built-in). |
| `IgnoreResult(action)`        | Ignores the return value of the action, useful for void returns. |

### Example: Combining Actions

```cpp
EXPECT_CALL(foo, Bar(_))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

Here, the mock method will set the second argument to 5 and return `true`.

### Using Functors or Lambdas as Actions

You can specify any callable compatible with the mock method signature:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x*x; });
```

Lambdas or functors can capture context and perform complex behavior.

---

## Best Practices

- Use `ON_CALL` to define default behaviors shared by many tests.
- Use `EXPECT_CALL` when you want to verify calls are made as expected.
- Avoid overly restrictive argument matchers—use `_` for 'don't care' arguments.
- Use sequences and `.After()` to express call ordering only when necessary.
- Use `.RetiresOnSaturation()` to avoid stale expectations causing failures.
- For move-only types, `MOCK_METHOD` supports them naturally; return values with lambdas.
- Use `NiceMock` to suppress warnings for uninteresting calls, `StrictMock` to make them errors.

---

## Common Pitfalls & Troubleshooting

- **Expectations must be set *before* mock methods are called.** Setting expectations after calls leads to undefined behavior.
- **Overlapping expectations:** The last matching `EXPECT_CALL` takes precedence. Order matters.
- **Forgotten `.Times(0)` expectation:** To assert a method is never called, write `EXPECT_CALL(foo, Bar(_)).Times(0);`
- **Uninteresting call warnings:** Use `NiceMock` or add catch-all expectations with `.Times(AnyNumber())`.
- **Too few or too many actions:** Warnings appear if your `.WillOnce()` clauses don’t align with `.Times()`.
- **Mock leaks:** If mock objects are not deleted, expectations are never validated. Use `Mock::AllowLeak(mock)` to suppress errors when intentional.

---

## Quick Start Example

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;
using ::testing::AtLeast;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), (const));
  MOCK_METHOD(void, DoWork, (int x));
};

TEST(FooTest, Example) {
  MockFoo mock;

  // Set default behavior:
  ON_CALL(mock, GetValue()).WillByDefault(Return(5));

  // Expect GetValue() to be called at least once, returning 5 each time:
  EXPECT_CALL(mock, GetValue()).Times(AtLeast(1));

  // Expect DoWork to be called with argument 10 exactly once.
  EXPECT_CALL(mock, DoWork(10)).Times(1);

  // Exercise code:
  EXPECT_EQ(mock.GetValue(), 5);
  mock.DoWork(10);
}
```

---

## Additional Resources

- [GoogleMock Mocking Reference](reference/mocking.md) — Full details on mocking
- [gMock for Dummies](docs/gmock_for_dummies.md) — Beginner-friendly overview
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md) — Quick reference
- [gMock Cookbook](docs/gmock_cook_book.md) — Recipes and best practices
- [Actions Reference](reference/actions.md) — Details on all built-in actions

---

Understanding expectations and actions is key to mastering writing expressive and robust tests with GoogleMock. Use the power to simulate complex behaviors, verify call interactions precisely, and build maintainable test suites with confidence.


