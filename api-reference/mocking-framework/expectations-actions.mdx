---
title: "Setting Expectations and Actions"
description: "Explains the ON_CALL and EXPECT_CALL macros, which allow users to specify expected calls, argument matchers, return values, and reactions to function invocations for mock objects. Includes documentation of chained expectations, sequences, and call behaviors."
---

# Setting Expectations and Actions

The `ON_CALL` and `EXPECT_CALL` macros form the core of GoogleMock's (gMock) **spec builder syntax**, enabling you to specify default behaviors and detailed expectations on mock methods in your tests. This page explains how to use these macros to define expected calls, argument matchers, return values, and how to control invocation sequences and call behaviors for mock objects.

---

## Overview

Mock objects by themselves have no behavior; you control how they react using `ON_CALL` and set expectations using `EXPECT_CALL`. Understanding and mastering these macros is crucial to writing effective, maintainable, and precise tests with GoogleMock.

- **`ON_CALL`** defines the *default behavior* of a mock method when it is invoked without corresponding explicit expectations. It does **not** imply that the method must be called.
- **`EXPECT_CALL`** sets an expectation that a mock method *will* be called according to the defined argument matchers, invocation counts, and call order.

When combining these, remember:

- The **last matching** `EXPECT_CALL` or `ON_CALL` declaration that matches the arguments of the call takes precedence.
- `EXPECT_CALL` actions override `ON_CALL` default actions.

---

## Using `ON_CALL` to Set Default Behaviors

`ON_CALL` specifies the behavior a mock method should perform when called without an explicit expectation set by `EXPECT_CALL`. This is useful to provide fallback behavior for methods whose calls you do not want to strictly verify.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers))
    [.With(multi_arg_matcher)]
    .WillByDefault(action);
```

- `matchers` specify argument expectations (omitting implies wildcard for each argument).
- `.With()` takes an optional matcher for the entire argument tuple.
- `.WillByDefault()` **must** be provided once to set the action executed.

### Example

```cpp
using ::testing::Return;
using ::testing::_;

ON_CALL(mock_turtle, GetX())
    .WillByDefault(Return(10));
```

Here `GetX()` will return 10 by default if no `EXPECT_CALL` explicitly handles the call.

---

## Using `EXPECT_CALL` to Set Expectations and Actions

`EXPECT_CALL` declares a requirement that a mock method is called with specified arguments, a certain number of times, optionally in a given order, and defines what the method should do when called.

### Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers))
    [.With(multi_arg_matcher)]        // Optional, once
    [.Times(cardinality)]             // Optional, once
    [.InSequence(sequences...)]       // Optional, multiple
    [.After(expectations...)]         // Optional, multiple
    [.WillOnce(action)]               // Optional, multiple
    [.WillRepeatedly(action)]         // Optional, once
    [.RetiresOnSaturation()];         // Optional, once
```

Clauses must appear in the order above. Multiple `.InSequence`, `.After`, and `.WillOnce` clauses can be used; others at most once.

### Detailed Clause Descriptions

- **`.With(multi_arg_matcher)`** — Restricts expectation to calls matching the entire argument tuple.

- **`.Times(cardinality)`** — Specifies how many times this call is expected, using GoogleMock cardinalities such as `Exactly(n)`, `AtLeast(n)`, and `AnyNumber()`.

  If omitted, cardinality is inferred from the count of `WillOnce` and `WillRepeatedly` based on this logic:
  - No actions: `Times(1)`.
  - `n` `WillOnce` clauses, no `WillRepeatedly`: `Times(n)`.
  - `n` `WillOnce` and one `WillRepeatedly`: `Times(AtLeast(n))`.

- **`.InSequence(sequences...)`** — Specifies that this expectation belongs to one or more sequences; calls for expectations included in a `Sequence` object must occur in the order declared.

- **`.After(expectations...)`** — Specifies prerequisite expectations that must be satisfied before this expectation can match. Supports up to 5 `Expectation` or `ExpectationSet` arguments.

- **`.WillOnce(action)`** — Defines the action performed once per matching call; multiple can be chained to define different behaviors for successive calls.

- **`.WillRepeatedly(action)`** — Defines an action for all subsequent calls once the `WillOnce` sequence is exhausted.

- **`.RetiresOnSaturation()`** — Marks the expectation as *inactive* after it is saturated (i.e., max call count reached). This affects matching behavior by retiring the expectation so that it won't match further calls, letting earlier expectations match instead.

### Example

```cpp
using ::testing::Return;
using ::testing::AtLeast;
using ::testing::InSequence;

Sequence s;
EXPECT_CALL(mock, DoThing(42))
    .Times(2)
    .WillOnce(Return(true))
    .WillOnce(Return(false))
    .RetiresOnSaturation()
    .InSequence(s);
EXPECT_CALL(mock, DoThing(_))
    .Times(AnyNumber())
    .WillRepeatedly(Return(true));

// The above expects DoThing(42) to be called twice in order and retire after saturated,
// thereafter DoThing with any argument can still be called any number of times and returns true.
```

---

## Chained Expectations and Sequences

You can control the order of calls using **sequences** and the `.After()` clause.

### Using `Sequence` and `InSequence`

The `Sequence` class lets you define partial orders for expectations using sequences. Assigning expectations to the same `Sequence` enforces a strict call order among them.

The `InSequence` helper class automatically assigns all expectations in its scope to an anonymous `Sequence`.

```cpp
using ::testing::InSequence;

{
  InSequence s;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

This ensures `FirstCall()` happens before `SecondCall()`.

### Using `.After()` for Flexible Ordering

`.After()` lets you specify that an expectation must only be matched after other expectations, allowing partial ordering (DAG) of calls.

```cpp
using ::testing::Expectation;
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, DoWork()).After(e1);
```

This means `DoWork()` must be called after `Init()`.

You can also use `ExpectationSet` to specify multiple prerequisites.

---

## Behavior and Error Handling

### Matching Logic

- GoogleMock matches calls to the *last* (most recent) matching `EXPECT_CALL` or `ON_CALL`.
- If no expectation matches, it falls back to default actions if defined with `ON_CALL`.
- If no matching expectation or default action exists, an *uninteresting call* occurs.

### Uninteresting Calls

Calling a mock method without an `EXPECT_CALL` matching the arguments generates a *warning* (naggy behavior), unless the mock is a `NiceMock` (suppresses warnings) or a `StrictMock` (treats warnings as failures).

### Unexpected Calls

Calls that match with some `EXPECT_CALL` defined but whose arguments do not match any expectation are *unexpected* and lead to test failures.

### Saturation and Retirement

An expectation is *saturated* when it reaches its maximum number of expected calls.
- Without `.RetiresOnSaturation()`, saturated expectations remain active and will cause failures if called more
- With `.RetiresOnSaturation()`, saturated expectations retire and will no longer match, letting earlier (less specific) expectations apply.

### Cardinality Violations

Expecting more or fewer calls than specified violates the cardinality and triggers GoogleTest failures, detailing:

- The expected number of calls
- The actual number of calls
- Whether the expectation is saturated or unsatisfied

---

## Common Usage Patterns and Tips

### 1. Setting Default Behavior Then Testing Specific Use Cases

Use `ON_CALL` in your mock constructor or test setup to provide general fallback behavior. Use `EXPECT_CALL` sparingly to test particular interactions.

### 2. Catch-All Expectations

Set a general expectation for calls you don't care about to suppress warnings:

```cpp
EXPECT_CALL(mock, SomeMethod(_)).Times(AnyNumber());
```

### 3. Use Sequences or `.RetiresOnSaturation()` to Manage Call Order

When calls must happen in specific order, use `Sequence` or wrap expectations in an `InSequence` to enforce order.

If expectations should retire after being satisfied to allow other expectations to match, use `.RetiresOnSaturation()`.

### 4. Watch for Sticky Expectations

By default, an expectation remains active even after being saturated, meaning the last matching expectation applies until `.RetiresOnSaturation()` or ordering makes it inactive.

---

## Troubleshooting

- **Uninteresting mock function call warnings:** Consider if you meant to have an expectation; use `ON_CALL` to set defaults and `EXPECT_CALL` to verify calls explicitly.
- **Unexpected mock function call errors:** Check if arguments failed to match any existing expectation. Use `--gmock_verbose=info` to trace calls and matching decisions.
- **Excessive call failures:** Ensure the number of calls does not exceed the cardinality specified in `Times()` or inferred from `WillOnce` and `WillRepeatedly`.
- **Expectation ordering problems:** Confirm that expectations using `InSequence` or `.After()` clauses are correctly set before calls happen. Mix sequences and `.RetiresOnSaturation()` appropriately.

For detailed debugging, run your tests with `--gmock_verbose=info` to see trace messages for mock invocations and matches.

---

## Internal Mechanics and Thread Safety

GoogleMock protects internal mock state using a global mutex to ensure thread-safe state transitions on expectations and call matching.

Mock methods automatically verify that all expectations are satisfied on destruction, or via explicit calls to:

```cpp
Mock::VerifyAndClearExpectations(&mock_object);
Mock::VerifyAndClear(&mock_object);
```

Use `Mock::AllowLeak(&mock_object)` to suppress leak warnings if intentionally leaking mocks.

---

## Summary

- Use `ON_CALL` to establish default mock behaviors without enforcing calls.
- Use `EXPECT_CALL` to specify expected calls, argument matchers, invocation counts, call order (`Sequence` and `.After()`), and return actions.
- Chain multiple `WillOnce()` calls for different call results, use `WillRepeatedly()` for repetitive call behavior.
- Manage call order flexibly using sequences and `.After()`.
- Use `.RetiresOnSaturation()` to retire expectations when saturated, enabling fallback matching.
- Understand uninteresting vs unexpected calls and configure mock strictness with `NiceMock` / `StrictMock`.
- Run tests with verbosity (`--gmock_verbose=info`) to trace mock call matching and diagnose failures.

---

## See Also

- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Beginner-friendly introduction to mocks
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Practical recipes on using expectations and actions
- [Matchers Reference](reference/matchers.md) — Argument matching
- [Actions Reference](reference/actions.md) — Defining mock behaviors
- [MOCK_METHOD and EXPECT_CALL Macros](reference/mocking.md#macros) — Syntax and clauses
- [Managing Mock Strictness (NiceMock, StrictMock)](reference/mocking.md#NiceStrictNaggy)

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googlemock/include/gmock/gmock-spec-builders.h", "range": "1-447"},{"path": "googlemock/src/gmock-spec-builders.cc", "range": "1-447"}]} />
