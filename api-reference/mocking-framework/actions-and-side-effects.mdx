---
title: "Actions and Side Effects"
description: "Covers configuration of mock method return values, output parameters, and custom behaviors using built-in and user-defined Actions. Includes variadic actions and support for complex side effects."
---

# Actions and Side Effects

This documentation explains how to configure mock method return values, manipulate output parameters, and define custom behaviors using GoogleMock's built-in and user-defined actions. It also covers variadic actions and advanced support for complex side effects, enabling you to precisely specify how mocked methods behave when invoked.

---

## Overview

Actions in GoogleMock specify what a mock function should do when called. Whether you want to return a fixed value, modify an output parameter, invoke a callable, or perform multiple side-effects, actions allow you to express these behaviors clearly and concisely within your test specifications.

You can use:

- Simple return actions like returning a value or reference.
- Side effect actions to modify arguments.
- Invoking functions, methods, lambdas, or callbacks.
- Composing multiple actions to simulate complex behaviors.

This page details how to leverage these features, with practical examples to help you integrate actions into your tests effectively.

---

## Returning Values from Mock Methods

### Return Fixed Values

Use `Return(value)` to return a specific value when the mock method is called.

```cpp
using ::testing::Return;

EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42));
```

*Note:* `Return(value)` captures a copy of `value` at **expectation setup time**, not at run time.

### Return Reference or Pointer

- Use `ReturnRef(variable)` to return a reference.
- Use `ReturnNull()` to return a null pointer.
- Use `ReturnPointee(ptr)` to return the value pointed to by a pointer at **execution time**.

```cpp
Bar bar;
EXPECT_CALL(mock, GetBar())
    .WillOnce(ReturnRef(bar));

int x = 5;
EXPECT_CALL(mock, GetValue())
    .WillRepeatedly(ReturnPointee(&x));
```

### Return Different Values on Multiple Calls

Combine multiple `WillOnce()` actions followed optionally by `WillRepeatedly()` for repeated behavior.

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

This returns `1` on the first call, `2` on the second, and `3` thereafter.

---

## Side Effects and Output Parameters

Methods often signal results by modifying arguments passed by pointer or reference. GoogleMock provides dedicated actions to support this pattern.

### Setting Output Arguments

- `SetArgPointee<N>(value)`: Sets the value pointed to by the `N`-th argument (zero-based).

```cpp
EXPECT_CALL(mock, ProcessData(_, _))
    .WillOnce(SetArgPointee<1>(42));
```

Here, the second argument pointed-to value will be set to `42`.

- `SetArrayArgument<N>(first, last)`: Copies a range of elements to an array pointed to by the `N`-th argument.

```cpp
int data[] = {1, 2, 3};
EXPECT_CALL(mock, FillBuffer(_))
    .WillOnce(SetArrayArgument<0>(data, data + 3));
```

### Assigning Output Arguments by Reference

- Use `SetArgReferee<N>(value)` to assign to the variable referenced by the `N`-th argument.

### Saving Arguments for Later Verification

- `SaveArg<N>(pointer)` copies the `N`-th argument to `*pointer`.
- `SaveArgByMove<N>(pointer)` moves the `N`-th argument to `*pointer` (useful with move-only types).
- `SaveArgPointee<N>(pointer)` copies the value pointed to by the `N`-th argument.

```cpp
std::string actual;
EXPECT_CALL(mock, WriteData(_))
    .WillOnce(SaveArg<0>(&actual));
```

---

## Using Functions, Methods, Functors, and Lambdas as Actions

If built-in actions don’t suffice, you can invoke arbitrary callable objects.

### `Invoke()` and `InvokeWithoutArgs()`

- `Invoke(callable)`: Calls `callable` with the mock method's arguments.
- `Invoke(object_pointer, &Class::Method)`: Calls the method on the given object.
- `InvokeWithoutArgs(callable)`: Calls a zero-argument callable ignoring mock method parameters.

```cpp
bool IsPositive(int x) { return x > 0; }
EXPECT_CALL(mock, Check(_))
    .WillOnce(Invoke(IsPositive));

EXPECT_CALL(mock, Reset())
    .WillOnce(InvokeWithoutArgs([] { ResetSystem(); }));
```

Note: The callable must be compatible with the mock method's signature (arguments convertible, return compatible).

### Invoking a Callable Passed as a Mock Argument

If your method accepts a callback or functor, invoke it using `InvokeArgument<N>(args...)`.

```cpp
EXPECT_CALL(mock, DoWork(_, _))
    .WillOnce(InvokeArgument<1>(5));  // Calls the second argument with 5.
```

Wrap arguments in `std::ref()` if they must be passed by reference.

### Ignoring Action Return Value

Use `IgnoreResult(action)` to discard the return value of an action.

```cpp
EXPECT_CALL(mock, Process())
    .WillOnce(IgnoreResult(Invoke(SomeFunctionReturningInt)));
```

This is useful for mock functions that return `void`.

---

## Combining Multiple Actions

### `DoAll()`

Execute multiple actions sequentially. Only the last action’s return value is used.

```cpp
EXPECT_CALL(mock, Fill(_, _))
    .WillOnce(DoAll(
        SetArgPointee<1>(10),
        Return(true)));
```

Useful for setting output parameters and returning a status simultaneously.

### `WithArg<N>(action)`, `WithArgs<N1, N2, ...>(action)`, and `WithoutArgs(action)`

These adapt the arguments passed to an action:

- `WithArg<N>(action)`: Pass argument `N` to `action`.
- `WithArgs<N1, N2, ...>(action)`: Pass selected arguments to `action`.
- `WithoutArgs(action)`: Call `action` without any arguments.

```cpp
EXPECT_CALL(mock, Compute(_, _, _))
    .WillOnce(WithArgs<0, 2>(Invoke(&helper, &Helper::Process)));
```

### Tips

- Actions and matchers can be assigned to variables and reused.
- Actions with internal state should be carefully shared to avoid unintended behavior.

---

## Defining Your Own Actions

When needed, define custom actions:

- Use lambdas or functors with call operators compatible with the mock method signature.
- Use `ACTION()` macros for simple, parameterless actions.
- Use `ACTION_P`, `ACTION_P2`, ... for parameterized actions.
- For advanced control, implement the `ActionInterface` or use `MakePolymorphicAction()`.

```cpp
ACTION(IncrementArg0) {
  ++(*arg0);
  return 0;
}

EXPECT_CALL(mock, DoSomething)
    .WillOnce(IncrementArg0());
```

Refer to the [gMock Cookbook](../mocking-framework/defining-and-using-mocks.md) for detailed examples.

---

## Handling Move-Only Types

GoogleMock supports mocking methods accepting or returning move-only types (e.g., `std::unique_ptr`). Use lambdas or callable objects in `WillOnce()` or `WillRepeatedly()` to create or forward such objects dynamically.

Example:

```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
      return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

Avoid capturing move-only objects by value in `Return()`; use lambdas instead.

---

## Variadic Actions and Complex Side Effects

GoogleMock’s variadic actions simplify working with methods that affect multiple output parameters or require complex side-effects.

- `SetArrayArgument<N>(first, last)` copies ranges to output arrays.
- `InvokeArgument<N>(args...)` invokes a callable passed as argument.
- Use `DoAll()` to chain multiple side-effects.

Example chaining output modification and return value:

```cpp
EXPECT_CALL(mock, UpdateData(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

---

## Best Practices

- Use `ON_CALL()` to set default behaviors for mocks without creating strict expectations.
- Use `EXPECT_CALL()` when you want to verify that a call happens.
- Prefer `NiceMock` or `StrictMock` wrappers to control warnings and failures on unexpected calls.
- Always match the semantics of your system under test; avoid over-constraining expectations.
- Combine `DoAll()` and output-modifying actions for concise side-effect simulations.
- When invoking callable arguments, wrap reference parameters with `std::ref()`.
- When mocking move-only types, avoid `Return()` and prefer lambdas.
- Use `RetiresOnSaturation()` for expectations with limited intended invocations to avoid sticky expectations.

---

## Troubleshooting Tips

- Receiving warnings about uninteresting calls? Use `NiceMock` or set explicit expectations with `EXPECT_CALL(...).Times(AnyNumber())` on those methods.
- If mock actions don’t run as expected, verify that your return actions or lambdas have compatible signatures.
- When modifying output parameters, ensure proper indexing of arguments using zero-based positions.
- Cannot mock variadic functions? GoogleMock does not support ellipsis arguments; consider interface redesigns to avoid this.
- For complex custom actions, ensure correct setup of value and template parameters if using `ACTION_TEMPLATE` macros.

---

## Additional Resources

- [Defining and Using Mocks](../mocking-framework/defining-and-using-mocks.md)
- [Matchers Reference](../matchers-and-expectations/using-matchers.md)
- [Mocking Framework Overview](../mocking-framework/expectations-and-cardinalities.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [Actions Reference](docs/reference/actions.md)

---

## Example: Chaining Actions with Side Effects

```cpp
class MockProcessor {
 public:
  MOCK_METHOD(bool, Process, (int input, int* output), (override));
};

TEST(ProcessorTest, SideEffectExample) {
  MockProcessor mock;

  EXPECT_CALL(mock, Process(42, _))
      .WillOnce(DoAll(
          SetArgPointee<1>(100),   // Set *output = 100
          Return(true)));          // Return true from Process()

  int val = 0;
  EXPECT_TRUE(mock.Process(42, &val));
  EXPECT_EQ(val, 100);
}
```

This example shows how to set an output parameter and return a value together.

---