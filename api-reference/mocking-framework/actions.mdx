---
title: "Actions: Custom Responses to Calls"
description: "Describes how to control the behavior of mock methods when they are invoked, using predefined and custom actions such as returning values, throwing exceptions, or invoking callbacks."
---

# Actions: Custom Responses to Calls

This documentation page details how you can control the behavior of mock methods when they are invoked using GoogleMock's built-in and custom *actions*. Actions specify what a mock function should do when called, such as returning a value, throwing exceptions, invoking callbacks, or modifying output arguments. Understanding and utilizing actions allows you to precisely simulate complex interactions and side effects in your unit tests.

---

## What Are Actions?

Actions in GoogleMock define the behavior a mock method executes upon invocation. Since mock methods have no real implementation, actions let you customize their response, achieving realistic test scenarios without depending on actual object behavior.

Every action is compatible with the signature of the mock method it is applied to, supporting correct argument forwarding and return types.

---

## Specifying Actions in Expectations

Actions are most commonly specified as part of an `EXPECT_CALL()` or `ON_CALL()` statement:

- `EXPECT_CALL(mock, Method(args))` sets an expectation and associates actions executed when the call happens.
- `ON_CALL(mock, Method(args))` sets default actions without expectation enforcement.

Available chaining clauses for `EXPECT_CALL`: 

```cpp
EXPECT_CALL(mock, Method(args))
    .With(multi_argument_matcher)  // Optional
    .Times(cardinality)            // Optional
    .InSequence(sequences...)      // Optional
    .After(expectations...)        // Optional
    .WillOnce(action)              // Can appear multiple times
    .WillRepeatedly(action)        // At most once
    .RetiresOnSaturation();        // At most once
```

In `ON_CALL`, the main clause is `.WillByDefault(action)`, which sets the default behavior.

Actions specified by `WillOnce()` are consumed once per invocation in order; `WillRepeatedly()` applies thereafter.

---

## Built-in Actions

GoogleMock provides a rich set of predefined actions to cover common behaviors:

### Returning Values
- `Return()`: For `void` functions, does nothing (returns).
- `Return(value)`: Returns the specified `value`. **Important:** The conversion of `value` to the mock's return type happens when the expectation is set, not at each invocation.
- `ReturnArg<N>()`: Returns the N-th argument received.
- `ReturnNew<Type>(args...)`: Returns a freshly allocated `new Type(args...)` object pointer on each invocation.
- `ReturnNull()`: Returns a null pointer.
- `ReturnPointee(ptr)`: Returns the dereferenced value pointed to by `ptr` at the time of the call.
- `ReturnRef(variable)`: Returns a reference to a variable.
- `ReturnRefOfCopy(value)`: Returns a reference to a copy of `value` which lives as long as the action.
- `ReturnRoundRobin({v1, v2, ..., vN})`: Cycles through a provided list of values round-robin with each call.

### Side Effects
- `Assign(&variable, value)`: Assigns `value` to `variable` when the mock method is called.
- `DeleteArg<N>()`: Deletes the pointer passed as the N-th argument.
- `SaveArg<N>(pointer)`: Saves a copy of the argument N into the provided pointer.
- `SaveArgByMove<N>(pointer)`: Moves the argument N into the provided pointer.
- `SaveArgPointee<N>(pointer)`: Saves the value pointed to by argument N into *pointer.
- `SetArgReferee<N>(value)`: Assigns `value` to the referent of the argument N.
- `SetArgPointee<N>(value)`: Assigns `value` to the pointee argument at position N.
- `SetArrayArgument<N>(first, last)`: Copies elements from `[first, last)` to the array or iterator pointed to by the N-th argument.
- `SetErrnoAndReturn(error, value)`: Sets errno to `error` and returns `value`.
- `Throw(exception)`: Throws the specified exception when the mock method is called.

### Using Callables as Actions

You can specify any **callable** as an action if it matches the mock method's signature:

- `f`: Invoke a function, functor, lambda with the mock call's arguments.
- `Invoke(f)`: Wraps a function/functor to be called with the mock's arguments.
- `Invoke(obj_ptr, &class::method)`: Invokes a member method on the object with the mock's arguments.
- `InvokeWithoutArgs(f)`: Calls a callable with no arguments regardless of the mock call's.
- `InvokeWithoutArgs(obj_ptr, &class::method)`: Calls a member method with no arguments.
- `InvokeArgument<N>(arg1, arg2, ..., argk)`: Invokes the N-th argument of the mock method assuming it is callable, passing the specified arguments.

**Tip:** For arguments passed by reference to `InvokeArgument`, wrap the argument in `std::ref()` to avoid copying.

### Composite Actions

- `DoAll(a1, a2, ..., aN)`: Executes several actions sequentially, returning the result of the last. Useful for combining side effects with return value.
- `IgnoreResult(a)`: Ignores the return value of an action (must not return void).
- `WithArg<N>(a)`: Passes only argument N to inner action `a`.
- `WithArgs<N1, N2, ..., Nk>(a)`: Passes specified arguments to inner action `a`.
- `WithoutArgs(a)`: Calls `a` without any arguments.

### Default Action

- `DoDefault()`: Performs the default action defined by `ON_CALL` or the built-in default. Cannot be used inside composite actions.

---

## Custom Actions

When the built-in actions do not suffice, you can define your own:

### Using Lambdas or Functors

Write a callable with signature compatible with the mocked method and pass it to `.WillOnce()` or `.WillRepeatedly()`.

```cpp
EXPECT_CALL(mock, Method(args))
    .WillOnce([](ArgType arg) {
        // custom behavior
        return something;
    });
```

### Using ACTION Macros

Use the preprocessor macros to quickly define monomorphic or parameterized actions:

```cpp
ACTION(ActionName) {
  // 'arg0', 'arg1', ... represent mock call arguments.
  // Return a value compatible with the mocked method.
}

ACTION_P(ParamAction, param) {
  return arg0 + param;
}
```

Then:

```cpp
EXPECT_CALL(mock, Method).WillOnce(ActionName());
EXPECT_CALL(mock, Method).WillOnce(ParamAction(5));
```

### Implementing `ActionInterface`

For fine-grained control, implement the `ActionInterface<F>` class where `F` is the mocked method type. Implement the `Perform` method to execute the action logic.

Use `MakeAction()` to wrap your implementation:

```cpp
class CustomAction : public ActionInterface<R(Args...)> {
public:
  R Perform(const std::tuple<Args...>& args) override {
    // custom logic
  }
};

Action<R(Args...)> MakeCustomAction() {
  return MakeAction(new CustomAction);
}
```

### Polymorphic Actions

If you want one action to be usable across different method signatures, define a polymorphic action with a templated `Perform` method and wrap with `MakePolymorphicAction()`.

```cpp
class PolyAction {
 public:
  template <typename R, typename Args>
  R Perform(const Args& args) const {
    // polymorphic behavior
  }
};

PolymorphicAction<PolyAction> MakePoly() {
  return MakePolymorphicAction(PolyAction());
}
```

---

## Practical Examples

### Returning Different Values in Sequence

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

`mock.GetValue()` returns 10 on first call, 20 on second, then 30 afterwards.

### Modifying an Output Argument and Returning a Value

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

The second pointer argument is set to 5, and the function returns `true`.

### Invoking a Callback Argument

```cpp
EXPECT_CALL(mock, DoAsync(_, _))
    .WillOnce(InvokeArgument<1>(42, std::ref(helper)));
```

Invokes the second argument (a callable) with `(42, helper)`.

### Delegating to a Real or Fake Object

```cpp
ON_CALL(mock, Method(_)).WillByDefault([&real](ArgType arg) {
  return real.Method(arg);
});
```

Allows the mock to simulate a real object’s behavior when no explicit expectation is provided.

---

## Best Practices & Tips

- Use `ON_CALL()` to define general default behavior without imposing call count requirements.
- Use `EXPECT_CALL()` to both set expectations and specify actions.
- When returning references, prefer `ReturnRef()` over `Return()`.
- Use `ReturnPointee()` to delay value retrieval until mock invocation time.
- For complex side effects, combine multiple actions with `DoAll()`.
- Use `Invoke*()` family of actions to integrate existing code seamlessly.
- Wrap arguments with `std::ref()` if they should be passed by reference to invoked callables.
- Prefer lambdas or functors for clarity and flexibility when defining custom actions.
- Use `RetiresOnSaturation()` to automatically retire expectations upon saturation.

---

## Troubleshooting

- If you see warnings about too many or too few actions compared to call cardinalities, review your `.WillOnce()` and `.WillRepeatedly()` usage.
- Avoid placing `DoDefault()` inside composite actions like `DoAll()`; it's not supported.
- When returning move-only types, use lambdas or `ByMove` to return fresh instances each call.
- Ensure you don’t accidentally return copies of temporaries when live values are needed; use `ReturnPointee()` or `ReturnRefOfCopy()` appropriately.
- When argument types mismatch in custom actions, use `WithArgs<>` to select the right argument subset.

---

## Related Documentation

- [Mock Object Creation & Usage](./mock-object-basics)
- [Matchers: Argument Matching & Patterns](./matchers)
- [Expectations & Call Ordering](./expectations)
- [Customizing Mock Behavior with Matchers and Actions](../../guides/mocking-and-advanced-testing/using-matchers-and-actions)
- [Writing New Actions](./actions#quicknewactions)
- [GoogleMock Cookbook - Actions Section](../../docs/gmock_cook_book.md#using-actions)

---

With these facilities, GoogleMock lets you fully customize how your mocks respond, making it possible to precisely simulate complex interaction patterns and build robust, focused unit tests.