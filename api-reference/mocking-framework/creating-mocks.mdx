---
title: "Defining and Using Mocks"
description: "Describes the APIs and macros for defining mock classes and methods, including MOCK_METHOD and configuration of method signatures. Guides users through practical workflows for introducing test doubles into existing codebases."
---

# Defining and Using Mocks

This page details how to create and use mock classes and methods in GoogleTest's mocking framework (gMock). It focuses on the APIs and macros for defining mock classes, particularly the `MOCK_METHOD` macro, and configuring method signatures, as well as how to inject test doubles effectively into existing codebases.

---

## Overview

Mock objects simulate behavior of real objects in tests by providing controllable and verifiable methods. gMock facilitates the creation of mock classes where each mocked method can be specified with expectations and behaviors.

This page specifically covers the key macros and classes involved in defining mock methods with correct signatures and how to use these mocks in test scenarios.

## MOCK_METHOD Macro

`MOCK_METHOD` is the primary macro for defining a mock method inside a mock class. It creates the necessary plumbing to track method invocations and set expectations.

### Syntax

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
```

- **ReturnType**: The return type of the method.
- **MethodName**: The name of the method to be mocked.
- **Args...**: The method parameter types.
- **Specs...**: Optional qualifiers such as `const`, `override`, `noexcept`, reference qualifiers, or calling conventions.

### Key Points

- Must appear inside the `public:` section of the mock class, regardless of the base method's access level.
- Supports mocking `const` methods with the `(const)` specifier and marking overridden methods with `(override)`.
- Comma-separated `Specs...` allow combining qualifiers, for example `(const, override, noexcept)`.
- To handle argument types containing commas (e.g., templates like `std::pair<int, int>`), wrap the argument list in parentheses or use type aliases to avoid syntax errors.

### Examples

#### Basic Mock Method

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), (override));
  MOCK_METHOD(void, SetValue, (int v), (override));
};
```

#### Mocking Const Methods

```cpp
class MockTurtle {
 public:
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(void, MoveTo, (int x, int y), (override));
};
```

#### Handling Types with Commas

```cpp
// Using parentheses around argument type
MOCK_METHOD((std::pair<int, int>), GetPair, ());

// Using type alias
using IntPair = std::pair<int, int>;
MOCK_METHOD(IntPair, GetPair, ());
```

### Mocking Overloaded Methods

You must provide the full argument list to disambiguate which overload is being mocked. Mocking all overloads explicitly is recommended to avoid hiding other versions.

```cpp
class MockBar {
 public:
  MOCK_METHOD(int, Sum, (int x), (override));
  MOCK_METHOD(int, Sum, (int x, int y), (override));
};
```

Use `using` to bring unmocked overloads into scope if needed.

## Using Mocks in Tests

After defining mock classes with mocked methods, tests typically involve:

1. Creating instances of the mock class.
2. Setting up behavior and expectations using `ON_CALL` and `EXPECT_CALL`.
3. Exercising the code under test that uses the mock.
4. Verifying the mock meets the expectations, automatically done on destruction or manually via `Mock::VerifyAndClearExpectations()`.

### ON_CALL

Defines the default behavior of a mock method when called, without imposing expectations that the method will be called.

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .WillByDefault(action);
```

- `.With()` is optional and restricts the calls this applies to based on all arguments as a tuple.
- `.WillByDefault()` specifies the default action.

### EXPECT_CALL

Sets an expectation that a mock method will be called, optionally configuring the number of times, call order, and actions.

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .Times(cardinality)
    .InSequence(sequences...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

- `.Times()` specifies how many times the call must occur.
- `.InSequence()` and `.After()` specify ordering constraints.
- `.WillOnce()` and `.WillRepeatedly()` specify what the method will do upon invocation.
- `.RetiresOnSaturation()` automatically deactivates the expectation after it has been satisfied.

For detailed usage of these clauses, see [Setting Expectations and Actions](../guides/mocking-and-advanced-patterns/setting-expectations-and-actions.md).

## Managing Ownership and Lifetime

Mock objects automatically verify if expectations are met during destruction.

Use `Mock::AllowLeak(&mock_object)` to skip verification for a mock object intentionally leaked. Use `Mock::VerifyAndClearExpectations(&mock_object)` to verify expectations early and clear them.

## MockFunction

When needing to mock `std::function` or similar function objects, use `MockFunction`.

```cpp
MockFunction<int(std::string)> mock_func;
EXPECT_CALL(mock_func, Call("test")).WillOnce(Return(42));
int result = mock_func.AsStdFunction()("test");
```

It provides a single mock method named `Call()` matching the signature.

## Practical Tips and Workflows

- Always place `MOCK_METHOD` in the `public:` section.
- For methods overriding virtual methods, always specify `(override)` in the fourth parameter to avoid surprises.
- For const methods, specify `(const, override)`.
- Use `ON_CALL` to define default behaviors shared across multiple tests.
- Use `EXPECT_CALL` to specify calls you want to verify strictly.
- When mocking move-only types or complex return types, use lambdas or `WillOnce` with helper functions.
- Be aware that `EXPECT_CALL` defines expectations for future calls â€” set them before exercising the code under test.
- Use sequences (`Sequence` and `InSequence`) or partial ordering (`After`) to specify call order dependencies.
- Retire expectations explicitly when necessary using `RetiresOnSaturation` to prevent shadowing.

## Common Pitfalls

- Forgetting `MOCK_METHOD` must be public causes compilation or linkage errors.
- Not disambiguating overloaded methods leads to ambiguous calls.
- Over-specifying expectations can lead to brittle tests.
- Omitting `EXPECT_CALL` but calling mock methods triggers uninteresting call warnings.
- Ignoring call strictness management (`NiceMock`, `StrictMock`, `NaggyMock`) can cause unexpected test failures or noisy test output.

## Code Example

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};

// Usage in test
TEST(PaintTest, DrawsLine) {
  MockTurtle turtle;

  ON_CALL(turtle, GetX()).WillByDefault(testing::Return(0));
  ON_CALL(turtle, GetY()).WillByDefault(testing::Return(0));

  EXPECT_CALL(turtle, PenUp());
  EXPECT_CALL(turtle, GoTo(testing::_, testing::_));

  Painter painter(&turtle);
  painter.DrawLine(0, 0, 10, 10);
}
```

## Further Reading

- For comprehensive usage of `EXPECT_CALL` and `ON_CALL`, see [Setting Expectations and Actions](../guides/mocking-and-advanced-patterns/setting-expectations-and-actions.md).
- To explore mock object strictness variants, see [Managing Mock Strictness](../api-reference/mocking-framework/nice-strict-mocks.md).
- Learn about argument matchers to fine-tune expectations in [Argument Matchers](../api-reference/advanced-features-and-configuration/matchers.md).

---

## Summary

The `MOCK_METHOD` macro and associated classes form the core API for creating and controlling mock methods in gMock. Correct usage allows precise specification of mock method signatures, behaviors, and expectations, enabling robust and maintainable unit tests. This page equips users with the knowledge to define mocks defensively, express expected call sequences, and delegate behaviors effectively within tests.


---