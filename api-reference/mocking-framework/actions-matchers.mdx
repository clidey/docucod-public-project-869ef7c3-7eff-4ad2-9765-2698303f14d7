---
title: "Actions and Matchers"
description: "Comprehensive documentation of built-in and extensible actions (returns, invokes, throws) and matchers (equality, predicates, custom). Provides reference and best practices for using and composing actions and matchers to model realistic behaviors and argument checks."
---

# Actions and Matchers

This page provides a comprehensive reference and guidance around **Actions** and **Matchers** in GoogleMock (gMock), the powerful framework for creating and controlling mock objects in C++ testing. Here, you will learn how to specify what mock functions should do when invoked (using Actions), and how to precisely match function arguments (using Matchers) to model realistic behaviors and expectations.

---

## Overview

In mock-based testing, Actions define the behavior of a mock method when it is called, such as what it returns or side effects it causes. Matchers are predicates used to specify constraints on the arguments passed to mocked methods, enabling detailed verification of interactions.

Together, Actions and Matchers allow you to:

- Simulate complex return values, side effects, and call sequences.
- Selectively verify calls with fine-grained argument checking.
- Extend the framework by creating custom behaviors and checks.

This page focuses solely on Actions and Matchers constructs and usage patterns. It complements other pages such as the [Mocking Reference](../reference/mocking.md) and [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html).

---

## Actions

Actions specify what a mock function should do when it is invoked. They allow you to model return values, side effects, exceptions, call other functions, or compose multiple behaviors.

All built-in Actions live in the `::testing` namespace.

### Common Built-In Actions

#### Returning Values

| Action                      | Description                                                                                      |
|-----------------------------|--------------------------------------------------------------------------------------------------|
| `Return()`                  | Returns from a `void` function.                                                                  |
| `Return(value)`             | Returns `value`, converting it at the time the expectation is set, not at call time.             |
| `ReturnArg<N>()`            | Returns the `N`-th argument passed to the function (0-based).                                    |
| `ReturnNew<T>(a1, ..., ak)` | Returns `new T(a1, ..., ak)` creating a new object on each call.                                 |
| `ReturnNull()`              | Returns a null pointer.                                                                           |
| `ReturnPointee(ptr)`        | Returns the value pointed to by `ptr` when the action executes (useful for live values).         |
| `ReturnRef(variable)`       | Returns a reference to `variable`.                                                              |
| `ReturnRefOfCopy(value)`    | Returns a reference to a copy of `value`. The copy lives as long as the action.                  |
| `ReturnRoundRobin({v1,...})`| Returns values in rotation from the list each time the function is called.                       |

##### Example
```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```
This will return 10 on the first call, 20 on the second, and 30 thereafter.

---

#### Side Effects

Actions that cause effects other than simply returning values. Useful for setting output arguments or modifying state.

| Action                                     | Description                                         |
|--------------------------------------------|-----------------------------------------------------|
| `Assign(&variable, value)`                  | Assigns `value` to the variable.                     |
| `DeleteArg<N>()`                           | Deletes the pointer passed as the `N`-th argument.  |
| `SaveArg<N>(pointer)`                      | Copies the `N`-th argument to `*pointer`.            |
| `SaveArgByMove<N>(pointer)`                | Moves the `N`-th argument to `*pointer`.             |
| `SaveArgPointee<N>(pointer)`               | Saves the value pointed to by the `N`-th argument to `*pointer`. |
| `SetArgReferee<N>(value)`                  | Sets the value referenced by the `N`-th argument.   |
| `SetArgPointee<N>(value)`                   | Sets the value pointed to by the `N`-th argument.   |
| `SetArrayArgument<N>(first, last)`          | Copies the elements in range `[first, last)` to array pointed by `N`-th argument.|
| `SetErrnoAndReturn(error, value)`           | Sets `errno` and returns `value`.                    |
| `Throw(exception)` (since v1.1.0)          | Throws the given exception (must be copyable).       |

##### Example
```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```
This sets the output argument at index 1 to 5 and returns `true`.

---

#### Actions Using Functions, Functors, or Lambdas

You can provide a callable to invoke when the mock function is called. The function signature must be compatible with the mock method.

| Action                                    | Description                                  |
|-------------------------------------------|----------------------------------------------|
| `f`                                       | Invokes the callable `f` with the mock arguments.
| `Invoke(f)`                               | Invokes a global/static function or functor `f` with arguments.
| `Invoke(object_pointer, &class::method)` | Invokes `method` on `object_pointer` with arguments.
| `InvokeWithoutArgs(f)`                    | Invokes `f` without passing any arguments.
| `InvokeWithoutArgs(object_pointer, &class::method)` | Invokes a zero-argument method on an object.
| `InvokeArgument<N>(args...)`              | Invokes the `N`-th argument as a callable with specified arguments.

##### Usage Tips
- Use `Unused` for unused parameters in lambdas or functions.
- If an argument to `InvokeArgument` should be passed by reference, wrap it with `std::ref()`.

##### Example
```cpp
EXPECT_CALL(mock, DoSomething(_, _))
    .WillOnce(InvokeArgument<1>(5, std::ref(helper)));
```
Calls the second argument (assumed to be a callable) with parameters `5` and a reference to `helper`.

---

#### Default Action

- `DoDefault()` executes the default behavior defined by `ON_CALL()` or built-in defaults.

**Note:** `DoDefault()` cannot be used inside a composite action (results in a runtime error).

---

#### Composite Actions

You can combine multiple actions to occur sequentially on the same call.

| Action                | Description                                                                  |
|-----------------------|------------------------------------------------------------------------------|
| `DoAll(a1, a2, ..., an)` | Performs all actions `a1` to `an` in order, returns the result of `an`.       |
| `IgnoreResult(a)`      | Performs action `a` but ignores its return value. `a` must not return void.   |
| `WithArg<N>(a)`        | Performs action `a` with the single N-th argument.                           |
| `WithArgs<N1, N2, ..., Nk>(a)` | Performs action `a` with the selected arguments.                          |
| `WithoutArgs(a)`       | Performs action `a` without any arguments.                                   |

##### Example
```cpp
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```
Sets output argument 0 to 42 and returns `true`.

---

#### Defining Custom Actions

You can create your own action using the `ACTION`, `ACTION_P`, or `ACTION_Pk` macros.

Example: Simple action to sum two arguments
```cpp
ACTION(Sum) { return arg0 + arg1; }
// Usage:
EXPECT_CALL(mock, Add(_, _))
    .WillOnce(Sum());
```

Parameterized action example:
```cpp
ACTION_P(Plus, n) { return arg0 + n; }
EXPECT_CALL(mock, Add(_))
    .WillOnce(Plus(5));
```
---

## Matchers

Matchers help specify constraints on mock method arguments to verify that the code under test calls mocks with expected values or properties.

### Key Points

- Matchers can be as simple as exact values (e.g., `Eq(5)`) or wildcards (`_`).
- You can use built-in matchers for common predicates (e.g., `Lt()`, `NotNull()`, `HasSubstr()`).
- Matchers can be combined logically: `AllOf()`, `AnyOf()`, `Not()`, etc.
- You can create custom matchers using macros or classes.
- Matchers must be purely functional, side-effect free.

### Using Matchers

| Matcher               | Purpose                                              |
|-----------------------|------------------------------------------------------|
| `_`                   | Wildcard matcher; matches any value.                  |
| `Eq(value)`           | Matches exactly `value`.                              |
| `Lt(value)`           | Matches arguments less than `value`.                  |
| `Ge(value)`           | Matches arguments greater than or equal `value`.     |
| `Not(matcher)`        | Negates the inner matcher.                            |
| `AllOf(m1, m2, ...)`  | Matches if all inner matchers match.                  |
| `AnyOf(m1, m2, ...)`  | Matches if any inner matcher matches.                 |
| `Field(&Class::field, matcher)` | Matches if the field in argument matches inner matcher. |
| `Property(&Class::method, matcher)` | Matches if property returned by method matches inner matcher. |
| `Pointee(matcher)`    | Matches pointers where the pointed value matches inner matcher. |
| `Truly(predicate)`    | Uses arbitrary unary predicate function as matcher.  |

##### Example
```cpp
EXPECT_CALL(mock, Foo(Field(&MyClass::count, Ge(10))));
```
Matches calls to `Foo()` where argument's `count` field is at least 10.

### Combining Matchers on Multiple Arguments

Use the `.With()` clause on `EXPECT_CALL` or `ON_CALL` to apply a multi-argument matcher over all arguments as a tuple.

Example: Verify first argument is less than the second
```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt()); // Lt() applied to tuple of args
```

You can also use `Args<N1, N2>(m)` to match specific arguments as a tuple.

### Defining Custom Matchers

Use `MATCHER` and `MATCHER_P` macros to write custom matchers succinctly. 

Basic matcher example:
```cpp
MATCHER(IsDivisibleBy7, "") { return (arg % 7) == 0; }

EXPECT_CALL(mock, Bar(IsDivisibleBy7()));
```

Parameterized matcher example:
```cpp
MATCHER_P(HasAbsoluteValue, value, "") { return abs(arg) == value; }

EXPECT_CALL(mock, Baz(HasAbsoluteValue(10)));
```

Further control of match description, match explanation, and negated descriptions is available via arguments and streaming to a listener.

### Safe Matcher Casting

When types differ but are safely convertible (e.g., `int` to `long`), use `SafeMatcherCast<T>(m)` to cast matchers to the appropriate argument type to satisfy compiler constraints.

Example:
```cpp
EXPECT_CALL(foo, DoThis(SafeMatcherCast<Derived*>(base_matcher)));
```

### Dealing with Overloaded Methods

For methods overloaded by constness or argument types, use `Const()` wrapper or typed matchers to disambiguate usage.

Example:
```cpp
EXPECT_CALL(mock, GetBar());         // non-const
EXPECT_CALL(Const(mock), GetBar());  // const
```

### Using Matchers as Predicates

You can use matchers as predicates in algorithms by wrapping them with `Matches()`. For example, counting how many elements are greater than 10 in a vector can be:

```cpp
count_if(vec.begin(), vec.end(), Matches(Gt(10)));
```

---

## Best Practices & Tips

- Use `ON_CALL` to define default behaviors of mock methods that do not require verification.
- Use `EXPECT_CALL` to specify actual expectations (count, argument constraints, call sequence).
- Prefer generalized matchers over exact values unless precisely needed.
- Use `InSequence`, `.After()`, and `.RetiresOnSaturation()` for controlling call order and expectation lifecycle.
- Utilize composite actions (`DoAll()`, `IgnoreResult()`) to model complex behavior.
- For matchers and actions with complex logic, implement custom matchers or actions rather than overcomplicating test code.
- Remember matchers are evaluated multiple times internally; they must have no side effects.
- Leverage built-in matchers for tuple arguments and fields to write expressive and maintainable tests.

---

## Related Links and Further Reading

- [Actions Reference](../reference/actions.md) — Complete list of built-in Actions
- [Matchers Reference](../reference/matchers.md) — Comprehensive Matcher details
- [Mocking Reference](../reference/mocking.md) — Overview of mocking constructs
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Recipes for Actions and Matchers
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Beginner-friendly guide
- [Setting Expectations Reference](../reference/mocking-framework/setting-expectations) — Detailed on `EXPECT_CALL` and `ON_CALL`

---

By mastering Actions and Matchers, you gain fine-grained control over mocking beyond just verifying method invocations. This empowers you to create robust, readable, and maintainable tests that model your system's real interactions precisely and flexibly.
