---
title: "Defining and Using Mocks"
description: "Explains how to create mock classes and methods using GoogleMock, leveraging core macros and templates. Outlines the process for injecting mocks into tested code, configuring mock behavior, and inspecting interactions."
---

# Defining and Using Mocks

This guide explains how to create mock classes and methods using GoogleMock. It focuses on leveraging the core macros and templates provided, walking you through defining mocks, configuring behaviors, injecting mock objects into your code, and inspecting mock interactions.

---

## Creating Mock Classes

Mock classes are user-defined classes that inherit from interfaces or abstract base classes. GoogleMock simplifies mock creation by generating mock methods using the `MOCK_METHOD` macro.

### Using `MOCK_METHOD`

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers...));
```

- **ReturnType**: The return type of the method being mocked.
- **MethodName**: The exact name of the method.
- **Args...**: The method's parameter types enclosed in parentheses.
- **Qualifiers**: Optional qualifiers such as `const`, `override`, `noexcept`, calling convention (`Calltype(...)`), and reference qualifiers (`ref(&)`, `ref(&&)`).

**Example:**
```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Handling Commas in Types

If the return type or argument list contains commas (e.g., template types like `std::pair<int, int>`), wrap the type in an extra set of parentheses:

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
```

Alternatively, use type aliases:

```cpp
using BoolIntPair = std::pair<bool, int>;
MOCK_METHOD(BoolIntPair, GetPair, ());
```

### Mocking Private or Protected Methods

Declare all `MOCK_METHOD` calls in the `public:` section of your mock class, regardless of the access level in the base class. This enables GoogleMock to work seamlessly with methods of all access types.

### Mocking Overloaded Methods

You can mock overloaded functions by providing distinct mock method declarations matching each overload's signature. If you don't mock all overloads, consider using `using BaseClass::MethodName;` in the mock class to avoid hiding base class versions.

### Mocking Class Templates

Mock template classes by using `MOCK_METHOD` as usual within the template mock class.

### Mocking Non-Virtual Methods

GoogleMock supports mocking non-virtual methods using template-based dependency injection, where the mock and the real class share the same method signatures but are unrelated. Choose this pattern to inject mocks at compile-time.

### Alternative: Mocking Free Functions

You cannot mock free functions directly. Instead, introduce an interface wrapping these functions and mock the interface.

### Old-Style Macros

Legacy `MOCK_METHODn` macros are available but migrate to the generic `MOCK_METHOD` as it is more flexible and type-safe.

---

## Setting Expectations and Configuring Behavior

Expectations define which mock methods should be called, how often, with which arguments, and what behavior to exhibit.

### `EXPECT_CALL`

Use `EXPECT_CALL(mock_object, Method(matchers...))` to declare expected calls.

Example:
```cpp
EXPECT_CALL(mock_turtle, Forward(100))
    .Times(AtLeast(1))
    .WillOnce(Return())
    .WillRepeatedly(Return());
```

### Available Clauses for `EXPECT_CALL`

- `.With(multi_arg_matcher)`: Match all arguments as a tuple.
- `.Times(cardinality)`: Specify how many times the call is expected.
- `.InSequence(sequence...)`: Enforce ordering of calls.
- `.After(expectations...)`: The call occurs after specified expectation(s).
- `.WillOnce(action)`: Specify behavior for a single call.
- `.WillRepeatedly(action)`: Behavior for all subsequent calls.
- `.RetiresOnSaturation()`: Expectation becomes inactive after matching its number of calls.

### Cardinalities

Some common cardinalities:
- `Exactly(n)` or `n`: Called exactly n times.
- `AtLeast(n)`: Called at least n times.
- `AtMost(n)`: Called at most n times.
- `AnyNumber()`: Called any number of times.
- `Between(m, n)`: Called between m and n times.

### Setting Default Actions with `ON_CALL`

`ON_CALL(mock_object, Method(matchers...))` sets the default behavior of a mock method when called, without requiring that the method must be called. It uses `.WillByDefault(action)` to specify behavior.

This is useful for common behaviors in test fixtures where you do not need to verify the call.

Example:
```cpp
ON_CALL(mock_turtle, GetX())
    .WillByDefault(Return(10));
```

Unmatched calls consult the default action.

### Matchers

Matchers specify expected argument values and can be simple values or sophisticated predicates (e.g., `_` for wildcard, `Ge(5)` for greater equal 5). Use the built-in [Matchers Reference](reference/matchers.md) to explore capabilities.

### Tips for `EXPECT_CALL` and `ON_CALL`

- Use `ON_CALL` to specify behavior without verification; use `EXPECT_CALL` to verify calls.
- Expect that expectations are set before mock usage.
- Use sequences or `.RetiresOnSaturation()` to control call ordering and lifetime.
- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Use `StrictMock<T>` to treat unexpected calls as failures.

---

## Using Mocks in Tests

Basic workflow for using mocks:

1. Include GoogleMock headers and import namespace:
```cpp
#include <gmock/gmock.h>
using ::testing::AtLeast;
```

2. Define your mock class as above.
3. Create instances:
```cpp
MockTurtle turtle;
```

4. Set up expectations:
```cpp
EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
```

5. Inject mocks into code under test.
6. Run your test.

Example:
```cpp
TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;
  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

If expectations are violated (e.g., too few or wrong calls are made), GoogleMock produces detailed errors to help debug.

---

## Advanced Usage

### Delegating Calls

Mocks can delegate calls to fakes, real objects, or parent classes to reuse behavior while still allowing verification. Use `ON_CALL` with lambdas to forward calls.

### Controlling Call Order and Partial Orders

Use `InSequence` or `Sequence` and `.InSequence()` or `.After()` clauses to enforce strict or partial orders on method calls.

### Handling Move-Only Types

GoogleMock supports mocking methods that accept or return move-only types such as `std::unique_ptr`. Use lambdas inside `.WillOnce()` or `.WillRepeatedly()` to create and return new objects on each call.

### Verifying Mocks Early

Call `Mock::VerifyAndClearExpectations(&mock_object)` to force verification before destruction, useful for heap-allocated mocks.

### Controlling Uninteresting Calls

Adjust verbosity and use `NiceMock`, `NaggyMock`, or `StrictMock` wrappers to control warnings or errors on calls without expectations.

---

## Common Pitfalls & Best Practices

- Always mock methods in `public:` sections of mocks.
- Set expectations before exercising mocks.
- Avoid over-specifying expectations to reduce test brittleness.
- Use default actions (`ON_CALL`) to avoid noisy warnings.
- Use `.RetiresOnSaturation()` in sequences to avoid unexpected over-saturation errors.
- Beware of non-virtual destructors; this can cause leaks and test failures.
- When mocking overloaded methods, disambiguate calls with `Const()` or specialized matchers.

---

## Troubleshooting

If your expectations are not met or unexpected calls occur:

- Run tests with `--gmock_verbose=info` to get detailed call traces.
- Verify that `EXPECT_CALL` and `ON_CALL` are placed before mock usage.
- Use `NiceMock` to suppress warnings on uninteresting calls.
- Confirm that your mocks have virtual destructors.
- For complex behaviors, break down expectations and isolate failing calls.

---

## Summary

GoogleMock lets you create fully functional mock classes for unit testing C++ code by using the `MOCK_METHOD` macro to define mock methods matching real interfaces. You then specify expectations and behaviors via `EXPECT_CALL` (verification) and `ON_CALL` (default behavior). Mocks can be injected into your code under test to verify interactions precisely and flexibly. Advanced features such as call ordering, delegation, and move-only type support provide powerful tools to build robust and maintainable tests.

---

For more detailed recipes and examples, please see:

- [Mocking Reference](reference/mocking.md)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](reference/actions.md)

---

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googlemock/include/gmock/gmock-spec-builders.h", "range": "1-257"},{"path": "docs/reference/mocking.md", "range": "1-1630"}]} />