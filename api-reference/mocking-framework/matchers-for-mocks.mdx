---
title: "Matchers and Advanced Matching for Mocks"
description: "A catalogue of standard and advanced matchers provided by GoogleMock for validating call arguments in expectations. Explains matcher composition, custom matchers, and advanced cases for flexible mock verification."
---

# Matchers and Advanced Matching for Mocks

GoogleMock offers a comprehensive catalogue of matchers that allow you to validate call arguments efficiently and flexibly when setting expectations on mock methods. This page catalogues both standard and advanced matchers, explains how to compose them, and guides you in creating custom matchers to handle complex verification scenarios.

---

## Overview

When using GoogleMock to write tests, validating that mock functions are called with correct arguments is crucial. Matchers are the key facility enabling this: they act as predicates describing how each argument should be matched. This page presents the powerful built-in matchers, how to combine them logically, and how to extend the framework by writing custom matchers for more specialized needs.

Matchers make your tests robust and expressive by allowing you to specify constraints on arguments at varying granularities — from simple equality to evaluating complex invariants across multiple arguments.

---

## Standard Matchers Catalog

GoogleMock includes a rich set of standard matchers for everyday needs:

- **Wildcard Matcher**:
  - `_` — Matches any value, effectively a "don't care" filter.
- **Value Matchers**:
  - `Eq(value)`, `Ne(value)`, `Lt(value)`, `Le(value)`, `Gt(value)`, `Ge(value)` — simple relational matchers.
- **Floating-Point Matchers**:
  - `FloatEq(value)`, `DoubleEq(value)`, `FloatNear(value, max_abs_error)`, supporting approximate numeric matches with accuracy controls.
- **String Matchers**:
  - `StrEq`, `StrNe`, `StrCaseEq`, `StrCaseNe` — for comparing C-style strings with or without case sensitivity.
  - `HasSubstr(substring)`, `StartsWith(prefix)`, `EndsWith(suffix)` — for checking substrings and prefixes/suffixes.
- **Pointer Matchers**:
  - `IsNull()`, `NotNull()`, `Pointee(matcher)`, `Pointer(matcher)` — to match raw and smart pointers.
- **Container Matchers**:
  - `ElementsAre(...)`, `UnorderedElementsAre(...)`, `Contains(matcher)`, `Each(matcher)` — for element-wise and container-content checks.
  - `SizeIs(matcher)`, `BeginEndDistanceIs(matcher)` — to validate container sizes using another matcher.
- **Tuple and Pair Matchers**:
  - `Pair(first_matcher, second_matcher)`, `Key(matcher)` — often used to check map elements.
- **Logical Combinators**:
  - `AllOf(...)`, `AnyOf(...)`, `Not(matcher)` — to compose matchers into complex predicates.

### Example: Using Standard Matchers in EXPECT_CALL

```cpp
using ::testing::_;
using ::testing::Gt;
using ::testing::HasSubstr;

EXPECT_CALL(mock_object, SetValue(Gt(5)));  // Arg must be > 5
EXPECT_CALL(mock_object, PrintMessage(HasSubstr("warning")));  // Arg contains "warning"
```

These built-in matchers ensure your tests are readable and generate helpful error messages on failure.

---

## Matcher Composition

Matchers can be combined to express more complex constraints on arguments:

- **AllOf(m1, m2, ...)** — succeeds only if all contained matchers match.
- **AnyOf(m1, m2, ...)** — succeeds if any one matcher matches.
- **Not(m)** — negates a matcher.

This composability allows validation of intricate call argument conditions.

### Example: Composite Matcher Usage

```cpp
EXPECT_CALL(mock, DoSomething(AllOf(Gt(5), Not(Eq(10)))));
```

The above expects `DoSomething()` to be called with an argument greater than 5 and not equal to 10.

---

## Multi-Argument Matching with `With()`

GoogleMock supports matching multiple arguments together as a whole via the `.With()` clause in `EXPECT_CALL` and `ON_CALL`.

- `.With(multi_argument_matcher)` restricts the expectation to calls where all arguments collectively satisfy the provided matcher.
- The matcher must accept a tuple of the argument types: `Matcher<std::tuple<A1, ..., An>>`.
- GoogleMock provides some built-in 2-tuple matchers like `Lt()`, `Eq()`, etc., to facilitate this.

### Example: Using `.With()` to Validate Inter-Argument Relationships

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // Expects first argument < second argument
```

You can also use `Args<k1, ..., kn>(m)` to match a subset of arguments as a tuple.

---

## Custom Matchers

If the built-in matchers do not fully satisfy your test's needs, you can write custom matchers using one of the following approaches:

### 1. Using the MATCHER and MATCHER_P Macros

These macros let you quickly define simple and parameterized matchers without boilerplate.

**Basic Custom Matcher Example:**

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

// Usage:
EXPECT_CALL(mock, Method(IsEven()));
EXPECT_THAT(value, IsEven());
```

If you want more control over the failure message, you can stream additional context using the special `result_listener` variable:

```cpp
MATCHER(IsEven, "") {
  if (arg % 2 == 0) return true;
  *result_listener << "which has remainder " << (arg % 2);
  return false;
}
```

### Parameterized Matcher Example:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return arg % divisor == 0;
}

// Usage
EXPECT_THAT(value, IsDivisibleBy(3));
```

### 2. Implementing Matcher Interfaces

For more complex matchers or higher reusability, implement the matcher interface directly:

- Provide a class with member functions:
  - `bool MatchAndExplain(const T& value, MatchResultListener* listener) const`
  - `void DescribeTo(std::ostream* os) const`
  - `void DescribeNegationTo(std::ostream* os) const`
- Wrap the implementation into a matcher using `testing::Matcher<T>`.

This approach gives you full control over matching behavior and descriptions.

---

## Practical Tips and Best Practices

- **Prefer using built-in matchers** whenever possible; they are optimized and integrate well with failure messages.
- **Compose matchers** with `AllOf`, `AnyOf`, `Not` to express complex logic cleanly.
- **Use `With()` clause** to match argument tuples, especially when argument relationships matter.
- **When writing custom matchers, keep them side-effect free.** Matchers may be invoked multiple times unpredictably.
- **Provide clear `DescribeTo()` and `DescribeNegationTo()` messages** in custom matchers to aid debugging.
- Use parameterized matchers to avoid boilerplate and improve test readability.
- For multi-argument relationships, consider writing predicates or custom composite matchers.

---

## Common Pitfalls and Troubleshooting

- **Matcher does not match as expected:** Ensure the matcher type correctly corresponds to the argument type. Use `SafeMatcherCast<T>()` if necessary.
- **Overly strict expectations cause brittle tests:** Avoid over-specifying arguments unless necessary.
- **Multiple `With()` clauses in one expectation:** `.With()` can be used at most once and must be the first clause.
- **Custom matcher returns incorrect messages:** Use `result_listener` or add descriptive `DescribeTo` messages.
- **Matching pointers needs care:** Use `Pointee()` to check pointed-to values safely, avoiding null pointer dereferencing.

---

## Example: Combining Matchers in an EXPECT_CALL

```cpp
using ::testing::AllOf;
using ::testing::AnyOf;
using ::testing::Not;
using ::testing::Gt;
using ::testing::Lt;
using ::testing::_;

EXPECT_CALL(mock, ProcessData(
    AllOf(Gt(0), Not(Lt(100)))),  // arg must be in range [1, 99]
    AnyOf(Eq("start"), Eq("stop")),     // 2nd arg is "start" or "stop"
    _                                    // 3rd arg can be anything
);
```

---

## Advanced Use Cases

- Creating custom matchers that hold state or have parameters
- Matching containers and tuples recursively
- Matching STL containers with matchers like `ElementsAre`, `UnorderedElementsAre`
- Writing matchers that explain mismatch with detailed diagnostics
- Using matchers in multi-threaded or asynchronous tests

Refer to the linked sections below for in-depth understanding and recipes.

---

## Additional Resources

- [Matchers Reference](/docs/reference/matchers.md): Complete list of built-in matchers with detailed behavior.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers): Extensive guide on writing matchers and tips on usage.
- [Using Matchers](/api-reference/advanced-assertions-and-matching/using-matchers): Integration tips with assertions and mocks.

---

## Summary

Matchers form the backbone of argument validation in GoogleMock. With a powerful library of built-in matchers, composable logical operators, and support for custom matchers, GoogleMock empowers you to flexibly specify the exact call argument constraints you need. Mastering matchers helps you write clear, robust, and maintainable mock-based tests.

---

<Callout title="See Also">
- [GoogleMock: Defining and Using Mock Objects](/api-reference/mocking-framework/defining-and-using-mocks)
- [Setting Expectations with EXPECT_CALL](/api-reference/mocking-framework/expectations-actions-cardinalities)
- [Writing Custom Matchers (gMock Cookbook)](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers)
- [Matchers Reference](/docs/reference/matchers.md)
</Callout>