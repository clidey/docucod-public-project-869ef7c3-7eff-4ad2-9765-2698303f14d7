---
title: "Expectations, Actions, and Cardinalities"
description: "Detailed reference for the core workflow of GoogleMock: setting up expectations (EXPECT_CALL, ON_CALL), defining actions (returning values, invoking functions), and asserting call frequency using cardinalities. Provides illustrative examples and options for specifying default and sequence behaviors."
---

# Expectations, Actions, and Cardinalities in GoogleMock

This document details the core workflow components of GoogleMock: how to define expectations with `EXPECT_CALL` and `ON_CALL`, specify mock behaviors using actions, and control the expected number of mock invocations through cardinalities. Through clear explanations, practical examples, and guidance on usage patterns, this page empowers you to harness the full power of GoogleMock to verify code interactions effectively.

---

## 1. Overview of Expectations

In GoogleMock, *expectations* describe how you expect your mock methods to be called during a test. Setting the right expectations is crucial to verifying the correctness of your code's interaction with its dependencies.

### Key Concepts:

- **Expectations** are set using the macro `EXPECT_CALL(mock_object, method(matchers))`.
- Expectations specify the *arguments* a method must receive and the *frequency* of calls.
- Expectations include *actions* to define what a method should do when called.
- You can also set default behaviors with `ON_CALL` that do not impose call count constraints.

### Example of a simple expectation:

```cpp
using ::testing::Return;

// A mock turtle move is expected to be called once and return 42.
EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(42));
```


## 2. Defining Mock Method Expectations

### Syntax of `EXPECT_CALL`

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)     // Optional, multi-argument matcher
    .Times(cardinality)          // Optional, how many times to expect
    .InSequence(seq1, seq2, ...) // Optional, restrict call order
    .After(other_expectations)   // Optional, set call ordering dependencies
    .WillOnce(action)            // Optional, action for one call
    .WillRepeatedly(action)      // Optional, action for subsequent calls
    .RetiresOnSaturation();      // Optional, retire expectation after used up
```

- `mock_object`: Your mock instance.
- `Method`: The method name to expect.
- `matchers...`: Argument matchers defining expected argument values.

### Argument Matching

- Matchers can be specific values or placeholders like `_` to match any value.
- Multiple arguments can be matched individually.
- A multi-argument matcher can match all arguments as a tuple (via `.With()`).

### Specifying Call Cardinalities

Cardinalities specify *how many times* an expected call should occur. You can specify cardinalities with:

| Cardinality             | Meaning                                         |
|-------------------------|------------------------------------------------|
| `AnyNumber()`           | Call may occur any number of times              |
| `AtLeast(n)`            | Call occurs at least *n* times                   |
| `AtMost(n)`             | Call occurs at most *n* times                    |
| `Between(m, n)`         | Call occurs between *m* and *n* times           |
| `Exactly(n)` or simply `n` | Call occurs exactly *n* times                    |

Omitting `.Times()` causes GoogleMock to infer the cardinality based on `WillOnce()` and `WillRepeatedly()` clauses:

- No `WillOnce` or `WillRepeatedly`: cardinality defaults to exactly one (`Times(1)`).
- `n` `WillOnce` clauses, no `WillRepeatedly`: inferred as exactly *n*.
- `n` `WillOnce` clauses plus one `WillRepeatedly` clause: inferred as at least *n*.

### Example: Setting cardinalities

```cpp
EXPECT_CALL(mock_turtle, Forward(_))  // Any argument accepted
    .Times(AtLeast(2))
    .WillRepeatedly(Return());
```

### Common Pitfalls

- Calling a method more times than the upper bound causes test failures.
- Calls fewer than the lower bound also trigger failures at verification.
- `Times(0)` forbids calls and will fail if the method is called.


## 3. Specifying Actions for Mock Methods

Actions define *what* a mock method does when it is called. Without actions, GoogleMock provides default return values (0, `false`, or default-constructed values).

### Common Action Methods

- `WillOnce(action)`: Specify action for exactly one call.
- `WillRepeatedly(action)`: Specify action for all subsequent calls after `WillOnce`s.

### Examples of actions

#### Returning values

```cpp
using ::testing::Return;
EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(3))
    .WillOnce(Return(5))
    .WillRepeatedly(Return(7));
```
Every call returns the next specified value; after the `WillOnce`s finish, the last action is repeated.

#### Invoking custom functions or lambdas

```cpp
using ::testing::Invoke;

int ComputeDistance(int x) { return x * 2; }

EXPECT_CALL(mock_calc, Distance(_))
    .WillOnce(Invoke(ComputeDistance));
```

You can use lambdas:

```cpp
EXPECT_CALL(mock_obj, Foo(_))
    .WillOnce([](int n) { return n * n; });
```

#### Setting output parameters

```cpp
using ::testing::SetArgPointee;
EXPECT_CALL(mock_mutator, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

The `DoAll()` action executes multiple actions sequentially; only the last action's return value is used.

### Action Ownership and Evaluation

- `WillOnce()` actions are evaluated once at expectation setup; repeated calls reuse the stored action.
- For move-only types or stateful actions, use `WillOnce()`.
- `WillRepeatedly()` applies to calls after all `WillOnce()` actions are consumed.

### Tips

- Use `ReturnRef(var)` to return a reference.
- Use `ReturnPointee(ptr)` to return the pointee of a pointer at call time.
- Instantiate complex behaviors with lambdas for inline custom logic.


## 4. Using `ON_CALL` to Define Default Behavior

`ON_CALL` setups specify behaviors for mock methods but **do not set expectations** on call frequency. They define what happens when a method is called but without requiring the method to be called.

```cpp
ON_CALL(mock_obj, Method(_))
    .WillByDefault(Return(42));
```

Use `ON_CALL` for common behaviors shared across tests or when behavior is needed without expectations.

---

## 5. Cardinalities: Controlling Expected Call Counts

Cardinalities are objects expressing call frequency constraints. They are used with `.Times()` and elsewhere to shape your test's intent about invocation counts.

### Built-in Cardinality Functions

- `AnyNumber()` - allows zero or more calls
- `AtLeast(n)` - at least n calls
- `AtMost(n)` - at most n calls
- `Between(m,n)` - call counts between m and n inclusive
- `Exactly(n)` - exactly n calls

Example usage:

```cpp
EXPECT_CALL(mock, Foo())
    .Times(AtLeast(3));

EXPECT_CALL(mock, Bar())
    .Times(Exactly(1));
```

### Cardinality Interface

You can define your own cardinality by implementing the `CardinalityInterface`. It must:

- Return if a given call count *satisfies* the cardinality.
- Return if a call count *saturates* the cardinality (reaches upper bound).
- Provide a textual description.

### Examples

```cpp
EXPECT_CALL(mock, Foo())
    .Times(Between(2, 5));

EXPECT_CALL(mock, Foo())
    .Times(AnyNumber());
```


## 6. Ordering and Sequences

### Enforcing Call Order Using `InSequence` and `After`

If your test expects calls to occur in a particular order, use:

- **`InSequence`** scope object: Expectations declared within will be called in order.

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(mock, Foo(1));
  EXPECT_CALL(mock, Foo(2));
}
```

- **`Expectation` objects and `After()` clause:** Allows specifying partial orders.

```cpp
Expectation e1 = EXPECT_CALL(mock, Foo(1));
EXPECT_CALL(mock, Foo(2)).After(e1);
```

### Partial Orders With Sequences

Assign expectations to multiple `Sequence` objects to express complex partial orderings.

## 7. Managing Expectation Lifetimes

By default, expectations stay active even after reaching their upper call count limit, which can cause errors on additional calls.

Use `.RetiresOnSaturation()` to retire the expectation once it reaches its maximum call count.

```cpp
EXPECT_CALL(mock, Foo(42))
    .Times(2)
    .RetiresOnSaturation();
```

## 8. Handling Uninteresting Calls

Calls to mock methods with no matching `EXPECT_CALL` are *uninteresting calls*. By default, GoogleMock:

- Issues warnings on uninteresting calls (naggy behavior).
- Returns default values for such calls.

Use the wrappers `NiceMock<>`, `NaggyMock<>` (default), and `StrictMock<>` to control this behavior:

- `NiceMock`: Suppresses warnings for uninteresting calls.
- `StrictMock`: Treats uninteresting calls as errors.

For more details see the [gMock Cookbook section on Nice, Strict, and Naggy mocks](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#TheNiceStrictandNaggy).


## 9. Guidance, Tips, and Best Practices

- Prefer using `ON_CALL` to set default behavior, and `EXPECT_CALL` only where call expectations need to be verified.
- Avoid over-constraining tests by setting too many `EXPECT_CALL`s; over-specification leads to brittle tests.
- Use argument matchers like `_` to ignore irrelevant parameters.
- Use cardinalities such as `AnyNumber()` to avoid warnings on uninteresting calls.
- For sequential behaviors, leverage `InSequence` or `After()` to specify call order.
- Use `.RetiresOnSaturation()` where expectations are only relevant until met.
- Watch for excessive or missing actions compared to the declared `Times()` values; GoogleMock will warn, helping avoid mismatches.
- Customize actions with lambdas or functors for complex behaviors.
- Use `ReturnRef()` and `ReturnPointee()` for returning references or live values.

---

## 10. Examples

### Simple Mock Method Call Expectation

```cpp
EXPECT_CALL(foo, GetValue(42))
    .Times(Exactly(2))
    .WillRepeatedly(Return(100));

foo.GetValue(42);  // returns 100
foo.GetValue(42);  // returns 100
// third call would cause an error
```

### Setting Default Behavior Without Expectation

```cpp
ON_CALL(foo, GetValue(_))
    .WillByDefault(Return(0));
```

All calls to `GetValue` not matched by an `EXPECT_CALL` return 0 without failing.

### Specifying Order with `InSequence`

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(foo, Start());
  EXPECT_CALL(foo, Process(1));
  EXPECT_CALL(foo, Process(2));
  EXPECT_CALL(foo, Finish());
}
```

The above expectation requires these calls to occur strictly in this order.

### Complex Action Example

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 10; })
    .WillRepeatedly(Return(42));
```

First call returns 10×input argument; subsequent calls return 42.


---

## 11. Troubleshooting Common Issues

- **Excessive calls error:** Happens when calls exceed the upper bound in `.Times()`. Check your call counts or adjust cardinalities.
- **Uninteresting calls warnings:** Indicates mock method called without an expectation. Add `EXPECT_CALL(...).Times(AnyNumber())` as a catch-all or use `NiceMock`.
- **Too many or too few actions warnings:** Ensure the number of `WillOnce()` matches intended call count; add `WillRepeatedly()` if calls continue beyond `WillOnce()`.
- **Call order violations:** Use `InSequence` or `After` clauses appropriately to enforce expected call order.
- **Mock object leaks:** Use `Mock::AllowLeak()` to prevent leak reporting if intentional.

Refer to the [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) and [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) for detailed guidance.


---

## 12. Related References

- [Using Matchers](reference/matchers.md) — for argument matching.
- [Using Actions](docs/reference/actions.md) — detailed list of built-in and custom actions.
- [Mocking Reference](reference/mocking.md) — detailed overview of expectation syntax and semantics.
- [gMock Cookbook](docs/gmock_cook_book.md) — practical recipes and advanced mocking patterns.
- [Strictness and Mock Behavior Modes](docs/gmock_cook_book.md#NiceStrictNaggy) — controlling warnings and errors on uninteresting calls.
- [GoogleTest Primer](guides/getting-started/googlemock-intro.md) — introduction to mocks and expectations.


<Source url="https://github.com/google/googletest" branch="main" paths='[{"path": "docs/gmock_cook_book.md", "range": "1-615"},{"path": "docs/reference/mocking.md", "range": "1-853"},{"path": "googlemock/include/gmock/gmock-cardinalities.h", "range": "1-97"},{"path": "googlemock/src/gmock-cardinalities.cc", "range": "1-131"}]' />