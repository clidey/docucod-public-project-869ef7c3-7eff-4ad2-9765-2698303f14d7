---
title: "Actions and Stubbing Behavior"
description: "Reference to built-in and custom actions for specifying mock return values, side effects, or behaviors. Includes usage of ON_CALL, Invoke, and advanced action templates."
---

# Actions and Stubbing Behavior

This page details the built-in and custom actions you can specify in GoogleMock to control mock method behaviors when they are invoked. It covers how to use `ON_CALL` for default behaviors, `EXPECT_CALL` for explicit expectations, and advanced action templates including `Invoke` and composite actions.

---

## Overview of Actions

Actions determine what happens when a mock method is called — what values it returns, what side effects it produces, or how it delegates to other functions.

Use actions to:

- Return fixed or computed values
- Modify output parameters
- Perform complex side effects
- Delegate calls to other functions, functors, or lambdas

All actions are in the `::testing` namespace and are typically specified via methods chained from `EXPECT_CALL()` or `ON_CALL()`.

---

## Setting Default Behavior: ON_CALL

`ON_CALL(mock_object, Method(matchers))` lets you specify the default action for a mock method call that matches given argument matchers *without* asserting the method must be called.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);        // Required
```

- `.With(...)` restricts the specification to argument tuples matching the multi-argument matcher.
- `.WillByDefault(...)` specifies the default action to perform on matching calls.


### Behavior

- Default actions are used when no `EXPECT_CALL` explicitly handles a call.
- Later `ON_CALL` statements override earlier ones for matching arguments.
- Useful to set common fallback behavior, often in test fixture setup or mock constructor.


### Example

```cpp
using ::testing::_;
using ::testing::Return;

ON_CALL(foo, GetValue(_))
    .WillByDefault(Return(42));

EXPECT_CALL(foo, GetValue(5));  // Specific expectations
```

In this example, calling `foo.GetValue(5)` activates the expectation; calls with other arguments return 42 by default.

---

## Setting Expectations: EXPECT_CALL

`EXPECT_CALL(mock_object, Method(matchers))` sets expectations that the mock method will be called with arguments matching those matchers and specifies what should happen on each call.

### Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // At most once
    .Times(cardinality)            // At most once
    .InSequence(sequences...)      // Any number
    .After(expectations...)        // Any number
    .WillOnce(action)              // Any number
    .WillRepeatedly(action)        // At most once
    .RetiresOnSaturation();        // At most once
```

### Clauses Breakdown

- **With**: Restricts matching to argument tuples satisfying a composite matcher.
- **Times**: Specifies how many times the call is expected (e.g., `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`).
- **InSequence**: Associates the expectation with one or more `Sequence` objects to enforce relative order.
- **After**: Indicates this expectation should occur after specified other expectations.
- **WillOnce**: Defines the action for a single invocation; multiple calls chain actions in order.
- **WillRepeatedly**: Defines the action for all subsequent invocations after `WillOnce`s are exhausted.
- **RetiresOnSaturation**: Deactivates (retires) the expectation once its `Times` limit is hit.


### Behavior

- `EXPECT_CALL` defines both an expectation and the behavior.
- When multiple expectations match a call, the *last* matching expectation takes precedence.
- Call order can be enforced with sequences or explicit dependency using `After`.

### Example

```cpp
using ::testing::Return;

EXPECT_CALL(foo, Compute(5))
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));

foo.Compute(5); // returns 10
foo.Compute(5); // returns 20
foo.Compute(5); // returns 30
foo.Compute(5); // returns 30
```

Here `foo.Compute(5)` is expected exactly 3 times, with specified return values. Additional calls beyond times will cause a test failure unless matched by another expectation.

---

## Commonly Used Actions

GoogleMock provides many built-in actions for different purposes.

### Returning Values

| Action                              | Description                                             |
| ---------------------------------- | ------------------------------------------------------- |
| `Return(value)`                    | Returns a specified value (evaluated at expectation set time). |
| `ReturnRef(variable)`              | Returns a reference to a variable.
| `ReturnPointee(pointer)`           | Returns the value pointed to by a pointer (evaluated at call time).
| `ReturnNew<T>(args...)`            | Returns a new object created each time.
| `ReturnNull()`                    | Returns a null pointer.
| `DoDefault()`                      | Uses the default action set by `ON_CALL` or built-in.

### Side Effects and Argument Manipulation

| Action                             | Description                                           |
| --------------------------------- | ----------------------------------------------------- |
| `SetArgPointee<N>(value)`         | Assigns `value` to the object pointed to by the N-th argument.
| `SetArrayArgument<N>(first, last)`| Copies elements to the array pointed by N-th argument.
| `SaveArg<N>(pointer)`             | Copies N-th argument to pointed location.
| `DeleteArg<N>()`                  | Deletes a pointer argument.

### Composite and Delegating Actions

| Action                          | Description                                         |
| ------------------------------ | --------------------------------------------------- |
| `DoAll(a1, a2, ..., aN)`        | Runs actions sequentially, returns the last's result.
| `Invoke(f)`                     | Calls a callable with the same arguments as the mock method.
| `InvokeWithoutArgs(f)`          | Calls a callable without passing arguments.
| `InvokeArgument<N>(args...)`    | Invokes N-th mock function argument (a callable) with provided args.
| `IgnoreResult(a)`               | Runs action ignoring its return value.
| `WithArg<N>(a)`                 | Passes only the N-th argument to action `a`.
| `WithArgs<N1,...,Nk>(a)`        | Passes selected arguments to action `a`.
| `WithoutArgs(a)`                | Runs `a` with no arguments.

---

## Using a Function, Functor, or Lambda as an Action

You can specify any callable matching the mock method's signature or compatible with it as an action, allowing flexible behavior:

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce([](int n) { return n * 2; });

EXPECT_CALL(mock, Process(_))
    .WillRepeatedly(Invoke(&SomeFunction));
```

Also, you can bind extra arguments or adapt argument lists using `Invoke`, `WithArg`, and related adapters.

---

## Action Ordering and Default Behaviors

- `WillOnce()` clauses are executed in the sequence they appear.
- `WillRepeatedly()` executes once all `WillOnce()` actions are exhausted.
- If no `ON_CALL` or `EXPECT_CALL` matches, GoogleMock performs built-in default action.
- Late `EXPECT_CALL`s override earlier ones for calls matching their arguments.

---

## Practical Tips & Best Practices

- Use `ON_CALL` to set default behavior, especially for passthroughs or common returns.
- Use `EXPECT_CALL` only when you want to verify a call is made.
- Avoid setting expectations on overloaded methods without specifying argument types precisely.
- Order `EXPECT_CALL`s carefully; later ones have higher priority.
- Use `RetiresOnSaturation` to disable a saturated expectation, enabling fallback expectations.
- Combine `SetArgPointee` and `Return` with `DoAll()` to mock methods with output parameters and a return value.
- Prefer lambdas or functors for complex or move-only arguments/actions.

---

## Troubleshooting

- If mock methods always return default values, verify `ON_CALL` or `EXPECT_CALL` with `WillByDefault` or `WillOnce` respectively is set.
- If you get warnings about uninteresting calls on mock methods, either add an `EXPECT_CALL` with `Times(AnyNumber())` or use `NiceMock` for that mock.
- Overly strict `EXPECT_CALL` can cause brittle tests; balance constraints with test stability.
- Use `--gmock_verbose=info` flag while running tests to get detailed tracing and help diagnose matching failures.
- If `WillOnce(Return(std::move(...)))` fails repeatedly, ensure unique objects are returned or use lambdas to create new objects.

---

## Advanced Action Templates

### Invoking Callable Arguments

Invoke a mock function’s callable argument using `InvokeArgument<N>(args...)`:

```cpp
EXPECT_CALL(mock, DoWork(_, _))
    .WillOnce(InvokeArgument<1>(5));  // Calls the 2nd argument as a callable.
```

Use `std::ref()` inside arguments for references to avoid copying.

### Delegating to a Real or Fake Object

You can use `ON_CALL` or `EXPECT_CALL` with `Invoke` to delegate to existing implementation methods, allowing partial mocking or chaining of behaviors.

---

## Example: Complete Use of ON_CALL and EXPECT_CALL

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, Bar, (int x), (override));
};

MockFoo foo;

// Default behavior: return -1 for any Bar(x) call.
ON_CALL(foo, Bar(_))
    .WillByDefault(Return(-1));

// Expect Bar to be called with 10 exactly twice.
EXPECT_CALL(foo, Bar(10))
    .Times(2)
    .WillOnce(Return(100))
    .WillOnce(Return(200));

EXPECT_CALL(foo, Bar(5))
    .WillRepeatedly(Return(50));

EXPECT_EQ(foo.Bar(5), 50);
EXPECT_EQ(foo.Bar(10), 100);
EXPECT_EQ(foo.Bar(10), 200);
EXPECT_EQ(foo.Bar(5), 50);
EXPECT_EQ(foo.Bar(1), -1);  // Matches ON_CALL default
```

---

## Allowing Uninteresting Calls and Strictness

GoogleMock by default warns about uninteresting calls (calls to mock methods without expectations), but does not consider them test failures. You can:

- Use `NiceMock` to silence such warnings.
- Use `StrictMock` to make them failures.

This allows tuning the granularity of the mock’s strictness according to your testing needs.

---

## Related Links

- [Mocking Basics](gmock_for_dummies.md) — Introductory tutorial on mocking
- [Actions Reference](actions.md) — Detailed list of built-in actions
- [Mocking Reference](mocking.md) — Core macros and classes for mocking
- [Matchers Reference](matchers.md) — Argument matching techniques
- [Mocking Cookbook](gmock_cook_book.md) — Recipes for advanced mocking patterns

<Source url="https://github.com/google/googletest" paths={[{"path": "docs/reference/mocking.md", "range": "all"},{"path": "docs/gmock_cook_book.md", "range": "#Setting-the-Default-Actions#Using-a-Function-Functor-or-Lambda-as-an-Action"},{"path": "docs/reference/actions.md", "range": "all"}]} branch="main" />