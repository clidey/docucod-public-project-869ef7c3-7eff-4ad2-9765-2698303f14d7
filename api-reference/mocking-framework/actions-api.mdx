---
title: "Actions and Return Strategies"
description: "Describes the standard and advanced actions available for mock methods, including simple value return, exception throwing, invocation forwarding, and parameter manipulation. Provides API documentation for action helpers to guide behavior definition."
---

# Actions and Return Strategies

This document details the foundation and advanced usage of **actions** in GoogleMock's mocking framework. It covers the mechanisms by which mocked methods respond when called, including simple returns, throwing exceptions, forwarding invocations, and manipulating parameters. Included is a comprehensive reference to action helpers that facilitate behavior definition, empowering you to customize mock responses precisely.

---

## Overview

When defining mock behaviors in GoogleMock, **actions** specify what happens when a mocked method is invoked. You can tailor a mock method to return fixed or computed values, throw exceptions, modify arguments, or even delegate execution. Understanding these actions is crucial to achieving realistic and expressive mock behaviors that reflect real-world scenarios.

This page focuses specifically on the kinds of actions you can attach to mocked methods and how to use them effectively in your tests.

---

## Basic Return Actions

### `Return(value)`
Sets the mock method to return a specified `value`. The value is copied or converted at the time the expectation is set, meaning subsequent changes to the original value do not affect the returned value.

```cpp
using ::testing::Return;
EXPECT_CALL(mock_obj, GetNumber())
    .WillOnce(Return(42));

int result = mock_obj.GetNumber();  // returns 42
```


### `ReturnRef(variable)`
Returns a reference to `variable`. The returned reference must remain valid during the mock’s usage.

```cpp
Bar bar_instance;
EXPECT_CALL(mock_obj, GetBar())
    .WillOnce(ReturnRef(bar_instance));

Bar& reference = mock_obj.GetBar();
```

### `ReturnPointee(ptr)`
Returns the value pointed to by the pointer `ptr` at call time, enabling dynamic return values that reflect current state.

```cpp
int dynamic_value = 10;
EXPECT_CALL(mock_obj, GetValue())
    .WillRepeatedly(ReturnPointee(&dynamic_value));

dynamic_value = 20;
EXPECT_EQ(mock_obj.GetValue(), 20);  // reflects updated value
```

---

## Throwing Exceptions

### `Throw(exception)`
Instead of returning a value, the mock method throws the specified copyable exception instance when called. This allows you to simulate error paths and test exception handling in your code.

```cpp
using ::testing::Throw;
EXPECT_CALL(mock_obj, DangerousMethod())
    .WillOnce(Throw(std::runtime_error("Failure occurred")));
```

<Warning>
This action requires exceptions to be enabled in your compiler and project settings.
</Warning>

---

## Composite Actions

Sometimes your mock method needs to perform side effects **and** return a value. GoogleMock provides composite actions for chaining multiple operations into one.

### `DoAll(a1, a2, ..., an)`
Executes all the actions `a1` through `an` sequentially each time the mock method is called. Only the return result of the last action `an` is used as the mock return value. The first `n-1` actions must return `void`.

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;

EXPECT_CALL(mock_obj, Compute(_))
    .WillOnce(DoAll(SetArgPointee<0>(42),  // Side effect: set output param
                    Return(true)));    // Return value
```

---

## Side Effect Actions

Mock methods often modify arguments passed by pointer or reference to simulate realistic behavior.

| Action                     | Description                                              |
| -------------------------- | -------------------------------------------------------- |
| `SetArgPointee<N>(value)`  | Sets the value pointed to by argument `N` to `value`.      |
| `SetArrayArgument<N>(first, last)` | Copies elements from `[first, last)` to the array pointed to by argument `N`. |
| `SetArgReferee<N>(value)`  | Assigns `value` to the variable referred by argument `N`.  |
| `SaveArg<N>(pointer)`      | Copies the value of argument `N` into `*pointer`.           |

```cpp
EXPECT_CALL(mock_obj, UpdateValue(_))
    .WillOnce(SetArgPointee<0>(123));
```

---

## Using Functions and Lambdas as Actions

GoogleMock allows you to use existing functions, member functions, functors, or lambdas as mock actions.

### `Invoke(function_or_functor)`
Calls the specified callable with the same arguments as the mocked method.

```cpp
int Add(int x, int y) { return x + y; }
EXPECT_CALL(mock_obj, Sum(_, _))
    .WillOnce(Invoke(Add));

EXPECT_EQ(mock_obj.Sum(3, 4), 7);
```

### `Invoke(object_ptr, &Class::method)`
Invokes a member function of a specified object.

```cpp
class Helper { public:
  bool Check(int x) { return x > 0; }
};
Helper helper;
EXPECT_CALL(mock_obj, IsValid(_))
    .WillOnce(Invoke(&helper, &Helper::Check));
```

### `InvokeWithoutArgs(callable)`
Calls a callable without passing any arguments, even if the mock method has arguments.

```cpp
bool AlwaysTrue() { return true; }
EXPECT_CALL(mock_obj, AnyMethod(_))
    .WillOnce(InvokeWithoutArgs(AlwaysTrue));
```

### `InvokeArgument<N>(args...)`
Invokes the `N`-th argument of the mock method call, which is expected to be a callable, with the provided `args...`.

```cpp
EXPECT_CALL(mock_obj, DoAsync(_, _))
    .WillOnce(InvokeArgument<1>(5));  // Calls the 2nd argument as a callback with 5
```

---

## Argument Selection Actions

GoogleMock supports calling actions with subsets or reordered arguments of the mocked method’s argument list.

| Action               | Description                                                  |
| -------------------- | ------------------------------------------------------------ |
| `WithArg<N>(action)` | Calls `action` with only the `N`-th argument of the mock method. |
| `WithArgs<N1,...>(action)` | Calls `action` with selected arguments `N1, N2, ...`.          |
| `WithoutArgs(action)` | Calls `action` with no arguments, ignoring all mock method arguments. |

```cpp
EXPECT_CALL(mock_obj, Process(_, _, _))
    .WillOnce(WithArgs<0, 2>(Invoke(&RealProcessor::Process)));
```

---

## Default and Fallback Actions

### `DoDefault()`
Executes the mock method’s default action, i.e., the action specified by `ON_CALL`, or the built-in default if none is set.

```cpp
ON_CALL(mock_obj, Foo()).WillByDefault(Return(5));
EXPECT_CALL(mock_obj, Foo()).WillOnce(DoDefault());
```

<Note>
`DoDefault()` cannot be used inside composite actions.
</Note>

### Built-in Default Actions

* **Void functions:** do nothing (empty return).
* **Bool:** return `false`.
* **Numeric types:** return `0`.
* **Pointer types:** return `nullptr`.
* **Default-constructible types (C++11+):** return default-constructed object.

You can override these for a given return type using `DefaultValue<T>::Set()`.

---

## Retiring Expectations

By default, expectations remain active until the test completes. Sometimes it is desirable to retire an expectation as soon as its expected calls are saturated, to avoid ambiguity or failures caused by overlapping expectations.

### `.RetiresOnSaturation()`
Instructs that the expectation will no longer match calls once its call count reaches its upper bound.

Example:

```cpp
EXPECT_CALL(mock_obj, Foo(42))
    .Times(2)
    .RetiresOnSaturation();

EXPECT_CALL(mock_obj, Foo(_))
    .Times(AnyNumber());
```

After two calls to `Foo(42)`, the second expectation will take over.

---

## Combining Multiple Behaviors

You can combine various actions to express complex behaviors, like returning a value **and** setting output parameters, or calling an internal handler while also recording data.

Example: Save an argument and return a value

```cpp
EXPECT_CALL(mock_obj, GetData(_, _))
    .WillOnce(DoAll(SaveArg<0>(&stored_key), Return(true)));
```

---

## Practical Tips & Best Practices

- **Use `ON_CALL` for default behavior:** Set general default actions with `ON_CALL`. Only set `EXPECT_CALL` for calls you intend to verify.

- **Chain multiple `WillOnce` actions:** Use multiple `WillOnce` clauses to specify different return values or actions across calls.

- **Order matters:** Newer expectations and actions override older ones.

- **Use `RetiresOnSaturation` to avoid sticky expectations:** This prevents expectations from lingering after the call count limit is reached.

- **Avoid overusing `EXPECT_CALL`:** Over-specification makes tests brittle. Prefer `ON_CALL` where you don’t care about call count.

- **Use lambdas or function objects for dynamic behavior:** When simple returned values are insufficient, implement custom logic.

- **Be mindful of side effects in actions:** Actions are invoked at call time, but `EXPECT_CALL` evaluates action parameters only once, so use lambdas to defer computation.

---

## Troubleshooting Common Issues

- Unintended default returns due to missing or exhausted actions: Always provide a `WillRepeatedly` or sufficient `WillOnce` clauses.

- Unexpected exceptions: Confirm `Throw()` is used intentionally with exceptions enabled.

- Compiler errors with complex actions: Use the generic form (`Invoke`) for functions and lambdas.

- Sticky expectations causing multiple matching failures: Use `RetiresOnSaturation()` or sequences.

---

## Quick Overview of Action Helpers API

| Helper Action             | Purpose                                      |
|--------------------------|----------------------------------------------|
| `Return(value)`          | Return a fixed value.                         |
| `ReturnRef(variable)`    | Return a reference.                           |
| `ReturnPointee(ptr)`     | Return value pointed by `ptr` at invocation.|
| `Throw(exception)`       | Throw an exception.                           |
| `DoAll(a1,...,an)`      | Perform multiple actions sequentially.       |
| `SetArgPointee<N>(value)`| Set output argument value at index N.         |
| `SetArrayArgument<N>(first,last)`| Copy array to argument pointer N.           |
| `Invoke(callable)`        | Call given function or functor.               |
| `InvokeWithoutArgs(f)`    | Call given function with no args.             |
| `InvokeArgument<N>(args...)`| Call the Nth argument (callable) with arguments. |
| `IgnoreResult(a)`         | Call action `a` but ignore its return value. |
| `WithArg<N>(a)`           | Call action `a` with argument N.               |
| `WithArgs<N1,...>(a)`     | Call action `a` with selected arguments.      |
| `WithoutArgs(a)`          | Call action `a` with no arguments.             |

---

## Related Documentation

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Recipes covering actions and more.
- [Mock Objects and Methods](https://google.github.io/googletest/api/gmock_mock_objects_and_methods.html) — Overview of mocks and expectations.
- [Matchers Reference](https://google.github.io/googletest/gmock_matchers.html) — For argument matching.
- [Expectations and Cardinalities](https://google.github.io/googletest/api/gmock_cardinalities.html) — Control call counts.

---

By mastering these actions, you will confidently customize your mock's behavior, allowing precise simulation of complex, real-world interactions during testing.