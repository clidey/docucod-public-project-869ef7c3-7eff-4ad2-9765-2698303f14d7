---
title: "Mock Objects and Method Expectations"
description: "Discover how to declare mock classes and methods using MOCK_METHOD macros. Learn to set up ON_CALL and EXPECT_CALL statements, chaining expectations, and managing default return values and behaviors."
---

# Mock Objects and Method Expectations

This chapter covers how to define mock classes and their methods with GoogleMock, using the `MOCK_METHOD` macro family. You will learn how to configure method behaviors and expectations with `ON_CALL` and `EXPECT_CALL` statements, how to chain multiple expectations, and manage default return values and behaviors effectively.

---

## Defining Mock Classes and Methods

To begin mocking in GoogleMock, you create a mock class that inherits from the interface or base class you want to mock. For each virtual method that you want to mock, you use the `MOCK_METHOD` macro, which generates the mocked method for you.

### Basic Usage of `MOCK_METHOD`

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(void, DoThis, (), (override));
  MOCK_METHOD(int, DoThat, (bool flag), (override));
};
```

- The first argument to `MOCK_METHOD` is the return type.
- The second is the method name.
- The third is a tuple with the method's parameter types.
- The optional fourth argument is a list of qualifiers, such as `const` and `override`.

If mocking a `const` method, add `(const, override)` for the last parameter. 

### Challenges with Complex Types

Types with commas, such as `std::pair` or `std::map`, need to be either:

- Wrapped in extra parentheses:

```cpp
MOCK_METHOD((std::pair<int, int>), GetPair, ());
MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
```

- Or defined with type aliases for clarity and compiling ease:

```cpp
using Pair = std::pair<int, int>;
MOCK_METHOD(Pair, GetPair, ());
```

### Visibility of Mock Methods

Always place `MOCK_METHOD` declarations in the `public:` section of your mock class, even if the method is `protected` or `private` in the base class. This allows `ON_CALL` and `EXPECT_CALL` to access the mock methods externally.

### Mocking Overloaded and Template Methods

Simply provide a separate `MOCK_METHOD` declaration for each overload or use type aliases and templates as necessary. To avoid hiding other overloads, bring them into scope via `using BaseClass::MethodName;`.

### Mocking Non-virtual Methods

GoogleMock can mock non-virtual methods when used in dependency injection scenarios where your mock class is unrelated to the real class but shares the same method signatures.

```cpp
class MockPacketStream {
 public:
  MOCK_METHOD(const Packet*, GetPacket, (size_t packet_number), (const));
};
```

---

## Specifying Mock Behaviors: `ON_CALL` and `EXPECT_CALL`

### `ON_CALL` — Setting Default Behavior

Use `ON_CALL` to specify what the mock method should do when called, **without creating an expectation that it must be called**.

```cpp
ON_CALL(mock_foo, DoThis()).WillByDefault(Return(1));
```

- The parameter list is identical to `EXPECT_CALL`.
- The `.WillByDefault()` clause is **mandatory** and specifies the behavior for calls not covered by `EXPECT_CALL`.

### `EXPECT_CALL` — Setting Expectations

Use `EXPECT_CALL` to specify how many times and in what manner a mock method is expected to be called.

```cpp
EXPECT_CALL(mock_foo, DoThis(5))
    .Times(3)
    .WillRepeatedly(Return(10));
```

- You can chain modifiers such as:
  - `.With()` – match arguments as a tuple
  - `.Times()` – specify call cardinality
  - `.InSequence()` – specify partial or total ordering
  - `.After()` – set prerequisites for call order
  - `.WillOnce()` and `.WillRepeatedly()` – control the return or action behavior
  - `.RetiresOnSaturation()` – retire expectation after it's fulfilled

#### Cardinalities in `.Times()`

Common cardinalities include:

- `AnyNumber()` — any number of calls allowed
- `AtLeast(n)` — at least `n` calls
- `AtMost(n)` — at most `n` calls
- `Between(m, n)` — between `m` and `n` inclusive
- `Exactly(n)` or simply `n` — exactly `n` calls; `0` means disallow calls

If you omit `.Times()`, GoogleMock infers it based on the presence/absence of `WillOnce` and `WillRepeatedly` clauses.

### Matching Arguments

Use argument matchers or specific values to specify what arguments are expected:

```cpp
EXPECT_CALL(mock_foo, DoThis(Ge(5), _));  // First arg >=5, second arg anything
EXPECT_CALL(mock_foo, DoThat(_)).Times(0);  // Expect no calls
```

The wildcard matcher `_` can be used when you do not care about an argument's value.

### Chaining Multiple Behaviors

You can define a sequence of actions for calls via `WillOnce` chained multiple times, followed by an optional `WillRepeatedly`:

```cpp
EXPECT_CALL(mock_foo, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

Calls 1 and 2 return 1 and 2 respectively, all subsequent calls return 3.

### Using `.With()` to Match Argument Tuples

To impose constraints involving multiple arguments together, use `.With()` which receives a matcher of a tuple:

```cpp
EXPECT_CALL(mock, SetPosition(_, _)).With(Lt());
// Expects first argument less than second
```

---

## Managing Uninteresting and Unexpected Calls

### Mock Types Regarding Call Strictness

GoogleMock provides three wrapper templates to control behavior on uninteresting calls.

| Wrapper Template              | Description                                                                            |
|------------------------------|----------------------------------------------------------------------------------------|
| `NiceMock<T>`                | Suppresses warnings on uninteresting calls (calls without `EXPECT_CALL`).              |
| `NaggyMock<T>` (default)    | Prints warnings on uninteresting calls.                                               |
| `StrictMock<T>`               | Treats uninteresting calls as errors leading to test failures.                         |

Example:

```cpp
NiceMock<MockFoo> nice_foo;
EXPECT_CALL(nice_foo, DoThis());
nice_foo.DoThis();  // No warning for other calls
```

These wrappers inherit the mocked class's constructors, so you can construct with any arguments just like the original mock.

### Behavior Differences

| Situation            | NiceMock             | NaggyMock           | StrictMock           |
|----------------------|----------------------|---------------------|----------------------|
| Uninteresting call   | Ignored silently     | Prints warning      | Fails test           |
| Unexpected call      | Fails test           | Fails test          | Fails test           |

### Practical Tips

- Use `NiceMock` in most tests to reduce noise.
- Use `StrictMock` when you want precise call monitoring, catching all unexpected interactions.
- `NaggyMock` is useful during initial test development to notify about possible missing expectations.

---

## Handling Non-default Constructible Types in Returns

If your mock method returns a type without a default constructor, you **must** explicitly specify return values in expectations, otherwise an exception or test failure occurs when the method is called unexpectedly.

```cpp
EXPECT_CALL(mock_foo, ReturnNonDefaultConstructible())
   .WillOnce(Return(MyTypeConstructor()));
```

---

## Additional Features and Best Practices

### Setting Default Actions with `ON_CALL`

Prefer `ON_CALL` for setting default behaviors shared across tests or for optional calls, while reserving `EXPECT_CALL` for calls whose presence and frequency you want to verify.

### Avoid Over Specifying

Only specify as many expectations and argument matchers as you need to express intent.

### Order and Overriding of Expectations

Expectations set later override earlier ones for the same method and arguments, reflecting the pattern of default behavior first, specific overrides later.

### Mock Lifecycles

Expectations are verified automatically when mock objects are destroyed. Use `Mock::AllowLeak()` if a mock must intentionally live beyond test's lifetime without verification.

### Mocking Complex and Move-Only Types

GoogleMock supports mocking methods with move-only types (`std::unique_ptr`) in arguments and returns directly via `MOCK_METHOD`.

### Deleting Mock Objects in Actions

You can safely delete a mock object from within an action.

```cpp
EXPECT_CALL(mock_foo, DoThis()).WillOnce(Delete(mock_foo_pointer));
```

---

## Code Examples

### Creating a Basic Mock and Setting Expectations

```cpp
class Foo {
 public:
  virtual void DoThis() = 0;
  virtual int DoThat(bool flag) = 0;
  virtual ~Foo() = default;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(void, DoThis, (), (override));
  MOCK_METHOD(int, DoThat, (bool flag), (override));
};

TEST(FooTest, Example) {
  MockFoo mock;

  ON_CALL(mock, DoThat(true))
      .WillByDefault(Return(42));

  EXPECT_CALL(mock, DoThis())
      .Times(1);

  mock.DoThis();  // OK
  int val = mock.DoThat(true);  // Returns 42 by default
  EXPECT_EQ(val, 42);
}
```

### Using NiceMock

```cpp
NiceMock<MockFoo> nice_mock;
EXPECT_CALL(nice_mock, DoThis());
nice_mock.DoThis();
// no warning on uninteresting calls
```

### Specifying Call Sequences

```cpp
Sequence s;
EXPECT_CALL(mock, DoThis()).InSequence(s);
EXPECT_CALL(mock, DoThat(true)).InSequence(s);

mock.DoThis();
mock.DoThat(true);
```

### Retiring Expired Expectations

```cpp
EXPECT_CALL(mock, DoThat(_))
    .Times(2)
    .RetiresOnSaturation();
```

After two matching calls, this expectation will no longer match calls, allowing other expectations to take over.

---

For more detailed examples on argument matchers, actions, and sequences, see the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) and the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html).

---

## Troubleshooting and Common Pitfalls

- **Uninteresting mock function call warnings:** Use `NiceMock` to suppress warnings if the calls are indeed expected to be unverified.

- **Unexpected calls:** Occur when a call does not match any active `EXPECT_CALL` setup; ensure your expectations cover the intended calls.

- **Mock method invocation order:** Use `InSequence` or `After` clauses to enforce call orders.

- **Default return values:** For non-void return types without defaults, always provide explicit return actions to avoid run-time errors.

- **Mock object lifetime:** If a mock lives beyond the test, call `Mock::AllowLeak` to avoid false leak reports.

---

For comprehensive understanding and additional recipes, review [gmock_for_dummies.md](https://google.github.io/googletest/gmock_for_dummies.html), [gmock_cheat_sheet.md](https://google.github.io/googletest/gmock_cheat_sheet.html), and [gmock_faq.md](https://google.github.io/googletest/gmock_faq.html).

---