---
title: "Defining Mock Objects and Methods"
description: "Step-by-step reference for declaring mock classes and methods using GoogleMock. Covers the key macros (MOCK_METHOD, etc.), supported method signatures, and usage scenarios for faking interfaces and simulating object behavior in tests."
---

# Defining Mock Objects and Methods

This reference provides a comprehensive, step-by-step guide for declaring mock classes and methods using GoogleMock. It covers the key macros like `MOCK_METHOD`, discusses supported method signatures, and explains usage scenarios for faking interfaces and simulating object behavior in tests.

---

## 1. Defining Mock Classes

To create a mock class, derive from the interface or base class you want to mock and declare mock methods using the `MOCK_METHOD` macro. Each mocked method replaces a virtual method and simulates its behavior.

### MOCK_METHOD Macro

```cpp
MOCK_METHOD(return_type, method_name, (args...), (qualifiers...));
```

- `return_type`: The return type of the method being mocked.
- `method_name`: The name of the method.
- `args...`: The method arguments enclosed in parentheses.
- `qualifiers...` (optional): Method qualifiers such as `const`, `override`, `noexcept`, calling convention (e.g., `Calltype(STDMETHODCALLTYPE)`), or reference qualifiers (e.g., `ref(&)`, `ref(&&)`).

**Important:** `MOCK_METHOD` must be declared in the `public:` section of the mock class, even if the overridden method is protected or private.

#### Handling Commas in Types

Since commas inside template parameters can confuse the macro parser, use either:

- Parentheses around the entire return or argument type:
  ```cpp
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
  ```

- Type aliases:
  ```cpp
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
  using MapIntDouble = std::map<int, double>;
  MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
  ```

### Example

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
  virtual ~Foo();
  virtual int GetSize() const = 0;
  virtual string Describe(const char* name) = 0;
  virtual string Describe(int type) = 0;
  virtual bool Process(Bar elem, int count) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(string, Describe, (const char* name), (override));
  MOCK_METHOD(string, Describe, (int type), (override));
  MOCK_METHOD(bool, Process, (Bar elem, int count), (override));
};
```

### Mocking Class Templates

Mock class templates work similarly:

```cpp
template <typename Elem>
class StackInterface {
 public:
  virtual ~StackInterface();
  virtual int GetSize() const = 0;
  virtual void Push(const Elem& x) = 0;
};

template <typename Elem>
class MockStack : public StackInterface<Elem> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const Elem& x), (override));
};
```

### Mocking Overloaded Methods

Mocking overloaded functions requires you to mock each overload explicitly:

```cpp
class Foo {
 public:
  virtual ~Foo();
  virtual int Add(Element x);
  virtual int Add(int times, Element x);
  virtual Bar& GetBar();
  virtual const Bar& GetBar() const;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (Element x), (override));
  MOCK_METHOD(int, Add, (int times, Element x), (override));
  MOCK_METHOD(Bar&, GetBar, (), (override));
  MOCK_METHOD(const Bar&, GetBar, (), (const, override));
};
```

Use `using Foo::Add;` inside the mock to avoid hiding unmocked overloads.

### Mocking Non-Virtual Methods

GoogleMock also supports mocking of non-virtual methods using the same `MOCK_METHOD` macro syntax but without the `override` qualifier:

```cpp
class ConcretePacketStream {
 public:
  void AppendPacket(Packet* new_packet);
  const Packet* GetPacket(size_t packet_number) const;
  size_t NumberOfPackets() const;
};

class MockPacketStream {
 public:
  MOCK_METHOD(const Packet*, GetPacket, (size_t packet_number), (const));
  MOCK_METHOD(size_t, NumberOfPackets, (), (const));
};
```

This technique requires specifying mocks at compile-time.

---

## 2. Using Mocks in Tests

The typical workflow:

1. **Include gMock headers** and use the `testing` namespace or import needed symbols.
2. **Create mock objects** of your mock classes.
3. **Set default behaviors** with `ON_CALL`.
4. **Set expectations** with `EXPECT_CALL` specifying how the mocks should be called.
5. **Run the test code** that uses the mock objects.
6. **Verify** that expectations are met, automatically done at mock destruction or manually.

### Setting Default Actions: ON_CALL

```cpp
ON_CALL(mock_object, Method(matchers))
    .With(multi_argument_matcher)  // optional
    .WillByDefault(action);        // required
```

`ON_CALL` specifies what happens when the mock method is called, but does not impose any expectation that the call will happen.

### Setting Expectations: EXPECT_CALL

```cpp
EXPECT_CALL(mock_object, Method(matchers))
    .With(multi_argument_matcher)  // optional
    .Times(cardinality)            // optional
    .InSequence(sequences...)      // zero or more
    .After(expectations...)        // zero or more
    .WillOnce(action)              // zero or more
    .WillRepeatedly(action)        // optional
    .RetiresOnSaturation();        // optional
```

`EXPECT_CALL` sets expectations on calls, specifying argument matchers, expected number of calls, sequencing, and behavior.

#### Cardinalities (Times)

Predefined cardinalities include

- `Exactly(n)` or `n`
- `AnyNumber()`
- `AtLeast(n)`
- `AtMost(n)`
- `Between(m, n)`

If omitted, GoogleMock infers the cardinality from the actions specified.

#### Ordering

- Use `.InSequence(...)` or `InSequence` object for strict call ordering.
- Use `.After(...)` to specify that one expectation must happen after others.

### Example

```cpp
using ::testing::Return;
using ::testing::_;

MockFoo foo;

ON_CALL(foo, GetSize())
    .WillByDefault(Return(1));

EXPECT_CALL(foo, Describe(5))
    .Times(3)
    .WillRepeatedly(Return("Category 5"));

EXPECT_EQ(MyProductionFunction(&foo), "good");
```

---

## 3. Mock Behavior Control

### NiceMock, NaggyMock, and StrictMock Wrappers

These templates modify how uninteresting calls (calls to methods without matching expectations) are handled for a mock object:

| Wrapper       | Uninteresting Call Behavior                             |
|--------------|--------------------------------------------------------|
| `NiceMock<T>` | Silences warnings on uninteresting calls (default: ignore) |
| `NaggyMock<T>` | Prints warnings on uninteresting calls (default behavior)  |
| `StrictMock<T>` | Treats uninteresting calls as test failures            |

Example:

```cpp
NiceMock<MockFoo> nice_foo;      // Ignores uninteresting calls
NaggyMock<MockFoo> naggy_foo;    // Warns on uninteresting calls
StrictMock<MockFoo> strict_foo;  // Errors on uninteresting calls
```

---

## 4. Handling Mock Methods Returning Move-Only Types

You can directly mock methods returning or accepting move-only types (e.g., `std::unique_ptr`) using `MOCK_METHOD`:

```cpp
MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
```

When returning move-only types from mocks, prefer specifying actions using lambdas or functions to produce new objects each call:

```cpp
EXPECT_CALL(mock_buzzer_, MakeBuzz("x"))
    .WillRepeatedly([](StringPiece text) {
      return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

---

## 5. Best Practices and Common Pitfalls

- **Set expectations before invoking mock methods.** Setting `EXPECT_CALL` after a mock method is called is undefined behavior.
- **Avoid over-specification.** Use `ON_CALL` when you donâ€™t want to enforce call counts or arguments.
- **Use wildcards `_` matcher** for arguments you don't care about.
- **Ordering matters in setting expectations:** newer `EXPECT_CALL`s override older ones.
- **Retire expectations explicitly if needed:** to prevent them from matching calls after saturation, use `.RetiresOnSaturation()`.
- **Use sequences or `.After()` for strict or partial ordering of calls.**

---

## 6. Advanced Usage

### Using `DefaultValue<T>` to Change Default Return Values

When no action is specified, GoogleMock returns default values for some types automatically. For user-defined types or custom behavior, you can change the default return values:

```cpp
::testing::DefaultValue<MyType>::Set(my_default_value);
::testing::DefaultValue<MyType>::Clear();
```

### Using `MockFunction` for std::function Mocks

You can mock a callback or std::function-like interface using `MockFunction`:

```cpp
MockFunction<int(std::string)> mock;
EXPECT_CALL(mock, Call("bar")).WillOnce(Return(1));
...
foo(mock.AsStdFunction());
```

This lets you test code that takes `std::function` arguments.

---

## 7. Troubleshooting Common Issues

### Warning: Uninteresting Call

When a mock method is called but no `EXPECT_CALL` matches and no `ON_CALL` default action is set, a warning is printed. If this is expected, suppress it by:

- Using `NiceMock` wrapper
- Adding a catch-all `EXPECT_CALL` with `Times(AnyNumber())`

### Mocked Method Invokes Real Method

Ensure the method is declared `virtual` in the base class. Non-virtual methods cannot be mocked.

### Mock Failures on Call Count

Try `--gmock_verbose=info` to see detailed call matching logs for diagnosing unexpected call counts.

### Overloads Ambiguity

Help the compiler by disambiguating overloaded methods using `Const()` or specifying matchers explicitly.

### Mock Leak Errors

GoogleMock verifies expectations at destruction. If mocks are leaked, expectations are not verified. Use `Mock::AllowLeak(&mock_obj)` if leaking is intentional.

---

For examples, techniques on delegating to real or fake objects, custom matchers and actions, refer to the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html).


---

## References & Further Reading

- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Expectations and Default Actions](https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL)
- [Matchers Library](https://google.github.io/googletest/reference/matchers.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html)
- [Using Mocks in Tests Guide](https://google.github.io/googletest/guides/getting-started/first-mock.html)

<Source url="https://github.com/google/googletest" paths={[{"path": "docs/reference/mocking.md", "range": "1-230"}]} />

