---
title: "Matchers in Mocking"
description: "Explains how to use matchers within the context of mock expectations and actions, including built-in, custom, and extended matcher sets. Provides guidance for best practices and integration across GoogleTest and GoogleMock."
---

# Matchers in Mocking

Matchers are the cornerstone of writing precise and expressive mock expectations in GoogleMock (gMock). They enable you to specify criteria that function arguments must satisfy during tests, facilitating comprehensive and readable test assertions. This page delves deeply into using matchers within mock expectations and actions, including built-in matchers, custom matcher creation, advanced usage patterns, and best practices for integration within your testing workflow.

---

## Understanding Matchers

Matchers are predicate-like objects that determine whether a function argument meets specific criteria. They are crucial for selecting or verifying mock method calls based on argument values.

### Key Benefits of Using Matchers

- **Expressiveness:** Concisely specify complex conditions on arguments.
- **Reusability:** Share and reuse matchers across tests.
- **Readability:** Produce human-friendly failure messages.
- **Safety:** Statically typed to catch mistakes at compile-time.

Matchers come in two principal forms:

- **Monomorphic Matchers:** Typed to match a single argument type.
- **Polymorphic Matchers:** Template-based, can match multiple types or be converted to specific matchers depending on context.

Example:

```cpp
using ::testing::Gt;
using ::testing::_;  // Wildcard matcher

// Matches any argument greater than 5
EXPECT_CALL(mock_obj, Foo(Gt(5)));

// Matches any argument (unconditionally)
EXPECT_CALL(mock_obj, Foo(_));
```


## Built-in Core Matchers

GoogleMock offers an extensive set of built-in matchers, covering common comparisons, container contents, pointers, and strings.

### 1. Wildcard Matchers

- `_`, `A<T>()`, `An<T>()`: Match anything of any type.

### 2. Equality and Comparison Matchers

- `Eq(value)`: Matches arguments equal to `value`.
- `Ne(value)`: Matches arguments not equal to `value`.
- `Lt(value)`, `Le(value)`, `Gt(value)`, `Ge(value)`: Matches for less-than, less-or-equal, greater-than, and greater-or-equal comparisons.

### 3. Pointer and Reference Matchers

- `IsNull()`: Matches any `NULL` pointer (including smart pointers).
- `NotNull()`: Matches any non-`NULL` pointer.
- `Ref(variable)`: Matches arguments that reference the exact variable.
- `Pointee(matcher)`: Matches a pointer whose pointed-to value satisfies `matcher`.

### 4. String Matchers

- `StrEq(string)`: Matches string arguments equal to `string`.
- `StrNe(string)`: Matches string arguments not equal to `string`.
- `StrCaseEq(string)`: Case-insensitive equality.
- `StrCaseNe(string)`: Case-insensitive inequality.
- `HasSubstr(substring)`: Matches strings containing `substring`.
- `StartsWith(prefix)`: Matches strings that start with `prefix`.
- `EndsWith(suffix)`: Matches strings ending with `suffix`.

### 5. Container Matchers

- `Contains(element_matcher)`: Matches containers with at least one element satisfying `element_matcher`.
- `Each(element_matcher)`: Matches containers where every element satisfies `element_matcher`.
- `ElementsAre(...)`: Matches containers with elements matching the corresponding matchers in order.
- `UnorderedElementsAre(...)`: Matches containers with elements matching the matchers in any order.

### 6. Composite and Logical Matchers

- `AllOf(m1, m2, ...)`: Matches when all supplied matchers match.
- `AnyOf(m1, m2, ...)`: Matches when any supplied matcher matches.
- `Not(m)`: Matches when the matcher `m` does not match.


## Using Matchers in Mock Expectations

Matchers are primarily used in `EXPECT_CALL` and `ON_CALL` macros to specify argument matching criteria.

### `EXPECT_CALL` with Matchers

```cpp
EXPECT_CALL(mock_obj, MethodName(m1, m2));
```

- `m1`, `m2` are matchers corresponding to the method's arguments.
- You can combine matchers to build complex expectations:

```cpp
using ::testing::AllOf;
using ::testing::Gt;
using ::testing::Ne;

EXPECT_CALL(mock_obj, Foo(AllOf(Gt(5), Ne(10))));
```

### `With()` Clause

Refine expectations by matching **all arguments as a tuple** with a multi-argument matcher:

```cpp
EXPECT_CALL(mock_obj, Foo(_, _))
    .With(Gt());  // Matches calls where first arg < second arg
```

The matcher inside `With()` must be a matcher of a tuple type matching the function's arguments.

### Helpful Patterns

- Use `_` to match any argument without constraint.
- Use specific value or comparison matchers to ensure argument correctness.
- Combine with `AllOf()`, `AnyOf()`, and `Not()` for complex logic.


## Creating Custom Matchers

When built-in matchers don't suffice, gMock lets you define your own matchers efficiently.

### Using `MATCHER` Macros

Define simple custom matchers with minimal boilerplate:

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}
```

Use as:

```cpp
EXPECT_CALL(mock_obj, MethodName(IsEven()));
EXPECT_THAT(value, IsEven());
```

### Parameterized Matchers

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}
```

Usage:

```cpp
EXPECT_THAT(x, HasAbsoluteValue(10));
```

### Adding Descriptions and Explanations

- Provide descriptive strings referring to `negation` and parameters in the matcher.
- Stream detailed explanation messages to `result_listener` inside matcher body to enhance failure messages.

Example:

```cpp
MATCHER_P(IsDivisibleBy7, "") {
  if ((arg % 7) == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```


### Advanced Matcher Interface

Alternatively, implement the MatcherInterface directly for more control, enabling:

- Overloading on parameter types
- Complex polymorphic behavior

Example:

```cpp
class NotNullMatcher {
 public:
  using is_gtest_matcher = void;

  template <typename T>
  bool MatchAndExplain(T* p, MatchResultListener* /* listener */) const {
    return p != nullptr;
  }

  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

PolymorphicMatcher<NotNullMatcher> NotNull() {
  return MakePolymorphicMatcher(NotNullMatcher());
}
```


## Casting Matchers

### SafeMatcherCast

Use `SafeMatcherCast<T>(m)` when you want to cast matcher `m` to a different type `T` safely, with compile-time checks ensuring:

- Implicit convertibility of `T` to the matcher’s expected argument type.
- Non-lossy casts for arithmetic types.
- Proper handling of references.

Example:

```cpp
Matcher<int> int_matcher = Eq(5);
Matcher<long> long_matcher = SafeMatcherCast<long>(int_matcher);
```

### MatcherCast

Allows more permissive cast using `static_cast`, but potentially unsafe.
Use only when you fully understand the implications.


## Combining Matchers for Compound Arguments

- Use `Pair()`, `Key()`, and `FieldsAre()` to construct matchers for compound data types like pairs, maps, and structs.

Example:

```cpp
EXPECT_CALL(mock_obj, MethodName(Pair(Ge(5), HasSubstr("foo"))));
EXPECT_THAT(container, Contains(Key(Ge(10))));
EXPECT_THAT(object, FieldsAre(Eq(5), HasSubstr("bar")));
```


## Common Usage Patterns and Best Practices

- **Default behavior:** Absence of explicit matchers defaults each argument matcher to `_`.
- **Order precedence:** More recent expectations override earlier ones.
- **Avoid over-specification:** Use matchers to specify *only* what matters.
- **Use `With()` cautiously:** When matching arguments as a whole, ensure your tuple matcher accurately reflects arguments.
- **Combining predicates:** Use built-in logical matchers (`AllOf`, `AnyOf`, `Not`) to express complex logic without writing custom matchers.
- **Reference arguments:** When matching non-copyable objects or references, use `Ref` with caution.


## Troubleshooting Common Issues

- **Matcher not matching expected arguments:** Ensure types match or use `SafeMatcherCast`.
- **Ambiguous overloads:** Use `Const()` wrapper or explicit type matchers like `TypedEq<T>`.
- **Unexpected calls not matching expectations:** Check matcher ordering and argument matchers.
- **Move-only types in matchers:** Use lambdas or actions to handle correctly.


## Example: Combining Use Cases

```cpp
using ::testing::_;               // Wildcard matcher
using ::testing::Gt;              // Greater than matcher
using ::testing::Pointee;         // Match value pointed to
using ::testing::Pair;            // For pairs

class MockFoo {
 public:
  MOCK_METHOD(void, ProcessData, (
              const std::pair<int, std::unique_ptr<std::string>>& data), (override));
};

MockFoo mock;

EXPECT_CALL(mock, ProcessData(Pair(Gt(10), Pointee(HasSubstr("test")))));

std::unique_ptr<std::string> ptr = std::make_unique<std::string>("this is a test string");
std::pair<int, std::unique_ptr<std::string>> arg(11, std::move(ptr));

mock.ProcessData(arg);  // Matches expectation
```


## Further Reading and Related Pages

- [Defining & Using Mock Objects](reference/mocking-framework/define-and-use-mocks.md) — Learn mock class creation patterns.
- [Expectations, Actions & Sequences](reference/mocking-framework/expectations-and-actions.md) — Detailed usage of expectations on mocks.
- [Matchers Reference](reference/matchers-and-advanced-assertions/core-matchers.md) — Detailed listing of matchers.
- [Using Mocks](guides/essential-workflows/using-mocks.md) — Workflow guide for mock usage.
- [gMock for Dummies](docs/gmock_for_dummies.md) — Beginner friendly tutorial.
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md) — Handy task reference.

---

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googlemock/include/gmock/gmock-matchers.h", "range": "1-626"},{"path": "googlemock/test/gmock-matchers_test.h", "range": "1-140"}]} />
