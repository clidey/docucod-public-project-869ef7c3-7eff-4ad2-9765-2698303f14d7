---
title: "Actions and Side Effects"
description: "Describes the actions API for specifying side effects or return values of mock calls, including both built-in and custom actions. Includes reference for invoking callables, returning values, or throwing exceptions."
---

# Actions and Side Effects

GoogleMock allows you to specify what a mock function _does_ when it is called using **actions**. Actions define the side effects and return values of mock calls, enabling sophisticated behaviors in tests beyond simple expectations.

This reference covers the API for builtin and custom actions, teaching you how to control mock function behaviors effectively.

---

## 1. Overview of Actions

**Actions** direct how a mock method behaves when called. You specify them primarily through:

- `ON_CALL(...)` to set _default_ behavior without enforcing call count
- `EXPECT_CALL(...).WillOnce(...)` and `EXPECT_CALL(...).WillRepeatedly(...)` to specify behaviors for matched calls

Actions can return values, mutate arguments, invoke functions/lambdas, throw exceptions, or combine multiple operations.

### Typical Usage Flow

1. Define a mock method using `MOCK_METHOD` macro.
2. Use `ON_CALL` to specify default actions (behavior without expectations).
3. Use `EXPECT_CALL` with `.WillOnce()` and/or `.WillRepeatedly()` to specify call expectations and behaviors.
4. When your code under test calls the mock method, the configured action executes.

---

## 2. Built-in Return Value Actions

| Action                         | Description                                                                                     |
| ------------------------------ | ------------------------------------------------------------------------------------------------- |
| `Return()`                    | For void mock methods, returns immediately without value.                                        |
| `Return(value)`               | Returns a copy of `value`. The copy is made when the expectation is set, not when the call happens. |
| `ReturnArg<N>()`              | Returns the N-th (0-based) argument passed to the mock function.                                |
| `ReturnNew<T>(a1, ..., ak)`   | Returns a newly created `T` object constructed with the given args. A new object is created for each call. |
| `ReturnNull()`                | Returns a null pointer.                                                                          |
| `ReturnPointee(ptr)`          | Returns the value pointed to by `ptr` at call time (live value). Useful for returning changing data. |
| `ReturnRef(variable)`         | Returns a reference to `variable`. Useful for authoritative mutable data.                        |
| `ReturnRefOfCopy(value)`      | Returns a reference to a copy of `value`. The copy is stored inside the action object.           |
| `ReturnRoundRobin({a1,...,an})` | Cycles through the return values in the list on each call, starting again after reaching the end. |

### Example: Returning Different Values Each Call

```cpp
using ::testing::Return;

EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));  // returns 30 thereafter

int x1 = mock.GetValue();  // 10
int x2 = mock.GetValue();  // 20
int x3 = mock.GetValue();  // 30
```

### Example: Returning Value Pointed by Pointer

```cpp
int counter = 0;
EXPECT_CALL(mock, GetCounter())
    .WillRepeatedly(ReturnPointee(&counter));

counter = 5;
EXPECT_EQ(mock.GetCounter(), 5);
counter = 8;
EXPECT_EQ(mock.GetCounter(), 8);
```

---

## 3. Side Effect Actions

Actions can perform side effects on arguments, allowing you to simulate output parameters or mutate objects.

| Action                     | Description                                                                    |
| --------------------------- | ------------------------------------------------------------------------------ |
| `Assign(&variable, value)`  | Assigns `value` to `variable`. Useful for setting shared state or output args.  |
| `DeleteArg<N>()`            | Deletes the N-th argument if it is a pointer. Useful for ownership transfer tests. |
| `SaveArg<N>(pointer)`       | Saves the N-th argument by copying it into `*pointer`.                          |
| `SaveArgByMove<N>(pointer)` | Saves the N-th argument by move-assignment into `*pointer`.                    |
| `SaveArgPointee<N>(pointer)`| Saves the value pointed by the N-th argument into `*pointer`.                  |
| `SetArgReferee<N>(value)`  | Assigns `value` to the variable referenced by the N-th argument.               |
| `SetArgPointee<N>(value)`  | Assigns `value` to the variable pointed to by the N-th argument.               |
| `SetArrayArgument<N>(first, last)` | Copies elements in `[first, last)` to the array pointed at by N-th argument.|  
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value`.                                |
| `Throw(exception)`          | Throws the provided exception object when called.                             |

### Example: Setting an Output Argument

```cpp
using ::testing::_; 
using ::testing::SetArgPointee;
using ::testing::DoAll;
using ::testing::Return;

EXPECT_CALL(mock, FindUser(_, _))
  .WillOnce(DoAll(
      SetArgPointee<1>(42),  // sets output arg #1
      Return(true)));

int id = 0;
EXPECT_TRUE(mock.FindUser("bob", &id));
EXPECT_EQ(42, id);
```

### Example: Deleting Pointer Argument

```cpp
EXPECT_CALL(mock, Dispose(_))
    .WillOnce(DeleteArg<0>());
```

This will call `delete` on the first argument when `Dispose` is called.

---

## 4. Using Functions, Lambdas, and Functors as Actions

You can specify any callable as an action, providing ultimate flexibility:

- Plain functions
- Lambdas
- Functors or function objects
- Member function pointers with instance

The callable must have a compatible signature with the mock method.

### Example: Using a Lambda

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) {
      return x * 2;
    });

EXPECT_EQ(mock.Compute(3), 6);
```

### Example: Using a Member Function

```cpp
class Helper {
 public:
  int Double(int x) { return 2 * x; }
};

Helper helper;
EXPECT_CALL(mock, Compute(_))
    .WillOnce(Invoke(&helper, &Helper::Double));
```

### Example: Ignoring Unused Arguments in Callable

Declare arguments as `Unused` to indicate ignoring them:

```cpp
using ::testing::Unused;
EXPECT_CALL(mock, Foo(_, _, _))
    .WillOnce(Invoke([](Unused, int x, int y) {
      return x + y;
    }));
```

---

## 5. Special Actions

GoogleMock provides utility actions to help common patterns.

| Action                     | Description                                            |
| --------------------------- | ------------------------------------------------------ |
| `DoDefault()`              | Performs the default action associated with the mock (from `ON_CALL` or default). |
| `DoAll(a1, a2, ..., an)`  | Performs all subactions in order and returns the result of the last one. The first `n-1` must return void. |
| `IgnoreResult(a)`         | Performs action `a`, ignoring its return value (making it `void`). Useful when chaining with `DoAll()`. |
| `WithArg<N>(a)`           | Passes the N-th argument of the mock function to action `a` and executes it. |
| `WithArgs<N1, N2,...>(a)` | Passes selected arguments (by indices) of the mock function to action `a`. |
| `WithoutArgs(a)`          | Executes action `a` with no arguments. Useful for adapting actions needing fewer args. |
| `InvokeArgument<N>(args...)` | Invokes the N-th argument which is a callable with provided arguments. Useful for invoking callbacks passed in mocks. |

### Example: Performing Multiple Actions

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(
        SetArgPointee<0>(10),     // Side effect
        Return(true)              // Return value
    ));
```

### Example: Ignoring a Result

```cpp
EXPECT_CALL(mock, Bar(_))
    .WillOnce(IgnoreResult(SomeFuncReturningValue));
```

### Example: Invoking Passed-in Callback

```cpp
EXPECT_CALL(mock, DoWork(_, _))
    .WillOnce(InvokeArgument<1>(42)); // Calls 2nd argument with 42
```

---

## 6. Defining Custom Actions

When built-in actions are insufficient, define your own action:

- Implement a **callable** type (functor, lambda, function) compatible with mock function signature.
- Use `ACTION`, `ACTION_P`, or `ACTION_TEMPLATE` macros for simpler syntax.
- Use `MakeAction` or `MakePolymorphicAction` for class-based actions.

### Simple Example Using `ACTION` Macro

```cpp
ACTION(IncrementArg0) {
  ++(*arg0);  // increments the first argument by reference
  return 0;
}

EXPECT_CALL(mock, Func(_)).WillOnce(IncrementArg0());
```

### Parameterized Action Example

```cpp
ACTION_P(Add, n) {
  return arg0 + n;
}

EXPECT_CALL(mock, Func(_)).WillOnce(Add(5));
```

### Functor Class Action Example

```cpp
struct MultiplyBy {
  int factor;
  int operator()(int x) { return x * factor; }
};

EXPECT_CALL(mock, Func(_)).WillOnce(MultiplyBy{10});
```

### Polymorphic Action Example

Use `MakePolymorphicAction` to make the same action usable for multiple function signatures.

---

## 7. Troubleshooting and Best Practices

### Verify You Set Return Values for Non-void Functions

For mock functions that return non-void, ensure an action with an appropriate return value is set via `ON_CALL`, `EXPECT_CALL.WillOnce()`, or `EXPECT_CALL.WillRepeatedly()` or the default value must exist.

### Beware of Copying in Return()

`Return(value)` copies `value` when the expectation is set, not at call time. For mutable or moving values use lambdas or `ReturnPointee`.

### Use `ON_CALL` for Default Behavior

Set method _behavior_ with `ON_CALL`, set _expectations_ with `EXPECT_CALL`. Overusing `EXPECT_CALL` for default behaviors may cause tests to be too restrictive.

### Suppress Uninteresting Call Warnings

Uninteresting calls (calls without expectations) cause warnings by default. Use `NiceMock` to suppress.

### Properly Chain Actions

When chaining multiple actions, use `DoAll()` and ensure only the last returns a value.


---

## 8. Additional Resources

- [GoogleMock for Dummies](docs/gmock_for_dummies.md) - Beginner friendly introduction.
- [Mocking Reference](docs/reference/mocking.md) - Overview of mock-related macros and classes.
- [Expectations & Actions Guide](guides/mocking-techniques/setting-expectations.md) - How to set expectations and actions.
- [Actions Reference](docs/reference/actions.md) - Concise list of built-in actions.
- [gMock Cookbook](docs/gmock_cook_book.md#UsingActions) - Advanced usage examples.

---

For the authoritative source code, see [gmock/include/gmock/gmock-actions.h](https://github.com/google/googletest/blob/main/googlemock/include/gmock/gmock-actions.h) and the tests in [googlemock/test/gmock-spec-builders_test.cc](https://github.com/google/googletest/blob/main/googlemock/test/gmock-spec-builders_test.cc).

---

## Summary Diagram: Action Flow

```mermaid
flowchart TD
  A[Define Mock Method with MOCK_METHOD]
  A --> B[Set Default Behavior with ON_CALL]
  B --> C{Call Mock Method}
  C -->|Matches EXPECT_CALL| D[Run WillOnce/WillRepeatedly Actions]
  C -->|No Match| E[Run Default ON_CALL Action or Built-in Default]
  D --> F[Return or Apply Side Effects]
  E --> F

  classDef action fill:#e0f7fa,stroke:#0288d1,stroke-width:2px;
  B,D,E,F class action;
```

