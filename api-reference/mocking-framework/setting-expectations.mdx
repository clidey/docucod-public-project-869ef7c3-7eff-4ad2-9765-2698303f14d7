---
title: "Setting Expectations & Sequences"
description: "Documents ON_CALL, EXPECT_CALL, and related macros for specifying expected behavior, call counts, and call sequences on mock objects. Explains argument matching, default actions, and verification steps."
---

# Setting Expectations & Sequences

This page documents how to specify the expected behavior, call counts, and call sequences on mock objects using the `ON_CALL`, `EXPECT_CALL`, and related macros in GoogleMock. It explains how to define argument matchers, set default and explicit behavior, manage ordering constraints, and verify call expectations efficiently.

---

## Overview

When writing tests with GoogleMock, controlling how mock methods behave and verifying how many times and in what order they are called is crucial. This is achieved primarily through two macros:

- `ON_CALL()`: Specifies the default behavior of mock methods without imposing any expectations on their invocation.
- `EXPECT_CALL()`: Sets explicit expectations that a mock method will be called with certain arguments, a specified number of times and potentially in a defined sequence.

The flexibility of these macros allows you to precisely describe interactions your code under test should have with its dependencies.

---

## Using `EXPECT_CALL`

`EXPECT_CALL(mock_object, method(matchers...))` declares that you expect the mock method `method` to be called with arguments matching the specified matchers.

### Key Modifiers for `EXPECT_CALL`

You may chain multiple clauses to customize the expectation's behavior:

```cpp
EXPECT_CALL(mock_object, method(matchers...))
    .With(multi_arg_matcher)    // Restricts by multiple args as a tuple
    .Times(cardinality)         // Specifies call count constraint
    .InSequence(sequences...)   // Enforces call order
    .After(expectations...)     // Call must occur after other expectations
    .WillOnce(action)           // Defines behavior for a single call
    .WillRepeatedly(action)     // Defines behavior for subsequent calls
    .RetiresOnSaturation();     // Retires expectation once saturated
```

Each clause must follow a specific order, and their usage control how calls to the mock method are matched and handled.

### Argument Matchers

- Matchers specify the argument conditions the expectation applies to. For example, `_` means "match anything".
- If `matchers` is omitted (only for non-overloaded methods), the expectation matches calls with any arguments.
- The `.With()` clause allows matching arguments as a tuple through a single multi-argument matcher.

### Call Cardinality (`.Times()`)

Controls how many times the call is expected:

| Cardinality           | Meaning
|-----------------------|------------------------------------------------------
| `AnyNumber()`         | Called zero or more times.
| `AtLeast(n)`          | Called at least `n` times.
| `AtMost(n)`           | Called at most `n` times.
| `Between(m, n)`       | Called between `m` and `n` times inclusive.
| `Exactly(n)` or `n`   | Called exactly `n` times (`0` means never called).

If `.Times()` is omitted, GoogleMock infers:

- No `.WillOnce()` or `.WillRepeatedly()` => `.Times(1)`
- `n` `.WillOnce()` and no `.WillRepeatedly()` => `.Times(n)`
- `n` `.WillOnce()` and one `.WillRepeatedly()` => `.Times(AtLeast(n))`

### Call Ordering

#### `.InSequence(sequences...)`

- Assigns expectations to one or more sequences.
- Calls to expectations in the same sequence must occur in the order they were declared.
- Using multiple sequences expresses partial orders (DAGs).

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(my_mock, Reset())
    .InSequence(s1, s2);
EXPECT_CALL(my_mock, GetSize())
    .InSequence(s1);
EXPECT_CALL(my_mock, Describe())
    .InSequence(s2);
```

Here, `Reset()` must be called before both `GetSize()` and `Describe()`, but `GetSize()` and `Describe()` can occur in any order relative to each other.

#### `.After(expectations...)`

- Specifies that this expectation will only match after one or more other expectations have been satisfied.
- Can be used to express dependencies and partial ordering.
- Accepts up to 5 `Expectation` or `ExpectationSet` objects.

Example:

```cpp
Expectation init_x = EXPECT_CALL(my_mock, InitX());
Expectation init_y = EXPECT_CALL(my_mock, InitY());
EXPECT_CALL(my_mock, Describe())
    .After(init_x, init_y);
```

This makes `Describe()` callable only after both `InitX()` and `InitY()` have been called.

### Behavior Clauses

#### `.WillOnce(action)`
- Defines the behavior for a single matching call.
- Multiple `.WillOnce()` can be chained to specify behavior for successive calls.
- If `.Times()` is not specified, the total `.WillOnce()` count implies expected call count.

Example:

```cpp
EXPECT_CALL(my_mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2));
```

The first call returns 1, the second returns 2.

#### `.WillRepeatedly(action)`
- Defines behavior for all calls after `.WillOnce()` actions are exhausted.
- Can be used only once per expectation.

Example:

```cpp
EXPECT_CALL(my_mock, GetName())
    .WillOnce(Return("John"))
    .WillRepeatedly(Return("Anonymous"));
```

The first call returns "John", subsequent calls return "Anonymous".

#### `.RetiresOnSaturation()`
- Retires the expectation once the upper bound of the call count is reached.
- Only effective for expectations with an upper-bounded `.Times()`.
- Causes subsequent matching calls to fall through to other expectations.

Example:

```cpp
EXPECT_CALL(my_mock, SetNumber(_))
    .Times(2)
    .RetiresOnSaturation();
```

After two calls matching this expectation, the expectation is retired.

---

## Using `ON_CALL`

`ON_CALL(mock_object, method(matchers...))` defines the default behavior for calls to a mock method that match the specified argument matchers. Unlike `EXPECT_CALL`, it does **not** set any expectation about the number or order of calls.

You must always specify the action with `.WillByDefault(action);`.

Example:

```cpp
ON_CALL(my_mock, Greet())
    .WillByDefault(Return("hello"));
```

This specifies that unless overridden, calling `my_mock.Greet()` will return "hello".

The `.With()` clause can be used similarly to `EXPECT_CALL` to restrict the default action to argument tuples matching the multi-argument matcher.

Important notes:

- Multiple `ON_CALL`s can be set on the same mock method; the last matching one takes precedence.
- Actions set by `ON_CALL` are superseded by actions or expectations specified in `EXPECT_CALL` for matching calls.

---

## Sequences and Ordering

GoogleMock offers powerful ways to express ordering constraints:

### `Sequence`

`Sequence` objects group expectations to enforce a strict order in which calls happen.

- Adding expectations to the same `Sequence` causes them to be valid only if called in the specified order.
- Multiple sequences can express partial orders (DAGs).

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(foo, A()).InSequence(s1, s2);
EXPECT_CALL(bar, B()).InSequence(s1);
EXPECT_CALL(bar, C()).InSequence(s2);
EXPECT_CALL(foo, D()).InSequence(s2);
```

This means `A()` must occur before `B()` and `C()`, and `C()` must be before `D()`. There is no order enforced between `B()` and `C()`.

### `InSequence` Scope Object

For convenience, creating an `InSequence` object on the stack places all `EXPECT_CALL` statements in its scope into a hidden sequence:

```cpp
{
  InSequence seq;
  EXPECT_CALL(foo, A());
  EXPECT_CALL(foo, B());
}
```

Here, `A()` and `B()` must be called in order.

### Combining `.After()` with Sequences

You can mix `.After()` calls with sequences to create complex ordering constraints.

---

## Behavior of Expectations

### Sticky Expectations

Expectations are *sticky* by default: they remain active even after their call count upper bound is reached, causing failures if called beyond the expected number. You can change this behavior by using `.RetiresOnSaturation()` or by placing expectations in sequences.

### Uninteresting vs Unexpected Calls

- **Uninteresting call**: A call to a mock method without any `EXPECT_CALL` set. By default, causes a warning but not a test failure.
- **Unexpected call**: A call to a mock method for which `EXPECT_CALL` exists but arguments do not match any expectation. Causes an error.

You can manage uninteresting calls globally with `NiceMock` (suppresses warnings) or `StrictMock` (treats warnings as failures).

---

## Verification and Resetting

GoogleMock automatically verifies all expectations on mock object destruction. You can manually verify expectations and clear them:

```cpp
Mock::VerifyAndClearExpectations(&mock_obj);  // Verifies and clears expectations only.
Mock::VerifyAndClear(&mock_obj);               // Verifies, clears expectations and default actions.
```

Manually verifying is useful if the lifetime of the mock object is managed externally or you want to trigger verification early.

---

## Practical Examples

### Example: Basic Expectation

```cpp
using ::testing::Return, ::testing::_;

MockTurtle turtle;
EXPECT_CALL(turtle, PenDown())
    .Times(1);
EXPECT_CALL(turtle, Forward(100))
    .WillOnce(Return());
```

### Example: Sequenced Calls

```cpp
Sequence s1;
EXPECT_CALL(mock, Initialize()).InSequence(s1);
EXPECT_CALL(mock, Start()).InSequence(s1);
EXPECT_CALL(mock, Stop()).InSequence(s1);
```

The calls must occur in the order: Initialize(), Start(), Stop().

### Example: Setting Default Actions

```cpp
ON_CALL(mock, GetValue()).WillByDefault(Return(42));
EXPECT_CALL(mock, GetValue()).Times(AnyNumber());
```

The mock returns 42 by default and any number of `GetValue()` calls are allowed.

### Example: Controlling Call Counts

```cpp
EXPECT_CALL(mock, SendData(_))
    .Times(Exactly(3))
    .WillRepeatedly(Return(true));
```

`SendData()` is expected to be called exactly 3 times and will return true each call.

### Example: Partial Order Using `.After()`

```cpp
Expectation e1 = EXPECT_CALL(mock, Setup());
Expectation e2 = EXPECT_CALL(mock, Connect()).After(e1);
```

`Connect()` is expected only after `Setup()` has been called.

---

## Troubleshooting Common Issues

- **Setting expectations after calls:** Always set `EXPECT_CALL` before exercising the mock. Setting expectations afterward leads to undefined behavior.
- **Overlapping expectations:** Later matching expectations override earlier ones. Order your `EXPECT_CALL` accordingly.
- **Excessive calls:** If a method is called more times than expected, it results in a test failure unless `.RetiresOnSaturation()` is used to retire expectations or a catch-all general expectation is provided.
- **Undefined default actions:** If no default action is specified and an unexpected call happens, the default value for the return type is returned or an error is signaled for non-default-constructible types.

---

## Summary

This page documents the detailed usage of `ON_CALL` and `EXPECT_CALL` macros to specify the behavior and expectations of mock methods. It guides you through defining call matchers, setting call counts, using sequences and partial ordering constraints, and verifying expectations effectively, empowering you to write clear, robust, and maintainable mock-based tests.

---

## See Also

- [Mock Class and Method Definitions](./mock-class-definitions.md) for how to define mocks.
- [Matchers and Customization](../assertions-matchers/expressive-matchers.md) for argument matcher details.
- [Mock Actions and Side Effects](./mock-actions.md) for behaviors in `WillOnce` and `WillRepeatedly`.
- [Nice, Naggy, and Strict Mocks](./strictness-modes.md) for handling uninteresting calls.
- [Using Mocks in Tests](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md#using-mocks-in-tests) for practical mock usage.
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) for recipes.

---

## Code Location

See the implementation and tests related to this page:

<Source url="https://github.com/google/googletest" branch="main" path="googlemock/include/gmock/gmock-spec-builders.h" range="1-239" />
<Source url="https://github.com/google/googletest" branch="main" path="googlemock/src/gmock-spec-builders.cc" range="1-460" />

---