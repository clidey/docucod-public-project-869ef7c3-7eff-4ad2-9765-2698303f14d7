---
title: "Setting Expectations"
description: "Instructions and patterns for specifying expected interactions using EXPECT_CALL and ON_CALL macros. Clarifies call sequences, cardinalities, actions, and error behaviors, facilitating precise interaction verification."
---

# Setting Expectations

GoogleMock empowers you to precisely specify how your mock objects are expected to behave and interact with your code under test. Setting robust and meaningful expectations ensures that your tests can detect incorrect usage patterns, missed calls, or unexpected interactions at the earliest moment.

This page guides you through the essential concepts and usage patterns for setting expectations using the `EXPECT_CALL` and `ON_CALL` macros in GoogleMock. You will learn how to specify argument matching, call counts (cardinalities), call order, and behaviors (actions), enabling you to write tests that are expressive, maintainable, and resilient.

---

## 1. Overview of Expectation Setting

In GoogleMock, expectations govern how a mock method is expected to be invoked during a test run:

- **`EXPECT_CALL` macro:** Declares that a mock method is expected to be called with certain argument patterns, a specified number of times, in particular orders if needed, and defines the behavior of the method when invoked.
- **`ON_CALL` macro:** Specifies the default behavior of a mock method when it is called without strict verification of whether the call must occur.

**Why set expectations?**

Proper expectations help ensure that your code:

- Calls the right methods on its collaborators
- Uses the correct argument values
- Calls methods the expected number of times
- Respects required call sequences

Failing to set proper expectations can allow bugs to silently pass or cause tests to fail unnecessarily from overly strict expectations.

## 2. Syntax and Basic Usage

### General `EXPECT_CALL` Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(arg_matchers...))
    .Times(cardinality)         // How many times the method is expected to be called
    .WillOnce(action)           // Behavior on the first few calls
    .WillRepeatedly(action)     // Behavior on calls after WillOnce actions
    .InSequence(sequences...)   // Specifies call order
    .After(expectations...)     // Specifies prerequisite calls
    .RetiresOnSaturation();     // When to retire expectation
```

The macro takes two arguments separated by a comma:

- The mock object instance
- The method name, optionally with matchers for arguments

**Note:** For *non-overloaded* methods, you can omit the argument matchers to express "match any arguments." For overloaded methods, you must specify arguments to avoid ambiguity.

### Simple Example

```cpp
EXPECT_CALL(turtle, PenDown())
    .Times(AtLeast(1));
```

This expectation asserts that the mock `turtle`'s `PenDown()` method will be called at least once during the test.

### Specifying Argument Matchers

You can specify expectations on method arguments with matchers.

```cpp
EXPECT_CALL(turtle, Forward(100));           // Expects `Forward` called with 100
EXPECT_CALL(turtle, GoTo(50, _));             // First arg = 50, second arg anything
EXPECT_CALL(turtle, SetColor(testing::NotNull()));  // Argument must not be NULL
```

The underscore `_` matcher means "accept any value".

## 3. Call Cardinalities

Cardinalities specify **how many times** a method call is expected.

| Cardinality          | Meaning                                          |
|----------------------|--------------------------------------------------|
| `Times(AnyNumber())` | Method can be called any number of times         |
| `Times(AtLeast(n))`  | Called at least _n_ times                         |
| `Times(AtMost(n))`   | Called at most _n_ times                          |
| `Times(Between(m, n))` | Called between _m_ and _n_ times inclusive     |
| `Times(Exactly(n))` or `Times(n)` | Called exactly _n_ times                   |
| `Times(0)`           | Method must **never** be called                   |

If you omit `.Times()`, GoogleMock infers cardinality based on the number of `.WillOnce()` and `.WillRepeatedly()` clauses:

- No `.WillOnce()` or `.WillRepeatedly()` ⇒ `Times(1)`
- *n* `.WillOnce()` and no `.WillRepeatedly()` ⇒ `Times(n)`
- *n* `.WillOnce()` and one `.WillRepeatedly()` ⇒ `Times(AtLeast(n))`

### Example: Exact Calls with Different Return Values

```cpp
using ::testing::Return;
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This means `GetX()` will be called 5 times, returning `100` and `150` on the first two calls, and `200` thereafter.

### Zero Times: Disallowing Calls

To explicitly assert that a method should not be called:

```cpp
EXPECT_CALL(foo, Bar(_))
    .Times(0);
```

This causes your test to fail if `foo.Bar()` is called with any argument.

## 4. Controlling Call Order

By default, method calls may be matched in any order. You can constrain calls to occur in a specified sequence.

### Using `InSequence` Object

Wrap your expectations in a scope with an `InSequence` object:

```cpp
{
  using ::testing::InSequence;
  InSequence seq;

  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

This expects the three calls to occur in the order specified.

### Using `Sequence` Objects

For more complex partial orderings, use `Sequence` objects and `.InSequence()` clauses:

```cpp
using ::testing::Sequence;
Sequence s1, s2;

EXPECT_CALL(foo, Reset())
    .InSequence(s1, s2);
EXPECT_CALL(foo, GetSize())
    .InSequence(s1);
EXPECT_CALL(foo, Describe())
    .InSequence(s2);
```

This specifies that `Reset()` must happen before `GetSize()` and `Describe()`, but `GetSize()` and `Describe()` may occur in any order relative to each other.

### Using `.After()` Clause

You can specify partial order with `.After()` by declaring prerequisite expectations:

```cpp
using ::testing::Expectation;

Expectation init_x = EXPECT_CALL(foo, InitX());
Expectation init_y = EXPECT_CALL(foo, InitY());
EXPECT_CALL(foo, Describe())
    .After(init_x, init_y);
```

The `Describe()` call must occur after both `InitX()` and `InitY()`.

You can also use `ExpectationSet` for a large/unfixed number of prerequisites.

## 5. Specifying Actions: What the Mock Does

Expectations not only check calls but define the mock's behavior.

- **`.WillOnce(action)`** specifies the behavior when the expectation fires for the first few times.
- **`.WillRepeatedly(action)`** specifies the behavior after all `.WillOnce()` actions are exhausted.

GoogleMock provides numerous built-in [actions](reference/actions.md). For example:

- `Return(value)` returns a value
- `ReturnRef(variable)` returns a reference
- `Invoke(function)` invokes a callable
- `DoAll(...)` sequences multiple actions
- `SetArgPointee<N>(value)` sets output arguments

### Example: Returning Different Values on Successive Calls

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(200))
    .WillRepeatedly(Return(300));
```

Each call returns different values as specified.

### Important Note on Side Effects

The action expression inside `.WillOnce()` or `.WillRepeatedly()` is evaluated only *once* during expectation setup, not each time the mock method is called. Hence:

```cpp
int n = 100;
EXPECT_CALL(turtle, GetX())
    .Times(4)
    .WillRepeatedly(Return(n++));  // Will always return 100
```

The above always returns `100` due to evaluation semantics. Use custom actions to get dynamic behavior.

## 6. Multiple Expectations and Matching Rules

You can specify multiple expectations on the same mock method, differing by argument matchers or cardinalities.

### Matching Order

GoogleMock finds the *last* (newest) expectation matching the call, allowing you to refine behaviors over time:

```cpp
EXPECT_CALL(turtle, Forward(_));       // #1 - catch-all
EXPECT_CALL(turtle, Forward(10))
    .Times(2);                         // #2 - more specific
```

Here, `Forward(10)` calls match #2 first until saturated, then match #1.

### Sticky Expectations

Expectations remain active even after reaching their max call count, causing failures on excessive calls. Use `.RetiresOnSaturation()` to deactivate expectations immediately after their saturation:

```cpp
EXPECT_CALL(turtle, GoTo(0, 0))
    .Times(2)
    .RetiresOnSaturation();
```

### Call Sequences with Sticky Behavior

It’s important to design expectations mindfully to avoid over-constraining or getting unexpected failures.

## 7. Uninteresting, Unexpected, and Excessive Calls

- **Uninteresting calls:** Calls to mock methods with no matching `EXPECT_CALL` – by default, gMock allows these but emits warnings.
- **Unexpected calls:** Calls that do not match any existing expectation with argument matchers; these cause test failures.
- **Excessive calls:** Calls that exceed the expected maximum number specified by `.Times()`; cause immediate test failures.

### Controlling Uninteresting Call Behavior

Use `NiceMock` to suppress warnings for uninteresting calls:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
```

Use `StrictMock` to treat uninteresting calls as failures:

```cpp
using ::testing::StrictMock;
StrictMock<MockFoo> mock_foo;
```

The default behavior (without these wrappers) is "naggy" which generates warnings.

## 8. Practical Tips

- Always define your expectations *before* exercising the mock object.
- Avoid setting expectations after a mock method is called; this leads to undefined behavior.
- Use `_` wildcard matchers to ignore unimportant arguments.
- Use `.Times(AnyNumber())` for methods you want to allow any number of calls without complaint.
- Prefer `ON_CALL` to setup common default behaviors, and `EXPECT_CALL` to assert important mock interactions.
- If you want to assert that a method is *never* called, specify `.Times(0)` explicitly.

## 9. Troubleshooting Common Pitfalls

- **Upper-bound violation**: If your tests fail due to too many calls to a mock method, confirm your `.Times()` specification and `.RetiresOnSaturation()` usage.
- **Uninteresting call warnings**: If you receive warnings about uninteresting calls, consider whether you should add expectations for these calls or use `NiceMock`.
- **Unexpected calls**: Verify your argument matchers to ensure calls match expected patterns.
- **Default actions missing**: If an unexpected call occurs on a mock method with no default action, it may cause throws or errors; supply `ON_CALL` default actions or use `WillRepeatedly` in `EXPECT_CALL`.

## 10. Example Walkthrough

```cpp
#include <gmock/gmock.h>
using ::testing::AtLeast;

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(PainterTest, DrawsCircleWithPenDown) {
  MockTurtle turtle;

  // Expect PenDown to be called at least once
  EXPECT_CALL(turtle, PenDown())
      .Times(AtLeast(1));

  // Expect Forward to be called five times with any arguments
  EXPECT_CALL(turtle, Forward(::testing::_))
      .Times(5);

  // Setup GetX to return dynamic values
  EXPECT_CALL(turtle, GetX())
      .WillOnce(::testing::Return(0))
      .WillOnce(::testing::Return(10))
      .WillRepeatedly(::testing::Return(20));

  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

If the code under test invokes `PenDown` fewer times than required or fails to call `Forward` five times, your test will fail.

## 11. Summary

| Concept           | Macro/Type       | Description                                   |
|-------------------|------------------|-----------------------------------------------|
| Setting an expectation on a mocked method call | `EXPECT_CALL()`     | Declare the expected calls and behavior         |
| Setting default behavior regardless of call count | `ON_CALL()`         | Set default behavior                                |
| Call argument matching | Matchers           | Match argument values for expectations            |
| Call cardinalities | `.Times()`        | Specify how many times a call is expected         |
| Call ordering | `.InSequence()`, `.After()` | Define the order of expected calls                 |
| Controlling action behaviors | `.WillOnce()`, `.WillRepeatedly()` | Specify method output and side effects        |
| Retiring expectations | `.RetiresOnSaturation()` | Deactivate expectation after saturation           |
| Uninteresting calls handling | `NiceMock`, `StrictMock` | Control warnings or failures on unexpected calls  |

## 12. Additional Resources

For deeper understanding and advanced usage, consult:

- [gMock for Dummies](docs/gmock_for_dummies.md) — Beginner-friendly guide
- [Mocking Reference](docs/reference/mocking.md) — Complete API details
- [gMock Cookbook](docs/gmock_cook_book.md) — Recipes and patterns
- [Matchers Reference](reference/matchers.md) — Argument matching details
- [Actions Reference](reference/actions.md) — Built-in actions you can use

---

<Callout title="Tip" type="info">
Always set your expectations before the method under test exercises the mocks. Setting expectations after usage leads to undefined behavior and inconsistent test results.
</Callout>

<Callout title="Warning" type="warning">
Beware of overly strict expectations that cause fragile tests. Use `ON_CALL` to set broad default behaviors and only use `EXPECT_CALL` for critical interactions you need to verify.
</Callout>

---

<AccordionGroup title="Common Patterns and Usage Examples">
<Accordion title="Defining a Mock Method and Setting Expectations">
```cpp
class MockLogger {
 public:
  MOCK_METHOD(void, Log, (int severity, const std::string& message), (override));
};

TEST(LoggingTest, LogsWarningMessage) {
  MockLogger mock_logger;

  // Expect the method to be called once with severity >= 2
  EXPECT_CALL(mock_logger, Log(::testing::Ge(2), "Disk space low"))
      .Times(1);

  // Run code that should trigger warning log
  system_under_test_->CheckDiskSpace();
}
```
</Accordion>
<Accordion title="Ordering Calls Using InSequence">
```cpp
using ::testing::InSequence;

TEST(NetworkTest, SendsHandshakeBeforeData) {
  MockConnection conn;

  {
    InSequence seq;

    EXPECT_CALL(conn, SendHandshake());
    EXPECT_CALL(conn, SendData(_));
  }

  client_->ConnectUsing(&conn);
}
```
</Accordion>
<Accordion title="Using ON_CALL for Defaults">
```cpp
class MockDB {
 public:
  MOCK_METHOD(bool, Connect, (), (override));
};

TEST(DatabaseTest, CanConnect) {
  MockDB db;

  // Provide default behavior
  ON_CALL(db, Connect())
      .WillByDefault(::testing::Return(true));

  // Expect Connect to be called
  EXPECT_CALL(db, Connect());

  // The code under test
  bool ok = db.Connect();
  EXPECT_TRUE(ok);
}
```
</Accordion>
</AccordionGroup>
