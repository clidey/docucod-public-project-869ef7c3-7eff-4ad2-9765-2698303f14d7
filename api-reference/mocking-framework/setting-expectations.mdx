---
title: "Setting Expectations and Sequences"
description: "Explains the ON_CALL and EXPECT_CALL macros, API patterns for setting up mock behavior and call expectations, and management of call order and frequency. Details how to structure and verify complex interactions."
---

# Setting Expectations and Sequences

GoogleMock provides powerful macros and patterns to precisely specify how mock objects behave and how they expect to be called. This page explains the **`ON_CALL`** and **`EXPECT_CALL`** macros, which are fundamental to setting up mock behavior and expectations, as well as how to manage the order and frequency of mock method calls using sequences.

---

## 1. Understanding `ON_CALL` and `EXPECT_CALL`

### 1.1. `ON_CALL`

`ON_CALL` configures the **default behavior** of a mock method when it is called. This does **not** create an expectation that the method must be called — it only specifies what happens if it is called.

**Syntax:**
```cpp
ON_CALL(mock_object, Method(matchers))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);         // Required
```

- Use this when you want to **allow a call but not require it**.
- The `.With()` clause restricts calls to those matching the combined argument tuple.
- The action specified by `.WillByDefault()` defines what the mock method does (e.g., return a value).

**Example:**
```cpp
using ::testing::Return;
using ::testing::_;

ON_CALL(my_mock, Calculate(_, _))
    .WillByDefault(Return(42));
```
This sets up `Calculate` to return `42` whenever called with any arguments unless overridden by an `EXPECT_CALL`.

### 1.2. `EXPECT_CALL`

`EXPECT_CALL` both **sets the behavior** and **creates an expectation** that the mock method **will be called**.

**Syntax:**
```cpp
EXPECT_CALL(mock_object, Method(matchers))
    .With(multi_argument_matcher)          // Optional, must come first
    .Times(cardinality)                    // Optional
    .InSequence(sequences...)              // Optional, zero or more
    .After(expectations...)                // Optional, zero or more
    .WillOnce(action)                      // Zero or more
    .WillRepeatedly(action)                // Optional
    .RetiresOnSaturation();                // Optional
```

- If `.Times()` is omitted, gMock infers the call count from `.WillOnce()` / `.WillRepeatedly()` clauses.
- The method calls need to satisfy each clause’s conditions.
- Use to **verify expected interactions**, such as "method X must be called 3 times with specific arguments." 

**Example:**
```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::AtLeast;

EXPECT_CALL(my_mock, ReadData(Truly(IsValidId)))
    .Times(AtLeast(2))
    .WillOnce(Return(true))
    .WillRepeatedly(Return(false));
```
This expects `ReadData` to be called at least twice, returns true the first time and false after.

---

## 2. Specifying Argument Expectations (`Matchers`)

Both macros allow detailed argument matching:

- Use exact values (e.g., `EXPECT_CALL(m, Foo(5))`).
- Use wildcards (`_`) to match any value.
- Use built-in matchers (`Ge`, `Le`, `NotNull`, etc.) to specify argument constraints.
- Use `.With()` to apply a matcher over the entire argument tuple.

**Tip:** Specify only the arguments you care about to avoid brittle tests.

---

## 3. Controlling Call Frequency (`Times`)

The `.Times()` clause controls how many times a call is expected:

| Cardinality           | Meaning                            |
|----------------------|----------------------------------|
| `Exactly(n)` or `n`  | Exactly `n` times                 |
| `AtLeast(n)`          | At least `n` times                |
| `AtMost(n)`           | At most `n` times                 |
| `Between(m, n)`       | Between `m` and `n` times         |
| `AnyNumber()`         | Any number of times               |

If omitted, gMock uses the rules:

- No `.WillOnce()` or `.WillRepeatedly()`: `Times(1)`
- `n` `.WillOnce()` without `.WillRepeatedly()`: `Times(n)`
- `n` `.WillOnce()` with `.WillRepeatedly()`: `Times(AtLeast(n))`

**Example:**
```cpp
EXPECT_CALL(mock, Write(_))
    .Times(0);  // Expects Write not to be called
```

---

## 4. Managing Call Order

### 4.1. `InSequence` Clause & `InSequence` Object

#### `InSequence` Clause

- Assign `EXPECT_CALL`s to one or multiple `Sequence` objects.
- Expectations within the same sequence must be satisfied in the order they were declared.

Example:
```cpp
using ::testing::Sequence;

Sequence s1, s2;
EXPECT_CALL(mock, Open()).InSequence(s1, s2);
EXPECT_CALL(mock, Read()).InSequence(s1);
EXPECT_CALL(mock, Close()).InSequence(s2);
```
This means `Open()` must come before `Read()` and `Close()`, but `Read()` and `Close()` can be in any order relative to each other.

#### `InSequence` Object

- Declared on the stack.
- All `EXPECT_CALL`s inside its scope are put into a hidden anonymous sequence.

Example:
```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Connect());
  EXPECT_CALL(mock, Disconnect());
}
```
Calls to `Connect()` and `Disconnect()` **must occur in the order specified**.

### 4.2. `After` Clause

- Use `.After()` to specify that an expectation depends on one or several other expectations being satisfied first.

Example:
```cpp
auto init = EXPECT_CALL(mock, Initialize());
EXPECT_CALL(mock, Execute()).After(init);
```
This enforces that `Execute()` call must happen only after `Initialize()`.

---

## 5. Using Multiple Expectations on the Same Method

- Setting multiple expectations on the same mock method is possible.
- gMock searches expectations **in reverse order** to find a match,
  allowing newer, more specific expectations to override older, more general ones.

Example:
```cpp
EXPECT_CALL(mock, Save(_)).Times(AnyNumber());  // general
EXPECT_CALL(mock, Save(42)).Times(3);           // specific
```
Calls to `Save(42)` will match the second expectation first. If it's called more than 3 times, an error is reported.

---

## 6. Managing Sticky Expectations

Expectations are **sticky** by default, meaning they remain active even after reaching their call limits, causing upper-bound errors if violated. 

To make expectations retire immediately once saturated, use `.RetiresOnSaturation()`:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .RetiresOnSaturation();
```

This is critical when defining sequences or when call count matters.

---

## 7. Best Practices and Common Pitfalls

- Always set expectations **before** exercising mocks to avoid undefined behavior.
- Use `ON_CALL` for default behaviors and `EXPECT_CALL` only for calls you want to verify.
- Use sequences to verify call order when it matters, but avoid over-specifying order unnecessarily.
- Beware that `EXPECT_CALL`s with overlapping matchers can shadow each other depending on order.
- Use `.Times(0)` to explicitly disallow calls.
- Use `NiceMock` to suppress warnings for uninteresting calls, or `StrictMock` to treat them as errors.
- Use `.RetiresOnSaturation()` to prevent upper-bound errors in multi-call expectations.

---

## 8. Verification and Cleaning up

- GoogleMock automatically verifies expectations when mock objects are destroyed.
- To verify and clear expectations earlier, use:

```cpp
using ::testing::Mock;

Mock::VerifyAndClearExpectations(&mock_obj);
```

- To allow intentional mock leaks without verification errors, call:

```cpp
Mock::AllowLeak(&mock_obj);
```

---

## 9. Illustrative Example

```cpp
#include <gtest/gtest.h>
#include <gmock/gmock.h>

using ::testing::AtLeast;
using ::testing::Return;
using ::testing::_;
using ::testing::InSequence;

class MockTurtle {
 public:
  MOCK_METHOD(void, PenUp, (), ());
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(void, Forward, (int), ());
  MOCK_METHOD(int, GetX, (), ());
};

TEST(PainterTest, DrawsSimpleLine) {
  MockTurtle turtle;

  {
    InSequence seq;
    EXPECT_CALL(turtle, PenDown());
    EXPECT_CALL(turtle, Forward(100)).Times(AtLeast(1));
    EXPECT_CALL(turtle, PenUp());
  }

  ON_CALL(turtle, GetX()).WillByDefault(Return(0));

  // Exercise code that uses turtle mock...
  turtle.PenDown();
  turtle.Forward(100);
  turtle.PenUp();

  // GetX called without strict expectation, uses default action.
  int x = turtle.GetX();
  EXPECT_EQ(x, 0);
}
```

This test verifies that a drawing sequence calls turtle methods in the specified order and number, while a getter uses the default behavior.

---

## 10. Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — beginner-friendly introduction.
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) — quick reference of macros and patterns.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — practical recipes.
- [Matchers Reference](../core-testing-framework/matchers-api.mdx) — detailed argument matching.
- API sections on [Mocking Methods and Classes](../mocking-framework/mocking-and-method-mocking.mdx).

---

<AccordionGroup title="Common Questions and Troubleshooting">
<Accordion title="Why is order of EXPECT_CALL important?">
GoogleMock searches expectations in reverse order so more specific or later expectations override earlier ones. Overlapping expectations may unintentionally shadow each other if ordered incorrectly. Use sequences to precisely control call order.
</Accordion>
<Accordion title="What happens if a call exceeds Times()?">
An error will be immediately reported signaling an upper-bound violation. Use `.RetiresOnSaturation()` to retire expectations when saturated and avoid excessive call errors.
</Accordion>
<Accordion title="How to set default behavior for a mock method?">
Use `ON_CALL` with `.WillByDefault()` to set behavior without setting an expectation for call count or ordering.
</Accordion>
<Accordion title="How to enforce call order but allow some flexibility?">
Use `Sequence` objects combined with `InSequence` and `.After()` clauses to specify exact or partial ordering among expectations.
</Accordion>
</AccordionGroup>