---
title: "Setting Expectations with EXPECT_CALL and ON_CALL"
description: "Comprehensive guide to specifying how mocks should behave: defining expected calls, argument matchers, sequencing, return values, and side effects. Explore the ON_CALL and EXPECT_CALL macros and related utility classes, with tips on flexible matching and behavior composition."
---

# Setting Expectations with EXPECT_CALL and ON_CALL

Comprehensive guide to specifying how mocks should behave: defining expected calls, argument matchers, sequencing, return values, and side effects. Explore the ON_CALL and EXPECT_CALL macros and related utility classes, with tips on flexible matching and behavior composition.

---

## Introduction

When working with GoogleMock, controlling how your mock objects respond to method calls is pivotal for creating meaningful and robust tests. This page focuses exclusively on the powerful mechanisms for setting these behaviors and expectations via the `EXPECT_CALL` and `ON_CALL` macros.

`EXPECT_CALL` not only defines how a mock should behave on specific calls but also establishes formal expectations — specifying which calls should happen, how often, and in what order. In contrast, `ON_CALL` is intended for defining default behaviors without imposing call expectations.

This guide unpacks the syntax, usage patterns, and utilities essential for mastering mock call specifications, empowering you to craft precise and maintainable tests that validate your code's interactions effectively.

---

## Core Concepts of Setting Expectations

### What is EXPECT_CALL?

- Defines an expectation that a particular method will be called with specified argument constraints.
- Allows detailed control over call Cardinality (how many times expected), ordering, and behavior.
- Triggers verification failures if expectations are not met or are violated during test execution.

### What is ON_CALL?

- Specifies default behavior for matching calls to mock methods.
- Does **not** set any expectations about whether calls occur or how often.
- Acts as a fallback, overridden by more specific `EXPECT_CALL`s if present.

---

## Syntax and Usage

### General Syntax for EXPECT_CALL

```cpp
EXPECT_CALL(mock_object, Method(arg_matchers...))
    .With(multi_argument_matcher)    // Optional, at most once
    .Times(cardinality)              // Optional, at most once
    .InSequence(sequences...)        // Optional, any number of times
    .After(expectations...)          // Optional, any number of times
    .WillOnce(action)                // Optional, any number of times
    .WillRepeatedly(action)          // Optional, at most once
    .RetiresOnSaturation();          // Optional, at most once
```

### General Syntax for ON_CALL

```cpp
ON_CALL(mock_object, Method(arg_matchers...))
    .With(multi_argument_matcher)    // Optional, at most once
    .WillByDefault(action);          // **Required once**
```

### Argument Matchers

- Use specific matchers (e.g., `Eq()`, `Ge()`, `_` for wildcard) for each argument to precisely define when the expectation applies.
- Omitting arguments in `EXPECT_CALL` selects the overload for non-overloaded methods, matching calls with any arguments.
- The `.With()` clause lets you impose constraints on the **entire** argument tuple, enabling assertions on inter-argument relationships.

### Cardinalities (Times)

Control how many times a particular call is expected:

| Cardinality         | Description                                 |
|---------------------|---------------------------------------------|
| `Exactly(n)` or `n` | Exactly n times. If n=0, call should never happen. |
| `AnyNumber()`        | Any number of times.                          |
| `AtLeast(n)`        | At least n times.                            |
| `AtMost(n)`         | At most n times.                             |
| `Between(m, n)`     | Between m and n times (inclusive).          |

If omitted, GoogleMock infers cardinality based on presence of `.WillOnce()` and `.WillRepeatedly()` clauses.

### Ordering Calls

- **InSequence**: Enforce that expectations happen strictly in the order declared within a sequence.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

- **InSequence(sequences...)**: Assign expectations to multiple explicit `Sequence` objects to enforce partial ordering.
- **After(expectations...)**: Specify that an expectation can only be matched after one or more other expectations have been satisfied.

### Specifying Behavior

- `.WillOnce(action)`: Define behavior for a single call; multiple `.WillOnce()` clauses specify behaviors for successive calls.
- `.WillRepeatedly(action)`: Defines behavior for all subsequent calls after the `.WillOnce()` clauses are exhausted.
- `.WillByDefault(action)`: Used with `ON_CALL` to define the default behavior.

### Retiring Expectations

- `.RetiresOnSaturation()`: Indicates that once the expectation's invocation count reaches its upper bound, it will no longer match calls.
- Useful to chain distinct behaviors on the same method call sequence.

---

## Practical Examples

### Basic Expectation

Expect that `DoSomething()` is called exactly once:

```cpp
EXPECT_CALL(mock_object, DoSomething());
```

### Expect with Argument Matchers

Expect `Process` called with `x >= 5`:

```cpp
using ::testing::Ge;
EXPECT_CALL(mock_object, Process(Ge(5)));
```

### Specifying Cardinality and Return Values

Expect exactly 3 calls to `GetValue()`, returning 10, 20, 30:

```cpp
using ::testing::Return;
EXPECT_CALL(mock, GetValue())
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillOnce(Return(30));
```

### Sequenced Calls

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Reset())
    .InSequence(s1, s2);
EXPECT_CALL(mock, GetSize())
    .InSequence(s1);
EXPECT_CALL(mock, Describe())
    .InSequence(s2);
```

This enforces that `Reset()` happens before both `GetSize()` and `Describe()`, and that `GetSize()` and `Describe()` follow their respective partial orders.

### Using ON_CALL to Define Defaults

```cpp
ON_CALL(mock, GetStatus())
    .WillByDefault(Return("OK"));
```

If there is no matching `EXPECT_CALL`, calling `GetStatus()` returns `"OK"`.

### Combining ON_CALL and EXPECT_CALL

Use `ON_CALL` for common default behavior, and `EXPECT_CALL` to verify specific calls:

```cpp
ON_CALL(mock, Compute(_)).WillByDefault(Return(0));
EXPECT_CALL(mock, Compute(42)).WillOnce(Return(100));

// Calls with argument 42 will return 100 and must be called once
// Others will return 0 by default.
```

### Retiring Expectations Example

```cpp
EXPECT_CALL(mock, Update(5)).Times(2).RetiresOnSaturation();
EXPECT_CALL(mock, Update(_)).Times(AnyNumber());

// The first two calls to Update(5) match the first expectation, which retires after 2 calls.
// Further calls to Update(5) will match the more general expectation.
```

---

## Best Practices and Tips

- **Set Expectations Before Invocation:** Always specify `EXPECT_CALL` before the call happens to avoid undefined behavior.
- **Use ON_CALL for Mocks Setup:** Use `ON_CALL` in test setup or constructors for default behavior; reserve `EXPECT_CALL` for expectations you care to verify.
- **Avoid Overly Specific Matchers:** Too strict argument matching leads to brittle tests.
- **Use Sequences or `After` for Ordered Calls:** To enforce call ordering, use `InSequence` or `.After()` clauses.
- **Leverage `.RetiresOnSaturation()` to handle repeated calls gracefully.**
- **Suppress Uninteresting Call Warnings:** Use `NiceMock` or catch-all `EXPECT_CALL(...).Times(AnyNumber())` as appropriate.

---

## Common Pitfalls and Troubleshooting

<AccordionGroup title="Common Issues with EXPECT_CALL and ON_CALL">
<Accordion title="'Uninteresting mock function call' warning">
When you see warnings about uninteresting calls, it means the method was called but no explicit expectation was set.

- If the call is truly irrelevant, consider wrapping your mock in `NiceMock`.
- If you mean to allow any calls, add a catch-all expectation with `Times(AnyNumber())`.
- Avoid adding empty `EXPECT_CALL` as it increases maintenance burden.
</Accordion>
<Accordion title="Unexpected method calls despite ON_CALL">
This happens because `ON_CALL` defines behavior but not an expectation.

- Add an `EXPECT_CALL` if you need to validate that a call definitely happens.
- Remember that `EXPECT_CALL` has precedence over `ON_CALL`.
</Accordion>
<Accordion title="Mismatched argument errors">
Verify argument matchers are correct and not too restrictive.

- Use `_` to wildcard arguments that don’t matter.
- Utilize `.With()` for complex multi-argument conditions instead of over-specifying individual arguments.
</Accordion>
<Accordion title="Excessive call failures">
Occurs when a mock function is called more times than specified in `Times()`.

- Adjust cardinalities to reflect expected usage.
- Use `.RetiresOnSaturation()` to retire expectations after use.
- Chain `.WillOnce()` and `.WillRepeatedly()` actions appropriately.
</Accordion>
</AccordionGroup>

---

## Utilities and Related Classes

| Class/Utility       | Purpose                                                     |
|---------------------|-------------------------------------------------------------|
| `Sequence`          | Represents a call sequence for ordering expectations        |
| `InSequence`        | Scope object to impose ordering on contained `EXPECT_CALL`s |
| `Expectation`       | Handle returned from `EXPECT_CALL` to specify ordering or chaining with `.After()` |
| `ExpectationSet`    | A set of `Expectation`s used in more advanced ordering with `.After()` |
| `NiceMock<T>`       | Suppresses warnings on unexpected/uninteresting calls       |
| `StrictMock<T>`     | Treats unexpected/uninteresting calls as test failures      |

---

## Summary

Master the use of `EXPECT_CALL` and `ON_CALL` to articulate how mocks should behave and what calls should be expected during your test flows. Proper application of argument matchers, call cardinalities, and ordering constructs like sequences enables you to craft tests that verify code interactions with precision and clarity.

Use `ON_CALL` to define defaults and `EXPECT_CALL` for verifiable expectations, remembering to prefer clear, maintainable matchers and to sequence calls when order matters.

---

## Further Reading and References

- [GoogleMock Mocking Reference](reference/mocking.md#EXPECT_CALL)
- [gMock for Dummies: Setting Expectations](gmock_for_dummies.md#setting-expectations)
- [gMock Cookbook: Expectations and Actions](guides/mocking_patterns/expectations_and_actions.md)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](reference/actions.md)

---

## Example

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;
using ::testing::Sequence;

class MockPrinter {
 public:
  MOCK_METHOD(void, Print, (int value), ());
  MOCK_METHOD(void, Print, (const char* message), ());
};

TEST(PrinterTest, OrderedPrints) {
  MockPrinter printer;
  Sequence seq;

  EXPECT_CALL(printer, Print(42)).InSequence(seq);
  EXPECT_CALL(printer, Print(_)).InSequence(seq);
  EXPECT_CALL(printer, Print("Done")).InSequence(seq);

  printer.Print(42);
  printer.Print(100);
  printer.Print("Done");
}

TEST(PrinterTest, DefaultBehavior) {
  MockPrinter printer;
  ON_CALL(printer, Print(_)).WillByDefault(Return());

  // All prints do nothing unless specified in EXPECT_CALL.
  printer.Print(123);
}
```

---