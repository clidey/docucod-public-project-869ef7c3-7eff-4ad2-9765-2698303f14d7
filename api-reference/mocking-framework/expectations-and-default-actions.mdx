---
title: "Expectations and Default Actions"
description: "API details for specifying expected interactions with mocks: ON_CALL and EXPECT_CALL macros, expectation configuration, return policies, default value management, and call count controls (cardinalities). Practical examples help users set up and verify complex behaviors."
---

# Expectations and Default Actions

This document provides detailed API reference information for specifying expected interactions with mock objects using GoogleMock’s `EXPECT_CALL` and `ON_CALL` macros. It covers how to configure expectations, control call counts (cardinalities), define default behavior, and manage return policies. Through practical examples, you will learn to set up complex mock behaviors, tune mocking precision, and verify interactions effectively.

---

## Overview of Expectations

In GoogleMock, *expectations* specify how mock methods are expected to be called during tests. Expectations are set using `EXPECT_CALL` and influence:

- Which methods must be invoked,
- The arguments they should receive,
- How many times calls should happen (cardinalities),
- The order of calls relative to other expectations.

Setting the right expectations guards against unexpected or missing calls during test execution.

## Setting Expectations with `EXPECT_CALL`

The `EXPECT_CALL` macro establishes an expectation on a mock object's method:

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher)        // Optional, used once
    .Times(cardinality)                  // Optional, used once
    .InSequence(sequences...)            // Optional, any number
    .After(expectations...)              // Optional, any number
    .WillOnce(action)                    // Optional, any number
    .WillRepeatedly(action)              // Optional, once
    .RetiresOnSaturation();              // Optional, once
```

- **Basic Syntax:**

  - `mock_object`: The mock instance.
  - `MethodName`: The mock method expected to be called.
  - `matchers...`: Argument constraints, matching the method’s parameters.

- **Chained clauses** must be used in the order shown above.

### 1. Matchers—Specifying Expected Arguments

Matchers declare which arguments are allowed or expected for the call. Use:

- Exact value matching: e.g., `EXPECT_CALL(foo, Bar(5))` expects 5.
- Wildcard matcher `_` to accept any argument.
- Rich matchers like `Lt(10)`, `Ge(0)`, `NotNull()`, and custom predicates.
- Omit parameters for non-overloaded methods to accept any arguments.

### 2. Restricting with `.With` Clause

Use `.With(multi_argument_matcher)` to match arguments as a tuple condition. This allows expressing compound conditions over multiple parameters, such as the first argument less than the second:

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .With(Lt());  // Matches pairs where first arg < second arg
```

This clause can appear at most once and must be the first clause after `EXPECT_CALL`.

### 3. Cardinalities with `.Times`

The `.Times()` clause controls how often the method call is expected. Common cardinalities:

| Cardinality   | Meaning                                    |
|---------------|--------------------------------------------|
| `AnyNumber()` | Call allowed any number of times           |
| `AtLeast(n)`  | Call at least n times                       |
| `AtMost(n)`   | Call at most n times                        |
| `Between(m,n)`| Call between m and n times (inclusive)     |
| `Exactly(n)` or `n` | Call exactly n times, including 0 to disallow calls |

If omitted, GoogleMock infers cardinality:

- No `WillOnce` or `WillRepeatedly` clauses: implies `Times(1)`.
- `n` `WillOnce` clauses only: implies `Times(n)`.
- `n` `WillOnce` clauses + one `WillRepeatedly`: implies `Times(AtLeast(n))`.

### 4. Ordering with `.InSequence` and `.After`

Use `.InSequence()` to specify expectations that must be matched in order:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, A()).InSequence(s1);
EXPECT_CALL(mock, B()).InSequence(s1, s2);
EXPECT_CALL(mock, C()).InSequence(s2);
```

`.After()` allows specifying that a call should occur only after other expectations have been satisfied:

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Run()).After(e1);
```

### 5. Defining Return or Behavior with `.WillOnce` and `.WillRepeatedly`

These clauses define what happens when a mock method is invoked.

- `.WillOnce(action)` specifies behavior for the next *one* call matching this expectation.
- `.WillRepeatedly(action)` specifies behavior for *all subsequent* calls after `WillOnce` clauses are used.

Example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

- First call returns 1, second 2, all subsequent 3.

### 6. Controlling Expectation Lifetime with `.RetiresOnSaturation`

By default, expectations remain *sticky*: they do not retire even after reaching their call count limit, which can cause over-saturation errors on extra calls. Use `.RetiresOnSaturation()` to automatically deactivate an expectation after it reaches its upper bound:

```cpp
EXPECT_CALL(mock, Foo(7))
    .Times(2)
    .RetiresOnSaturation();
```

Thus, once the method is called twice with 7, this expectation retires and other expectations or default rules can match subsequent calls.

## Specifying Default Behavior with `ON_CALL`

`ON_CALL` defines default actions taken by mock methods but does *not* impose any expectation on those methods being called. This is useful for test setup to specify typical behavior without enforcing call counts.

### Syntax

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher)   // Optional, once
    .WillByDefault(action);          // Required
```

Rules:

- `.WillByDefault()` must be specified exactly once.
- `.With()` may be specified at most once and must precede `.WillByDefault()`.

Example:

```cpp
ON_CALL(mock, GetSize(_))
    .WillByDefault(Return(100));
```

Default behavior specified by the last matching `ON_CALL` takes precedence. `EXPECT_CALL` behavior supersedes `ON_CALL` behavior.

## Difference Between `EXPECT_CALL` and `ON_CALL`

- `EXPECT_CALL` means you *expect* the method to be called a certain number of times.
- `ON_CALL` means you define *what happens* if the method is called, but do not require it.

Use `ON_CALL` to define typical behavior once.
Use `EXPECT_CALL` to verify your code's interaction and to enforce call counts.

## Default Actions and Return Values

- By default, methods returning builtin or default-constructible types will:
  - Return 0, false, nullptr, or default constructed values as appropriate.
- If you want to customize the default return value for a *type* throughout your tests, use the `DefaultValue<T>` API:

```cpp
DefaultValue<MyType>::Set(my_default_value);
DefaultValue<MyType>::Clear();
```

- For method-specific default behaviors, prefer `ON_CALL`.

## Managing Multiple Expectations

- GoogleMock matches calls to the *newest* (last declared) matching active expectation.
- If an expectation's call count is exceeded (over-saturated), a failure happens.
- Expectations are *sticky*: they remain active even after saturation, unless `.RetiresOnSaturation()` is used.
- You can use a catch-all expectation with `EXPECT_CALL(...).Times(AnyNumber())` to accept all calls.

## Controlling Mock Behavior on Uninteresting Calls

- **Uninteresting call:** A call to a method with no `EXPECT_CALL` expectation.
- By default, GoogleMock warns on uninteresting calls, but does not fail the test.
- Use `NiceMock` to suppress warnings on uninteresting calls.
- Use `StrictMock` to treat uninteresting calls as failures.

## Forcing Verification and Reset

- Mocks automatically verify expectations on destruction.
- To verify before destruction or if you suspect leaks:

```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(&mock));
```

- To clear both expectations and default behaviors:

```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClear(&mock));
```

- Avoid setting new expectations after clearing a mock.

## Practical Examples

### Setting an Expectation with Cardinalities and Actions

```cpp
using ::testing::Return;
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This expects5 calls. The first two calls return 100, then 150, the rest return 200.

### Defining Default Action Without Expectation

```cpp
ON_CALL(turtle, GetY()).WillByDefault(Return(42));
```

If no `EXPECT_CALL` specifies `GetY`, calls will return 42.

### Sequencing Calls

```cpp
{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

The calls must occur in this order or the test will fail.

### Avoiding Sticky Expectation Problems

```cpp
for (int i = n; i > 0; i--) {
  EXPECT_CALL(turtle, GetX())
      .WillOnce(Return(10*i))
      .RetiresOnSaturation();
}
```

This sequence defines multiple expectations that retire when saturated, avoiding upper-bound errors.

## Common Pitfalls and Best Practices

- Never call mock methods before setting `EXPECT_CALL` expectations. Behavior is undefined.
- Matchers must be functional and free of side effects.
- Over-specification of argument matchers or cardinalities can make tests brittle.
- Use `.RetiresOnSaturation()` when chaining multiple expectations that should deactivate after use.
- Understand distinction between `ON_CALL` and `EXPECT_CALL` to write robust tests.
- Use sequences (`InSequence` or `After`) to enforce call order only when relevant.

## Troubleshooting Verification Failures

- Run tests with `--gmock_verbose=info` to get detailed traces of mock calls and matching expectations.
- Look for messages about uninteresting, unexpected, excessive calls.
- Use `NiceMock` and `StrictMock` appropriately if warnings or failures on uninteresting calls are confusing.
- Use `Mock::VerifyAndClearExpectations()` to catch verification issues before destructor.

---

## Summary

- Use `EXPECT_CALL` to set explicit mock method call expectations with argument constraints, call counts, sequencing,
and actions.
- Use `ON_CALL` to define default mock method behavior without enforcing calls.
- Cardinalities in `Times()` control expected call quantities.
- `.WillOnce()` and `.WillRepeatedly()` clauses configure return values and side effects.
- Control call order with `InSequence` and `After`.
- Use `RetiresOnSaturation()` to automatically deactivate expectations when saturated.
- Handle uninteresting calls using `NiceMock`, `StrictMock`, or default behavior.
- Verify expectations explicitly when needed using mock verification APIs.

---

## Additional References

- [Defining Mock Objects and Methods](../api-reference/mocking-framework/mock-objects-and-methods.md)
- [Matchers Reference](../api-reference/actions-matchers-extensions/matchers-library-and-customization.md)
- [Actions Reference](../api-reference/actions-matchers-extensions/action-templates-and-custom-actions.md)
- [GoogleMock for Dummies](../docs/gmock_for_dummies.md)
- [Mocking Reference](../docs/reference/mocking.md)
- [gMock Cookbook](../docs/gmock_cook_book.md)

---

_Source code and detailed unit test coverage are available in the GoogleMock repository._

<Source url="https://github.com/google/googletest" branch="main" paths='[{"path":"googlemock/include/gmock/gmock-spec-builders.h","range":"1-393"},{"path":"googlemock/src/gmock-spec-builders.cc","range":"1-298"}]' />