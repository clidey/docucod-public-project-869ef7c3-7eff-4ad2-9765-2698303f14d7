---
title: "Mock Actions and Cardinalities"
description: "Explore action builders for customizing mock responses, from returning values and invoking callbacks to composing more advanced call behaviors. Understand cardinality constraints to specify how many times an expectation must be satisfied."
---

# Mock Actions and Cardinalities

Google Mock provides a rich set of action builders and cardinality constraints that enable users to precisely specify how mock methods behave and how often they are expected to be called. This page explores these facilities, helping you customize mock responses, specify call order and frequency, and model complex interactions in your tests.

---

## Overview

In Google Mock, **actions** define what a mock method does when it is invoked, including returning specific values, modifying arguments, or invoking callbacks. **Cardinalities** specify constraints on how many times a mock method is expected to be called, enabling flexible but exact test verifications.

Bootstrapping your mock methods with appropriate actions and cardinalities ensures your unit tests observe behavior accurately and fail when contracts are violated.

---

## Actions: Customizing Mock Responses

Actions control the behavior of mocked methods when they are called. Without explicitly specified actions, Google Mock either returns default values or no-ops based on the return type.

### Returning Values

- **`Return(value)`**: Returns a specific copy of `value` every time the mock method is called.

- **`ReturnRef(variable)`**: Returns a reference to the specified variable, useful when mock methods return references.

- **`ReturnPointee(pointer)`**: Returns the value pointed to by `pointer` each time the method is called, allowing dynamic return values.

**Example:**
```cpp
EXPECT_CALL(mock_object, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```
This sequence returns 1 and 2 for the first two calls, then always returns 3.

### Invoking Callbacks and Functions

You can use functions, functors, or lambdas as actions:

- **`Invoke(callable)`**: Calls the specified function, method, lambda, or functor with the mock function’s arguments.

- **`InvokeWithoutArgs(callable)`**: Invokes the callable ignoring any mock method arguments.

- **`InvokeArgument<N>(args...)`**: Calls the N-th (0-based) argument (assumed to be a callable) with the specified arguments, simulating callbacks.

**Example:**
```cpp
EXPECT_CALL(mock, DoWork(_, _))
    .WillOnce(InvokeArgument<1>(42)); // invoke callback at argument #1
```

### Combining Multiple Actions

- **`DoAll(action1, action2, ..., actionN)`**: Executes multiple actions sequentially when invoked. The return value of the last action is used as the mock method’s return value.

**Example:**
```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```
This sets the first argument pointed value to 5 and returns true.

### Modifying Output Arguments

- **`SetArgPointee<N>(value)`**: Sets the value pointed to by the N-th argument.

- **`SetArrayArgument<N>(begin, end)`**: Copies a range of values into the array pointed to by the N-th argument.

**Example:**
```cpp
int arr[3] = {1, 2, 3};
EXPECT_CALL(mock, FillArray(_))
    .WillOnce(SetArrayArgument<0>(arr, arr + 3));
```

### Ignoring Action Results

- **`IgnoreResult(action)`**: Converts an action’s return value to void, useful when mocking void functions or combining actions.

### Selecting Arguments Passed to Actions

- **`WithArgs<Indices...>(action)`**: Calls the specified action with selected arguments from the mock method.

- **`WithoutArgs(action)`**: Calls an action that takes no arguments.

- **`WithArg<N>(action)`**: Calls an action with only the N-th argument.

### Parameterizing Actions

Google Mock provides macros `ACTION_P()`, `ACTION_P2()`, and `ACTION_TEMPLATE()` to define actions with parameters and enable reuse with different input values.

### Defining Custom Action Classes

You can also implement your own action classes by defining a call operator compatible with your mock function’s signature.

---

## Cardinalities: Specifying Call Counts

Google Mock’s cardinalities allow you to specify *how many times* a mock method is expected to be called.

### Built-in Cardinalities

| Cardinality       | Description                                |
|-------------------|--------------------------------------------|
| `Times(AnyNumber())` or `AnyNumber()`   | Supports any number of calls.
| `Times(AtLeast(n))`        | Called at least *n* times.
| `Times(AtMost(n))`         | Called at most *n* times.
| `Times(Between(m, n))`     | Called between *m* and *n* times inclusive.
| `Times(Exactly(n))` or `Times(n)` | Called exactly *n* times.

### Default Cardinality Behavior

- When no `Times()` is specified,
  - *and no* `WillOnce` or `WillRepeatedly` is specified: inferred as `Times(1)`.
  - *and* there are *n* `WillOnce` clauses but no `WillRepeatedly`: inferred as `Times(n)`.
  - *and* there are *n* `WillOnce` clauses and a `WillRepeatedly`: inferred as `Times(AtLeast(n))`.

### Custom Cardinalities

You can implement your own cardinality by subclassing the `CardinalityInterface`.

**Example:** Defining a cardinality for an even number of calls.
```cpp
class EvenNumberCardinality : public testing::CardinalityInterface {
 public:
  bool IsSatisfiedByCallCount(int call_count) const override {
    return (call_count % 2) == 0;
  }

  bool IsSaturatedByCallCount(int call_count) const override {
    return false;  // Never saturated
  }

  void DescribeTo(std::ostream* os) const override {
    *os << "called even number of times";
  }
};

Cardinality EvenNumber() {
  return MakeCardinality(new EvenNumberCardinality);
}

EXPECT_CALL(mock, Foo()).Times(EvenNumber());
```

### Controlling Expectation Lifetimes

- **`RetiresOnSaturation()`**: Marks an expectation to retire (become inactive) once its call upper bound is reached. This helps avoid conflicts with more general expectations.

---

## Best Practices and Tips

- **Set expectations before exercising mocks** to avoid undefined behaviors.
- Use **`ON_CALL` to specify default behavior** without mandating call counts.
- Use **`EXPECT_CALL` to enforce** that a call *must* be made with given arguments and cardinalities.
- Compose **multiple `EXPECT_CALL`s carefully**; the last matching expectation takes precedence.
- Use **`InSequence` and `After` clauses** to impose call order when necessary.
- Be mindful that **uninteresting calls produce warnings by default**; suppress using `NiceMock` or specify expectations accordingly.
- Use **`WillOnce` and `WillRepeatedly`** judiciously to define sequences of behaviors.
- Define **custom actions** or **delegates** for complex behavior, such as delegating to a real or fake object.

---

## Troubleshooting Common Issues

- **Mismatch in call counts** leads to test failures with detailed messages describing expected and actual invocation counts.
- **Too many or too few actions** relative to cardinality cause warnings.
- **Overloaded methods** may require disambiguation when setting expectations or actions.
- **Unintended infinite recursion** can occur if delegating to parent or real implementations improperly; use explicit class scopes.

---

## Related Resources

- [MOCK_METHOD Macro](docs/reference/mocking.md#MOCK_METHOD): Defining mock methods with qualifiers.
- [EXPECT_CALL Macro](docs/reference/mocking.md#EXPECT_CALL): Setting call expectations with matching, cardinality, and actions.
- [ON_CALL Macro](docs/reference/mocking.md#ON_CALL): Defining default mock method behaviors without expectations.
- [Matchers Reference](reference/matchers.md): For argument matching details.
- [gMock Cookbook](docs/gmock_cook_book.md): Comprehensive recipes for more advanced mocking techniques.

---

For complete and effective testing, combine your understanding of mock actions and cardinalities to precisely model your expected interactions while maintaining test readability and robustness.

---