---
title: "Defining Custom Matchers"
description: "Guidance on extending GoogleTest with user-defined matchers for domain-specific validation. Offers templates, recommended patterns, and practical examples."
---

# Defining Custom Matchers

Extending GoogleTest with user-defined matchers empowers you to tailor assertions to your domain-specific needs, enabling expressive and precise verification beyond built-in matchers. This guide walks you through the patterns and facilities for creating custom matchers, helping you verify complex conditions and produce informative test failure messages.

---

## Why Define Custom Matchers?

Built-in matchers in GoogleTest cover a wide range of standard types and conditions, but many real-world tests require validations unique to your particular application domain or data types. Custom matchers allow you to encapsulate these checks in reusable, readable constructs that communicate intent clearly and produce detailed diagnostics on failure — elevating both test quality and maintainability.

## Approaches to Creating Custom Matchers

GoogleTest offers multiple ways to define custom matchers, from quick macros for simple needs to full-fledged classes providing extensive control.

### 1. Using `MATCHER` Macros

For straightforward cases, the `MATCHER`, `MATCHER_P`, and related macros provide concise syntax to define matchers as boolean predicates with optional descriptive strings. These macros handle polymorphism automatically and generate failure messages using provided descriptions.

**Basic Example:**

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

// Usage
EXPECT_CALL(mock, Foo(IsEven()));
EXPECT_THAT(value, IsEven());
```

The macro defines a matcher `IsEven` which verifies if a number is divisible by two. Failure messages will use "is even" as the matcher description based on the name.

**Adding Parameterization:** Use `MATCHER_P` and variants to accept matcher parameters.

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}

// Usage
EXPECT_THAT(x, HasAbsoluteValue(10));
```

Descriptions can be customized by specifying strings that reference the special boolean `negation` and the parameters.

### 2. Defining Matcher Classes (Monomorphic and Polymorphic)

For more complex scenarios requiring fine control over matching logic and diagnostics, define matcher classes implementing the GoogleTest matcher interface.

A monomorphic matcher targets a single argument type `T`:

```cpp
class MyMatcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(const T& arg, std::ostream* listener) const {
    // matching logic
  }

  void DescribeTo(std::ostream* os) const {
    *os << "matches ...";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "does not match ...";
  }
};

::testing::Matcher<T> MyCustomMatcher() {
  return ::testing::Matcher<T>(new MyMatcher());
}
```

Polymorphic matchers are matcher factories usable across argument types by templating the `MatchAndExplain` method:

```cpp
class PolymorphicMyMatcher {
 public:
  using is_gtest_matcher = void;

  template <typename T>
  bool MatchAndExplain(const T& arg, std::ostream* listener) const {
    // polymorphic logic
  }

  void DescribeTo(std::ostream* os) const { ... }
  void DescribeNegationTo(std::ostream* os) const { ... }
};

inline ::testing::PolymorphicMatcher<PolymorphicMyMatcher> MyPolyMatcher() {
  return ::testing::MakePolymorphicMatcher(PolymorphicMyMatcher());
}
```

### 3. Using `MatchAndExplain` and Listeners

Your matcher can optionally provide detail on why a value matched or failed by streaming to the listener argument in `MatchAndExplain()`. This supports clearer diagnostics especially when embedded in composite matchers or wrapped in negations.

Example:

```cpp
MATCHER(IsDivisibleBy7, "") {
  if ((arg % 7) == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

Reporting additional conditions improves the expressiveness and debugging experience of your tests.

## Using Custom Matchers

Custom matchers plug seamlessly into the existing GoogleTest assertion macros:

- Assertions

```cpp
EXPECT_THAT(value, IsEven());
ASSERT_THAT(container, ElementsAre(HasAbsoluteValue(10), _));
```

- Mock Expectations

```cpp
EXPECT_CALL(mock, Func(IsDivisibleBy7())).Times(3);
```

Matchers can be composed with the rich combinators GoogleTest provides (`AllOf()`, `AnyOf()`, `Not()`, etc.) for complex logic.

## Best Practices and Tips

- **Keep Matchers Pure:** Avoid side effects in matchers; they may be invoked multiple times unpredictably.
- **Provide Descriptive Messages:** Make failure explanations as helpful as possible.
- **Leverage Polymorphism:** Use polymorphic matchers for wide applicability.
- **Combine with Built-in Matchers:** Custom matchers work well alongside built-in ones.
- **Name Meaningfully:** Names should reflect matcher intent, aiding readability.
- **Avoid Deep Logic:** Complex validations might be better tested separately rather than in matchers.

## Troubleshooting Common Issues

- **Compilation Errors on Templates:** Use `MATCHER` macros for simple cases or explicitly specify template parameters and types for complex matchers.
- **Poor Error Messages:** Enhance `DescribeTo` and `MatchAndExplain` implementations.
- **Misbehaving Tests:** Ensure the matcher logic is deterministic and side-effect free.

## Practical Example: Defining a Parameterized Matcher

```cpp
MATCHER_P(IsBetween, range, "Checks if value is between two numbers") {
  return arg >= range.first && arg <= range.second;
}

// Usage:
EXPECT_THAT(value, IsBetween(std::make_pair(5, 10)));
```

If the check fails, output explains expected range and actual value.

## Summary

Defining custom matchers in GoogleTest offers a powerful mechanism to extend assertion capabilities with domain-specific validations that read clearly and deliver insightful diagnostics. Whether simple predicates using `MATCHER` macros or full polymorphic matcher classes, you gain precision and expressiveness that make your tests more robust, maintainable, and user-friendly.

---

For further details, refer to the following key documentation pages and resources:

- [Matchers Reference](reference/matchers.md) — Explore built-in and advanced matchers
- [Mocking Reference](reference/mocking.md) — Learn how matchers integrate with mock expectations
- [gMock Cookbook](docs/gmock_cook_book.md#NewMatchers) — Extensive examples and advanced usage
- [Assertions Reference](docs/reference/assertions.md#EXPECT_THAT) — Using `EXPECT_THAT` with matchers

Use these materials to deepen your mastery and produce comprehensive tests tailored to your application's unique requirements.

<Callout>
**Tip:** Start with simple `MATCHER` macros for common cases before investing in complex matcher classes. Incrementally enhance failure descriptions for better test diagnosability.
</Callout>

---