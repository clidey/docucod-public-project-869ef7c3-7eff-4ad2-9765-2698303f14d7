---
title: "Setting Expectations and Actions"
description: "API documentation for ON_CALL, EXPECT_CALL, and related mechanisms for specifying mock behavior and default responses. Covers matchers, argument matching, and controlling invocation counts in test scenarios."
---

# Setting Expectations and Actions

This page provides comprehensive API documentation for the ON_CALL, EXPECT_CALL, and related mechanisms in GoogleMock, which allow users to specify mock behavior and default responses in testing scenarios. It covers matchers, argument matching, invocation control, and how to direct mock method behaviors effectively.

---

## Overview

GoogleMock provides two primary constructs for controlling mock method behavior:

- **ON_CALL:** Defines default behaviors for mock methods without enforcing that the method must be called.
- **EXPECT_CALL:** Sets explicit expectations that the mock method will be called with certain arguments, the number of calls, and potentially the order.

This page details their usage, syntax, available chaining modifiers, and best practices to write precise, maintainable tests.

---

## ON_CALL: Defining Default Behavior

The `ON_CALL` macro lets you specify what happens when a mock method is called, without requiring that the method must be called. This is ideal for establishing common default behavior shared across multiple test cases.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers...))
    [.With(multi_argument_matcher)]  // Optional
    .WillByDefault(action);          // Required
```

- `matchers...` corresponds to each argument and restricts which calls the behavior applies to.
- `.With()` takes a matcher for the entire argument tuple and applies additional filtering.
- `.WillByDefault()` specifies the action executed when matching calls occur.

If no `matchers...` are provided, the default is to match any arguments (wildcard `_`).

### Example

```cpp
using ::testing::_;
using ::testing::Lt;
using ::testing::Return;

ON_CALL(my_mock, SetPosition(_, _))
    .With(Lt())
    .WillByDefault(Return(true));
```

This means that by default, `SetPosition` will return `true` when called with any two arguments where the first is less than the second.

### Important Points

- `WillByDefault()` must be used exactly once per `ON_CALL`.
- Multiple `ON_CALL`s with different matchers can be declared to vary default behaviors.
- Default actions set with `ON_CALL` are superseded by `EXPECT_CALL` actions.

---

## EXPECT_CALL: Setting Expectations

`EXPECT_CALL` binds both the behavior and the expectation that a call to the mock method matching the specified arguments will occur.

### Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    [.With(multi_argument_matcher)]      // Optional, at most once
    [.Times(cardinality)]                // Optional, at most once
    [.InSequence(sequences...)]          // Optional, any number
    [.After(expectations...)]            // Optional, any number (up to 5)
    [.WillOnce(action)...]               // Optional, any number
    [.WillRepeatedly(action)]            // Optional, at most once
    [.RetiresOnSaturation()]             // Optional, at most once
```

#### Clause Descriptions

- **With:** Filters calls by applying a matcher on all arguments together.
- **Times:** Specifies how many times the call matching the expectation is allowed or required. Common cardinalities include:
  - `AnyNumber()`
  - `AtLeast(n)`
  - `AtMost(n)`
  - `Between(m, n)`
  - `Exactly(n)`

  If omitted, gMock infers cardinality based on `WillOnce` and `WillRepeatedly` usage.

- **InSequence:** Specifies that calls are expected in the order defined by one or more `Sequence` objects.

- **After:** Sets a partial order, specifying that this call must occur after other expectations.

- **WillOnce:** Specifies actions to perform in order on consecutive calls matched by the expectation.

- **WillRepeatedly:** Action performed on all further matching calls after `WillOnce` actions are exhausted.

- **RetiresOnSaturation:** Automatically retires the expectation after it has been saturated (reached upper call limit), deactivating it.

### Example Usage

```cpp
using ::testing::Return;
using ::testing::AtLeast;
using ::testing::Sequence;

Sequence s1, s2;

EXPECT_CALL(my_mock, Reset())
    .InSequence(s1, s2);
EXPECT_CALL(my_mock, GetSize())
    .InSequence(s1)
    .WillOnce(Return(5));
EXPECT_CALL(my_mock, Describe())
    .InSequence(s2)
    .WillRepeatedly(Return("Mock Description"));
```

Here, `Reset()` must be called before both `GetSize()` and `Describe()`. `GetSize()` returns 5 once, and `Describe()` returns a string on every call that follows.

### Default Cardinality Inference

- No `Times()`, no `WillOnce()`, no `WillRepeatedly()`: assumed `Times(1)`.
- `n` `WillOnce()` and no `WillRepeatedly()`: inferred `Times(n)`.
- `n` `WillOnce()` with `WillRepeatedly()`: inferred `Times(AtLeast(n))`.

### Common Patterns

- Defining an expectation that a method should never be called:

  ```cpp
  EXPECT_CALL(mock, Foo(_)).Times(0);
  ```

- Allowing calls with any arguments any number of times:

  ```cpp
  EXPECT_CALL(mock, Bar(_)).Times(AnyNumber());
  ```

- Using a catch-all expectation to suppress "uninteresting call" warnings:

  ```cpp
  EXPECT_CALL(mock, Baz(_)).Times(AnyNumber());
  ON_CALL(mock, Baz(_)).WillByDefault(Return(0));
  ```

### Best Practices

- Use `ON_CALL` by default to set expected behaviors.
- Use `EXPECT_CALL` only when you intend to verify the call happens with specific behavior.
- Avoid overly strict `EXPECT_CALL`s, to reduce test brittleness.
- Add `.RetiresOnSaturation()` where the expectation should deactivate after fulfilling the call count.
- Use `Sequence` and `After` to express partial ordering and sequencing clearly.

---

## Matchers and Argument Matching

Both `ON_CALL` and `EXPECT_CALL` use **matchers** to specify which argument values the specification or expectation applies to.

- Each function argument can be matched individually.
- The `.With()` clause lets you combine arguments into a single multi-argument matcher.
- Common built-in matchers include `_` (wildcard), `Eq`, `Lt`, `Ge`, `NotNull`, among many others.

### Complex Argument Matching

- Combine matchers with `AllOf()`, `AnyOf()`, `Not()`, etc.
- Use `Field()` and `Property()` to match object members or method results.
- Use `Pointee()` to expect properties of objects pointed by pointers.
- Use `SafeMatcherCast` and `MatcherCast` when needing to resolve type mismatches.

### Example

```cpp
EXPECT_CALL(foo, Bar(AllOf(Ge(5), Ne(10)), Field(&MyClass::value, Eq(42))));
```

This expects `Bar` to be called with a first argument `>= 5` and not `10`, and second argument whose member `value` is exactly 42.

---

## Actions: Controlling Mock Method Behavior

After matching a call, you typically want your mock method to do something. Actions define the behavior of the mock method.

### Built-in Actions

- `Return(value)`: return a value.
- `ReturnRef(variable)`: return a reference.
- `ReturnPointee(ptr)`: return the value pointed to.
- `SetArgPointee<N>(value)`: set the Nth argument as an output parameter.
- `DoAll(...)`: chain multiple actions, returning the last action’s result.
- `Invoke(func)`: call a given function or method.
- `InvokeWithoutArgs(func)`: call a no-argument function.
- `InvokeArgument<N>(args...)`: invoke the Nth argument as a callable.
- `IgnoreResult(action)`: ignore the action’s return value, returning void.
- `Throw(exception)`: throws an exception.

### Specifying Actions

- `.WillOnce(action)`: action to perform upon the next matching call.
- `.WillRepeatedly(action)`: action to perform on all subsequent calls.

### Example

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

This means the first call returns 1, second call 2, and all further calls 3.

---

## Controlling Invocation Counts

The `.Times()` clause is crucial for specifying how many times a particular expectation applies.

### Cardinalities

| Cardinality           | Meaning                                           |
|-----------------------|---------------------------------------------------|
| `AnyNumber()`         | The call can occur any number of times.           |
| `AtLeast(n)`          | The call occurs at least n times.                  |
| `AtMost(n)`           | The call occurs at most n times.                   |
| `Between(m,n)`        | The call occurs between m and n times, inclusive. |
| `Exactly(n)` (or n)   | The call occurs exactly n times.                   |

If `.Times()` is omitted, gMock infers the call count based on other clauses.

### RetiresOnSaturation

When expectations are saturated (called the maximum times allowed), they remain sticky by default and might cause errors on extra calls. Using `.RetiresOnSaturation()` makes an expectation retire when saturated, deactivating it and avoiding these errors.

### Examples

```cpp
EXPECT_CALL(mock, Foo(7))
    .Times(2)
    .RetiresOnSaturation();

EXPECT_CALL(mock, Foo(_))
    .Times(AnyNumber());
```

This allows exactly two calls with argument 7 which retire after saturation; any further calls with argument 7 match the second expectation.

---

## Tips and Common Pitfalls

- **Set expectations before exercising the mock:** `EXPECT_CALL` should never follow an executed call.
- **Use `ON_CALL` for default behavior and `EXPECT_CALL` for verification:** Overusing `EXPECT_CALL` leads to brittle tests.
- **Beware of argument matchers:** Matching too strictly may cause tests to fail unnecessarily.
- **Use sequences and `After` carefully:** They help guarantee call order but can increase test fragility if overused.
- **Suppress uninteresting call warnings wisely:** Use `NiceMock` or add catch-all expectations with `.Times(AnyNumber())`.
- **Remember the precedence rule:** Later expectations override earlier ones, so order your expectations accordingly.

---

## Troubleshooting

- If you get warnings about "uninteresting calls", consider if your test needs those calls or if a catch-all expectation is missing.
- Unexpected calls may yield detailed messages with argument mismatch reasons; use them to tune your matchers.
- Use `--gmock_verbose=info` to get detailed traces of mock calls and expectations, helping diagnose mismatches.
- Verify that your mocked methods have the correct signatures and qualifiers to avoid silent failures.

---

## Related Documentation

- [Mock Method Definition (`MOCK_METHOD`)](/api-reference/core-mocking-api/mock-method-definition)
- [Built-in Matchers Reference](/api-reference/matchers-actions-assertions/built-in-matchers)
- [Actions Reference](/api-reference/matchers-actions-assertions/advanced-actions)
- [NiceMock, NaggyMock, StrictMock Controls](/api-reference/mock-behavior-extensions/nice-naggy-strict-mocks)
- [GoogleMock Cook Book](docs/gmock_cook_book.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)

---

## Summary

The `ON_CALL` and `EXPECT_CALL` mechanisms form the backbone of controlling mock object behavior in GoogleMock, allowing users to specify default behaviors and explicit call expectations with rich argument matching, call ordering, and action specifications. Mastering these constructs enables precise, maintainable, and robust test scenarios.

---

## Example Complete Usage

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;

class MockCalculator {
 public:
  MOCK_METHOD(int, Add, (int a, int b), ());
  MOCK_METHOD(bool, Reset, (), ());
};

TEST(CalcTest, Example) {
  MockCalculator calc;

  ON_CALL(calc, Add(_, _))
      .WillByDefault([](int a, int b) { return a + b; });

  EXPECT_CALL(calc, Reset())
      .Times(1)
      .WillOnce(Return(true));

  EXPECT_CALL(calc, Add(5, 3))
      .Times(2)
      .WillOnce(Return(8))
      .WillRepeatedly(Return(10));

  EXPECT_TRUE(calc.Reset());
  EXPECT_EQ(calc.Add(5, 3), 8);
  EXPECT_EQ(calc.Add(5, 3), 10);
  EXPECT_EQ(calc.Add(2, 2), 4);  // Uses ON_CALL default!
}
```

---