---
title: "Defining Mocks and Expectations"
description: "Explains core macros and utilities for declaring mock classes (MOCK_METHOD), configuring method signatures, and expressing call expectations with ON_CALL and EXPECT_CALL. Walks through common patterns and pitfalls in mocking C++ interfaces."
---

# Defining Mocks and Expectations

This documentation page provides a focused guide on the core macros and utilities essential for defining mock classes in GoogleTest’s mocking framework. It covers how to declare mock methods using the `MOCK_METHOD` macro, configure method signatures with qualifiers, and express call expectations using `ON_CALL` and `EXPECT_CALL`. Alongside comprehensive syntax and behavioral explanations, the page presents common patterns, tips, and pitfalls in mocking C++ interfaces.

---

## Overview

GoogleTest’s mocking support, provided primarily by GoogleMock (gMock), hinges on powerful macros and helper classes that streamline creating and manipulating mocks. This page details the foundational components for declaring mock classes and setting up expectations so you can reliably verify interactions in your tests.

---

## MOCK_METHOD: Declaring Mock Methods

The `MOCK_METHOD` macro is central to declaring mock member functions inside your mock classes. It replaces typical method definitions with mock implementations that intercept calls and allow you to specify expectations and behaviors.

### Syntax
```cpp
MOCK_METHOD(ReturnType, MethodName, (ArgumentTypes...), (Qualifiers...));
```

- **ReturnType**: The method's return type.
- **MethodName**: The name of the method to mock.
- **ArgumentTypes**: A parenthesized comma-separated list of argument types.
- **Qualifiers** (optional): Comma-separated list of method qualifiers such as `const`, `override`, `noexcept`, calling conventions (`Calltype()`), and reference qualifiers (`ref(&)`, `ref(&&)`).

### Important Notes
- Use `MOCK_METHOD` inside the `public:` section of your mock class regardless of the base class access.
- Parenthesize return or argument types that include commas to avoid parsing errors.

### Examples
#### Basic Mock Method
```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, DoSomething, (int value), (override));
};
```

#### Handling Commas in Types
```cpp
class MyMock {
 public:
  // This would fail to compile because of the comma inside std::pair
  // MOCK_METHOD(std::pair<bool, int>, GetPair, ());  // Error!

  // Correct: wrap type with parentheses
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());

  // Or use type aliases
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
};
```

#### Mocking Const and Override Methods
```cpp
class Base {
 public:
  virtual int size() const = 0;
};

class MockDerived : public Base {
 public:
  MOCK_METHOD(int, size, (), (const, override));
};
```

---

## Setting Expectations: ON_CALL and EXPECT_CALL

GoogleMock distinguishes between specifying default behavior and asserting code interactions:

- **`ON_CALL`**: Defines the default behavior of a mock method without setting an expectation that the method is called.
- **`EXPECT_CALL`**: Sets an expectation that the method *will* be called, specifying how many times, with what arguments, and optionally in what order.

### Common Syntax
```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher)?
    .WillByDefault(action);

EXPECT_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher)?
    .Times(cardinality)?
    .InSequence(sequences...)*
    .After(expectations...)*
    .WillOnce(action)*
    .WillRepeatedly(action)?
    .RetiresOnSaturation()?;
```

*Clauses marked with `?` are optional and can appear once; those marked with `*` can appear multiple times.*

### ON_CALL

Defines what a mock method does when called without asserting it is called.

- **`.With(multi_argument_matcher)`**: Optional; further refines which calls the behavior applies to by matching all arguments at once.
- **`.WillByDefault(action)`**: Required; specifies the default action to perform.

If `WillByDefault` is not set, calling the method returns the globally defined default value for its return type.

### EXPECT_CALL

Creates an expectation that a mock method will be called with certain arguments.

#### Clauses
- **`.With(multi_argument_matcher)`**: Optional; restricts the expectation to calls matching all arguments as a group.
- **`.Times(cardinality)`**: Optional; specifies how many times the method is expected to be called. If omitted, inferred from `.WillOnce` and `.WillRepeatedly` clauses.
- **`.InSequence(sequences...)`**: Optional; imposes call ordering along zero or more `Sequence` objects.
- **`.After(expectations...)`**: Optional; specifies that the expectation must occur after other expectations.
- **`.WillOnce(action)`**: Optional; actions to perform on the first N calls.
- **`.WillRepeatedly(action)`**: Optional; action to perform on all subsequent calls after `WillOnce` actions.
- **`.RetiresOnSaturation()`**: Optional; automatically makes the expectation inert once it saturates.

#### Cardinalities
| Cardinality        | Meaning                                      |
|--------------------|----------------------------------------------|
| `AnyNumber()`       | The method may be called any number of times. |
| `AtLeast(n)`        | The method must be called at least *n* times. |
| `AtMost(n)`         | The method must be called at most *n* times.  |
| `Between(m, n)`     | The method must be called between *m* and *n* times inclusive. |
| `Exactly(n)` / `n`  | The method must be called exactly *n* times.  |

If no `Times()` is specified, GoogleMock infers it following these rules:
- No `.WillOnce`/`.WillRepeatedly`: `Times(1)`
- N `.WillOnce` clauses and no `.WillRepeatedly`: `Times(n)`
- N `.WillOnce` clauses and one `.WillRepeatedly`: `Times(AtLeast(n))`

### Examples

#### Basic EXPECT_CALL
```cpp
EXPECT_CALL(mock_turtle, PenDown()).Times(AtLeast(1));
```

#### Expecting a Method Call with Arguments
```cpp
EXPECT_CALL(mock_turtle, GoTo(50, _));
```

#### Sequences for Ordered Calls
```cpp
Sequence s1, s2;
EXPECT_CALL(mock_turtle, StartDrawing()).InSequence(s1, s2);
EXPECT_CALL(mock_turtle, DrawLine()).InSequence(s1);
EXPECT_CALL(mock_turtle, EndDrawing()).InSequence(s2);
```

#### Setting Default Behavior with ON_CALL
```cpp
ON_CALL(mock_turtle, GetX())
     .WillByDefault(Return(10));
```

#### Using `WillOnce` and `WillRepeatedly`
```cpp
EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

#### Using `.RetiresOnSaturation()`
Automatically disables an expectation once it reaches the call limit.

```cpp
EXPECT_CALL(mock_turtle, GetX())
    .Times(2)
    .RetiresOnSaturation();
```

---

## Best Practices and Common Pitfalls

- Always place `MOCK_METHOD` declarations in `public:` sections so expectations can be set from tests.
- Wrap complex types with commas (like `std::pair<>`) in extra parentheses or use type aliases to avoid `MOCK_METHOD` parsing errors.
- Use `ON_CALL` to set default behavior without asserting calls; reserve `EXPECT_CALL` for when you want to enforce that calls happen.
- Define expectations *before* exercising code under test to get accurate verification.
- If your method is overloaded, specify arguments in `EXPECT_CALL` to disambiguate the overload.
- Use `Sequence` and `.InSequence` to enforce call ordering and `.After` for partial order dependencies.
- Use `.RetiresOnSaturation()` carefully to avoid sticky expectations causing failures due to call count violations.
- When mocking methods returning references, use `ReturnRef()` to return references properly.
- To mock methods with move-only types (`std::unique_ptr`), use `MOCK_METHOD` normally and specify actions using lambdas or callables.
- Avoid unnecessarily strict expectations as they can make tests brittle.
- Use `NiceMock`, `NaggyMock`, or `StrictMock` wrappers to control behavior on uninteresting mock calls.

---

## Troubleshooting

- **Uninteresting call warnings:** If you set no expectation and the mock method is called, you'll see a warning. Use `ON_CALL` to define behavior or `EXPECT_CALL(...).Times(AnyNumber())` to suppress warnings.
- **Unexpected call errors:** Occur if a call doesn't match any `EXPECT_CALL`. Check argument matchers and order.
- **Mock destructor warnings:** If the mock class destructor is not virtual, behavior is undefined. Always ensure your interfaces have virtual destructors.
- **Overly restrictive expectations:** Use `.RetiresOnSaturation()` or sequences if expecting multiple calls with specific order.
- **Parsing errors with `MOCK_METHOD`:** Parenthesize types with commas, or define type aliases.

---

## Further Reading and Related Documentation

- [GoogleTest Mocking Reference](reference/mocking.md): Detailed source and API documentation.
- [gMock Cookbook](guides/mocking-patterns/gmock_cook_book.md): Practical recipes with explanations.
- [Actions and Mock Behaviors](api-reference/matchers-mocking/actions-mock-behaviors.md): How to specify mock actions.
- [Argument Matchers](api-reference/matchers-mocking/argument-matchers.md): Using matchers in expectations.
- [Expectations, Actions, and Call Sequences](guides/mocking-patterns/expectations-actions-sequences.md): Patterns for controlling expectations beyond basics.
- [Nice, Naggy, and Strict Mocks](concepts/mocking-fundamentals/nice-naggy-strict-mocks.md): Managing call tolerance on mocks.

---

## Summary

Defining mocks and expectations is the cornerstone of interaction testing in GoogleTest. Using `MOCK_METHOD` you declare mock methods with precise configuration, while `ON_CALL` and `EXPECT_CALL` let you control default behaviors and enforce call expectations. Mastering these constructs ensures robust and expressive tests, enabling you to assert correctness of your system's collaborations.

---

<CardGroup cols={2}>
<Card title="Example: Basic Mock Class">
{`cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
`}
</Card>
<Card title="Example: Expectation Usage">
{`cpp
MockTurtle turtle;
ON_CALL(turtle, GetX()).WillByDefault(Return(0));
EXPECT_CALL(turtle, PenDown()).Times(1);
EXPECT_CALL(turtle, Forward(10));

// Exercising code...
`}
</Card>
</CardGroup>

---

## Navigation

This page fits within the API Reference under [Matchers and Mocking APIs](../../api-reference/matchers-mocking/defining-mocks-expectations.md), complementing topics like actions, argument matchers, and cardinalities. Users typically proceed from introductory guides on mocking to this reference for detailed use.

---

## Source Code Reference

For in-depth insight and conformance:

<Source url="https://github.com/google/googletest" paths={[{path: "googlemock/include/gmock/gmock-spec-builders.h", range: "1-314"}, {path: "googlemock/docs/reference/mocking.md", range: "1-1863"}]} branch="main" />