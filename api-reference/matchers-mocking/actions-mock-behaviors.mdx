---
title: "Actions and Mock Behaviors"
description: "Documents the full set of GoogleMock actions, including returning values, throwing exceptions, invoking functions, and composing complex sequences. Covers built-in and custom actions, with real-world code snippets and recommendations for advanced use."
---

# Actions and Mock Behaviors

This page thoroughly documents the full range of GoogleMock actions — the behaviors that mocked methods can perform when invoked during tests. It covers the built-in actions, how to invoke functions or lambdas, side effects like throwing exceptions or modifying arguments, and composing complex sequences of actions to simulate realistic scenarios. Users will find detailed explanations along with real-world C++ code examples and best practices that unlock the full power of mock behaviors.

---

## Overview of Actions

Actions in GoogleMock define **what happens when a mock method is called**. They specify the method's runtime behavior including:

- Returning values or references
- Throwing exceptions
- Invoking callbacks or other functions
- Setting output parameters or saving argument values
- Combining multiple actions in sequence

Users primarily interact with actions when chaining `.WillOnce()`, `.WillRepeatedly()` (for `EXPECT_CALL`s) or `.WillByDefault()` (for `ON_CALL`s) to specify mock method behavior.

**Note:** If no explicit action is specified for a mock method, GoogleMock provides built-in default actions depending on the return type (e.g., `void` returns nothing, `bool` returns `false`, default-constructible types return a default-constructed value).

---

## Built-in Actions

GoogleMock provides many ready-to-use actions in the `::testing` namespace. Here's a categorized overview:

### Returning Values
| Action                             | Description                                                  |
|----------------------------------|--------------------------------------------------------------|
| `Return()`                       | Return from a `void` mock function.                           |
| `Return(value)`                  | Return the specified value. The value is converted at the time the expectation is set, not at call-time. |
| `ReturnArg<N>()`                 | Return the N-th (0-based) argument passed to the method.      |
| `ReturnNew<T>(a1, ..., ak)`      | Return a `new T(...)` object, creating a new object each call.|
| `ReturnNull()`                   | Return a null pointer.                                        |
| `ReturnPointee(ptr)`              | Return the value pointed to by the pointer `ptr` at invocation time. |
| `ReturnRef(variable)`            | Return a reference to the given variable.                     |
| `ReturnRefOfCopy(value)`         | Return a reference to a copy of `value` that lives as long as the action.
|
| `ReturnRoundRobin({a1, ..., ak})` | Cycle through returning each `ai` in the list for successive calls.

### Side Effects
| Action                             | Description                                                  |
|----------------------------------|--------------------------------------------------------------|
| `Assign(&variable, value)`        | Assign `value` to the referenced variable.                   |
| `DeleteArg<N>()`                  | Delete (delete operator) the N-th argument, which must be a pointer. |
| `SaveArg<N>(pointer)`             | Save the N-th argument to `*pointer` by copy-assignment.      |
| `SaveArgByMove<N>(pointer)`       | Save the N-th argument to `*pointer` by move-assignment.      |
| `SaveArgPointee<N>(pointer)`      | Save the pointee of the N-th argument to `*pointer`.          |
| `SetArgReferee<N>(value)`         | Assign `value` to the variable referenced by the N-th argument. |
| `SetArgPointee<N>(value)`         | Assign `value` to the variable pointed to by the N-th argument. |
| `SetArrayArgument<N>(first, last)`| Copy elements from iterator range `[first, last)` into array pointed to by the N-th argument. |
| `SetErrnoAndReturn(error, value)`| Set `errno` to the specified error and return `value`.        |
| `Throw(exception)`                | Throw the specified exception (must be copyable).            |

### Composite Actions
| Action                          | Description                          |
|---------------------------------|------------------------------------|
| `DoAll(a1, a2, ..., an)`        | Performs actions `a1` to `an` in sequence each time called; the result of the final action `an` is returned. |
| `IgnoreResult(a)`               | Execute action `a` but ignore its return value (useful for void-returning mocks).|
| `WithArg<N>(a)`                 | Pass only the N-th argument of the mock method to action `a` and execute it. |
| `WithArgs<N1, N2, ..., Nk>(a)` | Pass selected arguments to inner action `a`.                   |
| `WithoutArgs(a)`                | Execute action `a` without any arguments.                       |

---

## Specifying Actions in Tests

The primary use of actions is in conjunction with expectations on mock methods:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .WillOnce(Return(value))       // Behavior for first call
    .WillOnce(Invoke(SomeFunction)) // Behavior for second call
    .WillRepeatedly(Return(default_value)); // For subsequent calls
```

Or to specify default fallback behavior (not an expectation of calls):

```cpp
ON_CALL(mock_object, Method(matchers...))
    .WillByDefault(Return(default_value));
```

**Important Details:**

- `.WillOnce()` can be repeated multiple times to specify sequential actions for consecutive calls matching the expectation.
- `.WillRepeatedly()` can be specified at most once, used after `.WillOnce()` actions or alone.
- `.WillByDefault()` is used with `ON_CALL` to specify a default behavior; it must appear exactly once per `ON_CALL`.

---

## Examples of Common Actions

### Returning Values

```cpp
using ::testing::Return;
...
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));

// First call returns 1, second returns 2, then always returns 3
```

### Returning References

```cpp
using ::testing::ReturnRef;
Bar bar_instance;
EXPECT_CALL(mock, GetBar())
    .WillOnce(ReturnRef(bar_instance));
```

### Throwing Exceptions

```cpp
using ::testing::Throw;
EXPECT_CALL(mock, DoWork())
    .WillOnce(Throw(std::runtime_error("failure")));
```

### Calling a Function or Lambda

```cpp
using ::testing::Invoke;

int Add(int a, int b) { return a + b; }

EXPECT_CALL(mock, Sum(_, _))
    .WillOnce(Invoke(Add));

EXPECT_CALL(mock, GetFlag())
    .WillRepeatedly([] { return true; });
```

### Setting Output Arguments

```cpp
using ::testing::SetArgPointee;
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

### Deleting Arguments

```cpp
using ::testing::DeleteArg;
EXPECT_CALL(mock, FreeResource(_))
    .WillOnce(DeleteArg<0>());  // Deletes first argument pointer
```

### Invoking Callback Argument

```cpp
using ::testing::InvokeArgument;
EXPECT_CALL(mock, ExecuteCallback(_))
    .WillOnce(InvokeArgument<0>(true));
```

(The above executes the 0-th argument as a callback, passing `true`.)

---

## Composing Complex Behavior

To perform multiple actions sequentially in response to a single mock call, use `DoAll()`:

```cpp
EXPECT_CALL(mock, Foo())
    .WillOnce(DoAll(
        /* first */ SetArgPointee<0>(100),
        /* last returns */ Return(true)));
```

Here, the first action sets the 0-th output argument, then the last action returns the boolean `true`.

---

## Working with Move-Only Types

GoogleMock supports mocking methods that take or return move-only types (e.g. `std::unique_ptr`) normally:

```cpp
MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
...
EXPECT_CALL(mock_buzzer_, MakeBuzz("hello"))
    .WillOnce(Return(std::make_unique<Buzz>(AccessLevel::kInternal)));
```

For methods taking move-only types, use lambdas or functors as actions for flexible behavior:

```cpp
EXPECT_CALL(mock_buzzer_, ShareBuzz(NotNull(), _))
    .WillOnce(Return(true));
EXPECT_CALL(mock_buzzer_, ShareBuzz(_, _))
    .WillOnce([](std::unique_ptr<Buzz> buzz, Unused) { return buzz != nullptr; });
```

---

## Best Practices

- **Use `ON_CALL` for default behaviors:** Defining default actions via `ON_CALL` lets you set general behavior while letting `EXPECT_CALL` handle expectations.
- **Use `EXPECT_CALL` or `.WillOnce()` when you want to verify a call:** This makes the tests strict about calls.
- **Chain `.WillOnce()` calls for different call behaviors:** For example, return different values or invoke different side effects in order.
- **Use `.WillRepeatedly()` for stable fallback behavior:** This covers all calls not explicitly handled by `.WillOnce()`.
- **Avoid side effects inside `.WillOnce(Return(...))` expressions:** The return value is evaluated once when setting up the expectation, not upon each call.
- **Use `DoAll()` to combine multiple actions in one call:** Useful for setting output arguments and returning a value simultaneously.
- **Use `RetiresOnSaturation()` to deactivate expectations safely after being fully used.**

---

## Troubleshooting Common Issues

### Too Many or Too Few Actions

- GoogleMock warns if you specify more `.WillOnce()` actions than expected calls.
- It also warns if fewer `.WillOnce()` actions are specified for the expected number of calls.
- Always ensure `.WillOnce()` actions align with `.Times()` cardinality, or omit `Times()` and let GoogleMock infer.

### Unexpected Calls

- Calling a mock method with unexpected arguments causes an error unless a catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` exists.
- Use `NiceMock` or `NaggyMock` to suppress or warn about uninteresting calls.

### Uninteresting Calls

- If a mock method is called without any `EXPECT_CALL` and no default action, GoogleMock prints a warning.
- To ignore, provide a default action with `ON_CALL()` or use `NiceMock`.

### Move-Only Types in Actions

- Avoid `Return(std::move(...))` repeated calls — they will fail after the first use.
- Use lambdas to dynamically build and return move-only objects at runtime.

---

## Complete Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class MockTurtle {
 public:
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(int, GetX, (), (const));
};

using ::testing::Return;
using ::testing::DoAll;
using ::testing::SetArgPointee;

TEST(TurtleTest, ActionsExample) {
  MockTurtle turtle;

  // Default behavior: GetX() returns 0
  ON_CALL(turtle, GetX()).WillByDefault(Return(0));

  // Expect PenDown called once
  EXPECT_CALL(turtle, PenDown()).Times(1);

  // Define GetX behavior to return 10, then 20, then keep returning 30
  EXPECT_CALL(turtle, GetX())
      .WillOnce(Return(10))
      .WillOnce(Return(20))
      .WillRepeatedly(Return(30));

  turtle.PenDown();
  EXPECT_EQ(10, turtle.GetX());
  EXPECT_EQ(20, turtle.GetX());
  EXPECT_EQ(30, turtle.GetX());
  EXPECT_EQ(30, turtle.GetX());
}
```

This test shows default actions, expectations with actions, and composite sequences.

---

## Further Exploration

To master advanced mocking behaviors, explore:

- Defining custom actions via functors or lambdas.
- Using `Invoke()`, `InvokeWithoutArgs()` to transfer control to custom functions.
- Performing side effects with `SetArgPointee()`, `SaveArg()`, and `DoAll()`.
- Managing call sequences and call ordering with `InSequence` and `After` clauses.

For comprehensive instructions, consult the [Mocking Reference](reference/mocking.md), the [Actions Reference](reference/actions.md), and the [gMock Cookbook](gmock_cook_book.md).

---

<Callout type="tip">
Always set your expectations before exercising your mocks to ensure predictable behavior and immediate failure on unexpected calls.
</Callout>

<Callout type="note">
Use `RetiresOnSaturation()` for expectations expected to happen a precise number of times when subsequent calls should be delegated to other expectations.
</Callout>

---

<Source url="https://github.com/google/googletest" paths={[{"path": "googlemock/include/gmock/gmock-spec-builders.h", "range": "1-488"},{"path": "docs/reference/actions.md", "range": "2-120"},{"path": "docs/reference/mocking.md", "range": "15-294"}]} />
