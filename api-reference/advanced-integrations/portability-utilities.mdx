---
title: "Portability & Configuration Utilities"
description: "Reference the low-level macros and utility APIs for ensuring cross-platform compatibility, compiler feature detection, and flag handling. Suitable for integrators and those embedding GoogleTest/GoogleMock within varied build ecosystems."
---

# Portability & Configuration Utilities

This reference details the foundational macros and utility APIs within GoogleTest and GoogleMock that empower cross-platform compatibility, compiler feature detection, and flag management. These utilities are essential for integrators embedding GoogleTest or GoogleMock in diverse build environments where platform-specific differences and feature variability must be gracefully handled.

---

## 1. Overview

At the core of GoogleTest and GoogleMock portability lies the internal header `gtest-port.h` (and its GoogleMock counterpart `gmock-port.h`) which abstracts away platform and compiler discrepancies. This includes:

- Environment and platform detection macros
- Feature availability macros for compiler and library capabilities
- Synchronization primitives for thread safety
- Low-level logging and assertion mechanisms
- File system and system call wrappers
- Thread-local storage implementations
- Regular expression engine selection
- Handling of command-line flags and environment variables

These utilities form the backbone of GoogleTest's ability to seamlessly run on Windows, Linux, macOS, and a variety of other supported platforms with different compilers and runtime capabilities.

---

## 2. Environment and Platform Detection

GoogleTest uses a comprehensive set of predefined macros that signal environment characteristics. These are automatically set during compilation to reflect the host platform and environment features.

### Key Macros

| Macro                  | Description                                                          |
| ---------------------- | -------------------------------------------------------------------- |
| `GTEST_OS_WINDOWS`       | Defined if compiling on Windows platform                            |
| `GTEST_OS_LINUX`         | Defined if compiling on Linux                                        |
| `GTEST_OS_MAC`           | Defined if compiling on macOS                                        |
| `GTEST_HAS_PTHREAD`      | Indicates if POSIX threads are supported                            |
| `GTEST_HAS_EXCEPTIONS`   | Indicates if compiler exceptions are enabled                       |
| `GTEST_HAS_RTTI`         | Boolean: RTTI support status                                         |
| `GTEST_HAS_STD_WSTRING`  | Whether `std::wstring` is supported on the platform                 |
| `GTEST_HAS_DEATH_TEST`   | Whether death tests are supported (requires file system, platform) |

Users typically do not need to manually define these. GoogleTest detects them automatically; however, manual overrides via compiler flags are possible for edge cases or embedded platforms.

---

## 3. Compiler Feature Detection

GoogleTest employs feature testing macros to detect C++ language support and attributes, allowing it to leverage modern capabilities when available. For example:

- `GTEST_HAVE_ATTRIBUTE_(x)`: Checks for support of GCC-style attributes.
- `GTEST_INTERNAL_HAS_CPP_ATTRIBUTE(x)`: Checks support for C++11/17 standardized attributes.
- `GTEST_HAVE_FEATURE_(x)`: Detects compiler features such as sanitizers.

These allow conditional compilation and safer, clearer code without sacrificing portability.

---

## 4. Synchronization Primitives

Thread safety is a core objective for GoogleTest on supported platforms. The utilities provide:

- **Mutex and MutexLock**: Thin abstractions over OS-specific mutexes.
- **ThreadLocal<T>**: Template class providing thread-local storage.
- **Notification**: Lightweight signaling primitive for thread coordination.

These implementations adapt to the underlying platform:

- On POSIX with pthreads, GoogleTest wraps `pthread_mutex_t` and `pthread_key_t`.
- On Windows desktop platforms, critical sections and Windows threading APIs are used.
- For platforms without threading support, dummy implementations exist that disable synchronization and thread-local storage to allow compilation without concurrency guarantees.

<CodeGroup>
```c++
// Example usage of Mutex and MutexLock
Mutex mu;
{
  MutexLock lock(&mu);  // Locks mutex on scope entry, unlocks on exit.
  // Critical section
}
```
</CodeGroup>

ThreadLocal supports per-thread instances with optional default value construction and ensures proper destruction of thread-specific objects.

---

## 5. Logging and Checked Assertions

GoogleTest provides a robust logging macro `GTEST_LOG_(severity)` which streams messages to stderr, with severity levels:

- `GTEST_INFO`
- `GTEST_WARNING`
- `GTEST_ERROR`
- `GTEST_FATAL` (terminates the program after logging)

### Checked Assertions

`GTEST_CHECK_(condition)` provides an all-mode assert that immediately aborts if the condition is false, even in release builds. It ensures consistency and guards against invalid states.

```c++
GTEST_CHECK_(x != nullptr) << "Pointer x must not be null.";
```

---

## 6. File System and POSIX Wrappers

To accommodate platform differences, GoogleTest wraps common file and I/O operations in the `posix` namespace. This includes:

- File descriptor retrieval (`FileNo`)
- File status querying (`Stat`)
- Directory removal (`RmDir`)
- File type checks (`IsDir`)
- Case-insensitive string comparison (`StrCaseCmp`)
- STD stream capturing (`CaptureStdout`, `GetCapturedStdout`, etc.)

On Windows, these wrap Windows-specific equivalents (e.g., `_fileno`, `_stat`, `_rmdir`). On POSIX systems, the standard variants are used.

These wrappers allow GoogleTest to seamlessly capture output, manage files, and query terminal capabilities in a uniform way.

---

## 7. Regular Expression Support

GoogleTest provides its own `RE` class wrapping a platform-appropriate regex engine:

- **RE2** (via Abseil) when available and linked.
- **POSIX Extended Regex** on UNIX-like platforms
- A limited simple regex implementation elsewhere

The choice is automatic based on platform capabilities and build options.

Users can interact with `RE` objects to perform full and partial regex matches with uniform API across platforms.

---

## 8. Command-Line Flag and Environment Variable Handling

Facilitating custom flags and environment variable overrides for test parameters is done with macros like:

- `GTEST_FLAG(name)` to reference flags
- `GTEST_DEFINE_bool_`, `GTEST_DEFINE_int32_`, `GTEST_DEFINE_string_` for defining flags

GoogleTest attempts to parse environment variables (e.g., `GTEST_COLOR`) to influence test behavior, gracefully falling back to defaults if variables are unset or malformed.

---

## 9. Thread Counting and Thread Management

GoogleTest provides utility functions like `GetThreadCount()` to query the current number of OS threads, supporting consistency checks in multi-threaded tests or internal sync mechanisms.

---

## 10. Usage Examples

### Checking Conditions with GTEST_CHECK_

```c++
int* ptr = GetPointer();
GTEST_CHECK_(ptr != nullptr) << "Pointer must not be null";
```

### Capturing stdout for verification

```c++
CaptureStdout();
printf("hello world");
std::string output = GetCapturedStdout();
EXPECT_EQ(output, "hello world");
```

### Using ThreadLocal storage

```c++
ThreadLocal<int> thread_local_counter(0);
thread_local_counter.set(thread_local_counter.get() + 1);
int current = thread_local_counter.get();
```

---

## 11. Best Practices and Tips

- **Do not use internal macros directly in user code**: `GTEST_CHECK_`, `GTEST_LOG_`, and similar internal utilities are for GoogleTest's own implementation; prefer the public APIs.
- **Override feature flags only when necessary**: Usually, automatic detection suffices. Manual overrides may be needed on unusual platforms or cross-compilation scenarios.
- **Be aware of thread safety**: On platforms without pthreads or Windows equivalents, GoogleTest disables synchronization, which may affect multi-threaded test use.
- **Use provided synchronization and thread-local classes**: These ensure cross-platform correctness.

---

## 12. Troubleshooting Common Issues

- **Invalid or missing platform macros**: If GoogleTest cannot identify the platform, ensure you are using supported compilers and build environments or define macros manually.
- **Linker errors related to pthreads**: Verify the build system links with the pthread library if POSIX threading is detected and used.
- **Stream capturing quietness**: If `CaptureStdout()` or `CaptureStderr()` does not seem to capture output, confirm `GTEST_HAS_STREAM_REDIRECTION` is enabled and your platform supports standard file descriptor redirection.

---

## 13. Related Documentation

- [Supported Platforms & Build Systems](https://github.com/google/googletest/blob/main/docs/platforms.md)
- [Basic Configuration & Project Setup](https://github.com/google/googletest/blob/main/docs/getting-started/core-setup/configuration-basics.md)
- [Thread Safety in GoogleTest](https://github.com/google/googletest/blob/main/docs/primer.md#known-limitations)
- [Mocking Integration: gmock-port.h](https://github.com/google/googletest/blob/main/googlemock/include/gmock/internal/gmock-port.h)

---

## 14. Summary

The portability and configuration utilities encapsulated in `gtest-port.h` and related headers enable GoogleTest and GoogleMock to offer a consistent, configurable, and lightweight cross-platform testing environment. They manage platform detection, thread safety, regex support, and environmental configuration seamlessly, allowing users to focus on writing reliable tests rather than on platform intricacies.

---

<Accordion title="See Also">
- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md)
- [Supported Platforms](https://github.com/google/googletest/blob/main/docs/platforms.md)
- [GoogleMock Port Utilities](https://github.com/google/googletest/blob/main/googlemock/include/gmock/internal/gmock-port.h)
- [Basic Setup and Configuration](https://github.com/google/googletest/blob/main/docs/getting-started/core-setup/configuration-basics.md)
</Accordion>
