---
title: "Action Templates"
description: "Documents the action templates letting users specify what should happen when mocked methods are invoked. Covers the full range of supplied actions and the macro infrastructure to define parameterized, reusable actions for sophisticated mocking scenarios."
---

# Action Templates

Action Templates in GoogleMock provide a powerful mechanism allowing users to specify what happens when mocked methods are invoked. They enable creating parameterized, reusable actions that can be applied flexibly across different mock methods and signatures, enabling sophisticated mocking scenarios beyond the built-in actions.

This documentation covers the full range of static and parameterized actions supplied by GoogleTest, along with the macro infrastructure for defining custom action templates.

---

## What Are Actions?

Actions in gMock define the behavior of a mock method when it is called. They specify the effects such as returning values, modifying arguments, invoking callbacks, throwing exceptions, or performing complex multi-step operations.

Each mock method invocation matches an expectation flagged with an action to perform. Actions can be simple or combined, and can be customized or extended by users using Action Templates.

---

## Built-in Actions Overview

GoogleMock supplies an extensive collection of built-in actions, which can be used out-of-the-box:

### Returning Values
- `Return(value)`: Returns a specified value.
- `ReturnRef(variable)`: Returns a reference to a variable.
- `ReturnNew<T>(args...)`: Returns a new instance of type `T` constructed with the given args.
- `ReturnRoundRobin({values})`: Returns successive values cycling through the supplied list.
- `ReturnArg<N>()`: Returns the N-th argument of the mock method call.
- `ReturnNull()`: Returns a null pointer.
- `ReturnPointee(ptr)`: Returns the object pointed to by the pointer.

### Side Effects
- `Assign(&variable, value)`: Assigns a value to the variable.
- `DeleteArg<N>()`: Deletes the N-th argument (a pointer).
- `SetArgPointee<N>(value)`: Assigns value to the object pointed to by the N-th argument.
- `SetArrayArgument<N>(first, last)`: Copies a range to the array pointed to by the N-th argument.
- `Throw(exception)`: Throws the specified exception.
- `SetErrnoAndReturn(errno_val, return_val)`: Sets errno and returns a value.

### Invoking Callables
- `Invoke(f)`: Invokes callable `f` with the mock method's arguments.
- `InvokeWithoutArgs(f)`: Invokes callable `f` without any arguments.
- `InvokeArgument<N>(args...)`: Invokes the N-th argument (a callable) passing the specified arguments.

### Composite Actions
- `DoAll(a1, a2, ..., an)`: Performs multiple actions in sequence, returning the result of the last.
- `IgnoreResult(action)`: Performs an action and ignores its result.
- `WithArg<N>(action)`: Performs an action with the N-th argument.
- `WithoutArgs(action)`: Performs an action ignoring all arguments.

### Default
- `DoDefault()`: Performs the default action as defined via `ON_CALL()` or built-in defaults.

---

## Defining New Action Templates

While the built-in actions cover common cases, advanced testing often requires custom, parameterized actions. GoogleMock offers the `ACTION_TEMPLATE` macro to define new action templates with explicit template and value parameters.

### Syntax
```cpp
ACTION_TEMPLATE(ActionName,
                HAS_m_TEMPLATE_PARAMS(kind1, name1, ..., kind_m, name_m),
                AND_n_VALUE_PARAMS(p1, ..., p_n)) {
  // statements
}
```

- `ActionName`: The name of the new action template.
- `HAS_m_TEMPLATE_PARAMS(...)`: Specifies *m* template parameters with kinds (e.g., typename, int).
- `AND_n_VALUE_PARAMS(...)`: Specifies *n* value parameters for the action.

Inside the body, you can access all mock arguments using `args` (as a tuple), parameter values by name, and predefined symbols such as `arg0`, `args_type`, `return_type`.

### Example
Define an action that copies the k-th argument of the mock method and converts it to a specified type `T`:

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(::std::get<k>(args));
}
```

Use this action as:

```cpp
int captured_val;
EXPECT_CALL(mock, Foo).WillOnce(DuplicateArg<1, unsigned char>(&captured_val));
```

### Action Template Instantiation

To instantiate a template action, supply the explicit template parameters followed by the value parameters:

```cpp
ActionName<TemplateParams>(value_params)
```

For example:

```cpp
DuplicateArg<1, unsigned char>(&captured_val)
```

---

## Practical Tips and Best Practices

- **Use built-in actions first:** Many scenarios are covered by built-in actions like `Return`, `SetArgPointee`, or `Invoke`. Leverage those before creating custom actions.

- **Composite actions:** Use `DoAll` to combine actions where multiple side-effects or behaviors are desired in one method call.

- **Custom actions with `ACTION` macros:** When simple custom actions are needed, consider using `ACTION` and `ACTION_P` for readability and ease.

- **Preserve ownership semantics:** Be careful with move-only types in actions (like `std::unique_ptr`). Use lambdas or `Return(ByMove(...))` instead of naive `Return()` to return move-only values safely.

- **Avoid side-effects in matchers:** Actions can safely have side-effects, but matchers should always be pure and free of side effects.

- **Use `InvokeArgument<N>` to trigger callbacks passed as arguments:** This action invokes the N-th argument of the mocked function if it is callable, useful for mocking asynchronous callbacks.

- **Use `WillByDefault` to specify default behaviors:** To set default actions for mock methods (versus strict expectations), pair with `ON_CALL`.

---

## When and Why to Use Action Templates

- **Reusability:** When an action involves complex logic and requires parameters, action templates let you write once and reuse across tests and mocks.

- **Generality:** Template parameters allow adapting the action behavior to different types or behavior patterns.

- **Custom Complex Behaviors:** When you need to perform multi-step logic, argument manipulation, or chained side effects beyond existing built-in actions.

---

## Illustrative Code Examples

### Using Built-in Actions

```cpp
using ::testing::Return;
using ::testing::SetArgPointee;
using ::testing::DoAll;

EXPECT_CALL(mock, ProcessData(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

This sets the second argument pointed to (index 1) to 42 and returns true.

### Using InvokeArgument

```cpp
using ::testing::InvokeArgument;

EXPECT_CALL(mock, AsyncCall(_))
    .WillOnce(InvokeArgument<0>(5)); // Invokes the callable passed as 0th argument with 5
```

### Custom Action Template

```cpp
ACTION_P(DoubleArg0, factor) {
  return arg0 * factor;
}

EXPECT_CALL(mock, Multiply(_))
    .WillOnce(DoubleArg0(2)); // Multiplies arg0 by 2
```

For more flexible generic templates, use `ACTION_TEMPLATE` as shown in the previous section.

---

## Troubleshooting Common Issues

- **Return values:** Remember `Return()` captures the value at the time the expectation is set. If you want values computed at call time, use lambdas.

- **Move-only types:** Using `Return(std::move(...))` multiple times leads to run-time errors. Use lambdas or `Return(ByMove(...))`.

- **Uninteresting calls warning:** If you get warnings about uninteresting calls despite setting actions, consider `NiceMock` or add `EXPECT_CALL(...).Times(AnyNumber())`.

- **Action evaluation:** Actions specified inside `EXPECT_CALL` or `ON_CALL` are evaluated *once* at the statement, not at each call.

- **Complex action ordering:** If you have multi-step actions, ensure `DoAll()` has the last action return the method return type.

---

## References

- [Actions Reference](../reference/actions.md)
- [Mocking Reference](../reference/mocking.md#EXPECT_CALL)
- [gMock Cookbook](../gmock_cook_book.md#UsingActions)
- [gMock for Dummies - Actions](../gmock_for_dummies.md#setting-expectations)

---

This page is part of the GoogleTest suite documenting its advanced features around mocking. For a broader overview, see the [Mocking & Advanced Patterns Guides](../../guides/mocking-and-advanced-patterns/setting-expectations-and-actions.md).

---

<Info>
When writing custom actions with `ACTION_TEMPLATE`, remember that the macro sets up a class with a `Perform` operator that receives the matched call's arguments in a tuple and must return the appropriate value or void to satisfy the mock method's return type.
</Info>