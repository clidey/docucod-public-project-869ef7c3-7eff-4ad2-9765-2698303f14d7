---
title: "Framework Initialization and Main Entry"
description: "Instructions for setting up and initializing GoogleMock in your test suite. Covers usage of the main() function provided by gmock_main.cc, integration with GoogleTest runners, and platform-specific notes."
---

# Framework Initialization and Main Entry

## Overview

This documentation covers the setup and initialization of the GoogleMock framework in your test suite, specifically focusing on the provided `main()` function implementation in `gmock_main.cc`. Using this entry point simplifies integration by handling test framework initialization and execution seamlessly. This guide addresses how to utilize the `gmock_main` library, integrate with GoogleTest runners, and notes platform-specific variations.

---

## Why Initialization Matters

Before running tests that rely on GoogleMock and GoogleTest, you must initialize the framework properly to parse command-line arguments and configure the test environment. GoogleMock provides a convenient default `main()` function via the `gmock_main` library, which eliminates the need for users to write their own main function, thus reducing boilerplate and integration errors.

This initialization also ensures GoogleTest is correctly initialized since GoogleMock depends on it.

---

## Using the Provided `main()` Function: `gmock_main`

GoogleMock supplies a compiled library, `gmock_main`, which includes a `main()` function implementation located in `src/gmock_main.cc`. Linking your test executables against this library allows you to run tests immediately without a custom entry point.

### Features of `gmock_main`'s `main()`:

- Initializes **both GoogleMock and GoogleTest** via `testing::InitGoogleMock()`.
- Supports passing command-line arguments (`argc`, `argv`) for test filtering, output configuration, and other flags.
- Runs all tests by invoking `RUN_ALL_TESTS()` and returns the aggregated status.
- Prints a banner message `"Running main() from gmock_main.cc"` to diagnose which main function is linked.

### Platform-Specific Considerations:

- On **normal desktop platforms**, `main(int argc, char** argv)` serves as the program entry point.
- For **embedded and Arduino-like platforms (ESP8266, ESP32, nRF52)**, GoogleMock adapts by defining `setup()` and `loop()` functions instead of `main()`, integrating with typical Arduino lifecycles.
- On **Windows Mobile**, special handling ensures proper entry point linkage despite compiler quirks by using `_tmain` or `main` as appropriate.

---

## How to Link with `gmock_main`

When building your test executable, link against `gmock_main` instead of `gmock` alone:

```cmake
# Example CMake snippet
add_executable(my_tests test_main.cpp other_tests.cpp)
target_link_libraries(my_tests PRIVATE gmock_main)
```

This linkage automatically brings in the default `main()` and GoogleMock setup.

If you prefer to provide your own customized `main()`, link only against `gmock`.

---

## Initialization Function: `InitGoogleMock`

The core initialization function called in `gmock_main.cc` is:

```cpp
namespace testing {
  void InitGoogleMock(int* argc, char** argv);
  void InitGoogleMock();                    // For embedded/Arduino platforms
}
```

### Purpose:
- Parses and removes GoogleMock- and GoogleTest-specific flags from `argc`/`argv`.
- Initializes internal state for mocking and test execution.
- Calls GoogleTest initialization implicitly, so separate calls are unnecessary.

### Usage:
Usually, you do not need to call this explicitly if you link with `gmock_main`, as it is invoked by the provided `main()`.

If writing a custom main(), ensure to call `testing::InitGoogleMock(&argc, argv);` early before running any tests.

---

## Example: Custom `main()` Function (When Not Using `gmock_main`)

```cpp
#include "gmock/gmock.h"

int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This example mimics the behavior of `gmock_main.cc`. If you need to customize startup behavior, implement your own `main()` like above without linking to `gmock_main`.

---

## Platform-Specific Code Snippets

Below are concise examples reflecting platform adaptations from `gmock_main.cc`:

### Embedded/Arduino Platforms

```cpp
#ifdef GTEST_OS_ESP8266
extern "C" {
#endif

void setup() {
  testing::InitGoogleMock();  // No argc/argv
}

void loop() {
  RUN_ALL_TESTS();
}

#ifdef GTEST_OS_ESP8266
}
#endif
```

### Normal Desktop Platform Entry

```cpp
int main(int argc, char** argv) {
  std::cout << "Running main() from gmock_main.cc\n";
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

---

## Integration Tips and Best Practices

- Prefer linking against `gmock_main` for most test binaries to avoid writing redundant `main()` implementations.
- For complex custom test setups (e.g., initializing test environments or conditionally executing tests), write your own `main()` but use `testing::InitGoogleMock()` for initialization.
- Ensure that your build system links the correct threading and system libraries as GoogleTest and GoogleMock require them (CMake takes care of this automatically).
- On embedded platforms, use the appropriate initialization pattern (e.g., Arduino setup/loop).
- Print statements from `gmock_main`'s `main()` help you verify if your binary is linked correctly.

---

## Troubleshooting

<AccordionGroup title="Common Issues with Framework Initialization">
<Accordion title="Multiple `main()` Linker Errors">
Linker errors about multiple `main()` functions often occur when linking both `gmock_main` and a custom `main()` function in your code. To fix this:
- Use only `gmock_main` if you want the default main entry point.
- Remove `gmock_main` linking if providing your own `main()`.
</Accordion>
<Accordion title="Tests Not Running or Initialization Fails">
Ensure your test binary calls `testing::InitGoogleMock()` before executing tests. If relying on `gmock_main`, this is automatic.
Check that command-line arguments are correctly passed.
</Accordion>
<Accordion title="Platform-Specific Entry Points Missing">
On embedded or Arduino platforms, verify you include `gmock_main` that provides `setup()` and `loop()` functions instead of `main()`. Linking standard `main()` on those platforms will cause runtime failures.
</Accordion>
</AccordionGroup>

---

## Related Documentation

- [Using Mocks in Tests](https://github.com/google/googletest/blob/main/docs/guides/core-testing-workflows/using-mocks-in-tests.mdx) — details mock class setup and test writing.
- [Integration and Best Practices: Build System Integration](https://github.com/google/googletest/blob/main/docs/guides/integration-and-best-practices/build-system-integration.mdx) — covers CMake and Bazel linking strategies including `gmock_main`.
- [gMock API Reference: MOCK_METHOD, Expectations](https://github.com/google/googletest/blob/main/docs/api-reference/mocking-api/mock-method-macro.mdx) — explore mocking APIs beyond initialization.
- [Troubleshooting Setup and Runtime Issues](https://github.com/google/googletest/blob/main/docs/getting-started/first-steps/troubleshooting.mdx) — practical advice for resolving common errors.

---

## Summary

Using `gmock_main` simplifies your test setup by providing a default `main()` function that initializes GoogleMock and GoogleTest automatically, handles platform differences, and starts your tests. Linking your test binaries against this library streamlines execution and reduces boilerplate. When advanced customization or platform-specific behavior is needed, you can implement your own `main()` while respecting the initialization sequence described.

Embed these practices within your C++ test projects to ensure reliable, portable, and maintainable testing environments with GoogleMock.