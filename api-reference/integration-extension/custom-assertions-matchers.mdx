---
title: "Custom Assertions & Matchers"
description: "Instructions and examples for defining custom assertions and matchers to tailor test and mock validations to the specific requirements of user code."
---

# Custom Assertions & Matchers

This documentation provides detailed instructions and examples for defining **custom assertions and matchers** in GoogleTest and GoogleMock. These tools enable you to tailor your test and mock validations precisely to the unique requirements of your user code, enhancing expressiveness and robustness in your tests.

---

## Introduction

When writing tests, there are often situations where the built-in assertions or matchers do not adequately express the criteria you want to verify. This page guides you through creating custom assertions and matchers that let you describe complex verification logic clearly, with meaningful failure messages.

Custom assertions help verify specific conditions in your tests, while custom matchers allow flexible and readable specification of argument expectations in your mocks.

---

## Why Define Custom Assertions and Matchers?

- **Expressiveness:** You can capture complex domain-specific logic succinctly.
- **Reusability:** Encapsulate and reuse verification logic across multiple tests.
- **Clarity:** Generate clear and informative failure messages tailored to your check.
- **Integration:** Seamlessly integrate with your mocks and test assertions.

---

## Custom Matchers

GoogleMock's powerful matcher system allows you to specify what arguments you expect when a mock method is called. While there are many built-in matchers, creating _custom matchers_ enables you to define intricate matching logic to suit your needs.

### Basic Custom Matcher

Use the `MATCHER(name, description)` macro to define a stateless matcher easily. For example, to check if an integer is even:

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

// Usage in a test:
EXPECT_CALL(mock_object, Func(IsEven()));
EXPECT_THAT(value, IsEven());
```

Here, `arg` represents the value being matched. The description string appears in failure messages; if you leave it empty, GoogleMock generates one automatically from the matcher name.

### Parameterized Matchers

When your matcher requires parameters, use `MATCHER_P`, `MATCHER_P2`, ... up to `MATCHER_P10`. For example, a matcher that checks if a value is between two bounds:

```cpp
MATCHER_P2(IsBetween, low, high, "") {
  return low <= arg && arg <= high;
}

// Usage
EXPECT_CALL(mock_object, Func(IsBetween(1, 10)));
EXPECT_THAT(value, IsBetween(5, 7));
```

### Best Practices for Custom Matchers

- The matcher body must be **purely functional** with no side effects.
- Use `*result_listener` (if available) to output diagnostic messages explaining why a match failed.
- Prefer concise, human-readable descriptions for better failure messages.
- Use `PrintToString()` to convert parameter values for informative output.

### Example with Explanation Message

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  if (arg % divisor == 0) return true;
  *result_listener << "whose remainder is " << (arg % divisor);
  return false;
}

// Usage:
EXPECT_THAT(x, IsDivisibleBy(7));
```

If `x` fails to be divisible by 7, the failure message will include the remainder, helping debug the issue.

---

## Custom Assertions

While GoogleTest's `EXPECT_` and `ASSERT_` macros cover many scenarios, you can define _custom assertions_ for specialized conditions.

### Using Matchers in Assertions

GoogleTest provides the `EXPECT_THAT(value, matcher)` and `ASSERT_THAT(value, matcher)` macros that support any matcher:

```cpp
EXPECT_THAT(value, StartsWith("Hello"));
ASSERT_THAT(container, ElementsAre(1, 2, 3));
```

You can combine this with custom matchers to build expressive tests.

### Writing Predicate Assertions

If your condition is more complex, use the predicate-based assertions:

```cpp
// A predicate function
bool IsValid(const Foo& foo) { ... }

EXPECT_PRED1(IsValid, foo_instance);
```

Or predicate-format assertions, which provide rich failure messages:

```cpp
testing::AssertionResult AssertFoo(const char* expr, const Foo& foo) {
  if (foo.IsOk()) return testing::AssertionSuccess();
  return testing::AssertionFailure() << expr << " is not OK";
}

EXPECT_PRED_FORMAT1(AssertFoo, foo_instance);
```

---

## Using Matchers in Mocking

Matchers let you precisely specify which function calls your test code is expected to make. They can represent simple comparisons, wildcards, ranges, and complex logical combinations.

Examples:

```cpp
EXPECT_CALL(mock, Func(Ge(5), _));         // First argument >= 5, second anything
EXPECT_CALL(mock, Func(AllOf(Gt(0), Lt(10)))); // Argument in (0, 10)
```

For deeper detail, consult the [Matchers Reference](/api-reference/advanced-mocking-matchers-actions/matchers-reference).

---

## Defining Custom Matchers: Key Points

- Use `MATCHER` macros for quick definitions.
- For reusable, complex matchers, implement the matcher interface manually.
- Parameterize matchers to inject custom logic.
- Ensure matchers are **pure**, without side effects.
- Provide descriptive failure messages.

---

## Example: Custom Matcher with Parameters

Below is a complete example of a parameterized matcher checking if a string contains a substring a certain number of times.

```cpp
MATCHER_P2(ContainsNTimes, substring, count, "") {
  int occurrences = 0;
  size_t pos = 0;
  while ((pos = arg.find(substring, pos)) != std::string::npos) {
    ++occurrences;
    pos += substring.length();
  }
  *result_listener << "contains '" << substring << "' " << occurrences << " times";
  return occurrences == count;
}

// Use it as:
EXPECT_THAT(text, ContainsNTimes("error", 3));
```

---

## Integrating Custom Assertions and Matchers with GoogleMock

Custom matchers can be used inside `EXPECT_CALL()` macros to specify argument expectations precisely.

```cpp
EXPECT_CALL(mock_object, Method(ContainsNTimes("failed", 1)));
```

This enhances the power of your mocks and helps detect unexpected behaviors early.

---

## Practical Tips and Best Practices

- Define custom matchers in header files accessible by all tests that use them.
- Always write clear and user-friendly messages in matcher failures.
- Use standard matchers like `AllOf()`, `AnyOf()`, and `Not()` to compose complex logic.
- Avoid overly strict argument matchers to reduce test brittleness.
- Combine `ON_CALL()` for default behavior and `EXPECT_CALL()` for enforcing expectations.

---

## Troubleshooting Custom Assertions and Matchers

- **Matcher not called as expected?** Verify purity and absence of side effects.
- **Poor failure message?** Provide detailed diagnostic streaming to `result_listener`.
- **Compilation errors on custom matcher?** Ensure `MATCHER*` macros are declared at namespace scope.
- **Ambiguous matcher usage?** Use explicit template parameters or type casts like `SafeMatcherCast`.

---

## Related Documentation

- [Matchers Reference](https://github.com/google/googletest/blob/main/docs/reference/matchers.md) — detailed overview of built-in and custom matchers.
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) — how to write and configure mocks.
- [Assertions Reference](https://github.com/google/googletest/blob/main/docs/reference/assertions.md) — usage of assertions including `EXPECT_THAT`.
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) — recipes and best practices.

---

## Summary

Mastering custom assertions and matchers empowers you to write precise, expressive, and maintainable tests. With flexible matchers, your mock expectations become clearer, your failures more informative, and your test suite more resilient.

Explore related guides on mocking, matchers, and assertions to leverage GoogleTest and GoogleMock to their fullest potential.

---

<Callout title="Tip">
To start creating your own matchers, first experiment with `MATCHER` and `MATCHER_P` macros in simple scenarios to grasp the fundamentals.
</Callout>

<Callout title="Note">
Always define matchers in the global or testing namespace scope, outside functions and classes, to ensure proper linkage and type deduction.
</Callout>

---

For any further questions or examples, consult the extensive GoogleTest and GoogleMock documentation or community resources.
