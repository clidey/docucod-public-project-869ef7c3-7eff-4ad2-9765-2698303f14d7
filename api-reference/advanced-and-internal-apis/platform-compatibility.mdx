---
title: "Platform Compatibility and Porting Utilities"
description: "Documents platform abstraction APIs, macros, and utility functions that underpin GoogleTest and GoogleMock's cross-platform support. Explains flag management, logging, threading, and OS compatibility layers for developers adapting the tools to novel environments."
---

# Platform Compatibility and Porting Utilities

This documentation details the platform abstraction APIs, macros, and utility functions underpinning GoogleTest and GoogleMock's ability to operate seamlessly across diverse operating systems and environments. It guides developers aiming to adapt or extend these testing tools to novel or less-common platforms by clarifying the flag management, logging, threading, and OS compatibility layers.

---

## Overview

GoogleTest and GoogleMock are designed with broad platform compatibility in mind. Achieving this requires a foundational layer of platform abstraction utilities that:

- Identify and adapt to underlying operating system capabilities
- Manage cross-platform threading, synchronization, and logging
- Handle platform-specific quirks transparently

This is primarily implemented in the header `gtest-port.h` for GoogleTest, with complementary logic in `gmock-port.h` for GoogleMock.

These layers expose macros, classes, and functions for platform detection, feature flags, logging, threading primitives, character handling, and more. Users typically interact indirectly with these through the public APIs, but understanding them is essential when customizing GoogleTest/GoogleMock for unusual environments.

---

## Environment-Describing Macros

GoogleTest uses a set of macros to detect or specify platform features. These allow conditional compilation and selective enabling of features.

### Key Macros and Their Purpose

| Macro                        | Description                                                             | Usage                         |
|------------------------------|-------------------------------------------------------------------------|------------------------------|
| `GTEST_HAS_CLONE`            | Indicates support for the Linux `clone(2)` system call                  | `1` or `0`                   |
| `GTEST_HAS_EXCEPTIONS`       | Whether C++ exceptions are enabled                                      | `1` or `0`                   |
| `GTEST_HAS_POSIX_RE`         | Availability of POSIX regular expressions                              | `1` or `0`                   |
| `GTEST_HAS_PTHREAD`          | Availability of pthreads threading library                             | `1` or `0`                   |
| `GTEST_HAS_RTTI`             | Runtime Type Information (RTTI) support                                | `1` or `0`                   |
| `GTEST_HAS_STD_WSTRING`      | Whether `std::wstring` is supported                                    | `1` or `0`                   |
| `GTEST_HAS_FILE_SYSTEM`      | Support for filesystem operations                                      | `1` or `0`                   |
| `GTEST_HAS_SEH`              | Support for Microsoft Structured Exception Handling                   | `1` or `0`                   |
| `GTEST_HAS_STREAM_REDIRECTION` | Support for capturing I/O stream redirection                         | `1` or `0`                   |
| `GTEST_LINKED_AS_SHARED_LIBRARY` | Defined when linking against GoogleTest built as a shared library  | `1` when applicable          |
| `GTEST_CREATE_SHARED_LIBRARY` | Defined when building GoogleTest as a shared library                  | `1` when applicable          |
| `GTEST_DEFAULT_DEATH_TEST_STYLE` | Default behavior for death tests, e.g., "fast" or "threadsafe"   | String literal               |

These macros default to either `1` or `0` after detection and are always defined (never left undefined), ensuring consistent preprocessor checks.

> Define these macros explicitly at build time if automatic detection is imperfect for your platform.

---

## Platform Identification Macros

GoogleTest automatically defines platform-specific macros to represent the host OS environment. These macros are never defined by user code and follow naming like `GTEST_OS_<PLATFORM>`. A few examples:

- `GTEST_OS_LINUX`
- `GTEST_OS_WINDOWS`
- `GTEST_OS_MAC`
- `GTEST_OS_CYGWIN`
- Platform variants like `GTEST_OS_WINDOWS_DESKTOP`, `GTEST_OS_WINDOWS_MINGW`, etc.

These macros enable selective compilation of platform-specific code paths.

---

## Feature-Availability Macros

These indicate availability of key GoogleTest features relevant to portable test development:

- `GTEST_HAS_DEATH_TEST` - Whether death tests are available
- `GTEST_HAS_TYPED_TEST` and `GTEST_HAS_TYPED_TEST_P` - Support for typed, parameterized tests
- `GTEST_IS_THREADSAFE` - Thread-safety support status
- `GTEST_USES_RE2`, `GTEST_USES_POSIX_RE`, `GTEST_USES_SIMPLE_RE` - Regex engine variants
- `GTEST_HAS_ABSL` - GoogleTest built with Abseil support

Use these macros to guard test code and features for compatibility.

---

## Logging Facilities

GoogleTest provides a cross-platform logging capability that abstracts log output in a consistent manner. Key components:

- `GTEST_LOG_(severity)` macro: logs a message at severity level (INFO, WARNING, ERROR, FATAL).
- `GTestLog` class: Manages log stream lifecycle and optionally aborts on fatal logs.
- `LogToStderr()`: Optional function to direct all logs to standard error.
- `FlushInfoLog()`: Flushes informational logs.

Typical usage example:

```cpp
GTEST_LOG_(INFO) << "Informational message";
GTEST_LOG_(WARNING) << "Warning: possible issue detected.";
GTEST_LOG_(FATAL) << "Fatal error: aborting.";  // Aborts program immediately
```

By default, logs are streamed to standard error.

---

## Stream Capture Utilities

GoogleTest supports capturing output generated on standard output (`stdout`) and error (`stderr`) streams. This is useful when testing code that writes to these streams.

- `CaptureStdout()`: Begin capturing stdout
- `GetCapturedStdout()`: Stop capturing and retrieve captured stdout content
- `CaptureStderr()`: Begin capturing stderr
- `GetCapturedStderr()`: Stop capturing and retrieve captured stderr content

This is enabled on most platforms where stream redirection is supported (`GTEST_HAS_STREAM_REDIRECTION == 1`).

<Check>
Only one active capture can exist for stdout or stderr at a time. Attempting to reenter capture results in a fatal error.
</Check>

---

## Threading and Synchronization Primitives

GoogleTest implements internal thread-safety primitives adapted to the platform.

### Thread Safety Determination

- Macro `GTEST_IS_THREADSAFE` defines if thread-safe primitives are available.
- Supported through either pthreads (POSIX) or native Windows API.

### Mutex

- `Mutex` class: Provides mutual exclusion locking.
- `MutexLock` (aka `GTestMutexLock`): RAII style locking wrapper.
- Static mutexes can be declared and defined via `GTEST_DECLARE_STATIC_MUTEX_` and `GTEST_DEFINE_STATIC_MUTEX_`.

**Example usage:**

```cpp
::testing::internal::Mutex mu;
{
  ::testing::internal::MutexLock lock(&mu);  // Lock acquired
  // critical section
}  // lock destructed, mutex unlocked
```

### ThreadLocal Storage

- `ThreadLocal<T>` template: Provides thread-local data storage.
- Supports default-initialized and parameterized construction.
- Ensures values are unique per thread and destroyed safely.

### Notification

- `Notification` class: Used to block threads until notified.
- Mainly used internally for thread coordination in tests.

### Thread Execution Helper

- `ThreadWithParam<T>` template class: Allows running user-defined functions with parameters on new threads.
- Provides `Join()` to wait for thread completion.

**Note:** These classes are primarily for internal use and testing GoogleTest's concurrency features.

---

## File System and POSIX Compatibility Wrappers

GoogleTest abstracts common filesystem and OS API calls to handle platform differences.

- `posix::Stat()`, `RmDir()`, and `IsDir()` wrap file status and directory removal.
- `posix::FOpen()`, `FReopen()`, `FDOpen()`, `FClose()` wrap file open/close operations.
- `posix::Read()`, `Write()`, and `Close()` for low-level file descriptor operations.
- `posix::GetEnv()` wraps environment variable access, accounting for platforms that lack environment variable support.
- `posix::IsATTY()` provides platform-specific terminal detection.

These wrappers enable writing portable code without scattering platform-specific #ifdefs.

---

## Character Utilities

GoogleTest defines inline functions to safely handle character classification and conversion consistently across platforms:

- `IsAlpha()`, `IsDigit()`, `IsSpace()`, `IsUpper()`, `IsLower()`, and `IsXDigit()` handle ASCII checks with proper casting to `unsigned char`.
- `ToLower()`, `ToUpper()` provide safe character case conversion.
- `StripTrailingSpaces()` trims spaces from the end of strings.

These utilities ensure consistent behavior for assertion messages and regex implementations.

---

## Regular Expression Handling

GoogleTest supports multiple regex engines, automatically selecting the best supported on the platform:

- RE2 (when Abseil and RE2 dependencies are enabled)
- POSIX Extended Regular Expressions (on UNIX-like platforms)
- A simple built-in regex engine for platforms lacking others

The `RE` class provides the interface:

- Construction from string patterns
- `FullMatch` and `PartialMatch` static methods for regex testing

Example:

```cpp
  ::testing::internal::RE my_regex("^test.*$");
  bool matches = ::testing::internal::RE::FullMatch("testing", my_regex);
```

---

## Integer Types and Helpers

GoogleTest defines integer types of specific sizes for cross-platform consistency:

- `BiggestInt`: The largest signed integer type supported (typically `long long`).
- `TypeWithSize`: Template mapping sizes in bytes to specific integer types (e.g., 4 bytes -> `int32_t`).
- `TimeInMillis`: Alias for millisecond durations as `int64_t`.

These are integral in precise comparisons and timing functions within the testing framework.

---

## Flag and Environment Variable Utilities

GoogleTest supports command-line flags and environment variables for test customization:

- Macros like `GTEST_FLAG(flag_name)` provide access to internal flag variables.
- When built with Abseil, Abseil Flags replace internal flag management.
- Functions parse flags and environment variables in a type-safe manner:
  - `BoolFromGTestEnv()`
  - `Int32FromGTestEnv()`
  - `StringFromGTestEnv()`

These features allow users to configure tests behaviorally without code changes.

---

## Error Checking Macros

GoogleTest provides internal macros for runtime assertions and error checking:

- `GTEST_CHECK_(condition)`: Aborts program if condition is false, logging the failure.
- `GTEST_CHECK_POSIX_SUCCESS_(posix_call)`: Verifies POSIX calls return 0, aborts with error

These are primarily used for internal sanity checks in GoogleTest source code.

---

## Customization Points

Both GoogleTest and GoogleMock allow users to provide custom implementations or overrides via custom directories:

- GoogleTest: Custom macros in `gtest/internal/custom/gtest-port.h`.
- GoogleMock: Custom macros in `gmock/internal/custom/gmock-port.h`.

Examples:

- Override platform-specific logging functions
- Provide alternate threading or synchronization implementations
- Define or replace environmental macros

For details, refer to the customization README files within the source tree.

---

## Practical Tips and Best Practices

- **Platform Adaptation:** When porting GoogleTest to a novel environment, start by verifying and setting the environment-defining macros appropriately.

- **Flag Overrides:** Use compiler flags (`-DGTEST_HAS_PTHREAD=0`, etc.) to tailor platform assumptions when automatic detection fails.

- **Threading:** Enable threading support carefully, making sure necessary thread libraries are linked (e.g., pthreads on Linux).

- **Shared Libraries:** If building GoogleTest/GoogleMock as shared libraries, define `GTEST_CREATE_SHARED_LIBRARY` and `GTEST_LINKED_AS_SHARED_LIBRARY` to ensure correct symbol visibility.

- **Logging:** For environments lacking standard stderr, override logging macros to redirect logs properly.

- **Stream Capturing:** Use stream capturing to test code with output on stdout or stderr.

- **Writing Tests:** Rest assured these abstractions work transparently for test authors who consume GoogleTest normally.

- **Handling Unsupported Platforms:** If platform features like file-io or threading are missing, GoogleTest gracefully disables applicable features.

---

## Troubleshooting

- **Missing Macros:** If you find undefined macros related to platform or feature detection, verify your build configuration or explicitly define them.

- **Linking Errors on Threading:** Ensure the pthread library is linked if using `GTEST_HAS_PTHREAD`.

- **Stream Capture Failures:** Confirm your platform sets `GTEST_HAS_STREAM_REDIRECTION` to 1 if you wish to use output capturing.

- **Logging Crashes:** Override logging macros if standard streams are unavailable.

- **Exception Support:** If exceptions appear disabled, check `GTEST_HAS_EXCEPTIONS` and your compiler flags.

- **Wide String Issues:** On platforms lacking wide string support, `GTEST_HAS_STD_WSTRING` will be 0; avoid related assertions or features.

---

## Reference Example: Using Mutex and ThreadLocal

```cpp
#include "gtest/internal/gtest-port.h"

using namespace testing::internal;

Mutex mu;
ThreadLocal<int> thread_local_value(42);

void ThreadFunc() {
  MutexLock lock(&mu);
  int value = thread_local_value.get();
  // Do thread-safe operations using value...
}
```

---

## Additional Resources

- See [Supported Platforms](https://github.com/google/googletest/blob/main/docs/platforms.md) for platform compatibility.
- Refer to the [googletest README](https://github.com/google/googletest/blob/main/googletest/README.md) for build and configuration guides.
- The [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) helps understand core testing concepts that depend on this compatibility layer.
- For advanced topics and customization, explore the `custom` directory within the source headers.

---

## Diagram: Platform Compatibility Layer Overview

```mermaid
flowchart TD
  subgraph Platform_Abstraction_Layer
    EnvDetection["Environment Macros"]
    FeatureFlags["Feature Availability Macros"]
    PlatformMacros["Platform Identification Macros"]
    Logging["Logging Utilities"]
    Threads["Threading & Sync Primitives"]
    FileSystem["File System Wrappers"]
    CharUtils["Character Utilities"]
    Regex["Regex Engine (RE)"]
    Flags["Flag and Env Variable Utilities"]
  end

  UserCode["GoogleTest & GoogleMock Framework Code"] -->|Uses| Platform_Abstraction_Layer

  EnvDetection --> FeatureFlags
  FeatureFlags --> Threads
  FeatureFlags --> Regex
  PlatformMacros --> FileSystem
  Threads --> Mutex["Mutex & MutexLock"]
  Threads --> ThreadLocal["ThreadLocal<T> Storage"]
  Threads --> Notification["Notification Synchronization"]
  Logging --> Logs["GTEST_LOG_ Macro"]
  FileSystem --> POSIX["posix namespace wrappers"]
  CharUtils --> Regex
  Flags --> UserCode

  Style Platform_Abstraction_Layer fill:#def,stroke:#333,stroke-width:1px
```

---

This reference illustrates how various components interrelate, forming a cohesive foundation that makes GoogleTest and GoogleMock seamlessly cross-platform.

---

## Summary
This page documents the low-level platform compatibility and porting utilities that allow GoogleTest and GoogleMock to function across multiple operating systems and environments. It focuses on the environment identification macros, feature availability flags, logging, threading primitives, filesystem wrappers, character utilities, regex support, and flag management critical for adapting the framework to new platforms or customizing its behavior.

# End of Document
