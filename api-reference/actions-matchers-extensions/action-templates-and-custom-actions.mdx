---
title: "Action Templates and Custom Actions"
description: "Reference for using and creating actions that control the side effects and return values of mock methods. Includes reusable templates, the ACTION and ACTION_TEMPLATE macros, and advanced constructs such as InvokeArgument. Suitable for complex behavior orchestration in tests."
---

# Action Templates and Custom Actions

This reference provides detailed guidance on how to use and create **actions** in GoogleMock, which define the behaviors of mock methods when they are called. Actions control the side effects, return values, or delegated executions of mock functions, enabling complex test behavior orchestration.

All actions discussed here reside in the `::testing` namespace.

---

## Built-in Actions Overview

GoogleMock provides a rich set of built-in actions covering return values, side effects, delegation, and composition. Here's a high-level categorization:

| Action Category          | Common Examples                           | Description                                               |
|-------------------------|-------------------------------------------|-----------------------------------------------------------|
| Returning Values        | `Return()`, `Return(value)`, `ReturnRef()`, `ReturnPointee()` | Return a value or reference from a mock method call.
| Side Effects            | `SetArgPointee()`, `SetArrayArgument()`, `Assign()`, `DeleteArg()` | Perform modifications on arguments or global state.
| Delegation              | `Invoke()`, `InvokeWithoutArgs()`, `InvokeArgument()` | Call a function, method, or callable object.
| Composition             | `DoAll()`, `IgnoreResult()`, `WithArg()`, `WithArgs()`, `WithoutArgs()` | Combine multiple actions or transform arguments.

---

## Using Return Actions

- `Return()`: Return from a void mock function.
- `Return(value)`: Return the specified value. Note that the conversion to the mock function's return type occurs when the expectation is set, not at runtime.
- `ReturnRef(variable)`: Return a reference to a variable.
- `ReturnPointee(ptr)`: Dereference the pointer `ptr` and return the result at runtime.
- `ReturnNull()`: Return a null pointer.
- `ReturnNew<T>(args...)`: Create and return a new object by invoking `new T(args...)` each time the method is called.
- `ReturnRoundRobin({a1, ...})`: Return the elements from the list in round-robin fashion.

### Example:
```cpp
using ::testing::Return;

EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

---

## Side Effect Actions

- `Assign(&variable, value)`: Assigns the value to the referenced variable.
- `DeleteArg<N>()`: Deletes the N-th argument (which must be a pointer).
- `SaveArg<N>(pointer)`: Copies the N-th argument into `*pointer`.
- `SaveArgByMove<N>(pointer)`: Moves the N-th argument into `*pointer`.
- `SaveArgPointee<N>(pointer)`: Copies the value pointed to by the N-th argument into `*pointer`.
- `SetArgReferee<N>(value)`: Assigns `value` to the variable referred to by the N-th argument.
- `SetArgPointee<N>(value)`: Assigns `value` to the value pointed to by the N-th argument.
- `SetArrayArgument<N>(first, last)`: Copies elements from `[first, last)` into the array or iterator pointed by the N-th argument.
- `SetErrnoAndReturn(error, value)`: Sets `errno` to `error` and returns `value`.
- `Throw(exception)`: Throws the specified exception when called.

### Example:
```cpp
using ::testing::SetArgPointee;
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(SetArgPointee<1>(100));
```

---

## Using Functions, Functors, and Lambdas as Actions

You can specify a callable to execute when a mock method is invoked. Functions, lambdas, and functors can be used via:

- `f`: Pass a callable `f` directly.
- `Invoke(f)`: Invoke `f` with the mock's arguments.
- `Invoke(object_pointer, &Class::Method)`: Call a method on an object.
- `InvokeWithoutArgs(f)`: Call `f` with no arguments.
- `InvokeWithoutArgs(object_pointer, &Class::Method)`: Call a zero-argument method on an object.
- `InvokeArgument<N>(args...)`: Invoke the N-th argument of the mock method call as a callable with the provided arguments.

### Special notes:
- For `InvokeArgument<N>`, if the callable takes arguments by reference, wrap those arguments with `std::ref()` to pass by reference.

### Example:
```cpp
using ::testing::Invoke;

int ComputeSum(int a, int b) { return a + b; }
EXPECT_CALL(mock, DoSum(_, _))
    .WillOnce(Invoke(ComputeSum));
```

---

## Default Actions

- `DoDefault()`: Invokes the default action specified by `ON_CALL`, or the built-in default if none specified.

> **Note:** `DoDefault()` cannot be used inside composite actions and will result in a runtime error if attempted.

---

## Composite Actions

Composite actions allow you to combine or manipulate other actions.

- `DoAll(a1, a2, ..., an)`: Performs all actions sequentially. All except the last must return `void`. Returns the result of the last action.
- `IgnoreResult(a)`: Executes action `a` and ignores its return value. Useful to adapt actions returning a value to mock methods returning void or within `DoAll()`.
- `WithArg<N>(a)`: Passes the N-th argument of the mock method to action `a`.
- `WithArgs<N1, N2, ..., Nk>(a)`: Passes selected arguments to action `a`.
- `WithoutArgs(a)`: Calls action `a` with no arguments.

### Example:
```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(123), Return(true)));
```

---

## Defining Custom Actions

GoogleMock supports defining custom actions to extend its capabilities. There are multiple approaches:

### 1. Using `ACTION` and `ACTION_P` macros

These macros define (parameterized) actions with access to mock call arguments `arg0`, `arg1`, etc.

Example:
```cpp
ACTION(IncrementArg0) {
  return ++(*arg0);
}

EXPECT_CALL(mock, DoSomething()).WillOnce(IncrementArg0());
```

With parameters:
```cpp
ACTION_P(Add, n) {
  return arg0 + n;
}

EXPECT_CALL(mock, Compute()).WillOnce(Add(5));
```

### 2. Using `ACTION_TEMPLATE` for templated actions

Use when you need explicit template parameters not deducible from values.

Example:
```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

EXPECT_CALL(mock, Func(_, _)).WillOnce(DuplicateArg<1, unsigned char>(&n));
```

### 3. Implementing ActionInterface

For full control and clarity, implement `::testing::ActionInterface<F>`, where `F` is the signature type of the mock method.

Example:
```cpp
class IncrementAction : public ::testing::ActionInterface<int(int*)> {
 public:
  int Perform(const std::tuple<int*>& args) override {
    return ++(*std::get<0>(args));
  }
};

::testing::Action<int(int*)> Increment() {
  return ::testing::MakeAction(new IncrementAction); 
}
```

### 4. Using `MakePolymorphicAction` for polymorphic actions

Allows the same action to be used with different mock method signatures.

Example:
```cpp
class ReturnSecondArgumentImpl {
 public:
  template <typename R, typename Args>
  R Perform(const Args& args) const {
    return std::get<1>(args);
  }
};

::testing::PolymorphicAction<ReturnSecondArgumentImpl> ReturnSecondArgument() {
  return ::testing::MakePolymorphicAction(ReturnSecondArgumentImpl());
}

EXPECT_CALL(mock, Func(_, _)).WillOnce(ReturnSecondArgument());
```

---

## Notes and Best Practices

- Actions that are stateful should be handled carefully when shared between expectations.
- When returning move-only values, consider using lambdas or functors instead of `Return()`.
- Use `IgnoreResult()` to adapt actions returning values for use with `void` mock methods or composite actions.
- Use `InvokeArgument<N>` to call a callable argument passed to the mock method.

---

## Summary

By mastering actions, you enable your mocks to simulate complex behaviors including returning dynamic values, triggering side effects, delegating operations, and combining multiple steps. Leveraging built-in actions and custom-defined actions ensures your tests remain expressive, maintainable, and robust.

For full details on available actions and usage examples, see the [Actions Reference](../docs/reference/actions.md).

---

## Further Reading

- [gMock Cookbook](docs/gmock_cook_book.md) - Recipes for using matchers and actions.
- [Mocking Reference](docs/reference/mocking.md) - Details on mock definitions and expectations.
- [Matchers Reference](docs/reference/matchers.md) - For argument matching in expectations.
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md) - Quick guide to common mocking tasks.
