---
title: "Setting Expectations"
description: "Details how to use ON_CALL and EXPECT_CALL macros to specify behaviors and call expectations, covering default actions, return values, input matchers, and reaction to uninteresting calls."
---

# Setting Expectations with ON_CALL and EXPECT_CALL

This page details how to use the `ON_CALL` and `EXPECT_CALL` macros in GoogleMock to specify both the behaviors of mock methods and expectations on their invocations. These tools empower you to define default actions, set precise call expectations with argument matchers, and control reactions to uninteresting or unexpected calls.

---

## Overview

GoogleMock lets you replace real objects in tests with mock objects that can simulate behavior and verify interaction. The two primary macros for this are:

- `ON_CALL(mock_object, Method(matchers))`: Defines the default behavior of a mock method without setting an expectation that it must be called.
- `EXPECT_CALL(mock_object, Method(matchers))`: Defines both the expected behavior and the expected number and conditions of calls.

Use `ON_CALL` for setting up common or fallback behaviors, and `EXPECT_CALL` when you want to verify that calls happen as expected.

<Check>
Always set expectations before the code under test calls the mock methods. Setting expectations afterward leads to undefined behavior.
</Check>

---

## Using `ON_CALL` to Define Default Actions

`ON_CALL` specifies actions taken whenever the mock method is called, without enforcing an expectation that the call must occur.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers))
    .With(multi_argument_matcher)  // optional
    .WillByDefault(action);
```

- `mock_object`: The mock instance.
- `Method(matchers)`: The method and argument matchers (can be omitted for non-overloaded methods to match any arguments).
- `.With(...)`: (Optional) Matches the entire argument tuple.
- `.WillByDefault(action)`: Required. Defines what the method does when called with matching arguments.

### Behavior

- Multiple `ON_CALL`s can define different behaviors for different argument conditions.
- When a method is called, the last matching `ON_CALL` takes precedence.
- The default action (if no `ON_CALL` is set) returns zero, false, or default-constructed values depending on the return type.

### Example

```cpp
using ::testing::_;
using ::testing::Lt;
using ::testing::Return;

ON_CALL(my_mock, SetPosition(_, _))
    .With(Lt())
    .WillByDefault(Return(true));
```

This sets the default behavior for `SetPosition` when the first argument is less than the second to return `true`.

<Note>
`.With()` can be used at most once and must be the first clause of an `ON_CALL` statement.
</Note>

---

## Using `EXPECT_CALL` to Set Call Expectations and Behavior

`EXPECT_CALL` defines the expected calls to a mock method and how those calls behave. It is the heart of specifying interaction contracts in tests.

### Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers))
   .With(multi_argument_matcher)  // optional
   .Times(cardinality)            // optional
   .InSequence(sequences...)      // optional
   .After(expectations...)        // optional
   .WillOnce(action)              // optional, repeatable
   .WillRepeatedly(action)        // optional
   .RetiresOnSaturation();        // optional
```

### Clauses Explained

- `.With(matcher)`: Like `ON_CALL`, matches against the tuple of all arguments.
- `.Times(cardinality)`: Specifies how many times the expectation is valid, using cardinalities like `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`, etc.
- `.InSequence(sequences...)`: Enforces call order within specified sequences.
- `.After(expectations...)`: Requires this call only after other expectations satisfy (partial order).
- `.WillOnce(action)`: Specifies behavior for a single occurrence of the call.
- `.WillRepeatedly(action)`: Specifies behavior for all subsequent calls after `WillOnce`s are exhausted.
- `.RetiresOnSaturation()`: Causes this expectation to retire when its call limit is reached, allowing other expectations to match further calls.

<Info>
Clauses must appear in the following order when present: `.With()` → `.Times()` → `.InSequence()` → `.After()` → `.WillOnce()` → `.WillRepeatedly()` → `.RetiresOnSaturation()`.
</Info>

### Cardinalities

Use to specify expected call count:

| Cardinality | Meaning |
|-------------|----------|
| `AnyNumber()` | Call any number of times.
| `AtLeast(n)`  | Called at least n times.
| `AtMost(n)`   | Called at most n times.
| `Between(m,n)`| Between m and n calls.
| `Exactly(n)`  | Exactly n calls.

If `.Times()` is omitted, GoogleMock infers it:
- No `.WillOnce` nor `.WillRepeatedly`: expects exactly 1 call.
- With `n` `.WillOnce`s and no `.WillRepeatedly`: expects exactly `n` calls.
- With `n` `.WillOnce`s and `.WillRepeatedly`: expects at least `n` calls.

### Example

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::Sequence;

Sequence s;

EXPECT_CALL(my_mock, GetNumber())
    .Times(3)
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));

EXPECT_CALL(my_mock, Reset())
    .InSequence(s);
EXPECT_CALL(my_mock, GetNumber())
    .InSequence(s);
```

This expects `GetNumber()` to be called thrice returning 1, 2, 3 respectively, and a sequence ordering between `Reset()` and `GetNumber()`.

### Setting Up Multiple Expectations

GoogleMock searches for matching expectations in reverse order of declaration, preferring newer expectations to override older ones.

<Warning>
Beware over-specifying: if two expectations overlap, calls can unexpectedly match the wrong one unless carefully ordered.
</Warning>

### Retiring Expectations

Use `.RetiresOnSaturation()` to deactivate an expectation after its allowed calls to avoid saturation errors when overlapping expectations exist.

### Controlling Call Order

- Use `InSequence` RAII object or `.InSequence()` clause with `Sequence` objects to specify strict order.
- Alternatively, use `.After()` to specify partial order prerequisites.

### Common Usage Patterns

- Catch-all expectations with `.Times(AnyNumber())` and wildcards (`_`) to ignore uninteresting calls.
- Specific `EXPECT_CALL`s for calls you want to verify precisely.

<Note>
`.With()` clause must be the first clause and appear at most once in `EXPECT_CALL`.
</Note>

---

## Matchers for Argument Matching

You specify what arguments are expected using matchers (e.g., exact values, `_` for anything, predicates like `Lt(5)`).

When omitted for non-overloaded methods, arguments default to wildcards.

### Examples

```cpp
EXPECT_CALL(foo, Bar(5));  // expects argument equal to 5
EXPECT_CALL(foo, Baz(_, Lt(10)));  // first arg anything, second less than 10
```

---

## Common Pitfalls and Best Practices

### When to Use `ON_CALL` vs. `EXPECT_CALL`

- Use `ON_CALL` to define stable or default behavior of mocks without asserting their calls.
- Use `EXPECT_CALL` when your test needs to verify the interactions explicitly.

### Avoid Over-Verification

Overly strict expectations make tests brittle. Use broad matchers and fewer `EXPECT_CALL`s when details don't matter.

### Suppressing Uninteresting Call Warnings

To avoid warnings from uninteresting calls (methods with no `EXPECT_CALL`), use `NiceMock<T>`. Alternatively, add `EXPECT_CALL(...).Times(AnyNumber())` for methods you want to silence warnings on.

### Setting Expectations in Setup

Set your `ON_CALL`s and default behavior in fixture setup, and write focused `EXPECT_CALL`s in tests to verify behavior.

### Order of Expectations Matters

Later `EXPECT_CALL`s have precedence. If you want call order, use sequences or `.After()` clauses explicitly.

---

## Troubleshooting

### Uninteresting Call Warnings

```
GMOCK WARNING:
Uninteresting mock function call - returning default value.
Function call: Foo(1, 2)
```
This indicates a mock method was called without an `EXPECT_CALL`. Use `NiceMock` or add a permissive `EXPECT_CALL` to suppress.

### Unexpected Call Failures

```
Unexpected mock function call - returning default value.
Function call: Bar(5)
Expected arg #0: is equal to 3
Actual: 5
```
The method was called with unexpected arguments relative to the expectations. Check argument matchers.

### Excessive Call Failures

```
Mock function called more times than expected - returning default value.
Function call: Bar(3)
Expected: to be called once
Actual: called twice
```
The call count exceeded `.Times()`; consider if your `.Times()` is correct or add `.RetiresOnSaturation()`.

### Call Order Violations

If using `InSequence` or `.After()`, calls that do not match the order produce failures.

---

## Additional Tools

### Sequences and Ordering

Use `Sequence` objects to group expectations to enforce call order.
Using the `InSequence` object creates an anonymous `Sequence` affecting expectations in its scope.

### Expectation Sets

When specifying `.After()`, you can pass a set of expectations to declare multiple pre-requisites.

### Retiring Expectations

Use `.RetiresOnSaturation()` to retire an expectation automatically once saturated, enabling others to match subsequent calls.

---

## Summary

The `ON_CALL` and `EXPECT_CALL` macros provide powerful capabilities to customize and verify mock behavior in GoogleMock.

- Use `ON_CALL` to set default fallback behavior without enforcing a call.
- Use `EXPECT_CALL` to specify what calls must happen, their argument constraints, and behaviors.
- Compose matchers to precisely specify argument expectations.
- Control call count and order with cardinalities, sequences, and prereq chains.
- Manage uninteresting calls and expectation lifecycle with niceness levels and retiring.

Together, these tools allow you to write robust, maintainable tests that verify the interactions your code has with dependencies precisely and flexibly.

---

For a deeper dive, see the [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) and the [Mocking Reference](reference/mocking.md).

---

## Example Full Pattern

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;
using ::testing::Sequence;

class MockFoo {
 public:
  MOCK_METHOD(int, Bar, (int x), ());
};

TEST(FooTest, CheckBarCalls) {
  MockFoo mock;

  // Default behavior for any input
  ON_CALL(mock, Bar(_)).WillByDefault(Return(0));

  // Expect Bar(5) to be called exactly twice, returns 10
  EXPECT_CALL(mock, Bar(5))
      .Times(2)
      .WillRepeatedly(Return(10));

  // Expect Bar with input > 10 once
  EXPECT_CALL(mock, Bar(_))
      .With(::testing::Gt(10))
      .WillOnce(Return(20));

  EXPECT_EQ(mock.Bar(5), 10);  // Matches EXPECT_CALL
  EXPECT_EQ(mock.Bar(5), 10);  // Matches EXPECT_CALL
  EXPECT_EQ(mock.Bar(15), 20); // Matches EXPECT_CALL with .With
  EXPECT_EQ(mock.Bar(2), 0);   // Default ON_CALL
}
```

---