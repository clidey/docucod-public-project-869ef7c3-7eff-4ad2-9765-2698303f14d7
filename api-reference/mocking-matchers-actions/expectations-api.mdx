---
title: "Expectations and Call Specification"
description: "Details APIs for defining call expectations using EXPECT_CALL and ON_CALL, setting cardinalities, sequencing, return values, and call constraints. Includes tips for avoiding common pitfalls and building robust, intention-revealing tests."
---

# Expectations and Call Specification

This page details the APIs provided by GoogleMock for defining call expectations on mock objects, specifically through the `EXPECT_CALL` and `ON_CALL` macros. It covers how to specify cardinalities, sequence constraints, return behaviors, and call ordering, enabling precise control over mock behavior and interaction validation. The documentation also highlights best practices and common pitfalls for writing robust and intention-revealing tests.

---

## Overview

At the heart of GoogleMock's powerful mocking capabilities are two macros that let you specify how mock methods should behave and what calls you expect them to receive:

- `EXPECT_CALL`: Defines explicit expectations on method calls, including how many times the calls occur, with which arguments, and any sequence constraints.

- `ON_CALL`: Defines default behaviors for mock methods without imposing expectations about how often or whether they must be called.

Together, these macros allow granular control over interactions in your tests.


## Core Macros

### MOCK_METHOD

Before using `EXPECT_CALL` and `ON_CALL`, mock methods are declared in a mock class using the `MOCK_METHOD` macro.

```cpp
class MyMock {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
};
```

- The first three parameters are the return type, method name, and argument list.
- The optional fourth parameter is a comma-separated list of qualifiers like `const`, `override`, `noexcept`, etc.

**Important:**

- When mocking methods with argument or return types involving commas (e.g., templates like `std::pair` or `std::map`), wrap the part with commas in parentheses or use a type alias to avoid parsing errors.
- All mock methods must be declared in the `public` section even if the original method was protected or private.

### EXPECT_CALL

Syntax to set an expectation on a mock method call:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .Times(cardinality)
    .InSequence(sequences...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

- The `matchers...` specify constraints for each argument.
- The `.With()` clause further restricts via a multi-argument matcher.
- `.Times()` specifies how many times to expect the call.
- `.InSequence()` enforces ordering within one or more sequences.
- `.After()` enforces partial ordering dependent on other expectations.
- `.WillOnce()` specifies actions for individual calls.
- `.WillRepeatedly()` specifies an action for all further calls.
- `.RetiresOnSaturation()` causes the expectation to become inactive after reaching its cardinality.

All clauses are optional (some have usage restrictions).

### ON_CALL

Syntax to define the default behavior of a mock method without setting a call expectation:

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .WillByDefault(action);
```

- Must end with `.WillByDefault()`.
- Does not set an expectation; the mock method may or may not be called.
- Can be used to establish fallback behaviors distinct from expectations.


## Detailed Clauses

### With

- Restricts expectations or default behaviors to calls whose entire argument tuple matches a multi-argument matcher.
- Must be the first clause following `EXPECT_CALL` or `ON_CALL`, and can appear at most once.

Example:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // Expects first arg < second arg
```

### Times

- Defines the expected number of calls to a mock method.
- Predefined cardinalities include:
  - `AnyNumber()` — unlimited calls allowed
  - `AtLeast(n)` / `AtMost(n)` — minimum or maximum calls
  - `Between(m, n)` — range inclusive
  - `Exactly(n)` or `n` — exactly n calls

If omitted, GoogleMock infers cardinality based on presence of `WillOnce` and `WillRepeatedly` clauses.

Example:

```cpp
EXPECT_CALL(mock, DoSomething()).Times(3);
```

### InSequence

- Specifies sequence(s) that this expectation belongs to.
- Calls to expectations in the same sequence must occur strictly in the order declared.
- Can belong to multiple sequences.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Reset()).InSequence(s1, s2);
EXPECT_CALL(mock, GetSize()).InSequence(s1);
EXPECT_CALL(mock, Describe()).InSequence(s2);
```

### After

- Specifies partial ordering between expectations.
- This expectation can only be matched after all specified expectations or expectation sets have been satisfied.
- Can accept up to 5 expectations or expectation sets.

Example:

```cpp
Expectation init_x = EXPECT_CALL(mock, InitX());
Expectation init_y = EXPECT_CALL(mock, InitY());
EXPECT_CALL(mock, Describe()).After(init_x, init_y);
```

### WillOnce

- Defines the action to perform on the *next* matching call.
- Supports specifying multiple `WillOnce` clauses sequentially.

Example:

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));
```

### WillRepeatedly

- Defines the action to perform on all subsequent matching calls after all `WillOnce` actions have been used.
- Only one `WillRepeatedly` allowed.

Example:

```cpp
EXPECT_CALL(mock, GetName())
    .WillRepeatedly(Return("John Doe"));
```

### RetiresOnSaturation

- The expectation retires (becomes inactive) immediately once it reaches its call limit.
- Useful to prevent unexpected calls to a saturated expectation.

Example:

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
```


## Classes for Call Ordering and Expectation Grouping

- `Sequence`: Used to create a named sequence to group ordered expectations.
- `InSequence`: RAII helper that puts all `EXPECT_CALL`s within its scope into an anonymous sequence.
- `Expectation`: Handle representing a single expectation, useful for `After()` clauses.
- `ExpectationSet`: Handle representing a set of expectations, useful for partial ordering.


## Best Practices

- Always place `MOCK_METHOD` declarations in the `public:` section of mock classes.
- Use `ON_CALL` to set default behaviors without constraints; use `EXPECT_CALL` to verify that calls happen.
- Use `Times()` only when you want to strictly check the number of calls.
- Use sequences and `After()` to express call ordering and dependencies.
- Prefer `RetiresOnSaturation()` for expectations that should be inactive after their call count is fulfilled.
- Avoid overly strict expectations to keep tests resilient to refactoring.


## Common Pitfalls

- Omitting `EXPECT_CALL`s while calling mock methods triggers uninteresting call warnings.
- Using `EXPECT_CALL` with argument matchers and forgetting runtime code calls leads to unexpected call failures.
- Call order errors occur when sequence constraints are violated.
- Exceeding expected call counts triggers excessive call failures.
- Setting multiple `With()` or `WillRepeatedly()` clauses per expectation is illegal.


## Examples

### Setting a Default Action with ON_CALL

```cpp
using ::testing::Return;

MockFoo foo;
ON_CALL(foo, GetSize())
    .WillByDefault(Return(5));
```

### Setting Expectations with EXPECT_CALL

```cpp
using ::testing::_;
using ::testing::AtLeast;
using ::testing::Return;

EXPECT_CALL(foo, UpdateData(_, 42))
    .Times(AtLeast(1))
    .WillRepeatedly(Return(true));

// The method UpdateData is expected to be called at least once
// with any first argument and 42 as the second argument, returning true.
```

### Using Sequences

```cpp
using ::testing::InSequence;

{
  InSequence s;

  EXPECT_CALL(foo, Open());
  EXPECT_CALL(foo, Write(_));
  EXPECT_CALL(foo, Close());
}
// Ensures calls happen in the order: Open(), Write(), Close()
```

### Ordering with After

```cpp
auto e1 = EXPECT_CALL(foo, Init());
EXPECT_CALL(foo, Start()).After(e1);
```

### Retiring an Expectation Automatically

```cpp
EXPECT_CALL(foo, SendMessage("Hi"))
    .Times(1)
    .RetiresOnSaturation();
```

---

## Troubleshooting

- **Uninteresting Call Warnings**: If your mock method is called without an `EXPECT_CALL`, you get warnings unless you use a `NiceMock` or add `EXPECT_CALL(...).Times(AnyNumber())`.

- **Upper Bound Violations**: If a method is called more than expected, GoogleMock reports excessive call errors. Use `RetiresOnSaturation()` or properly specify `Times()` and `WillRepeatedly()` to address this.

- **Ordering Issues**: Use sequences or `After()` properly to avoid order-related failures.

- **Ambiguous Overloads**: If `ON_CALL` or `EXPECT_CALL` fails with ambiguous method errors, specify argument matchers explicitly or disambiguate with `Const()` or type casts.

- **Default Values for Return Types**: If your mock method has a return type without a default returned value, GoogleMock may fail at runtime unless you set a default using `DefaultValue<T>` or provide `ON_CALL` handlers.

---

## Additional Resources

- [Mocking Reference](../docs/reference/mocking.md): Comprehensive details on mocking mechanics including `MOCK_METHOD`, `EXPECT_CALL`, and `ON_CALL`.
- [GoogleMock for Dummies](../docs/gmock_for_dummies.md): A beginner's guide to grasp mocking basics in GoogleMock.
- [gMock Cookbook](../docs/gmock_cook_book.md): Practical recipes and examples for advanced mock usage.
- [Matchers Reference](matchers.md): Explore built-in and custom matchers for argument specifications.
- [Actions Reference](actions.md): Learn all actions that can be specified in `.WillOnce()`, `.WillRepeatedly()`, and `.WillByDefault()`.
- [GoogleTest Assertions API](../api-reference/testing-apis/assertions-api.md): For combining matchers with assertions.

---

## Summary
This page equips you to define precise call expectations on mock methods with `EXPECT_CALL` and default behaviors with `ON_CALL`, capture call order with sequences, and specify return behaviors, including once-only and repeated actions. By mastering these APIs, you can create expressive and maintainable tests that validate expected interactions rigorously while avoiding brittleness.

<Check>
  - Always specify explicit expectations only where necessary — rely on `ON_CALL` for default behaviors.
  - Use `RetiresOnSaturation()` to avoid sticky expectations causing call order conflicts.
  - Pay attention to call ordering demands in your tests by using sequences and `After()`.
  - Handle overloaded methods carefully with explicit argument lists or `Const()`.
  - Suppress uninteresting call warnings with `NiceMock` or `EXPECT_CALL(...).Times(AnyNumber())` if you prefer.
</Check>

---

## Mermaid Diagram: Expectations and Call Flow
```mermaid
sequenceDiagram
  participant TestCode
  participant MockMethod
  participant Expectation

  TestCode->>MockMethod: Call(args)
  MockMethod->>Expectation: FindMatchingExpectation(args)
  alt Match Found
    Expectation-->>MockMethod: Selected Expectation
    MockMethod->>Expectation: Check call count and constraints
    alt Within Cardinality
      Expectation-->>MockMethod: Perform WillOnce or WillRepeatedly.
      MockMethod->>TestCode: Return action result
      Expectation->>Expectation: Update call count
      Expectation->>Expectation: Retire if saturated (if RetiresOnSaturation())
    else Over-saturated
      Expectation-->>MockMethod: Warning/Error; return default result
    end
  else No Match Found
    MockMethod-->>TestCode: Uninteresting or Unexpected Call Warning/Error
  end
```

---