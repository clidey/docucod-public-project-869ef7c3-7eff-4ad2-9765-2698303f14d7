---
title: "Actions and Return Behaviors"
description: "Reference for the available actions controlling mock behavior (returning values, setting arguments, throwing exceptions), including action templates and user-defined actions. Includes usage patterns for variadic and default actions."
---

# Actions and Return Behaviors

This reference details the actions that control mock behavior in GoogleMock. Actions define what a mock function should do when invoked, such as returning values, setting arguments, or throwing exceptions. All actions are part of the `::testing` namespace.

---

## Returning Values

Actions that specify the return behavior of mock functions:

| Action                 | Description                                                                                                           |
|------------------------|-----------------------------------------------------------------------------------------------------------------------|
| `Return()`             | Returns from a `void` mock function.                                                                                   |
| `Return(value)`        | Returns `value`, converting it to the mock function's return type at the time the expectation is set (not at execution).
| `ReturnArg<N>()`       | Returns the N-th (0-based) argument passed to the mock function.                                                       |
| `ReturnNew<T>(a1, ..., ak)` | Returns a newly created object with `new T(a1, ..., ak)`; a fresh object is created for each call.                     |
| `ReturnNull()`         | Returns a null pointer.                                                                                                |
| `ReturnPointee(ptr)`   | Returns the value pointed to by `ptr` at the time of the action execution.                                             |
| `ReturnRef(variable)`  | Returns a reference to the specified `variable`.                                                                      |
| `ReturnRefOfCopy(value)` | Returns a reference to a copy of `value`. The copy remains alive as long as the action exists.                         |
| `ReturnRoundRobin({a1, ..., ak})` | Each call returns the next element in the list, looping back to the start after the last element.                 |

### Example: Returning Different Values Across Calls

```cpp
using ::testing::Return;

EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));

// Calls will return 1, then 2, then 3 for subsequent calls
```

---

## Side Effect Actions

Actions that perform side effects on arguments or other state:

| Action                   | Description                                                           |
|--------------------------|-----------------------------------------------------------------------|
| `Assign(&variable, value)` | Assigns `value` to the variable pointed by `&variable`.               |
| `DeleteArg<N>()`          | Deletes the N-th argument, which must be a pointer.                    |
| `SaveArg<N>(pointer)`     | Saves the value of the N-th argument to `*pointer` by copy-assignment. |
| `SaveArgByMove<N>(pointer)` | Saves the N-th argument to `*pointer` by move-assignment.              |
| `SaveArgPointee<N>(pointer)` | Saves the value pointed to by the N-th argument to `*pointer`.        |
| `SetArgReferee<N>(value)` | Assigns `value` to the variable referenced by the N-th argument.       |
| `SetArgPointee<N>(value)` | Assigns `value` to the variable pointed to by the N-th argument.
|
| `SetArgumentPointee<N>(value)` | Alias for `SetArgPointee<N>(value)` (deprecated, will be removed in v1.7.0). |
| `SetArrayArgument<N>(first, last)` | Copies elements from the range `[first, last)` into the array pointed to by the N-th argument. |
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value`.                        |
| `Throw(exception)`        | Throws the specified exception object (must be copyable). Requires exceptions support.

### Example: Setting an Output Argument

```cpp
using ::testing::SetArgPointee;

EXPECT_CALL(mock, Mutate(_))
    .WillOnce(SetArgPointee<0>(42));

// When Mutate is called, it will set argument 0's pointee to 42
```

---

## Using Callables as Actions

You can specify a function, functor, or lambda as the action to perform:

| Action                           | Description                                                                                         |
|---------------------------------|---------------------------------------------------------------------------------------------------|
| `f`                             | Invokes the callable `f` with the mock function's arguments directly.                             |
| `Invoke(f)`                     | Invokes a global/static function or functor `f` with the mock function's arguments.              |
| `Invoke(object_pointer, &class::method)` | Invokes the specified method on the given object pointer with mock function arguments.        |
| `InvokeWithoutArgs(f)`          | Invokes `f` which must take no arguments.                                                         |
| `InvokeWithoutArgs(object_pointer, &class::method)` | Invokes the no-argument method on the object pointer.                                     |
| `InvokeArgument<N>(arg1, arg2, ..., argk)` | Invokes the N-th argument (which must be callable) with the specified arguments.

### Usage Notes

- You can declare unused parameters as `Unused` to clean up callable signatures.
- Ownership of callbacks passed to `Invoke` or `InvokeWithoutArgs` is taken by the action.
- To pass arguments by reference to `InvokeArgument`, wrap them with `std::ref()`.

### Example: Using a Lambda as an Action

```cpp
EXPECT_CALL(mock, Process(_, _))
    .WillOnce([](int x, int y) { return x + y; });
```

---

## Default Actions

| Action        | Description                                                                             |
|---------------|-----------------------------------------------------------------------------------------|
| `DoDefault()` | Invokes the mock function's default action, either the built-in default or one set by `ON_CALL()`.

**Important:** `DoDefault()` cannot be used inside composite actions; it will cause runtime errors.

---

## Composite Actions

Composite actions allow combining multiple actions into one:

| Action                                | Description                                                                                              |
|--------------------------------------|----------------------------------------------------------------------------------------------------------|
| `DoAll(a1, a2, ..., an)`              | Executes all actions `a1` through `an` sequentially on each call, returning the result of `an`. The first `n-1` actions must return void.
|
| `IgnoreResult(a)`                     | Performs action `a` and ignores its result (useful if `a` returns non-void but the mock method returns void).
|
| `WithArg<N>(a)`                      | Passes argument N to action `a` and performs it.
|
| `WithArgs<N1, N2, ..., Nk>(a)`       | Passes the selected arguments to action `a` and performs it.
|
| `WithoutArgs(a)`                     | Performs action `a` without passing any arguments.

### Example: Combining Side Effects and Return Values

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

This sets the output argument and returns `true`.

---

## Defining Custom Actions

You can define custom actions using macros or functors:

| Macro                           | Description                                                                                       |
|--------------------------------|---------------------------------------------------------------------------------------------------|
| `ACTION(Name) { ... }`          | Defines a parameterless action named `Name`.
|
| `ACTION_P(Name, param) { ... }` | Defines an action that takes one parameter.
|
| `ACTION_Pk(Name, p1, ..., pk) { ... }` | Defines parameterized actions with multiple parameters.

Inside these macros, you can access mock function arguments as `arg0`, `arg1`, etc., and their types as `arg0_type`, `arg1_type`, etc. You can also access the full argument tuple as `args`.

### Example: Custom Action Summing Two Arguments

```cpp
ACTION(Sum) { return arg0 + arg1; }

EXPECT_CALL(mock, Add(_, _))
    .WillOnce(Sum());
```

**Note:** `ACTION*` macros must be defined in namespace scope and cannot be declared inside functions or classes.

---

# Practical Tips

- Use `ON_CALL()` to set default behaviors without setting expectations.
- Use `EXPECT_CALL()` for setting expectations and behaviors, including return values and call counts.
- Chain `WillOnce()` and `WillRepeatedly()` to specify sequential and repeated behaviors.
- Wrap unwanted action results with `IgnoreResult()` when needed.
- Use `DoAll()` to combine side effects and return values.
- Use `Invoke()` and related methods to delegate to real functions, functors, or lambdas.
- For actions that return a reference or the current value of a variable, use `ReturnRef()` or `ReturnPointee()` to avoid returning stale copies.
- Use `RetiresOnSaturation()` to make expectations retire automatically when fully matched.

---

# Troubleshooting Common Issues

- **Run-time errors using `DoDefault()` inside composite actions:** Avoid `DoDefault()` inside `DoAll()` or similar composites.
- **Unexpected type conversion errors:** Ensure that `Return(value)` is used correctly, remembering it copies value at expectation time, not invocation time.
- **Side effects not taking effect when combined with returns:** Use `DoAll()` to chain `SetArgPointee()` with a return action.
- **Callable argument types not matching:** Use `Unused` parameters or `WithArgs<>` to adapt callable signatures.

---

For comprehensive examples, consult the [gMock Cookbook](../gmock_cook_book.md) and related documentation on [Mocking Reference](mocking.md) and [Expectations API](expectations-api.md).