---
title: "Framework Portability and Internal Utilities"
description: "Describes macros, utilities, and hooks that enable GoogleTest and GoogleMock to operate across platforms, compilers, and C++ standards. Highlights customization points and environment-specific configurations."
---

# Framework Portability and Internal Utilities

This documentation describes the internal macros, utilities, and hooks that enable **GoogleTest** and **GoogleMock** to operate seamlessly across various platforms, compilers, and C++ standards. It highlights customization points that allow users to tailor the framework’s behavior and environment-specific configurations critical for ensuring portability and flexibility.

---

## Portability and Customization Overview

GoogleTest and GoogleMock are designed to be portable across a wide range of operating systems, compilers, and C++ environments. To achieve this, the framework includes several internal utilities and macros that detect platform properties, handle threading and synchronization, and provide consistent behavior regardless of the underlying system.

The framework exposes specific injection points for customization, allowing users or integrators to override default behaviors where necessary. This is especially important for adapting to environment-specific needs, such as alternative threading implementations, logging facilities, or stack trace gathering.

---

## Key Components

### 1. Platform and Environment Detection Macros

GoogleTest internally defines macros to detect the operating system and platform capabilities, enabling platform-specific code paths in a clean and maintainable way.

- Examples include macros like `GTEST_OS_WINDOWS`, `GTEST_OS_LINUX`, `GTEST_OS_MAC`, as well as finer grain distinctions such as `GTEST_OS_WINDOWS_DESKTOP`, `GTEST_OS_IOS`, or embedded system macros like `GTEST_OS_ESP32`.
- These macros allow conditional compilation and feature enabling/disabling depending on the target environment.
- Users typically do not need to define these manually; the framework auto-detects these, but custom overrides are possible.

### 2. Threading and Synchronization Primitives

Given the importance of thread safety for parallel test execution, GoogleTest implements abstractions for mutexes, locks, and thread-local storage.

- **Mutex and Lock**: Thread synchronization using `Mutex`, `MutexLock` classes, with static mutex support using macros such as `GTEST_DECLARE_STATIC_MUTEX_` and `GTEST_DEFINE_STATIC_MUTEX_`.
- **Thread Local Storage**: `ThreadLocal<T>` template provides thread-local storage, tailored per platform.
- The framework adapts by checking for pthread availability or Windows threading APIs.
- If threading is not supported, dummy implementations ensure compilability without thread safety guarantees.

### 3. Logging and Assertion Utilities

The framework includes macros and classes for platform-independent logging and assertion checks.

- `GTEST_LOG_(severity)` provides logging with severity levels such as INFO, WARNING, ERROR, and FATAL.
- `GTEST_CHECK_(condition)` asserts conditions fatal to program continuation.
- These macros abstract differences in platform APIs and offer extensibility via custom definitions.

### 4. Command Line Flags Support

GoogleMock builds on the flag system used by GoogleTest but also supports advanced flags management:

- Flags can be declared and defined via macros like `GMOCK_DECLARE_bool_()`, `GMOCK_DEFINE_bool_()`, and accessed or set via `GMOCK_FLAG_GET()` and `GMOCK_FLAG_SET()`.
- When Abseil (Absl) is integrated into the environment, the framework uses Absl’s flag APIs transparently.
- Otherwise, internal implementations provide flag handling, ensuring consistent access across build configurations.

### 5. Customization Injection Points

GoogleTest and GoogleMock provide specific header files and macros to allow users to insert custom behaviors or override default implementations.

- `custom/gtest-port.h` and `custom/gmock-port.h` allow defining macros and functions that alter logging, threading, exception handling, API exporting, and other platform-specific aspects.
- Example customization macros include:
  - Logging overrides: `GTEST_LOG_()`, `GTEST_CHECK_()`, with user-supplied `LogToStderr()` and `FlushInfoLog()`.
  - Threading support flags like `GTEST_HAS_NOTIFICATION_` or `GTEST_HAS_MUTEX_AND_THREAD_LOCAL_`.
  - Stack trace getter override: `GTEST_OS_STACK_TRACE_GETTER_`.
  - Temporary directory function override: `GTEST_CUSTOM_TEMPDIR_FUNCTION_`.
- For flags defined in GoogleMock, customization is achieved through macros such as `GMOCK_DEFINE_bool_()`, with expansion to Abseil flags if available.

---

## Using and Extending Framework Portability and Internal Utilities

This section guides you through practical use and customization scenarios for maximizing portability and tailored behavior.

### Step 1: Understand Platform Macros

Be aware of macros that detect your build environment. You can inspect or override these in your build system if specialized behavior is needed.

```cpp
#ifdef GTEST_OS_WINDOWS
// Code compiled only for Windows platforms
#endif
```

### Step 2: Define Custom Macros in `custom/gtest-port.h` or `custom/gmock-port.h`

If you want to adapt logging or threading behavior, create or modify these custom headers. For example, to redefine logging:

```cpp
#define GTEST_LOG_(severity) CustomLogger::Log(severity, __FILE__, __LINE__)
void LogToStderr();
void FlushInfoLog();
```

### Step 3: Use Flag Macros for Configuration

Define and declare your configuration flags with provided macros. For instance, in GoogleMock:

```cpp
GMOCK_DEFINE_bool_(verbose_mode, false, "Enable verbose logging");
if (GMOCK_FLAG_GET(verbose_mode)) { /* verbose behavior */ }
```

### Step 4: Rely on Thread Safety Primitives

When writing platform-agnostic tests or extensions, use the internal Mutex and ThreadLocal templates. For example:

```cpp
#include "gtest/internal/gtest-port.h"

testing::internal::Mutex mutex;
{
  testing::internal::MutexLock lock(&mutex);
  // Critical section
}

thread_local int local_value = 0;
```


---

## Practical Tips and Best Practices

- **Do not redefine platform macros unless absolutely necessary**, as incorrect settings may break internal assumptions.
- **Leverage custom configuration points to adapt the framework** without modifying core source files, maintaining easier upgrades and custom builds.
- **Ensure your environment supports C++17 or higher**, as the utilities rely on modern standards.
- When integrating with third-party flag libraries like Abseil, prefer enabling their support to gain advanced flag capabilities.
- Use the provided mutex and thread-safe utilities when working in multi-threaded test scenarios to avoid race conditions.
- Regularly consult the internal macros for thread safety and platform configurations in case of build or runtime failures.

---

## Common Troubleshooting

### Problem: Tests fail to compile due to missing platform macro definitions.
- **Solution**: Confirm your build environment defines macros correctly; for uncommon platforms, define the relevant macros manually or configure the build system accordingly.

### Problem: Logging functions are not behaving as expected or are too verbose.
- **Solution**: Override logging macros via `custom/gtest-port.h` or control verbosity via flags.

### Problem: Multithreaded tests are unstable or show race conditions.
- **Solution**: Confirm that threading is enabled; verify `GTEST_IS_THREADSAFE` macro is defined and use the provided `Mutex`, `MutexLock` utilities.

### Problem: Flags are not recognized or set properly.
- **Solution**: In GoogleMock, check whether Abseil flags are enabled and properly linked; otherwise, investigate the macro definitions for flag declaration and access.

---

## References and Further Reading

- [GoogleTest Portability Header (`gtest-port.h`)](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-port.h)
- [GoogleMock Portability Header (`gmock-port.h`)](https://github.com/google/googletest/blob/main/googlemock/include/gmock/internal/gmock-port.h)
- [Customization Points - `custom` directory README](https://github.com/google/googletest/blob/main/googlemock/include/gmock/internal/custom/README.md)
- [Build and Integration Utilities (CMake)](https://github.com/google/googletest/blob/main/googletest/cmake/internal_utils.cmake)
- [Supported Platforms Overview](https://github.com/google/googletest/blob/main/docs/platforms.md)
- [GoogleTest Primer and Core Concepts](https://github.com/google/googletest/blob/main/docs/primer.md)

---

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googletest/include/gtest/internal/gtest-port.h", "range": "1-599"},{"path": "googlemock/include/gmock/internal/gmock-port.h", "range": "1-115"},{"path": "googlemock/include/gmock/internal/custom/README.md", "range": "1-20"},{"path": "googletest/include/gtest/internal/custom/README.md", "range": "1-40"},{"path": "googletest/cmake/internal_utils.cmake", "range": "1-162"}]} />
