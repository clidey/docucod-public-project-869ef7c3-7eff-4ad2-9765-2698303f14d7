---
title: "Call Expectations and Invocations"
description: "Describes how to specify expectations, such as ON_CALL and EXPECT_CALL macros, for mock methods. Includes explanations of argument matching, call counts, ordering, and default actions—key for precise behavioral testing."
---

# Call Expectations and Invocations

This page describes how to specify call expectations for mock methods using the `EXPECT_CALL` and `ON_CALL` macros in GoogleMock. This is fundamental for precise behavioral testing, enabling you to define *when* and *how* mock methods are called, what arguments they receive, their call counts, call order, and what actions to perform.

---

## Overview of Call Expectations

When working with mock methods, you as the test author want to control two aspects:

- The _default behavior_ of a mock method when it is called without an explicit expectation.
- The _expected calls_ to a mock method, detailing how many times and in what order they occur, and what the mock should do each time.

GoogleMock provides two key macros for this:

- `ON_CALL(mock_object, Method(matchers...))` – specifies the default action for calls matching given argument matchers. It does **not** set an expectation on call counts.
- `EXPECT_CALL(mock_object, Method(matchers...))` – specifies an expected set of calls with optional cardinality, ordering, and action clauses.

### Typical Workflow For Using Call Expectations

<Steps>
<Step title="Create Mock Objects">
Define your mock class using `MOCK_METHOD` macros and instantiate mock objects.
</Step>
<Step title="Set Default Behaviors with ON_CALL">
Use `ON_CALL` to specify how a mock method behaves by default when called without specific expectations.
</Step>
<Step title="Specify Expected Calls with EXPECT_CALL">
Use `EXPECT_CALL` to declare the expected interactions: which methods will be called, how often, in what order, and what they return or do.
</Step>
<Step title="Exercise the Code Under Test">
Run your code that invokes these mock methods.
</Step>
<Step title="Verification Upon Mock Destruction">
GoogleMock automatically verifies that all expectations are satisfied when the mock objects are destroyed.
</Step>
</Steps>

## Using `ON_CALL` to Set Default Actions

### Purpose
`ON_CALL` specifies the *default* behavior of a mock method (for example, the default return value or action), without enforcing any constraints on the number or order of calls.

This is useful when a mock method is called but your test does not require strict verification of those calls.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher) // optional, at most once
    .WillByDefault(action);       // mandatory exactly once
```

- The arguments `matchers...` can be omitted if you want to match any arguments (only for non-overloaded methods).
- The `.With()` clause restricts matching to calls whose entire argument tuple matches the multi-argument matcher.
- `.WillByDefault()` sets the default action that is performed when the mock method is called without a matching `EXPECT_CALL`.

### Important Notes

- The `.WillByDefault()` clause **must appear exactly once** per `ON_CALL` statement.
- You cannot use `DoDefault()` as the action in `ON_CALL`.
- Multiple `ON_CALL` statements with overlapping matchers are allowed; the *last* matching one takes precedence.

### Example

```cpp
using ::testing::Return;
ON_CALL(my_mock, GetValue(_))
    .WillByDefault(Return(42));
```

In this example, calls to `my_mock.GetValue()` will return `42` unless overridden by an `EXPECT_CALL`.

## Using `EXPECT_CALL` to Set Call Expectations

### Purpose
`EXPECT_CALL` is used to precisely specify expected calls, including call counts, ordering dependencies, and behaviors.

This macro not only sets the mock method's behavior but also verifies that calls matching its argument matchers occur according to your expectations.

### Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)   // optional, at most once, must be first clause
    .Times(cardinality)            // optional, at most once, specifies expected call count
    .InSequence(sequences...)      // optional, any number of times, specifies partial ordering sequences
    .After(expectations...)        // optional, any number of times, specifies call dependencies
    .WillOnce(action)              // optional, any number of times, actions for individual calls
    .WillRepeatedly(action)        // optional, at most once, action for repeated calls
    .RetiresOnSaturation();        // optional, at most once, expectation retires after being saturated
```

- As with `ON_CALL`, argument matchers are optional for non-overloaded methods (meaning all arguments matched).
- All clauses are optional except that `.With()`, if present, must be the first and only once.
- Call cardinality controls how many calls are expected:
  - `Times(Exactly(n))` or `Times(n)` means exactly *n* calls.
  - `Times(AnyNumber())` means no limit.
  - Other cardinalities such as `AtLeast(n)`, `AtMost(n)`, `Between(m,n)` are available.
- Ordering constraints can be specified with `.InSequence` or `.After` clauses:
  - `.InSequence` places the expectation into one or more sequences, enforcing order.
  - `.After` declares that an expectation occurs after specified expectations.
- Actions define what to do for each matching call:
  - `.WillOnce()` specifies a list of actions for the first calls.
  - `.WillRepeatedly()` specifies the action for all calls after `WillOnce` actions are exhausted.
- `.RetiresOnSaturation()` causes the expectation to be inactive once its expected number of calls is reached, which affects which expectation matches further calls.

### Call Cardinality Inference

If `.Times()` is omitted, the cardinality is inferred automatically: 

- If neither `WillOnce` nor `WillRepeatedly` are specified, cardinality defaults to `Exactly(1)`.
- If *n* `WillOnce` clauses are specified but no `WillRepeatedly`, cardinality is `Exactly(n)`.
- If *n* `WillOnce` clauses and one `WillRepeatedly` clause are specified, cardinality is `AtLeast(n)`.

### Example

```cpp
using ::testing::Return;
using ::testing::Sequence;

Sequence s;
EXPECT_CALL(my_mock, ProcessData(_, _))
    .Times(3)
    .InSequence(s)
    .WillOnce(Return(true))
    .WillOnce(Return(false))
    .WillRepeatedly(Return(true));
```

Here, `ProcessData` is expected to be called exactly three times, in order (due to sequence). It returns `true` on the first call, `false` on the second, and `true` on the third and subsequent calls.

## Key Clauses Explained

### `.With(multi_argument_matcher)`

Used in both `ON_CALL` and `EXPECT_CALL` to match the entire argument tuple using a matcher on the tuple type (e.g., `Matcher<std::tuple<A1, ..., An>>`).

Use this to impose relationship constraints among multiple arguments.

Example:

```cpp
EXPECT_CALL(mock, Update(_, _))
    .With(Lt());  // expects that the first argument is less than the second
```

### `.Times(cardinality)`

Defines how many times the expectation applies. Note that 0 means the method should never be called. `Times` can be provided an integer or from cardinality helpers such as:

- `AnyNumber()`
- `AtLeast(n)`
- `AtMost(n)`
- `Between(m, n)`
- `Exactly(n)` (or simply `n`)

### `.InSequence(sequence...)`

Defines that the expectation belongs in one or more sequences. Calls must be made in the order of the sequence(s). Can be specified multiple times.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(a, Foo()).InSequence(s1, s2);
EXPECT_CALL(b, Bar()).InSequence(s1);
EXPECT_CALL(c, Baz()).InSequence(s2);
```

### `.After(expectation_or_expectation_set...)`

Specifies that this expectation can be satisfied only after one or more other expectations are satisfied, allowing creation of a partial ordering of calls.

Accepts up to five `Expectation` or `ExpectationSet` objects.

Example:

```cpp
Expectation e1 = EXPECT_CALL(mock, InitX());
ExpectationSet e2;
e2 += EXPECT_CALL(mock, InitY());
e2 += EXPECT_CALL(mock, InitZ());
EXPECT_CALL(mock, Use()).After(e1, e2);
```

### `.WillOnce(action)` and `.WillRepeatedly(action)`

Defines what the mock does when the call matches this expectation:

- `.WillOnce()` specifies the action for each matched call, in order.
- `.WillRepeatedly()` defines the fallback action after all `WillOnce` actions.

The action can be any built-in or user-defined [action](../actions.md), such as `Return()`, `Invoke()`, `SetArgPointee()`, or lambdas.

### `.RetiresOnSaturation()`

Causes the expectation to retire (become inactive) once the call count reaches the upper bound of the cardinality. This lets later expectations become active and match subsequent calls.

Useful when expectations are stacked, but should not remain active after their calls are exhausted.

## Call Matching and Precedence

- When a mock method is called, GoogleMock searches expectations in reverse order of declaration, picking the last active match. This allows more specific expectations declared later to override more general ones.
- Uninteresting calls (calls to mock methods with no matching expectation) invoke the default action from any matching `ON_CALL` or from built-in rules and may produce warnings or errors depending on mock strictness (`NiceMock`, `NaggyMock`, `StrictMock`).
- If an expectation is over-saturated (called more times than allowed), the call is allowed but the default action is performed, and a failure is reported.

## Managing Expectations Programmatically

- Use `Expectation` and `ExpectationSet` objects to express and manage call order dependencies with `.After()`.
- Use `Sequence` objects and the `InSequence()` clause or the `InSequence` RAII helper to enforce sequential call ordering.

## Troubleshooting Common Pitfalls

<AccordionGroup title="Common Issues with Call Expectations">
<Accordion title="Unexpected mock function calls">
An unexpected call occurs when a mock method is called with arguments that don't match any active `EXPECT_CALL` expectation. This causes test failures with detailed messages about attempted matches and argument mismatches.
</Accordion>
<Accordion title="Uninteresting calls and warnings">
By default, calls to mock methods with no matching `EXPECT_CALL` are "uninteresting" and allowed, but a warning is emitted. Use `NiceMock` to suppress such warnings, or `StrictMock` to treat them as failures.
</Accordion>
<Accordion title="Call count mismatches">
If a mock method is called fewer or more times than expected, GoogleMock reports errors. Use proper `.Times()` clauses, or allow `AnyNumber()` when call counts vary.
</Accordion>
<Accordion title="Ordering violations with `InSequence` and `After`">
If calls occur out of the expected order, GoogleMock reports errors indicating which expectation was violated.
</Accordion>
</AccordionGroup>

## Practical Tips and Best Practices

- Use `ON_CALL` to set common default behaviors globally for a mock object.
- Use `EXPECT_CALL` selectively to assert behaviors you want to verify.
- Avoid over-specifying expectations; uninteresting calls do not cause failures (unless using `StrictMock`).
- Combine `.WillOnce()` and `.WillRepeatedly()` to specify sequential and fallback behaviors.
- Use sequences and `.After()` to specify order only when it matters to avoid brittle tests.
- When mocking overloaded methods, specify argument matchers to disambiguate.
- Use `.RetiresOnSaturation()` to prevent expectations from remaining active after expected calls are made.

### Example: Setting a Call Expectation with Order and Default Behavior

```cpp
using ::testing::Return;
using ::testing::Sequence;
using ::testing::_;

Sequence s;
MockFoo mock;

ON_CALL(mock, Process(_))
    .WillByDefault(Return(false));  // Default behavior

EXPECT_CALL(mock, Process(42))
    .Times(2)
    .InSequence(s)
    .WillOnce(Return(true))
    .WillOnce(Return(false));

// Code exercising mock.Process(42) twice
```

In this example:

- Calls to `Process` with any argument will, by default, return `false`.
- The test expects exactly two calls to `Process(42)` in the sequence.
- The first call to `Process(42)` will return `true`, the second returns `false`.

---

## How Call Expectations Fit Into the GoogleMock Ecosystem

This page focuses on the critical aspect of call expectations and invocations within GoogleMock:

- It builds directly on mock method definitions from [`MOCK_METHOD`](reference/mocking.md#MOCK_METHOD).
- It is related to the broader concepts of matchers and actions detailed in [Matchers Library](api-reference/matchers-actions-utilities/matchers-api) and [Actions Library](api-reference/matchers-actions-utilities/actions-api).
- For organizing tests and lifecycle, see [Test Cases & Fixtures](api-reference/core-testing-api/test-case-framework).
- For high-level usage, see [gMock Cheat Sheet](docs/gmock_cheat_sheet.md) and the [gMock Cookbook](guides/real-world-testing/scenarios-patterns).

---

## References and Further Reading

- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md) — quick syntax and usage reference.
- [Mocking Reference](docs/reference/mocking.md) — detailed API and semantics.
- [gMock Cookbook](docs/gmock_cook_book.md#SettingExpectations) — practical recipes and advanced usage.
- [Matchers Reference](api-reference/matchers-actions-utilities/matchers-api) — argument matching.
- [Actions Reference](api-reference/matchers-actions-utilities/actions-api) — defining behaviors.

---

## Troubleshooting Common Issues

<AccordionGroup title="Troubleshooting Call Expectations">
<Accordion title="Unmatched Calls">
Ensure that every call you expect matches the argument matchers and ordering. Unexpected calls produce diagnostic messages explaining mismatches.
</Accordion>
<Accordion title="Wrong Number of Calls">
Verify your `.Times()` clauses and that call counts in tests satisfy expectations.
</Accordion>
<Accordion title="Overlapping Expectations Shadowed"
>
Remember that the last declared matching `EXPECT_CALL` takes precedence.
</Accordion>
</AccordionGroup>

---

## Summary of Macros

| Macro     | Purpose                                         |
|-----------|------------------------------------------------|
| `ON_CALL` | Define default behavior for matching calls, no expectation on call count. |
| `EXPECT_CALL` | Define expected calls, with detailed control on arguments, call counts, order, and behavior. |

---

### Code Example: Simple `ON_CALL` and `EXPECT_CALL`

```cpp
using ::testing::Return;
using ::testing::_;

MockFoo mock;

ON_CALL(mock, Foo(_))
    .WillByDefault(Return(-1));

EXPECT_CALL(mock, Foo(42))
    .Times(2)
    .WillOnce(Return(10))
    .WillOnce(Return(20));

// When called with 42, mock.Foo will return 10 then 20 (exactly two calls expected).
// When called with other arguments, it returns -1.
```
