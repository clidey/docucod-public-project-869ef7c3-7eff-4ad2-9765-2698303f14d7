---
title: "Death Tests"
description: "Explains the API for writing death tests—tests that verify code aborts or crashes as expected. Includes macros for defining death tests, options for matching death messages, and caveats for platform support."
---

# Death Tests

GoogleTest provides an API for writing *death tests* — special tests designed to verify that portions of your code terminate or abort as expected under certain conditions, such as triggering fatal errors or assertion failures. This feature ensures that your consistency checks and error handling code behave correctly by intentionally causing and detecting program terminations.

---

## Overview of Death Tests

Death tests execute a specific statement or code block in a separate process, capturing its exit status and output, to verify that it crashes or terminates as intended. Because the statement under test causes termination, death tests run this code isolated from the test runner process.

Death tests help you:

- Assert that critical preconditions cause program termination when violated.
- Confirm that unsafe usage scenarios fail fast and produce expected error messages.
- Safeguard program correctness by validating fatal error triggers.

> **Important:** Death tests detect *process terminations* rather than exceptions. Exceptions thrown do not count as death if they are caught by user code.


## Writing Death Tests

GoogleTest provides several macros to define death tests, with two main groups:

### ASSERT_DEATH and EXPECT_DEATH

- `ASSERT_DEATH(statement, matcher)`
- `EXPECT_DEATH(statement, matcher)`

These macros verify that `statement` terminates the program with a non-zero exit code, and writes to `stderr` a message matching `matcher`.

The `matcher` parameter is usually:
- A regular expression string, which GoogleTest interprets as an expected substring regex (not exact match).
- A matcher object (like those from GoogleMock) matching `const std::string&`.

Example usage:

```cpp
ASSERT_DEATH(MyFunctionThatShouldAbort(), "Error on invalid input");
EXPECT_DEATH({ DoSomethingDangerous(); }, "Fatal failure.*detected");
```

### ASSERT_EXIT and EXPECT_EXIT

For more fine-grained exit code verification, you can use:

- `ASSERT_EXIT(statement, predicate, matcher)`
- `EXPECT_EXIT(statement, predicate, matcher)`

Here:
- `predicate` is a callable or function object that accepts an `int` exit status and returns a `bool`. GoogleTest provides useful predefined predicates:

  - `::testing::ExitedWithCode(code)`: Verifies the process exited with exit code `code`.
  - `::testing::KilledBySignal(signal)`: Verifies the process was killed by a specific signal (POSIX only).

Example:

```cpp
ASSERT_EXIT(ExitNow(), ::testing::ExitedWithCode(0), "Success");
EXPECT_EXIT(RaiseSignal(SIGKILL), ::testing::KilledBySignal(SIGKILL), "Killed");
```

### EXPECT_DEATH_IF_SUPPORTED and ASSERT_DEATH_IF_SUPPORTED

These macros behave like `EXPECT_DEATH` and `ASSERT_DEATH`, but only run the death test if the platform supports death tests. On unsupported platforms, they issue warnings but do not fail.

---

## How Death Tests Work Internally

Death tests operate by:

1. Spawning a child process (using `fork()` and `exec()` on POSIX, or `CreateProcess()` on Windows).
2. Executing the `statement` separately in the child process.
3. Waiting for the child’s termination and checking its exit status and `stderr` output.
4. Matching the exit conditions and output against user expectations.

### Death Test Styles

GoogleTest supports two death test styles, controlled by the flag `--gtest_death_test_style` or programmatically via `GTEST_FLAG_SET(death_test_style, "style")`:

- `fast`: The child process runs the death test statement immediately after forking. This is faster but less thread-safe.
- `threadsafe`: The child process re-executes the entire test binary with special flags to run *only* the targeted death test. This style isolates tests better and helps avoid threading issues, at the cost of increased time due to re-execution.

Note: On Windows and Fuchsia, death tests are always thread-safe regardless of this flag.

### Common Flags

- `--gtest_death_test_style=[fast|threadsafe]`: Selects death test style (default is `fast` on most platforms).
- `--gtest_death_test_use_fork`: On POSIX platforms, forces use of `fork()` rather than `clone()` for death tests. Useful under tools like Valgrind.

---

## Important Considerations and Best Practices

### Failure Cases

A death test fails if:

- The statement does not cause process termination.
- The process exits with an unexpected status code.
- The error output to `stderr` does not match the expected regex or matcher.
- The statement executes a `return` (not allowed in the death test block).
- The statement throws an exception (exceptions caught by GoogleTest mark failure).

### Thread Safety

Because `fork()` is unsafe when multiple threads exist, GoogleTest:

- Warns if multiple threads are detected when running death tests.
- Recommends naming test suites containing death tests with the suffix `DeathTest` to run them before others.
- Uses `clone()` on Linux for safer forking when possible.

### Side Effects in Death Tests

Since death tests run in child processes, any side effects (e.g., memory releases) are not visible to the parent test process and may cause false memory leak reports. To avoid this:

- Avoid freeing shared resources inside death tests.
- Alternatively, disable heap checks or free resources in the parent.

### Multiple Death Tests on the Same Line

Not allowed due to macro implementation constraints.

### Invoking Death Tests in Loops

Supported and can help ensure consistent death behavior across multiple inputs.

### Streaming Messages

You can append custom failure messages to death test macros using the `<<` operator to get clearer diagnostics.

---

## Examples

### Simple EXPECT_DEATH

```cpp
TEST(FooDeathTest, CrashesOnInvalidInput) {
  EXPECT_DEATH(Foo("bad_input"), "Invalid input detected");
}
```

### ASSERT_EXIT with exit code verification

```cpp
TEST(MyDeathTest, ExitsWithZeroCode) {
  ASSERT_EXIT(MyCleanExitFunction(), testing::ExitedWithCode(0), "Exiting");
}
```

### Death test with compound statement

```cpp
EXPECT_DEATH({
  PrepareData();
  TriggerFatalError();
}, "Fatal error");
```

### Death test inside a loop

```cpp
for (int i = 0; i < 5; ++i) {
  EXPECT_DEATH(DoDangerousOperation(i), "Operation failed");
}
```

---

## Troubleshooting Common Death Test Issues

### 1. Death Test Fails to Detect Termination

- Ensure the code under test actually calls `exit()`, `abort()`, or causes a fatal error.
- Avoid `return` or exceptions escaping the test statement.

### 2. Regex Matching Failure

- Confirm error messages printed to `stderr` match the expected regex.
- Use simpler regex or matchers if multi-line or complex patterns fail.

### 3. Threading Issues

- Verify no extra threads remain alive when running death tests; rename suites with `DeathTest` suffix to run them first.
- Use the `threadsafe` death test style to mitigate threading risks.

### 4. Platform Specific Behavior

- On Windows, death tests always run in thread-safe style with child processes created via `CreateProcess()`.
- On POSIX systems, `fork()` and `clone()` vary by style and platform.

### 5. Heap Checker Warnings

- Avoid side effects on heap from within death tests, or disable heap checks.

---

## Internal Utilities

### InDeathTestChild()

Utility method returning `true` if the current process is a death test child process to tailor behaviors inside death tests (internal use only).

### Exit Status Predicates

- `ExitedWithCode(exit_code)`: Predicate to check for a normal exit with given code.
- `KilledBySignal(signum)`: Predicate to check if the process was killed by a given signal (POSIX only).

### DeathTest Class

Abstract class encapsulating death test logic with methods:

- `AssumeRole()`: Decides if test runs or monitors child.
- `Wait()`: Waits for child process exit.
- `Passed()`: Analyzes exit status and output.
- `Abort()`: Aborts death test child with reason.

Concrete subclasses implement OS-specific behavior.

---

## Summary

Death tests are crucial tools to ensure your code terminates correctly in fatal cases. GoogleTest's macros (`ASSERT_DEATH`, `EXPECT_DEATH`, `ASSERT_EXIT`, `EXPECT_EXIT`) provide expressive, robust ways to write these tests with built-in support for exit code validation and error output matching. Be mindful of platform specifics, thread safety, and possible side effects to write reliable, maintainable death tests.

---

## Further Reading

- [Assertions Reference - Death Assertions](reference/assertions.md#death)
- [Advanced Guide - Death Tests](advanced.md#death-tests)
- [GoogleTest Primer](primer.md)
- [Writing and Running Unit Tests](guides/core-workflows/writing-unit-tests.md)
- [Death Tests and Exception Handling](guides/advanced-testing-patterns/death-tests-and-exception-handling.md)

---

## Source
For complete source and implementation details refer to:

- [googletest/src/gtest-death-test.cc](https://github.com/google/googletest/blob/main/googletest/src/gtest-death-test.cc)
- [googletest/include/gtest/gtest-death-test.h](https://github.com/google/googletest/blob/main/googletest/include/gtest/gtest-death-test.h)
- [googletest/include/gtest/internal/gtest-death-test-internal.h](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-death-test-internal.h)
