---
title: "Assertions and Expectations"
description: "Comprehensive list and behavior description of assertion macros, including EXPECT_*, ASSERT_*, death test assertions, and custom assertion mechanisms. Documents failure semantics, fatal vs. non-fatal cases, and best practices for expressive test writing."
---

# Assertions and Expectations

This document comprehensively details the assertion macros and expectation constructs provided by GoogleTest and GoogleMock, which are essential tools to verify and validate the behavior of C++ code under test.

---

## Overview

In testing with GoogleTest, **assertions** are the primary means of verifying conditions within tests, generating diagnostics on success or failure. GoogleMock extends this with **expectations** to specify detailed behaviors and interactions with mock objects, enabling interaction-based testing.

This reference covers the full spectrum of macro assertions, including Boolean, binary comparison, string, floating-point, predicate, exception, and death test assertions. It also includes the expectations framework used for mocks, detailing how to set, combine, and verify expectations precisely.

---

## 1. Assertion Macros

GoogleTest provides a rich set of assertion macros to enable expressive, clear, and flexible test verifications.

### 1.1 Basic Assertions

- `EXPECT_TRUE(condition)`, `ASSERT_TRUE(condition)`: Verifies a condition is true.
- `EXPECT_FALSE(condition)`, `ASSERT_FALSE(condition)`: Verifies a condition is false.

These generate nonfatal (`EXPECT_`) or fatal (`ASSERT_`) failures.

### 1.2 Binary Comparisons

Assertions comparing two values using operators like `==`, `!=`, `<`, `<=`, `>`, `>=`.

| Macro          | Purpose                                |
|----------------|--------------------------------------|
| `EXPECT_EQ(a,b)` | Verifies `a == b`                    |
| `EXPECT_NE(a,b)` | Verifies `a != b`                    |
| `EXPECT_LT(a,b)` | Verifies `a < b`                     |
| `EXPECT_LE(a,b)` | Verifies `a <= b`                    |
| `EXPECT_GT(a,b)` | Verifies `a > b`                     |
| `EXPECT_GE(a,b)` | Verifies `a >= b`                    |

`ASSERT_` variants exist as well.

*Notes:*
- When comparing pointers, these verify pointer equality, not the contents.
- For string literals or C strings, prefer string-specific macros.

### 1.3 String Comparisons

For C strings, GoogleTest provides content-based comparison assertions:

- `EXPECT_STREQ(a, b)`: Check that *C strings* `a` and `b` have equal contents.
- `EXPECT_STRNE(a, b)`: Check that *C strings* `a` and `b` differ.
- `EXPECT_STRCASEEQ(a, b)`: Case-insensitive equality.
- `EXPECT_STRCASENE(a, b)`: Case-insensitive inequality.

### 1.4 Floating-Point Comparisons

To counter issues with exact equality of floating-point numbers, GoogleTest offers:

- `EXPECT_FLOAT_EQ(a, b)`: Asserts that single-precision floats `a` and `b` are nearly equal within 4 ULPs.
- `EXPECT_DOUBLE_EQ(a, b)`: Same for double precision.
- `EXPECT_NEAR(a, b, abs_error)`: Asserts the absolute difference between `a` and `b` is within `abs_error`.

### 1.5 Predicate Assertions

For testing complex predicates or custom logic:

- `EXPECT_PRED1(pred, val)`, ..., `EXPECT_PRED5(pred, val1, ..., val5)`: Verifies that `pred(val…)` returns `true`.
- `EXPECT_PRED_FORMAT*`: Allows predicate functions with custom assertion formatted messages.

These macros offer richer failure diagnostics compared to simple `EXPECT_TRUE`.

### 1.6 Explicit Success and Failure

- `SUCCEED()`: Explicitly marks a success in a test. Does not affect overall test outcome but can document expected progress.
- `FAIL()`: Generates a fatal failure to abort the current function.
- `ADD_FAILURE()`: Generates a nonfatal failure allowing the test to continue.

### 1.7 Exception Assertions

Assertions to verify exception throwing behavior (requires enabled C++ exceptions):

- `EXPECT_THROW(statement, exception_type)`: Asserts `statement` throws given exception.
- `EXPECT_ANY_THROW(statement)`: Asserts it throws any exception.
- `EXPECT_NO_THROW(statement)`: Asserts it does not throw.

### 1.8 Death Assertions

Verify that code causes the process to terminate:

- `EXPECT_DEATH(statement, matcher)`: Verifies the statement causes death with stderr matching `matcher`.
- Variants: `EXPECT_DEBUG_DEATH`, `EXPECT_DEATH_IF_SUPPORTED`, `EXPECT_EXIT` allow different scopes and predicates for death testing.

*Note:* Death tests execute test code in subprocesses, isolating failures.

---

## 2. Mock Expectations

GoogleMock extends GoogleTest with powerful mocking capabilities. **Expectations** specify how mock methods are expected to be called, verified against the actual calls.

### 2.1 `EXPECT_CALL` Macro

To set an expectation on a mock method call:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .Times(cardinality)
    .InSequence(sequences...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

- **`matchers...`**: Specify expected argument values or wildcards (`_`). Must match all arguments to apply.
- **Clauses** (all optional except `.WillOnce()` and `.WillRepeatedly()` usage):
  - `.With()`: A matcher on all the method arguments as a tuple.
  - `.Times()`: Cardinality of expected calls (exactly, at least, any number, etc.).
  - `.InSequence()`: Associates expectation with one or more `Sequence` objects to require order.
  - `.After()`: Requires this expectation to occur after listed expectations.
  - `.WillOnce()`: Defines the action to perform on each call, supports multiple chained calls with differing actions.
  - `.WillRepeatedly()`: Defines the persistent action after `WillOnce`s are exhausted.
  - `.RetiresOnSaturation()`: Expectation becomes inactive after its call count reaches upper bound.

*Notes:* Clauses must appear in this order, and `.With()` can only appear once at the start.

#### Example

```cpp
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This expects `GetX()` to be called five times, returning 100 then 150, and 200 thereafter.

### 2.2 `ON_CALL` Macro

`ON_CALL` sets the **default behavior** of mock methods but does *not* set any call expectation.

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .WillByDefault(action);
```

Useful to configure default behavior in mocks, especially for calls not explicitly `EXPECT_CALL`ed.

### 2.3 Matchers

Matchers describe which arguments will satisfy an expectation or default action. ` _ ` is the wildcard matcher matching any argument. Various built-in matchers exist such as `Eq()`, `Ge()`, `NotNull()`, and user-defined matchers can be created.

### 2.4 Cardinalities

Controls how many times a call is expected:

| Cardinality       | Meaning                          |
|-------------------|--------------------------------|
| `AnyNumber()`     | Call can occur any number       |
| `AtLeast(n)`      | Minimum `n` calls required      |
| `AtMost(n)`       | Maximum `n` calls allowed       |
| `Between(m, n)`   | Between `m` and `n` calls       |
| `Exactly(n)` or `n`| Exactly `n` calls (0 means forbidden) |

If omitted, GoogleMock infers cardinality from `.WillOnce()` and `.WillRepeatedly()` clauses.

### 2.5 Sequences and Ordering

- **`Sequence`** objects represent ordered chains of expectations.
- `.InSequence(seq1, seq2, ...)` associates expectations with sequences.
- **`InSequence`** RAII helper groups expectations in scope into one anonymous sequence.

Ordering via `.InSequence` or `.After` enables strict or partial ordering in expectation matching.

### 2.6 Expectation Handles

- `Expectation` and `ExpectationSet` allow specifying prerequisites for ordering via `.After()`.
- Useful for complex dependency ordering.

### 2.7 Retiring Expectations

- By default, expectations are *sticky*, staying active even after saturation, which may cause test failures if called too many times.
- Use `.RetiresOnSaturation()` to deactivate an expectation as soon as it saturates, allowing other expectations to take effect.

### 2.8 Uninteresting and Unexpected Calls

- **Uninteresting call:** A call to a mock method with *no* matching expectation exists.
- **Unexpected call:** A call to a method with expectations, but no expectation matches the arguments or sequencing requirements.

gMock's default behavior warns on uninteresting calls and errors on unexpected calls.
- Use `NiceMock` to suppress warnings on uninteresting calls.
- Use `StrictMock` to treat uninteresting calls as errors.

---

## 3. Best Practices and Tips

- **Order expectations sensibly:** More general expectations first, more specific later (newer `EXPECT_CALL`s override older ones).
- **Avoid over-specifying expectations:** Too strict expectations yield brittle tests.
- **Use `ON_CALL` to define default behaviors:** Keep expectations focused only on calls relevant to verifying behavior.
- **Sequence your calls carefully:** To test order constraints, combine sequences with `.InSequence` or `.After`.
- **Retire expectations to avoid sticky behavior issues:** Use `.RetiresOnSaturation()` whenever you want expectations to deactivate upon saturation.
- **Omit `Times()` when appropriate:** GoogleMock infers cardinalities based on `.WillOnce()` and `.WillRepeatedly()`.
- **Match arguments only as strictly as needed:** Wildcard `_` avoids brittle tests.

---

## 4. Examples

### 4.1 Basic EXPECT_CALL with default action

```cpp
EXPECT_CALL(mock, Foo(5));  // Expects Foo(5) once, returns default value.
mock.Foo(5);
```

### 4.2 Setting actions and cardinalities

```cpp
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));

for (int i = 0; i < 5; i++) {
  int x = turtle.GetX();  // Returns 100, 150, then 200 three times.
}
```

### 4.3 Using sequences to enforce order

```cpp
Sequence s;
EXPECT_CALL(mock, First()).InSequence(s);
EXPECT_CALL(mock, Second()).InSequence(s);

mock.First();    // Must be called before Second().
mock.Second();
```

### 4.4 Using `.After()` to specify partial order

```cpp
Expectation a = EXPECT_CALL(mock, Foo());
Expectation b = EXPECT_CALL(mock, Bar());
EXPECT_CALL(mock, Baz()).After(a, b);

mock.Foo();
mock.Bar();
mock.Baz();    // Only allowed after Foo and Bar.
```

### 4.5 Using `ON_CALL` to set default behavior

```cpp
ON_CALL(mock, GetName()).WillByDefault(Return("default"));
EXPECT_CALL(mock, GetName());  // Expects call but doesn't override behavior
EXPECT_EQ("default", mock.GetName());
```

### 4.6 Using `RetiresOnSaturation`

```cpp
EXPECT_CALL(mock, Foo(5))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, Foo(_))
    .Times(AnyNumber());

// The first two calls to Foo(5) match first expectation.
// Subsequent calls match the second.
```

---

## 5. Troubleshooting

### 5.1 Uninteresting call warnings

If you see warnings about calls that are uninteresting, verify if you:

- Intended to ignore calls? Then consider switching mock to `NiceMock` to suppress warnings.
- Wanted to enforce calls? Add an `EXPECT_CALL` for those.

### 5.2 Unexpected calls

Failures due to unexpected calls indicate mismatches in argument matchers or call ordering. Use `--gmock_verbose=info` to trace the matching process and understand which expectations failed to match calls.

### 5.3 Sticky expectations causing failures

When an expectation exceeds its call count but remains active, further matching calls cause an error. Use `.RetiresOnSaturation()` to prevent this or sequence expectations to retire old ones.

### 5.4 Too many or too few actions warnings

GoogleMock warns if an expectation’s number of `WillOnce()` and `WillRepeatedly()` actions doesn’t align with call cardinality. Make sure to provide an appropriate number of actions or suppress warnings appropriately.

---

## 6. Related Concepts and References

- [GoogleMock for Dummies - Overview and Basic Usage](../gmock_for_dummies.md)
- [Mocking Reference - MOCK_METHOD, EXPECT_CALL](../reference/mocking.md)
- [gMock Cookbook - Recipes for Common Usage Patterns](../gmock_cook_book.md)
- [Matchers Reference - Argument Matchers](../reference/matchers.md)
- [Actions Reference - Defining Behavior](../reference/actions.md)
- [Writing Effective Assertions](../guides/core-workflows/writing-assertions.md)

---

## 7. Summary

GoogleTest's assertion macros and GoogleMock’s expectation syntax empower developers to write expressive, reliable tests that verify both state and interactions. Leveraging macros like `EXPECT_CALL` and `ON_CALL`, users can precisely specify expected calls on mock objects with detailed control over arguments, call counts, order, and behavior. This ensures robust detection of incorrect usage or failures early.

---

<AccordionGroup title="Code Examples">
<Accordion title="Basic EXPECT_CALL with actions">
```cpp
EXPECT_CALL(mock_turtle, Forward(100))
    .Times(AtLeast(1))
    .WillOnce(Return(true))
    .WillRepeatedly(Return(false));
```
</Accordion>
<Accordion title="Ordered Calls with InSequence">
```cpp
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(mock, PenDown());
  EXPECT_CALL(mock, Forward(10));
  EXPECT_CALL(mock, PenUp());
}
```
</Accordion>
<Accordion title="Using .After() with Expectation">
```cpp
Expectation init_done = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Work())
    .After(init_done)
    .Times(1);
```
</Accordion>
<Accordion title="Setting Default Behaviour with ON_CALL">
```cpp
ON_CALL(mock, GetX())
    .WillByDefault(Return(5));
```
</Accordion>
<Accordion title="Suppressing Uninteresting Call Warnings with NiceMock">
```cpp
using ::testing::NiceMock;
NiceMock<MockTurtle> mock_turtle;
// no warnings will be printed for uninteresting calls
```
</Accordion>
</AccordionGroup>

---

## 8. C++ Macro Usage Notes

- `EXPECT_CALL` and `ON_CALL` are implemented as macros to capture source code location for diagnostics.
- For overloaded methods, specify arguments explicitly to disambiguate.
- If argument types contain commas, wrap them in parentheses or use type aliases.

---

## 9. Visualizing Expectation Flow (Mermaid Diagram)

```mermaid
flowchart TD
  Start([Test Start]) --> SetupExpectations["Set Expectations with EXPECT_CALL"]
  SetupExpectations --> RunTest["Run Test Code Using Mocks"]
  RunTest --> CallsDetected{"Calls Detected"}
  CallsDetected -->|Matches Expectation| HandleCall["Perform EXPECT_CALL Action"]
  CallsDetected -->|Matches ON_CALL Only| HandleDefault["Perform ON_CALL Default Action"]
  CallsDetected -->|Unexpected Call| ReportError["Report Unexpected Call Error"]
  HandleCall --> CheckSaturation{"Expectation Saturated?"}
  CheckSaturation -->|Yes| RetireExpectation["Retire Expectation If Configured"]
  CheckSaturation -->|No| Continue
  RetireExpectation --> Continue["Continue to Next Call"]
  HandleDefault --> Continue
  Continue --> EndTest["Test End: Verify Expectations"]
  EndTest --> VerifyResult{ "All Expectations Met?" }
  VerifyResult -->|Yes| TestPass([Test Pass])
  VerifyResult -->|No| TestFail([Test Fail])
```

---

Please refer to related sections in this documentation set to deepen understanding of mocking, assertions, and advanced usage.

<!-- End of Assertions and Expectations Documentation -->
