---
title: "Test Runner and Main Entry"
description: "Guidance for initializing and running tests using custom or provided main() entry points. Shows users how to configure test environments and invoke the test runner across different platforms."
---

# Test Runner and Main Entry

GoogleTest and GoogleMock provide flexible facilities to initialize and run tests across different environments, platforms, and build setups. This page guides you on how to correctly configure the `main()` entry function or use the provided default implementations for launching your tests. It also highlights best practices for environment setup and running tests, ensuring that your test suite executes reliably and reports accurate results.

---

## Overview

When using GoogleTest or GoogleMock, the common goal is to write tests that automatically register themselves and run within a test runner. The runner is typically invoked by calling `RUN_ALL_TESTS()`, which executes all registered tests and returns a status code indicating success or failure.

To run tests, the framework requires initializing test flags and parsing command-line arguments. This initialization is usually done by calling either `testing::InitGoogleTest()` for GoogleTest or `testing::InitGoogleMock()` for GoogleMock, the latter initializing GoogleTest as well.

Users can:

- Use the default `main()` entry point provided by the libraries,
- Write a custom `main()` function to add extra logic or configuration before running tests.

---

## Default `main()` Implementations

For convenience, GoogleTest and GoogleMock offer predefined `main()` functions:

- **GoogleTest's default main:** Provided by linking with the `gtest_main` library. It initializes GoogleTest and calls `RUN_ALL_TESTS()`.
- **GoogleMock's default main:** Provided by linking with the `gmock_main` library, which calls `testing::InitGoogleMock()` and `RUN_ALL_TESTS()`.

These default main functions allow users to avoid writing boilerplate code and start running tests immediately after writing them.

<Tip>
If you do not require custom setup or command-line processing, prefer linking with `gtest_main` or `gmock_main`. This reduces maintenance and ensures compatibility with future GoogleTest releases.
</Tip>

---

## Writing a Custom `main()` Function

If your project requires setting up resources, modifying test environments, or processing command-line arguments beyond what GoogleTest supports, define your own `main()` function following these guidelines:

### Step-by-Step:

<Steps>
<Step title="Include required headers">
Make sure to include `<gtest/gtest.h>` for GoogleTest and `<gmock/gmock.h>` for GoogleMock.
</Step>
<Step title="Initialize GoogleTest or GoogleMock">
Call `testing::InitGoogleTest(&argc, argv);` to parse GoogleTest flags.
Use `testing::InitGoogleMock(&argc, argv);` when using GoogleMock, which also initializes GoogleTest.
Make sure this call happens before accessing any GoogleTest constructs.
</Step>
<Step title="Run all tests">
Call `RUN_ALL_TESTS()` and return its result from `main()`. This ensures the process exit code reflects the test results.
</Step>
</Steps>

### Typical custom main example:

```cpp
#include "gtest/gtest.h"

int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);

  // Optional: custom initialization code here

  return RUN_ALL_TESTS();
}
```

With GoogleMock:

```cpp
#include "gmock/gmock.h"

int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);

  // Optional: custom initialization or flag handling

  return RUN_ALL_TESTS();
}
```

---

## Important Usage Notes

- **Return Value Must Not Be Ignored:** Always return the result of `RUN_ALL_TESTS()` from your `main()` function. The return code enables automated systems to detect test failures.

- **Call Initialization First:** Make sure `testing::InitGoogleTest()` or `testing::InitGoogleMock()` is called before invoking any tests to ensure flags are parsed correctly.

- **Call `RUN_ALL_TESTS()` Only Once:** Calling it multiple times can cause undefined behavior and interfere with advanced features like thread-safe death tests.

- **Command-Line Flags:** Both initialization functions consume and remove recognized test flags from the argument list, leaving unrecognized flags intact for your own parsing.

- **Platform Compatibility:** On Windows, `InitGoogleTest()` handles wide strings for `wmain` entry points. On embedded platforms, like ESP32 or Arduino, GoogleTest adapts to platform-specific entry patterns.

---

## Running Tests Across Platforms

GoogleTest supports an expansive range of platforms with some platform-specific considerations for test entry and execution:

| Platform Type          | Entry Point Usage                              | Initialization Function            |
|------------------------|-----------------------------------------------|----------------------------------|
| Desktop (Linux, macOS, Windows) | Use standard `main(int, char**)` function      | `InitGoogleTest(&argc, argv)` or `InitGoogleMock(&argc, argv)` |
| Embedded (ESP8266, ESP32, NRF52) | Use `setup()` and `loop()` functions instead   | `testing::InitGoogleMock()` in `setup()`, `RUN_ALL_TESTS()` in `loop()` |
| QuRT                   | Use main without argc/argv; call `InitGoogleTest()` without args | `InitGoogleTest()` with no arguments   |

### Example for Embedded (ESP32):

```cpp
void setup() {
  testing::InitGoogleMock(); // No args for embedded
}

void loop() {
  RUN_ALL_TESTS();
}
```

---

## Example Walkthrough

Suppose you want to add a custom resource initialization before running your tests, your `main()` would look like:

```cpp
#include "gtest/gtest.h"
#include <iostream>

int main(int argc, char** argv) {
  // Initialize GoogleTest command-line flags
  testing::InitGoogleTest(&argc, argv);

  // Custom initialization logic
  std::cout << "Setting up resources before testing..." << std::endl;
  SetupMyTestResources();

  // Run all registered tests
  int result = RUN_ALL_TESTS();

  // Clean up resources afterwards
  CleanupMyTestResources();

  return result;
}
```

This pattern ensures that you retain full control over the testing lifecycle without losing the advantages of GoogleTest's automated test discovery and execution.

---

## Practical Tips & Best Practices

- **Linking Choice:** Decide early if you want to use provided main libraries (`gtest_main`, `gmock_main`) or write custom mains. The former simplifies build and maintenance.

- **Flag Documentation:** Familiarize yourself with standard GoogleTest and GoogleMock command-line flags (e.g., `--gtest_filter`, `--gmock_verbose`) to leverage flexible test execution.

- **Avoid Duplicates:** Do not combine both a user-defined `main()` and linking with `gtest_main` or `gmock_main`. This will cause linker conflicts.

- **Return Codes:** Always check your test runner exit codes in CI pipelines to enforce test pass/failure policies.

- **Environment Setup:** Use GoogleTest's global test environment feature (deriving from `testing::Environment`) for setup/teardown shared across all tests rather than placing heavy code in `main()`.

---

## Troubleshooting

<AccordionGroup title="Common Issues in Test Runner Setup">
<Accordion title="Tests Not Running or Being Discovered">
Check that you call `testing::InitGoogleTest(&argc, argv)` or `testing::InitGoogleMock(&argc, argv)` before `RUN_ALL_TESTS()`. Tests won't register or run without this initialization.
</Accordion>
<Accordion title="Multiple `main()` Definitions">
Avoid linking with `gtest_main` or `gmock_main` if you define your own `main()` in your test executable. This leads to linker errors due to duplicate symbols.
</Accordion>
<Accordion title="Test Runner Returns Unexpected Status">
Verify that you return `RUN_ALL_TESTS()` result from `main()`. If you ignore it and always return 0, tools relying on the exit code will misinterpret test outcomes.
Also, enable verbose flags to see detailed failure reasons.
</Accordion>
<Accordion title="Failure to Parse Flags">
Check that `testing::InitGoogleTest()` is called early and that the argument list is not corrupted before passing it in. Some build setups or wrappers may alter or strip command-line arguments unexpectedly.
</Accordion>
</AccordionGroup>

---

## Internal Initialization Flow Diagram

```mermaid
flowchart TD
  Start([Start main()]) --> Init["Call InitGoogleMock(&argc, argv) \n(or InitGoogleTest(&argc, argv))"]
  Init --> ParseFlags["Parse and remove recognized flags"]
  ParseFlags --> SetupTests["Register tests and test fixtures"]
  SetupTests --> RunTests["Call RUN_ALL_TESTS()"]
  RunTests --> EvaluateResults{Tests Passed?}
  EvaluateResults -->|Yes| Exit0([Return 0])
  EvaluateResults -->|No| Exit1([Return non-zero])

  classDef initFill fill:#ddf,stroke:#339,stroke-width:1px;
  class Init,ParseFlags,SetupTests initFill;
```

---

## References

- [GoogleTest Primer](https://google.github.io/googletest/primer.html) — Introduction and basic usage including test writing and running.
- [Writing the main() Function](https://google.github.io/googletest/reference/testing.html#testing.InitGoogleTest) — Details on test initialization and entry point.
- [gmock_main Package Configuration](https://github.com/google/googletest/blob/main/googlemock/cmake/gmock_main.pc.in) — Build system info on linking `gmock_main`.
- [Cross-Platform Testing Guide](../../guides/advanced-and-integration-guides/cross-platform-testing.md) — Platform-specific considerations for test execution.

---

By understanding and implementing the test runner and main entry properly, you unlock seamless, reliable, and flexible execution of your automated C++ tests across diverse development environments and deployment platforms.
