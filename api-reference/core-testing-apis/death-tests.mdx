---
title: "Death Tests"
description: "Explains how to write and interpret death tests, which validate that code triggers specific process deaths. Describes macros, matching criteria, sandboxing, and best practices for testing error-handling and assertion failures."
---

# Death Tests

GoogleTest's death tests are a powerful feature that validate whether specific code triggers process termination as expected. These tests are vital for verifying error-handling paths, particularly assertion failures and fatal error conditions that kill the program.

This documentation will guide you through writing and interpreting death tests, describe the underlying macros, explain how to specify matching criteria for error messages, discuss sandboxing behavior, and provide best practices for robust error condition testing.

---

## Overview of Death Tests

Death tests assert that a certain statement causes the test process to terminate—either by `exit`, aborting, or being killed by a signal. 

This differs from ordinary assertions in that the entire process dies, rather than just signaling a test failure.

Death tests are important for:

- Validating error-handling code and `CHECK`/`ASSERT` macros that terminate execution
- Verifying that fatal conditions are caught early and the application does not silently continue in an inconsistent state

GoogleTest implements death tests by spawning a child process that runs the statement, then monitoring its exit status and standard error output for expected outcomes.

> **Note:** Exceptions escaping the death test are treated as failures and cause the test to report an error but are not considered process death.

---

## Key Macros for Writing Death Tests

GoogleTest provides the following macros to write death tests:

| Macro                      | Behavior                                                              | Use Case                                 |
|----------------------------|-----------------------------------------------------------------------|------------------------------------------|
| `ASSERT_DEATH(statement, matcher)` | Fails fatal on no death; aborts current function on failure          | When failure should stop the current test immediately |
| `EXPECT_DEATH(statement, matcher)` | Fails non-fatal on no death; continues execution                      | When failure can be tolerated and test should continue |
| `ASSERT_EXIT(statement, predicate, matcher)` | Checks for process exit status with predicate and stderr output     | When more control over exit condition is needed |
| `EXPECT_EXIT(statement, predicate, matcher)` | Like `ASSERT_EXIT`, but non-fatal                                    | More permissive exit checks |
| `EXPECT_DEATH_IF_SUPPORTED` / `ASSERT_DEATH_IF_SUPPORTED` | Only run death test if supported on the platform                      | Cross-platform safe death test assertions |
| `EXPECT_DEBUG_DEATH` / `ASSERT_DEBUG_DEATH` | Death tests only in debug mode; in optimized mode executes without asserting death | Testing code that aborts only in debug build |

> **Tip:** Use the `ASSERT_` family when failures must stop further execution in the test, otherwise `EXPECT_` variants allow you to collect multiple failures.

Example:

```cpp
TEST(MyDeathTest, FooAssertDies) {
  ASSERT_DEATH({ Foo(-1); }, "Invalid input detected");
  EXPECT_DEATH(Bar(), "fatal error");
}

TEST(MyDeathTest, ExitCodeAndMessage) {
  EXPECT_EXIT(NormalExitFunction(), testing::ExitedWithCode(0), "Success");
}
```

---

## Statement and Matcher Parameters

### Statement

The first parameter to death test macros is a statement of code expected to cause death. This can be:

- A simple function call
- A compound statement surrounded by `{}`

Example:

```cpp
EXPECT_DEATH({
  int x = GetValue();
  Validate(x);
}, "Validation failed");
```

**Caveats:**

- Avoid using assertions like `ASSERT_*` inside the death test statement because they can cause early return, which is considered a failure in death tests.
- A death test statement that returns or throws an exception fails the test: death tests require process termination, not exception throwing.

### Matcher

The second parameter specifies the expected error message output to stderr when the death occurs. It can be:

- A string interpreted as a regular expression pattern (using GoogleTest’s regex flavor)
- A GoogleTest matcher compatible with `Matcher<const std::string&>` such as `ContainsRegex()`

By default, string literals are interpreted as regex patterns implicitly using `ContainsRegex` matcher for backward compatibility.

Example:

```cpp
EXPECT_DEATH(ThrowIfInvalid(), "Invalid value: .* at line [0-9]+");
EXPECT_DEATH(CrashFunction(), ContainsRegex("fatal"));
```

> **Tip:** Use raw string literals to write regex to avoid double escaping.

---

## How Death Tests Work Behind the Scenes

Death tests run your statement in a separate subprocess so that process termination does not kill the main test runner. This is managed internally by GoogleTest, abstracting platform differences.

### Styles of Death Tests

GoogleTest supports two main death test styles, controlled by the `--gtest_death_test_style` flag.

| Style         | Description                                                                                      | When to Choose                  |
|---------------|------------------------------------------------------------------------------------------------|--------------------------------|
| `fast`        | Child process is forked, statement executed immediately in child.                               | Faster execution, default on POSIX|
| `threadsafe`  | Child process re-executes test binary with flags to run only this death test.                   | Safer in multithreaded or complex programs|

On Windows platforms, all death tests default to the `threadsafe` style because of OS limitations.

> **Recommendation:** Use `threadsafe` if your code spawns threads or relies heavily on thread-specific state. For simpler single-threaded scenarios, prefer `fast` for speed.

### Process Flow

1. **Parent spawns child process**: using `fork` on POSIX or CreateProcess on Windows.
2. **Child runs death test statement**.
3. **Child exits or terminates**.
4. **Parent captures child's stderr** and exit status.
5. **Parent verifies exit status matches predicate** and stderr matches expected matcher.
6. **Test passes if all criteria are met; otherwise fails.**

---

## Best Practices for Writing Death Tests

### 1. Name Your Death Test Suites Appropriately

Conventionally, name your test suites containing death tests with the suffix `DeathTest`.

Reasons:

- GoogleTest runs death tests before regular tests.
- Helps avoid thread safety issues by isolating them.

Example:

```cpp
class FooDeathTest : public testing::Test {};

TEST_F(FooDeathTest, DiesOnInvalidInput) {
  ASSERT_DEATH(Foo(-1), "Invalid input");
}
```

### 2. Ensure Statement Terminates the Process

Death tests expect your statement to cause process termination. If your code throws exceptions that are caught outside or returns normally, the test fails.

Don't use `return` or uncaught exceptions inside the death test statement.

### 3. Use Appropriate Matchers

- Match stderr outputs for informative failure diagnostics.
- Prefer regex or GoogleTest string matchers.
- Match on unique fragments of error messages to avoid brittle tests.

### 4. Avoid Side Effects Inside Death Test Statements

Because death tests run in subprocesses, any in-memory side effects will not be visible to the parent process.

If memory is freed or files are closed inside the death test, it may interfere with subsequent tests or test runners.

### 5. Use `Mock::AllowLeak` for Mock Objects

Mock objects will leak in death tests due to abrupt process termination. Explicitly allow such leaks where needed to avoid false positives in leak detection.

### 6. Use `EXPECT_DEATH_IF_SUPPORTED` for Portable Tests

When writing tests that may run on platforms without death test support, use `EXPECT_DEATH_IF_SUPPORTED` so tests gracefully skip death checks on unsupported platforms.

---

## Handling Exceptions in Death Tests

- If exceptions escape the death test statement, this counts as failure (`THREW` outcome).
- Exceptions thrown inside death tests are caught internally and reported as test failures.

Example test from use case:

```cpp
TEST(CxxExceptionDeathTest, ExceptionIsFailure) {
  EXPECT_NONFATAL_FAILURE(
    EXPECT_DEATH(throw 1, ""),
    "threw an exception");
}
```

---

## Debug Mode Specific Death Tests

- `EXPECT_DEBUG_DEATH` and `ASSERT_DEBUG_DEATH` assert death only when compiled in debug mode (`NDEBUG` macro is not defined).
- In optimized build, they just execute the statement without asserting death.

Useful for code that triggers fatal assertions or log failures in debug build but compiles to non-failing code in release.

Example:

```cpp
EXPECT_DEBUG_DEATH(SomeDebugOnlyCheck(), "check failed");
```

---

## Sandbox and Environment Considerations

- Death tests run in a child process that inherits the same environment but executes independently.
- The current working directory may be changed; death tests accommodate this.
- Thread count warnings are emitted if multiple threads are active during death test invocation because `fork()` in multithreaded contexts is unsafe.

---

## Common Pitfalls and Troubleshooting

| Problem                              | Explanation/Resolution                                           |
|------------------------------------|-----------------------------------------------------------------|
| Multiple death tests on same line   | Not allowed; leads to compilation errors. Write in separate lines. |
| Death test statement returns        | Causes failure (`RETURNED` outcome). Remove `return` from statement. |
| Exception thrown but not caught     | Causes failure (`THREW` outcome). Avoid letting exceptions escape death tests. |
| Death test fails silently           | Verify matcher patterns against stderr output; check death test style. |
| Unrecognized death test style flag  | Set `--gtest_death_test_style=threadsafe` or `fast`. Others invalid. |
| Tests fail on Windows with pop-ups  | Disable exception catching or run with debugger to avoid pop-ups. |

To debug, review the stderr logged from the death test and verify that the expected message matches exactly in the regex or matcher.

---

## Practical Examples

### Simple ASSERT_DEATH

```cpp
TEST(MyDeathTest, DetectsFatalError) {
  ASSERT_DEATH({
    DoSomethingFatal();
  }, "fatal error detected");
}
```

### Using EXPECT_EXIT and Exit Predicate

```cpp
void NormalExit() {
  printf("Success\n");
  exit(0);
}

TEST(MyDeathTest, ExitsWithZero) {
  EXPECT_EXIT(NormalExit(), ::testing::ExitedWithCode(0), "Success");
}
```

### Death Test with Function That Takes Arguments

```cpp
void DieIf(bool should_die) {
  if (should_die) std::terminate();
}

TEST(MyDeathTest, ConditionalDeath) {
  EXPECT_DEATH(DieIf(true), "");
  EXPECT_NONFATAL_FAILURE(
      EXPECT_DEATH(DieIf(false), ""),
      "failed to die");
}
```

---

## Related Macros and Assertions

- See the [Assertions Reference](reference/assertions.md#death) for full macro descriptions.
- See `EXPECT_FATAL_FAILURE` and `EXPECT_NONFATAL_FAILURE` for catching failures inside death tests.
- Use `SCOPED_TRACE` to add context if death tests involve subroutines.

---

## Summary

Death tests are an essential tool for robustly verifying that your code correctly causes process termination on fatal error conditions. GoogleTest abstracts away platform details, providing macros such as `ASSERT_DEATH`, `EXPECT_EXIT`, and their variants to run death tests safely and match expected error output using regex or matchers.

Write death tests to cover assertion failures, aborts, abnormal exits, and any path expected to kill the process, and use matchers to precisely define the expected diagnostic output.

By naming test suites with `DeathTest`, carefully choosing death test styles, and following best practices, you can make death testing a reliable, cross-platform part of your testing workflow.

---

## Additional Resources

- [Assertions Reference](reference/assertions.md#death)
- [Advanced Guide on Death Tests](guides/advanced-and-real-world/testing-error-handling-death-tests.md)
- [Basic Test Macros Reference](api-reference/core-testing-apis/test-macros.md)
- [Matchers Reference](api-reference/core-testing-apis/matchers.md)
- [GoogleTest Primer](getting-started/introduction-requirements/what-is-googletest.md)
- [Platform and Threading Considerations](overview/integration-and-ecosystem/supported-platforms.md)

---

## Source Reference

For developers interested in internals, death tests are principally defined in:

- `gtest/include/gtest/gtest-death-test.h` (public API)
- `gtest/include/gtest/internal/gtest-death-test-internal.h` (internals)
- `gtest/src/gtest-death-test.cc` (core implementation)
- `gtest/test/googletest-death-test-test.cc` (internal tests for death tests)

<Source url="https://github.com/google/googletest" paths='["googletest/include/gtest/gtest-death-test.h","googletest/src/gtest-death-test.cc","googletest/test/googletest-death-test-test.cc","googletest/include/gtest/internal/gtest-death-test-internal.h"]' branch="main" />