---
title: "Mocking APIs"
description: "Complete reference for creating and controlling mock objects with GoogleMock. Documents key macros for mock declarations, expectation setup, call verification, and lifecycle management. Includes clear examples of how to mock functions/methods and validate interactions."
---

# Mocking APIs

Comprehensive reference on creating, configuring, and controlling mock objects using GoogleMock. This documentation details the core macros and classes essential for defining mocked methods, setting expectations, specifying default behaviors, verifying interactions, and managing the lifecycle of mocks.

---

## Overview

GoogleMock enables you to create mock classes and methods easily within C++ for interaction-based unit testing. Mocks simulate dependencies, allowing precise control over method calls, arguments, return values, and invocation order. This page specifically documents:

- Defining mock methods with `MOCK_METHOD`
- Setting expectations via `EXPECT_CALL`
- Configuring default behaviors with `ON_CALL`
- Controlling call ordering and cardinality
- Verifying mock usage and managing lifetimes

For foundational concepts and practical tutorials, the [gMock for Dummies](gmock_for_dummies.md) and [gMock Cookbook](docs/gmock_cook_book.md) guides provide excellent hands-on introductions.

---

## Mocking Methods with `MOCK_METHOD`

### Syntax

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
```

Define a mock method `MethodName` in your mock class with the specified return type and argument list. The optional `Specs` parameter controls method qualifiers such as `const`, `override`, exception specifiers, calling conventions, and reference qualifiers.

### Specifiers

| Specifier                   | Description                                                       |
|-----------------------------|-------------------------------------------------------------------|
| `const`                     | Marks the method as `const`; required when overriding `const` methods. |
| `override`                  | Marks the method as overriding a virtual method; recommended for clarity. |
| `noexcept`                  | Marks method `noexcept`, matching the base class.                  |
| `Calltype(...)`             | Specifies calling convention (e.g., `STDMETHODCALLTYPE` on Windows). |
| `ref(&)` or `ref(&&)`       | Specifies reference qualifiers if overriding ref-qualified methods. |

### Handling Commas in Arguments

Types containing commas (e.g., `std::pair<bool, int>`) must be enclosed in parentheses or defined via type aliases to prevent parsing errors:

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
```

Or preferably:

```cpp
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD(BoolAndInt, GetPair, ());

using MapIntDouble = std::map<int, double>;
MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
```

### Placement

`MOCK_METHOD` must be declared in the `public:` section of your mock class, regardless of the access level of the base method, to enable external access for expectations and calls.

### Example

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

---

## Setting Expectations with `EXPECT_CALL`

Create expectations that specify which mock methods should be called, with what arguments, how many times, and in what order.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
  .With(multi_arg_matcher)?
  .Times(cardinality)?
  .InSequence(sequences...)?
  .After(expectations...)?
  .WillOnce(action)*
  .WillRepeatedly(action)?
  .RetiresOnSaturation()?;
```

*Clauses in parentheses are optional or can appear multiple times. Clauses must be used in the order shown.*

### Clauses Explained

- **With**: Uses a matcher on the entire tuple of arguments, allowing complex constraints on all parameters.

- **Times**: Specifies how many times the method is expected. Cardinailty examples:
  - `AnyNumber()`: any number of times
  - `Exactly(n)`: exactly n times
  - `AtLeast(n)`, `AtMost(n)`, `Between(m, n)`

  If omitted, `Times` is inferred from `WillOnce`/`WillRepeatedly` clauses.

- **InSequence**: Associates the expectation with one or more `Sequence` objects to enforce ordering among multiple expectations.

- **After**: Specifies that this expectation must occur after one or more other `Expectation` or `ExpectationSet` objects.

- **WillOnce**: Schedules an action to perform on the _next_ matching call. Can be repeated multiple times consecutively.

- **WillRepeatedly**: Specifies the action for all matching calls after `WillOnce` actions run out. Allowed once.

- **RetiresOnSaturation**: Makes the expectation retire (become inactive) as soon as its call count matches the expectation.

### Examples

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::Sequence;

Sequence s1, s2;

EXPECT_CALL(my_mock, Foo(5))
    .Times(2)
    .WillRepeatedly(Return(true));

EXPECT_CALL(my_mock, Bar(_, _))
    .InSequence(s1, s2)
    .WillOnce(Return(42))
    .RetiresOnSaturation();

EXPECT_CALL(my_mock, Baz(_))
    .After(EXPECT_CALL(my_mock, Foo(5)))
    .WillOnce(Return(1));

// With multi-arg matcher:
EXPECT_CALL(my_mock, SetPosition(_, _))
    .With(Lt())  // expects first arg < second arg
    .WillRepeatedly(Return(true));
```

### Best Practices

- Use `ON_CALL` to set default behaviors without imposing expectations.
- Use `EXPECT_CALL` only when you want to verify invocation.
- Order specific expectations after general ones to avoid unintended shadowing (newer rules override older).
- Use `RetiresOnSaturation` to prevent stale expectations from matching unexpected calls.
- Use `InSequence` or `After` to enforce call order only when necessary; avoid over-constraining tests.

---

## Defining Default Behaviors with `ON_CALL`

Set default actions that apply when no `EXPECT_CALL` matches, or to define fallback behaviors.

### Syntax

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .With(multi_arg_matcher)?
    .WillByDefault(action);
```

- `.With()` is optional and can be used only once.
- `.WillByDefault()` is required exactly once.

### Characteristics

- Default behaviors apply only when no expectations match the call.
- Allows the mock to behave realistically without setting explicit expectations.
- Newer `ON_CALL` statements override older ones for matching calls.

### Example

```cpp
using ::testing::_;
using ::testing::Return;

ON_CALL(my_mock, DoSomething(_))
    .WillByDefault(Return(true));

ON_CALL(my_mock, DoSomething(42))
    .WillByDefault(Return(false));
```

---

## Controlling Mock Object Behavior

### NiceMock, NaggyMock, and StrictMock

- **NaggyMock**: Default; warns on uninteresting calls.
- **NiceMock**: Suppresses warnings on uninteresting calls.
- **StrictMock**: Fails on uninteresting calls.

Example:

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock; // No warnings for uninteresting calls
StrictMock<MockFoo> strict_mock; // Errors on uninteresting calls
```

Note: These wrappers work correctly if the mock methods are defined directly in the base class; nesting is not supported.

### Allowing Leakage

Sometimes mocks are intentionally leaked (e.g., owned externally). Use:

```cpp
Mock::AllowLeak(&mock_object);
```

This suppresses leak warnings and disables automatic verification on destruction.

### Verifying and Clearing Expectations

You can explicitly verify if all expectations were met before disposing of a mock:

```cpp
bool success = Mock::VerifyAndClearExpectations(&mock_object);
```

Or verify and clear both expectations and default actions:

```cpp
bool success = Mock::VerifyAndClear(&mock_object);
```

Do not add new expectations after verification.

---

## Advanced Usage Patterns

### Expectation Ordering

Use [`InSequence`](docs/gmock_cheat_sheet.md#Sequence) or `.After()` to enforce call order.

Example with `InSequence`:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, A());
  EXPECT_CALL(mock, B());
}
```

Example with `.After()`:

```cpp
Expectation e1 = EXPECT_CALL(mock, A());
EXPECT_CALL(mock, B()).After(e1);
```

### Mocking Overloaded Methods

Explicitly specify the overload by providing argument matchers or using the `Const()` wrapper for overloaded const methods.

Example:

```cpp
EXPECT_CALL(mock, Overloaded(MatcherType));
EXPECT_CALL(Const(mock), Overloaded(MatcherType));
```

### Delegating to Real or Fake Objects

You can delegate calls to real or fake implementations in default actions:

```cpp
ON_CALL(mock_object, Method).WillByDefault([&real_obj](Args... args) {
  return real_obj.Method(args...);
});
```

### Mocking Methods with Move-Only Types

Use the same `MOCK_METHOD` syntax with move-only params and return types. Use lambdas or functors in `WillOnce`/`WillRepeatedly` for custom behavior.

---

## Troubleshooting Common Issues

- Ensure mocked methods are `virtual` except when using Hi-perf dependency injection mocking of non-virtual methods.
- Convert const-qualified parameters (e.g., `const int`) in mock declarations to remove warnings in MS Visual C++.
- If expectations are not satisfied, run tests with `--gmock_verbose=info` to trace mock call matching.
- Uninteresting calls (calls without `EXPECT_CALL`) result in warnings by default; use `NiceMock` or add broad expectations to control this.

---

## Code Examples

### Defining a Mock Class

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Process, (Data d), (override));
  MOCK_METHOD(bool, IsValid, (), (const, override));
};
```

### Setting Expectations and Default Actions

```cpp
MockFoo mock;

ON_CALL(mock, GetSize()).WillByDefault(Return(10));
EXPECT_CALL(mock, Process).Times(1);
EXPECT_CALL(mock, IsValid())
    .WillOnce(Return(true))
    .WillRepeatedly(Return(false));

int size = mock.GetSize(); // returns 10
mock.Process(Data()); // expected once
bool valid1 = mock.IsValid(); // returns true
bool valid2 = mock.IsValid(); // returns false
```

### Ordering Expectations

```cpp
Sequence s1;
EXPECT_CALL(mock, Init()).InSequence(s1);
EXPECT_CALL(mock, Run()).InSequence(s1);
```

Calls to `Init()` must precede `Run()`.

### Verifying Expectations Early

```cpp
bool verified = Mock::VerifyAndClearExpectations(&mock);
ASSERT_TRUE(verified);
```

---

## Related Documentation

- [gMock for Dummies](docs/gmock_for_dummies.md): A beginner-friendly tutorial on mock usage.
- [gMock Cookbook](docs/gmock_cook_book.md): Recipes and pragmatic examples.
- [Matchers API](api-reference/matchers-actions/matchers): Using and creating argument matchers.
- [Actions API](api-reference/matchers-actions/actions): Built-in and custom actions.
- [Cardinalities and Expectations](api-reference/advanced-customization/cardinalities-expectations): Customizing call counts.
- [Core Testing APIs - Test Discovery and Execution](api-reference/core-testing-apis/test-discovery-execution): Integration of mocks in test runs.

---

## Summary

This page offers a definitive guide for using GoogleMock's mocking facilities, focusing strictly on user-facing macros and classes for mocking C++ methods. It equips developers with syntax, best practices, and troubleshooting tips for creating effective and maintainable mock-based tests, controlling behavior with default actions, and verifying interactions to ensure software correctness.

---

## Additional Tips

- Always mock virtual methods except when explicitly using techniques for non-virtual mocking.
- Use `.RetiresOnSaturation()` to make expectations respect upper call limits gracefully.
- Control verbosity of mock warnings using the `--gmock_verbose` flag.
- Use `NiceMock` or `StrictMock` depending on the desired sensitivity to uninteresting calls.
- Verify expectations explicitly if your mock's lifetime is uncontrolled.

---