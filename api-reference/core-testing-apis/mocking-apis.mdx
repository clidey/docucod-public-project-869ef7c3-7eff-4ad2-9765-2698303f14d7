---
title: "Mocking APIs and Macros"
description: "API reference for creating, configuring, and using mock objects and methods with GoogleMock. Covers key macros (MOCK_METHOD, EXPECT_CALL, ON_CALL), behavioral configuration, and lifecycle."
---

# Mocking APIs and Macros

This page provides a thorough reference for creating, configuring, and using mock objects and methods within GoogleMock, the mocking framework of the GoogleTest suite. It focuses on the core macros used to define mock methods and set expectations, default behaviors, and call sequences in tests.

To use these facilities, include the header:

```cpp
#include <gmock/gmock.h>
```

---

## MOCK_METHOD Macro

```cpp
MOCK_METHOD(return_type, method_name, (args...), (specs...));
```

The `MOCK_METHOD` macro defines a mock method inside your mock class. It accepts:

- **return_type**: The return type of the mock method.
- **method_name**: The name of the method to mock.
- **args...**: Parenthesized comma-separated list of argument types.
- **specs...**: Optional list of method qualifiers (e.g., `const`, `override`, `noexcept`) and call type specifiers.

### Allowed Specifiers

| Specifier                      | Description                                                  |
|-------------------------------|--------------------------------------------------------------|
| `const`                       | Marks method as const; required if overriding a const method. |
| `override`                    | Marks method with C++ override keyword; recommended when overriding virtual methods. |
| `noexcept`                    | Marks method as noexcept; required if overriding a noexcept method. |
| `Calltype(calltype)`          | Specifies the calling convention (e.g., `Calltype(STDMETHODCALLTYPE)`). Useful on Windows. |
| `ref(&)` or `ref(&&)`         | Declares reference qualifiers; required if overriding methods with reference qualifiers. |

### Handling Commas in Types

Types containing commas (e.g., `std::pair<bool, int>`) may cause parsing errors. Solutions include:

1. Wrapping the entire type in parentheses:

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
```

2. Using type aliases:

```cpp
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD(BoolAndInt, GetPair, ());
using MapIntDouble = std::map<int, double>;
MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
```

### Important Usage Notes

- `MOCK_METHOD` declarations must be placed in the `public:` section of the mock class, even if mocking methods that are originally `protected` or `private`.

- The macro auto-generates the implementation for you; no manual method body is necessary.

---

## EXPECT_CALL Macro

```cpp
EXPECT_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)?
    .Times(cardinality)?
    .InSequence(sequences...)*
    .After(expectations...)*
    .WillOnce(action)*
    .WillRepeatedly(action)?
    .RetiresOnSaturation()?;
```

Sets an expectation that `method_name` of `mock_object` will be called with arguments matching the specified `matchers`. This macro must be called before exercising the mock object.

### Argument Matchers

- Each argument in the method call should have a corresponding matcher (e.g., `_` for any value, `Eq(value)`, `Lt(value)`).
- If the argument list is omitted for non-overloaded methods, it implies using wildcard matcher `_` for each argument.

### Modifier Clauses and Their Usage Order

- `.With(multi_argument_matcher)`: Restricts the entire argument tuple (must appear first; can be used once).
- `.Times(cardinality)`: Specifies the number of expected calls (e.g., `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`), used once.
- `.InSequence(sequences...)`: Specifies sequences to enforce call order; can appear multiple times.
- `.After(expectations...)`: Specifies expectations which must have been satisfied before this call; can appear multiple times.
- `.WillOnce(action)`: Defines behavior for individual calls; can appear multiple times.
- `.WillRepeatedly(action)`: Defines behavior for the remaining calls after `WillOnce`; can appear once.
- `.RetiresOnSaturation()`: Causes the expectation to retire (no longer match) after reaching its call limit; can appear once and must be last.

#### Example

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::Sequence;

Sequence s1, s2;
EXPECT_CALL(mock_object, Reset())
    .InSequence(s1, s2);
EXPECT_CALL(mock_object, GetSize())
    .InSequence(s1);
EXPECT_CALL(mock_object, Describe())
    .InSequence(s2);

EXPECT_CALL(mock_object, GetNumber())
    .Times(3)
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));
```

### Behavior Details

- **Cardinality Inference:** If `.Times()` is omitted, it is inferred based on presence of `.WillOnce` and `.WillRepeatedly`.
- **Expectation Order:** New expectations override older ones; last matching expectation wins.
- **Sticky Expectations:** Expectations remain active even after saturation unless `RetiresOnSaturation()` is used or a sequence requires retirement.

---

## ON_CALL Macro

```cpp
ON_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)?
    .WillByDefault(action);
```

Sets the default behavior when the specified method is called, without setting any expectation about the number of calls.

### Notes

- Does not set expectations; unverified calls matching this spec will not cause test failures.
- Useful for defining fallback or baseline behavior used by multiple tests.
- When multiple `ON_CALL`s are specified, the last matching one takes precedence.

### Usage

```cpp
ON_CALL(mock_object, Foo(_, _))
    .WillByDefault(Return(true));
```

### Clause Details

- `.With(multi_argument_matcher)`: Optional restriction, similar to `EXPECT_CALL`.
- `.WillByDefault(action)`: Required, specifies the default action to perform.

---

## Mock Classes for Behavior Control

GoogleMock also provides special wrapper templates to control how uninteresting calls (calls without explicit expectations) are handled:

- `NiceMock<T>`: Suppresses warnings for uninteresting calls.
- `NaggyMock<T>`: (Default) Warns for uninteresting calls.
- `StrictMock<T>`: Treats uninteresting calls as errors (test failures).

Each is used similarly:

```cpp
NiceMock<MockClass> nice_mock;
StrictMock<MockClass> strict_mock;
```

### Important Notes

- These wrappers only affect uninteresting calls, not unexpected calls (calls that don't match any expectation).
- They only work for mock methods declared *directly* in the mocked class via `MOCK_METHOD`.
- The mock class destructor should be virtual for correct behavior.

---

## Expectation and Sequence Management

GoogleMock allows fine-grained control of call ordering and dependencies:

- `Sequence`: Represents a sequence of expectations enforcing chronological ordering.
- `InSequence`: An RAII helper that puts all expectations defined in its scope into an anonymous sequence.
- Expectation chaining via `.After()`: Specifies partial order dependencies among expectations.

Example of enforcing order:

```cpp
Sequence seq;
EXPECT_CALL(mock, Foo()).InSequence(seq);
EXPECT_CALL(mock, Bar()).InSequence(seq);
```

Or using `InSequence` scope:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, Foo());
  EXPECT_CALL(mock, Bar());
}
```

This will expect `Foo()` to be called before `Bar()`.

---

## Default Values and Actions

- `::testing::DefaultValue<T>` lets you specify the default returned value for mock methods of type `T` when no explicit action is specified.
- Use `DefaultValue<T>::Set(value)`, `SetFactory()`, or `Clear()` to manage defaults.

### Example

```cpp
DefaultValue<int>::Set(42);
EXPECT_CALL(mock, GetNumber());
int val = mock.GetNumber();  // val == 42
DefaultValue<int>::Clear();
```

- Method-specific default actions are best set via `ON_CALL()`.

---

## Best Practices and Tips

- Always define expectations (`EXPECT_CALL`) before exercising mocks to ensure predictable behavior and useful error reporting.
- Use `ON_CALL` to specify default behaviors without setting call expectations.
- Avoid mocking non-virtual methods whenever possible; prefer interfaces with virtual methods.
- Use `NiceMock` or `StrictMock` wrappers to manage and simplify verbosity related to uninteresting calls.
- Use sequences (`Sequence` and `InSequence`) to enforce call ordering when required.
- Prefer type aliases or parentheses in `MOCK_METHOD` to correctly handle complex return or parameter types containing commas.
- Be mindful that expectations are sticky unless retired.
- Use `RetiresOnSaturation()` to make expectations inactive after reaching their call count.
- When mocking overloaded methods, provide all overloads or bring omitted ones into scope with `using` to avoid hiding errors.

---

## Troubleshooting Common Mock Setup Issues

- Ensure all mocked methods are virtual.
- Mock destructors should be virtual.
- Expectation syntax errors can cause undefined behavior; check order and usage of clauses.
- Use `--gmock_verbose=info` during test debugging to see mock call traces and matching expectations.
- Avoid setting expectations after mock methods have been called or passed to tested code.

---

### Additional Resources

- [gMock for Dummies Tutorial](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Matchers Reference](matchers.md)
- [Actions Reference](actions.md)
- [Cardinalities Reference](reference/mock-configuration-behavior/cardinalities-reference.md)
- [Nice, Naggy, and Strict Mocks](reference/mock-configuration-behavior/nice-naggy-strict-mocks.md)

---

This completes the core API reference for mocking methods and expectations in GoogleMock.
