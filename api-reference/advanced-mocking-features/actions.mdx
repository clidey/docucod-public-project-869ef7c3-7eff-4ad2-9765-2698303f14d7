---
title: "Actions: Return Values & Behaviors"
description: "Details how to specify and compose actions for mock methods, covering built-in actions (Return, Throw, Assign, etc.), user-defined actions, and advanced composition patterns. Includes API usage, extension points, and best practices."
---

# Actions: Return Values & Behaviors

This page guides you through specifying and composing actions for mock methods in GoogleMock. Actions control the behavior of mock functions when they are called, enabling the simulation of return values, side effects, exceptions, and complex compositions. Whether using built-in actions like `Return()` and `Throw()`, defining your own custom actions, or combining multiple actions for advanced testing patterns, this documentation provides clear instructions, examples, and best practices to help you harness the full power of GoogleMock's action system.

---

## Overview of Actions

When defining expectations on mock methods, actions specify what a mock function does when invoked. An action can return a value, modify arguments, invoke callbacks, throw exceptions, or perform complex sequences. Understanding how to effectively use actions is essential to create precise and maintainable tests that simulate real behaviors.

### Core Capabilities
- Return specific values or references.
- Assign values to output parameters.
- Invoke callable arguments or external functions.
- Throw exceptions.
- Combine several actions in a sequence.

---

## Built-in Actions

GoogleMock includes a rich set of built-in actions in the `::testing` namespace. Here, we cover the most commonly used actions, their behaviors, and example usages.

### Returning Values

| Action                  | Description                                                |
|-------------------------|------------------------------------------------------------|
| `Return()`              | Returns from a `void` mock function.                       |
| `Return(value)`         | Returns a copy of `value`. The conversion happens at the time the expectation is set, not at call time. |
| `ReturnArg<N>()`        | Returns the N-th (0-based) argument passed to the mock function. |
| `ReturnNew<T>(args...)` | Returns a pointer to a newly created object `new T(args...)` for each call. |
| `ReturnNull()`          | Returns a null pointer (e.g., `nullptr`).                  |
| `ReturnPointee(ptr)`    | Returns the value pointed to by `ptr`, evaluated at call time. |
| `ReturnRef(variable)`   | Returns a reference to `variable`. Useful when the return type is a reference. |
| `ReturnRefOfCopy(value)`| Returns a reference to a copy of `value`; the copy stays valid as long as the action. |
| `ReturnRoundRobin({a1,...})` | On each call, returns the next item in the list cyclically. |

**Example:**
```cpp
using ::testing::Return;

EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillRepeatedly(Return(42));
```
This makes `GetValue()` return 10 the first call, and 42 thereafter.

### Side-Effect Actions

| Action                          | Description                                   |
|--------------------------------|-----------------------------------------------|
| `Assign(&variable, value)`      | Assigns `value` to `variable`.                 |
| `DeleteArg<N>()`                | Deletes the pointer argument at index N.      |
| `SaveArg<N>(pointer)`           | Saves the N-th argument's value to `*pointer`.|
| `SaveArgByMove<N>(pointer)`    | Saves the N-th argument by move to `*pointer`.| 
| `SaveArgPointee<N>(pointer)`   | Saves the value pointed to by the N-th argument to `*pointer`.
| `SetArgReferee<N>(value)`      | Sets the referenced variable passed as the N-th argument to `value`.
| `SetArgPointee<N>(value)`      | Assigns `value` to the variable pointed to by the N-th argument.
| `SetArrayArgument<N>(first, last)` | Copies elements from `[first, last)` to the array pointed by the N-th argument.
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value`.
| `Throw(exception)`              | Throws the given exception.

**Example:**
```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```
This sets the pointed-to argument 0 to 5 and returns `true`.

### Using Callables as Actions

You can use existing functions, functors, lambdas, or callbacks as actions.

| Action                                            | Description                                |
|--------------------------------------------------|--------------------------------------------|
| `f`                                               | Calls the callable `f` with mock arguments. Returned value is used as the return value. |
| `Invoke(f)`                                       | Calls global/static function, member function, or functor `f` with mock arguments. |
| `Invoke(obj_ptr, &Class::method)`                 | Calls `method` on `obj_ptr` with mock arguments. |
| `InvokeWithoutArgs(f)`                            | Calls `f` which takes no arguments. Ignores mock function arguments. |
| `InvokeWithoutArgs(obj_ptr, &Class::method)`      | Calls `method` (with no args) on `obj_ptr`. |
| `InvokeArgument<N>(args...)`                      | Invokes the N-th argument, which must be a callable, with supplied `args`. |

**Example:**
```cpp
int Sum(int x, int y) { return x + y; }
EXPECT_CALL(mock, Compute(_, _))
    .WillOnce(Invoke(Sum));
```

### Default Action

| Action          | Description                       |
|-----------------|---------------------------------|
| `DoDefault()`   | Performs the default action specified by `ON_CALL` or the built-in default.

> **Note:** `DoDefault()` cannot be used inside composite actions.

---

## Composite Actions

Composite actions allow you to combine multiple actions in a sequence, performing several operations at once and returning the result of the last action.

| Action                         | Description                              |
|-------------------------------|------------------------------------------|
| `DoAll(a1, a2, ..., an)`       | Performs each action `a1` to `an` in order; returns `an`'s result. The first `n-1` must return void. |
| `IgnoreResult(a)`              | Performs action `a` but ignores its return value. Useful for void-returning mocks where the action returns a value. |
| `WithArg<N>(a)`                | Passes the N-th argument of mock function to action `a`. |
| `WithArgs<N1,...,Nk>(a)`      | Passes arguments at indices N1,...,Nk to action `a`. |
| `WithoutArgs(a)`               | Performs action `a` without any arguments. |

**Example:**
```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```
Sets the first output argument to 5 and returns true.

---

## Defining New Actions

Sometimes built-in actions are insufficient. You can create custom actions using:

- **Callables:** Define lambdas or functors with call operators matching the mock method signature.
- **Action Macros:** Use macros like `ACTION`, `ACTION_P`, etc., for quick parameterized action definitions.
- **Implementation of `ActionInterface<F>`:** Define classes with a `Perform` method templated on result and argument tuple types. Ideal for full control.
- **Polymorphic Actions:** For actions usable with multiple function signatures, use `MakePolymorphicAction` with a template `Perform` method.

### Example: Custom Parameterized Action Using `ACTION_P`
```cpp
ACTION_P(IncrementBy, n) {
  return arg0 + n;  // arg0 is 0th argument to mock
}

EXPECT_CALL(mock, Add(_))
    .WillOnce(IncrementBy(5));
```

### Example: Custom Monomorphic Action (full control)
```cpp
template <typename F>
class MultiplyByAction : public ::testing::ActionInterface<F> {
 public:
  explicit MultiplyByAction(int factor) : factor_(factor) {}

  template <typename Result, typename ParamsTuple>
  Result Perform(const ParamsTuple& args) override {
    return std::get<0>(args) * factor_;
  }

 private:
  int factor_;
};

Action<int(int)> MultiplyBy(int factor) {
  return MakeAction(new MultiplyByAction<int(int)>(factor));
}

EXPECT_CALL(mock, Multiply(_)).WillOnce(MultiplyBy(3));
```

### Example: Polymorphic Action

A polymorphic action can adapt to multiple signatures.

```cpp
class ReturnSecondArg {
 public:
  template <typename Result, typename ArgsTuple>
  Result Perform(const ArgsTuple& args) const {
    return std::get<1>(args);
  }
};

PolymorphicAction<ReturnSecondArg> ReturnSecond() {
  return MakePolymorphicAction(ReturnSecondArg());
}

EXPECT_CALL(mock, Func(_, _))
    .WillOnce(ReturnSecond());  // returns argument 1 regardless of signature
```

---

## Best Practices & Tips

- **Set expectations before calls:** Always define your `EXPECT_CALL` clauses before the mock method is invoked. gMock reports violations immediately.
- **Use `RetiresOnSaturation()` for non-sticky expectations:** To avoid repeated matches after expected call counts are reached.
- **Prefer `ON_CALL` for default behavior without expectations:** Use `EXPECT_CALL` only for calls you want to verify.
- **Use composite actions to simulate side effects and return values simultaneously:** Example: combining `SetArgPointee` with `Return` using `DoAll()`.
- **Be mindful of move-only types:** Use lambdas or functors for complex behaviors, especially with move-only arguments or return values.
- **Avoid over-specifying expectations:** Use matchers like `_` to allow flexibility and reduce brittleness.

---

## Troubleshooting Common Issues

### `SetArgPointee` Conflicts With Return Type

If your mock method returns a value and you want to set output parameters, use `DoAll` to combine `SetArgPointee` and `Return`:

```cpp
EXPECT_CALL(mock, Func(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

### Default Return Value Is Not What You Expect

Remember `Return(value)` converts `value` to the expected return type *when setting the expectation*. To return a live or changing value, use `ReturnPointee(pointer)` or `ReturnRef(variable)`.

### Using `Throw` Action

Only use `Throw()` with exception-enabled environments. It throws the specified exception when the mock method is called.

### Move-Only Types

When mocking methods that involve move-only types like `std::unique_ptr`, prefer lambdas or functors instead of `Return()` to create fresh objects each call to avoid errors.

---

## References & Next Steps

- Explore [Mocking Reference](reference/mocking.md) for detailed mock object usage.
- Learn about [Matchers](reference/matchers.md) to specify argument matching precisely.
- Visit the [gMock Cookbook](gmock_cook_book.md) for practical recipes.
- Understand expectations and sequencing in [gMock Cheat Sheet](gmock_cheat_sheet.md).

---

### Example of Complete Action Chain

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;

EXPECT_CALL(mock, GetData(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```
On the first call to `GetData`, the mock will set the 0th pointer argument to 42 and return true.


---