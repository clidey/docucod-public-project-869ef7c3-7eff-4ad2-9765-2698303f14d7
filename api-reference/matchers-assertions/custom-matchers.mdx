---
title: "Custom and Advanced Matchers"
description: "Reference guide to implementing custom matchers and advanced matcher constructs for more specialized testing needs."
---

# Custom and Advanced Matchers

This reference guide helps you implement your own custom matchers and use advanced constructs in GoogleMock to precisely specify argument expectations in your C++ tests. Custom matchers enable expressive, reusable, and maintainable verification logic tailored to your domain beyond built-in matchers.

---

## Why Custom Matchers?
Built-in matchers cover many common cases, but sometimes your test requires specialized logic that can't be succinctly or clearly represented. Custom matchers empower you to:

- Validate complex properties of function arguments.
- Compose flexible and combinable predicates.
- Provide rich failure messages with explanations.
- Parameterize matching behavior to adapt in different test scenarios.

They help you write tests that communicate intent clearly and catch bugs effectively.

---

## Defining Custom Matchers

GoogleMock offers macros and interfaces for defining matchers in a structured way.

### Using the `MATCHER` Macro

The simplest way to define a custom matcher is with the `MATCHER` macro. It creates a polymorphic matcher that works wherever a matcher is expected.

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}
```

Use it in an expectation or assertion:

```cpp
EXPECT_CALL(mock_foo, Bar(IsEven()));
EXPECT_THAT(value, IsEven());
```

**Details:**
- The parameter `arg` represents the value under test.
- The macro body must return a `bool` indicating a match.
- The second parameter is an optional description string.


### Parameterized Matchers

To introduce parameters to your matchers, use `MATCHER_P` and its variants `MATCHER_P2`, ..., `MATCHER_P10`.

Example:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}

EXPECT_THAT(number, HasAbsoluteValue(10));
```

This supports:
- Using multiple parameters with `MATCHER_P2` through `MATCHER_P10`.
- Rich, customizable descriptions that include parameter values.
- Polymorphic behavior adapting to the argument's type.

### Inside the Matcher Body

You can:
- Use the `arg` variable to access the argument being matched.
- Use `result_listener` (a `std::ostream*`) to provide detailed failure info.
- Use expectations (`EXPECT_` macros) inside matchers.

Example enhancing failure message:

```cpp
MATCHER(IsDivisibleBy7, "") {
  if (arg % 7 == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

---

## Writing Matcher Classes

For more control, define a matcher class implementing the following interface:

```cpp
class MyMatcher {
 public:
  using is_gtest_matcher = void;

  explicit MyMatcher(int param) : param_(param) {}

  template <typename T>
  bool MatchAndExplain(const T& value, std::ostream* listener) const {
    // Your matching logic.
  }

  void DescribeTo(std::ostream* os) const {
    *os << "description";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "negated description";
  }

 private:
  int param_;
};
```

Then create a factory function returning `testing::Matcher<T>`:

```cpp
template <typename T>
testing::Matcher<T> MyMatcherFactory(int param) {
  return testing::Matcher<T>(new MyMatcher(param));
}
```

Use in tests by writing:

```cpp
EXPECT_CALL(mock, Func(MyMatcherFactory<Type>(param)));
```

This approach:
- Enables explicit control over matcher types.
- Supports monomorphic and polymorphic matchers.
- Is suitable for widely reused or complex matchers.

---

## Composite Matchers

You can compose matchers to express complex logic:

- `AllOf(m1, m2, ...)` matches if all sub-matchers match.
- `AnyOf(m1, m2, ...)` matches if any sub-matcher matches.
- `Not(m)` negates matcher `m`.

Example:

```cpp
EXPECT_CALL(mock, Func(AllOf(Ge(0), Le(10))));
EXPECT_CALL(mock, Func(Not(IsNull())));
```

GoogleMock supports variadic arguments for these combinators for rich logical expressions.

---

## Practical Utility Matchers

GoogleMock offers flexible provided matchers that you can combine or extend:

- `Field(&Class::field, matcher)` to match a member variable.
- `Property(&Class::getter, matcher)` to match a getter value.
- `Pointee(matcher)` to match a value pointed to by a pointer/smart pointer.
- `ResultOf(callable, matcher)` to match the result of applying a callable on the argument.
- Container-specific matchers like `ElementsAre`, `Contains`, `Each` for STL-like containers.

Use these to target commonly recurring patterns with clarity and efficiency.

---

## Tips and Best Practices

- **Keep matchers pure:** Do not modify any state inside matchers.
- **Provide clear error descriptions:** Use `result_listener` to explain mismatches.
- **Leverage parameterization:** Design your matchers to accept parameters to maximize reuse.
- **Combine built-in with custom:** Don’t reinvent the wheel when built-in matchers suffice.
- **Avoid over-specification:** Use `EXPECT_CALL` sparingly to avoid brittle tests.

---

## Common Pitfalls and Troubleshooting

- Forgetting to add `using ::testing::` for matcher symbols.
- Incorrect matcher signatures leading to ambiguous calls.
- Overly strict matchers causing unexpected failures due to implementation changes.
- Defining matchers with side-effects - always keep them functional and isolated.
- Providing insufficient descriptions that obscure the failure cause.

Use the `--gmock_verbose=info` flag when running tests to get detailed mock invocation diagnostics.

---

## Example: Custom Matcher with Parameter and Explanation

```cpp
MATCHER_P(IsBetween, range, "") {
  if (arg >= range.first && arg <= range.second) return true;
  *result_listener << "which is " << arg << ", expected between "
                   << range.first << " and " << range.second;
  return false;
}

// Usage
EXPECT_CALL(mock, Foo(IsBetween(std::make_pair(10, 20))));
```

This matcher checks if a value lies within a given range and reports the actual value upon failure.

---

## References and Further Reading
- [GoogleMock Matchers Reference](reference/matchers-assertions/core-matchers)
- [gMock Cookbook — Custom Matchers](gmock_cook_book.md#NewMatchers)
- [GoogleTest Advanced Assertions](api-reference/core-testing-api/assertions)
- [Writing Your First Test](guides/getting-started/writing-your-first-test)
- [Mocking Reference](api-reference/mocking-apis/mock-classes)
- [GoogleMock Developer Guide](docs/gmock_for_dummies.md)

---

For practical recipes, workflows, and troubleshooting, see the related guides and references to become proficient in writing expressive, robust tests with custom matcher logic tailored to your codebase.