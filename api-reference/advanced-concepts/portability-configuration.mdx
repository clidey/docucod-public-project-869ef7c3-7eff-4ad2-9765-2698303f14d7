---
title: "Portability & Configuration APIs"
description: "Mechanisms and macros to ensure consistent test and mock behavior across platforms. Documents relevant flags, environmental hooks, and platform abstraction options."
---

# Portability & Configuration APIs

GoogleMock provides robust mechanisms and macros to ensure consistent test and mock behavior across different platforms and compilers. This documentation covers key configuration flags, environment hooks, and platform abstraction options that help you adapt GoogleMock to your environment seamlessly.

---

## Overview

GoogleMock’s portability layer abstracts platform-specific differences and exposes configurable macros and flags. This allows your tests and mocks to behave consistently whether you're on Linux, Windows, Mac OS, or embedded platforms,
while accommodating differences in threading support, exception handling, and other system features.

By leveraging these APIs, you ensure your test suites remain reliable and maintainable in diverse environments.

---

## Platform & Environment Flags

GoogleMock integrates tightly with GoogleTest’s portability macros (`gtest-port.h`), extending them with `gmock-port.h` for mock-specific flags and configuration.

### Key Platform Macros

GoogleMock gains awareness of platform capabilities through macros, often defined by the build system or autodetection. Examples include:

- `GTEST_HAS_PTHREAD` — Indicates presence of POSIX threads support.
- `GTEST_IS_THREADSAFE` — Whether thread-safety features are enabled.
- `GTEST_HAS_EXCEPTIONS` — Exception handling support.

These not only affect GoogleTest but also GoogleMock’s internal handling of concurrency, synchronization, and error reporting.

### GoogleMock-Specific Flags

GoogleMock defines a set of flags accessible via macros prefixed with `GMOCK_FLAG_`:

- `GMOCK_FLAG_GET(flag_name)` — Retrieve the current value of a GoogleMock flag.
- `GMOCK_FLAG_SET(flag_name, value)` — Programmatically set a GoogleMock flag.

Common flags include:

- `gmock_verbose` — Controls logging verbosity.
- `default_mock_behavior` — Sets default behavior for mocks (for example, strict or lenient).

You can define and declare such flags using provided macros (`GMOCK_DEFINE_bool_`, `GMOCK_DECLARE_int32_`, etc.) to customize feature toggles and behavior at compile or runtime.

### Example: Reading and Setting Flags

```cpp
// Read the verbosity level
std::string verbosity = GMOCK_FLAG_GET(verbose);

// Change default mock behavior to strict
GMOCK_FLAG_SET(default_mock_behavior, 2);
```

---

## Initialization and Environment Hook

Use `InitGoogleMock()` to initialize GoogleMock, parsing command-line flags specific to mock configuration as part of your test program setup.

### Usage Example

```cpp
int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This function parses GoogleMock-specific flags (such as `--gmock_verbose`) from `argv` and removes them before running tests, ensuring that non-GoogleMock flags remain untouched.

### Behavior

- Parses and applies environment flags.
- Removes recognized gMock flags from `argv`.
- Leaves unrecognized flags intact.

This ensures seamless integration with custom command lines and other testing or framework flags.

---

## Platform Abstraction and Thread Safety

GoogleMock inherits platform abstraction utilities from GoogleTest, implemented in `gtest-port.h` and extended in `gmock-port.h`.

### Thread Synchronization

Porting and synchronization utilities include:

- Mutex and lock classes compatible with underlying threading libraries (e.g., pthreads on POSIX or Windows critical sections).
- Thread-local storage abstractions.

These ensure that GoogleMock's internal data structures remain consistent in multi-threaded test executions across supported platforms.

### Supported Platforms and Policies

GoogleMock supports all platforms supported by GoogleTest, including Linux, Windows, macOS, and certain embedded platforms. It adheres to:

- Google's C++ Support Policies (requiring minimum C++17 and compatible compilers).
- Thread-safety configurations based on platform capabilities.

### Build System Integration

Common macros such as `GTEST_HAS_PTHREAD` and `GTEST_IS_THREADSAFE` are set by build configuration scripts like CMake and pkg-config.

For example, CMake scripts detect pthread support and define `-DGTEST_HAS_PTHREAD=1` as appropriate, which GoogleMock uses to conditionally compile its threading and synchronization features.

---

## Common Compiler and Build Flags

To tailor GoogleMock to your environment, several compiler flags and macros are used to control behavior:

- `DGTEST_HAS_PTHREAD` — Enable/disable pthread use.
- `DGTEST_CREATE_SHARED_LIBRARY` — When building GoogleTest/GoogleMock as a shared library.
- `DGTEST_LINKED_AS_SHARED_LIBRARY` — Used when linking with shared versions.
- `GMOCK_DONT_DEFINE_<MACRO>` — Prevent GoogleMock from defining certain macros to avoid conflicts.

### Visual Studio Runtime Compatibility

GoogleMock build scripts provide flags such as `gtest_force_shared_crt` to ensure that runtime linkage is consistent between your project and the GoogleMock libraries, avoiding linker errors on Windows.

### Controlling Build Options with CMake

The GoogleTest CMake build files (`CMakeLists.txt`) fully support platform-specific tweaks and options controlling thread support, exception handling, and runtime configurations.

Here is a snippet illustrating how pthread support is detected and propagated:

```cmake
find_package(Threads)
if(CMAKE_USE_PTHREADS_INIT)
  add_definitions(-DGTEST_HAS_PTHREAD=1)
endif()
```

You can override or customize these flags as necessary.

---

## Best Practices and Troubleshooting

- **Always initialize GoogleMock** with `InitGoogleMock()` early in your test program to ensure flags and environment settings apply correctly.
- **Confirm your build environment defines pthread support correctly** — incorrect or missing macro settings may cause runtime failures or link errors.
- **Use provided flag macros to customize mock behavior and logging** rather than hardcoding values.
- For Visual Studio users, **match your runtime linkage** (`/MT` or `/MD`) with GoogleMock builds to prevent symbol conflicts.
- If you encounter macro conflicts with other libraries, use `GMOCK_DONT_DEFINE_<macro>=1` build flags to rename GoogleMock's macros.

---

## Related Documentation

- [GoogleTest Portability Macros (`gtest-port.h`)](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-port.h) — foundational platform abstraction layer shared by GoogleTest and GoogleMock.
- [GoogleMock Customization Points](https://github.com/google/googletest/tree/main/googlemock/include/gmock/internal/custom) — advanced user customization hooks.
- [GoogleMock Initialization Tests](https://github.com/google/googletest/blob/main/googlemock/test/gmock_test.cc) — reference for test cases on flag parsing and environment hook behavior.
- [Supported Platforms and Toolchains](https://github.com/google/googletest/blob/main/overview/integration-platforms/platform-support.mdx) — what platforms GoogleMock is certified on.

---

## Conclusion

This Portability & Configuration APIs guide equips you with the macros, flags, and initialization routines needed for consistent GoogleMock behavior across diverse platforms and environments. By understanding and leveraging these components, you ensure robust, maintainable, and portable mocking tests in your C++ projects.

---

<AccordionGroup title="Flag Macros & Usage">
<Accordion title="Common GoogleMock Flag Macros">
GoogleMock flag macros provide programmatic access to configuration flags:

- `GMOCK_DEFINE_bool_(name, default_val, doc)` — Defines a boolean flag.
- `GMOCK_DECLARE_bool_(name)` — Declares a boolean flag.
- `GMOCK_FLAG_GET(name)` — Gets the current flag value.
- `GMOCK_FLAG_SET(name, value)` — Sets the flag programmatically.

Example:

```cpp
GMOCK_DEFINE_bool_(catch_leaked_mocks, true, "Whether to catch leaked mocks.");

if (GMOCK_FLAG_GET(catch_leaked_mocks)) {
  // ...
}
```
</Accordion>
<Accordion title="Customizing Flags">
Define your own flags or override existing ones by providing definitions in a custom header included before GoogleMock. Also use build-time defines to control macro definitions if you encounter conflicts.
</Accordion>
</AccordionGroup>

<AccordionGroup title="Initialization Sequence">
<Accordion title="InitGoogleMock">
`InitGoogleMock()` is your entry point to initialize GoogleMock:

- It parses command-line arguments for GoogleMock flags.
- It removes recognized GoogleMock flags from the args.
- Leaves unrelated flags untouched.
- Supports wide and narrow character argv.

### Example:

```cpp
int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This ensures environment flags like `--gmock_verbose` are recognized and applied.
</Accordion>
<Accordion title="Common Parsing Behavior">
GoogleMock strips recognized flags, such as:

- `--gmock_verbose=info`
- `--gmock_default_mock_behavior=2`

And leaves unrecognized flags like `--non_gmock_flag` untouched.

</Accordion>
</AccordionGroup>

<AccordionGroup title="Threading and Synchronization">
<Accordion title="Thread-Safety Configuration">
GoogleMock relies on GoogleTest’s platform macros such as `GTEST_HAS_PTHREAD` and `GTEST_IS_THREADSAFE` to conditionally compile synchronization primitives and thread-safe mock data structures.

If pthreads support is enabled, GoogleMock uses mutexes and thread-local storage to protect internal state.
</Accordion>
<Accordion title="Porting to Your Platform">
If your platform lacks POSIX thread support or another feature, you can disable threading features by defining `GTEST_HAS_PTHREAD=0` or disabling GoogleMock threading support via build flags.

Ensure these macros are correctly set for your build system.
</Accordion>
</AccordionGroup>

---

### Reference Links

- [GoogleMock GitHub Repository](https://github.com/google/googletest)
- [CMake Build and Configuration](https://github.com/google/googletest/blob/main/README.md#build-with-cmake)
- [GoogleTest Portability Header](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-port.h)
- [GoogleMock Portability Header](https://github.com/google/googletest/blob/main/googlemock/include/gmock/internal/gmock-port.h)

---