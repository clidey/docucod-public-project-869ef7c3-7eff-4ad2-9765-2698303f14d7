---
title: "Main Functions and Initialization"
description: "Reference for the main entry points (such as gtest_main and gmock_main), initialization and shutdown details, and guidelines for using test runners and main override."
---

# Main Functions and Initialization

This reference covers the primary entry points for running tests with GoogleTest and GoogleMock, detailing initialization and shutdown procedures, as well as best practices for overriding the test runner's main function. Understanding these components ensures seamless integration and control over the lifecycle of your test program.

---

## 1. Overview of Main Entry Points

GoogleTest and GoogleMock provide default main functions through libraries like `gtest_main` and `gmock_main`. These main functions handle initializing the framework, running all registered tests, and properly shutting down.

- **`gtest_main`**: Provides a basic `main()` implementation that initializes GoogleTest and runs all tests.
- **`gmock_main`**: Extends `gtest_main` to initialize GoogleMock (which depends on GoogleTest) and run all tests.

Using these provided entry points simplifies writing and running tests by eliminating the need to write your own `main()` function unless custom behavior is required.


## 2. Initialization and Running Tests

### GoogleTest Initialization

Your test executable should call:

```cpp
int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

- **`testing::InitGoogleTest()`** parses command-line flags relevant to GoogleTest, removing them from `argc` and `argv`.
- **`RUN_ALL_TESTS()`** executes all registered tests, returns `0` if all tests pass, `1` otherwise.

**Important:** You must **not** ignore the return value of `RUN_ALL_TESTS()`. It determines the success or failure of your test run and is vital for automated systems.

### GoogleMock Initialization

GoogleMock builds on GoogleTest, so it requires you to initialize both frameworks with:

```cpp
int main(int argc, char **argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This call initializes both GoogleMock and GoogleTest. Note that you should not call `testing::InitGoogleTest()` separately when using GoogleMock.


## 3. Using the Provided Main Functions

GoogleTest and GoogleMock provide ready-to-use main functions in libraries that you can link against:

- Link your test executable with `gtest_main` to use the default `main()` function from GoogleTest.
- Link with `gmock_main` to use the default `main()` function from GoogleMock.

This way, you only need to write your test cases without worrying about writing the main function.

### Example: Linking a Test with `gtest_main`

In your build system, link your test executable with `gtest_main`:

```cmake
add_executable(example_test example_test.cc)
target_link_libraries(example_test gtest_main)
add_test(NAME example_test COMMAND example_test)
```

Your test executable will automatically initialize and run tests when launched.


## 4. Writing a Custom main() Function

If your test program needs to perform custom setup or teardown beyond what the test fixtures provide, you may write your own `main` function following this pattern:

```cpp
#include <gtest/gtest.h>

int main(int argc, char** argv) {
  testing::InitGoogleTest(&argc, argv);

  // Your custom pre-test setup code here

  return RUN_ALL_TESTS();
}
```

Be sure to call `InitGoogleTest()` before `RUN_ALL_TESTS()`. This ensures proper flag parsing and initialization.


### Using Custom main() with Fixtures

You can execute code before and after all tests run by placing it around the call to `RUN_ALL_TESTS()`.

Example:

```cpp
int main(int argc, char** argv) {
  testing::InitGoogleTest(&argc, argv);

  // Pre-tests initialization
  InitializeDatabase();

  int result = RUN_ALL_TESTS();

  // Post-tests cleanup
  ShutdownDatabase();

  return result;
}
```


## 5. Platform-Specific Entry Points

GoogleTest and GoogleMock provide special initializations for certain platforms:

- **Arduino-like platforms (ESP8266, ESP32, nRF52)**: Use `setup()` and `loop()` functions instead of `main()`.
  ```cpp
  void setup() { testing::InitGoogleTest(); }
  void loop() { RUN_ALL_TESTS(); }
  ```

- **QuRT**: Program entry is `main()` without `argc/argv`.

- **Windows Mobile**: Uses `_tmain()` with appropriate wide-character arguments.

- **Others**: Use the standard `int main(int argc, char** argv)`.


## 6. Best Practices and Guidelines

- **Call `InitGoogleTest()` or `InitGoogleMock()` before `RUN_ALL_TESTS()`**: This is critical for proper initialization.
- **Return the result of `RUN_ALL_TESTS()` from `main()`**: This allows automated systems to recognize test success or failure.
- **Avoid multiple calls to `RUN_ALL_TESTS()` in the same process**: It is unsupported and may cause undefined behavior.
- **Use the provided `gtest_main` or `gmock_main` libraries when possible**: This reduces boilerplate and potential errors.
- **For custom needs, write your own `main()` carefully** following the outlined pattern.


## 7. Code Examples

<CodeGroup>
```cpp
// Basic main function using GoogleTest
#include <gtest/gtest.h>

int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```
```cpp
// GoogleMock main function
#include <gmock/gmock.h>

int main(int argc, char **argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```
```cpp
// Custom main with setup and teardown
#include <gtest/gtest.h>

int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  
  // Custom setup before tests
  SetupResources();
  
  int result = RUN_ALL_TESTS();
  
  // Custom teardown after tests
  CleanupResources();
  
  return result;
}
```
</CodeGroup>


## 8. Troubleshooting Common Issues

- **Failure to initialize flags**: Always call `testing::InitGoogleTest()` or `testing::InitGoogleMock()` with `argc` and `argv` before running tests.
- **Ignoring the return value of `RUN_ALL_TESTS()`**: Make sure to return or properly handle this value; otherwise, test execution systems may misinterpret outcomes.
- **Link errors related to `main()`**: Ensure you link with the appropriate `gtest_main` or `gmock_main` if you don't provide your own `main`.
- **Multiple `RUN_ALL_TESTS()` calls**: Avoid calling this function more than once per process.


## 9. Installation and Build Notes

When building with CMake, you can include GoogleTest and GoogleMock sources and automatically get the main functions:

```cmake
add_subdirectory(googletest)
add_subdirectory(googlemock)

add_executable(your_tests test_main.cc other_tests.cc)
target_link_libraries(your_tests gtest_main gmock_main pthread)
```

Refer to the [GoogleMock CMakeLists.txt](../googlemock/CMakeLists.txt) for details on including tests and linking.


## 10. References and Further Reading

- [GoogleTest Primer](primer.md) — Introduction to writing tests and main setup
- [gtest_main.cc source](googletest/src/gtest_main.cc) — Reference implementation of main for GoogleTest
- [gmock_main.cc source](googlemock/src/gmock_main.cc) — Reference implementation of main for GoogleMock
- [API Reference: Configuration and Test Options](../api-reference/integration-examples/config-options.md) — Advanced test configuration including initialization
- [Getting Started: Project Setup](../getting-started/configuration-first-test/project-setup.md) — How to integrate GoogleTest into your project


---

By following these guidelines, you will ensure that your tests start up correctly, run reliably, and integrate smoothly with build and CI systems.

<Source url="https://github.com/google/googletest" paths={[{"path": "googletest/src/gtest_main.cc", "range": "1-56"},{"path": "googlemock/src/gmock_main.cc", "range": "1-73"}]} />
<Source url="https://github.com/google/googletest" paths={[{"path": "googlemock/CMakeLists.txt", "range": "1-127"}]} />

