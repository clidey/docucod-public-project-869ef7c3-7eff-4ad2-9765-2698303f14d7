---
title: "Specifying Actions & Side Effects"
description: "API documentation for defining custom actions, injecting return values, and simulating side effects in mocks. Covers built-in actions, advanced usage like InvokeArgument, and macro-driven action templates."
---

# Specifying Actions & Side Effects

This documentation page explores how to define the behaviors and side effects of mock methods using GoogleMock's powerful action framework. It covers the built-in actions you can apply to mocks, how to invoke argument callables, combine multiple actions, define custom actions using macros or lambdas, and explains advanced patterns like `InvokeArgument` and macro-driven templates.

---

## What Are Actions?

Actions describe the behavior of a mock method when it is called. Instead of a mock method being a simple stub, actions let you specify what the mocked method should **return**, what **side effects** it should perform, or how it should simulate complex interactions.

You use actions in conjunction with `EXPECT_CALL` or `ON_CALL` to define what happens when a mock method is invoked.

**Example:**

```cpp
using ::testing::Return;

EXPECT_CALL(mock_object, GetNumber())
    .WillOnce(Return(42));  // This mock method returns 42 on the first call.
```

---

## Built-in Actions for Returning Values

GoogleMock includes many built-in actions to return values or simulate method behavior:

| Action                      | Description                                                                |
|----------------------------|----------------------------------------------------------------------------|
| `Return()`                 | For `void` methods, simply returns without doing anything.
| `Return(value)`            | Returns the specified `value` (copy performed at expectation creation).
| `ReturnArg<N>()`           | Returns the N-th argument passed to the method (zero-based).
| `ReturnNew<T>(args...)`    | Returns a new instance of `T` created dynamically with specified args.
| `ReturnNull()`             | Returns `nullptr` for pointer return types.
| `ReturnPointee(ptr)`       | Returns the value pointed to by `ptr`.
| `ReturnRef(variable)`      | Returns a reference to `variable`.
| `ReturnRefOfCopy(value)`   | Returns a reference to a copy of `value` with lifetime tied to action.
| `ReturnRoundRobin({a1, ..., an})` | Returns values from the list cyclically on sequential calls.

```cpp
EXPECT_CALL(mock, GetData())
    .WillOnce(ReturnNew<Data>(size, options));
```

> **Tip:** To return a live-updated value, prefer `ReturnRef()` or `ReturnPointee()` instead of `Return()`.

---

## Built-in Actions for Side Effects

Actions also support simulating side effects on arguments or global state:

| Action                       | Description                                                             |
|-----------------------------|-------------------------------------------------------------------------|
| `Assign(&variable, value)`  | Assigns `value` to `variable`.
| `DeleteArg<N>()`            | Deletes the pointer argument at the N-th position.
| `SaveArg<N>(pointer)`       | Copies the N-th argument to `*pointer`.
| `SaveArgByMove<N>(pointer)` | Moves the N-th argument to `*pointer`.
| `SaveArgPointee<N>(pointer)`| Copies the value pointed to by the N-th argument to `*pointer`.
| `SetArgReferee<N>(value)`  | Sets the referenced value by the N-th argument to `value`.
| `SetArgPointee<N>(value)`  | Sets the pointed-to value by the N-th argument to `value`.
| `SetArrayArgument<N>(first, last)` | Copies elements in the range `[first, last)` to array pointed to by the N-th argument.
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value` (useful for system call mocks).
| `Throw(exception)`           | Throws the given exception.

**Example: Setting an output pointer and returning a value:**

```cpp
using ::testing::DoAll;
using ::testing::Return;
using ::testing::SetArgPointee;

EXPECT_CALL(mock, Compute(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

---

## Combining Multiple Actions

You can combine several actions to run in sequence using `DoAll()`. Only the return value of the last action is returned.

```cpp
using ::testing::DoAll;
using ::testing::Return;
using ::testing::SetArgPointee;

EXPECT_CALL(mock, Func(_))
    .WillOnce(DoAll(
        SetArgPointee<0>(10),  // Side effect: set output argument
        Return(true)          // Return true as function result
    ));
```

Other useful combiners:

- `IgnoreResult(action)`: performs `action` but ignores its return value (useful when adapting return types).
- `WithArg<N>(action)`: passes only the N-th argument to `action`.
- `WithArgs<N1, N2, ..., Nk>(action)`: passes a subset of arguments to `action`.
- `WithoutArgs(action)`: calls `action` without passing any arguments.

---

## Using Callable Objects (Functions, Lambdas, Functors) as Actions

You can specify arbitrary callable objects as actions using `Invoke()` and related helpers.

| Form                                    | Description                                              |
|-----------------------------------------|----------------------------------------------------------|
| `Invoke(f)`                            | Calls `f` with the mock method arguments.
| `Invoke(object, &Class::method)`       | Calls the method on the given object with the arguments.
| `InvokeWithoutArgs(f)`                  | Calls `f()` with no arguments.
| `InvokeWithoutArgs(object, &Class::method)` | Calls the method on object with no arguments.

**Example:**

```cpp
int Add(int x, int y) { return x + y; }

EXPECT_CALL(mock, Sum(_, _))
    .WillOnce(Invoke(Add));
```

If your callable ignores some arguments, declare them as `Unused` for clarity and flexibility.

---

## Invoking a Callable Passed as a Mock Argument: `InvokeArgument` Action

For mock method arguments that are themselves callable (e.g., callbacks), use `InvokeArgument<N>(args...)` to invoke the N-th argument with provided parameters.

```cpp
EXPECT_CALL(mock, DoAsync(_, _))
    .WillOnce(InvokeArgument<1>(42));  // Calls the second argument with 42
```

If the invoked callable expects reference arguments, wrap them in `std::ref()`.

---

## Defining Custom Actions Using Macros

You can define custom actions using `ACTION`, `ACTION_P`, and related macros for succinct reusable behavior definitions:

```cpp
ACTION(IncrementArg0) {
  return ++arg0;
}

EXPECT_CALL(mock, Foo(_))
    .WillOnce(IncrementArg0());
```

Parameterized actions:

```cpp
ACTION_P(MultiplyBy, n) {
  return arg0 * n;
}
EXPECT_CALL(mock, Foo(_))
    .WillOnce(MultiplyBy(10));
```

You can define actions with multiple parameters using `ACTION_P2`, `ACTION_P3`, etc.

> **Tip:** Use `argK`, `argK_type`, `return_type`, and `function_type` inside the macro for detailed control and type safety.

---

## Using the Macro-Driven Action Templates

For advanced use cases, define action templates with explicit compile-time parameters with `ACTION_TEMPLATE`. This allows precise typing and reusable action templates.

Example:

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}
```

Use as:

```cpp
int out;
EXPECT_CALL(mock, Foo).WillOnce(DuplicateArg<1, unsigned char>(&out));
```

---

## Additional Tips & Best Practices

- Define actions for **side effects** (output arguments, state changes) separate from return values.
- Combine `SetArgPointee()` and `Return()` with `DoAll()` for simultaneous result and side effect.
- For move-only types (e.g. `std::unique_ptr`), use lambdas or functors to handle return and argument passing correctly.
- To ignore return values of an action, wrap the action with `IgnoreResult()`, but only for actions that return non-void.
- When mocking methods that take callable arguments, use `InvokeArgument` to test asynchronous or callback-based interfaces.

---

## Troubleshooting Common Issues

- **Compilation errors due to commas in types:** surround complicated return types or argument types with parentheses or use `using` type aliases.
- **Default action used unexpectedly:** if your mock method return type does not have a default value set, remember to configure it using `ON_CALL()` or `DefaultValue<T>::Set()`.
- **Uninteresting call warnings:** adjust mock strictness modes (`NiceMock`, `NaggyMock`, `StrictMock`) or explicitly add `EXPECT_CALL(...).Times(AnyNumber())` for methods called freely.
- **Actions running out:** If you specify fewer actions than expected calls without `WillRepeatedly()`, GoogleMock warns and falls back to default actions.

---

## Example: Simulating a Complex Mock Method Behavior

```cpp
using ::testing::DoAll;
using ::testing::Return;
using ::testing::SetArgPointee;
using ::testing::Invoke;
using ::testing::Unused;

class MockProcessor {
 public:
  MOCK_METHOD(bool, Process,
              (int input, int* output, std::function<void(int)> callback), (override));
};

// Custom action that increments the input and invokes the callback.
ACTION_P(IncrementAndInvoke, callback_value) {
  int result = arg0 + 1;
  arg2(callback_value);
  *arg1 = result;
  return true;
}

// Test usage:
MockProcessor mock;
EXPECT_CALL(mock, Process(_, _, _))
    .WillOnce(IncrementAndInvoke(42));

int output = 0;
int callback_result = 0;
mock.Process(10, &output, [&](int val){ callback_result = val; });
// output == 11
// callback_result == 42
```

---

## Reference Links

- [Actions Reference](actions.md)
- [Mocking Methods & Objects](api-reference/mocking-apis/mocking-methods)
- [Defining Expectations & Behaviors](api-reference/mocking-apis/defining-expectations)
- [gMock Cookbook - Actions & Side Effects](docs/gmock_cook_book.md#Using-Actions)

---

## Summary

This page empowers you to precisely control complex behaviors and side effects for mocked methods using GoogleMock's rich actions framework, blending predefined actions with custom callback invocations and macro-driven templates for reuse and flexibility. Combine these patterns with expectation rules to create robust, expressive, and maintainable mock interactions in your C++ tests.