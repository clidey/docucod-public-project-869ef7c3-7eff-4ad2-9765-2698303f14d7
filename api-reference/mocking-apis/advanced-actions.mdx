---
title: "Advanced & Custom Actions"
description: "Demonstrates advanced mocking capabilities, such as variadic actions, invoking arguments, and composing custom actions to simulate complex behaviors within mock methods."
---

# Advanced & Custom Actions in GoogleMock

This documentation dives into the advanced mocking capabilities of GoogleMock, demonstrating how to leverage powerful actions such as variadic actions, invoking callable arguments, composing multiple actions, and crafting custom actions. These techniques enable developers to simulate and control complex behaviors in mock methods, elevating test precision and expressiveness.

---

## Overview

GoogleMock provides numerous built-in and extensible actions that control what a mock method does when called. While simple usage involves returning fixed values or invoking basic behaviors, advanced scenarios require combining multiple actions, invoking arguments as functions, manipulating arguments directly, or defining custom behavior with templated actions.

This page covers such advanced action techniques beyond the basics, offering practical recipes, code examples, and tips to simulate intricate behaviors within your mock methods with clarity and correctness.

---

## Using Variadic and Composite Actions

### DoAll: Performing Multiple Actions Sequentially

When you need a mock method invocation to perform several side effects or actions in sequence, use `DoAll()`. All actions except the last must return `void`, with the last action providing the mock method's return value.

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;

EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(7), Return(true)));
```

This example sets an output pointed to by argument 0 and then returns `true`. The mock method simulates complex behavior in a single call.

:::tip
- The last action in `DoAll()` dictates the return value.
- The prior actions must return `void`.
- Useful to combine side effect setting and return values in one expectation.
:::

### IgnoreResult: Ignoring an Action's Return Value

Sometimes an action returns a value, but the mock method expects `void`. Wrap the action with `IgnoreResult()` to discard its return value.

```cpp
EXPECT_CALL(mock, VoidFunc())
    .WillOnce(IgnoreResult(Invoke(SomeFunctionReturningInt)));
```

### WithArg and WithArgs: Passing Subsets of Arguments

If your action only needs a subset of the mock method's arguments, use:

- `WithArg<N>(action)` for a single argument.
- `WithArgs<N1, N2, ..., Nk>(action)` for multiple arguments.

They forward only the specified arguments in order.

```cpp
EXPECT_CALL(mock, Foo(_, _, _))
    .WillOnce(WithArgs<0, 2>(Invoke(&Helper::DoSomething)));
```

`Helper::DoSomething` will receive only arguments 0 and 2 of `Foo`.

### WithoutArgs: Invoking an Action with No Arguments

Use `WithoutArgs(action)` to ignore all mock arguments and call an action that takes none.

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(WithoutArgs(Invoke([]() { return 42; })));
```

---

## Invoking Arguments as Callables

Sometimes, a mock method receives a function pointer, functor, or callback as an argument. GoogleMock enables invoking that argument directly.

### InvokeArgument<N>: Calling the N-th Argument as a Callable

```cpp
using ::testing::InvokeArgument;

EXPECT_CALL(mock, StartJob(_, _))
    .WillOnce(InvokeArgument<1>(true)); // Calls the 2nd argument as a callable with 'true'
```

You can pass arguments to the callable. Use `std::ref()` if any parameter is a reference type.

:::note
- The callable argument can be a function pointer, functor, or callback.
- Arguments are passed by value unless wrapped with `std::ref()`.
- Supports any callable arity.
:::

---

## Custom Actions

When built-in actions or compositions donâ€™t fit your needs, you can define your own actions.

### Defining Custom Actions Using ACTION Macros

Use `ACTION`, `ACTION_P`, and `ACTION_Pk` macros to create named actions with zero or multiple parameters.

```cpp
// Simple action returning the sum of first two args
ACTION(SumArgs) {
  return arg0 + arg1;
}

// Parameterized action adding a fixed value
ACTION_P(Add, n) {
  return arg0 + n;
}

EXPECT_CALL(mock, Calculate(5))
    .WillOnce(SumArgs());
EXPECT_CALL(mock, Calculate(3))
    .WillOnce(Add(10));
```

:::tip
- Inside `ACTION` definitions, `argK` refer to the k-th argument.
- `argK_type`, `args`, `args_type`, `return_type`, and `function_type` provide contextual type information.
- You can define actions with rich logic, including side effects.
:::

### Defining Parameterized and Template Actions

For advanced templates and generic actions, use `ACTION_TEMPLATE`, which enables specifying explicit template parameters and value parameters.

Example:

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(DuplicateArg<1, unsigned char>(&result));
```

This pattern is powerful for type-safe, reusable actions.

---

## Specialized Built-in Actions

Beyond basic Return and Invoke, GoogleMock provides utilities to manipulate arguments and simulate side effects:

- `SetArgPointee<N>(value)`: Assign value to the variable pointed to by the N-th argument.
- `SaveArg<N>(pointer)`: Saves a copy of the N-th argument.
- `SaveArgByMove<N>(pointer)`: Moves the N-th argument.
- `DeleteArg<N>()`: Deletes the N-th argument pointer.

These are useful when mocking methods that modify output parameters or own pointers.

Example:

```cpp
EXPECT_CALL(mock, FillBuffer(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

---

## Combining Actions for Complex Behaviors

### Sequence of Actions

The `WillOnce()` can appear multiple times to specify actions for successive calls.

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

This sets return values 1 and 2 for the first two calls and 3 thereafter.

### Partial Ordering and Sequences

Use `InSequence` and `After` to ensure expectations enforce ordering among calls. Refer to [Expectations & Actions](../mocking-apis/expectations-actions) for details.

---

## Best Practices and Tips

- Prefer `ON_CALL` for default behaviors, and `EXPECT_CALL` for verifying calls.
- Use `NiceMock` or `StrictMock` to control warnings & failures on unexpected calls.
- Carefully control argument matcher specificity to avoid brittle tests.
- Use `RetiresOnSaturation()` when you want expectations to retire automatically.
- Use `Invoke()` and related patterns to call existing functions or methods dynamically.
- Extend with custom actions for sophisticated mocking requirements.

---

## Troubleshooting

- If you get warnings about uninteresting calls, consider if you need to add expectations or suppress with `NiceMock`.
- When actions involve move-only types, prefer lambdas or functors over `Return`.
- In complex call ordering, use `InSequence` and `After` to model partial orders.
- Ensure mock methods are declared in `public:` sections and are virtual.
- Use `--gmock_verbose=info` to see verbose call traces if expectations don't behave as intended.

---

## Further Reading

- [Creating Mock Classes and Setting Expectations](/guides/mocking-techniques/mock-classes-expectations)
- [Responding with Actions and Advanced Matchers](/guides/mocking-techniques/working-with-actions-matchers)
- [Matchers in Mocks](/api-reference/mocking-apis/matchers)
- [Expectations & Actions Reference](/api-reference/mocking-apis/expectations-actions)
- [Mock Behaviors: Strict, Nice, Naggy](/api-reference/mocking-apis/mock-behaviors)

---

## Example: Using Advanced Actions in a Mock

```cpp
class Foo {
 public:
  virtual int Compute(int x, std::function<int(int)> callback) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Compute, (int x, std::function<int(int)> callback), (override));
};

TEST(FooTest, ComplexBehavior) {
  MockFoo mock;

  // Delegate to callback with argument 10
  EXPECT_CALL(mock, Compute(_, _))
      .WillOnce(InvokeArgument<1>(10));

  EXPECT_EQ(42, mock.Compute(5, [](int val) { return 42; }));
}
```

This tests that `Compute` invokes the callback correctly, simulating complex interaction.
