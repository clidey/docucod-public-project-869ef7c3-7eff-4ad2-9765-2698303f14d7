---
title: "Actions & Return Values"
description: "Full reference to actions in GoogleMock, allowing users to dictate what happens when mocked methods are called. Covers built-in actions, ACTION/ACTION_TEMPLATE macros, value returns, and advanced action composition."
---

# Actions & Return Values

Comprehensive reference to **actions** in GoogleMock, enabling users to specify what happens when mocked methods are called. This document details built-in actions, legacy and modern action macros (`ACTION`, `ACTION_TEMPLATE`), returning values, side effects, function invocation as actions, and advanced action composition.

---

## 1. Overview of Actions in GoogleMock

In GoogleMock, **actions** define the behavior a mocked method should perform when invoked. Instead of just verifying that calls happen with expected arguments, actions let you control the method's effects—such as returning specific values, modifying arguments, throwing exceptions, or invoking callbacks.

Users configure actions primarily via `EXPECT_CALL(...).WillOnce()` and `WillRepeatedly()`, or by setting defaults with `ON_CALL(...).WillByDefault()`.

**Key points:**

- Actions drive what the mock method *does* when called.
- Multiple actions can be chained via `WillOnce()` to specify sequential behavior.
- Built-in actions cover common needs like returning values, deleting pointer arguments, or invoking custom callables.

GoogleMock also supports advanced constructs for combining actions (`DoAll()`, `IgnoreResult()`, `WithArg()`, etc.), defining custom actions using `ACTION` macros or C++ callable objects, and polymorphic actions for type flexibility.

---

## 2. Returning Values from Mock Methods

GoogleMock offers a variety of actions to return values from mocked methods, adapting to many scenarios common in testing.

### Common return actions:

| Action                  | Description  |
|------------------------|--------------|
| `Return()`             | Returns from a `void` mock method immediately.
| `Return(value)`        | Returns a specific value. Conversion to the return type occurs when the action is set, not on each call.
| `ReturnRef(variable)`  | Returns a reference to the specified variable. Useful for functions returning references.
| `ReturnRefOfCopy(value)`| Returns a reference to a copy of the provided value. The copy persists as long as the action.
| `ReturnPointee(ptr)`   | Returns the value pointed to by a pointer at call time — useful when the pointed content can vary.
| `ReturnNew<T>(args...)`| Returns a pointer to a newly allocated `T` constructed with the given arguments. A new object is created on each call.
| `ReturnNull()`         | Returns a null pointer.
| `ReturnRoundRobin({a1, ..., an})` | Cycles through returning listed values in order on each call, looping back after the end.

### Usage example:
```cpp
EXPECT_CALL(mock_obj, GetCount())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(10));
```
This sets the return of `GetCount()` to 1, then 2, then always 10 for subsequent calls.

### Important considerations:
- `Return(value)` converts the `value` once at expectation setup time — changing the original variable later won't affect returned values.
- Use `ReturnPointee(ptr)` or `ReturnRef()` to reflect the live value or reference.
- For returning references, **always** use `ReturnRef()` or `ReturnRefOfCopy()`.

---

## 3. Built-in Side Effect Actions

GoogleMock provides a rich set of built-in actions to support common side-effects on mock method arguments.

| Action                   | Description                                   |
|-------------------------|-----------------------------------------------|
| `Assign(&var, value)`    | Assigns `value` to the referenced variable `var`.
| `DeleteArg<N>()`         | Deletes the Nth (zero-indexed) argument pointer.
| `SaveArg<N>(ptr)`        | Saves the Nth argument by copy to `*ptr`.
| `SaveArgByMove<N>(ptr)`  | Moves the Nth argument into `*ptr`.
| `SaveArgPointee<N>(ptr)` | Saves the value pointed to by the Nth argument pointer.
| `SetArgReferee<N>(value)`| Assigns `value` to the variable referenced by the Nth argument.
| `SetArgPointee<N>(value)`| Assigns `value` to the variable pointed to by the Nth argument.
| `SetArrayArgument<N>(first, last)` | Copies a range of elements to the array pointed to by the Nth argument.
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value`.
| `Throw(exception)`        | Throws the specified exception value (must be copyable).

### Example:
```cpp
EXPECT_CALL(mock, MutateData(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```
Sets the pointed-to value of argument 0 to 42 and returns true.

---

## 4. Using Callables and Functions as Actions

If the built-in actions don't cover your needs, you can use functions, lambdas, functors, or callable objects as actions.

### Supported forms:

- Plain callable: `WillOnce(&MyFunction);`
- `Invoke(callable)`: Wraps a callable and calls it with the mock method's actual arguments.
- `Invoke(object_ptr, &Class::Method)`: Calls a method on an object.
- `InvokeWithoutArgs(callable)`: Calls a callable without passing mock method arguments.
- `InvokeArgument<N>(args...)`: Invokes the Nth argument (which must be callable) with specified arguments.

Example with lambda:
```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce([](int x) { return x * 2; });
```

Example invoking callback argument:
```cpp
EXPECT_CALL(mock, DoWork(_, _))
    .WillOnce(InvokeArgument<1>(true));  // Invokes 2nd argument as callback with `true`.
```

### Note:
- You can declare unused parameters with the special `Unused` type.
- `Invoke` actions own the callable and manage its lifetime.

---

## 5. Composite Actions

GoogleMock allows combining multiple actions into a single composite action:

| Action                   | Description                                   |
|--------------------------|-----------------------------------------------|
| `DoAll(a1, a2, ..., an)` | Performs all actions in sequence; returns the last one's result. The first `n-1` must return void.
| `IgnoreResult(a)`        | Executes action `a` but discards its return value.
| `WithArg<N>(a)`          | Passes the Nth argument of the mock to action `a`.
| `WithArgs<N1, N2, ..., Nk>(a)` | Passes selected arguments to action `a`.
| `WithoutArgs(a)`         | Executes action `a` without any arguments.

Example:
```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

Example reordering arguments:
```cpp
EXPECT_CALL(mock, Foo(_, _, _))
    .WillOnce(WithArgs<2, 0>(Invoke(&SomeFunction)));
```

---

## 6. Defining Custom Actions

To implement behavior not covered by built-in actions or simple callables, you can define custom actions.

### Modern way: Using lambda or callable objects

Write a callable with a call operator compatible with the mock function signature:
```cpp
EXPECT_CALL(mock, Fn(_)).WillOnce([](int x) { return x + 1; });
```

### Legacy macro-based actions (`ACTION` macros)

For simple custom actions, GoogleMock offers legacy macros to generate actions:
- `ACTION(name)`: Defines an action with zero parameters.
- `ACTION_P(name, param)`: Parameterized action with one parameter.
- `ACTION_Pk(name, p1, ..., pk)`: Parameterized actions with multiple parameters.
- `ACTION_TEMPLATE` for template parameterized actions.

Example:
```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}
EXPECT_CALL(mock, DoSomething()).WillOnce(IncrementArg1());
```

Inside the body:
- `argN` refers to the Nth function argument (0-based).
- `args` is the tuple of all arguments.
- `return_type` is the mock function's return type.

### Advanced custom actions

You can implement the `ActionInterface` interface directly for full control, supporting polymorphic or monomorphic actions with `MakePolymorphicAction()`.

---

## 7. Advanced Topics

### Returning move-only types

GoogleMock supports returning move-only types (e.g., `std::unique_ptr`) via:
- Lambdas or functors that produce fresh values on each call.
- `Return(ByMove(std::move(obj)))` for `WillOnce`.

A `Return` wrapping a moved value cannot be used with `WillRepeatedly`.

### Behavior for multiple `WillOnce` and `WillRepeatedly`

- The first call uses the first `WillOnce()` action, the second call uses the second, and so on.
- When the `WillOnce()` list is exhausted, `WillRepeatedly()` action is used for all further calls.
- If no `WillRepeatedly()` action is provided, the default action executes after `WillOnce()`s are exhausted.

### Sticky expectations and `RetiresOnSaturation()`

Expectations are sticky by default—they remain active after their expected call count.

Use `.RetiresOnSaturation()` on expectations to deactivate them automatically after their expected number of calls, allowing subsequent expectations to be matched.

### Parallel calls & threads

gMock supports safe concurrent calling of mock methods.

Ensure that expectation setup and teardown happen without concurrent access.

Actions are executed on the calling thread.

### Error & warning modes

Actions help in debugging unexpected calls or argument mismatches. Use flags like `--gmock_verbose=info` to get detailed tracing of mock calls.

---

## 8. Practical Tips & Common Pitfalls

- Wrap complex argument types with extra parentheses in `MOCK_METHOD` to avoid macro parsing errors.
- Use `ReturnRef()` instead of `Return()` for functions returning references.
- Use `ON_CALL` to set default action behavior that applies when no expectations are set, and `EXPECT_CALL` to also set expectations.
- Remember newer `EXPECT_CALL`s take precedence over older ones; order your calls accordingly.
- For multiple `WillOnce`, use `.RetiresOnSaturation()` to have expectations retire automatically.
- To chain multiple actions that have side effects, use `DoAll()`.
- Invoke callable arguments safely with `InvokeArgument<N>(...)` wrapping params that require reference passing with `std::ref()` if needed.
- Control warnings on uninteresting calls with `NiceMock` and errors with `StrictMock`.

---

## 9. Key Examples

### Returning a sequence of values:
```cpp
EXPECT_CALL(mock, GetId())
    .WillOnce(Return(123))
    .WillOnce(Return(456))
    .WillRepeatedly(Return(789));
```

### Returning live pointee values:
```cpp
int live_value = 10;
EXPECT_CALL(mock, GetValue())
    .WillRepeatedly(ReturnPointee(&live_value));
live_value = 20;
EXPECT_EQ(mock.GetValue(), 20);
```

### Combining side effect with return:
```cpp
EXPECT_CALL(mock, SetFlag(_))
    .WillOnce(DoAll(SetArgPointee<0>(true), Return(true)));
```

### Invoking a callback argument:
```cpp
EXPECT_CALL(mock, AsyncRun(_, _))
    .WillOnce(InvokeArgument<1>(42));  // invoke 2nd arg as callback with 42
```

### Defining a simple custom action:
```cpp
ACTION(DoubleValue) {
  return arg0 * 2;
}
EXPECT_CALL(mock, Compute(_)).WillOnce(DoubleValue());
```

### Using `DoAll()` to execute multiple actions:
```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(DoAll(SaveArg<0>(&saved_data), Return(true)));
```

---

For extensive usage guidance, best practices, and advanced workflows, see:
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)

<Source url="https://github.com/google/googletest" paths={[{"path": "googlemock/include/gmock/gmock-actions.h", "range": "1-500"},{"path": "googlemock/include/gmock/gmock-more-actions.h", "range": "1-150"}]} />
