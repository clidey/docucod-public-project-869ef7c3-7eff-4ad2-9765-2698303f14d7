---
title: "Actions and Expectations"
description: "Documents the system for defining expectations on mock method calls, stipulating call counts (cardinalities), sequencing, actions (returning values, invoking callbacks, throwing exceptions), and verification. Includes coverage of built-in and custom actions."
---

# Actions and Expectations

This reference page details the system GoogleTest uses to define and manage mocking behaviors: setting expectations on mock method calls, specifying how often such calls should happen (cardinalities), the order of calls (sequencing), actions performed on calls (such as returning values, invoking callbacks, or throwing exceptions), and verifying that all expectations are met in tests. It includes both the built-in actions provided by GoogleTest and guidance on defining custom actions.

---

## Overview

When writing tests with mock objects, your primary goal is to control and verify how these mocked methods behave during execution. GoogleTest's mocking framework offers a powerful, expressive set of tools to specify:

- **Expectations**: When and how often a mock method should be called.
- **Actions**: What a mock method should do when called (return a value, modify arguments, invoke a callable, etc).
- **Ordering**: Constraints that specify the sequence in which mock calls should occur.
- **Verification**: Automatic or manual checks that ensure expectations are satisfied.

This page documents those facilities, empowering you to write precise and maintainable tests.

---

## Setting Expectations on Mock Methods

You use `EXPECT_CALL` to specify the calls you expect your mock method to receive.

### Basic Syntax

```cpp
EXPECT_CALL(mock_obj, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action)
    .InSequence(sequences...)
    .After(expectations...)
    .RetiresOnSaturation();
```

- **mock_obj** is your mock object.
- **MethodName** is the mock method.
- **matchers** defines the expected arguments (use `_` to allow anything).

The clauses modify and refine expectations, each with specific rules on usage and order.

### Cardinalities (How many times to expect calls)

Controls how many calls matching the expectation should occur.

| Cardinality                | Meaning                             |
|----------------------------|-----------------------------------|
| `AnyNumber()`              | Zero or more times.                 |
| `AtLeast(n)`               | At least n times.                  |
| `AtMost(n)`                | At most n times.                   |
| `Between(m, n)`            | Between m and n (inclusive).      |
| `Exactly(n)` or just `n`   | Exactly n times (0 means must not be called). |

If `Times()` is omitted, GoogleTest infers it from the presence of `WillOnce()` and `WillRepeatedly()`, defaulting usually to one call.

### Ordering Calls

By default, calls don't have to match the order expectations are declared in. To impose order:

- Use `.InSequence(seq1, seq2, ...)` to require calls occur in the order of expectations assigned to the same sequence.
- Use `.After(expectation1, expectation2, ...)` to require calls occur after other specified calls, allowing for partial ordering.

```cpp
using ::testing::Sequence;
Sequence s1, s2;

EXPECT_CALL(mock, Reset())
    .InSequence(s1, s2);
EXPECT_CALL(mock, Step1())
    .InSequence(s1);
EXPECT_CALL(mock, Step2())
    .InSequence(s2);
```

### Retiring Expectations

`.RetiresOnSaturation()` makes an expectation become inactive after it has been fulfilled (saturated). This helps avoid later calls erroneously matching already-used expectations.

---

## Actions: What Mock Methods Do When Called

Actions describe how mocked methods respond upon invocation. GoogleTest includes a rich set of built-in actions grouped by their behavior.

### Returning Values

| Action                              | Description                                                                                             |
|------------------------------------|-----------------------------------------------------------------------------------------------------|
| `Return()`                         | For `void` functions, returns (does nothing).                                                        |
| `Return(value)`                    | Returns `value`. The value is converted to the expected return type when the expectation is set.     |
| `ReturnArg<N>()`                   | Returns the N-th argument of the function (0-based).                                                 |
| `ReturnNew<T>(args...)`            | Returns a new heap-allocated object created with `new T(args...)` each call.                         |
| `ReturnNull()`                     | Returns a null pointer.                                                                              |
| `ReturnPointee(ptr)`               | Returns the value pointed to by `ptr` at the time of invocation.                                     |
| `ReturnRef(variable)`              | Returns a reference to `variable`.
| `ReturnRefOfCopy(value)`           | Returns a reference to a copy of `value`.
| `ReturnRoundRobin({a1, ..., aN})` | Returns elements in round-robin fashion cycling through the list.                                   |

### Performing Side Effects

| Action                          | Description                                                                              |
|--------------------------------|------------------------------------------------------------------------------------------|
| `Assign(&variable, value)`      | Assigns `value` to `variable`.                                                           |
| `DeleteArg<N>()`                | Deletes the pointer passed as the N-th argument.                                         |
| `SaveArg<N>(pointer)`           | Saves the N-th argument to location pointed by `pointer` via copy-assignment.            |
| `SaveArgByMove<N>(pointer)`     | Saves the N-th argument by move-assignment to `pointer`.                                |
| `SaveArgPointee<N>(pointer)`    | Saves the value pointed by the N-th argument to `pointer`.                              |
| `SetArgReferee<N>(value)`       | Sets the variable referenced by the N-th argument to `value`.                            |
| `SetArgPointee<N>(value)`       | Assigns `value` to the object pointed by the N-th argument.                              |
| `SetArrayArgument<N>(first, last)` | Copies elements from `[first, last)` to the array pointed by the N-th arg (pointer or iterator). |
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value`.                                            |
| `Throw(exception)`              | Throws copyable `exception` (available since v1.1.0).                                   |

### Using Functions, Functors, or Lambdas as Actions

You can specify a callable that is invoked when the mock function is called.

| Action                                    | Description                                                                                      |
|-------------------------------------------|------------------------------------------------------------------------------------------------|
| `f`                                       | Calls callable `f` with the mock function arguments.                                            |
| `Invoke(f)`                               | Invokes a global/static function or functor `f`.                                               |
| `Invoke(ptr, &Class::Method)`             | Invokes the method on the object at `ptr`.                                                     |
| `InvokeWithoutArgs(f)`                     | Invokes function `f` with no arguments.                                                        |
| `InvokeWithoutArgs(ptr, &Class::Method)` | Invokes the method taking no arguments on object `ptr`.                                        |
| `InvokeArgument<N>(args...)`              | Invokes the callable provided as argument `N` to the mock method with arguments `args...`.    |

> **Tip:** If a callable has unused parameters, declare them as `Unused` to avoid compiler errors.

### Composite Actions

Actions can be combined or modified:

| Action                      | Description                                                                                           |
|-----------------------------|-----------------------------------------------------------------------------------------------------|
| `DoAll(a1, a2, ..., aN)`     | Performs all specified actions sequentially; returns the result of the last one.                     |
| `IgnoreResult(a)`            | Performs action `a` but ignores its result.                                                          |
| `WithArg<N>(a)`              | Passes the N-th argument of the mock function to action `a`.                                         |
| `WithArgs<N1, N2, ..., Nk>(a)` | Passes the selected arguments of the mock function to action `a`.                                  |
| `WithoutArgs(a)`              | Performs action `a` without passing any arguments.                                                  |

---

## Defining Custom Actions

GoogleTest supports defining custom actions for advanced use cases:

### Macro-Based Actions

Pre-C++11 code can define actions using `ACTION` macros:

```cpp
ACTION(MyAction) {
  // Use arg0, arg1, ... for arguments.
  return arg0 + arg1;
}
```

Parameterized versions like `ACTION_P` and `ACTION_Pk` support parameters.


### Functor or Lambda-Based Actions

You can also define custom actions using any callable (including lambdas or functor objects) compatible with the mock function signature.

```cpp
EXPECT_CALL(mock, Func(_))
    .WillOnce([](int x) { return x * 2; });
```

### Polymorphic Actions

For actions usable across multiple mock function types, implement a class with a templated `Perform()` method and wrap it using `MakePolymorphicAction()`.

### Action Interface Implementation

For precise control, implement `::testing::ActionInterface<F>`, where `F` matches the mock function signature.

---

## Default Actions vs. Expectation-Specific Actions

- `ON_CALL(mock, Method(matchers)).WillByDefault(action)` sets the default action for matching calls but does **not** set an expectation that the call must happen.
- `EXPECT_CALL(mock, Method(matchers))` both sets an expectation and optionally specifies the action.

If an `EXPECT_CALL` matches a call, its action supersedes the corresponding `ON_CALL` default action.

---

## Best Practices and Practical Tips

- **Use `ON_CALL` to define default behavior** whenever you don't necessarily want to verify that a call occurs.
- **Use `EXPECT_CALL` to verify that calls happen a certain number of times with specific arguments.**
- **Combine actions like `DoAll` to achieve complex behaviors**, such as setting output parameters and returning a value in one call.
- **Use sequences and ordering modifiers (`InSequence`, `After`) to verify call order** where important.
- **Avoid overconstraining tests with overly strict expectations**; use `NiceMock` if you want to suppress warnings about uninteresting calls.
- **Use `RetiresOnSaturation` for expectations that should become inactive after fulfilled** to avoid upper-bound violations unexpectedly.

---

## Troubleshooting Common Issues

- **Uninteresting Call Warnings:** By default, gMock warns when a mock function is called without an `EXPECT_CALL`. Use `ON_CALL` defaults or `NiceMock` to suppress if expected.
- **Upper Bound Violations:** Occur if mocked methods are called more times than expected. Use `RetiresOnSaturation` where appropriate.
- **Incorrect Ordering Errors:** Use explicit sequences or `.After()` to specify ordering constraints.
- **Return Value Issues:** Remember `Return(value)` copies `value` at expectation time, not execution time. Use `ReturnPointee(&var)` to return the current value.

---

## Example: Defining an Expectation with Actions

```cpp
using ::testing::Return;
using ::testing::DoAll;
using ::testing::SetArgPointee;

EXPECT_CALL(mock, Process(_))
    .Times(3)
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)))
    .WillRepeatedly(Return(false));
```

Here, the first call assigns 10 to the first argument pointed location and returns `true`. Subsequent calls return `false`.

---

## Summary

This page offers a comprehensive guide to:

- Declaring Expectations (`EXPECT_CALL` and modifiers)
- Setting default behaviors (`ON_CALL`)
- Using and combining Actions
- Defining custom actions
- Managing call order and sequencing
- Verification and diagnostics

For more detailed recipes and nuances, see the associated [gMock Cookbook](../gmock_cook_book.md) and [Mocking Reference](mocking.md).

---

<AccordionGroup title="Quick Reference - Built-In Actions">
<Accordion title="Returning Values">
- `Return(value)` - Return a pre-defined value.
- `ReturnArg<N>()` - Return the N-th argument.
- `ReturnNew<T>(args...)` - Return a new instance of T.
- `ReturnNull()` - Return null pointer.
- `ReturnPointee(ptr)` - Return value pointed by ptr at invocation time.
- `ReturnRef(variable)` - Return reference to variable.
</Accordion>
<Accordion title="Side Effects">
- `Assign(&var, value)` - Assign value to var.
- `DeleteArg<N>()` - Delete N-th argument (pointer).
- `SaveArg<N>(ptr)` - Copy N-th argument to *ptr.
- `SetArgPointee<N>(value)` - Set *N-th pointer argument to value.
- `Throw(exception)` - Throw exception.
</Accordion>
<Accordion title="Composite Actions">
- `DoAll(a1, a2, ..., aN)` - Perform all actions, returning last one’s result.
- `IgnoreResult(a)` - Perform action but ignore return value.
- `WithArg<N>(a)` - Pass the N-th argument to action a.
</Accordion>
</AccordionGroup>

---

## Code Example: Using Invoke and InvokeArgument

```cpp
using ::testing::Invoke;
using ::testing::InvokeArgument;

int HelperFunction(int x, int y) { return x + y; }

EXPECT_CALL(mock, Compute(_, _))
    .WillOnce(Invoke(HelperFunction))
    .WillOnce(InvokeArgument<1>(5));

// First call: Calls HelperFunction(arg0, arg1)
// Second call: Invokes callable argument #1 with argument 5
```

---

## Verification and Test Termination

GoogleMock verifies that all expectations are met when the mock object is destroyed. You can force verification earlier:

```cpp
using ::testing::Mock;

Mock::VerifyAndClearExpectations(&mock_obj);
```

If a mock object is leaked (not deleted), expectations won't be verified unless you call `Mock::AllowLeak()`.

---

## Related Documentation

- [Mocking Reference](mocking.md): Declaration of mocks and expectations.
- [Actions Reference](actions.md): Details of built-in and user-defined actions.
- [gMock Cookbook](gmock_cook_book.md): Recipes and advanced usage.
- [Matchers Reference](argument-matchers.md): Argument matching details.

---

## Summary Diagram

```mermaid
flowchart TD
  ExpectationDef["Define EXPECT_CALL(mock, Method(args)) with matchers"] --> Cardinality["Specify cardinality .Times() or inferred"]
  Cardinality --> Actions["Specify actions .WillOnce(), .WillRepeatedly()"]
  Actions --> Order["Specify order with .InSequence() or .After()"]
  Order --> Verification["GoogleMock verifies expectations on mock destruction or explicitly"]

  subgraph ActionsDetails
    Return["Return()"]
    SideEffect["SetArgPointee(), Assign(), Throw(), etc."]
    InvokeCall["Invoke(), InvokeArgument(), Lambda"]
    Composite["DoAll(), IgnoreResult(), WithArg()"]
    Return --> Actions
    SideEffect --> Actions
    InvokeCall --> Actions
    Composite --> Actions
  end

  Verification --> TestOutcome["Test pass/fail based on expectations"]

  classDef key fill:#f96,stroke:#333,stroke-width:1px,color:#fff;
  ExpectationDef,Cardinality,Actions,Order,Verification key;
```
