---
title: "Actions"
description: "Documents the Actions API, detailing the specification of default and per-call behaviors for mock methods. Includes reusable action templates and advanced constructs such as custom action macros, variadic actions, and invoking callable arguments."
---

# Actions API Reference

The Actions API defines how mock methods behave in GoogleMock. It encompasses the specification of default actions, per-call behaviors, and advanced action constructs to customize the response and side effects of mock methods. This page presents reusable action templates, explains advanced features like custom action macros, variadic actions, and illustrates how to invoke callable arguments in mocks.

---

## 1. Introduction to Actions in GoogleMock

A mock method by itself only declares the interface; actions define its behavior when invoked during tests. Actions determine what a mock method does — such as returning values, modifying arguments, calling callbacks, or throwing exceptions.

This API allows you to precisely express how mock methods behave by setting default behaviors and custom behaviors per invocation. Understanding actions is essential to unlock the full power of GoogleMock, enabling tests that simulate diverse interaction patterns and complex side effects.

---

## 2. Setting Default Actions with `ON_CALL`

GoogleMock provides a built-in default action for mock methods based on the return type:

- `void` methods do nothing.
- Numeric types return zero.
- `bool` returns `false`.
- Pointers return `nullptr`.
- Default-constructible types return a default-constructed value.

You can customize the default action of a mock method using `ON_CALL`.

```cpp
ON_CALL(mock_object, Method(args...))
    .WillByDefault(Return(custom_value));
```

### Key points:
- Default actions take effect for uninteresting calls (calls with no explicit expectation).
- They don't set expectations about the method call count.
- When multiple `ON_CALL`s match a call, the newest matching action takes precedence.

### Example:

```cpp
using ::testing::Return;

ON_CALL(foo, GetSize())
    .WillByDefault(Return(42));
```

If no `EXPECT_CALL` overrides this, calling `foo.GetSize()` returns 42.

---

## 3. Specifying Behaviors per Call with `EXPECT_CALL`

Using `EXPECT_CALL`, you specify expectations on mock method invocations, including the sequence and number of calls, expected arguments, and actions performed when calls occur.

```cpp
EXPECT_CALL(mock_object, Method(args...))
    .WillOnce(Return(value1))  // first matching call returns value1
    .WillOnce(Return(value2))  // second matching call returns value2
    .WillRepeatedly(Return(value_default));  // all further calls
```

### Important notes:
- `WillOnce()` actions are used sequentially for each matching call.
- `WillRepeatedly()` provides behavior after all `WillOnce()` actions are consumed.
- If no action is specified, the default action for the return type is used.

---

## 4. Common Built-in Actions

GoogleMock offers a broad set of pre-defined actions to cover typical use cases for managing mocked behaviors.

### Returning Values

| Action                       | Description                                                                                   |
|-----------------------------|-----------------------------------------------------------------------------------------------|
| `Return()`                  | Returns from a `void` mock method.                                                            |
| `Return(value)`             | Returns `value`. The conversion occurs at expectation setup time, not runtime.                 |
| `ReturnArg<N>()`            | Returns the `N`-th argument of the method call.                                               |
| `ReturnNew<T>(args...)`     | Creates a new object with `new T(args...)` on each call and returns it.                        |
| `ReturnNull()`              | Returns a null pointer.                                                                        |
| `ReturnPointee(ptr)`        | Returns the value pointed to by `ptr`.                                                        |
| `ReturnRef(variable)`       | Returns a reference to the specified variable.                                                |
| `ReturnRefOfCopy(value)`    | Returns a reference to a stored copy of `value`.                                             |
| `ReturnRoundRobin({vals})` | Cycles through the list `{vals}`, returning each in turn on consecutive calls.                 |

### Side Effects

| Action                         | Description                                                                                   |
|-------------------------------|-----------------------------------------------------------------------------------------------|
| `Assign(&var, value)`          | Assigns `value` to `var` when the mock method is called.                                      |
| `DeleteArg<N>()`               | Deletes the pointer passed as the `N`-th argument.                                           |
| `SaveArg<N>(pointer)`          | Copies the `N`-th argument into the pointed-to `*pointer`.                                   |
| `SaveArgByMove<N>(pointer)`    | Moves the `N`-th argument into `*pointer`.                                                   |
| `SaveArgPointee<N>(pointer)`   | Copies the pointee (value) of the `N`-th pointer argument into `*pointer`.                    |
| `SetArgReferee<N>(value)`     | Assigns `value` to the variable referred to by the `N`-th argument.                           |
| `SetArgPointee<N>(value)`     | Assigns `value` to the variable pointed to by the `N`-th argument.                           |
| `SetArrayArgument<N>(first, last)` | Copies elements in the range `[first, last)` to the array pointed to by the `N`-th argument.|
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value`.                                               |
| `Throw(exception)`             | Throws the given exception when the mock method is invoked.                                   |

### Using Function Objects, Lambdas, or Functors

You can also specify any callable object compatible with the mock method signature as an action.

Examples:

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce([](int x) { return x + 1; });
EXPECT_CALL(mock, Bar()).WillOnce(Invoke(some_function));
EXPECT_CALL(mock, Baz()).WillOnce(Invoke(&obj, &MyClass::Method));
```

### Special Invocation Actions

| Action                    | Description                                                                                 |
|--------------------------|---------------------------------------------------------------------------------------------|
| `InvokeWithoutArgs(f)`    | Invokes callable `f` without passing the mock method's arguments.                           |
| `InvokeArgument<N>(args...)` | Invokes the mock method's `N`-th argument (callable) passing the given `args...`.          |

> **Tip:** When the callable argument accepts parameters by reference and you want to pass references, wrap the argument in `std::ref()`.

---

## 5. Composite Actions

Composite actions combine multiple simpler actions into one sequence when the mock method is called.

| Action                         | Description                                                                                         |
|-------------------------------|---------------------------------------------------------------------------------------------------|
| `DoAll(a1, ..., an)`           | Performs all actions `a1` through `an` in sequence; returns the result of `an`. The first `n-1` actions must return `void` and will receive a const view of arguments. |
| `IgnoreResult(action)`         | Executes `action` but ignores its return value; useful when the mock method returns `void`.      |
| `WithArg<N>(action)`           | Passes the `N`-th argument of the mock call to `action` and performs it.                         |
| `WithArgs<N1, ..., Nk>(action)` | Passes selected arguments by indices to `action`.                                               |
| `WithoutArgs(action)`          | Executes `action` without any arguments.                                                        |

**Example combining actions:**

```cpp
EXPECT_CALL(mock, DoStuff(_))
    .WillOnce(DoAll(
        SetArgPointee<0>(5),  // sets *arg0 to 5
        Return(true)          // then returns true
    ));
```

> **Note:** `DoDefault()` triggers the default action (defined by `ON_CALL` or built-in). It **cannot** be used inside composite actions.

---

## 6. Defining Custom Actions

When built-in actions don’t meet your needs, you can define your own:

- **Using Lambda or Functor** — implement a callable with the appropriate signature.

  ```cpp
  EXPECT_CALL(mock, Method(_))
      .WillOnce([](int x) { return x * 2; });
  ```

- **Using `ACTION` Macros** — legacy macro-based action definitions.

  ```cpp
  ACTION(DoubleArg) { return arg0 * 2; }
  EXPECT_CALL(mock, Method(_)).WillOnce(DoubleArg());
  ```

- **Using ActionInterface** — define a class implementing `Perform()` method for more control and reusability.

  ```cpp
  class MultiplyByAction : public ActionInterface<int(int)> {
   public:
    int Perform(const std::tuple<int>& args) override {
      return std::get<0>(args) * factor_;
    }

    explicit MultiplyByAction(int factor) : factor_(factor) {}
   private:
    int factor_;
  };

  Action<int(int)> MultiplyBy(int factor) {
    return MakeAction(new MultiplyByAction(factor));
  }
  ```

- **Polymorphic Actions** — use `MakePolymorphicAction()` to define actions usable with multiple mock method types.

  Useful for generic behaviors, e.g., `ReturnSecondArgument()`.

---

## 7. Advanced Constructs

### Variadic Actions

GoogleMock supports defining actions that accept a variable number of template parameters and arguments using `ACTION_TEMPLATE`.

This is useful when you want fine-grained control over how parameters are handled and passed to your action.

Example:

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

int n;
EXPECT_CALL(mock, Foo(_, _)).WillOnce(DuplicateArg<1, unsigned char>(&n));
```

### Invoking Callable Arguments

When a mock method receives a callable (function pointer, functor, or callback) as an argument, and you want your mock to invoke that callable, use `InvokeArgument<N>(args...)`.

```cpp
EXPECT_CALL(foo, Method(_, _))
    .WillOnce(InvokeArgument<1>(5));
```

This calls the mock method's second argument (index `1`) with the argument `5`.

- To pass arguments by reference, wrap them in `std::ref()`.
- Temporary objects passed as arguments are copied internally.

### Ignoring Returned Values

If the action you want to use returns a value but the mock method returns `void`, use `IgnoreResult()`.

```cpp
EXPECT_CALL(mock, VoidMethod())
    .WillOnce(IgnoreResult(SomeFunctionReturningInt));
```

Note: Cannot use `IgnoreResult()` on actions that already return `void`.

### Sharing Actions

Actions can be copied efficiently. Reusing action objects with internal state may have shared side effects, so be careful.

For no internal state, sharing actions is encouraged.

### Move-only Types and Actions

gMock supports mocking methods with move-only arguments or return types (e.g., `std::unique_ptr`). Use lambdas or functors with `WillOnce` to handle such cases properly.

---

## 8. Practical Examples

### Setting a Default Return Value

```cpp
ON_CALL(mock, GetValue())
    .WillByDefault(Return(10));
```

### Multiple Return Values in Sequence

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

### Modifying an Output Argument

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(SetArgPointee<0>(5));
```

### Invoking a Callable Argument

```cpp
EXPECT_CALL(mock, Execute(_, _))
    .WillOnce(InvokeArgument<1>(42, std::ref(helper)));
```

### Combining Multiple Actions

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)));
```

### Custom Action with Lambda

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 10; });
```

### Polymorphic Action Example (Return Second Argument)

```cpp
class ReturnSecondArgumentAction {
 public:
  template <typename Result, typename ArgumentsTuple>
  Result Perform(const ArgumentsTuple& args) const {
    return std::get<1>(args);
  }
};

EXPECT_CALL(mock, DoSomething)
    .WillOnce(MakePolymorphicAction(ReturnSecondArgumentAction()));
```

---

## 9. Troubleshooting

- **Unexpected calls**: Make sure to set expectations explicitly or use `NiceMock` to suppress warnings.
- **Compile errors with move-only types**: Use lambdas or functors for `WillOnce` actions.
- **`DoDefault()` in composite actions causes runtime errors**: Use `DoDefault()` only alone outside composite actions.
- **Callables taking references not behaving as expected**: Use `std::ref()` to pass arguments by reference to `InvokeArgument<N>()`.

---

## 10. References & Related Documentation

- [gMock Cookbook: Using Actions](https://google.github.io/googletest/gmock_cook_book.html#using-actions)
- [Actions Reference](../reference/actions.md)
- [Mocking Reference](../reference/mocking.md#EXPECT_CALL.WillOnce)
- [gMock Cheat Sheet](../docs/gmock_cheat_sheet.md#Actions)

---

For an in-depth walkthrough on mocking and actions, consult the [gMock for Dummies](../docs/gmock_for_dummies.md) guide and the comprehensive [gMock Cookbook](../docs/gmock_cook_book.md).
