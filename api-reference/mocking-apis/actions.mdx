---
title: "Actions"
description: "Explains the rich set of actions available for controlling mock method behavior. Covers default actions, custom actions, parameterized actions, and advanced usage scenarios to simulate concrete results or behaviors."
---

# Actions

GoogleMock provides a rich collection of **actions** to precisely specify how mock methods should behave when invoked. Actions define the behavior of mock method calls, allowing you to simulate return values, side effects, exceptions, and complex call patterns. This page explains the core concepts of actions, details the built-in actions available, and illustrates how to compose and customize them for flexible test mocking.

---

## Understanding Actions in GoogleMock

When you write tests with mocks, you often want to control not just whether a method was called but also what it does during that call. Actions enable you to express *what happens* when a mock method is called—whether returning a particular value, modifying arguments, invoking callbacks, throwing exceptions, or even chaining multiple behaviors.

GoogleMock distinguishes between:

- **Default Actions**: Specified with `ON_CALL()`, defining fallback behavior when no `EXPECT_CALL()` matches.
- **Expectation Actions**: Specified with `EXPECT_CALL()`'s `WillOnce()` and `WillRepeatedly()`, directly controlling behavior during expected calls.

Actions are placed in these clauses to tailor the mock’s responses and side effects.

### How Actions Enhance Your Testing

1. **Simulate realistic scenarios:** Return values can be canned or computed dynamically to mimic real behavior.
2. **Inject side effects:** Modify outputs or invoke callbacks to replicate complex interactions.
3. **Control multiple calls:** Define varying behavior across successive calls (e.g., different return values).
4. **Improve test clarity:** By declaring behavior explicitly, tests become more understandable and maintainable.

---

## Categories of Actions

### Returning Values

These actions specify exact or computed return values when a mock method is called.

- `Return(value)`: Return a fixed value. Note this captures the value at expectation setup, not at call time.
- `ReturnRef(variable)`: Return a reference to an existing variable.
- `ReturnPointee(pointer)`: Return the value pointed to by a pointer at call time.
- `ReturnNew<T>(args...)`: Return a pointer to a freshly allocated `T` object created with provided constructor arguments.
- `ReturnNull()`: Return a null pointer.
- `ReturnRoundRobin({a1, a2, ...})`: Return values cycling through the given list for each call.
- `ReturnArg<N>()`: Return the _N_-th argument of the mock function.

### Setting Side Effects on Arguments

Some functions modify parameters passed by pointer or reference. The following actions help simulate these side effects:

- `SetArgPointee<N>(value)`: Sets the pointee of the _N_-th argument to `value`.
- `SetArrayArgument<N>(first, last)`: Copies a range of elements into the _N_-th argument, useful for output arrays.
- `Assign(&variable, value)`: Assigns `value` to the provided variable.
- `DeleteArg<N>()`: Deletes the pointer in the _N_-th argument.
- `SaveArg<N>(pointer)`: Saves a copy of the _N_-th argument into a location pointed to by `pointer`.

### Controlling Function Flow

- `DoAll(a1, a2, ..., an)`: Executes multiple actions in order for a single call. Only the last action’s return value is used.
- `IgnoreResult(action)`: Executes `action` but ignores its return value, useful when the mock function returns `void`.

### Invoking Callbacks or Functions

Sometimes the mock method receives callable objects or you want to invoke custom code:

- `Invoke(f)`: Calls a specified function, method, functor, or lambda with the same arguments as the mock method.
- `InvokeWithoutArgs(f)`: Calls a function or functor that takes no arguments.
- `Invoke(object_ptr, &Class::Method)`: Invokes a method on a given object.
- `InvokeArgument<N>(args...)`: Calls the mock method’s _N_-th argument as a callable, passing specified arguments.

### Exception and Error Simulation

- `Throw(exception)`: Throws the given exception object when the mock method is invoked.
- `SetErrnoAndReturn(error_code, value)`: Sets the global `errno` to `error_code` and returns `value`.

### Default Behavior

- `DoDefault()`: Performs the default action as specified by `ON_CALL()` or the built-in default.

---

## How to Use Actions

Actions are specified on expectations using:

- `.WillOnce(action)`: Uses `action` for the *next* matching call.
- `.WillRepeatedly(action)`: Uses `action` for *all subsequent* matching calls.
- `.WillByDefault(action)`: Defines default behavior for `ON_CALL()` specs.

```cpp
using ::testing::Return;

EXPECT_CALL(mock_object, SomeMethod(_))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

In this example, the mock will return `42` on the first call, then `0` thereafter.

<Tip>
Always prefer defining the *minimum* necessary expectations. Overly restrictive behaviors make tests brittle.
</Tip>

---

## Action Composition and Customization

### Using `DoAll()` to Chain Actions

When you want a mock method to do multiple things, such as set an output argument and return a value, use `DoAll()`:

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;

EXPECT_CALL(mock, Compute(_))
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)));
```

Here, the first argument is set to 10, and the method returns true.

### Passing Selected Arguments to Functors with `WithArgs` and `WithArg`

Use `WithArgs<N1, N2>(action)` to apply an inner action to selected mock method arguments. This is useful to adapt actions to mismatch between mock method arguments and action callable signature.

```cpp
using ::testing::WithArgs;
using ::testing::Invoke;

EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(WithArgs<0>(Invoke(CustomAction)));
```

### Creating Custom Actions

If existing actions don’t meet your needs, you can create custom actions either by:

- Implementing functor classes with compatible call operators.
- Using `ACTION` or `ACTION_P` macros for concise custom action templates.
- Using `Invoke()` with user-defined functions or lambdas.

Example of a custom lambda action:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 2; });
```

### Delegating Calls to Real or Fake Objects

Actions can invoke real or fake implementations inside a mock:

```cpp
ON_CALL(mock, Method(_))
    .WillByDefault(Invoke(&real_object, &RealClass::Method));
```

This allows combining mocking verification with real behavior.

---

## Practical Examples of Common Actions

### 1. Returning a Simple Value

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(100));
```

### 2. Returning a Reference

```cpp
int value = 42;
EXPECT_CALL(mock, GetRef())
    .WillOnce(ReturnRef(value));
```

### 3. Modifying Argument Values

```cpp
EXPECT_CALL(mock, GetValue(_))
    .WillOnce(SetArgPointee<0>(123));
```

### 4. Throwing Exceptions

```cpp
EXPECT_CALL(mock, Perform())
    .WillOnce(Throw(std::runtime_error("error")));
```

### 5. Invoking a Callback Parameter

```cpp
EXPECT_CALL(mock, DoAsync(_, _))
    .WillOnce(InvokeArgument<1>(true));
```

### 6. Chaining Side Effects and Returns

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)));
```

### 7. Returning Different Values on Subsequent Calls

```cpp
EXPECT_CALL(mock, GetCount())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

---

## Best Practices and Common Pitfalls

- **Use `ON_CALL()` to define defaults.** Reserve `EXPECT_CALL()` for actual expectations.
- **Avoid over-specifying:** Only set expectations on interactions your test cares about.
- **Beware of action evaluation timing:** `Return(value)` captures `value` during setup, not per call.
- **Use lambdas or functions for dynamic return values:** To produce fresh values per invocation.
- **Chain `DoAll()` carefully:** Only the last action's return value is used; preceding actions must be `void`.
- **Understand sticky expectations:** Use `.RetiresOnSaturation()` where relevant to avoid unexpected failures.
- **Leverage `InvokeArgument<N>()` to handle asynchronous or callback-based code.
- **Suppress warnings on uninteresting calls using `NiceMock<T>` if appropriate.

<Warning>
Never use `DoDefault()` inside composite actions (`DoAll()` etc) as it results in runtime errors.
</Warning>

---

## Troubleshooting Common Issues with Actions

### Unresponsive or Incorrect Return Values
- Confirm whether `Return()` argument is evaluated once at expectation setup instead of per call.
- Use `ReturnPointee()` or a lambda function to return up-to-date values.

### Confusing Uninteresting Call Warnings
- Ensure you either set proper `EXPECT_CALL()` or use a `NiceMock` wrapper.

### Overloaded Method Ambiguity
- Use argument-based disambiguation techniques (`Const()` or typed matchers) in `EXPECT_CALL()`.

### Chained Actions Returning Wrong Values
- Verify that only the last element in `DoAll()` returns a value, others must be void.

### Callback Invocations Fail
- Use `InvokeArgument<N>` and wrap references in `std::ref()` to maintain original references.

_For more help, enable verbose output with `--gmock_verbose=info`._

---

## Additional Resources

- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Practical recipes for using actions effectively.
- [Actions Reference](../api-reference/mocking-apis/actions.md): Complete list and details of actions.
- [gMock for Dummies](../getting-started/introduction.md): Beginner-friendly introduction to mocking with actions.
- [Matchers Reference](../api-reference/core-apis/matchers.md): How to specify argument matching in conjunction with actions.
- [Using Custom Actions](../guides/mocking-and-test-doubles/advanced-mocking.md): Deep dive into writing your own actions and best practices.

---

## See Also

- `EXPECT_CALL()` and `ON_CALL()` usage: controls when and how actions take effect.
- Cardinalities and sequences: complements actions by specifying how often and in which order mock methods can be called.
- Nice, Naggy, and Strict mocks: control warnings related to uninteresting calls.

---

**End of Actions Reference**
