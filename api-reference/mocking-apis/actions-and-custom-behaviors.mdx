---
title: "Actions and Custom Behaviors"
description: "API documentation for actions (returning values, setting output params, invoking custom functions) as well as creating custom actions using macros like ACTION and ACTION_TEMPLATE. Shows advanced illustration for flexible mock response strategies."
---

# Actions and Custom Behaviors

This page details the API and usage patterns for controlling mock function **actions** in GoogleMock. Actions determine what happens when a mock method is called – whether it returns values, updates output parameters, invokes callbacks, or executes custom computations. Additionally, it explains how to create advanced, reusable custom actions for flexible mock behavior.

---

## Overview of Actions

In GoogleMock, **actions** specify the behavior of mock functions when invoked. Instead of just verifying that calls occur, actions let you:

- Return specific values or references
- Modify output parameters
- Invoke supplied functions or callbacks with specific arguments
- Throw exceptions
- Compose multiple effects
- Define custom, parameterized actions with fine control

Actions are expressed inside `WillOnce()`, `WillRepeatedly()` (for expectations) or `WillByDefault()` (for default behaviors).

## Built-In Actions

GoogleMock provides an extensive built-in action set, categorizing as:

### Returning Values

| Action                         | Description                                                 |
|-------------------------------|-------------------------------------------------------------|
| `Return(value)`                | Return a copy of `value`. The copy is made when the action is defined, not at call time. |
| `ReturnArg<N>()`               | Return the N-th argument (zero-based) passed to the mock.     |
| `ReturnNew<T>(a1, ..., ak)`    | Create and return a `new` object of type `T` constructed with arguments `a1...ak`. A new object is created each invocation. |
| `ReturnNull()`                 | Return a null pointer.                                        |
| `ReturnPointee(ptr)`           | Return the value pointed to by `ptr` at call time (live values). |
| `ReturnRef(variable)`          | Return a reference to `variable`. Used when the mock’s return type is a reference. |
| `ReturnRefOfCopy(value)`       | Returns a reference to a copy of `value` that lives as long as the action. |
| `ReturnRoundRobin({a1, ..., ak})` | Returns elements from a list cyclically on each call.        |

### Side Effects on Arguments

| Action                          | Description                                                |
|--------------------------------|------------------------------------------------------------|
| `SetArgPointee<N>(value)`       | Assign `value` to the variable pointed to by the N-th argument. |
| `SetArrayArgument<N>(first, last)` | Copy elements from source range [`first`, `last`) to the array pointed to by the N-th argument. |
| `SaveArg<N>(pointer)`           | Save a copy of the N-th argument into `*pointer`.           |
| `SaveArgByMove<N>(pointer)`     | Move the N-th argument into `*pointer`.                      |
| `SetErrnoAndReturn(error, value)` | Set `errno` to error and return `value`.                    |
| `DeleteArg<N>()`                | Deletes pointer in the N-th argument.                       |

### Using Functions or Callables

| Action                                         | Description                                                    |
|------------------------------------------------|----------------------------------------------------------------|
| `Invoke(f)`                                   | Invoke callable `f` with the mock function’s arguments and return the result. |
| `Invoke(object_pointer, &class::method)`      | Invoke member method on the object with mock function’s arguments. |
| `InvokeWithoutArgs(f)`                         | Invoke callable `f` with no arguments.                          |
| `InvokeArgument<N>(args...)`                   | Invoke the N-th (0-based) argument (a callable) with specified arguments. |
| `IgnoreResult(a)`                              | Invoke action `a` but ignore its return value (helpful when wrapping returning actions into void-returning actions). |

### Composite Actions

Composite actions combine multiple actions into one:

| Action                | Description                                              |
|-----------------------|----------------------------------------------------------|
| `DoAll(a1, a2, ..., an)` | Performs a sequence of actions `a1` through `an`. Returns result of `an`. |
| `WithArg<N>(a)`           | Takes the N-th argument of the mock and passes it to inner action `a`. |
| `WithArgs<N1, ..., Nk>(a)`| Passes selected arguments to action `a`.                 |
| `WithoutArgs(a)`          | Invokes action `a` without arguments. Useful for calling functions with no args as an action. |

### Default and Control Actions

| Action         | Description                                  |
|----------------|----------------------------------------------|
| `DoDefault()`  | Performs the default action (either built-in or specified by `ON_CALL`). Cannot be used inside composite actions. |
| `RetiresOnSaturation()` | Marks an expectation to retire (become inactive) when saturated (upper call count reached). Used inside `EXPECT_CALL`. |

---

## Defining Custom Actions

When built-in actions aren’t enough, you can define custom actions for complex or reusable behaviors.

### Using `ACTION` and `ACTION_P` Macros

Legacy macros allow concise action definitions:

```cpp
// Zero-parameter action
ACTION(SumArgs) { return arg0 + arg1; }

// Parameterized action
ACTION_P(Plus, n) { return arg0 + n; }

// Usage in a test
EXPECT_CALL(mock, Foo(_, _)).WillOnce(SumArgs());
EXPECT_CALL(mock, Foo(_, _)).WillOnce(Plus(5));
```

In the body of the defined actions:

- You refer to mock function arguments as `arg0`, `arg1`, etc.
- You can use `arg0_type` or parameter names suffixed with `_type` for explicit typing.
- The return of the block becomes the mock function return value.

### Advanced: Using `ACTION_TEMPLATE`

To make an action with explicit template parameters (not inferred from argument types), use `ACTION_TEMPLATE`:

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

int n;
EXPECT_CALL(mock, Foo(_, _)).WillOnce(DuplicateArg<1, unsigned char>(&n));
```

This macro defines an action template with explicit template parameter kinds (`typename`, `int`, etc.) and value parameters. It enables creating highly reusable and type-flexible actions.

---

## Practical Examples

### Returning Different Values in Sequence

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));

EXPECT_EQ(mock.GetValue(), 1);
EXPECT_EQ(mock.GetValue(), 2);
EXPECT_EQ(mock.GetValue(), 3);
EXPECT_EQ(mock.GetValue(), 3);
```

### Setting an Output Argument and Returning a Value

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

When `Mutate` is called, this action sets the value at the pointer in argument 0 to 42 and returns true.

### Invoking a Callable Argument

```cpp
using ::testing::InvokeArgument;
EXPECT_CALL(mock, ProcessCallback(_))
    .WillOnce(InvokeArgument<0>(42));
```

This will invoke the first argument (which must be a callable) with `42`.

### Writing a Custom Action with `ACTION_P`

```cpp
ACTION_P(AddN, n) {
  return arg0 + n;
}

EXPECT_CALL(mock, Foo(_))
    .WillOnce(AddN(5));  // Returns arg0 + 5
```

### Defining an Action Template

```cpp
ACTION_TEMPLATE(CopyArgToOutput,
                HAS_1_TEMPLATE_PARAMS(int, k),
                AND_1_VALUE_PARAMS(output)) {
  *output = std::get<k>(args);
}

int val;
EXPECT_CALL(mock, Func(_, _))
    .WillOnce(CopyArgToOutput<1>(&val));
```

This action copies the k-th argument to an output parameter.

---

## Best Practices and Tips

- Use `ReturnPointee()` for returning the *live* value pointed to by a pointer rather than a fixed copy.
- Combine multiple effects using `DoAll()`, remembering the last action’s return value is used as the function's return.
- Define custom actions with `ACTION_P*` macros for parameterized or reusable behaviors.
- Use `InvokeArgument<N>(args...)` to invoke a callback or function pointer argument.
- Be careful with `Return()` and move-only types: the value is captured once at expectation setup, not each call.
- To avoid surprises, use `RetiresOnSaturation()` on expectations with finite cardinalities to allow later expectations to match.
- Prefer lambdas or C++ callable objects for fine-grained or advanced actions.

---

## Troubleshooting Common Issues

### Side Effects Not Occurring as Expected

Remember that actions are evaluated once at expectation setup time for `Return()`. If you want side effects on each call, define a custom action (e.g., a lambda).

### Return Values Always the Same

Avoid returning a local variable modified inline in `Return(n++)`. Instead, capture by lambda or write a custom action.

### Callable Arguments Not Invoked

Wrap reference arguments in `std::ref()` inside `InvokeArgument()` to ensure references are preserved instead of copies.

### Confusing Behavior with Multiple Expectations

Recall that later `EXPECT_CALL` statements override earlier ones with overlapping matchers; order matters.

---

## Additional Resources

- [gMock Actions Reference](../reference/actions.md)
- [gMock Mocking Reference](../reference/mocking.md)
- [gMock Cookbook - Using Actions](../gmock_cook_book.md#using-actions)
- [gMock For Dummies](../gmock_for_dummies.md)

---

## Code Links

For full implementation details, see:

<Source url="https://github.com/google/googletest" paths='[{"path": "googlemock/include/gmock/gmock-more-actions.h", "range": "1-231"}]' branch="main" />

---