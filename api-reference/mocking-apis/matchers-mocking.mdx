---
title: "Matchers in Mock Expectations"
description: "Describes the use of matchers within GoogleMock's EXPECT_CALL and ON_CALL macros, providing users with tools to verify arguments, control call counts, and customize validation logic. Explores integrated and extensible matcher libraries for mocks."
---

# Matchers in Mock Expectations

Matchers are the key mechanism for specifying how to verify arguments in your GoogleMock `EXPECT_CALL` and `ON_CALL` macros. They provide powerful, flexible, and extensible tools to precisely control what argument values are considered valid during testing. This page explores how matchers integrate with mock expectations, illustrating their use cases, syntax, types, parameterization, and best practices.

---

## Understanding Matchers in Mock Expectations

When you set an expectation like `EXPECT_CALL(mock_obj, MethodName(matchers...))`, the matchers describe the criteria that the actual call arguments must satisfy for the call to be considered matching the expectation. This enables:

- **Verification of arguments** — assert that arguments meet conditions
- **Controlling call counts** — configure how many times calls with certain argument patterns are expected
- **Custom validation logic** — write arbitrary checks using predicates or custom matchers

Matchers work polymorphically, adapting to argument types, and are composable into complex conditions.

### Relationship Between `EXPECT_CALL` / `ON_CALL` and Matchers

- `EXPECT_CALL` uses matchers to specify which calls are expected, how often, and what they do.
- `ON_CALL` uses matchers to define the default behavior for calls matching certain argument patterns, even if not explicitly expected.

Newer expectations override older ones when argument matchers overlap; the last matching expectation wins.

---

## Basic Matcher Usage

You can use built-in matchers like `_` (wildcard), `Eq(value)` (equal to value), `Ge(x)` (greater or equal), etc. For example:

```cpp
EXPECT_CALL(mock_foo, Bar(_));           // Expect Bar called with any arg
EXPECT_CALL(mock_foo, Bar(42));          // Expect Bar called with 42
EXPECT_CALL(mock_foo, Bar(Ge(10)));      // Expect Bar called with value >= 10
```

Match literal values directly if you want exact equality:

```cpp
EXPECT_CALL(mock_obj, Func(5));   // Same as Func(Eq(5))
```

---

## Parameterized Matchers

Sometimes you need matchers with parameters, defined via `MATCHER_P`, `MATCHER_P2`, etc. These allow you to write reusable policies:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return (arg % divisor) == 0;
}

// Usage
EXPECT_CALL(mock_obj, Foo(IsDivisibleBy(5)));
```

Descriptions can also be customized to include parameters and negation state:

```cpp
MATCHER_P2(InClosedRange, low, high, "") {
  return low <= arg && arg <= high;
}

EXPECT_THAT(value, InClosedRange(10, 20));
```

If a match fails, the failure message will include human-friendly text about the range and the actual value.

---

## Composing Matchers

Matchers can be combined to form complex logical conditions:

- `AllOf(m1, m2, ...)` — match if all matchers succeed
- `AnyOf(m1, m2, ...)` — match if any matcher succeeds
- `Not(m)` — match if inner matcher fails

Example:

```cpp
EXPECT_CALL(mock_obj, Foo(AllOf(Ge(0), Ne(5))));
```

---

## Commonly Used Built-in Matchers

GoogleMock provides a rich library of built-in matchers:

- **Wildcard matcher:** `_` matches any argument
- **Equality matchers:** `Eq(value)`, `Ne(value)`
- **Relational matchers:** `Lt(x)`, `Le(x)`, `Gt(x)`, `Ge(x)`
- **String matchers:** `StrEq`, `StrCaseEq`, `StartsWith`, `EndsWith`, `HasSubstr`
- **Pointer matchers:** `IsNull()`, `NotNull()`, `Pointee(M)` — match based on pointer or pointee value
- **Container matchers:** `ElementsAre(...)`, `Contains(...)`, `Each(...)`, `SizeIs(...)`
- **Tuple / Pair matchers:** `Pair(m1, m2)`, `Key(m)`, `FieldsAre(...)`

See the [Matchers Reference](../core-testing-apis/matchers) for a detailed list.

---

## Using Matchers in `EXPECT_CALL` and `ON_CALL`

Matchers are specified as arguments to mock method calls in `EXPECT_CALL` and `ON_CALL`. Here's a minimal pattern:

```cpp
using ::testing::_;
using ::testing::Ge;
using ::testing::Return;

EXPECT_CALL(mock_obj, MethodName(Ge(10)))
    .Times(2)
    .WillRepeatedly(Return(true));
```

This expects that `MethodName` is called twice with an argument at least 10.

To ignore an argument, use `_`.

You may omit the matcher list for non-overloaded methods to accept any arguments:

```cpp
EXPECT_CALL(mock_obj, MethodName);
```

### The `.With()` Clause

Use `.With()` to specify a matcher for *all* arguments as a tuple:

```cpp
EXPECT_CALL(mock_obj, Foo(_, _))
    .With(Lt())  // check first arg less than second
    .Times(3);
```

Inside `.With()`, matchers operate on a `std::tuple` of all arguments and allow complex cross-argument checks.

---

## Creating Custom Matchers

You can write your own matchers neatly using the `MATCHER` macros. This allows concise, readable, and reusable matchers without boilerplate.

### Basic Custom Matcher

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock_obj, Foo(IsEven()));
```

You get automatic descriptions "is even" and "is odd" on failure.

### Custom Matcher with Detailed Failure Info

```cpp
MATCHER_P(WithinTolerance, tolerance, "") {
  if (abs(arg - expected) <= tolerance) {
    return true;
  }
  *result_listener << "which differs by " << abs(arg - expected);
  return false;
}

EXPECT_THAT(value, WithinTolerance(0.1));
```

### Parameterized and Multi-Parameter Matchers

Use `MATCHER_Pk` macros (`MATCHER_P2`, `MATCHER_P3`, ... up to 10) for matchers taking multiple parameters, with descriptions that can involve those parameters and the negation state.

---

## Tips and Best Practices

- Use the built-in matchers whenever possible—they provide clear messages and are well tested.
- Compose matchers with `AllOf()` and `AnyOf()` to express complex conditions.
- Use `.With()` in `EXPECT_CALL` or `ON_CALL` for relations between multiple arguments.
- Define custom matchers with `MATCHER` macros for concise, readable validation logic.
- Always use matchers when you want to verify argument properties, not just exact values.
- When matching pointers, prefer `Pointee(matcher)` over `AllOf(NotNull(), Pointee(matcher))` for simplicity.
- Parameterize matchers for reusability instead of repeating similar matchers.
- Avoid side effects in matchers; they must be purely functional.

---

## Example: Using Matchers in Expectations

```cpp
#include <gmock/gmock.h>

using ::testing::_;       // wildcard matcher
using ::testing::Ge;
using ::testing::NotNull;
using ::testing::Pointee;
using ::testing::Return;

class MockFoo {
 public:
  MOCK_METHOD(bool, Bar, (int n), ());
  MOCK_METHOD(void, ProcessData, (int* data_ptr), ());
};

TEST(ExampleTest, MatchersExample) {
  MockFoo mock;

  // Expect Bar to be called with a value >= 10.
  EXPECT_CALL(mock, Bar(Ge(10)))
      .Times(1)
      .WillOnce(Return(true));

  // Expect ProcessData to be called with a non-null pointer
  // pointing to a value equal to 5.
  EXPECT_CALL(mock, ProcessData(Pointee(5)));

  mock.Bar(12);          // Matches expectation

  int value = 5;
  mock.ProcessData(&value);  // Matches expectation
}
```

---

## Troubleshooting Matchers

- **Arguments don't match your expectation:** Check if your matchers correspond accurately to the expected argument types and values.
- **Unexpected matching failures:** Use verbose failure messages triggered by streaming to `result_listener` in custom matchers.
- **Ambiguous overloading errors:** Use `Const()` or cast matchers to select the right overload.
- **Unrecognized arguments:** Use `_` or `A<T>()` to accept any argument of type T.
- **Uninteresting calls warning:** Consider using `NiceMock` to suppress them if intentional.

---

## Related Resources

- [Matchers Reference](/api-reference/core-testing-apis/matchers)
- [Mocking Reference](/docs/reference/mocking.md)
- [gMock Cookbook: Writing New Matchers Quickly](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers)
- [Assertions Reference: Using Matchers in EXPECT_THAT](../core-testing-apis/assertions.md#EXPECT_THAT)
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md)

---

Mastering matchers in your mock expectations unlocks rich verifications that precisely express your test intent, catch mismatches early, and provide actionable diagnostics—empowering you to build robust, maintainable tests.
