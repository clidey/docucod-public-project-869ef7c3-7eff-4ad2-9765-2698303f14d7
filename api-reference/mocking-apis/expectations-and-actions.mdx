---
title: "Expectations and Actions"
description: "Detailed guide to expressing expectations (EXPECT_CALL) and customizing mock behavior via actions such as Return, Invoke, and custom stubs. Learn to tightly control and verify the flow of method invocations."
---

# Expectations and Actions

This guide details how to define expectations on mock methods using `EXPECT_CALL` and customize the behavior of mock objects with actions in GoogleMock. Learn to tightly control the flow of method invocations, specify argument matchers, sequence calls, and dictate return values or side effects through built-in and custom actions.

---

## Understanding Expectations with `EXPECT_CALL`

When writing tests with mock objects in GoogleMock, setting expectations is essential to verify that code under test interacts correctly with its dependencies. You define these expectations using the `EXPECT_CALL` macro.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `mock_object`: your mock class instance.
- `Method`: the method expected to be called.
- `matchers...`: argument matchers specifying expected arguments (can be omitted to match any arguments).
- Chained clauses specify how many times to expect, and what actions to perform on calls.

#### Example

```cpp
using ::testing::Return;

MockTurtle turtle;
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));

for (int i = 0; i < 5; ++i) {
  int x = turtle.GetX();
  // First call returns 100, second 150, others 200
}
```

This example expects `GetX()` to be called 5 times, returning specified values.

### Matchers: Controlling Expected Arguments

Matchers let you specify conditions on method arguments:

- Use `_` to match any value.
- Use built-in matchers like `Eq()`, `Lt()`, `NotNull()`, or custom ones.

Example:

```cpp
EXPECT_CALL(turtle, Forward(Ge(100)));  // Expect Forward() called with ≥100
EXPECT_CALL(mock, DoThat(_, NotNull()));  // Second argument must not be nullptr
```

If you don’t care about some arguments, just use `_`. Omitting the argument list is a shorthand for expecting any arguments, supported for non-overloaded methods.

### Cardinalities: Specifying Call Counts

The `.Times()` clause controls how many times a call is expected:

| Cardinality         | Meaning                                  |
|---------------------|------------------------------------------|
| `AnyNumber()`       | Called zero or more times                 |
| `AtLeast(n)`        | Called at least `n` times                 |
| `AtMost(n)`         | Called at most `n` times                  |
| `Between(m, n)`     | Called between `m` and `n` times (inclusive) |
| `Exactly(n)` or `n` | Called exactly `n` times; `0` means never |

If omitted, GoogleMock infers the cardinality from actions:

- No `WillOnce` or `WillRepeatedly`: `Exactly(1)` (default single call).
- `n` `WillOnce` actions, no `WillRepeatedly`: `Exactly(n)`.
- `n` `WillOnce` and one `WillRepeatedly`: `AtLeast(n)`.

### Ordering Calls: Sequences and the `.InSequence()` Clause

By default, mocks match calls in any order. When order matters, use sequences:

```cpp
using ::testing::Sequence;
Sequence seq;

EXPECT_CALL(mock, Init()).InSequence(seq);
EXPECT_CALL(mock, Start()).InSequence(seq);
EXPECT_CALL(mock, Stop()).InSequence(seq);
```

The above ensures `Init()`, `Start()`, `Stop()` are called in order.

For implicit scoping, you can also do:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
```

### Prerequisites: The `.After()` Clause

To specify partial ordering (a method call must happen after one or more others), use `.After()`:

```cpp
Expectation e1 = EXPECT_CALL(mock, First());
Expectation e2 = EXPECT_CALL(mock, Second());
EXPECT_CALL(mock, Last()).After(e1, e2);
```

This means `Last()` can only be called after **both** `First()` and `Second()` have been called.

### Controlling Expectation Lifetimes with `.RetiresOnSaturation()`

By default, expectations remain active even after their call limits are reached (sticky). To make an expectation inactive once saturated, use:

```cpp
EXPECT_CALL(mock, Foo()).Times(2).RetiresOnSaturation();
```

Once `Foo()` is called twice, this expectation no longer matches calls. This is useful to allow other expectations to match afterward.

### Using the `.With()` Clause for Multi-Argument Matching

Use `.With()` to specify a matcher that applies over the entire argument tuple:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // Expect first arg < second arg
```

This allows expressing conditions on combined argument values.

---

## Customizing Mock Behavior with Actions

Actions specify what the mock does when a method is called. You set these with `WillOnce()`, `WillRepeatedly()` on `EXPECT_CALL`s or `WillByDefault()` on `ON_CALL`s.

### Built-in Actions

| Action                  | Description                                         |
|-------------------------|-----------------------------------------------------|
| `Return(value)`         | Return `value`                                      |
| `ReturnRef(variable)`   | Return reference to a variable                      |
| `ReturnPointee(ptr)`    | Return the value pointed to by a pointer            |
| `DoDefault()`           | Perform the default action (usually returning default value) |
| `Throw(exception)`      | Throw an exception                                  |
| `Invoke(function)`      | Invoke a free function, functor, or lambda
| `Invoke(object, &method)`| Invoke a method on an object                        |
| `InvokeWithoutArgs(f)`  | Call a no-arg function or functor                    |
| `InvokeArgument<N>(args...)` | Invoke the `N`-th argument (callable) with given args         |
| `SetArgPointee<N>(value)` | Set the pointed-to value of argument `N`            |
| `SaveArg<N>(pointer)`   | Save argument `N` to pointer
| `DeleteArg<N>()`        | Delete argument `N` (must be pointer)                |
| `DoAll(...)`            | Perform multiple actions sequentially; return the last result |
| `IgnoreResult(action)`  | Ignore the return value of an action                |

### Examples

Returning a value on first call, then a default:

```cpp
using ::testing::Return;
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42));  // first

int val = mock.GetValue(); // returns 42
val = mock.GetValue();     // returns default 0
```

Performing side effects:

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;

EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

Using a lambda:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int x) { return x * 2; });
```

Invoking a method of a real or fake object:

```cpp
FakeFoo fake;
ON_CALL(mock, Bar(_))
    .WillByDefault([&fake](int x) { return fake.Bar(x); });
```

Calling an argument callback:

```cpp
using ::testing::InvokeArgument;
EXPECT_CALL(mock, CallWithCallback(_))
    .WillOnce(InvokeArgument<0>(42));  // calls callback(42)
```

### Chaining Actions: `DoAll`

You can chain multiple actions to happen on a single call:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

Remember, only the last action can return a value, others must return void.

### Returning Live Values

`Return(x)` copies the value `x` when the expectation is set. To return the value at call-time, use `ReturnPointee(&x)` or `ReturnRef(x)`.

```cpp
int n = 0;
EXPECT_CALL(mock, Get()).WillRepeatedly(ReturnPointee(&n));
n = 42;
EXPECT_EQ(mock.Get(), 42); // passes
```

### Creating Custom Actions

If built-in actions don't fit your needs, create an action by implementing a callable:

```cpp
EXPECT_CALL(mock, DoSomething())
    .WillOnce([]() { /* custom behavior */ return 7; });
```

or use the `ACTION` macros for legacy style custom actions.

### Ignore Return Values

Use `IgnoreResult(action)` when you want to ignore the result of an action, useful in void-returning mocks or chained actions:

```cpp
EXPECT_CALL(mock, SetVal(_))
    .WillOnce(IgnoreResult(Invoke(ProcessVal)));
```

### Selecting Arguments for Actions

If your mock method has many arguments but your action requires only some, use `WithArg<N>()`, `WithArgs<N1, N2>()`, or `WithoutArgs()` to adapt arguments:

```cpp
EXPECT_CALL(mock, Foo(_, _, _))
    .WillOnce(WithArgs<0,2>(Invoke(MyFunc)));
```

### Use Actions in `ON_CALL` to Set Default Behavior

`ON_CALL` declares default behavior without expectation:

```cpp
ON_CALL(mock, GetName())
    .WillByDefault(Return("default name"));
```

This behavior applies when no matching `EXPECT_CALL` exists.

---

## Best Practices and Tips

- Use `ON_CALL` extensively to specify default behaviors and reserve `EXPECT_CALL` for important interactions you want verified.
- For sequences or ordered calls, use `InSequence` or `.After()` clauses to communicate intent and avoid brittle tests.
- Remember that expectations are sticky unless `RetiresOnSaturation()` is used.
- Use `EXPECT_CALL(...).Times(0)` to assert a function is never called.
- When mocking overloaded or const methods, use appropriate matcher and qualifiers (e.g., `Const()`) to resolve ambiguity.
- Use `Mock::VerifyAndClearExpectations()` to force early verification if your mocks live longer or may leak.

---

## Troubleshooting Common Issues

- **Warning about uninteresting calls:** If a mock method is called without expectation, gMock warns but does not fail. Use `NiceMock` to suppress, or add `EXPECT_CALL(...).Times(AnyNumber())`.
- **Multiple expectations on the same function:** Newer ones override older. Order your expectations accordingly or combine `WillOnce()` actions.
- **Unexpected calls:** Result from calls that don’t match any expectations; check argument matchers and call ordering.
- **Performance problems compiling mocks:** Move constructors and destructors of mocks to `.cc` files to reduce compile time.
- **Issues with const or overloaded methods:** Use `Const()` or explicit matchers to identify the overload.

---

## Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) – Beginner-friendly introduction.
- [Mocking Reference](reference/mocking.md) – Detailed API reference for mock macros, expectations, and classes.
- [Actions Reference](reference/actions.md) – Comprehensive listing of built-in actions.
- [gMock Cookbook](gmock_cook_book.md) – Recipes for advanced mocking scenarios.
- [Nice, Naggy, and Strict Mocks](guides/mocking-advanced-techniques/nice-naggy-strict-mocks.mdx) – Control verbosity and strictness levels.

---

For a holistic understanding of GoogleMock, explore related pages covering argument matchers, strictness and cardinality, and deeper advanced usage in the Mocking APIs section.