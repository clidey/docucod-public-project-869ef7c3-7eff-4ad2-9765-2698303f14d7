---
title: "Expectations and Cardinalities"
description: "Guides setting up expectations for mock method calls, including times-called constraints (cardinalities), sequencing, and interaction verification. Provides insight into enforcing correct usage and error handling in mocks."
---

# Expectations and Cardinalities

This page guides you through the essential aspects of setting expectations on mock methods using GoogleMock. It focuses on specifying how many times a mock method call is expected—known as cardinalities—along with sequencing and interaction verification. By the end, you'll understand how to enforce correct mock usage and handle errors effectively.

---

## Understanding Expectations in GoogleMock

When setting up mocks, you use `EXPECT_CALL` to specify the methods you expect to be called, with certain argument patterns and behaviors. However, equally important is defining *how many times* these calls are expected. This is where **cardinalities** come in.

Cardinalities let you express constraints on the *number* of times a mock function is supposed to be invoked. Proper cardinality specification is crucial for ensuring your tests are precise yet flexible enough to avoid brittle failures.

### What Can You Expect to Specify?

- Exact call counts (e.g., exactly 3 times)
- Minimum or maximum call counts (e.g., at least twice, at most 5 times)
- Ranges (e.g., between 2 and 4 times)
- Unrestricted call counts (called any number of times)

In GoogleMock, these cardinalities come as built-in factory functions:

| Cardinality        | Meaning                                                         |
| ------------------ | ----------------------------------------------------------------|
| `AnyNumber()`      | The function can be called any number of times.                   |
| `AtLeast(n)`       | The function call is expected to happen *at least* *n* times.     |
| `AtMost(n)`        | The function call is expected to happen *at most* *n* times.      |
| `Between(m, n)`    | The function call is expected to happen between *m* and *n* times.|
| `Exactly(n)` or `n`| The function call is expected to happen *exactly* *n* times.      |


---

## Specifying Expectations

### Syntax Overview

You create expectations on mock methods using the `EXPECT_CALL` macro:

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .InSequence(sequences...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

All clauses except `WillOnce()`, `WillRepeatedly()`, and `Times()` are optional and can be omitted or repeated depending on use-cases.

### The `.Times()` Clause

The `.Times()` clause is how you define the cardinality. For example:

```cpp
using ::testing::AtLeast;
EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
```

If `.Times()` is omitted, GoogleMock infers the expected number of calls based on the actions you have specified, following these rules:

- If neither `.WillOnce()` nor `.WillRepeatedly()` are specified, inferred cardinality is `Times(1)`.
- If there are *n* `.WillOnce()` clauses and no `.WillRepeatedly()`, inferred cardinality is `Times(n)`.
- If there are *n* `.WillOnce()` clauses and one `.WillRepeatedly()`, inferred cardinality is `Times(AtLeast(n))`.

### How GoogleMock Handles Cardinality

GoogleMock tracks how many times each expectation has been called and checks it against the declared cardinality. It uses the concept of:

- **Satisfied:** The number of calls meets or exceeds the lower bound.
- **Saturated:** The upper bound of times has been reached.
- **Over-saturated:** The call count exceeds the upper bound, triggering an immediate test failure.


### Example: Specifying Exactly 3 Calls

```cpp
EXPECT_CALL(mock_object, Foo(_)).Times(Exactly(3));
```

This expects that `Foo` is called exactly three times with any arguments.

---

## Sequencing and Partial Ordering

Specifying expectations is not only about quantity but also *order*.

### Using `.InSequence()` Clause

The `.InSequence()` clause assigns an expectation to one or more `Sequence` objects, enforcing that calls in the same sequence occur in the order the expectations are declared.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Reset()).InSequence(s1, s2);
EXPECT_CALL(mock, GetSize()).InSequence(s1);
EXPECT_CALL(mock, Describe()).InSequence(s2);
```

This means `Reset` must be called before both `GetSize` and `Describe`, but `GetSize` and `Describe` can be called in any order relative to each other.


### Using `.After()` Clause

The `.After()` clause defines a partial order dependency between expectations, where an expectation must occur *after* one or more other expectations or sets of expectations have been satisfied.

Example:

```cpp
Expectation initX = EXPECT_CALL(mock, InitX());
Expectation initY = EXPECT_CALL(mock, InitY());
EXPECT_CALL(mock, Describe()).After(initX, initY);
```

Here `Describe()` will match only after both `InitX()` and `InitY()` have been called.


---

## Controlling Expectation Lifetimes

### Sticky Expectations

By default, expectations in GoogleMock are "sticky": even if they hit their upper bound of calls, they remain active and will continue matching calls, which causes failures if called too many times.

### Retiring Expectations with `.RetiresOnSaturation()`

The `.RetiresOnSaturation()` clause says that once the expectation has been saturated (upper bound reached), it becomes inactive and will no longer match calls.

Example:

```cpp
EXPECT_CALL(mock, Foo(7))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, Foo(_))
    .Times(AnyNumber());
```

The first two calls with argument `7` will match the first expectation and then retire it; subsequent calls with `7` will fall through to the second expectation.

---

## Best Practices and Common Pitfalls

### Best Practices

- **Define expectations before exercising mock:** Always declare your `EXPECT_CALL`s before invoking mock methods to ensure proper tracking.
- **Use cardinalities thoughtfully:** Overly strict cardinalities can cause fragile tests; be as specific as necessary, but no more.
- **Leverage sequences and `After()` for ordering:** Use these for complex order requirements without over-constraining tests.
- **Use `.RetiresOnSaturation()` to avoid sticky failures:** Helps when expecting a certain number of calls only.

### Common Pitfalls

- **Calling mocks more than expected:** Causes immediate test failures with messages indicating over-saturation.
- **Forgetting `.Times()` clause:** GoogleMock will infer, but it may not reflect your intent correctly.
- **Using incompatible argument matchers:** May cause expectations never to match.
- **Expectations without `.WillOnce()` or `.WillRepeatedly()`:** The default action is used; make sure this suits your test.

---

## Troubleshooting Common Issues

### Upper Bound Violations

If a mock method is called more times than expected, you will get an error message indicating the mismatch and details about the call count.

### Missing Calls

If a mock method is never called or called fewer times than expected, verification on destruction or explicit `Mock::VerifyAndClearExpectations()` will report failures.

### Ordering Violations

If ordering via `InSequence` or `After` is violated, GoogleMock will report unexpected call errors pinpointing which call occurred out of order.

---

## Real-world Usage Scenario

Imagine you are testing a network client that performs a sequence of operations — connect, authenticate, send data. You want to mock the network interface and ensure:

- `Connect()` is called exactly once
- `Authenticate()` is called after `Connect()` and at least once
- `SendData()` can be called multiple times but only after authentication

Set up your expectations using sequences and cardinalities:

```cpp
Sequence net_sequence;

EXPECT_CALL(network_mock, Connect())
    .Times(1)
    .InSequence(net_sequence);
EXPECT_CALL(network_mock, Authenticate())
    .Times(AtLeast(1))
    .InSequence(net_sequence);
EXPECT_CALL(network_mock, SendData(_))
    .Times(AnyNumber())
    .After(authentication_expectation);

// authentication_expectation can be the Expectation returned from
// EXPECT_CALL(..., Authenticate()).
```

This setup ensures the correct order and number of calls, and violations will be caught automatically.

---

## Additional References

- See [Mocking Reference](../reference/mocking.md#EXPECT_CALL) for detailed syntax of clauses.
- For cardinalities implementation details, see the `Cardinality` class in `gmock-cardinalities.h`.
- Learn about sequencing in the [Mocking Patterns & Advanced Use Cases](../guides/mocking-scenarios/mock-strictness-best-practices.md).
- Understand uninteresting vs unexpected calls in the [gMock Cookbook](../docs/gmock_cook_book.md#NiceStrictNaggy).

---

## Summary

`EXPECT_CALL` and cardinalities give you fine-grained control over how mock methods are expected to be invoked in your tests — from specifying exact call counts to enforcing call order via sequences and dependencies. Using `.RetiresOnSaturation()` aids in preventing sticky expectations causing failures after saturation.

GoogleMock's built-in cardinalities cover common use-cases, while users can define custom cardinalities by implementing the `CardinalityInterface`. Proper usage helps ensure your mocks precisely reflect intended contracts, making tests robust and maintainable.

---

## Code Snippet Example

```cpp
using ::testing::Sequence;
using ::testing::AtLeast;
using ::testing::Exactly;
using ::testing::AnyNumber;

Sequence s1, s2;

EXPECT_CALL(mock, Reset()).Times(Exactly(1)).InSequence(s1, s2);
EXPECT_CALL(mock, GetSize()).Times(AtLeast(1)).InSequence(s1);
EXPECT_CALL(mock, Describe()).Times(AnyNumber()).InSequence(s2);

// This means Reset must be called once before GetSize and Describe.
// GetSize must be called at least once before Describe is called.
```

---

## Mermaid Diagram: Expectation Flow and Cardinality Constraints

```mermaid
flowchart TD

  Start([Start: Mock Method Call]) --> CheckExpectations{Find Last Matching Expectation}

  CheckExpectations -->|No Match| UninterestingCall[Perform Default Action
and Possibly Warn]
  CheckExpectations -->|Match Found| CheckCallCount{Is Call Count Saturated?}

  CheckCallCount -->|Saturated| OverSaturation[Report Failure,
Perform Default Action]
  CheckCallCount -->|Not Saturated| IncrementCount[Increment Call Count]

  IncrementCount --> PreRequisites[Check Pre-requisite Expectations]

  PreRequisites -->|Satisfied| PerformAction[Perform Assigned Action]
  PreRequisites -->|Not Satisfied| UnsatisfiedPrereqs[Report Failures,
Don't Perform Action]

  PerformAction --> CheckRetire[Check .RetiresOnSaturation()]
  CheckRetire -->|Yes, Saturated| RetireExpectation[Retire This Expectation]
  CheckRetire -->|No| End([End])

  RetireExpectation --> End
  UnsatisfiedPrereqs --> End
  OverSaturation --> End
  UninterestingCall --> End

  classDef decision fill:#f9f,stroke:#333,stroke-width:2px;
  class CheckExpectations,CheckCallCount,PreRequisites,CheckRetire decision;
```

This diagram illustrates the flow when a mock method is called, how expectations are matched, cardinalities checked, and actions performed or errors reported.

---

## Troubleshooting Tips

<Tip>
If your test reports "called more times than expected", verify:
- The `.Times()` clause matches your test's intended call count.
- There are no implicit repeated calls hidden in your code.
- Use `.RetiresOnSaturation()` if calls should not be "sticky" after upper bound.
</Tip>

<Tip>
If calls are failing due to ordering, consider:
- Wrapping expectations in an `InSequence` block.
- Using the `.After()` clause for partial order dependencies.
- Verifying that implicit sequences via `InSequence` objects have not been corrupted.
</Tip>

<Warning>
Avoid mixing setting expectations and calling mock methods interleaved. Always set expectations before exercising mocks.
</Warning>

---

## Summary

This documentation page delivers comprehensive guidance on defining precise expectations on mock method calls with cardinalities and ordering constraints, empowering you to build robust tests with clear intent and minimal fragility.

---