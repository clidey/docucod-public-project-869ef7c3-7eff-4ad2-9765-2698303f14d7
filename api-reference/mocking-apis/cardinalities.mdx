---
title: "Cardinalities and Expectations"
description: "Documents cardinalities and expectation mechanisms for specifying and validating how many times mock methods are expected to be called. Details usage patterns for common testing needs as well as error/warning handling."
---

# Cardinalities and Expectations

This page documents the cardinalities and expectation specifications in GoogleMock, focusing on how to declare and validate the expected number of calls to mock methods. It guides you through the usage of common cardinalities for controlling call counts, details how GoogleMock infers call expectations, and explains error and warning handling when expectations are violated.

---

## Overview

GoogleMock lets you specify **how many times** a mock method is expected to be invoked using *cardinalities*. These cardinalities express call counts flexibly to reflect real testing scenarios.

By setting cardinalities on `EXPECT_CALL` statements, you control the *number of matched calls* permitted by the test. This mechanism ensures your code interacts with mocks as intended and helps detect unexpected or missing calls early.

### What Users Want to Achieve

- Define expectations on mock methods specifying how often they will be called.
- Use flexible cardinalities such as exact count, ranges, minimum or maximum counts.
- Understand how GoogleMock infers the number of calls when cardinalities are omitted.
- Handle and interpret errors when calls occur too few or too many times.
- Control expectation retirement behavior to allow complex test flows.

---

## Cardinality Types and Usage

GoogleMock's cardinalities are found in the `testing` namespace and specify the invocation count for mock functions. They are used primarily with the `.Times()` clause on `EXPECT_CALL`.

### Built-in Cardinalities

| Cardinality          | Meaning                                                       |
|----------------------|---------------------------------------------------------------|
| `AnyNumber()`        | No limit; the function can be called any number of times.     |
| `AtLeast(n)`         | The function is expected to be called at least *n* times.     |
| `AtMost(n)`          | The function can be called no more than *n* times.            |
| `Between(m, n)`      | The function is expected to be called between *m* and *n* times (inclusive). |
| `Exactly(n)` (or `n`)| The function is expected to be called exactly *n* times.       |


### Example: Setting Cardinalities

```cpp
using ::testing::Exactly;
using ::testing::AtLeast;
using ::testing::AnyNumber;

EXPECT_CALL(mock, Foo())
    .Times(Exactly(2));        // Must be called exactly twice

EXPECT_CALL(mock, Bar(_))
    .Times(AtLeast(1));        // Must be called at least once

EXPECT_CALL(mock, Baz(_))
    .Times(AnyNumber());       // Can be called any number of times
```

### Special Case: Disallowing Calls

Use `Times(0)` to specify that a call should *never* happen. Any unexpected invocation matching that expectation will cause a test failure.

```cpp
EXPECT_CALL(mock, ForbiddenMethod(_)).Times(0);
```

### Custom Cardinalities

Advanced users can implement `CardinalityInterface` to write custom cardinalities if the built-in ones don’t fit their needs.

---

## How GoogleMock Infers Cardinality

If you omit `.Times()`, GoogleMock infers cardinality based on the use of action clauses (`WillOnce`, `WillRepeatedly`):

- No `WillOnce()` or `WillRepeatedly()`: inferred as `Times(1)` (called exactly once).
- `n` `WillOnce()` clauses and no `WillRepeatedly()`: inferred as `Times(n)`.
- `n` `WillOnce()` clauses and one `WillRepeatedly()`: inferred as `Times(AtLeast(n))`.

### Example:

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2));  // Inferred Times(2)

EXPECT_CALL(mock, GetName())
    .WillOnce(Return("Alice"))
    .WillRepeatedly(Return("Bob"));  // Inferred Times(AtLeast(1))
```

---

## Using the `.Times()` Clause

The `.Times()` clause allows fine-grained control over expectations. It must be used at most once per expectation and must appear before certain other clauses like `.InSequence()`, `.WillOnce()`, etc.

### Usage Pattern

```cpp
EXPECT_CALL(mock, Method(args))
    .Times(Cardinality)      // Specify how many times Method can be called
    .WillOnce(action)        // Define behavior on calls
    .WillRepeatedly(action)  // Define behavior after WillOnce actions
    .RetiresOnSaturation();  // Optional: deactivate expectation when saturated
```

---

## Expectation Lifecycle: Retiring Expectations

Expectations are **active** when declared and become inactive (*retired*) under certain conditions.

- By default, expectations remain *sticky* (active) even if saturated (i.e., upper bound reached).
- Use `.RetiresOnSaturation()` if you want an expectation to retire immediately upon saturation, preventing further matching.
- Within sequences, expectations retire automatically when subsequent expectations match.

### Why Retiring Matters

Consider a test where multiple expectations overlap:

```cpp
EXPECT_CALL(mock, Foo(_)).Times(AnyNumber());       // #1
EXPECT_CALL(mock, Foo(7)).Times(2).RetiresOnSaturation(); // #2
```

The `.RetiresOnSaturation()` on expectation #2 means that after two calls with argument 7, this expectation becomes inactive, allowing #1 to match future calls instead of causing failures for extra calls.

Without `.RetiresOnSaturation()`, the third call with 7 would cause a test failure due to exceeding the allowed call count.

---

## Handling Errors and Warnings

GoogleMock rigorously enforces call cardinalities, and provides clear feedback when an expectation is violated.

### Call Counting Checks

- **Lower bound violations**: Occur if the expected minimum number of calls are not met by the time verification occurs (typically at mock destruction).
- **Upper bound violations**: Occur if a mock method is called more times than allowed by the cardinality.

### Warning on Action Count Mismatch

GoogleMock warns if the number of actions (`WillOnce()`, `WillRepeatedly()`) assigned to an expectation doesn’t correspond properly to the `.Times()` cardinality:

- Too many actions compared to the upper bound cause warnings.
- Too few actions compared to the lower bound also produce warnings if no `WillRepeatedly()` is specified.

### Uninteresting Calls

If a mock method is called without any expectation (`EXPECT_CALL`) declared, this is an *uninteresting call*. Depending on mock strictness (`NaggyMock`, `NiceMock`, `StrictMock`), it may generate warnings or failures.

### Unexpected Calls

If a mock method is called with arguments that do not match any active expectation, it is an *unexpected call* and always treated as a test failure.

---

## Practical Examples

### Disallowing a Method Call

```cpp
EXPECT_CALL(mock, MethodName(_)).Times(0);
```

This expectation expects that `MethodName` should never be called with any arguments. If it is called, a failure is reported immediately.

### Specifying AtLeast Cardinality

```cpp
EXPECT_CALL(mock, Update(_)).Times(AtLeast(3));
```

Here, the method `Update` is expected to be called *at least* 3 times; any additional calls are allowed.

### Combining Cardinality with Actions

```cpp
EXPECT_CALL(mock, GetValue())
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillOnce(Return(30));
```

This expectation asserts exactly 3 calls will occur in any order with the specified return values.

### Using Between Cardinality

```cpp
EXPECT_CALL(mock, Process(_)).Times(Between(2, 4));
```

Accepts between 2 and 4 calls to `Process` inclusive.

---

## Best Practices & Tips

- Always set expectations prior to exercising code that calls mocks.
- Use `.RetiresOnSaturation()` for expectations that should be exhausted and no longer apply subsequently.
- Add a catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());` for methods where extra calls are acceptable but should not fail.
- Use strict mocks (`StrictMock<T>`) to treat uninteresting calls as failures, or nice mocks (`NiceMock<T>`) to suppress warnings.
- Use `Mock::VerifyAndClearExpectations(&mock_object)` to manually trigger verification before object destruction.

---

## Troubleshooting

### Unexpected Call Failure

Occurs when a mock method is called with arguments that don’t match any active expectation:

- Verify your argument matchers.
- Check call ordering and sequencing if `.InSequence()` or `.After()` clauses are used.

### Too Few Calls Detected

If an expected call count is not reached:

- Confirm your code under test is exercising the mock as expected.
- Consider relaxing `.Times()` cardinality if the exact count is not necessary.

### Too Many Calls Detected

If a mock method is called more times than expected:

- Use `.RetiresOnSaturation()` to retire expectation after saturation if appropriate.
- Add catch-all expectations with `Times(AnyNumber())` to allow other calls.

### Warning About Action Counts

GoogleMock warns when `.WillOnce()` or `.WillRepeatedly()` clauses do not align with `.Times()` cardinality:

- Adjust the numbers of `.WillOnce()` clauses to match.
- Add `.WillRepeatedly()` for calls above `WillOnce` count.

---

## Additional Resources

- [Mocking Basics Guide](/guides/mocking-and-test-doubles/mock-basics)
- [Mocking Best Practices](/guides/mocking-and-test-doubles/mocking-best-practices)
- [EXPECT_CALL Documentation](../docs/reference/mocking.md#EXPECT_CALL)
- [Cardinalities Source Code](https://github.com/google/googletest/blob/main/googlemock/include/gmock/gmock-cardinalities.h)
- [gMock Cookbook Cardinalities Section](../docs/gmock_cook_book.md#WritingNewCardinalities)

---

## Summary

Cardinalities specify how many times a mock method is expected to be called, allowing precise yet flexible testing of call counts. This page details the core cardinalities available (`AnyNumber()`, `AtLeast(n)`, `AtMost(n)`, `Between(m, n)`, `Exactly(n)`), illustrates how GoogleMock infers cardinalities, explains expectation retirement and error handling for mismatched call counts, and offers guidance for typical usage and troubleshooting. Understanding and using cardinalities effectively is crucial to writing clear, stable, and meaningful mock-based tests.

---