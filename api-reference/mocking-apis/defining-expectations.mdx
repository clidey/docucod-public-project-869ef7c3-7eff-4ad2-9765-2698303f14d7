---
title: "Setting Expectations and Actions"
description: "Explanation of ON_CALL and EXPECT_CALL APIs for specifying expected interactions and behaviors of mocks. Documents cardinalities, invocation order, and composing actions for sophisticated behavioral tests."
---

# Setting Expectations and Actions

GoogleMock provides two core macros for defining how mock objects behave and what interactions they expect during tests: `ON_CALL()` and `EXPECT_CALL()`. This page explains how to specify expected interactions and mock behaviors, focusing on cardinalities, invocation order, and composing sophisticated actions to build flexible and precise behavioral tests.

---

## Overview

- **ON_CALL** sets the *default behavior* of a mock method without imposing any requirement that the method is called.
- **EXPECT_CALL** both *specifies behavior* and *sets expectations* on how many times, with what arguments, and in what order the mock method is expected to be called.

Understanding when and how to use each macro is key to writing clear, maintainable, and robust tests.


## ON_CALL: Defining Default Behaviors

### Purpose

`ON_CALL` configures the default action taken by a mock object when a method is invoked, but does not require that the method be called during the test.

Use `ON_CALL` to provide common mock behavior used across multiple tests without asserting that the calls happen.

### Syntax and Usage

```cpp
ON_CALL(mock_object, Method(matcher1, matcher2, ...))
    .With(multi_argument_matcher) // optional
    .WillByDefault(action);
```

- `.With(...)` restricts the behavior to call arguments matching the multi-argument matcher.
- `.WillByDefault(...)` specifies the action to perform when the mock method is called.

### Behavior Notes

- The latest matching `ON_CALL` takes precedence.
- If no `ON_CALL` applies, GoogleMock uses the built-in default action:
  - For void methods: does nothing.
  - For integral, pointer, or default-constructible types: returns a default value.

### Best Practices

- Use `ON_CALL` to define behavior that applies generally to a mock method.
- Configure common mock behavior in setup code or mock constructors.
- Avoid using `EXPECT_CALL` for calls you don’t want to verify.

<Callout>
**Tip:** If you see the warning "Uninteresting mock function call", it means a method was called without an `EXPECT_CALL`. Using `ON_CALL` or writing `EXPECT_CALL(...).Times(AnyNumber())` can suppress these warnings safely without over-constraining your tests.
</Callout>

---

## EXPECT_CALL: Setting Call Expectations

### Purpose

`EXPECT_CALL` defines an expectation on how many times a mock method will be called, with what arguments, in what order, and what it should do when called.

This is the primary mechanism to write tests that assert and verify interactions with mocks.

### General Syntax

```cpp
EXPECT_CALL(mock_object, Method(matcher1, matcher2, ...))
    .With(multi_argument_matcher)           // optional, must be first
    .Times(cardinality)                     // optional
    .InSequence(sequence1, sequence2, ...) // optional, any number
    .After(expectation1, expectation_set2, ...)
    .WillOnce(action1)                      // zero or more times
    .WillRepeatedly(action)                 // optional
    .RetiresOnSaturation();                 // optional
```

Clause details:

- **With()** – Filters calls based on a matcher for all arguments as a tuple; can only occur once and must be first (if used).
- **Times()** – Specifies the expected number of calls (cardinality). See below.
- **InSequence()** – Specifies that this expectation is in one or more sequences requiring calls in a particular order.
- **After()** – Sets call ordering by specifying that this call must happen after other expectations.
- **WillOnce()** – Specifies actions performed sequentially on matching calls.
- **WillRepeatedly()** – Specifies the action used when WillOnce actions have been exhausted.
- **RetiresOnSaturation()** – Causes the expectation to retire after it has been saturated, allowing subsequent expectations to handle calls.

### Call Cardinalities

The `.Times()` clause controls how often the expectation is valid:

| Cardinality           | Meaning                             |
|----------------------|-----------------------------------|
| `AnyNumber()`        | Zero or more calls allowed         |
| `AtLeast(n)`         | At least *n* calls expected        |
| `AtMost(n)`          | At most *n* calls allowed          |
| `Between(m, n)`      | Between *m* and *n* calls inclusive|
| `Exactly(n)` or `n`  | Exactly *n* calls expected          |

Default inference:

- If no `Times()`, `WillOnce()`, or `WillRepeatedly()` are specified, the default is `Times(1)`.
- If `n` `WillOnce()` are specified without a `WillRepeatedly()`, cardinality defaults to calling *n* times exactly.
- If `WillOnce()` and `WillRepeatedly()` appear, cardinality defaults to `Times(AtLeast(n))`.

<Note>
Omitting `Times()` can simplify test code, but be careful to specify it explicitly if your test depends on call counts.
</Note>

### Setting Invocation Order

You can constrain the order of calls using either **Sequences** or **After()**:

- **Sequences**: define partial or full linear orders between expectations.

  Example:

  ```cpp
  Sequence s1, s2;
  EXPECT_CALL(mock, Func1()).InSequence(s1);
  EXPECT_CALL(mock, Func2()).InSequence(s1, s2);
  EXPECT_CALL(mock, Func3()).InSequence(s2);
  ```

  This forms a DAG of call order dependencies.

- **After()**: defines explicit dependencies between expectations.

  Example:

  ```cpp
  Expectation e1 = EXPECT_CALL(mock, Init());
  Expectation e2 = EXPECT_CALL(mock, Start()).After(e1);
  ```

  The matching call to `Start()` must happen after `Init()`.

You can combine `InSequence` and `After()` for sophisticated ordering control.

### Actions: Specifying Behavior

`EXPECT_CALL` lets you specify how the mock method should behave when called.

- `WillOnce(action)` – assigns an action for a single call, allowing multiple `WillOnce()` to create sequences of behaviors.
- `WillRepeatedly(action)` – defines an action used after all `WillOnce()` actions are exhausted.

Typical actions include:

- `Return(value)`
- `ReturnRef(reference)`
- `Invoke(function, args...)`
- `DoAll(action1, action2, ... )` to combine multiple actions

### Making Expectations Sticky or Retiring

By default, expectations are "sticky," meaning they remain active even after their call count upper bound is reached. This can cause unexpected "called more times than expected" failures.

You can disable stickiness with `.RetiresOnSaturation()`, so the expectation retires (becomes inactive) once saturated. This is useful to compose expectations that should only be matched a finite number of times in sequences or ordered sets.

### Examples

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::Exactly;
using ::testing::Sequence;

MockTurtle turtle;
Sequence s;

// Expect PenDown() once, then Forward(10) twice, in order.
EXPECT_CALL(turtle, PenDown()).InSequence(s).Times(1);
EXPECT_CALL(turtle, Forward(10)).InSequence(s).Times(2);

// Set common default behavior for GoTo any location.
ON_CALL(turtle, GoTo(_, _))
    .WillByDefault(Return());

// Expect GoTo(0,0) exactly twice.
EXPECT_CALL(turtle, GoTo(0, 0))
    .Times(Exactly(2))
    .WillRepeatedly(Return());

// Exercise code...
```


## Common Pitfalls and Troubleshooting

- **Uninteresting calls warning:** When calling methods that have no expectations (i.e., no `EXPECT_CALL` and no suitable `ON_CALL`), GoogleMock emits warnings. This indicates you may want to use `ON_CALL` to specify default behavior or add `EXPECT_CALL(...).Times(AnyNumber())` for those calls you want to permit.

- **Multiple `With()` clauses:** Only one `.With()` clause is allowed per expectation or default action.

- **Cardinality conflicts:** Make sure not to specify `.Times()` more than once, and ensure cardinalities align with the number of `WillOnce()` and `WillRepeatedly()` clauses.

- **Order of clauses:** Clauses in `EXPECT_CALL` must appear in the documented order: `.With()` first, then `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, `.RetiresOnSaturation()` last.

- **Sticky expectations:** Without `.RetiresOnSaturation()`, expectations remain active after saturation, which can cause multiple-match errors. Use this flag or sequences to control order and saturation.

- **Unexpected calls:** Calls that don't match any active expectation are errors unless matched by permissive expectations.

---

## User Flow: Writing Mock Expectations

<Steps>
<Step title="Define your mock class">
Use `MOCK_METHOD` to create mock methods with the same signature as the real interface.
</Step>
<Step title="Setup default behaviors">
Use `ON_CALL()` in fixture setup or mock constructors to define common mock behavior.
</Step>
<Step title="Write test and specify expectations">
Use `EXPECT_CALL()` in your test functions to assert when and how your mock methods should be called, attaching cardinalities, sequences, and actions.
</Step>
<Step title="Run your tests">
Exercise the code under test; GoogleMock will verify if expectations were met when mocks are destroyed or manually verified.
</Step>
<Step title="Iterate and refine">
Adjust expectations and behaviors to improve test clarity, robustness, and maintainability.
</Step>
</Steps>

---

## Advanced Usage Tips

### Combining Actions
Use `DoAll(action1, action2, ..., actionN)` to perform multiple actions in sequence on a single invocation.

### Using Argument Matchers
Leverage the `.With()` clause to make assertions about the entire set of arguments together, enabling complex logical constraints on call parameters.

Example:

```cpp
EXPECT_CALL(mock, Func(_, _))
    .With(Lt());  // First argument less than second
```

### Specifying Partial Order of Calls
Use multiple `Sequence` objects together with `.InSequence(...)` to specify partial ordering or DAGs of call expectations.

### Verifying and Clearing Expectations Early
Call `Mock::VerifyAndClearExpectations(&mock)` before mock destruction if you want to verify expectations early.

### Dealing with Overloaded Methods
If your mock method is overloaded, you must disambiguate the overload by specifying the full parameter list in `EXPECT_CALL` and `ON_CALL` to avoid compilation errors.

---

## Troubleshooting Common Issues

| Problem                                                       | Solution or Explanation                                   |
|---------------------------------------------------------------|-----------------------------------------------------------|
| Uninteresting call warnings                                   | Use `ON_CALL` to specify default behaviors or `EXPECT_CALL(...).Times(AnyNumber())` to accept calls. |
| Unexpected calls failing tests                                 | Add missing or broader `EXPECT_CALL`s to cover these calls.|
| Over-saturation errors when calls exceed expected call counts  | Use `.RetiresOnSaturation()` or adjust `.Times()` cardinality. |
| Calls out of order when using sequences                         | Check that all related expectations are in the same sequence; consider using `.After()`. |
| Ambiguous overloaded method errors                             | Fully specify argument list in expectation or default action. |

---

## See Also

- [gMock Cookbook: Knowing When to Expect](docs/gmock_cook_book.md#UseOnCall)
- [Mocking Reference: EXPECT_CALL](docs/reference/mocking.md#EXPECT_CALL)
- [Mocking Reference: ON_CALL](docs/reference/mocking.md#ON_CALL)
- [Matchers Reference](api-reference/matcher-action-references/matchers-reference)
- [Actions Reference](api-reference/matcher-action-references/actions-reference)
- [Writing Mock Expectations](guides/mocking-with-googlemock/writing-mock-expectations)

---