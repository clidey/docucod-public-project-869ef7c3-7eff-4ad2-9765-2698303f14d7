---
title: "Actions and Advanced Mocking"
description: "Details the library of built-in and user-defined actions, including return values, side-effects, moving/copying parameters, and invoking callbacks. Covers advanced behaviors with variadic templates and the mechanics of fine-tuned mock responses."
---

# Actions and Advanced Mocking

This page provides an in-depth exploration of the library of built-in and user-defined actions available in GoogleMock. It covers the return values and side effects of actions, the mechanics of moving and copying parameters in mocks, invoking callbacks, and advanced behaviors involving variadic templates. Additionally, this page explains how to compose fine-tuned mock responses to simulate complex behaviors in tests.

---

## Overview of Actions

Actions define what a mock method does when invoked. They can return values, manipulate arguments, invoke functions or callbacks, throw exceptions, or combine multiple operations. Using actions effectively allows you to mimic complex behaviors, simulate side effects, and control the flow of your tests.

---

## Returning Values and References from Mock Methods

### Returning Values

The simplest action returns a pre-defined value:

```cpp
using ::testing::Return;
...
EXPECT_CALL(mock, Method()).WillOnce(Return(value));
```

Note: The `Return()` action converts the provided value to the method's return type at the time the expectation is set, not when executed.

### Returning References

For mock methods returning references, use `ReturnRef()` to return a live reference:

```cpp
using ::testing::ReturnRef;
...
EXPECT_CALL(mock, GetObject())
    .WillOnce(ReturnRef(existing_object));
```

### Returning Live Values

If you want the mock to return the current value of an object at call time, use:

- `ReturnRef()` for references
- `ReturnPointee()` for pointer types

Example:

```cpp
int x = 10;
EXPECT_CALL(mock, GetValue()).WillRepeatedly(ReturnPointee(&x));
x = 42;
EXPECT_EQ(42, mock.GetValue());
```

---

## Mocking Side Effects

Mocked methods often trigger side effects by modifying arguments or external state.

### Setting Output Arguments

You can assign to pointer or reference arguments using actions like `SetArgPointee<N>(value)`:

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(SetArgPointee<1>(5));
```

This sets the second argument's pointee to 5.

For multiple side effects along with a return value, combine actions using `DoAll()`:

```cpp
EXPECT_CALL(mock, MutateInt(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

### Setting Array Arguments

Use `SetArrayArgument<N>(first, last)` to copy elements into an output array or iterator:

```cpp
int values[3] = {1, 2, 3};
EXPECT_CALL(mock, FillArray(_))
    .WillOnce(SetArrayArgument<0>(values, values + 3));
```

---

## Using Functions, Functors, or Lambdas as Actions

You can use any callable object compatible with the mock method's signature as an action, via `Invoke()`.

Example:

```cpp
int Sum(int x, int y) { return x + y; }
EXPECT_CALL(mock, Add(_, _))
    .WillOnce(Invoke(&Sum));
```

You can also invoke a callable that takes **no** arguments using `InvokeWithoutArgs()`:

```cpp
bool Job() { return true; }
EXPECT_CALL(mock, Run())
    .WillOnce(InvokeWithoutArgs(&Job));
```

---

## Invoking Callbacks Passed as Arguments

Often mock methods receive function pointers or callbacks as parameters. You can invoke such callables directly using `InvokeArgument<N>(args...)`, which calls the N-th argument with provided parameters.

Example:

```cpp
EXPECT_CALL(mock, DoTask(_, _))
    .WillOnce(InvokeArgument<1>(5)); // Calls callback with 5
```

If the callback argument requires reference parameters, wrap them with `std::ref()`:

```cpp
Helper helper;
EXPECT_CALL(mock, Bar(_))
    .WillOnce(InvokeArgument<0>(5, std::ref(helper)));
```

---

## Combining Multiple Actions

`DoAll(a1, a2, ..., an)` performs all actions in sequence when the mock method is called, returning the value of the last action. The first `n-1` actions must return `void`.

Example:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(10)));
```

---

## Argument Selection and Adaptation in Actions

### Selecting Arguments for Custom Actions

Sometimes you need to invoke an action with only a subset of mock method arguments:

```cpp
EXPECT_CALL(mock, Foo(_, _, _))
    .WillOnce(WithArgs<0, 2>(Invoke(MyAction)));
```

### Ignoring Unused Arguments

If some action parameters are not needed, declare them as `Unused` in the function signature for clarity.

### Ignoring an Action's Return Value

If an action returns a value but you want to ignore it (e.g., for a `void` mock method), use `IgnoreResult()`:

```cpp
EXPECT_CALL(mock, Abc(_))
    .WillOnce(IgnoreResult(ProcessFunction));
```

Note: `IgnoreResult()` must not be used on actions already returning void.

---

## Sharing Actions and Matchers

Both actions and matchers are efficiently copyable. You can assign and reuse complex actions or matchers, avoiding needless rebuilds and improving readability.

Example:

```cpp
auto set_flag = DoAll(SetArgPointee<0>(true), Return(true));
EXPECT_CALL(mock, Func()).WillRepeatedly(set_flag);
```

Be cautious when sharing stateful actions, as different mock method expectations may share state unintentionally.

---

## Mock Behaviors Controlled by Strictness

You control how your mock objects treat uninteresting calls (calls made without expectations) by wrapping mocks as:

- `NiceMock<T>` — suppress warnings on uninteresting calls
- `NaggyMock<T>` — the default, warns on uninteresting calls
- `StrictMock<T>` — treats uninteresting calls as failures

Example:

```cpp
NiceMock<MockFoo> nice_mock;
StrictMock<MockFoo> strict_mock;
```

---

## Using Variadic and Template-based Advanced Actions

GoogleMock provides variadic template support in actions to handle functions with many parameters. Through generic actions and macros like `ACTION_TEMPLATE`, you can create parameterized actions that accept template arguments explicitly, enabling the design of reusable and flexible mock behaviors.

Example of a parameterized action template:

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(DuplicateArg<1, unsigned char>(&n));
```

---

## Moving and Copying Parameters in Mock Calls

GoogleMock supports mocking methods taking move-only types (`std::unique_ptr`, etc.). Use `MOCK_METHOD` normally, but specify actions with lambdas or functors to correctly support move semantics.

Example:

```cpp
class MockBuzzer : public Buzzer {
 public:
  MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
  MOCK_METHOD(bool, ShareBuzz, (std::unique_ptr<Buzz> buzz, int64_t timestamp), (override));
};

EXPECT_CALL(mock_buzzer_, MakeBuzz("hello"))
    .WillOnce([](StringPiece) { return std::make_unique<Buzz>(AccessLevel::kInternal); });

EXPECT_CALL(mock_buzzer_, ShareBuzz(NotNull(), _)).WillOnce(Return(true));
```

Care must be taken with actions that copy arguments internally; some built-in actions may not support move-only types.

---

## Fine-Tuning Mock Responses with Retiring Expectations

Expectations in GoogleMock are "sticky" by default—they remain active even after being saturated. Use `.RetiresOnSaturation()` to make expectations retire as soon as saturated, allowing subsequent expectations to take effect.

Example:

```cpp
EXPECT_CALL(mock, Method())
    .WillOnce(Return(1))
    .RetiresOnSaturation();
EXPECT_CALL(mock, Method())
    .WillOnce(Return(2))
    .RetiresOnSaturation();
```

This is particularly useful when expecting sequential calls with different behaviors.

---

## Delegating Mock Calls

You can delegate calls from mocks to fakes, real objects, or parent class implementations to reuse existing code while retaining verification.

- Delegate to fake:

```cpp
void DelegateToFake() {
  ON_CALL(*this, DoThis).WillByDefault([this](int n) { return fake_.DoThis(n); });
}
```

- Delegate to real:

```cpp
ON_CALL(*this, DoThis).WillByDefault([this](int n) { return real_.DoThis(n); });
```

- Delegate to parent:

```cpp
EXPECT_CALL(mock, Concrete)
    .WillOnce([&mock](const char* str) { return mock.Foo::Concrete(str); });
```

---

## Practical Tips and Common Pitfalls

- Use `ON_CALL` for default mock behaviors; prefer `EXPECT_CALL` only when verifying call counts or arguments.
- Avoid over-specifying expectations to prevent brittle tests.
- When mocking overloaded methods, be sure to mock all overloads or use `using BaseClass::Method;` to prevent hiding.
- Watch out for unprotected commas in template arguments to `MOCK_METHOD`; wrap complex types in extra parentheses or use type aliases.
- Test with `--gmock_verbose=info` to get detailed insights on expectation matching and uninteresting calls.
- Use `VerifyAndClearExpectations()` if your mock object’s lifetime extends beyond the test scope.

---

## Summary

This page equips you with a comprehensive understanding of how to use actions within GoogleMock to define custom mock behaviors, handle complex argument and return value scenarios, and compose multi-step operations. It also covers advanced mocking techniques such as templated actions, move-only parameter handling, call delegation, and managing mock strictness.

Explore the related detailed references and the gMock Cookbook to master effective mocking strategies.

---

## See Also

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Practical recipes for mocks and actions
- [Mocking Reference](./reference/mocking.md) — Technical details on macros and expectations
- [Actions Reference](./reference/actions.md) — List of built-in actions and how to define custom ones
- [Using gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Introductory guide
- [Strictness and Uninteresting Calls](./api-reference/mocking-apis/strictness-and-uninteresting-calls) — Controlling mock behavior

---

## Code Example: Multiple Actions with Invoking Callback

```cpp
class MockProcessor {
 public:
  MOCK_METHOD(void, Process, (int data, std::function<void(int)> callback));
};

TEST(ProcessorTest, ProcessInvokesCallback) {
  MockProcessor mock;

  EXPECT_CALL(mock, Process(_, _))
      .WillOnce(DoAll(
          Invoke([](int data, std::function<void(int)> cb) { cb(data + 1); }),
          Return()));

  bool callback_called = false;
  mock.Process(5, [&](int result) {
    callback_called = true;
    EXPECT_EQ(result, 6);
  });
  EXPECT_TRUE(callback_called);
}
```

---