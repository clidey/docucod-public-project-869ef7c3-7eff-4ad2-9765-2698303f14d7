---
title: "Platform and Build Configuration"
description: "Reference for platform abstraction APIs, environment and flag settings, and best practices for integrating GoogleTest/GoogleMock with build systems and adjusting for OS/compiler differences."
---

# Platform and Build Configuration

This reference documentation guides you through the platform abstraction APIs, environment and flag settings, and best practices for integrating GoogleTest and GoogleMock with build systems. It also explains how GoogleTest adapts to OS and compiler differences, providing tips and practical advice to configure and build the framework effectively on your platform.

---

## 1. Platform Abstraction and Environment Macros

GoogleTest provides a rich set of macros and abstractions that enable it to operate correctly across diverse operating systems and compiler environments. These macros let GoogleTest detect capabilities such as threading support, exception handling, regular expression engines, and OS-specific features. Understanding these macros enables you to customize or troubleshoot your build and integration.

### Key Platform Macros

GoogleTest automatically defines the following macros based on the detected platform:

- **Platform Indicators (GTEST_OS_\*)**
  - Detects the OS type, e.g., `GTEST_OS_LINUX`, `GTEST_OS_WINDOWS_DESKTOP`, `GTEST_OS_MAC`, `GTEST_OS_CYGWIN`, and many others.
  - Enables platform-specific code paths and workarounds.

- **Feature Availability (GTEST_HAS_\*)**
  - `GTEST_HAS_PTHREAD`: Indicates availability of POSIX threads and used to provide thread safety.
  - `GTEST_HAS_EXCEPTIONS`: Signals if C++ exception handling is enabled.
  - `GTEST_HAS_RTTI`: Specifies whether RTTI (Run-time type information) is active.
  - `GTEST_HAS_STD_WSTRING`: Whether `std::wstring` support exists on the platform.
  - `GTEST_HAS_DEATH_TEST`: Whether death tests are supported (platform & file system dependent).
  - `GTEST_HAS_POSIX_RE`: Availability of POSIX regex.

- **Thread Safety**
  - `GTEST_IS_THREADSAFE` macro indicates if GoogleTest is thread-safe on the current platform.

- **Stream Redirection**
  - `GTEST_HAS_STREAM_REDIRECTION` measures whether stdout/stderr redirection is supported by the platform.

- **Other Macros**
  - Macros for structured exception handling availability
  - Macros for clone system call availability on Linux
  - Macros for path separator differences

### Overriding Platform Behavior

Typically, GoogleTest auto-detects platform features. However, you can override defaults by defining these macros explicitly in your build system or compiler flags, for example:

```cmake
add_compile_definitions(-DGTEST_HAS_PTHREAD=1)
```

Use overrides to address unusual environments or to force features on or off, especially when porting or cross-compiling.

---

## 2. Environment and Flag Management

GoogleTest uses environment variables and command-line flags to configure test behavior dynamically.

- Use `GTEST_FLAG(flag_name)` macros to access internal flag variables safely in your test environment.
- Environment variables corresponding to command-line flags are parsed for flexible configuration, supporting boolean, integer, and string values.

### Recommended Usage

Initialize flags at program start with:

```cpp
int main(int argc, char** argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This informs GoogleTest to parse and setup flags, removing them from your program's argument list.

---

## 3. Compiler and Build System Integration

Setting up GoogleTest and GoogleMock requires correct compiler flags, linker options, and build tool configurations to handle OS and compiler nuances.

### CMake Integration Best Practices

GoogleTest provides internal CMake utility functions to ease configuration:

- **Compiler Flags**
  - GoogleTest’s CMake scripts automatically configure exception handling (`-fexceptions` or `/EHsc`), RTTI, warning levels, and threading flags.
  - On MSVC, flags like `/W4`, `/utf-8`, and static runtime options (`-MT`) are handled to avoid runtime mismatches.

- **Threading Support**
  - CMake detects pthread availability and defines `GTEST_HAS_PTHREAD` appropriately.

- **Library Definitions**
  - `cxx_library_with_type` function creates either static or shared GoogleTest libraries with proper properties.

- **Executable and Test Targets**
  - `cxx_test()` and related macros let you create test executables with all required flags and link dependencies, and register tests automatically.

- **Pkg-config Support**
  - GoogleTest installs `.pc` files that declare compiler flags and link libraries.
  - You can use `pkg-config` in your build system to retrieve all necessary compile and link flags.

### Pkg-config Usage Examples

```cmake
find_package(PkgConfig)
pkg_search_module(GTEST REQUIRED gtest_main)

add_executable(testapp samples/sample3_unittest.cc)
target_link_libraries(testapp PRIVATE ${GTEST_LDFLAGS})
target_compile_options(testapp PRIVATE ${GTEST_CFLAGS})

enable_testing()
add_test(NAME first_and_only_test COMMAND testapp)
```

> Avoid using `target_include_directories` or `target_link_libraries` with pkg-config `_INCLUDE_DIRS` and `_LIBRARIES` variables because they may omit essential flags such as `-pthread`.

### Troubleshooting pkg-config

If pkg-config cannot find GoogleTest, set the environment variable to point to the `.pc` files location, for example:

```
export PKG_CONFIG_PATH=/usr/local/lib64/pkgconfig
```

For cross-compilation setups, use:

```
export PKG_CONFIG_ALLOW_SYSTEM_CFLAGS=yes
export PKG_CONFIG_ALLOW_SYSTEM_LIBS=yes
export PKG_CONFIG_DIR=
export PKG_CONFIG_SYSROOT_DIR=/home/MYUSER/sysroot
export PKG_CONFIG_LIBDIR=${PKG_CONFIG_SYSROOT_DIR}/usr/lib64/pkgconfig
```

This ensures `pkg-config` uses the sysroot-aware include and lib directories.

---

## 4. Platform-specific and Compiler-specific Adjustments

GoogleTest detects platform and compiler types early, setting macros to address differences:

- **Windows vs POSIX**
  - Platform-specific headers and functions are wrapped.
  - Special handling for Windows threading and synchronization primitives.

- **MSVC-Focused Adjustments**
  - Microsoft Visual C++ exception and RTTI detection.
  - Disabling noisy warnings, enforcing UTF-8 source encoding.

- **GCC and Clang Adjustments**
  - Flag settings for warnings, RTTI and exceptions.

- **Static vs Dynamic Runtime Conflicts**
  - Guidance on building GoogleTest with static or dynamic runtimes, especially on Windows Visual Studio (e.g., `-MT` vs `-MD` flags).

- **Provisions for Embedded and Uncommon Platforms**
  - Macros for platforms like Windows Mobile, Android, ESP8266, etc., disabling features that are unsupported.

---

## 5. Threading and Synchronization Primitives

GoogleTest supports multithreading on platforms that provide POSIX threads or Windows threading primitives. It defines:

- **Mutex and MutexLock** classes providing mutual exclusion support.
- **ThreadLocal** storage abstractions allowing thread-local variable management.
- **Notification** utilities for inter-thread coordination (used internally).

These primitives adapt to the available platform mechanisms and are used internally to ensure thread safety in parallel test cases and death tests.

When building on platforms without threads, dummy implementations are provided to allow compiling without multi-threading support.

---

## 6. Best Practices for Integrating GoogleTest and GoogleMock in Build Systems

- Always use an environment that supports C++17 or above.
- Prefer using GoogleTest’s CMake build and integration system to leverage its automatic platform configuration.
- Link your test targets with `gtest_main` if you don't need a custom main.
- Use pkg-config files if integrating with other build systems and to ensure flags like `-pthread` are included correctly.
- Define or override macros (e.g., `GTEST_HAS_PTHREAD`) if the default detection fails.
- Use CMake helper macros/functions such as `cxx_test` or `cxx_executable_with_flags` to reduce boilerplate and ensure consistent compiler flags.
- Keep shared and static runtime linkage consistent to avoid linker errors (especially MSVC).

<Tip>
When configuring your build environment, always test that thread safety macros like `GTEST_IS_THREADSAFE` are defined as expected by running sample multi-threaded tests.
</Tip>

<Warning>
Common pitfalls include missing `-pthread` in compile and link flags, resulting in link errors. Using pkg-config or CMake helper functions eliminates these issues.
</Warning>

---

## 7. Troubleshooting and Common Issues

- **Linker Errors on Pthread Symbols**: Ensure `-pthread` or equivalent is passed during compilation and linking.
- **Multiple Runtime Libraries Errors on Windows**: Use the `gtest_force_shared_crt` CMake option to align runtime library linkage.
- **Pkg-config Fails to Locate .pc Files**: Set `PKG_CONFIG_PATH` or `PKG_CONFIG_LIBDIR` to point to the installation directories of GoogleTest’s pkg-config files.
- **Platform Detection Fails**: Define `GTEST_OS_*` or feature macros manually in your compiler flags as a fallback.

---

## 8. Example: Simple CMake Setup with GoogleTest

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyTests LANGUAGES CXX)

# Find GoogleTest using pkg-config or find_package
find_package(PkgConfig REQUIRED)
pkg_search_module(GTEST REQUIRED gtest_main)

add_executable(MyTestExample tests/example_test.cc)
target_link_libraries(MyTestExample PRIVATE ${GTEST_LDFLAGS})
target_compile_options(MyTestExample PRIVATE ${GTEST_CFLAGS})

enable_testing()
add_test(NAME MyTestExample COMMAND MyTestExample)
```

This ensures correct compilation/linking and platform-aware flags seamlessly.

---

## 9. Additional Resources

- [GoogleTest Platform Support and Macros](googletest/include/gtest/internal/gtest-port.h)
- [Using pkg-config with GoogleTest](docs/pkgconfig.md)
- [GoogleTest Custom Platform Configuration](googletest/include/gtest/internal/custom/README.md)
- [GoogleTest Build Instructions and CMake integration](googletest/README.md)
- [Supported Platforms Overview](docs/platforms.md)


---

## Mermaid Diagram: Build and Platform Feature Detection Flow

```mermaid
flowchart TD
  A[Build Script or User Compiler Flags] --> B{Platform/Compiler Auto-detection}
  B -->|Detect OS| C[GTEST_OS_* macros]
  B -->|Detect Compiler| D[Compiler specific flags]
  B -->|Detect Threads| E[GTEST_HAS_PTHREAD]
  B -->|Detect Exceptions| F[GTEST_HAS_EXCEPTIONS]
  B -->|Detect RTTI| G[GTEST_HAS_RTTI]
  B -->|Detect Regex Engine| H[GTEST_USES_RE2 / POSIX / SIMPLE]

  subgraph Platform Abstraction Layer
    C --> I[Threading & Synchronization Primitives]
    D --> I
    E --> I
  end

  I --> J[Build System (CMake / Bazel / Others)]
  J --> K[Apply Compiler & Linker Flags]

  K --> L[GoogleTest and GoogleMock Build]
  L --> M[User Test Binaries]

  subgraph User
    N[Write Tests] --> M
    O[Set Environment Variables and Flags] --> M
  end

  M --> P[Run Tests with Correct Platform Flags and Support]
```
```

---