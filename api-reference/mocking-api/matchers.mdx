---
title: "Matchers and Expectations"
description: "Comprehensive guide to the matcher APIs, which define flexible expectations on mock method arguments. Includes built-in matchers, custom matcher definitions, and advanced composition patterns for readable, robust tests."
---

# Matchers and Expectations

GoogleMock’s matcher APIs provide a powerful and expressive way to define flexible expectations on the arguments passed to mock methods. This documentation guides you through the core concepts, built-in matchers, custom matcher creation, and advanced composition patterns that help you write readable, robust, and maintainable tests.

---

## 1. Understanding Matchers: Defining What to Expect

Matchers are predicates that verify whether mock method arguments meet certain criteria when the method is called. You use matchers primarily in `EXPECT_CALL` and `ON_CALL` to specify **which values** the mock methods should accept.

### Basic Usage

- Use `EXPECT_CALL(mock_object, Method(matcher1, matcher2, ...))` to state that `Method` will be called with arguments satisfying those matchers.
- The wildcard matcher `_` matches any value, allowing you to ignore specific arguments.
- Literal values (e.g., `5`) are implicitly converted to simple equality matchers (`Eq(5)`).

```cpp
using ::testing::_;
using ::testing::Eq;

EXPECT_CALL(turtle, Forward(100));  // Expects Forward(100)
EXPECT_CALL(turtle, GoTo(50, _));  // Expects GoTo(x=50, any y)
EXPECT_CALL(turtle, Turn(_));       // Expects Turn with any argument
```

### Advanced Argument Matching

Matchers are composable and can express rich conditions:

- Comparison: `Ge(5)` (≥ 5), `Lt(10)` (< 10), `Between(3, 7)`
- String matching: `StartsWith("abc")`, `HasSubstr("xyz")`
- Containers: `ElementsAre(1, _, 3)` matches container elements with specific patterns
- Pointers: `NotNull()`, `Pointee(Eq(42))` to validate pointers or their contents

```cpp
EXPECT_CALL(foo, Bar(AllOf(Ge(5), Ne(10))));  // Arg ≥ 5 and ≠ 10
EXPECT_CALL(foo, Baz(Property(&Qux::name, StartsWith("John")))); // name starts with
```

## 2. Setting Expectations with `EXPECT_CALL`

`EXPECT_CALL` sets *explicit expectations* on mock methods. It specifies:

- Which method is expected to be called
- With what arguments (via matchers)
- How many times (`Times()` cardinality)
- In what order (`InSequence`, `After`)
- What actions to perform (`WillOnce`, `WillRepeatedly`)

### Syntax and Workflow

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .Times(cardinality)
    .InSequence(sequence...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

All clauses except `Times`, `WillOnce`, `WillRepeatedly` are optional.

#### Times

Defines how many calls are expected. Some common options:

- `Times(1)` : Exactly once
- `Times(0)` : Never called
- `AtLeast(n)`, `AtMost(n)`, `Between(m,n)`, `AnyNumber()`

If omitted, gMock infers cardinality based on the presence of actions.

#### InSequence and After

To enforce call ordering:

- `InSequence(seq1, seq2)`: Expected in strict order within given sequences.
- `After(expectation1, expectation2)`: Call must occur after other expectations.

Use these to express linear or partial orders on method calls.

#### Actions

Define return values or side effects with `WillOnce()` / `WillRepeatedly()`.

```cpp
EXPECT_CALL(foo, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

`WillOnce` defines behaviors for each call in order. `WillRepeatedly` applies to all subsequent calls.

#### RetiresOnSaturation

When an upper bound on expected calls is reached, use `.RetiresOnSaturation()` to deactivate the expectation so older, more general expectations can take over.

### Example: Combining Expectations

```cpp
EXPECT_CALL(turtle, GoTo(_, _)).Times(AnyNumber());         // #1
EXPECT_CALL(turtle, GoTo(0, 0)).Times(2).RetiresOnSaturation();  // #2
```

This expects the `GoTo(0,0)` call exactly twice; additional calls match the general case (#1). Expectation #2 is ordered after #1 because newer expectations override older ones.

## 3. Setting Default Behavior with `ON_CALL`

`ON_CALL` differs from `EXPECT_CALL` by not requiring the method to be called—it only specifies the default behavior when invoked.

Typical usage:

```cpp
ON_CALL(mock_object, Method(matchers...))
    .WillByDefault(action);
```

This sets fallback behavior for calls that do not have matching `EXPECT_CALL`s.

Use `ON_CALL` for common setup in test fixtures; use `EXPECT_CALL` for test-specific expectations.

## 4. Built-in Matchers Overview

The matcher API provides these common matcher categories:

| Category                  | Description                                           |
|---------------------------|-------------------------------------------------------|
| Wildcard                  | `_` matches any argument                             |
| Equality and Comparison   | `Eq()`, `Ne()`, `Lt()`, `Le()`, `Gt()`, `Ge()`     |
| Logical Combinators       | `AllOf()`, `AnyOf()`, `Not()`                        |
| String matchers           | `StartsWith()`, `EndsWith()`, `HasSubstr()`          |
| Container matchers        | `ElementsAre()`, `UnorderedElementsAre()`, `Contains()` |
| Pointer matchers          | `IsNull()`, `NotNull()`, `Pointee()`                 |
| Member matchers           | `Field()`, `Property()`                               |
| Tuple and pair matchers   | `Pair()`, `Pointwise()`, `UnorderedPointwise()`     |

Explore [Matchers Reference](reference/matchers.md) for a complete list with usage.

### Example: Container Matcher

```cpp
EXPECT_CALL(mock, Foo(ElementsAre(1, Gt(0), _, 5)));
```
This matches a container where the elements in order are: 1, greater than 0, any value, and 5.

## 5. Creating Custom Matchers

While most matchers suffice, sometimes you need to define your own logic for matching arguments.

### Quick Creation with `MATCHER` Macros

Use `MATCHER(name, description)` and its variants (`MATCHER_P`, `MATCHER_P2`, etc.) to define custom matchers succinctly.

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}

EXPECT_CALL(mock, Bar(IsDivisibleBy7()));
```

- `arg` is the argument being matched
- For parameterized matchers, use `MATCHER_P(name, param_name, description)`

You can append additional failure explanation using `*result_listener << "info";` inside the matcher.

### Creating Matcher Classes

For advanced use, implement matcher classes with `MatchAndExplain()`, `DescribeTo()`, and `DescribeNegationTo()` methods directly to control matching and messages.

```cpp
class EvenMatcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int value, std::ostream* os) const {
    return value % 2 == 0;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is even";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is odd";
  }
};

::testing::Matcher<int> IsEven() {
  return ::testing::Matcher<int>(new EvenMatcher());
}
```

## 6. Composing Matchers for Readability and Precision

Combine matchers logically to match complex argument constraints.

- Use `AllOf(m1, m2, ...)` to require all matchers
- Use `AnyOf(m1, m2, ...)` to require any matcher
- Use `Not(m)` for negation

Build layered criteria for clearer test intent:

```cpp
EXPECT_CALL(foo, Bar(AllOf(Gt(5), Not(Eq(10)))));
```

When matching multiple arguments combined, use `.With()` to apply a matcher on a tuple of arguments.

```cpp
EXPECT_CALL(foo, Func(_, _)).With(Lt());  // First arg less than second
```

## 7. Practical Tips and Best Practices

- **Order of Expectations:** New expectations override older ones for matching.
- **Retire Saturated Expectations:** Use `.RetiresOnSaturation()` to avoid upper bound errors.
- **Use `ON_CALL` for Defaults:** Avoid over-specifying expectations; default actions should be set with `ON_CALL`.
- **Suppress Warnings:** Use `NiceMock` to silence warnings for uninteresting calls when appropriate.
- **Avoid Over-Mocking:** Mock only what you control and when it enhances test clarity.
- **Use Provided Built-ins:** Leverage extensive built-in matchers before resorting to custom ones.

## 8. Troubleshooting Common Matcher Issues

- If your expectation never matches, verify argument types and matcher correctness.
- Use the `--gmock_verbose=info` flag to trace mock calls and matcher selections.
- Remember that `const` in argument declarations may be ignored - watch for MSVC warnings.
- When mocking overloaded methods, you may need to help the compiler by disambiguating with wrappers like `Const()`. 

## 9. Related Documentation

- [Matchers Reference](reference/matchers.md): Full list of GoogleMock built-in matchers.
- [Mocking Reference](reference/mocking.md): Details on mock classes, methods, and expectations.
- [gMock Cookbook](gmock_cook_book.md): Recipes including custom matchers and advanced techniques.
- [Defining and Using Mocks](guides/mocking-patterns/defining-using-mocks.mdx): Core mocking workflows.
- [Setting Expectations and Actions](guides/mocking-patterns/setting-expectations-actions.mdx): Detailed guide on `EXPECT_CALL` and `ON_CALL` usage.

---

#### Example: Combining Matchers for a Test

```cpp
using ::testing::_
using ::testing::AllOf;
using ::testing::Gt;
using ::testing::Ne;

EXPECT_CALL(foo, Process(AllOf(Gt(5), Ne(10))));
```

This expectation matches calls to `Process` with an argument greater than 5 and not equal to 10.

#### Example: Writing a Custom Parameterized Matcher

```cpp
MATCHER_P(IsMultipleOf, factor, "checks divisibility") {
  return arg % factor == 0;
}

EXPECT_CALL(mock, Foo(IsMultipleOf(3)));
```

---

This page provides the core building blocks for specifying granular and meaningful expectations on mock interactions.


