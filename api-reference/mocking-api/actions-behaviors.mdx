---
title: "Defining Actions and Behaviors"
description: "Covers the full range of supported mock actions, including built-in, user-defined, and advanced/parameterized actions. Includes instructions for using and combining actions such as Invoke, Return, and Throw."
---

# Defining Actions and Behaviors

This page provides a comprehensive guide on defining and using actions that specify what a mock method should do when called. GoogleMock offers a rich set of built-in actions and flexible mechanisms to combine, customize, and extend actions to fit your test scenarios.

---

## Understanding Actions

An *action* in GoogleMock defines the behavior of a mocked method when it is invoked. Actions control what values are returned, what side effects occur, or how control flows in your tests.

You primarily specify actions in two places:

- `ON_CALL(mock_object, method(...))` sets the default behavior without an expectation.
- `EXPECT_CALL(mock_object, method(...))` sets both an expectation and the action(s) to run when the method is called.

When no action is specified, GoogleMock performs a **default action** based on the return type.

---

## Built-in Actions

GoogleMock provides many built-in actions for common use cases, grouped below.

### Returning Values

| Action                      | Description                                                                                         |
|-----------------------------|-------------------------------------------------------------------------------------------------|
| `Return()`                  | Return from a `void` mock function.                                                             |
| `Return(value)`             | Return a copy of `value` (converted to the return type at expectation setting, not at call).    |
| `ReturnArg<N>()`            | Return the `N`-th argument (0-based) passed to the mock call.                                    |
| `ReturnNew<T>(a1, ..., ak)` | Construct and return a new `T` object by calling `new T(a1, ..., ak)` on each call.              |
| `ReturnNull()`              | Return a null pointer (including smart pointers).                                               |
| `ReturnPointee(ptr)`        | Return the value pointed to by `ptr` at the moment the action is executed.                       |
| `ReturnRef(variable)`       | Return a reference to `variable` instead of a copied value.                                    |
| `ReturnRefOfCopy(value)`    | Return a reference to a copy of `value` (copy lifetime is tied to the action).                  |
| `ReturnRoundRobin({...})`   | Return elements in round-robin from the given container or initializer list.                    |

### Side Effects

These actions produce side effects, often useful for manipulating output or input arguments in the mocked method.

| Action                       | Description                                                                                                |
|-----------------------------|------------------------------------------------------------------------------------------------------------|
| `Assign(&variable, value)`  | Assign `value` to the variable pointed to by `&variable`.                                                  |
| `DeleteArg<N>()`            | Delete the pointer passed as the `N`-th argument (must be a pointer).                                      |
| `SaveArg<N>(pointer)`       | Save a copy of the `N`-th argument to `*pointer`.                                                          |
| `SaveArgByMove<N>(pointer)` | Move the `N`-th argument to `*pointer`.                                                                   |
| `SaveArgPointee<N>(pointer)`| Save the value pointed to by the `N`-th argument to `*pointer`.                                            |
| `SetArgReferee<N>(value)`  | Assign `value` to the reference passed as the `N`-th argument.                                            |
| `SetArgPointee<N>(value)`  | Assign `value` to the variable pointed by the `N`-th argument.                                            |
| `SetArgumentPointee<N>(value)` | Deprecated alias for `SetArgPointee<N>(value)` (to be removed in v1.7.0).                               |
| `SetArrayArgument<N>(first, last)` | Copy elements from the source range `[first, last)` into the `N`-th argument's pointer or iterator.   |
| `SetErrnoAndReturn(error, value)`| Set the process-wide `errno` to `error`, then return `value`.                                           |
| `Throw(exception)`          | Throws the specified exception object. Requires the exception to be copyable.                            |

---

## Using Callables as Actions

You can use functions, methods, functors, or lambdas as actions to specify arbitrary behavior matching the mocked method's signature.

### Examples

```cpp
using ::testing::Invoke;

int Add(int x, int y) { return x + y; }

class Helper {
 public:
  bool IsPositive(int x) { return x > 0; }
};

MockFoo foo;
Helper helper;

EXPECT_CALL(foo, Sum(_, _))
    .WillOnce(Invoke(&Add))
    .WillRepeatedly(Invoke(&helper, &Helper::IsPositive));
```

### Key Notes

- `Invoke(f)` takes ownership of `f` if it's a callback object (e.g., `Closure*`), which must be permanent.
- You can use lambdas, functors with appropriately matching call operators.
- Unused parameters in functors/lambdas can be declared with `Unused` to reduce clutter.

---

## Invoking Functions Without Arguments

If you want to invoke a function or method that takes no arguments regardless of the mocked function’s arguments,
use `InvokeWithoutArgs()`. This is convenient when the callable doesn't need to process any input.

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(InvokeWithoutArgs([] { return 42; }));
```

---

## Invoking A Mock Function's Callable Argument

Sometimes a mock function receives a callable argument (e.g., a callback or function pointer), and you want to invoke it within your action. Use `InvokeArgument<N>(args...)` to invoke the `N`-th argument (0-based) as a callable.

```cpp
using ::testing::InvokeArgument;

EXPECT_CALL(mock, DoTask(_, _))
    .WillOnce(InvokeArgument<1>(5));  // Invokes the 2nd argument with parameter 5
```

If the callable argument expects references, wrap arguments in `std::ref()`.

---

## Composite Actions

You can combine multiple actions to execute sequentially using `DoAll()`:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

- The return value of the last action is used as the return value of the composite.
- All but the last actions must return `void`.

Other composite action utilities:

- `IgnoreResult(a)`: Perform action `a` but ignore its return value. Useful when your action returns a value but the method returns `void`.
- `WithArg<N>(a)`: Pass the `N`-th argument of the mock function to action `a`.
- `WithArgs<N1, N2, ..., Nk>(a)`: Pass selected arguments by index to action `a`.
- `WithoutArgs(a)`: Perform action `a` without forwarding any arguments.

---

## Defining Custom Actions

You can define your own actions in multiple ways:

### Using Lambdas or Functors

Any callable with a compatible signature can be used directly in `WillOnce()` or `WillRepeatedly()`.

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce([](int x, int y) { return x + y; });
```

For single-use actions with move-only state, lambdas or functors with `operator()&&` can be used.

### Using `ACTION` Macros

Legacy approach (not recommended for new code) is to use `ACTION`, `ACTION_P`, and related macros to define named actions.

Example:

```cpp
ACTION(IncrementArg0) { return ++arg0; }
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg0());
```

### Implementing `ActionInterface` (Advanced)

For finer control or polymorphic actions across different function signatures, implement the template
`ActionInterface<F>` where `F` is the function signature.

Example:

```cpp
template<typename F>
class MyAction : public testing::ActionInterface<F> {
 public:
  using Result = /* return type of F */;
  Result Perform(/*tuple of arguments*/) override {
    // Implement behavior
  }
};
```

Then wrap it with `MakeAction(new MyAction<F>)` for usage in GoogleMock.

### Polymorphic Actions

For actions reusable with multiple function signatures, define a class with a templated `Perform<R>(args)` method and wrap it using `MakePolymorphicAction()`.

Example:

```cpp
class ReturnSecondArgAction {
 public:
  template<typename R, typename Args>
  R Perform(const Args& args) {
    return std::get<1>(args);
  }
};

EXPECT_CALL(mock, Foo)
    .WillOnce(MakePolymorphicAction(ReturnSecondArgAction()));
```

---

## Common Pitfalls and Best Practices

- Actions in `EXPECT_CALL` are evaluated once when setting expectations. For side effects that should happen on each call, use lambdas or functors.
- `Return()` converts values to the mock function’s return type *when the expectation is set*, not when called.
- If returning move-only types repeatedly, use a lambda to create a new object each time.
- For mocking methods with move-only arguments/return types, user-defined lambdas are often necessary.
- Use `IgnoreResult()` to adapt an action returning a value for a void-returning mock method.
- When chaining side-effects on output parameters and returns, use `DoAll()` to combine them.
- Beware of sticky expectations: by default, an expectation remains active after its call count saturates. To retire expectations when saturated, use `.RetiresOnSaturation()` or `InSequence`.

---

## Examples

### Returning Different Values Over Calls

```cpp
EXPECT_CALL(foo, GetNextId())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

### Setting Output Parameter and Return Together

```cpp
EXPECT_CALL(mock, PopulateString(_))
    .WillOnce(DoAll(SetArgPointee<0>("hello"), Return(true)));
```

### Using Lambdas with Move-Only Types

```cpp
EXPECT_CALL(mock, MakeObject())
    .WillRepeatedly([]() {
      return std::make_unique<MyObject>();
    });
```

### Invoking a Callable Argument

```cpp
EXPECT_CALL(mock, DoWork(_, _))
    .WillOnce(InvokeArgument<1>(42));
```

---

## See Also

- [Actions Reference](reference/actions.md): Comprehensive list of built-in actions.
- [Mocking Reference - Expectation Macros](reference/mocking.md#EXPECT_CALL): How to set actions with expectations.
- [gMock Cookbook](docs/gmock_cook_book.md#UsingActions): Recipes and best practices for defining custom actions.
- [Matchers Reference](reference/matchers.md): For argument matching details.

---

For detailed guidance on setting expectations and argument matching with actions, please consult the related pages in the Mocking API.

<nav>
  <ul>
    <li><a href="/api-reference/mocking-api/specifying-expectations">Specifying Expectations</a></li>
    <li><a href="/api-reference/mocking-api/argument-matching">Argument Matching</a></li>
    <li><a href="/api-reference/mocking-api/actions-behaviors">Defining Actions and Behaviors</a></li>
  </ul>
</nav>
