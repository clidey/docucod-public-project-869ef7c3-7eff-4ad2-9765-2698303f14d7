---
title: "Expectations and Actions"
description: "Explores the specification of method call expectations and configuration of custom actions when those expectations are met. Includes controlling call counts, specifying sequences, and advanced action composition."
---

# Expectations and Actions

This documentation explores how to specify method call expectations and configure custom actions in GoogleMock when those expectations are met. It details techniques for controlling call counts, enforcing call sequences, and composing advanced behaviors when mocking methods.

---

## Overview

GoogleMock provides powerful mechanisms to specify **expectations** on mock method calls and control the **actions** performed when those expectations are triggered. This enables precise testing of how your code interacts with its dependencies â€” which calls happen, how many times, in what order, and with what behaviors.

This page covers the semantics and usage of the key constructs for expressing expectations and actions in GoogleMock, focusing on:

- Controlling *how many times* a method is expected to be called (cardinalities)
- Specifying sequences or partial orders for expected calls
- Configuring multiple and default actions to be performed on calls
- Handling uninteresting or unexpected calls gracefully

---

## Setting Expectations

Expectations declare how mock methods are expected to be called during test execution. They include:

### Defining Expectations with `EXPECT_CALL`

The macro `EXPECT_CALL(mock, Method(args...))` establishes an expectation that a mock method **will** be called with matching arguments. It can be enhanced with additional clauses that specify the expected number of calls, call order, and actions.

### Call Count Control (Cardinality)

Use `.Times(cardinality)` to specify *how many times* the expected call should occur. Cardinalities include:

| Cardinality       | Meaning                                  |
| ----------------- | ---------------------------------------- |
| `AnyNumber()`     | The call can occur any number of times (including zero). |
| `AtLeast(n)`      | The call must occur at least *n* times. |
| `AtMost(n)`       | The call must occur at most *n* times.  |
| `Between(m, n)`   | Call count between *m* and *n*, inclusive. |
| `Exactly(n)` or `n` | Call must occur exactly *n* times.      |

If you omit `.Times()`, GoogleMock infers it based on the number of `.WillOnce()` and `.WillRepeatedly()` clauses.

### Call Ordering

By default, expectations do not impose ordering on method calls.

- Use `InSequence(seq1, seq2, ...)` to require calls occur in the specified sequence(s).
- Use `.After(expectation)` to specify that an expectation can only be matched after some prior calls.

The `InSequence` object scopes multiple expectations. For example:

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(mock, Foo(1));
  EXPECT_CALL(mock, Bar(_)).Times(2);
  EXPECT_CALL(mock, Foo(2));
}
```

This enforces that `Foo(1)` happens before two `Bar` calls, which happen before `Foo(2)`.

To express partial ordering (a DAG of call constraints), you can assign expectations to multiple `Sequence` objects or specify multiple prerequisites using `.After()`.

### Expectation Behavior After Saturation

By default, expectations are *sticky*, meaning they remain active even after their upper bound of call count is reached, and will cause errors if calls exceed the limit.

You can soften this behavior with `.RetiresOnSaturation()`. When this is specified, the expectation becomes inactive as soon as it reaches its call limit, allowing other expectations to match subsequent calls.

### Using Multiple Expectations

You can set multiple overlapping expectations on the same method. GoogleMock matches calls against expectations in *reverse order* of declaration, so the *newest* match is preferred.

Good practice is to set more general matchers early (e.g., in the mock constructor or test fixture setup) and more specific matchers later to override behavior for some cases.

### Expectation Syntax Overview

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)        // Optional, match all args together
    .Times(cardinality)             // Optional, default inferred
    .InSequence(sequences...)       // Optional, to impose call order
    .After(expectations...)         // Optional, partial order constraints
    .WillOnce(action)               // Optional, behavior for specific calls
    .WillRepeatedly(action)         // Optional, behavior for additional calls
    .RetiresOnSaturation();         // Optional, make expectation retire on limit
```

Clause order matters: for example `.With()` must appear first if used.

***

## Defining Default Behavior with `ON_CALL`

`ON_CALL(mock, Method(matchers...))` defines the **default action** for calls matching the given matchers but does **not** set any expectation or verify invocation counts.

`ON_CALL` is useful to specify common fallback behaviors, e.g., in your test fixture setup, without enforcing the calls actually happen.

Example:

```cpp
ON_CALL(mock, Foo(_, 42)).WillByDefault(Return(true));
```

If no matching `EXPECT_CALL` exists for a call, the action defined by the last matching `ON_CALL` will be taken.

`ON_CALL` has syntax:

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)    // Optional
    .WillByDefault(action);     // Required
```

---

## Actions

Actions define what a mocked method does when called.

You can specify **actions** with:

- `.WillOnce(action)`: Executes the specified action for the next matched call only.
- `.WillRepeatedly(action)`: Executes the specified action for all subsequent matched calls after `.WillOnce`s are exhausted.
- `.WillByDefault(action)`: Sets the default action for `ON_CALL`.

### Common Built-in Actions

| Action                     | Description                                    |
| -------------------------- | ---------------------------------------------- |
| `Return(value)`            | Returns the specified `value` from the mock method. |
| `ReturnRef(variable)`      | Returns a reference to `variable`.
| `ReturnPointee(pointer)`   | Returns the value pointed to by `pointer` at call time.
| `DoDefault()`              | Uses the default action from `ON_CALL` or built-in default.
| `Invoke(function/functor)` | Calls a function or functor with the mock arguments.
| `InvokeWithoutArgs()`      | Calls a nullary function/functor ignoring mock arguments.
| `InvokeArgument<N>(args...)` | Calls the callable argument at position `N` with given `args`.
| `SetArgPointee<N>(value)` | Sets the output pointed argument `N` to `value`.
| `SaveArg<N>(&var)`         | Saves the `N`th argument into the variable.
| `Throw(exception)`         | Throws the specified exception.
| `DoAll(a1, a2, ..., an)`   | Performs all listed actions sequentially; returns the last's value.
| `IgnoreResult(action)`     | Performs the given action but ignores its return value.
| `WithArg<N>(action)`       | Invokes `action` with the `N`th argument.
| `WithArgs<N1, N2,...>(action)` | Invokes `action` with selected arguments.

### Actions from Callables

You can specify any pre-existing callable (function, lambda, functor) as an action.

Example:

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce(Invoke([](int x) { return x * 2; }));
```

### Combining Actions

Use `DoAll` to perform multiple actions in order when a single call happens.

Example:

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

In this example, an output argument is set and a value is returned.

---

## Handling Uninteresting and Unexpected Calls

### Uninteresting Calls

Calls to mock methods for which there is no `EXPECT_CALL` are known as *uninteresting*. By default, GoogleMock will:

- Perform the default action (if any)
- Print a warning message

You can adjust this using wrappers like `NiceMock` (suppress warnings) or `StrictMock` (treat as errors).

### Unexpected Calls

Calls that match no expectations (or exceed the set call count) are *unexpected* and cause test failures.

To reduce false negatives:

- Use `.Times(AnyNumber())` on catch-all expectations for methods where calls are allowed but not of direct interest.
- Use `ON_CALL` to provide default actions without constraints.

---

## Practical Usage Patterns

### Specifying Sequences with `InSequence`

Wrap related `EXPECT_CALL`s with an `InSequence` object to enforce strict call order:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
  EXPECT_CALL(mock, ThirdCall());
}
```

### Using `After` for Partial Orders

Combine expectations with `.After(...)` to create partial order constraints when strict sequences are too brittle.

### Retiring Expectations

Use `.RetiresOnSaturation()` to make an expectation inactive after it reaches its call limit. This prevents errors when multiple similar calls occur.

### Combining Multiple Actions

Use `.WillOnce()` multiple times to specify actions for successive calls.

Example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### Using Default Actions with `ON_CALL`

Set fallback behavior common to many tests or shared by tests without explicit expectations.

---

## Troubleshooting & Best Practices

- **Set Expectations Before Calls:** Always set `EXPECT_CALL` **before** exercising the code to avoid undefined behavior.

- **Avoid Over-Specification:** Use `ON_CALL` for default behavior and `EXPECT_CALL` only when verifying a call.

- **Account for Call Counts:** When expecting multiple calls with different behaviors, use `.WillOnce()` for each specific call and `.WillRepeatedly()` for the default behavior.

- **Suppress Warnings When Needed:** Use `NiceMock` to suppress warnings for uninteresting calls.

- **Use Sequences Judiciously:** Enforce order only when it matters for test robustness.

- **Use `.RetiresOnSaturation()` to avoid sticky expectations causing unexpected failures when call count limits are reached.

- **Check for Unintended Uninteresting Calls:** When warnings appear for uninteresting calls, confirm if you need to add expectations or default behavior.

- **Avoid Overly Complex Matchers:** Use simple matchers or combine multiple into `.With()` when argument relations matter.


---

## Example: Expecting Ordered Calls with Specific Behaviors

```cpp
using ::testing::InSequence;
using ::testing::Return;

{
  InSequence s;
  EXPECT_CALL(mock, MethodA()).WillOnce(Return(true));
  EXPECT_CALL(mock, MethodB(5)).WillOnce(Return(10));
  EXPECT_CALL(mock, MethodB(6)).WillRepeatedly(Return(20));
}

// Calls must occur in this order with specified returns.
EXPECT_TRUE(mock.MethodA());
EXPECT_EQ(10, mock.MethodB(5));
EXPECT_EQ(20, mock.MethodB(6));
EXPECT_EQ(20, mock.MethodB(6));
```

---

## Summary

This page presented how GoogleMock enables:

- Precise specification and verification of method call expectations.
- Control over call counts using cardinalities.
- Imposition of strict or partial call ordering.
- Customization of mock method behavior using a rich set of built-in and user-defined actions.
- Managing uninteresting and unexpected calls to improve test robustness.

---

## See Also

- [gMock Cookbook](gmock_cook_book.md) â€” Recipes and practical tips for mocking
- [Mocking Reference](docs/reference/mocking.md) â€” Deeper overview of mocks, macros, and methods
- [Actions Reference](docs/reference/actions.md) â€” Comprehensive list of built-in actions
- [Matchers Reference](reference/matchers.md) â€” Techniques to specify argument matchers
- [gMock for Dummies](docs/gmock_for_dummies.md) â€” Beginner-friendly introduction
