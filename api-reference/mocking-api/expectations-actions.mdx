---
title: "Setting Expectations and Actions"
description: "Documents the ON_CALL and EXPECT_CALL macros, sequencing, cardinality, and side-effect specification. Explains how to define what calls should occur on mocks, what actions should be performed, and how to verify call counts and order."
---

# Setting Expectations and Actions

Understand how to precisely define the behavior and expectations of mock methods using gMock's `ON_CALL` and `EXPECT_CALL` macros. This page guides you through specifying what calls should happen, how they are sequenced, how many times they occur, and the actions executed when a call matches.

---

## Overview

Mock objects in GoogleTest’s gMock framework enable you to specify how methods on those objects should behave when called and what calls you expect in your tests. There are two fundamental macros to define this behavior:

- `ON_CALL`: Specifies the default action to take when the mock method is called. It sets what should happen but doesn’t enforce that the method be called.
- `EXPECT_CALL`: Sets an expectation that the mock method *will* be called with specific arguments, the expected number of times, in a certain order if needed, and what actions to take.

This page explains how to use these macros to define detailed mock behaviors using clauses for argument matching, cardinality (number of calls), call ordering, and side effects.

---

## Using `EXPECT_CALL`

`EXPECT_CALL` is your primary tool for specifying that a mock method must be called in the test. It lets you:

- Define argument matchers to specify which calls satisfy the expectation.
- Set cardinalities to specify *how many* times a call is expected.
- Specify sequences or call orders.
- Define actions the mock method should perform when called.

### Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)      // Optional
    .Times(cardinality)                // Optional
    .InSequence(sequences...)          // Optional, multiple allowed
    .After(expectations...)            // Optional, multiple allowed
    .WillOnce(action)                  // Optional, multiple allowed
    .WillRepeatedly(action)            // Optional
    .RetiresOnSaturation();            // Optional
```

All chained clauses after `EXPECT_CALL` must appear in the order shown above.

### Argument Matchers

Matchers specify constraints on each argument of the mocked method.

- You can match specific values, e.g., `EXPECT_CALL(foo, Bar(5));`
- Use wildcards `_` to ignore particular arguments, e.g., `EXPECT_CALL(foo, Bar(_, 10));`
- Matchers can be combined or use complex predicates, e.g., `EXPECT_CALL(foo, Bar(Gt(0), Ne(10)));`

If you want to apply a matcher on *all* arguments as a tuple, use `.With()` (see below).

### `.With()` Clause: Matching Arguments as a Tuple

Use `.With()` to restrict calls based on the entire argument tuple. It takes a matcher of type `Matcher<std::tuple<A1, ..., An>>`.

Example: expect calls where the first argument is less than the second:

```cpp
using ::testing::Lt;
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());
```

This matches calls where the complete tuple matches the predicate.

### `.Times()` Clause: Specifying Call Cardinality

Controls *how many times* the call is expected to occur.

Common cardinalities (from the `::testing` namespace):

| Cardinality        | Behavior                                     |
|--------------------|----------------------------------------------|
| `AnyNumber()`       | Call may occur any number of times (including zero). |
| `AtLeast(n)`        | Call occurs at least *n* times.               |
| `AtMost(n)`         | Call occurs at most *n* times.                |
| `Between(m, n)`     | Call occurs between *m* and *n* times, inclusive. |
| `Exactly(n)` or `n` | Called exactly *n* times; `0` means disallow call. |

If omitted, `gMock` infers the cardinality based on whether `WillOnce()` and `WillRepeatedly()` clauses are used.


### `.InSequence()` Clause: Ordering Calls

Enables specifying that calls are expected to occur in a particular sequence.

- Pass one or more `Sequence` objects.
- Calls assigned to the same sequence must occur in the order the expectations were defined.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Init()).InSequence(s1, s2);
EXPECT_CALL(mock, Step1()).InSequence(s1);
EXPECT_CALL(mock, Step2()).InSequence(s2);
```

Here, `Init()` must be called before both `Step1()` and `Step2()`, but the relative order of the last two is not specified.

You can also achieve the same effect by creating an `InSequence` block, which assigns all `EXPECT_CALL`s inside it to a synthetic sequence.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, Start());
  EXPECT_CALL(mock, Process());
  EXPECT_CALL(mock, End());
}
```

---

### `.After()` Clause: Partial Order Constraints

Allows specifying that an expectation must occur *after* one or more other expectations have been satisfied.

- Can take up to 5 `Expectation` or `ExpectationSet` objects.
- Enables specifying a partial ordering (DAG) of expected calls.

Example:

```cpp
Expectation initX = EXPECT_CALL(mock, InitX());
ExpectationSet allInits;
allInits += EXPECT_CALL(mock, Init1());
allInits += EXPECT_CALL(mock, Init2());
EXPECT_CALL(mock, Run()).After(initX, allInits);
```

`Run()` will only be expected after `initX` and all `Init1()` and `Init2()` calls have occurred.

---

### `.WillOnce()` and `.WillRepeatedly()` Clauses: Defining Actions

Used to specify what the mocked method should do when called:

- `.WillOnce(action)`: Action to perform on a single call. Can appear multiple times, and each call performs the next action in order.
- `.WillRepeatedly(action)`: Action to perform on all subsequent calls after all `WillOnce()` actions are used. Can appear at most once.

If neither are specified, gMock uses the default action for the return type (e.g., return 0 or default-constructed value).

Examples:

```cpp
EXPECT_CALL(mock, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This means:

- First call returns 100
- Second call returns 150
- All subsequent calls return 200

Another example without `WillRepeatedly`:

```cpp
EXPECT_CALL(mock, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(200));
```

Expected to be called exactly twice, returning 100 then 200.

---

### `.RetiresOnSaturation()` Clause: Deactivating Expectation Early

Marks that once the expectation has been *saturated* (the upper bound of its call count is reached), it will no longer be active. This is useful when you expect an exact number of calls and want subsequent matching calls to be handled by other expectations.

Example:

```cpp
EXPECT_CALL(mock, SetValue(_))  // Expectation 1
    .Times(AnyNumber());
EXPECT_CALL(mock, SetValue(7))  // Expectation 2
    .Times(2)
    .RetiresOnSaturation();
```

The first two calls to `SetValue(7)` match Expectation 2, which will retire after saturation, so a third call would match Expectation 1.

---

## Using `ON_CALL`

`ON_CALL` configures the **default behavior** of mock methods for calls that do not match any `EXPECT_CALL`. It does **not** set any expectation about calls occurring.

Syntax:

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);        // Required
```

Unlike `EXPECT_CALL`, `ON_CALL` is used mainly to avoid undesired warnings and provide reasonable default behavior for mock methods.

Example:

```cpp
ON_CALL(mock, GetValue()).WillByDefault(Return(42));
```

Means any call to `GetValue()` without a matching expectation will return 42 by default.

### `.With()` Clause in `ON_CALL`

Same as for `EXPECT_CALL`, restricts the default behavior change to calls where the argument tuple matches the provided matcher.

---

## Practical Tips and Best Practices

- **Set expectations (`EXPECT_CALL`) before exercising code.** `EXPECT_CALL` must precede calls to mock methods to avoid undefined behavior.
- **Use `ON_CALL` for default behavior, `EXPECT_CALL` only for calls you want to verify.** Lend your tests flexibility and avoid over-specification.
- **Order of expectations matters:** Later `EXPECT_CALL`s override earlier ones. For specific behavior, define expectations in the right order or use sequences.
- **Use `InSequence` or `After` to control call ordering** when order matters.
- **Be mindful of cardinalities**; incorrect cardinalities lead to errors if calls happen too frequently or too infrequently.
- **Use `.RetiresOnSaturation()` to avoid over-saturation errors when expecting limited repeated calls.**
- **Specify actions carefully.** Remember that each `WillOnce` is consumed per call. Without `WillRepeatedly`, excess calls will fall back to default actions.
- **Avoid side effects in action specification expressions.** Expressions inside `WillOnce` are evaluated once during expectation setup, not on every call.
- **Keep expectations readable and maintainable.** Use matchers and multi-argument matchers to avoid brittle tests.

---

## Common Error Scenarios and Troubleshooting

| Scenario                                      | Description and Advice
| --------------------------------------------- | ---------------------------------------------------------------------------------------------------------------
| **Call too few times**                        | Your code called the mock method fewer times than expected. The test will fail at verification or teardown.
| **Call too many times (over-saturation)**   | The mock method was called more than the expected number of times. This will fail unless `.RetiresOnSaturation()` is used.
| **Unexpected call**                          | A call occurred that did not match any `EXPECT_CALL`. Check if you forgot to add an expectation, or if the call is unexpected.
| **Arguments do not match expectation**      | The call was made, but the arguments did not satisfy the matchers. Use verbose output (`--gmock_verbose=info`) to debug.
| **Uninteresting call warnings**              | You called a mock method with no `EXPECT_CALL`. This is allowed but warns by default. Use `NiceMock` or add catch-all expectations if unwanted.
| **Out-of-order calls**                        | Expected calls occurred out of sequence despite an ordering requirement. Make sure you correctly specified sequences or `.After()`.


---

## Example Usage Patterns

### Basic Expectation with Return Values

```cpp
using ::testing::Return;
using ::testing::_;

MockTurtle turtle;

EXPECT_CALL(turtle, GetX())
    .Times(3)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));

// Calls:
int x1 = turtle.GetX();  // 100
int x2 = turtle.GetX();  // 150
int x3 = turtle.GetX();  // 200
int x4 = turtle.GetX();  // 200
```

### Specifying Order with `InSequence`

```cpp
using ::testing::InSequence;

{
  InSequence seq;  // All EXPECT_CALLs below form a sequence.

  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}

// The following call order is valid:
turtle.PenDown();
turtle.Forward(100);
turtle.PenUp();

// Out-of-order or missing calls will fail.
```

### Partial Ordering with `.After()`

```cpp
Expectation e1 = EXPECT_CALL(mock, InitA());
Expectation e2 = EXPECT_CALL(mock, InitB());
EXPECT_CALL(mock, Process()).After(e1, e2);

// Process() will only be allowed after InitA() and InitB() have finished.
```

### Defining Default Behavior with `ON_CALL`

```cpp
using ::testing::Return;

ON_CALL(turtle, GoTo(_, _))
    .WillByDefault(Return());

// No EXPECT_CALL needed if you don't want to verify calls, but want to avoid warnings or change behavior.
```

---

## Related Concepts

- **Matchers:** Detailed list of built-in and custom matchers available to specify argument constraints.
- **Actions:** Built-in and custom actions usable with `WillOnce` and `WillRepeatedly` to define behavior.
- **Cardinalities:** How to fine-tune call count requirements using `Times` with `AtLeast`, `AtMost`, `Exactly`, and more.
- **Sequences and Partial Ordering:** Mechanisms to express call order requirements.
- **`NiceMock`, `NaggyMock`, and `StrictMock`:** Ways to control behavior and warnings on uninteresting calls.

---

## See Also

- [Basic Mocking with GoogleMock](../getting-started/configuration-and-first-use/using-googlemock-basics)
- [Mocking Methods and Classes](../api-reference/mocking-api/mock-methods)
- [Matchers and Verification](../api-reference/matchers-api/builtin-matchers)
- [Actions Reference](actions.md)
- [Using Matchers Guide](guides/core-test-workflows/using-matchers)

---

## Summary
This page equips you to define and control mock interactions precisely in your tests using `EXPECT_CALL` and `ON_CALL`. It explains how to set argument matchers, control call frequency, specify call ordering with sequences or dependencies, and set the actual behavior the mock performs when called.

With concrete examples and explanations of cardinalities, sequences, and actions, you gain mastery for writing dependable and maintainable mock-based tests.

---

<Info>
For advanced ordering and sequencing, explore the `Sequence` and `ExpectationSet` classes. To debug matching and ordering issues, use the `--gmock_verbose=info` flag to trace call matches.
</Info>

<Warning>
Always specify expectations before exercising your code. Writing expectations after calls can lead to undefined behavior.
</Warning>

---