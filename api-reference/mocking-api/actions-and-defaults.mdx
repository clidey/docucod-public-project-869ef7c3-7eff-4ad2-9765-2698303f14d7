---
title: "Actions, Defaults, and Sequences"
description: "Details how to specify actions, default behaviors, and call sequences for mocks, including use of user-defined actions and cardinalities (times called)."
---

# Actions, Defaults, and Sequences

This page guides you through specifying **actions**, setting **default behaviors**, and establishing **call sequences** for mock functions in GoogleMock. You will learn how to use built-in and user-defined **actions**, control how often mocked functions are expected to be called using **cardinalities**, and manage the order of calls with **sequences**.

---

## Understanding Actions: What Should a Mock Do When Called?

Every mock method in GoogleMock can be associated with an **action** that specifies what happens when the method is invoked. This allows you to precisely control the behavior your mocks simulate, shaping the interaction of your tests with dependencies.

### Built-in Actions Overview

GoogleMock provides a rich set of built-in actions, including:

- **Return Values:**
  - `Return(value)`: Returns a copy of `value`. If the return type differs, conversion happens when the expectation is set.
  - `ReturnRef(variable)`: Returns a reference to a variable.
  - `ReturnNull()`: Returns a null pointer.
  - `ReturnArg<N>()`: Returns the N-th argument passed to the mock.
  - `ReturnNew<T>(args...)`: Returns a newly allocated object of type `T`.
  - `ReturnRoundRobin({v1, v2, ..., vk})`: Cycles through the listed values on each call.

- **Side Effects:**
  - `Assign(&variable, value)`: Changes the value of a variable.
  - `SetArgPointee<N>(value)`: Sets the pointed-to value of the N-th argument.
  - `DeleteArg<N>()`: Deletes the N-th argument (must be pointer).
  - `Throw(exception)`: Throws an exception on call.

- **Function/Functor/Lambda Invocation:**
  - `Invoke(callable)`: Calls the given callable with the mock arguments.
  - `InvokeWithoutArgs(callable)`: Calls a callable ignoring the mock’s arguments.
  - `InvokeArgument<N>(args...)`: Invokes the N-th argument as a callable with provided args.

- **Composing Actions:**
  - `DoAll(a1, a2, ..., aN)`: Performs actions sequentially, returning the result of the last.
  - `IgnoreResult(action)`: Performs an action and ignores its return value.
  - `WithArg<N>(action)`, `WithArgs<N1, N2, ...>(action)`: Selectively passes arguments to inner actions.
  - `WithoutArgs(action)`: Calls an action ignoring all arguments.

### Using User-Defined Actions

If built-ins don’t cover your needs, define custom actions using one of these methods:

- **ACTION Macros:** Define a simple action at namespace scope.

  ```cpp
  ACTION(Sum) { return arg0 + arg1; }
  EXPECT_CALL(mock, Func()).WillOnce(Sum());
  ```

- **Parameterized Actions:** Use `ACTION_P`, `ACTION_P2`, etc., to create parameterized ones.

- **Callable Objects or Lambdas:** Use lambda functions or functor objects directly.

  ```cpp
  EXPECT_CALL(mock, Func(_)).WillOnce([](int x) { return x * 2; });
  ```

### Important Usage Notes

- Actions assigned by `EXPECT_CALL` are evaluated once when the expectation is set, not each time the mock is called. To have dynamically changing behaviors, use lambdas or functions instead.
- Use `DoAll()` to combine multiple side effects and a return value in one expectation.
- When returning references, prefer `ReturnRef()` for live variables or `ReturnRefOfCopy()` for references to copies that outlive the action.

---

## Default Actions: Defining Fallback Behavior

By default, uninteresting calls to mock methods return a built-in default value (zero, `false`, `nullptr`, or default-constructed object). To customize this:

- Use `ON_CALL(mock, method(matchers)).WillByDefault(action);` to define a **default action** for calls that do not have explicit `EXPECT_CALL` expectations.

- Globally customize return values for all mocks with `::testing::DefaultValue<T>::Set(value);` or provide lazy factory functions with `SetFactory()`.

### How Default Actions Work in Your Tests

- `ON_CALL` does not make expectations. It just changes what happens if no `EXPECT_CALL` matches.
- If multiple `ON_CALL`s match, the **last defined** matching `ON_CALL` is used.
- If no matching `ON_CALL`, the built-in default is used.
- `DoDefault()` action in `EXPECT_CALL` causes the corresponding `ON_CALL` or built-in default action to be performed.
- Avoid using `DoDefault()` inside composite actions, as it causes run-time errors.

### Example: Setting Default Behavior

```cpp
ON_CALL(mock_obj, GetValue(_)).WillByDefault(Return(42));
EXPECT_CALL(mock_obj, GetValue(10)).WillOnce(Return(100));

// Calls to GetValue with argument 10 return 100,
// others return 42 by default.
```

---

## Sequences and Call Ordering: Controlling the Flow of Calls

In tests where interaction order matters, sequences help establish **partial or complete call order** constraints.

### Creating and Using Sequences

Create a `::testing::Sequence` object and assign expectations to it via `.InSequence()`:

```cpp
using ::testing::Sequence;
Sequence s1, s2;

EXPECT_CALL(mock, Start()).InSequence(s1);
EXPECT_CALL(mock, Load()).InSequence(s1, s2);
EXPECT_CALL(mock, Finish()).InSequence(s2);
```

This means:
- `Start()` must happen before `Load()`
- `Load()` must happen before `Finish()`
- Calls in the same sequence occur in the order declared

### Scoped Sequence: `InSequence`

To make multiple expectations belong to a common anonymous sequence easily, use `::testing::InSequence` in a scope:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
// First() must be called before Second()
```

### Using `.After()` Clause for Partial Ordering

You can specify that an expectation happens after one or more other expectations:

```cpp
Expectation e1 = EXPECT_CALL(mock, Connect());
EXPECT_CALL(mock, Send()).After(e1);
```

For multiple prerequisites:

```cpp
ExpectationSet init_calls;
for (int i = 0; i < N; ++i) {
  init_calls += EXPECT_CALL(mock, Init(i));
}
EXPECT_CALL(mock, Run()).After(init_calls);
```

### Retiring Expectations

Expectations are **sticky** by default and remain active after they are satisfied. To make an expectation retire (become inactive) once saturated, use `.RetiresOnSaturation()`. This avoids confusion with repeated calls and helps model exclusive behavior.

### Important Sequencing Notes

- Calls will fail if they occur out of the declared sequence.
- Sequences can be combined to form partial orders with multiple paths.
- Expectations retain the default of being sticky unless explicitly retired.

---

## Setting Call Cardinalities: Times() Clause

Cardinalities specify how many times a mock method is expected to be called:

| Cardinality           | Meaning                                               |
|----------------------|-------------------------------------------------------|
| `AnyNumber()`         | Any number of calls allowed                            |
| `AtLeast(n)`          | Called at least `n` times                              |
| `AtMost(n)`           | Called at most `n` times                               |
| `Between(m, n)`       | Called between m and n times (inclusive)              |
| `Exactly(n)` or `n`   | Called exactly n times; 0 means should never be called |

### Implicit Cardinality Inference

If you omit `.Times()`, GoogleMock infers:

- If no `WillOnce` or `WillRepeatedly`: `Times(1)`
- If n `WillOnce`s and no `WillRepeatedly`: `Times(n)`
- If n `WillOnce`s and one `WillRepeatedly`: `Times(AtLeast(n))`

### Using `Times(0)` to Disallow Calls

To explicitly disallow calls:

```cpp
EXPECT_CALL(mock, Foo(_)).Times(0);
```

Calls violating this will cause test failures immediately.

### Common Patterns

- Use `Times(AnyNumber())` to allow any number of calls, typical when you don’t care about exact call count.
- Combine with sequences or `.RetiresOnSaturation()` to model complex call flows.

---

## Putting It All Together: Defining Expected Behaviors and Sequences

### Example: Mocking a Method with Actions, Cardinality, and Sequence

```cpp
using ::testing::Return;
using ::testing::Sequence;
using ::testing::InSequence;

Sequence s;
EXPECT_CALL(mock, Setup())
    .Times(1)
    .InSequence(s)
    .WillOnce(Return(true));

EXPECT_CALL(mock, Process(_))
    .Times(3)
    .InSequence(s)
    .WillRepeatedly(Return(0));

EXPECT_CALL(mock, Teardown())
    .Times(1)
    .InSequence(s);

// This test expects Setup() first, then exactly 3 calls to Process(),
// followed by Teardown().
```

### Handling Multiple Return Values and Side Effects

For example, to assign to arguments and return a value:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

To throw exception on call:

```cpp
EXPECT_CALL(mock, DangerousOp())
    .WillOnce(Throw(std::runtime_error("fail")));
```

To combine multiple actions:

```cpp
EXPECT_CALL(mock, Func())
    .WillOnce(DoAll(
        Invoke([]{ /* side effect */ }),
        Return(100)));  // Return last action's result
```

### Advanced Use: Invoking Callable Arguments

Sometimes your mock method receives a callback argument. Use `InvokeArgument<N>` to call this function argument:

```cpp
EXPECT_CALL(mock, RegisterCallback(_))
    .WillOnce(InvokeArgument<0>(42, std::string("msg")));
```

The callable argument at position 0 is invoked with parameters `42` and `"msg"`.

---

## Troubleshooting Common Issues

### Runtime Error When Using `DoDefault()` Inside Composite Actions

Avoid using `DoDefault()` inside `DoAll()` or other composite actions; this causes runtime errors.

### Unexpected Calls without Expectations

To prevent warnings on uninteresting calls, use `NiceMock` or add a catch-all expectation with `Times(AnyNumber())`.

### Actions Not Executing as Expected

Remember that actions are evaluated once when the expectation is set. Use lambdas or invoke functions to execute code at call time.

### Returning Live Data

To return the current value of a variable, use `ReturnRef()` or `ReturnPointee(&var)`, not `Return(var)`, which copies at expectation setting time.

---

## Summary

By mastering the use of actions, default behaviors, cardinalities, and sequences, you gain fine-grained control of mock object behavior and call validation. This enables writing expressive, reliable, and maintainable tests that verify not only what code returns but how it interacts with dependencies in terms of order and frequency.

---

## Additional Resources

- [Actions Reference](../reference/actions.md) for detailed built-in and user-defined actions.
- [Mocking Reference](../reference/mocking.md) for `EXPECT_CALL`, `ON_CALL`, and mock setup.
- [gMock Cookbook](../gmock_cook_book.md) for practical recipes using actions and expectations.
- [Matchers Reference](../reference/matchers.md) to express argument matching conditions.
- [Mock Methods & Macros](../api-reference/mocking-api/mock-methods.md) for defining mocks.
- [Cardinality List](../reference/mocking.md#EXPECT_CALL.Times) for timing control.

---

For a complete overview of setting expectations, controlling call ordering, and customizing mock behaviors, refer to the full [Mocking Reference](../reference/mocking.md) and [gMock Cookbook](../gmock_cook_book.md).


