---
title: "Expectations and Cardinalities"
description: "Understand how to set up expectations using macros like ON_CALL and EXPECT_CALL, control invocation counts with cardinality classes, and specify default/mock object behaviors. Includes practical usage patterns for comprehensive test coverage."
---

# Expectations and Cardinalities

Welcome to the core of specifying interactions in GoogleMock: setting expectations on your mock objects and controlling how many times the mock methods are expected to be called. This page details the syntax and semantics of the `EXPECT_CALL` and `ON_CALL` macros, along with cardinalities that let you express invocation counts clearly and precisely. Mastering these constructs ensures your tests cover the full spectrum of interaction-based verification and enable robust, maintainable tests.

---

## Understanding Expectations: The Power of `EXPECT_CALL`

At the heart of interaction verification in GoogleMock lies the `EXPECT_CALL` macro. It declares that a particular method on a mock object _is expected_ to be called, optionally with argument matchers, a specified number of times, in order, and with specific behaviors.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

Here's what happens:

- `mock_object`: Your mock instance.
- `MethodName`: The mocked method.
- `matchers...`: Optional argument matchers to constrain the calls.
- `Times(cardinality)`: How many times the method is expected to be called.
- `WillOnce` and `WillRepeatedly`: Actions defining the method's behavior.

> **Tip:** If you omit the `.Times()` clause, GoogleMock infers the expected call count based on presence and count of `WillOnce` and `WillRepeatedly` clauses. This often reduces verbosity without loss of clarity.

### Specifying Argument Matchers

Matchers describe what arguments you expect to see. For example:

```cpp
using ::testing::_;  // wildcard matcher
EXPECT_CALL(turtle, Forward(100));                     // exactly 100
EXPECT_CALL(turtle, GoTo(50, _));                       // x is 50, y can be anything
EXPECT_CALL(turtle, Move(Ge(10)));                      // argument >= 10
EXPECT_CALL(turtle, Draw(An<const std::string&>()));    // argument is const std::string&
```

You can omit the argument list for non-overloaded methods to express "any arguments":

```cpp
EXPECT_CALL(turtle, PenUp);
```

### Invocation Order

By default, calls can arrive in any order, but you can enforce order with:

- **Sequences** using `Sequence` objects and `.InSequence(...)` clauses.
- The `InSequence` helper class to scope a block of ordered expectations.
- `.After(...)` clause to define partial orders precisely.

This guarantees that your method calls occur in the order your test expects, catching elusive bugs caused by incorrect call sequencing.

### Call Counts: Cardinalities with `.Times()`

Cardinalities specify how many times a call is expected. They cover exact counts, ranges, lower or upper bounds, or allow any number:

| Cardinality          | Meaning                                      | Example                 |
|---------------------|----------------------------------------------|-------------------------|
| `AnyNumber()`        | Any number of calls (including zero)          | `.Times(AnyNumber())`    |
| `AtLeast(n)`         | Called _at least_ `n` times                    | `.Times(AtLeast(2))`     |
| `AtMost(n)`          | Called _at most_ `n` times                     | `.Times(AtMost(3))`      |
| `Between(m, n)`      | Called between `m` and `n` times (inclusive)  | `.Times(Between(1, 3))`  |
| `Exactly(n)` or `n`  | Called _exactly_ `n` times                      | `.Times(Exactly(4))` or `.Times(4)` |

#### Example: Expecting Twice the Call to `GoTo(0, 0)`

```cpp
EXPECT_CALL(turtle, GoTo(0, 0))
    .Times(2);
```

Any third call will fail the test.

### WillOnce and WillRepeatedly

Define the behavior when an expected call happens.

- `WillOnce` specifies behavior for a single call. You can chain multiple `WillOnce` clauses.
- `WillRepeatedly` specifies the behavior after all `WillOnce` calls are exhausted.

Example:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This means:

- On first call, return 100.
- On second call, return 150.
- On all subsequent calls, return 200.

### `RetiresOnSaturation`: Controlling Expectation Lifecycle

By default, expectations remain "sticky" even after reaching their max calls, meaning they continue to match calls until reset or the mock object is destroyed. You can make an expectation retire (become inactive) immediately upon saturation by adding:

```cpp
EXPECT_CALL(mock, SomeMethod())
    .Times(2)
    .RetiresOnSaturation();
```

This ensures that once the expectation is satisfied, calls will no longer match it and may fall back to other expectations.

---

## Defining Default Behaviors with `ON_CALL`

Sometimes, you want to specify how a mock method behaves by default but don't want to enforce an expectation that it _must_ be called. For that, GoogleMock provides `ON_CALL`.

### Basic Syntax

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .WillByDefault(action);
```

- Like `EXPECT_CALL`, you specify the method and the argument matchers.
- It does **not** create an expectation, so no verification on calls is done.
- Specify exactly one `.WillByDefault` clause.

### Use Case

`ON_CALL` is often used in test setup or mock constructors to specify common default behavior, leaving `EXPECT_CALL` to specify test-specific, verifiable expectations.

Example:

```cpp
ON_CALL(foo, GetName())
    .WillByDefault(Return("John Doe"));
```

If no `EXPECT_CALL` matches a call to `GetName()`, this default action is taken.

---

## Cardinality Classes and How They Work

GoogleMock encapsulates call count constraints in **cardinalities** â€” objects that describe acceptable invocation counts logically and human-readably.

### Built-in Cardinalities

These are implemented as factory functions returning Cardinality objects:

- `AnyNumber()`
- `AtLeast(int n)`
- `AtMost(int n)`
- `Between(int min, int max)`
- `Exactly(int n)`

Each cardinality implements:

- **IsSatisfiedByCallCount(call_count)**: Returns `true` if call count is within the accepted range.
- **IsSaturatedByCallCount(call_count)**: Returns `true` if the call count has met or exceeded the allowed maximum.
- **DescribeTo(ostream*)**: Human-readable description of the cardinality.

### Examples

- `Exactly(1)` means the method must be called once.
- `AtLeast(2)` means the method must be called two or more times.
- `Between(3, 5)` means the method must be called between three and five times inclusive.
- `AnyNumber()` means zero or more calls allowed.

### Informative Descriptions

GoogleMock provides descriptions like "called twice", "called at most 3 times", "never called", etc., which empower test failure messages with clarity.

---

## Practical Usage Patterns

### Setting Expectations with Counts and Arguments

```cpp
using ::testing::_;         // wildcard matcher
using ::testing::Exactly;
using ::testing::Return;

EXPECT_CALL(mock, Foo(42, _))
    .Times(Exactly(3))
    .WillRepeatedly(Return(true));
```

Here, `Foo` is expected to be called exactly three times with first argument 42, second argument anything, returning `true` every time.

### Combining `ON_CALL` and `EXPECT_CALL`

```cpp
ON_CALL(mock, Bar(_))
    .WillByDefault(Return(0));  // Default behavior

EXPECT_CALL(mock, Bar(7))    // Expectations
    .Times(AnyNumber())
    .WillRepeatedly(Return(42));
```

Calls to `Bar` with argument 7 return 42, expected any number of times; all other calls return 0 by default.

### Using Sequences for Ordering

```cpp
using ::testing::InSequence;

{
  InSequence s;
  EXPECT_CALL(mock, Start());
  EXPECT_CALL(mock, Process(_));
  EXPECT_CALL(mock, End());
}
```

Ensures calls occur in `Start()`, then `Process()`, then `End()` order.

### Retiring Expectations

```cpp
EXPECT_CALL(mock, UpdateValue(_))
    .Times(2)
    .RetiresOnSaturation();
```

After two calls, this expectation retires and won't match more calls.

---

## Common Pitfalls & Tips

- **Set expectations _before_ calling the methods.** Expectations set after invoking the mock method lead to undefined behavior.
- **Use `ON_CALL` for default behaviors, `EXPECT_CALL` for verified calls.** Avoid turning `ON_CALL` into expectations unless verification is required.
- **Remember sticky expectations:** to avoid errors with repeated calls, use `.RetiresOnSaturation()` or sequences.
- **Order your expectations carefully:** later `EXPECT_CALL`s override previous ones for matching.
- **Use `Times(0)` to expect no calls to a method.**

---

## Troubleshooting

### Expectation Not Satisfied

If your test reports unexpected calls or missed calls:

- Verify all expected calls are set before exercising the system under test.
- Confirm matchers correctly express your argument conditions.
- Check calls occur in the expected order if sequences or `.After()` clauses are used.

### Unexpected Calls and Uninteresting Calls

- Unexpected calls match existing expectations but with unmatched parameters.
- Uninteresting calls hit methods with no expectations; they trigger warnings but not test failures by default.
- Use `NiceMock<>` to suppress uninteresting call warnings.
- Use `StrictMock<>` to make uninteresting calls failures.

### Default Actions Not Working

If there's no default action set for a method and it returns a non-void, non-default-constructible type, you must set a default action with `ON_CALL`. Otherwise, gMock throws an error.

---

## Summary

Setting expectations and controlling call counts using cardinalities is the key to powerful, reliable interaction testing with GoogleMock. Use `EXPECT_CALL` to describe expected calls with precise argument matching and cardinalities, combine with sequences or `After()` clauses for ordering, and define behaviors using `WillOnce` and `WillRepeatedly`. Use `ON_CALL` to set default behavior without enforcing expectations. Understanding these tools prevents common pitfalls and enables comprehensive verification of your code's interactions.

---

### Additional Resources
- [Mocking Reference](reference/mocking.md#EXPECT_CALL): Detailed macro usage.
- [gMock for Dummies](gmock_for_dummies.md#SettingExpectations): User-friendly explanation and examples.
- [gMock Cookbook](gmock_cook_book.md#SettingExpectations): Advanced usage recipes.
- [Cardinalities Implementation](googlemock/src/gmock-cardinalities.cc): For in-depth understanding of call counts.

---