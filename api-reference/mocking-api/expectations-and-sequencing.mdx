---
title: "Setting Expectations & Call Sequences"
description: "Reference for creating expectations using ON_CALL, EXPECT_CALL, and managing call counts (cardinalities), default actions, and ordered verification. Equips users to specify, control, and verify behavior of mocks with expressive patterns."
---

# Setting Expectations & Call Sequences

GoogleMock provides powerful mechanisms to specify, control, and verify the behavior of mock objects through expectations. This page explains how to use the `EXPECT_CALL` and `ON_CALL` macros to create expectations and default behaviors on mock methods, manage call counts (cardinalities), define ordered and partially ordered call sequences, and handle default actions and verifications.

---

## Overview

When testing with mocks, you often need to:

- Specify which mock methods should be called, with which arguments, and how many times.
- Define what actions those methods should perform when called.
- Control the order in which calls should occur.
- Manage default behaviors for calls that don’t have explicit expectations.

GoogleMock uses two primary macros to accomplish these tasks:

- `EXPECT_CALL()` to set expectations on mock methods.
- `ON_CALL()` to set default behaviors without establishing expectations.

This page focuses on how to create flexible, expressive expectations, control sequences of calls, and properly verify them.

---

## Using `EXPECT_CALL` to Create Expectations

`EXPECT_CALL` declares that a particular mock method is expected to be invoked during the test, with optional constraints on arguments, the number of calls (cardinality), the order relative to other calls, and the actions performed.

### Syntax

```cpp
EXPECT_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)  // Optional, only once
    .Times(cardinality)            // Optional, only once
    .InSequence(sequences...)      // Optional, multiple times
    .After(expectations...)        // Optional, multiple times
    .WillOnce(action)              // Optional, multiple times
    .WillRepeatedly(action)        // Optional, only once
    .RetiresOnSaturation();        // Optional, only once
```

### Key Clauses Explained

#### Matchers: Specifying Argument Expectations

- Give the arguments that you expect with matchers such as `_` (wildcard), `Eq(value)`, `Ge(x)` (greater or equal), etc.
- If you omit arguments for a non-overloaded method, it means "match all arguments".

#### `.With()`

- Allows matching all the arguments as one tuple with a multi-argument matcher.
- Must be the first clause after `EXPECT_CALL`, and can appear at most once.
- Useful to impose constraints involving multiple arguments combined.

#### `.Times()`

- Defines how many times the mock method is expected to be called.
- Accepts cardinalities such as:
  - `AnyNumber()` (zero or more)
  - `AtLeast(n)`
  - `AtMost(n)`
  - `Between(m, n)`
  - `Exactly(n)` or simply `n`
- If omitted, gMock infers the cardinality based on the number of `WillOnce` and presence of `WillRepeatedly`:
  - No `WillOnce` nor `WillRepeatedly` => `Times(1)`
  - N `WillOnce` clauses only => `Times(N)`
  - N `WillOnce` plus one `WillRepeatedly` => `Times(AtLeast(N))`

#### `.InSequence()`

- Associates the expectation with one or more `Sequence` objects.
- Ensures that calls within the same sequence happen in the declared order.
- Can appear multiple times to add the expectation to multiple sequences.

#### `.After()`

- Specifies that this call should only happen after the given expectations or expectation sets complete.
- Can specify up to five prerequisites.
- Allows expressing complex partial orders between expectations.

#### `.WillOnce()` and `.WillRepeatedly()`

- Define the action(s) performed on matching calls.
- `WillOnce()` can appear multiple times, defining a sequence of actions for consecutive calls.
- `WillRepeatedly()` must appear at most once, defining the action after `WillOnce()` calls are exhausted.
- If omitted, default action is used (e.g., returning default-constructed value).

#### `.RetiresOnSaturation()`

- Causes the expectation to become inactive after it has matched the maximum expected number of calls.
- Useful to make expectations "unsticky" so later matching expectations can take over.

### Example Usage

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::Exactly;

EXPECT_CALL(turtle, GetX())
    .Times(3)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillOnce(Return(200));

EXPECT_CALL(turtle, SetPosition(_, _))
    .Times(AnyNumber());
```

This says `GetX()` will be called exactly three times returning 100, 150, then 200, and `SetPosition` can be called any number of times with any arguments.

---

## Using `ON_CALL` to Set Default Actions

`ON_CALL` specifies how a mock method behaves by default, without imposing any expectation that it must be called.

### Syntax

```cpp
ON_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)  // Optional, at most once
    .WillByDefault(action);        // Required
```

- Use `ON_CALL` to define the behavior that applies to any call not matched by `EXPECT_CALL` expectations.
- When multiple `ON_CALL`s apply, the last matching one takes precedence.

### Example

```cpp
using ::testing::Return;
using ::testing::_;

ON_CALL(mock_turtle, GetX())
    .WillByDefault(Return(42));

// Usage in a test:
EXPECT_CALL(mock_turtle, GoTo(50, _));
...code exercising the mock...
```

Calls to `GetX()` without explicit expectations will return 42 by default.

---

## Call Counts and Cardinalities

Understanding how many times a method is called is crucial. Cardinalities represent expected call counts flexibly.

### Built-in Cardinalities

| Cardinality     | Meaning                          |
|-----------------|--------------------------------|
| `AnyNumber()`   | Any amount of calls             |
| `AtLeast(n)`    | At least _n_ calls              |
| `AtMost(n)`     | At most _n_ calls               |
| `Between(m,n)`  | Between _m_ and _n_ calls       |
| `Exactly(n)` or `n` | Exactly _n_ calls. `0` means never called. |

### Default Cardinality Inference

- No `.Times()` and no actions => `Exactly(1)`
- N `WillOnce()` and no `WillRepeatedly()` => `Exactly(N)`
- N `WillOnce()` and one `WillRepeatedly()` => `AtLeast(N)`

### Common Pitfall: Sticky Expectations vs Retiring

By default, expectations are "sticky", which means they remain active even when saturated, causing subsequent calls to cause errors. Use `.RetiresOnSaturation()` to make an expectation retire automatically.

### Example

```cpp
EXPECT_CALL(mock, Method(42)).Times(2);  // Expects two calls with argument 42
...
mock.Method(42);
mock.Method(42);
mock.Method(42);  // Fails: exceeded call count
```

With `.RetiresOnSaturation()`, the expectation becomes inactive after two calls, allowing other expectations to match.

---

## Controlling Call Order with Sequences

Sometimes, you want to ensure calls happen in a particular sequence.

### Using `Sequence` and `InSequence`

- Define zero or more `Sequence` objects.
- Add your `EXPECT_CALL()` statements to one or more sequences via `.InSequence()`.
- Expected calls in the same sequence must happen in the order defined by the expectations.

```cpp
using ::testing::Sequence;
Sequence s;
EXPECT_CALL(mock, Init()).InSequence(s);
EXPECT_CALL(mock, Start()).InSequence(s);
// Init() must be called before Start()
```

### Using `InSequence` Helper Object

Wrap expectations inside an `InSequence` block to automatically add them to a private anonymous sequence.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, Step1());
  EXPECT_CALL(mock, Step2());
}
// Ensures Step1() is called before Step2()
```

### Partial Orders with Multiple Sequences

You may specify multiple sequences per expectation to create partial orders forming Directed Acyclic Graphs (DAGs).

### Using `.After()` Clause for Fine-Grained Control

You can specify that an expectation can only be met after one or more other expectations or sets of expectations have been satisfied.

```cpp
Expectation e1 = EXPECT_CALL(a, Foo());
EXPECT_CALL(b, Bar()).After(e1);
```

Multiple arguments of `.After()` are supported (up to five). This enables constructing complex dependency graphs.

---

## Default Actions, Unexpected and Uninteresting Calls

- **Default actions** define what happens when a mock method is invoked without a matching expectation or once an expectation’s explicit actions have been exhausted.
- **Unexpected calls** occur when a call matches no `EXPECT_CALL` expectations.
- **Uninteresting calls** occur when a mock method has no expectations set.

### Handling Default Actions

- If no action is specified using `ON_CALL`, default actions apply (e.g., returning 0, `false`, or default constructed objects).
- If you specify multiple `ON_CALL`s, the **most recent matching ON_CALL** takes precedence.

### Unexpected Calls

- Unexpected calls cause test failures.
- GoogleMock will print detailed failure messages to help debug, including which expectations were tried and did not match.

### Uninteresting Calls

- By default, uninteresting calls produce warnings.
- Use `NiceMock<T>` to suppress these warnings.
- Use `StrictMock<T>` to treat these calls as test failures.

---

## Managing Actions and Behavior

### Specifying Actions

Use `.WillOnce()` and `.WillRepeatedly()` to define actions that get executed when expectations match.

Example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillRepeatedly(Return(20));
```

The first call returns 10; subsequent calls return 20.

### Common Action Types

- `Return(value)`: Returns the given value.
- `ReturnRef(variable)`: Returns a reference to variable.
- `Invoke(callable)`: Calls a function or lambda.
- Composite actions like `DoAll()`.

### Best Practices

- Avoid side effects in actions unless needed.
- Use lambdas or functors to customize behavior flexibly.

---

## Verifying Expectations Explicitly

GoogleMock automatically verifies expectations on mock destruction. You can force verification before that using:

```cpp
bool ok = Mock::VerifyAndClearExpectations(&mock);
ASSERT_TRUE(ok);
```

This is useful when mocks may leak otherwise or to control check points.

### Clearing Expectations and Default Actions

Similarly, use:

```cpp
bool ok = Mock::VerifyAndClear(&mock);
```

This verifies and clears all expectations and default actions.

---

## Tips and Common Pitfalls

- **Specify expectations before exercising the mock.** Setting expectations after calls leads to undefined behavior.
- **Use `RetiresOnSaturation()` for expectations that should become inactive after a limit.**
- **Use sequences to enforce call ordering when order matters.**
- **Use `ON_CALL` for default behavior without strict call requirements.**
- **Use `NiceMock` or `StrictMock` to control reactions to uninteresting calls.**
- **Avoid ambiguous overloads by specifying matchers explicitly.**

---

## Example: Ordered Expectations with Multiple Calls

```cpp
using ::testing::InSequence;
using ::testing::Return;

class MockTurtle {
 public:
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(void, Forward, (int distance), ());
  MOCK_METHOD(void, PenUp, (), ());
};

TEST(DrawTest, DrawsLineInOrder) {
  MockTurtle turtle;
  {
    InSequence seq;
    EXPECT_CALL(turtle, PenDown());
    EXPECT_CALL(turtle, Forward(100));
    EXPECT_CALL(turtle, PenUp());
  }
  
  // Code exercising turtle
  turtle.PenDown();
  turtle.Forward(100);
  turtle.PenUp();
}
```

This test ensures that the turtle’s movements happen in order.

---

## References & Further Reading

- [GoogleMock Introduction & Basics](gmock_for_dummies.md)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](reference/actions.md)
- [Cardinalities Reference](gmock_cheat_sheet.md#CardinalityList)
- [Mocking Reference](docs/reference/mocking.md)
- [Using Mocks Guide](guides/core-testing-workflows/using-mocks.md)

For detailed best practices and advanced usage, see the [gMock Cookbook](docs/gmock_cook_book.md).

---

## Troubleshooting

- **Unexpected call failures:** Check that all expected calls are set via `EXPECT_CALL` prior to exercising mocks.
- **Uninteresting call warnings:** Use `NiceMock` or add catch-all `EXPECT_CALL(...).Times(AnyNumber())`.
- **Test fails due to incorrect call order:** Use `Sequence` objects or `InSequence` blocks to control order.
- **Default actions not executed as expected:** Verify that `ON_CALL` is set appropriately and that `WillOnce`/`WillRepeatedly` are correctly chained.

For more troubleshooting tips, refer to the [Mocking Troubleshooting](faq/troubleshooting/mocking-problems.md) page.

---

This documentation page equips you to confidently specify, sequence, and verify expectations using GoogleMock macros, enabling robust and precise unit testing of C++ code.