---
title: "Setting Expectations and Configuring Actions"
description: "Outlines API and macros for ON_CALL, EXPECT_CALL, action configuration (Invoke, Return, etc.), cardinalities, and sequencing. Empowers users to precisely specify mock behavior, argument handling, and call order."
---

# Setting Expectations and Configuring Actions

This documentation details how to precisely specify behavior, argument handling, and the ordering of calls in GoogleMock using the powerful `ON_CALL` and `EXPECT_CALL` macros, alongside action configuration techniques. It empowers you to control mocks with granular expectations, cardinalities, and call sequencing.

---

## 1. Overview of Setting Expectations

Setting expectations on mock methods is at the heart of interaction-based testing with GoogleMock. Expectations allow you to declare which methods of your mock objects you expect to be called, the arguments they should receive, how many times they will be called, and what they should return or do when invoked.

### Key concepts:

- **ON_CALL** sets default behaviors without enforcing any call count expectations.
- **EXPECT_CALL** sets both behavior and strict expectations for calls (arguments, call counts, call order).
- You combine **matchers** with **actions** to specify what arguments are allowed and what happens when the mock method is called.

Always set expectations before exercising the mock in your tests to ensure correct verification.

---

## 2. Using `ON_CALL`: Specifying Default Behaviors Without Expectations

### Purpose
`ON_CALL` configures how mocked methods behave *when called* but does *not* expect these calls to occur. This distinction keeps your tests resilient, avoiding over-constraining the behavior when it's not relevant to the verification.

### Syntax
```cpp
ON_CALL(mock_object, Method(matchers))
    [.With(multi_argument_matcher)]
    .WillByDefault(action);
```

- `.With()`  (optional) specifies a matcher over the entire argument tuple to filter calls.
- `.WillByDefault()`  (required) specifies the action to take when the call matches.

### Example
```cpp
using ::testing::Return;
using ::testing::_;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (int), (override));
};

MockFoo mock;
ON_CALL(mock, GetValue(_)).WillByDefault(Return(42));
```
Here, any call to `mock.GetValue()` returns `42` unless overridden by an `EXPECT_CALL` in the test.

### Best Practices
- Use in test fixture constructors or setup to define common default behaviors.
- Avoid using `ON_CALL` to enforce expectations on call counts — use `EXPECT_CALL` instead.
- When you want to silence warnings from uninteresting calls, `ON_CALL` combined with `NiceMock` can help.

---

## 3. Using `EXPECT_CALL`: Defining Precise Expectations

### Purpose
`EXPECT_CALL` not only defines the mock method’s behavior but also asserts that the method should be called according to specified constraints.

### Syntax
```cpp
EXPECT_CALL(mock_object, Method(matchers))
    [.With(multi_argument_matcher)]  
    [.Times(cardinality)]
    [.InSequence(sequences...)]
    [.After(expectations...)]
    [.WillOnce(action)...]
    [.WillRepeatedly(action)]
    [.RetiresOnSaturation()];
```

### Clause Details

- `.With(multi_argument_matcher)`: Match the entire argument tuple with a composite matcher.

- `.Times(cardinality)`: Specify how many times the call is expected:
  - `AnyNumber()`: zero or more times
  - `AtLeast(n)`, `AtMost(n)`, `Between(m, n)`, `Exactly(n)` (or `n`)

- `.InSequence(sequences...)`: Require that calls matching this expectation occur within specified sequences, enforcing ordering.

- `.After(expectations...)`: Specify that this expectation may only be matched *after* the listed expectations are satisfied, enabling arbitrary partial ordering.

- `.WillOnce(action)`: Define what happens on the next invocation matching this expectation, can be chained multiple times to specify sequential behaviors.

- `.WillRepeatedly(action)`: Define what happens after all `WillOnce()` actions are consumed.

- `.RetiresOnSaturation()`: Automatically retire the expectation once the upper bound of calls has been reached.

### Examples
```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::AtLeast;
using ::testing::Sequence;

Sequence s1;

EXPECT_CALL(mock, Foo(5))
    .Times(2)
    .WillOnce(Return(10))
    .WillOnce(Return(20));

EXPECT_CALL(mock, Bar(_))
    .Times(AtLeast(1))
    .InSequence(s1)
    .WillRepeatedly(Return(true));

Expectation e = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Cleanup()).After(e);
```

### Ordering Expectations
Ensuring mocks are called in the correct order prevents subtle bugs.

- Use `InSequence` for linear sequences.
- Use `.After()` with other expectations/expectation sets to describe complex DAGs.

### Cardinalities and Call Limits
- Omit `.Times()` to let GoogleMock infer default:
  - If no Will clauses, default is once.
  - If N `WillOnce()`, infertimes N.
  - If any `WillRepeatedly()`, infer `AtLeast(N)`.

- Setting `.Times(0)` prohibits any call to the method.

### Use `.RetiresOnSaturation()` to make expectations non-sticky
Expectations are sticky by default, meaning they remain active even after saturation. Use `.RetiresOnSaturation()` to auto-retire when saturated to allow subsequent expectations to be used.

---

## 4. Configuring Actions: Defining Mocked Method Behavior

The behavior of mock functions when they are invoked is controlled by actions.

### Built-in actions include:
- `Return(value)`: returns a copy of *value*.
- `ReturnRef(reference)`: returns a reference to an existing object.
- `ReturnPointee(pointer)`: returns the dereferenced value at call time.
- `DoAll(action1, action2, ..., actionN)`: performs multiple actions in order, returning the last’s value.
- `SetArgPointee<N>(value)`: sets the pointed-to value of the Nth argument.
- `SetArrayArgument<N>(first, last)`: copies an array into the Nth argument pointer.
- `Invoke(function/functor/lambda)`: calls the specified callable with the arguments.
- `InvokeWithoutArgs(function)`: calls a zero-argument callable ignoring mock arguments.
- `InvokeArgument<N>(args...)`: invokes the Nth argument itself, which must be a callable.
- `IgnoreResult(action)`: ignores an action’s return value, useful for `void` mock methods.

### Defining Custom Actions
- You can define lambdas, functors, or classes with call operators compatible with mocked method signatures.
- Parameterized and monomorphic/polymorphic actions can be implemented for versatile reuse.

### Practical Tips
- Use `ReturnPointee` to safely return live-updated values.
- Combine side effects with `DoAll()` if the mocked function modifies arguments and returns a value.
- Use `Invoke` to call existing functions or lambdas.
- To call a parent class’s concrete method, use `EXPECT_CALL(mock, Method(args)) .WillOnce([&mock](...) { return mock.Class::Method(...); })` to avoid infinite recursion.

---

## 5. Controlling Call Order: Cardinalities and Sequencing

### Cardinalities
They specify how often a mocked method is expected:
- Flexible granularities let tests express exact or fuzzy call counts.
- Use built-in cardinalities like `AnyNumber()`, `AtLeast()`, `AtMost()`, `Between()`, and `Exactly()`.

### Sequences
Control call ordering with:
- `InSequence`: Enforces linear order inside a scope.
- `.InSequence()` clause: Associate an expectation with a user-defined sequence.
- `.After()` clause: Enforce ordering relative to one or more earlier expectations, enabling arbitrary DAG ordering.

### Sticky behavior
Expectations remain active by default even when saturated to prevent premature failure. Use `.RetiresOnSaturation()` to change this behavior.

---

## 6. Advanced Behavior and Best Practices

### Prioritizing expectations
- GoogleMock searches expectations in reverse order; later expectations override earlier ones. Put more general expectations before specific ones.

### Ignoring arguments
- For uninteresting or complex arguments, omit parameter lists or use `_` matcher.
- When matching multiple arguments as a tuple, use `.With()` with tuple matchers.

### Uninteresting vs Unexpected calls
- **Uninteresting**: No expectation, no error but warning issued (unless mock is nice).
- **Unexpected**: Calls don't match any expectation, always an error.
- Control the behavior with `NiceMock`, `NaggyMock` (default), and `StrictMock` wrappers.

### Defining expectations that don’t specify parameters
- Allowed only for non-overloaded methods.
- Use with care, as omitting argument matchers ignores argument verification.

### Combining actions
- Use `DoAll()` to chain multiple actions (e.g., set output arguments + return a value).

### Tips for move-only types
- Mock methods can accept and return move-only types (like `std::unique_ptr`).
- Use lambdas or functors to return new instances per call.

---

## 7. Troubleshooting Common Issues

### Missing or misordered expectations
If a call doesn’t match any `EXPECT_CALL`, GoogleMock will report an unexpected call.

### Too many or too few calls
Failure messages will detail call count mismatches, including whether a call was over or under the expected number.

### Over-specified expectations
To avoid brittle tests due to too-specific expectations:
- Use `ON_CALL` for defaults.
- Use `EXPECT_CALL` only when verifying critical interactions.
- Don’t set more expectations than necessary.

### Uninteresting call warnings
- Suppressed by using `NiceMock`.
- Increased to errors by using `StrictMock`.

---

## 8. Summary

GoogleMock’s API for setting expectations and configuring actions lets you express how mocks behave and verify call patterns precisely. Leveraging `ON_CALL` for common default behaviors, and `EXPECT_CALL` for strict verification, helps produce robust and maintainable tests. Understanding cardinalities, actions, and call sequencing completes the powerful toolkit for interaction-based testing.

---

## 9. Useful Code Examples

### Setting default action with ON_CALL
```cpp
ON_CALL(mock, Foo(_))
    .WillByDefault(Return(123));  // Returns 123 by default
```

### Expecting calls with specific arguments
```cpp
EXPECT_CALL(mock, Bar(5))
    .Times(2)
    .WillOnce(Return(true))
    .WillOnce(Return(false));
```

### Enforcing call order
```cpp
Sequence s;
EXPECT_CALL(mock, Init()).InSequence(s);
EXPECT_CALL(mock, Process()).InSequence(s);
// Init must be called before Process
```

### Mocking side effects and return values
```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

### Calling real method inside mock
```cpp
EXPECT_CALL(mock, ConcreteMethod())
    .WillOnce([&mock]() { return mock.BaseClass::ConcreteMethod(); });
```

---

## 10. See Also

- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Matchers Reference](../assertions-and-matchers/using-matchers)
- [Actions Reference](../mocking-api/actions)
- [Core Concepts and Terminology](../../overview/core-concepts/core-concepts-terminology)
- [Defining Mocks and Methods](../mocking-api/defining-mocks-and-methods)
- [Strict, Nice, and Naggy Mocks](../mocking-api/strict-nice-mocks)

---