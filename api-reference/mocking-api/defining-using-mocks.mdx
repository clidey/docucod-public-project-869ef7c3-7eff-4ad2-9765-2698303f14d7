---
title: "Defining and Using Mock Objects"
description: "Guides users through the process of creating mock classes, declaring and implementing mock methods, and integrating mocks with test code. Highlights the core MOCK_METHOD macro, method qualifiers, and best practices."
---

# Defining and Using Mock Objects

This section guides you through creating mock classes, declaring and implementing mock methods, and integrating mocks with your test code. It highlights the core mock method macro `MOCK_METHOD`, method qualifiers you might use, and essential best practices to ensure your mocking is robust and efficient.

---

## Introduction to Mock Objects in GoogleMock

In testing, relying entirely on the real objects can be expensive, fragile, or simply unfeasible. Mock objects simulate the behavior of real objects by implementing their interfaces, allowing you to specify *expectations*â€”how methods will be called, with what arguments, how many times, and what they should return. This interaction-based testing is core to GoogleMock's design.

Mock objects differ from fakes, which provide working but simplified implementations. Mocks focus on specifying and verifying interactions.

---

## Creating Mock Classes

To write a mock class:

1. Derive from the interface or class with virtual methods.
2. Use the `MOCK_METHOD` macro in your mock class's public section to declare mocked methods.
3. For const methods, methods with `noexcept`, call conventions, or reference qualifiers, add optional specifiers as needed.

### The `MOCK_METHOD` Macro

Signature:

```cpp
MOCK_METHOD(return_type, method_name, (argument_types...), (specifiers...));
```

- The first three parameters correspond to the original method declaration.
- The optional fourth parameter lists qualifiers such as `const`, `override`, `noexcept`, `Calltype(...)`, `ref(...)`.

The macro handles generating the mock method's boilerplate implementation for you.

### Example

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Handling Unprotected Commas

If your return type or arguments contain commas (e.g., templates like `std::pair<bool, int>`), wrap them in an extra pair of parentheses or use typedef/using declarations:

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD(BoolAndInt, GetPair, ());
```

### Placement

Always place `MOCK_METHOD` declarations in the `public:` section of your mock, regardless of the original method access specifier.

### Overloaded and Template Methods

You can mock all overloads of a function by declaring each with `MOCK_METHOD`, respecting their signatures, including constness.

If you omit some overloads, use `using Base::method;` to bring them into scope to avoid compiler warnings.

### Special Cases

- Non-virtual functions can be mocked by defining unrelated mock classes replicating the method signatures (without `override`). Typically used with compile-time polymorphism.
- Destructors cannot be mocked with `MOCK_METHOD`. Instead, add a mock method such as `Die()` and call it explicitly in the destructor for verification.

---

## Using Mock Objects in Tests

Mock objects are simple to use once defined.

### Typical Workflow

1. Include GoogleMock headers and import necessary names from `testing` namespace.
2. Instantiate your mock objects.
3. Optionally set default behavior for methods using `ON_CALL`.
4. Write expectations using `EXPECT_CALL` with argument matchers, call counts, and behaviors.
5. Exercise the code under test.
6. On destruction, GoogleMock verifies that expectations are satisfied.

### Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;
using ::testing::Return;

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
};

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown())
      .Times(AtLeast(1));
  EXPECT_CALL(turtle, Forward(10));

  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

### Important Notes

- `EXPECT_CALL` must precede exercising code that uses the mock.
- If methods are called more or less than expected (or with wrong arguments), the test fails immediately.
- `EXPECT_CALL` matches expectations *in the future*, not retroactively.
- Use `ON_CALL` to set default method behavior without setting call expectations.

---

## Setting Expectations with `EXPECT_CALL`

`EXPECT_CALL` sets constraints on how a mock method will be called and what it will do.

### Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
  .With(multi_arg_matcher)         // Optional; must be first clause
  .Times(cardinality)             // Optional; controls call count
  .InSequence(sequences...)        // Optional; call order control
  .After(expectations...)          // Optional; partial order control
  .WillOnce(action)               // Optional; action for first call(s)
  .WillRepeatedly(action)         // Optional; action for subsequent calls
  .RetiresOnSaturation();         // Optional; retire expectation when saturated
```

### Modifiers

- **With**: applies a multi-argument matcher on the call arguments as a tuple.
- **Times**: specifies the expected number or range of calls (e.g., `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`). If omitted, GoogleMock infers it based on presence of `WillOnce` and `WillRepeatedly`.
- **InSequence**: associates expectations with sequences for strict call ordering.
- **After**: specifies that this expectation can only be matched after some other expectations have been satisfied.
- **WillOnce / WillRepeatedly**: specify the actions the stubbed method will perform.
- **RetiresOnSaturation**: when the expected number of calls is met, this expectation retires and will no longer match calls.

### Example

```cpp
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

Indicates that `GetX()` will be called 5 times, returning 100 the first time, then 150, then 200 thereafter.

### Call Cardinality

- `Times(0)` ensures a method should never be called.
- GoogleMock infers `Times` if omitted based on chained `WillOnce` / `WillRepeatedly`.
- Exact, range, and fuzzy call counts are supported (`Exactly`, `AtLeast`, `Between`).

### Matchers

- Use argument matchers like `_` (anything), `Eq`, `Ge`, and custom matchers to express which calls are expected.
- If you do not care about argument values, omit matchers (for non-overloaded methods) to expect any parameters.

### Using Multiple Expectations Together

Expectations are matched in reverse order (newest first). More specific expectations should be declared after more general ones.

### Call Ordering

- **Unordered Calls**: default; expectations can match in any order.
- **Ordered Calls**: use `InSequence` or `.After()` to specify strict or partial ordering.

### Sticky Expectations and Retirement

By default, expectations remain active (sticky) even when saturated, continuing to match calls and cause errors upon extra calls. Use `.RetiresOnSaturation()` to retire an expectation once its call count is met.

---

## Method Qualifiers in Mock Definitions

When mocking methods, the fourth macro parameter to `MOCK_METHOD` controls qualifiers:

| Qualifier            | Description                                               |
|----------------------|-----------------------------------------------------------|
| `const`              | Marks method const; required if overriding a const method |
| `override`           | Indicates method overrides virtual method; recommended    |
| `noexcept`           | Marks method noexcept; required if base method is noexcept|
| `Calltype(...)`      | Specifies calling convention (e.g., `Calltype(STDMETHODCALLTYPE)`) |
| `ref(&)` or `ref(&&)`| Reference qualifiers for the method (lvalue/rvalue refs)   |

Example:

```cpp
MOCK_METHOD(int, Foo, (double), (const, override, noexcept));
```

---

## Best Practices

- **Mock interfaces you own:** Avoid mocking classes from external owners. When necessary, define mocks close to the code, preferably in separate mock headers with `testonly` scope.
- **Virtual destructors:** Always ensure your base interfaces have virtual destructors to avoid memory leaks.
- **Declare expectations before usage:** Set all `EXPECT_CALL`s before passing mocks to code under test.
- **Use `NiceMock` and `StrictMock` appropriately:** Suppress warnings on uninteresting calls with `NiceMock`; treat them as test failures with `StrictMock`.
- **Use default actions with `ON_CALL` when behavior, not expectation, is needed:** Avoid unintentional test brittleness by using `ON_CALL` for default behaviors and reserve `EXPECT_CALL` for verifications.
- **Retire expectations in repeated calls:** Use `.RetiresOnSaturation()` when older expectations should be disabled after being satisfied.
- **Avoid over-specifying argument matchers:** Use wildcards `_` or omit arguments when specific values are not critical.
- **Use sequences for ordered calls:** When order matters, employ `InSequence` blocks or `After` clauses.

---

## Troubleshooting Common Issues

- **Expectations not matched:** Enable verbose mock logging with `--gmock_verbose=info` to trace calls and matched expectations.
- **Unexpected calls:** Ensure all expected calls are set with `EXPECT_CALL`. Use `Times(0)` to explicitly prohibit calls.
- **Too many or too few calls:** Adjust `Times()` accordingly or use fuzzy cardinalities.
- **Compiler issues with commas:** Wrap types with commas in parentheses or use type aliases.
- **Memory leaks or missing destructor calls:** Verify proper virtual destructors.
- **Confusion with overloaded methods:** Use `Const()` wrapper or `TypedEq` matchers to disambiguate in expectations.

---

## Summary

Defining and using mock objects with GoogleMock enables precise control over the behavior and verification of dependencies in C++ tests. By leveraging the `MOCK_METHOD` macro and setting detailed expectations with `EXPECT_CALL`, users can write robust, maintainable tests focused on interaction correctness. Method qualifiers, call ordering, and default behaviors provide fine-grained control. Employ best practices around ownership, call sequencing, and verbosity to maximize the effectiveness of mocks.

---

For deeper dives into related mocking workflows, see these sections:

- [Expectations and Actions](../mocking-api/expectations-actions)
- [Advanced Matchers for Mocking](../mocking-api/advanced-matchers-mocking)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Matchers Reference](../reference/matchers.md)
- [Actions Reference](../reference/actions.md)

# 
