---
title: "Actions and Macros"
description: "Covers defining and using test actions, including custom actions, return value logic, and macro utilities that enable mock methods to simulate desired behaviors or inject test conditions."
---

# Actions and Macros

This page details the available actions and macros you can use with GoogleMock to define custom behaviors and simulate the outcomes of mocked methods. Actions specify or influence what a mock function does when called, enabling you to create flexible, expressive tests that go beyond simple return values.

---

## Understanding Actions

An **action** in GoogleMock describes what a mock function should do when invoked. These behaviors can range from returning values, throwing exceptions, calling callbacks, to performing side effects such as modifying arguments.

By using actions, you control your mockâ€™s behavior precisely, enabling thorough testing of the interaction with the mock object.

## Return Value Actions

These actions specify what a mock method should return when called.

| Action                            | Description                                   |
|---------------------------------|-----------------------------------------------|
| `Return()`                      | Returns from a `void` mock function.          |
| `Return(value)`                 | Returns the given `value`. The value is converted at expectation setup, not at execution. |
| `ReturnArg<N>()`                | Returns the `N`-th (0-based) argument.         |
| `ReturnNew<T>(a1, ..., ak)`     | Returns a newly created object `new T(...)`, instantiated fresh on each call. |
| `ReturnNull()`                  | Returns a null pointer.                         |
| `ReturnPointee(ptr)`            | Returns the value pointed to by `ptr` at call time.
| `ReturnRef(variable)`           | Returns a reference to the given variable.     |
| `ReturnRefOfCopy(value)`        | Returns a reference to a copy of `value` that lives as long as the action. |
| `ReturnRoundRobin({a1,...,ak})`| Cycles through returning each value in the provided list, starting over at the end. |

### Example

```cpp
using ::testing::Return;
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

This means the first call returns `42`, every subsequent call returns `0`.

## Side Effect Actions

Side effects allow you to manipulate arguments passed into mock functions or otherwise affect external state.

| Action                          | Description                                     |
|--------------------------------|-------------------------------------------------|
| `Assign(&variable, value)`       | Assigns `value` to variable.                      |
| `DeleteArg<N>()`                | Deletes (invokes `delete` on) the `N`-th argument (must be a pointer).
| `SaveArg<N>(pointer)`           | Saves a copy of the `N`-th argument into the location pointed by `pointer`.
| `SaveArgByMove<N>(pointer)`     | Saves the `N`-th argument by move assignment.
| `SaveArgPointee<N>(pointer)`    | Saves the value pointed to by the pointer in the `N`-th argument.
| `SetArgReferee<N>(value)`       | Assigns `value` to the variable referred to by the `N`-th argument.
| `SetArgPointee<N>(value)`       | Assigns `value` to the variable pointed to by the `N`-th argument.
| `SetArrayArgument<N>(first, last)` | Copies elements from `[first, last)` into the array pointed by the `N`-th argument or iterator. |
| `SetErrnoAndReturn(error, value)` | Sets `errno` to `error` and returns `value`.
| `Throw(exception)`              | Throws the given exception object.               |

### Example

```cpp
using ::testing::SetArgPointee;
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(SetArgPointee<0>(5));  // Sets argument 0's pointee to 5
```

## Using Callables as Actions

You can define a mock method's behavior by invoking a callable (function, lambda, functor) when the mock method is called.

| Action                                     | Description                                         |
|--------------------------------------------|-----------------------------------------------------|
| `f`                                        | Calls the callable `f` with the mock function's arguments.
| `Invoke(f)`                                | Same as above; supports functions, functors, methods.
| `Invoke(object_pointer, &class::method)`  | Calls the specified method on the object pointer.
| `InvokeWithoutArgs(f)`                      | Calls function or functor `f` with no arguments.
| `InvokeWithoutArgs(object_pointer, &class::method)` | Calls method on object with no arguments.
| `InvokeArgument<N>(arg1, arg2, ..., argk)`| Calls the `N`-th argument (functor) with the provided arguments.

### Example

```cpp
using ::testing::Invoke;
EXPECT_CALL(mock, Compute(_))
    .WillOnce(Invoke(&helper, &Helper::ComputeImpl));
```

## Default Action

| Action        | Description                                              |
|---------------|----------------------------------------------------------|
| `DoDefault()` | Perform the default action specified by `ON_CALL()` or the built-in default action.

**Note:** `DoDefault()` cannot be used inside composite actions.

## Composite Actions

Composite actions combine several actions into one sequence.

| Action                   | Description                                       |
|--------------------------|-------------------------------------------------|
| `DoAll(a1, a2, ..., an)` | Performs all actions in sequence; returns the value of the last action. The first `n-1` must return void.
| `IgnoreResult(a)`        | Performs action `a` and ignores its return value.
| `WithArg<N>(a)`          | Performs action `a` passing only the `N`-th argument.
| `WithArgs<N1, ..., Nk>(a)`| Performs action `a` with selected arguments at specified indices.
| `WithoutArgs(a)`         | Performs action `a` with no arguments.

### Example

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

This sets the pointer argument to 5 and returns `true`.

## Defining New Actions

Define custom actions using macros or by implementing interfaces.

### ACTION Macros

| Macro                 | Description                              |
|-----------------------|------------------------------------------|
| `ACTION(name) { ... }`   | Defines an action with no parameters.
| `ACTION_P(name, p) { ... }` | Defines an action with one parameter.
| `ACTION_Pk(name, p1, ..., pk) { ... }` | Action with multiple parameters.

Inside the action body, you can refer to arguments of the mock as `arg0`, `arg1`, ..., and predefined symbols like `return_type`, `function_type`, and `args` (tuple).

### Example

```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}

EXPECT_CALL(mock, DoSomething)
    .WillOnce(IncrementArg1());
```

### Implementing Actions Directly

For advanced use, implement `::testing::ActionInterface<F>` where `F` matches the mock method signature. Define the `Perform` method to execute your action.

---

## Practical Tips

- Use `ON_CALL` to set common default behaviors that your tests don't need to verify explicitly.
- Use `EXPECT_CALL` with `WillOnce` and/or `WillRepeatedly` for setting explicit expectations and behaviors.
- For complex argument manipulations, chain actions with `DoAll`.
- When returning references, use `ReturnRef` instead of `Return`.
- Use `Invoke` with a function or lambda to define flexible action behavior.
- `InvokeArgument` is handy when your mock method takes a callback as an argument and you want to invoke it during the call.

## Common Pitfalls

- Beware that `Return(value)` evaluates `value` **once** at expectation definition, not at call time.
- Use `ReturnPointee` or `ReturnRef` if you want to return live values.
- `DoDefault()` cannot be used inside `DoAll()` or other composites.
- `SetArgPointee` requires the argument to be a pointer type.
- Composite actions only use the return value of the last action.

## Conclusion

By leveraging actions and macros smartly, you can create powerful and maintainable tests that simulate complex behaviors of your mocked interfaces.

---

### See Also
- [Mocking Reference](reference/mocking.md#EXPECT_CALL)
- [Actions Reference](reference/actions.md)
- [Matchers Reference](reference/matchers.md)
- [gMock Cookbook - Use OnCall Effectively](guides/real-world-use-cases/mocking-patterns.md#OnCall)
- [gMock for Dummies](guides/get-started/mocking-basics.md)
