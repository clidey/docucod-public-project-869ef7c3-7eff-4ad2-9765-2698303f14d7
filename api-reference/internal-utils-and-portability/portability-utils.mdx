---
title: "Portability and Platform Utilities"
description: "Explore internal headers providing macros, type abstractions, and feature/config checks for cross-platform consistency. Recommended for advanced users working with custom toolchains or platform-specific integration."
---

# Portability and Platform Utilities

GoogleTest and GoogleMock are designed to operate seamlessly across a wide range of platforms, compilers, and toolchains. This page explores the internal headers and portability utilities that facilitate this cross-platform consistency. Aimed primarily at advanced users intending to create custom toolchains or integrate GoogleTest and GoogleMock into platform-specific environments, this documentation delves into key internal abstractions, macros, and feature-detection mechanisms.

---

## Overview

The portability layer of GoogleMock is implemented primarily within internal headers such as `gmock-port.h` and relies heavily on utilities defined in GoogleTest's `gtest-port.h`. These headers provide:

- Macros for feature detection and flags handling
- Abstraction of low-level types and platform capabilities
- Compiler and standard library compatibility workarounds
- Threading and synchronization primitives
- Platform detection and conditional compilation logic

The design follows the principle that macros ending with an underscore (`_`) and symbols in internal namespaces are not part of the public API but serve as user-extensible points and internal implementation details. Direct usage of these constructs outside of GoogleMock or GoogleTest source code is discouraged.

---

## Key Components and Utilities

### 1. Platform and Compiler Detection

GoogleTest auto-detects the target platform and compiler to enable or disable features accordingly.

- Platforms include Windows, Linux, macOS, embedded systems, and many Unix flavors.
- Compiler versions are checked to ensure compliance with C++17 or newer requirements.

For example, `gmock-port.h` enforces a minimum MSVC version (Visual C++ 2015) and integrates macros like `GTEST_OS_WINDOWS` or `GTEST_HAS_PTHREAD` to conditionally include features.

### 2. Feature Flags and Macros

These macros signal the presence or absence of platform features or compiler support, such as:

- `GTEST_HAS_PTHREAD`: Indicates POSIX threads support.
- `GTEST_HAS_EXCEPTIONS`: Indicates whether exception handling is enabled.
- `GTEST_HAS_RTTI`: Run-Time Type Information availability.
- `GTEST_HAS_STD_WSTRING`: Support for `std::wstring`.
- `GTEST_HAS_FILE_SYSTEM`: File system availability.

The macros default to conservative values but can be overridden by users for custom environments.

### 3. Flag Management

GoogleMock shares a command-line flags system with Google Test, enhanced for optional Abseil integration.

- Macros like `GMOCK_DEFINE_bool_`, `GMOCK_DECLARE_bool_`, `GMOCK_FLAG_GET`, and `GMOCK_FLAG_SET` provide flag declaration, definition, and access.
- When Abseil is present, it leverages Abseil's flag implementation; otherwise, it falls back to a simpler, built-in macro-based approach.
- Users can customize flags through the `gmock/internal/custom` directory.

### 4. Threading and Synchronization

Portability layers expose abstractions around mutexes, notifications, and thread-local storage:

- Depending on platform support, mutexes are implemented via native threading APIs or dummy stubs.
- Thread-local storage wrappers simplify per-thread state management.
- Synchronization primitives facilitate thread-safe GoogleMock operations, especially relevant for death tests and multi-threaded scenarios.

### 5. Utility Functions and Wrappers

- Platform-independent wrappers for POSIX file I/O and environment operations ensure consistent behavior.
- Character classification and conversion helpers handle locale and encoding differences.
- Logging utilities and assertion-check macros standardize error reporting across platforms.

### 6. Customization Points

Advanced users can override or extend internal behaviors by defining macros via the `gmock/internal/custom/gmock-port.h` header. This supports use cases like:

- Custom command-line flags
- Specialized threading models
- Platform-specific feature toggling

---

## Using Portability Utilities in Custom Toolchains

For users integrating or embedding GoogleMock into non-standard platforms or custom toolchains, these utilities provide a robust foundation:

1. **Configuration:** Ensure feature macros match your platform capabilities.
2. **Flag Handling:** Use flag macros to define and manage test suite options consistently.
3. **Thread Safety:** Leverage provided synchronization classes to maintain thread safety.
4. **Platform Detection:** Use existing macros to conditionally compile platform-specific code.
5. **Custom Extensions:** Inject custom behavior via the `custom/` directory without modifying core headers.

---

## Example: Declaring a Custom Boolean Flag in GoogleMock

Suppose you want to add a new boolean flag to customize GoogleMock behavior. Using the portability utilities:

```cpp
#include "gmock/internal/gmock-port.h"

// Declare the flag externally.
GMOCK_DECLARE_bool_(my_custom_flag);

// Define the flag with a default value and documentation.
GMOCK_DEFINE_bool_(my_custom_flag, false, "Enable my custom feature.");

// Access the flag value.
bool is_enabled = GMOCK_FLAG_GET(my_custom_flag);

// Set the flag programmatically.
GMOCK_FLAG_SET(my_custom_flag, true);
```

This flag will integrate cleanly with command-line parsing and respects the underlying flag system, whether Abseil is enabled or not.

---

## Best Practices

- **Do not use internal macros or symbols directly** unless you are extending or customizing GoogleMock.
- **Avoid duplicating functionality already provided** by GoogleTest's portability layers.
- **Test customizations thoroughly across all target platforms** you intend to support.
- **Keep customizations isolated** in the provided `custom/` directories for ease of maintenance.

---

## Troubleshooting

| Issue | Cause | Solution |
|---|---|---|
| Compilation fails on older MSVC versions | Compiler version below Visual C++ 2015 | Upgrade MSVC to supported version |
| Flags not recognized or ignored | Conflicts between Abseil flags and built-in flags | Ensure consistent flag macro usage, or disable Abseil flags with `GTEST_NO_ABSL_FLAGS` |
| Thread safety issues | `GTEST_IS_THREADSAFE` not enabled or platform lacks pthread support | Verify build environment supports threads and `GTEST_HAS_PTHREAD` is set appropriately |
| Missing platform macros | Custom toolchain not defining expected platform macros | Define required macros matching your environment during build |

---

## References and Further Reading

- [GoogleTest `gtest-port.h` Source Header](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-port.h) — Core portability and platform detection utilities.
- [GoogleMock `gmock-port.h` Source Header](https://github.com/google/googletest/blob/main/googlemock/include/gmock/internal/gmock-port.h) — GoogleMock specific extensions of portability utilities.
- [Customization Points](https://github.com/google/googletest/blob/main/googlemock/include/gmock/internal/custom/README.md) — Guide to customizing internal macros and flags.
- [System Requirements & Supported Platforms](https://github.com/google/googletest/blob/main/docs/prerequisites-installation/system-requirements.md) — Platform and compiler compatibility details.
- [Supported Platforms & Ecosystem Overview](/overview/introduction-and-value/supported-platforms-and-ecosystem) — Understanding platform support from a high-level perspective.

---

This page belongs to the internal utilities and portability section, providing the foundation necessary for GoogleTest and GoogleMock to remain robust and portable across diverse environments. For typical usage scenarios, consult the Getting Started and Integration guides, while advanced users doing platform-specific embedding should leverage the customization points described here.
