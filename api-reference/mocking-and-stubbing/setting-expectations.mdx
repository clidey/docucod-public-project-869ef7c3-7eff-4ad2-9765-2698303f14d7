---
title: "Setting Expectations"
description: "Learn how to specify call expectations, cardinalities, and matching strategies for mock objects. This page documents the ON_CALL, EXPECT_CALL macros, and expectation builder APIs—helping users precisely control mock behaviors and verification."
---

# Setting Expectations

Learn how to specify call expectations, cardinalities, and matching strategies for mock objects. This page documents the `ON_CALL`, `EXPECT_CALL` macros, and expectation builder APIs—helping you precisely control mock behaviors and verification.

---

## Overview

Setting expectations in GoogleMock means telling your mock objects which calls to expect, how many times they should occur, with what argument values, and what behaviors (actions) to perform when these calls happen. This helps you define a precise contract for your mocks to validate code interactions exactly.

You primarily use the `EXPECT_CALL` macro to specify these expectations with rich and clear syntax. The `ON_CALL` macro is used to set default behavior for mock methods without enforcing call count expectations.

This page covers the syntax, semantics, and best practices for these core constructs.

---

## The `EXPECT_CALL` Macro: Specifying Call Expectations

`EXPECT_CALL` defines an expectation that a mock method will be invoked with certain arguments, how many times it may be called, and what actions it should perform.

### Syntax
```cpp
EXPECT_CALL(mock_object, Method(argument_matchers...))
    .With(multi_argument_matcher)    // Optional multi-arg matcher
    .Times(cardinality)               // Optional call count
    .InSequence(sequences...)         // Zero or more sequences
    .After(expectations...)           // Zero or more pre-requisite expectations
    .WillOnce(action)                 // Zero or more actions
    .WillRepeatedly(action)           // Optional repeating action
    .RetiresOnSaturation();           // Optional retire behavior
```

- The first parameter is the mock instance.
- The second parameter is the method name and its argument matchers (using matchers, literals, or `_` wildcard).
- Optional chained clauses specify more constraints and behaviors.

### Important Points

- `EXPECT_CALL` must be called **before** the tested code exercises the mock.
- If `Times()` is omitted, GoogleMock infers how many times the method is expected to be called based on actions:
  - No actions: expects exactly 1 call.
  - *n* `WillOnce()` actions, no `WillRepeatedly()`: expects exactly *n* calls.
  - *n* `WillOnce()` actions with a `WillRepeatedly()`: expects at least *n* calls.
- When multiple expectations exist for the same method, the **last** matching expectation that is active will be used.

### Argument Matching

Arguments can be literals or matchers (e.g., `Eq()`, `Ge()`, `_`). You can specify a multi-argument matcher with `.With()` for validation across all parameters simultaneously.

Example:
```cpp
using ::testing::_;
using ::testing::Lt;
EXPECT_CALL(mock, Foo(_, _)).With(Lt());  // first arg < second arg
```

### Cardinalities

Specifies how many times the calls should occur.

Common cardinalities include:
- `Times(AnyNumber())` - unlimited calls.
- `Times(AtLeast(n))`, `Times(AtMost(n))`, `Times(Between(m, n))` for ranges.
- `Times(n)` for exactly `n` times.
- `Times(0)` to disallow calls.

### Ordering Constraints

#### `.InSequence(sequences...)`
Include this expectation in one or more `Sequence` objects, requiring calls be made in the order specified by the sequences.

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Init()).InSequence(s1);
EXPECT_CALL(mock, Run()).InSequence(s1, s2);
EXPECT_CALL(mock, Finish()).InSequence(s2);
```

This enforces partial order constraints among calls.

#### `.After(expectations...)`
Specifies calls must occur after listed expectations complete.

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
ExpectationSet group;
group += EXPECT_CALL(mock, Load());
EXPECT_CALL(mock, Run()).After(e1, group);
```

---

## The `ON_CALL` Macro: Setting Default Behavior

`ON_CALL` sets the **default action** for a mock method. Unlike `EXPECT_CALL`, it does *not* set expectations or verify call counts—it only defines what the method does when called.

### Syntax
```cpp
ON_CALL(mock_object, Method(argument_matchers...))
    .With(multi_argument_matcher)    // Optional
    .WillByDefault(action);           // Exactly one
```

- Use `ON_CALL` for providing fallback behaviors shared by tests or common setups.
- When an `EXPECT_CALL` matches a call, its specified actions override `ON_CALL` behavior.

Example:
```cpp
using ::testing::Return;
ON_CALL(mock, GetValue(_)).WillByDefault(Return(42));
```

### Best Practice

Prefer to use `ON_CALL` in your test fixture `SetUp()` or mock constructor to specify normal behavior. Use `EXPECT_CALL` sparingly and deliberately only for behaviors or calls you want to verify happened.

---

## Expectation Builder API: More Control with Fluent Interfaces

Behind `EXPECT_CALL` and `ON_CALL` macros, you get access to expectation builder objects offering chainable methods to fine-tune expectations:

| Method                | Description                                   |
|-----------------------|-----------------------------------------------|
| `.With(matcher)`       | Multi-argument matcher applying to all args   |
| `.Times(cardinality)`  | Specifies how many times call is expected      |
| `.InSequence(seq...)`  | Specifies call ordering sequences               |
| `.After(expectation...)` | Specifies pre-requisite expectations          |
| `.WillOnce(action)`    | Action for a single call                        |
| `.WillRepeatedly(action)` | Action for repeated calls                     |
| `.RetiresOnSaturation()` | Retires expectation when saturated            |

These methods enforce usage rules:
- `.With()` can occur at most once and must be the first clause.
- `.Times()` at most once and must appear before actions and sequences.
- `.RetiresOnSaturation()` must be last.

---

## Common Usage Patterns

### Specifying Expectations With Actions

```cpp
using ::testing::Return;
EXPECT_CALL(turtle, GetX())
    .Times(3)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillOnce(Return(200));
```

This expects three calls, returning the specified values sequentially.

### Allowing Calls With Default Behavior

```cpp
ON_CALL(turtle, GetY()).WillByDefault(Return(42));
EXPECT_CALL(turtle, GetY()).Times(AnyNumber());
```

Expects calls can happen any number of times, all returning 42.

### Enforcing Call Order With Sequence

```cpp
Sequence s;
EXPECT_CALL(mock, First()).InSequence(s);
EXPECT_CALL(mock, Second()).InSequence(s);
```

`First()` must be called before `Second()`.

### Combining `After` with `InSequence`

```cpp
Expectation e1 = EXPECT_CALL(mock, Start());
Sequence s;
EXPECT_CALL(mock, Process()).InSequence(s);
EXPECT_CALL(mock, End()).InSequence(s).After(e1);
```

`End()` must be called after `Start()` and after `Process()` in sequence.

### Setting Times(0) to Disallow Calls

```cpp
EXPECT_CALL(mock, ForbiddenMethod(_)).Times(0);
```

Fails test immediately if `ForbiddenMethod` is called.

### Using `.WillRepeatedly` After `.WillOnce`

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillRepeatedly(Return(2));
```

First call returns 1, all subsequent calls return 2.

---

## Understanding Matching and Call Resolution Order

- GoogleMock matches calls against expectations in *reverse* order of their definitions. Later `EXPECT_CALL`s take precedence.
- For multiple expectations matching, the first matching active expectation is used.
- Default actions via `ON_CALL` operate independently, and the last matching `ON_CALL` is used for default behavior.
- If no expectation is found, the default action (from `ON_CALL` or the default for the return type) is performed, possibly triggering uninteresting call warnings depending on the mock’s strictness.

---

## Common Pitfalls and How to Avoid Them

- **Setting expectations after exercising mocks:** All `EXPECT_CALL` and `ON_CALL` setup must occur before calling any mock methods.
- **Omitting `Times()` without understanding inference:** Let GoogleMock infer times only if you understand the defaults.
- **Overlapping expectations without correct order:** Put more specific expectations after general catch-all expectations to take precedence.
- **Ignoring uninteresting call warnings:** Address either by adding appropriate `EXPECT_CALL` or using `NiceMock` if such calls are intentional.
- **Misusing `.With()` clause:** It can only appear once and must be the first clause in the chain.
- **Misordering clauses:** The order matters — `.Times()` before actions, `.RetiresOnSaturation()` must be last.

---

## Troubleshooting

### Test fails due to unexpected calls

- Confirm you have declared `EXPECT_CALL` for all expected mock method calls.
- Check argument matchers to ensure they match actual call arguments.
- Use `--gmock_verbose=info` to see detailed mock call trace.

### Warning: Uninteresting mock function call

- Occurs when method is called but no expectation is set.
- Use `NiceMock` to suppress warnings or add appropriate `EXPECT_CALL` with `Times(AnyNumber())`.

### Failure: Mock called more times than expected

- Verify the cardinalities with `.Times()` or via action count.
- Consider `.RetiresOnSaturation()` to retire saturated expectations.

### Confusion with call ordering

- Use `Sequence` objects or `.After()` clauses to enforce order.
- Verify no conflicting sequences or expectations.

---

## Example: Typical Expectation Setup

```cpp
#include <gmock/gmock.h>
using ::testing::AtLeast;
using ::testing::Return;
using ::testing::_;
using ::testing::Sequence;

class MockTurtle {
 public:
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(void, PenUp, (), ());
  MOCK_METHOD(int, GetX, (), (const));
};

TEST(DrawingTest, DrawsCircleWithCorrectCalls) {
  MockTurtle turtle;
  Sequence seq;

  ON_CALL(turtle, GetX()).WillByDefault(Return(0));

  EXPECT_CALL(turtle, PenDown())
      .InSequence(seq);
  EXPECT_CALL(turtle, GetX())
      .Times(AtLeast(1))
      .InSequence(seq)
      .WillRepeatedly(Return(10));
  EXPECT_CALL(turtle, PenUp())
      .InSequence(seq);

  // ... exercise code that uses turtle ...
}
```

This example sets up default `GetX()` value, expects calls to `PenDown()`, `GetX()`, and `PenUp()` in order, with `GetX()` expected multiple times returning 10.

---

## Related Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — for detailed recipes on using mocks
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — introductory guide
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — full macro and API reference
- [Setting Expectations](https://google.github.io/googletest/api/gmock/classtesting_1_1internal_1_1_typed_expectation.html) (internal class documentation)
- [Verification & Clearing Expectations](https://google.github.io/googletest/reference/mocking.html#VerifyAndClearExpectations) — techniques for verification

---

## Summary

Setting expectations is the core mechanism to instruct your mocks on what calls to expect, validate arguments, enforce call counts and order, and specify behaviors through actions. Use `EXPECT_CALL` to set expectations you want verified and use `ON_CALL` for defining default behaviors without imposing expectations. Chain modifiers like `.Times()`, `.With()`, `.InSequence()`, `.After()`, `.WillOnce()`, and `.RetiresOnSaturation()` to finely tune your mock's contract and behavior.

By mastering these, you can create robust, clear, and maintainable tests that precisely express interactions your code should have.
