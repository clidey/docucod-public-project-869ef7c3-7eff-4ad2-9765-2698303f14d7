---
title: "Declaring and Using Mocks"
description: "Explains the process of creating mock classes and functions using GoogleMock macros. Includes walkthroughs on MOCK_METHOD, setup strategies, and integrating mocks into test code."
---

# Declaring and Using Mocks

Explore how to create mock classes and mock methods effortlessly using GoogleMock macros. This guide walks you through the essential `MOCK_METHOD` macro, strategies for setting up mocks, and demonstrates how to integrate mocks seamlessly into your test code to verify interactions and behaviors.

---

## Overview of Mock Declaration

GoogleMock provides a declarative macro, `MOCK_METHOD`, that lets you quickly define mock methods in a mock class.

### Defining a Mock Class

To create a mock class:

1. Derive a class from the interface or class you want to mock.
2. In the `public:` section, declare mock methods using `MOCK_METHOD`.

Example:

```cpp
#include <gmock/gmock.h>  // Include GoogleMock

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

> **Best Practice:** Put `MOCK_METHOD` declarations in `public:` regardless of the original method's access level to ensure expectations can be set externally.

### MOCK_METHOD Syntax

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers...));
```

- `ReturnType`: The return type of the mocked method.
- `MethodName`: The method's name.
- `(Args...)`: Parenthesized list of argument types.
- `(Qualifiers...)`: Optional list of qualifiers like `const`, `override`, `noexcept`, calling convention (`Calltype`), and reference qualifiers (`ref(&)`).

### Dealing with Commas in Types

If your return type or arguments contain commas (like template types), wrap them in extra parentheses or use type aliases:

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
using MapType = std::map<int, double>;
MOCK_METHOD(bool, CheckMap, (MapType, bool));
```

### Mocking Overloaded or Const Methods

- Mock all overloaded variants explicitly to avoid hiding warnings.
- Use `const` qualifier in the fourth parameter when mocking `const` methods.

Example:

```cpp
MOCK_METHOD(int, Add, (int x), (override));
MOCK_METHOD(int, Add, (int times, int x), (override));
MOCK_METHOD(const Bar&, GetBar, (), (const, override));
```

### Mocking Class Templates

Mock class templates just like normal classes:

```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

### Mocking Non-Virtual Methods

GoogleMock supports mocking non-virtual methods in unrelated mock classes, useful for high-performance dependency injection:

```cpp
class ConcretePacketStream {
 public:
  void AppendPacket(Packet* new_packet);
  const Packet* GetPacket(size_t packet_number) const;
  size_t NumberOfPackets() const;
};

class MockPacketStream {
 public:
  MOCK_METHOD(const Packet*, GetPacket, (size_t packet_number), (const));
  MOCK_METHOD(size_t, NumberOfPackets, (), (const));
};
```

## Integrating Mocks into Tests

After declaring mock classes and methods, you can create mock objects and set expectations using `EXPECT_CALL` and specify behaviors with `ON_CALL`.

### Basic Usage Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown())
      .Times(AtLeast(1));

  Painter painter(&turtle);

  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

### Using Strictness Wrappers

GoogleMock provides *strictness modifiers* to control how uninteresting calls (calls without explicit expectations) are handled:

| Wrapper Type    | Behavior on Uninteresting Calls                | Usage Example                             |
| --------------- | ---------------------------------------------- | --------------------------------------- |
| `NiceMock<T>`   | Suppresses warnings on unexpected calls       | `NiceMock<MockFoo> nice_mock;`           |
| `NaggyMock<T>`  | Prints warnings on unexpected calls (default) | `NaggyMock<MockFoo> naggy_mock;`         |
| `StrictMock<T>` | Fails tests on unexpected calls                | `StrictMock<MockFoo> strict_mock;`       |

Example:

```cpp
using ::testing::NiceMock;

NiceMock<MockFoo> mock_foo;
EXPECT_CALL(mock_foo, DoSomething());
// No warning if other methods are called without expectation
```

> **Note:** Nesting strictness wrappers (e.g. `NiceMock<StrictMock<T>>`) is not supported.

### Setting Default Behaviors

Use `ON_CALL` to specify the default behavior of mock methods when no expectation matches.

```cpp
ON_CALL(mock_obj, Method(_))
    .WillByDefault(Return(default_value));
```

### Setting Expectations

Use `EXPECT_CALL` to define expectations with optional clauses:

```cpp
EXPECT_CALL(mock_obj, Method(arg_matchers...))
    .With(multi_arg_matcher)   // At most once
    .Times(cardinality)        // At most once
    .InSequence(sequences...)  // Any number of times
    .After(expectations...)    // Any number of times
    .WillOnce(action)          // Any number of times
    .WillRepeatedly(action)    // At most once
    .RetiresOnSaturation();    // At most once
```

Example:

```cpp
EXPECT_CALL(mock_foo, Compute(5))
    .Times(3)
    .WillRepeatedly(Return(42));
```

### Using Sequences to Specify Call Order

You can enforce strict or partial ordering of mock calls using `InSequence` or `Sequence` objects.

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, FirstCall()).InSequence(s1, s2);
EXPECT_CALL(mock, SecondCall()).InSequence(s1);
EXPECT_CALL(mock, ThirdCall()).InSequence(s2);
```

## Common Pitfalls and Tips

- Always declare mock methods as `virtual` (or use `MOCK_METHOD`) and public in your mock to allow GoogleMock to intercept calls.
- Use `EXPECT_CALL` before exercising the mock to avoid undefined behavior.
- Avoid nesting strictness wrappers as it is unsupported.
- Use `NiceMock` during development to suppress noisy warnings and `StrictMock` when you want strict validation.
- Wrap argument types with parentheses or use type aliases when commas appear inside types.
- Use `ON_CALL` for defining default behavior without setting expectations.
- To handle expectations with move-only types (e.g. `std::unique_ptr`), use lambdas or actions.

## Summary

This documentation focused exclusively on how to declare mock classes and methods using GoogleMock's `MOCK_METHOD` macro, the behavior of strictness modifiers (NiceMock, NaggyMock, StrictMock), and integrating mocks within your tests using `EXPECT_CALL` and `ON_CALL` macros. It outlines best practices and typical workflows for setting up mocks, specifying expectations, and controlling call sequences.

---

## Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Beginner-friendly guide covering mocks creation and usage.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Comprehensive recipes for mocking techniques.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — API reference including detailed clauses and types.
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) — Quick reference for mock usage.

<Accordion title="Related Documentation on This Topic">

### Mock Methods
`MOCK_METHOD` macro and its syntax

### Expectation and Default Behavior
`EXPECT_CALL` and `ON_CALL` macros usage, including clauses.

### Strictness Modes
Understanding `NiceMock`, `NaggyMock`, and `StrictMock` behavior and when to use them.

</Accordion>

<Accordion title="Best Practices and Common Pitfalls">

- Declare mock methods in `public:`
- Declare mock methods virtual
- Set expectations before exercising mocks
- Use strictness modifiers carefully
- Avoid over-specification of expectations

</Accordion>