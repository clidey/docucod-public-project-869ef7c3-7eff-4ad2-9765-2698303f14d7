---
title: "Portability and Platform Abstractions"
description: "Documents the core types, macros, and utilities available for ensuring portability across compilers and operating systems. Useful for advanced users customizing GoogleTest/GoogleMock to run on specialized hardware or embedded targets."
---

# Portability and Platform Abstractions

GoogleMock provides a foundation of core types, macros, and utilities to ensure your mocking code runs consistently across a wide variety of compilers and operating systems. This page documents those essential portability components aimed primarily at advanced users who want to customize GoogleMock or GoogleTest to work on specialized hardware, embedded environments, or otherwise non-standard platforms.

Whether you're adapting GoogleMock for a unique embedded target or customizing flags and platform detection, this documentation equips you with the tools, guidelines, and examples to do so effectively.

---

## Understanding the Role of Portability and Platform Abstractions

The goal of these abstractions is to insulate GoogleMock's core functionality from the quirks and inconsistencies that different build environments, compilers, and operating systems present. They:

- Detect platforms and compilers automatically
- Establish common fixed-width integer types
- Abstract threading and synchronization primitives
- Manage flags and environment variable integrations
- Provide macros to facilitate compatibility and deprecation warnings

This infrastructure empowers GoogleMock to maintain a stable API and predictable behavior across environments without burdening users with platform-specific details.

## Key Components

### Platform Detection

The platform detection macros identify the operating system you're compiling for, enabling platform-specific customizations or adaptations. These macros reflect a wide range of environments, including desktop OSs, embedded platforms, mobile, and specialized hardware.

Example platform macros include:

- `GTEST_OS_WINDOWS`, `GTEST_OS_LINUX`, `GTEST_OS_MAC`, `GTEST_OS_ANDROID`
- Embedded-specific macros like `GTEST_OS_ESP8266`, `GTEST_OS_ESP32`, `GTEST_OS_NRF52`, `GTEST_OS_XTENSA`, and `GTEST_OS_QURT`

These macros are automatically defined during compilation and should not be manually set. They allow conditional code paths for your target environment.

### Compiler and C++ Feature Verification

GoogleMock requires C++17 or later for compilation. The core macros detect compiler versions and capabilities, such as RTTI, exceptions, and standard attribute support, to adapt optimally.

For example:

- It errors out if compiling with MSVC earlier than Visual Studio 2015.
- Flags to indicate exception support: `GTEST_HAS_EXCEPTIONS`.
- Checks for thread safety and mutex availability.

These checks ensure you compile GoogleMock only in supported environments or help you diagnose compatibility issues early.

### Synchronization Primitives

GoogleMock's core relies on thread-safe primitives when threading is supported:

- `Mutex` and `MutexLock` provide locking wrappers compatible with pthreads or Windows synchronization APIs.
- `ThreadLocal<T>` supports thread-local variables with platform-specific implementations.

If threading is not available, dummy no-op implementations exist to facilitate compilation at the cost of thread safety.

### Command Line Flags and Environment Variables

Flags in GoogleMock for runtime configuration use macros that support both Abseil flags and GoogleTest’s native flag system. This flexibility allows easy integration into various ecosystems.

Macros for defining, declaring, getting, and setting flags exist, such as:

- `GMOCK_DEFINE_bool_(name, default_val, doc)`
- `GMOCK_DECLARE_bool_(name)`
- `GMOCK_FLAG_GET(name)`
- `GMOCK_FLAG_SET(name, value)`

The prefixing scheme with `gmock_` ensures that your flags do not clash with other systems.

### Utilities for Platform-Agnostic Operations

Utilities dealing with common cross-platform variations are available:

- File system access wrappers: abstract differences between Windows and POSIX file functions.
- Character utilities: safe wrappers around `isspace`, `isdigit`, etc., accommodating signedness.
- Logging macros and utilities ensure uniform logging across platforms.

### Macros for Compiler Attributes and Deprecation

To facilitate modern C++ usage and transitions, macros wrap attributes for things like deprecation:

- `GMOCK_DEPRECATE_AND_INLINE()` marks functions as deprecated and inline, if supported by the compiler and Abseil is available.

These macros help maintainers mark problematic or transitional APIs with minimal impact to users.

## Using Portability APIs: A Workflow Perspective

Consider you are customizing GoogleMock to run tests on a new embedded target that has limited standard library support and no threading.

1. **Ensure Platform Macro Detection:**
   Confirm your compiler defines a platform macro (e.g., `GTEST_OS_ESP32`). If not, extend the detection in `gtest-port-arch.h`.

2. **Adjust Threading Support:**
   You may disable `GTEST_IS_THREADSAFE` or `GTEST_HAS_PTHREAD` as appropriate. This disables threading primitives.

3. **Define Custom Flags:**
   Use `GMOCK_DEFINE_bool_()` in your custom port header to declare GoogleMock flags tailored for your environment.

4. **Manage File I/O and Logging:**
   Override platform-specific operations via `posix` namespace wrappers or custom replacements.

5. **Compile and Test:**
   Build your GoogleMock with these adaptations and verify basic mock behavior.

## Practical Tips and Best Practices

- **Do not use internal macros ending with underscores directly.** They are internal and subject to change without notice.
- Prefer GoogleMock flag macros for defining and referencing flags to reduce platform-specific issues.
- If you extend platform detection, add only what is absolutely necessary and consider contributing back.
- Always verify thread-safe capabilities on your platform to prevent subtle concurrency bugs.

## Common Pitfalls and Troubleshooting

- **Compilation Errors on Unsupported Platforms:** Check that your platform macro is correctly defined and that C++17 support is enabled.
- **Flag Name Collisions:** Always prefix flags with `gmock_` using the macros provided.
- **Threading Issues:** If running on a single-threaded or embedded system, disable threading support via build flags to avoid linking errors.
- **Deprecation Warnings:** Use the provided macros and ensure Abseil support is enabled to manage deprecated symbols correctly.

## Code Snippet: Defining a GoogleMock Flag

```cpp
// Define a boolean flag 'verbose' with default false and documentation.
GMOCK_DEFINE_bool_(verbose, false, "Enable verbose output from GoogleMock");

// Somewhere in the test code to read the flag:
if (GMOCK_FLAG_GET(verbose)) {
  std::cout << "Verbose mode enabled" << std::endl;
}

// To set the flag at runtime in code:
GMOCK_FLAG_SET(verbose, true);
```

## Code Snippet: Checking Platform in Custom Code

```cpp
#ifdef GTEST_OS_ESP32
// ESP32-specific code here
#endif

#ifdef GTEST_OS_WINDOWS
// Windows-specific adaptation
#endif
```

## Recommended Reading and Related Documentation

- [GoogleMock README](../googlemock/README.md) - For an overview and getting started with mocking.
- [gtest-port.h](../googletest/include/gtest/internal/gtest-port.h) - For core backend platform and threading support used by GoogleMock.
- [Supported Platforms](../docs/platforms.md) - Compatible OSes and compilers summary for GoogleTest and GoogleMock.
- [Customization Points](../googlemock/include/gmock/internal/custom/README.md) - For the recommended way to introduce custom platform adaptations and macros.

---

## Summary

This page equips advanced users with the knowledge to navigate GoogleMock’s portability layers, facilitating effective cross-platform support and customization. It covers platform detection macros, threading abstractions, flag handling mechanisms, and utilities essential for making GoogleMock run consistently across diverse and specialized environments.

By understanding and leveraging these abstractions, you can confidently extend or tweak GoogleMock in embedded or non-standard toolchains while keeping your tests robust and portable.


---

## Diagram: Platform Detection Macro Hierarchy

```mermaid
graph TD
  GTEST_OS{"""Platform Detection Macros""" ]

  GTEST_OS --> WINDOWS[GTEST_OS_WINDOWS]
  GTEST_OS --> LINUX[GTEST_OS_LINUX]
  GTEST_OS --> MAC[GTEST_OS_MAC]
  GTEST_OS --> ANDROID[GTEST_OS_LINUX_ANDROID]
  GTEST_OS --> ESP32[GTEST_OS_ESP32]
  GTEST_OS --> ESP8266[GTEST_OS_ESP8266]
  GTEST_OS --> NXP_QN9090[GTEST_OS_NXP_QN9090]
  GTEST_OS --> QURT[GTEST_OS_QURT]
  GTEST_OS --> NRF52[GTEST_OS_NRF52]

  WINDOWS --> WINDOWS_MOBILE[GTEST_OS_WINDOWS_MOBILE]
  WINDOWS --> WINDOWS_DESKTOP[GTEST_OS_WINDOWS_DESKTOP]
  WINDOWS --> WINDOWS_PHONE[GTEST_OS_WINDOWS_PHONE]

  LINUX --> LINUX_ANDROID[GTEST_OS_LINUX_ANDROID]

  MAC --> IOS[GTEST_OS_IOS]

  %% Style
  classDef platform fill:#D2E8FF,stroke:#369;color:#003366,font-weight:bold;
  class GTEST_OS,WINDOWS,LINUX,MAC,ANDROID,ESP32,ESP8266,NXP_QN9090,QURT,NRF52 platform;
```


---

## Additional Resources

- [GoogleTest Primer](../../docs/primer.md) – For foundational knowledge on testing with GoogleTest.
- [Cross-Platform and Environment Considerations Guide](../../guides/integration-scenarios/cross-platform-considerations.md) – For practical advice on using GoogleTest and GoogleMock across platforms.

For detailed customization instructions, refer to `googlemock/include/gmock/internal/custom/gmock-port.h` and the Customization Points README.

---

*This documentation is based on the current state of the GoogleMock internal porting headers and related platform abstractions as of the latest stable release.*