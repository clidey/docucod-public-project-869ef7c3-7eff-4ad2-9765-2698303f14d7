---
title: "Mock Classes and Methods"
description: "Covers how to define and use mock classes, declare mock methods, and utilize the core macros for controlling mock behavior. Walks through `MOCK_METHOD`, method specifiers, ON_CALL and EXPECT_CALL usage, and best practices for structuring mocks."
---

# Mock Classes and Methods

This page explains how to define and use mock classes in GoogleTest with GoogleMock. It details the usage of the `MOCK_METHOD` macro to declare mock methods, shows how to control mock behavior using expectation macros `ON_CALL` and `EXPECT_CALL`, and guides you through method specifiers and best practices for structuring mocks effectively.

---

## Defining Mock Classes

Mock classes in GoogleMock are ordinary C++ classes that provide mock implementations of an interface or class you want to test against. The cornerstone of this process is the `MOCK_METHOD` macro, which automatically generates mock methods matching the signature of your original interface.

### Using `MOCK_METHOD`

The simplified syntax to declare a mock method is:

```cpp
class MyMock {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...));
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
};
```

- **ReturnType**: The method's return type.
- **MethodName**: The method's name.
- **Args...**: Comma-separated argument types enclosed in parentheses.
- **Specs...** (optional): A comma-separated list of method specifiers such as `const`, `override`, `noexcept`, calling conventions (`Calltype(...)`), or reference qualifiers (`ref(&)`, `ref(&&)`).

#### Important Notes on `MOCK_METHOD`

- Always put `MOCK_METHOD` definition in the `public:` section of your mock class for accessibility by the macros `ON_CALL` and `EXPECT_CALL`.
- When mocking virtual methods with `const` qualifiers or overrides, specify them in the specifiers, e.g., `(const, override)`.

```cpp
MOCK_METHOD(int, GetValue, (), (const, override));
```

- Mocking overloaded methods requires specifying the correct argument types in parentheses to disambiguate the overload.

```cpp
MOCK_METHOD(int, Add, (int x), (override));
MOCK_METHOD(int, Add, (int times, Element x), (override));
```

- Handling types with commas (e.g., `std::pair<int, int>`) requires either parenthesizing the return type or providing a type alias to avoid parsing issues.

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());  // Parenthesized return type
// or
using BoolIntPair = std::pair<bool, int>;
MOCK_METHOD(BoolIntPair, GetPair, ());
```

- You can mock class templates as usual by templating your mock class and mocking each method appropriately.


### Mocking Private and Protected Methods

You must declare all mock methods as `public` in your mock class, regardless of the original method's accessibility in the base class. C++ permits changing access level in derived classes.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(bool, Transform, (Gadget* g), (override));
  MOCK_METHOD(void, Resume, (), (override));  // Was protected
  MOCK_METHOD(int, GetTimeOut, (), (override));  // Was private
};
```

### Mocking Non-virtual Methods

You can mock non-virtual methods by defining mock classes unrelated to the original class but mimicking its method signatures. This pattern supports high-performance dependency injection.

```cpp
class MockPacketStream {
 public:
  MOCK_METHOD(const Packet*, GetPacket, (size_t packet_number), (const));
  MOCK_METHOD(size_t, NumberOfPackets, (), (const));
};
```

Use template arguments to switch between production and test implementations.

---

## Controlling Mock Behavior

GoogleMock provides two core macros to control mock method behavior:

- `ON_CALL(mock_obj, Method(args))`: Sets the default action for calls that don't have an explicit expectation. Does *not* establish an expectation that the method will be called.
- `EXPECT_CALL(mock_obj, Method(args))`: Sets an expectation that the method will be called with arguments matching the provided matchers. Also specifies the behavior for those calls.

### Using `ON_CALL`

Syntax:

```cpp
ON_CALL(mock_object, Method(args...))
    .With(multi_argument_matcher)   // Optional
    .WillByDefault(action);
```

- The `.With()` clause allows you to specify a matcher that combines all the arguments as a tuple, applying constraints on the arguments collectively.
- The `.WillByDefault()` clause is mandatory and specifies the default action for matching calls.

**Example:**

```cpp
ON_CALL(foo, Calculate(_))
    .WillByDefault(Return(42));
```

This means whenever `foo.Calculate()` is called with any argument (wildcard `_`), it returns `42` by default, unless overridden by `EXPECT_CALL`.

### Using `EXPECT_CALL`

Syntax:

```cpp
EXPECT_CALL(mock_object, Method(args...))
    .With(multi_argument_matcher)   // Optional
    .Times(cardinality)             // Optional
    .InSequence(sequences...)       // Optional
    .After(expectations...)         // Optional
    .WillOnce(action)               // Optional, can appear multiple times
    .WillRepeatedly(action)         // Optional
    .RetiresOnSaturation();         // Optional
```

- Sets an expectation that the method will be called with matching arguments.
- Supports chaining of clauses to express call cardinality, ordering, timing, and behavior.

#### Key Clauses

- **With**: Restricts expectation to calls whose full argument tuple matches.
- **Times**: Number of times the call is expected. Can be exact (`Exactly(n)`), ranges (`Between(m,n)`), or open-ended (`AnyNumber()`, `AtLeast(n)`).
- **InSequence**: Specifies the expected order of calls among sequences.
- **After**: Call must happen only after certain other expectations are satisfied.
- **WillOnce**: Action performed on the first N matched calls.
- **WillRepeatedly**: Action for all subsequent matched calls after `WillOnce`s are exhausted.
- **RetiresOnSaturation**: Expectation deactivates after being fully satisfied.

**Example:**

```cpp
EXPECT_CALL(foo, GetSize())
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillOnce(Return(30));
```

This expects `foo.GetSize()` to be called exactly 3 times, returning 10, 20, and 30 in order.

---

## Using Matchers

Matchers specify constraints on method arguments when setting expectations or default behaviors. The simplest matcher `_` accepts any value, making arguments unconstrained. More specific matchers come from GoogleMock's matcher library or user-defined ones.

```cpp
EXPECT_CALL(foo, Process(Ge(5), NotNull()));
```

describes that the first argument must be greater than or equal to 5 and the second argument must not be null.

## Mock Class Structure Best Practices

- Place all mock methods in the `public:` section.
- Mock all virtual (or non-virtual if needed) methods you want to control or observe.
- Use `MOCK_METHOD` to define each method, mirroring the original method's signature as closely as possible.
- For overloaded methods, mock all relevant variants or use `using` declarations to bring base overloads into scope.
- When dealing with move-only types in method parameters or return types, use the modern `MOCK_METHOD` syntax which supports them out-of-the-box.

## Delegating Calls

You can delegate calls from a mock method to another implementation (fake, real, or parent class) by using `ON_CALL` with `.WillByDefault(Invoke(...))`. This pattern helps reuse existing behavior while verifying interactions.

```cpp
ON_CALL(mock, Foo).WillByDefault([this](int n) { return fake_.Foo(n); });
```

## Mocking `std::function` Types

GoogleMock provides the `MockFunction` template to mock `std::function` objects conveniently. It defines one mock method named `Call` matching the signature:

```cpp
MockFunction<R(Args...)> mock;
EXPECT_CALL(mock, Call(args...))...;
auto func = mock.AsStdFunction();
```

This is useful to verify interactions with callback interfaces.

## Managing Mock Strictness

Mock objects can generate warnings or errors on uninteresting calls (calls to methods without expectations) via wrappers:

- `NiceMock<T>`: suppresses warnings on uninteresting calls.
- `NaggyMock<T>`: default behavior, prints warnings on uninteresting calls.
- `StrictMock<T>`: treats uninteresting calls as errors.

These wrappers inherit constructors of `T` and work as subclasses, allowing seamless substitution.

```cpp
NiceMock<MockFoo> nice_mock;
StrictMock<MockFoo> strict_mock;
```

## Verifying and Resetting Mocks

All expectations are automatically verified when mock objects are destroyed. To verify explicitly:

```cpp
Mock::VerifyAndClearExpectations(&mock_obj);  // Verify only
Mock::VerifyAndClear(&mock_obj);              // Verify and reset
```

You can allow a mock to leak, skipping verification, with

```cpp
Mock::AllowLeak(&mock_obj);
```

## Common Pitfalls and Tips

- Always set expectations before the mock method is invoked, or behavior is undefined.
- Use `ON_CALL` for default behavior and `EXPECT_CALL` to verify interactions.
- Avoid over-specifying expectations to keep tests robust and maintainable.
- Use sequences (`InSequence`) or explicit ordering (`After`) for ordering constraints.
- When mocking overloaded methods, specify all overloads you want to mock or bring base versions in scope with `using`.
- Prefer `NiceMock` to suppress excessive warnings during development and switch to `StrictMock` to enforce stricter expectations.

---

## Summary

This documentation page has covered:

- How to define mock classes using `MOCK_METHOD`.
- The syntax and best practices for declaring mock methods, including method specifiers.
- How to control mock behavior using `ON_CALL` and `EXPECT_CALL`, including the use of modifier clauses like `.With()`, `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()`.
- Using `MockFunction` to mock `std::function`-style callable interfaces.
- Managing mock object strictness with `NiceMock`, `NaggyMock` (default), and `StrictMock`.
- Verification and lifecycle management of mocks.

For a smoother experience, refer to the [gMock Cookbook](docs/gmock_cook_book.md) for recipes and advanced usage patterns, and the [Mocking Reference](docs/reference/mocking.md) for concise API details. To understand how mocking fits into the broader GoogleTest framework, see [Test Definition and Execution](api-reference/core-testing-apis/test-definition-and-execution) and [Assertions and Results](api-reference/core-testing-apis/assertions-and-results).

<AccordionGroup title="Quick Links">
<Accordion title="gMock Cookbook (Recipes & Patterns)">
https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md
</Accordion>
<Accordion title="Mocking Reference (API Summary)">
https://github.com/google/googletest/blob/main/docs/reference/mocking.md
</Accordion>
<Accordion title="Core Testing APIs">
- Test Definition and Execution: /api-reference/core-testing-apis/test-definition-and-execution
- Assertions and Results: /api-reference/core-testing-apis/assertions-and-results
</Accordion>
<Accordion title="GoogleMock GitHub Repository">
https://github.com/google/googletest/tree/main/googlemock
</Accordion>
</AccordionGroup>

<Tip>
Use `ON_CALL` for defining default behaviors without expectation enforcement, and `EXPECT_CALL` when you want to verify the call occurs. Choose appropriate mock strictness wrappers to balance warning verbosity with test robustness.
</Tip>

