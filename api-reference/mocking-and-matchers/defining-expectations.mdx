---
title: "Defining Expectations (ON_CALL & EXPECT_CALL)"
description: "Documents the process of setting up expectations for mock objects, detailing how ON_CALL and EXPECT_CALL are used to specify call counts, argument constraints, return values, and call order. Covers enforcement and diagnostic capabilities for robust test behavior."
---

# Defining Expectations with ON_CALL and EXPECT_CALL

GoogleMock lets you precisely control how your mock objects behave and how they are expected to be used. This section breaks down how to define expectations on mock methods using the `ON_CALL` and `EXPECT_CALL` macros. Together, they let you specify:

- The default behavior of mocks
- Specific expectations on method calls, including how many times they should be invoked
- Argument constraints
- Returned values or actions
- Call order dependency

By mastering these macros, you ensure your tests validate the interactions of components with high confidence, and produce clear diagnostics when expectations are not met.

---

## Overview of ON_CALL and EXPECT_CALL

### ON_CALL: Setting Default Behaviors

`ON_CALL` configures the behavior of a mock method when it is invoked during tests. It sets up a "default action" that applies whenever the mock method is called and no more specific expectation applies.

- **Use case:** Provide fallback behavior so your mock won't fail unexpectedly if a call occurs outside your explicit `EXPECT_CALL` definitions.
- **Behavior:** Does *not* enforce how many times or if the function is called. Merely defines what should happen when it *is* called.
- **Example:** Returning a canned value or calling a real implementation.

```cpp
ON_CALL(mock_object, MethodName(_))
    .WillByDefault(Return(42));
```

### EXPECT_CALL: Defining Precise Expectations

`EXPECT_CALL` defines how many times you expect a particular method to be called, with what arguments, and what it returns or does when called.

- **Enforces:** Call count constraints (exactly, at least, at most, any number of times).
- **Allows:** Argument matchers to filter calls.
- **Trigger:** If the expectation is not satisfied, test fails.
- **Supports:** Chaining actions like `WillOnce()`, `WillRepeatedly()`.

```cpp
EXPECT_CALL(mock_object, MethodName(Eq(5)))
    .Times(1)
    .WillOnce(Return(10));
```

---

## Setting Call Counts and Argument Constraints

### Call Count Specifiers

You control expected call counts with the following `Times()` modifiers in `EXPECT_CALL`:

- `Times(1)` &mdash; Exactly once
- `Times(AtLeast(n))` &mdash; At least *n* times
- `Times(AtMost(n))` &mdash; At most *n* times
- `Times(AnyNumber())` or no `Times()` &mdash; Any number (including zero)

### Argument Matchers

Control which calls an expectation applies to, by specifying matchers for method arguments:

- Use predefined matchers like `_` (match any), `Eq(value)`, `Lt(value)`, `Ne(value)` etc.
- Combine with `AllOf()`, `AnyOf()`, `Not()` for complex conditions.
- Example:

```cpp
EXPECT_CALL(mock_obj, DoSomething(AllOf(Gt(0), Lt(5))))
    .Times(3);
```

---

## Configuring Return Values and Actions

GoogleMock lets you define actions that execute when the mock method is called:

### ON_CALL Actions

`ON_CALL(mock, Method(args)).WillByDefault(action)` sets the fallback action.

```cpp
ON_CALL(mock, GetValue()).WillByDefault(Return(42));
```

### EXPECT_CALL Actions

Use `WillOnce()` and `WillRepeatedly()` for fine control over sequences of calls.

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

This makes:

- first call return 1
- second call return 2
- any subsequent calls return 3

### Common Actions

- `Return(value)` &mdash; returns a value
- `Invoke(function)` &mdash; calls a user function or lambda
- `Throw(exception)` &mdash; throws an exception
- `SaveArg<index>(&var)` &mdash; saves argument value for later inspection
- `SetArgReferee<index>(value)` &mdash; modifies referenced argument

---

## Managing Call Order and Sequences

You can enforce order constraints on expected calls:

- Use the `Sequence` class to create a sequence object.
- Associate expectations via `.InSequence(&seq)` call.
- The mock calls must occur in the order defined.

Example:

```cpp
Sequence s1;

EXPECT_CALL(mock, FirstCall()).InSequence(&s1);
EXPECT_CALL(mock, SecondCall()).InSequence(&s1);
```

More complex control is possible with multiple sequences and combining sequences with `After()` or `Between()` constraints available in advanced GoogleMock workflows.

---

## Diagnostic Behavior and Enforcement

- **Failure on unmet expectations:** If an expected call does not occur, or occurs too many times, the test fails with detailed diagnostics.

- **Ambiguous matches:** If multiple expectations could match a call, the most recently specified applicable one is chosen, helping you control specificity.

- **Default behavior:** If no matching expectation or `ON_CALL` handler exists, mock methods produce default values or call real methods when allowed.

- **Helpful error messages:** GoogleMock prints the function name, expected vs actual call counts, and argument values to simplify debugging.

---

## Practical Examples

### Example 1: Simple ON_CALL

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), ());
};

MockFoo mock;
ON_CALL(mock, GetValue()).WillByDefault(Return(10));

EXPECT_EQ(mock.GetValue(), 10);  // uses ON_CALL default
```

### Example 2: EXPECT_CALL with argument constraint and call count

```cpp
class MockBar {
 public:
  MOCK_METHOD(void, Process, (int), ());
};

MockBar mock;
EXPECT_CALL(mock, Process(Gt(0))).Times(2);

mock.Process(1);  // counts towards expectation
mock.Process(2);  // counts towards expectation
mock.Process(0);  // ignored, does not match argument matcher
```

### Example 3: Sequenced EXPECT_CALL

```cpp
class MockBaz {
 public:
  MOCK_METHOD(void, Step, (int), ());
};

Sequence seq;
MockBaz mock;
EXPECT_CALL(mock, Step(1)).InSequence(&seq);
EXPECT_CALL(mock, Step(2)).InSequence(&seq);

mock.Step(1);  // OK
mock.Step(2);  // OK

// If Step(2) was called before Step(1), test fails due to sequence violation.
```

---

## Best Practices

- Use `ON_CALL` to define default behavior especially if the mock method is expected to be called multiple times without strict expectations.
- Use `EXPECT_CALL` to specify precise expectations critical to your testâ€™s correctness.
- Use argument matchers to focus expectations only on relevant calls.
- Avoid overconstraining call counts unless necessary; this reduces brittle tests.
- Use sequences sparingly to enforce necessary order but avoid making tests overly rigid.
- Provide custom actions with `WillOnce` and `WillRepeatedly` to simulate different responses realistically.
- When you want to ignore calls, use `.Times(AnyNumber())` or omit `EXPECT_CALL` but ensure an `ON_CALL` fallback is present.

---

## Troubleshooting Common Issues

### 1. Unexpected Call Failures

- Check if the arguments exactly match the expectation or matcher.
- Verify if the call is made before or after the expected sequence order.
- Ensure your `ON_CALL` provides a fallback action to avoid default fail behavior.

### 2. Duplicate or Conflicting EXPECT_CALL

- Multiple overlapping expectations can confuse GoogleMock.
- Limit expectations on the same mock method with compatible matchers.

### 3. Test Fails Due to Missing Expected Calls

- Verify that test paths exercise the calls.
- Adjust call counts to allow flexibility if the precise number of calls is nondeterministic.

### 4. Using Raw Pointers in Parameters

- Manage pointer lifetime carefully.
- Use smart pointers or custom actions to ensure no dangling references occur.

---

## Summary

Setting expectations using `ON_CALL` and `EXPECT_CALL` provides powerful control over mock object behavior and interactions. Use `ON_CALL` for defaults and `EXPECT_CALL` for strict requirements, combining call counts, argument matchers, actions, and call ordering to create precise, readable, and maintainable tests.

For deeper understanding, refer to the [GoogleMock Cookbook](https://github.com/google/googletest/blob/main/googlemock/docs/cook_book.md), the [Mocking Best Practices Guide](/guides/core-workflows/mocking-best-practices.md), and core GoogleTest documentation on [Parameterized Tests](../advanced.md#value-parameterized-tests).
