---
title: "Death Tests"
description: "Documents APIs and usage patterns for death tests, which validate that code fails or terminates in expected ways. Includes supported macros, output capturing, and platform considerations."
---

# Death Tests

Death tests in GoogleTest are specialized tests that validate whether code terminates as expected, typically to confirm that critical error handling and fatal assertions cause program termination. This page documents the APIs and usage patterns necessary to write effective death tests, explains how to capture their output, and discusses platform-specific considerations and best practices.

---

## What Are Death Tests?

Death tests verify that a piece of code causes the program to terminate or exit in a defined and expected way. This is crucial for testing assertions or fatal error handlers designed to halt execution when a program enters an inconsistent or unrecoverable state.

Unlike exception assertions, death tests confirm actual process termination (not just throwing exceptions). They ensure your program reacts safely to error conditions and corner cases by terminating immediately, preventing further damage or undefined behavior.

## Key Concepts

- **Death Test**: A test macro invocation that runs a statement expected to terminate the process.
- **Child Process Execution**: On POSIX and Windows, death tests run the statement in a separate child process.
- **Exit Status and Output Matching**: The test verifies that the child process exits with an expected exit code or signal and that its error output matches a specified pattern.
- **Death Test Styles**: Fast and Threadsafe styles define how child processes are launched.

## Supported Macros and Usage Patterns

GoogleTest provides a rich set of macros to perform death testing:

### Basic Macros

- **`ASSERT_DEATH(statement, matcher)`**

  Asserts that `statement` causes process termination with a non-zero exit status, and the error output matches `matcher`. The test aborts the calling function on failure.

- **`EXPECT_DEATH(statement, matcher)`**

  Similar to `ASSERT_DEATH` but records a nonfatal failure and continues execution.

### Exit Code Verification

- **`ASSERT_EXIT(statement, predicate, matcher)`**

  Asserts that `statement` causes process exit with an exit status satisfying `predicate` and stderr output matching `matcher`.

- **`EXPECT_EXIT(statement, predicate, matcher)`**

  Like `ASSERT_EXIT`, but nonfatal.

Example predicates provided include:

```cpp
// Checks if program exited with a specific code.
::testing::ExitedWithCode(exit_code);

// Checks if program was terminated by a specific signal (POSIX only).
::testing::KilledBySignal(signal_number);
```

### Debug Builds

- **`EXPECT_DEBUG_DEATH(statement, matcher)`**

  Runs the death test only in debug builds (when `NDEBUG` is not defined). In optimized builds, it executes `statement` normally without asserting.

### Death Test Conditional Support

- **`EXPECT_DEATH_IF_SUPPORTED(statement, matcher)`**

  Executes only if death tests are supported on the platform; otherwise, it compiles to a no-op with a warning.

### Example Usage

```cpp
TEST(MyDeathTest, AbortOnInvalidInput) {
  ASSERT_DEATH({ SomeFunction(-1); }, "Invalid input detected");
}

TEST(MyDeathTest, ExitWithSuccessMessage) {
  EXPECT_EXIT(NormalExit(), ::testing::ExitedWithCode(0), "Success");
}
```

## How Death Tests Work Internally

1. **Child Process Creation**: Depending on platform and death test style, GoogleTest forks or clones the test binary.
2. **Execution**: The child runs the specified death test statement.
3. **Communication**: The child and parent communicate through pipes to report outcomes.
4. **Validation**: The parent verifies:
   - The child terminated (did not return or throw an exception).
   - The exit code or signal matches the expected predicate.
   - The captured stderr output matches the expected pattern.

If any check fails, the death test fails.

## Death Test Styles

GoogleTest offers two death test styles, configurable via the `--gtest_death_test_style` flag:

- **`fast` (default on some platforms)**: Forks and executes the death test immediately in the child process.
- **`threadsafe` (recommended)**: Creates a new child process by re-executing the entire test binary with special flags to isolate the specific death test; safer in multi-threaded environments but slower.

Example to set style programmatically:

```cpp
GTEST_FLAG_SET(death_test_style, "threadsafe");
```

## Capturing Output

Death tests capture all `stderr` output generated by the child process during test execution. The output is checked against a string matcher or regular expression to verify that the expected error message was produced.

GoogleTest supports a simplified subset of regular expressions for matching — see [Regular Expression Syntax](https://github.com/google/googletest/blob/main/docs/advanced.md#regular-expression-syntax) for supported patterns.

## Writing Effective Death Tests

Follow these guidelines for reliable and maintainable death tests:

- **Use Compound Statements**: Death test macros accept any C++ statement, including blocks. Use `{ ... }` for multiple lines.

  ```cpp
  ASSERT_DEATH({
    Initialize();
    DoSomething();
  }, "expected error");
  ```

- **Avoid Side Effects Expecting to Persist**: Since the death test runs in a child process, in-memory side effects do not propagate back.

- **Do Not Use Assertions that Return from Functions in Death Statements**: Avoid `return` or exception-throwing statements inside death test blocks, as they cause test failure.

- **Name Death Test Suites with `*DeathTest` Suffix**: This convention improves test ordering and warning clarity.

- **Handle Mocks Carefully**: When expecting specific exit codes in death tests involving mocks, use `Mock::AllowLeak` to avoid mock leak detector conflicts.

## Platform Considerations

- **POSIX (Linux, macOS, etc.)**: Uses `fork()` or `clone()` to spawn processes. Threadsafe style uses `exec` to re-execute the test binary with isolation.

- **Windows**: Uses `CreateProcess()` to spawn a new process running only the death test.

- **Fuchsia**: Uses platform-specific spawn and process management.

- **Shared Limitations**:
  - Death tests require the test binary to be invoked with a path containing a directory separator, to enable re-execution.
  - Regular expressions are limited on non-POSIX platforms.

## Common Pitfalls and Troubleshooting

- **Multiple Death Tests per Line**: Placing more than one death test on the same line causes compilation errors.

- **Threading Issues**: Running multiple threads during death test setup or execution can cause hangs or warnings. Use the `threadsafe` style where possible.

- **Memory Deallocation**: Freeing memory inside a death test child can trigger false positives in memory checkers since the parent doesn’t observe reclaiming.

- **Expecting Specific Exit Codes**: Always supply a predicate, e.g., `ExitedWithCode` to precisely check exit status.

## Practical Example

```cpp
#include <gtest/gtest.h>

void CauseFatalError() {
  if (true) {
    fprintf(stderr, "Fatal error occurred\n");
    _Exit(1);
  }
}

TEST(FooDeathTest, CausesFatalError) {
  ASSERT_DEATH(CauseFatalError(), "Fatal error");
}

TEST(FooDeathTest, ExitSuccess) {
  EXPECT_EXIT(_Exit(0), testing::ExitedWithCode(0), "");
}
```

## Related Macros and Predicates

- **Predicates for `ASSERT_EXIT` / `EXPECT_EXIT`**
  - `testing::ExitedWithCode(code)` — expects normal exit with code.
  - `testing::KilledBySignal(signal)` — expects termination by signal (POSIX).

- **Debug Only Macros**
  - `EXPECT_DEBUG_DEATH` and `ASSERT_DEBUG_DEATH` macro variants for debug-only assertions.

- **Conditional Macros**
  - `EXPECT_DEATH_IF_SUPPORTED` / `ASSERT_DEATH_IF_SUPPORTED` guard death tests on unsupported platforms.

## Additional References and Next Steps

| Documentation                                             | Purpose                                      |
|-----------------------------------------------------------|----------------------------------------------|
| [Assertions Reference](../core-testing-apis/assertions.md) | Details on death and other assertion macros  |
| [Advanced GoogleTest Topics](advanced.md#death-tests)      | Deeper insights about death tests, styles, and platform details |
| [Death Tests for Error Handling Guide](../solutions-and-patterns/death-tests.mdx) | User guide on writing effective death tests |

For troubleshooting setup or integration of death tests, consult the Getting Started and Advanced topics sections.

---

_Last updated in branch `main`._

<Info>
For source code and internal details of death test implementation, see `googletest/include/gtest/gtest-death-test.h` and `googletest/src/gtest-death-test.cc`.
</Info>
