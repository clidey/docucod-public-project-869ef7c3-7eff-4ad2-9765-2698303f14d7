---
title: "Expectations and Actions"
description: "Documents the mechanisms for specifying expected calls, argument matching, and controlling return values or side effects using ON_CALL and EXPECT_CALL macros. Details advanced actions such as WillOnce, WillRepeatedly, and use of custom actions."
---

# Expectations and Actions

This page documents how to specify **expected calls**, match arguments, and control the behavior of mock methods in GoogleMock using the **`ON_CALL`** and **`EXPECT_CALL`** macros. It covers setting default behaviors, defining expectations, and orchestrating advanced actions such as `WillOnce`, `WillRepeatedly`, and custom user-defined actions.

---

## Overview

Mock objects in GoogleMock have two complementary ways to define their behavior:

- **`ON_CALL`** defines the *default action* for a mock method when it is called, without enforcing any expectation that the method *must* be called.
- **`EXPECT_CALL`** sets an *expectation* that a mock method will be called one or more times with specified arguments, while also defining its behavior.

By distinguishing these two, GoogleMock encourages designing tests that verify only the essential interactions, minimizing brittle or over-constraining tests.


## 1. Specifying Default Actions With `ON_CALL`

The `ON_CALL` macro lets you describe what should happen *by default* when a mock method matching certain arguments is called, without requiring that the method must be called. This is useful to set up a test fixture where the mock behaves a certain way unless overridden by more specific expectations.

### Syntax

```cpp
ON_CALL(mock_object, Method(arg_matchers...))
    [.With(multi_arg_matcher)]
    .WillByDefault(action);
```

- `.With()` is optional and restricts the default action to only calls matching the multi-argument matcher.
- `.WillByDefault()` **must** be specified exactly once and defines the default action.

### Example

```cpp
using ::testing::Return;

ON_CALL(mock, GetValue(_))
    .WillByDefault(Return(42));
```

This sets the default return value of `GetValue()` to 42 for any argument.

### Notes

- Default actions set by `ON_CALL` do not impose any requirement that the method actually be called.
- Multiple `ON_CALL` statements can be provided; the last matching one has precedence.
- Using `ON_CALL` is encouraged to set up common behavior and keep tests resilient.

## 2. Setting Expectations With `EXPECT_CALL`

`EXPECT_CALL` specifies that a mock method *must* be called with arguments matching certain matchers, one or more times, and describes what action should be taken upon these calls.

### Syntax

```cpp
EXPECT_CALL(mock_object, Method(arg_matchers...))
    [.With(multi_arg_matchers)]
    [.Times(cardinality)]
    [.InSequence(sequences...)]
    [.After(expectations...)]
    [.WillOnce(action)]...
    [.WillRepeatedly(action)]
    [.RetiresOnSaturation()];
```

All clauses are optional except the method name and matchers, except `.WillRepeatedly()` can appear at most once.

#### Clause summary:

- `.With(multi_arg_matchers)`: Additional matcher on whole argument tuples. Must be the first clause if present.
- `.Times(cardinality)`: Specifies how many calls are expected. Default inferred from actions.
- `.InSequence(sequences...)`: Specifies call order sequences.
- `.After(expectations...)`: Partial order specification; call only after given expectations satisfied.
- `.WillOnce(action)`: Behavior for a single call; can appear multiple times for different calls.
- `.WillRepeatedly(action)`: Behavior for all subsequent calls after `WillOnce`s.
- `.RetiresOnSaturation()`: Retire expectation once calls have reached upper bound.

### Example

```cpp
using ::testing::Return;
using ::testing::AtLeast;

EXPECT_CALL(mock, GetNumber())
    .Times(3)
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));

EXPECT_CALL(mock, IsValid())
    .WillRepeatedly(Return(true));
```

This states that `GetNumber` will be called exactly three times, returning 1, 2, and 3 for each call respectively. It also states `IsValid` will (possibly many times) return true.

### Advanced Expectation Behavior

- Expectations are matched in **reverse order**: newer expectations override older ones.
- Calls that don't match any `EXPECT_CALL` but match `ON_CALL` are considered *uninteresting* and by default cause a warning.
- Calls that don't match any `EXPECT_CALL` or `ON_CALL` are *unexpected* and cause a test failure.
- Specify `.Times(0)` on an expectation to explicitly disallow calls to that method.

## 3. Argument Matching

Both `ON_CALL` and `EXPECT_CALL` support argument matchers to control which calls the default action or expectation applies to.

### Types of Matchers

- Literal values (e.g., `5`) implicitly match with equality.
- Special matchers like `_` (wildcard), `Ge(5)` (greater or equal), `NotNull()`, and custom user-defined matchers.
- Multi-argument matchers through `.With()` to match combined argument tuples.

### Example

```cpp
EXPECT_CALL(mock, Process(_))  // Wildcard for one argument
    .WillOnce(Return(true));

EXPECT_CALL(mock, Process(Ge(10)))  // Argument >= 10
    .WillOnce(Return(false));
``` 

Calls with argument >= 10 will get false, other calls true.

## 4. Controlling Mock Behavior Through Actions

Actions specify what the mock method should do when invoked.

### Common Built-in Actions

| Action                | Description                                     |
| ----------------------|------------------------------------------------|
| `Return(value)`       | Return a copy of `value`.                        |
| `ReturnRef(var)`      | Return a reference to `var`.                     |
| `ReturnPointee(ptr)`  | Return the value pointed by `ptr` (evaluated at call time). |
| `DoDefault()`         | Perform the default action set by `ON_CALL` or default constructor. |
| `Invoke(callable)`    | Call an existing function, functor, method, or lambda. |
| `Throw(exception)`    | Throw the specified exception.                   |
| `SetArgPointee<N>(value)` | For output arguments, set the value pointed to by Nth argument. |
| `DoAll(a1, a2, ..., aN)` | Perform all actions in sequence; return the last action's return value. |

### Sequencing Actions

- `WillOnce(action)` applies the action once when the expectation matches.
- Multiple `WillOnce` clauses execute sequentially for successive calls.
- After `WillOnce`s are exhausted, `WillRepeatedly(action)` applies to all subsequent calls.

### Example

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

The first two calls return 1 and 2, subsequent calls return 3.

### Custom Actions

You can define custom actions by:

- Writing lambda functions or functors with a compatible signature.
- Using the `ACTION` and `ACTION_P` macros to define reusable custom actions.
- Using existing functions or methods with `Invoke()` or `InvokeWithoutArgs()`.

### Example: Using Lambda as an Action

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 2; });
```

## 5. Controlling Call Order

- Use `InSequence` objects or `.InSequence()` clauses on expectations to specify strict call order.
- `After()` clauses define partial order constraints on expectations.

### Example

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
  EXPECT_CALL(mock, Third());
}
```

The calls must occur in the order First → Second → Third.

## 6. Controlling Lifetimes and Retiring Expectations

- Expectations are *sticky* by default: they remain active even after saturating their call count, allowing additional calls to match older expectations.
- To relinquish this behavior, use `.RetiresOnSaturation()` so the expectation retires once saturated.

## 7. Handling Uninteresting and Unexpected Calls

- **Uninteresting calls:** calls to methods without matching `EXPECT_CALL`s. By default, they trigger warnings and execute the default action (either the built-in default or the one set by `ON_CALL`). Use `NiceMock` to suppress warnings or `StrictMock` to convert warnings into failures.
- **Unexpected calls:** calls that do not match any provided expectation. These always cause test failures.

## 8. Tips and Best Practices

- Prefer to use `ON_CALL` for default behaviors when call verification is not needed.
- Use `EXPECT_CALL` sparingly and only when you want to verify that calls happen as expected.
- When defining multiple `EXPECT_CALL`s on the same method, place the more specific expectations *after* the more general ones.
- Use `.RetiresOnSaturation()` to avoid brittle tests related to sticky expectations.
- Use `.With()` to express complex multi-argument constraints.
- When mocking overloaded methods, always specify the argument list to disambiguate.
- Use `Invoke()` or lambdas for complex or dynamic return behaviors.

## 9. Troubleshooting

- If you see "Uninteresting mock function call" warnings, consider if you should add expectations or use a `NiceMock`.
- Verify the order of `EXPECT_CALL`s and their matchers if calls are not matching as expected.
- Use the `--gmock_verbose=info` flag to see detailed call matching info.
- Ensure you specify `WillOnce()` or `WillRepeatedly()` actions when needed; otherwise, default actions apply.

---

## References

- [GoogleMock Mock Object Definition](../../api-reference/gmock-mock-api/mock-object-definition)
- [GoogleMock Matchers Reference](../../api-reference/gmock-mock-api/matchers-reference)
- [GoogleMock Actions Reference](../../api-reference/reference/actions.md)
- [GoogleMock Tutorial (Mocking Basics)](../../guides/real-world-workflows/mocking-basics.md)
- [GoogleTest Assertions Reference](../../api-reference/gtest-core-api/assertions-reference.md)

---

This page fits within the **GoogleMock Mocking API** of the API reference, closely related to defining mock classes and matchers, and builds on the fundamentals covered in core GoogleTest concepts.

### Response Diagram (Call flow for expectations and actions in a mock invocation)

```mermaid
sequenceDiagram
  participant Test as Test Logic
  participant Mock as Mock Object
  participant GMock as GoogleMock Framework
  participant Expect as Expectations
  participant OnCall as Default Actions

  Test->>Mock: Calls Mock Method(args)
  Mock->>GMock: InvokeWith(args)
  GMock->>Expect: FindMatchingExpectation(args)
  alt Matching Expectation Found
    Expect->>GMock: GetActionForArguments()
    GMock->>Test: Perform Action
  else No Matching Expectation
    GMock->>OnCall: FindOnCallSpec(args)
    alt Matching ON_CALL Found
      OnCall->>GMock: Perform Default Action
      GMock->>Test: Return Default Action Result
      GMock->>Test: Print Warning (uninteresting call)
    else No ON_CALL
      GMock->>Test: Return Built-in Default / Fail (unexpected call)
  end
```
