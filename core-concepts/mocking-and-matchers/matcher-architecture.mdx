---
title: "Matcher Architecture"
description: "Gain insight into how matchers work in both GoogleTest and GoogleMock. Understand the design of the Matcher interface, extensibility through custom matchers, and how matchers enhance declarative and readable test code."
---

# Matcher Architecture

Understand how matchers work in GoogleTest and GoogleMock to write expressive, flexible, and maintainable tests. This guide unveils the design of matcher interfaces, how to extend them with custom matchers, and their role in enhancing declarative test code.

---

## Introduction to Matchers

Matchers are the cornerstone of expressive test assertions in GoogleTest and GoogleMock. They act as predicates that define conditions on values or arguments, enabling tests to specify what is expected without describing how. This abstraction makes tests more readable and robust.

In GoogleMock, matchers allow you to specify expected arguments for mocked methods. In GoogleTest, they facilitate flexible assertion conditions. Both frameworks share a common matcher architecture designed for efficiency, reusability, and extensibility.

## Matcher Interface Design

Matchers in GoogleTest and GoogleMock are primarily represented by the template class `Matcher<T>`. This class encapsulates the logic to check if a value of type `T` satisfies the matcher condition and also supports generating human-readable descriptions of what the matcher tests.

### Core Operations of Matchers

Each matcher must provide the following capabilities:

- **Matching Logic:** Evaluate whether a given value matches the condition.
- **Explanation:** Optionally provide detailed explanations for why a match succeeded or failed.
- **Description:** Generate textual descriptions used in test failure outputs, both for positive and negative cases.

### Polymorphism and Type Safety

Matchers use polymorphic and monomorphic interfaces:

- **Monomorphic Matcher (`Matcher<T>`):** Matches values of a specific type `T`. Used for actual matching.
- **Polymorphic Matcher:** Acts as a factory that can convert into `Matcher<T>` for various types depending on the context. For example, `Eq(5)` can match different numeric types seamlessly.

Safety and strict typing are enforced at compile time, preventing mismatches where possible.

## Writing and Using Matchers

Matchers are typically used in two forms:

1. **Simple Matchers:** Built-in matchers include `Eq()`, `Ne()`, `Gt()`, `Ge()`, `Lt()`, `Le()`, wildcards like `_`, and others. They cover common cases.

2. **Composed Matchers:** Combined using logical combinators like `AllOf()`, `AnyOf()`, `Not()`, or container matchers like `ElementsAre()`.

### Example Usage

```cpp
using ::testing::Eq;
using ::testing::_;

EXPECT_CALL(mock_obj, SomeMethod(Eq(5), _));
EXPECT_THAT(value, AllOf(Ge(5), Le(10)));  // value between 5 and 10 inclusive
```

### Matchers as Predicates

Matchers behave like predicates but also provide rich failure messages, making them suitable for use in GoogleTest's `EXPECT_THAT` and GoogleMock's argument expectations.

## Extensibility: Writing Custom Matchers

GoogleTest and GoogleMock provide flexible mechanisms to create custom matchers tailored to your testing needs.

### Using MATCHER Macros

For most common cases, you can define custom matchers quickly with macros:

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

// Parameterized matcher example
MATCHER_P(IsDivisibleBy, divisor, "checks divisibility by a number") {
  return (arg % divisor) == 0;
}

// Usage
EXPECT_CALL(mock_obj, Process(IsEven()));
EXPECT_THAT(value, IsDivisibleBy(3));
```

The `MATCHER` macros automatically generate description strings and failure explanations.

### Implementing Matcher Interfaces Manually

For advanced use cases, implement the matcher interface directly:

- Define a class with:
  - `bool MatchAndExplain(const T&, MatchResultListener*) const` for matching and optional explanations.
  - `void DescribeTo(std::ostream*) const` and `void DescribeNegationTo(std::ostream*) const` to produce descriptive messages.
  - Typedef `using is_gtest_matcher = void;` to signal matcher support.

- Implement a factory function that returns a `Matcher<T>` instance.

This approach grants precise control over behavior and descriptions.

### Polymorphic Custom Matchers

To support matching multiple types like built-in polymorphic matchers, template your matching logic and use `MakePolymorphicMatcher()` to generate the polymorphic interface.

## Detailed Matcher Behavior

### MatchAndExplain Method

This method determines whether a given argument matches and streams additional information to `MatchResultListener` to provide insightful diagnostics in case of failure or success where helpful.

### Description Methods

- **DescribeTo:** Prints a message describing what the matcher expects.
- **DescribeNegationTo:** Prints a message describing what it means to not match.

Both are used by the testing framework to show explanatory messages in test output.

## Commonly Used Built-in Matchers

GoogleTest provides an extensive list of built-in matchers for convenience:

- **Wildcard Matcher:** `_` matches anything.
- **Comparison Matchers:** `Eq()`, `Ne()`, `Lt()`, `Le()`, `Gt()`, `Ge()`.
- **String Matchers:** `StrEq()`, `StrNe()`, `HasSubstr()`, `StartsWith()`, `EndsWith()`, `MatchesRegex()`.
- **Pointer Matchers:** `IsNull()`, `NotNull()`, `Pointee()`.
- **Container Matchers:** `ElementsAre()`, `UnorderedElementsAre()`, `Contains()`, `Each()`.
- **Composite Matchers:** `AllOf()`, `AnyOf()`, `Not()`.

These reduce boilerplate and express intent explicitly.

## Matcher Composition

Matchers can be combined logically for complex conditions:

```cpp
EXPECT_THAT(collection, AllOf(Contains(Ge(0)), SizeIs(5)));
EXPECT_CALL(mock_obj, Foo(AllOf(Gt(0), Ne(42))));
```

Composition allows building complex predicates from simpler ones.

## Tips, Best Practices, and Pitfalls

- **Prefer `ON_CALL` for default behaviors** and `EXPECT_CALL` when you want to verify that a call happens.
- **Be cautious with matcher expressions involving objects with side effects**, as matchers must be pure functions with no observable side effects.
- **Use `SafeMatcherCast<T>(m)`** to cast matchers safely when you know the conversion is valid.
- **Leverage built-in matchers whenever possible** to ensure clear error messages.
- **Write detailed descriptions and explanations in custom matchers** to help diagnose failures quickly.

## Troubleshooting Matcher Issues

- Matchers failing unexpectedly may result from incorrect types or matcher misuse; check type compatibility.
- If match explanations seem inadequate, implement or enhance the `MatchAndExplain` method.
- When matching containers or complex structures, ensure matchers correctly reflect the expected value structure.

## Summary

Matchers enhance the expressiveness and reliability of your C++ tests by abstracting argument validation into readable, reusable components. GoogleTest and GoogleMock provide a comprehensive matcher architecture that is powerful and extensible, empowering you to create clear and maintainable tests.

## See Also

- [Matchers Reference](reference/matchers.md) — for a complete list of built-in matchers.
- [Mocking Reference](reference/mocking.md) — for using matchers with mocks.
- [gMock Cookbook](gmock_cook_book.md) — for recipes and examples of matcher usage.
- [Writing New Matchers Quickstart](#NewMatchers) section in the gMock Cookbook.
- [Creating Expectations and Actions](reference/mocking.md#EXPECT_CALL) — for integrating matchers in mocks.

---