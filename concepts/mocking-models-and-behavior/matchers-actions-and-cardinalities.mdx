---
title: "Matchers, Actions, and Cardinalities"
description: "Covers the conceptual frameworks for matching argument values (matchers), defining mock return behaviors (actions), and controlling call count expectations (cardinalities). Details how these elements work together to build expressive, readable tests."
---

# Matchers, Actions, and Cardinalities

In GoogleTest and GoogleMock, writing expressive and robust tests hinges on three fundamental concepts: **Matchers**, **Actions**, and **Cardinalities**. Together, these form the core building blocks for specifying how mock methods respond to calls and how expected interactions with those methods are verified.

This document unpacks these concepts, illustrating how to use them to set up effective testing expectations, default behaviors, and constraints on mock methods.

---

## Matchers: Validating Argument Values

Matchers are predicates or specifications that determine whether a mock method’s arguments meet the desired criteria. They make tests flexible and readable by allowing partial or complex matching instead of rigid exact equality.

### What Are Matchers?

Matchers are used inside `EXPECT_CALL()` or `ON_CALL()` macros to specify which arguments are acceptable for a mock method invocation. If all matchers for a call’s arguments succeed, the mock method invocation is considered a match.

- **Use Literal Values or Built-in Matchers:** Writing `EXPECT_CALL(foo, Bar(5))` is equivalent to `EXPECT_CALL(foo, Bar(Eq(5)))`. GoogleMock provides numerous built-in matchers such as `_` (wildcard), `Ge()`, `Lt()`, `Not()`, etc.

- **The underscore matcher `_`:** Matches any argument value, useful to ignore arguments that are unimportant for a test.

- **Custom Matchers:** You can define your own complex matchers for domain-specific logic (see [Custom and Advanced Matchers](../api-reference/matchers-api/custom-matchers) for details).

### Using Multi-Argument Matchers with `.With()`

Sometimes you want to match on the entire argument tuple at once, for example to express relationships between arguments, like the first being less than the second. Use `.With()` for that:

```cpp
EXPECT_CALL(foo, SetPosition(_, _))
    .With(Lt())  // Args as a tuple satisfy the Lt() matcher
    .WillOnce(Return(true));
```

- The matcher passed to `.With()` must accept a `std::tuple` of arguments.
- This enables matching based on more sophisticated predicates beyond individual argument matching.

### Tips and Best Practices

- **Use `_` if you don’t care about specific argument values.**
- **Combine matchers logically using `AllOf()`, `AnyOf()`, `Not()`.**
- **Avoid over-specifying tests; only match what’s relevant.**
- **Use `.With()` when argument relationships matter.**

---

## Actions: Defining Mock Return Behavior and Side Effects

Actions specify what a mock method should do when it is called and matched against an expectation.

### Default Actions with ON_CALL()

Use `ON_CALL(mock_object, Method(args))` to define the **default behavior** of a mock method when called with matching arguments, but without asserting an expectation that the call must happen.

```cpp
ON_CALL(foo, Sign(_))
    .WillByDefault(Return(-1));
ON_CALL(foo, Sign(0))
    .WillByDefault(Return(0));
ON_CALL(foo, Sign(Gt(0)))
    .WillByDefault(Return(1));
```

The most recent matching `ON_CALL()` determines the default action for a given set of arguments.

### Specifying Expected Actions With EXPECT_CALL()

The `EXPECT_CALL(mock_object, Method(args))` macro defines both an expectation and an action:

- `.WillOnce(action)`: Specifies an action to perform on one matching call.
- `.WillRepeatedly(action)`: Specifies an action for all remaining matching calls after all `WillOnce` actions are used.

Example:

```cpp
EXPECT_CALL(foo, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This means:

1. The first call returns 100,
2. the second call returns 150,
3. subsequent calls return 200.

### Common Built-in Actions

- `Return(value)`: Return a copy of `value`.
- `ReturnRef(ref)`: Return a reference.
- `Invoke(callable)`: Delegate the call to a function, functor, or lambda.
- `DoAll(action1, action2, ...)`: Perform multiple actions sequentially, returning the result of the last.
- `SetArgPointee<N>(value)`: Set the pointed-to value of argument `N`.
- `InvokeArgument<N>(args...)`: Call the N-th argument if it’s callable.

### Best Practices

- Use `ON_CALL()` for default, unverified behaviors.
- Use `EXPECT_CALL()` with actions to specify expected behaviors and call verification.
- Chain multiple `WillOnce()` clauses to specify a sequence of behaviors.
- Use lambdas and `Invoke()` for complex or dynamic logic.

---

## Cardinalities: Controlling Call Counts

Cardinalities specify how many times a mock method call is expected.

### Using `.Times()` Clause

You can use `.Times(cardinality)` to set an explicit expectation on the number of matching calls. Some common cardinalities are:

| Cardinality     | Meaning                                   |
|-----------------|-------------------------------------------|
| `AnyNumber()`   | Allows any number of calls (including zero). |
| `AtLeast(n)`    | Expects at least `n` calls.                |
| `AtMost(n)`     | Expects at most `n` calls.                 |
| `Between(m,n)`  | Expects between `m` and `n` calls inclusively. |
| `Exactly(n)` or `n` | Expects exactly `n` calls.                |

### Cardinality Inference Rules

If `.Times()` is omitted, GoogleMock infers cardinality based on the presence of `WillOnce()` and `WillRepeatedly()` clauses:

- If no `WillOnce()` or `WillRepeatedly()`, cardinality defaults to `Exactly(1)`.
- If `n` `WillOnce()` clauses and no `WillRepeatedly()`, cardinality is `Exactly(n)`.
- If `n` `WillOnce()` clauses and a `WillRepeatedly()`, cardinality is `AtLeast(n)`.

### Using `.Times(0)` to Disallow Calls

Set `.Times(0)` to explicitly disallow calls in tests. Any call matching the warning will trigger a test failure.

```cpp
EXPECT_CALL(foo, Bar(_)).Times(0);  // Bar() should never be called.
```

### Controlling Expectation Lifetimes


- Expectations are **sticky** by default, remaining active even if saturated. Calls exceeding the cardinality cause failures.
- Use `.RetiresOnSaturation()` to indicate that an expectation retires and becomes inactive when saturated.

Example:

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
```

Here, the expectation will be matched only twice, then retire, allowing other expectations to match subsequent calls.

---

## How Matchers, Actions, and Cardinalities Work Together

When a mock method is invoked:

1. GoogleMock checks all expectations (set with `EXPECT_CALL`) in reverse order to find the first active matching one (matching argument values via matchers and with prerequisites met).
2. If a matching expectation is found, it verifies the call is within cardinality bounds.
3. GoogleMock performs the corresponding action:
   - Uses the next action in the `WillOnce()` list if available,
   - Otherwise uses the `WillRepeatedly()` action if provided,
   - Otherwise performs the `ON_CALL()` default action,
   - If none is defined, uses the default return value for the type.
4. If no expectation matches, GoogleMock treats the call as "uninteresting" or "unexpected" depending on configured mock strictness.

This flexible design allows you to specify precisely when and how mock methods should be called, what values to expect as input, and what output or side effects to produce.

---

## Practical Examples

### Example 1: Basic Matcher and Action

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, Compute, (int x), ());
};

MockFoo mock;
EXPECT_CALL(mock, Compute(Ge(10)))
    .WillOnce(Return(42));

int result = mock.Compute(15);  // Matches Ge(10), returns 42.
```

### Example 2: Using Cardinalities and Sequences

```cpp
using ::testing::Sequence;

Sequence s;

EXPECT_CALL(mock, Compute(_))
    .InSequence(s)
    .WillOnce(Return(1));
EXPECT_CALL(mock, Compute(_))
    .InSequence(s)
    .WillOnce(Return(2));

// Compute() must be called twice in order, returns 1 then 2.
``` 

### Example 3: Matching Multiple Arguments as a Whole

```cpp
EXPECT_CALL(mock, Process(_, _))
    .With(AllOf(Args<0>(Gt(0)), Args<1>(Lt(100))))
    .WillRepeatedly(Return(true));
```

### Example 4: Ignoring Calls Without Expectations

```cpp
NiceMock<MockFoo> nice_mock;
// No EXPECT_CALL() for SomeMethod() needed.
// Will suppress uninteresting call warnings.
nice_mock.SomeMethod(123);
```

---

## Troubleshooting Common Pitfalls

- **Over-specifying Call Counts:** Use `.RetiresOnSaturation()` when specifying multiple `.WillOnce()` actions to avoid upper-bound call count errors.
- **Uninteresting Calls:** If you get warnings about uninteresting calls, consider using `ON_CALL()` to set default behavior or wrapping mocks with `NiceMock` to suppress warnings.
- **Ambiguous Overloads:** Always specify parameters for overloaded functions in expectations to avoid ambiguous matches.
- **Matchers Must be Pure:** Matchers cannot have side effects or be stateful; they must always yield the same result given the same input.

---

## Additional References and Next Steps

- [Mocking Methods and Classes](../api-reference/mocking-api/mock-methods)
- [Setting Expectations and Actions](../api-reference/mocking-api/expectations-actions)
- [Matchers Reference](../api-reference/matchers-api/builtin-matchers)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Core Concepts and Terminology](../overview/intro-concepts/core-concepts-terminology)
- [Using Matchers for Flexible Testing](../guides/core-test-workflows/using-matchers)

---

Mastering matchers, actions, and cardinalities empowers you to write expressive, maintainable, and precise tests using GoogleMock. Experiment with combinations to suit your test scenarios, progressively refining your mock specifications to balance strictness and flexibility.