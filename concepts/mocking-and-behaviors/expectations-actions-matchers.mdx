---
title: "Expectations, Actions, and Matchers"
description: "Explore the expressive API for specifying how mocks should behave and what they should validate. Understand how matchers, actions, and expectations work together to enable precise testing and meaningful failure messages."
---

# Expectations, Actions, and Matchers

Explore the expressive API for specifying how mocks should behave and what they should validate. Understand how matchers, actions, and expectations work together to enable precise testing and meaningful failure messages.

---

## Introduction

When working with mock objects in GoogleMock, your primary tools are **expectations**, **actions**, and **matchers**. They form a powerful, expressive framework that lets you specify exactly how your mocks should behave under test and what interactions they should validate.

This guide unpacks these concepts from a user-centered perspective, helping you understand how to declare what calls are expected, determine mock behavior, and match arguments precisely for robust, maintainable tests.

---

## 1. Setting Expectations with `EXPECT_CALL`

### What Is an Expectation?

An **expectation** in GoogleMock states that a particular method on a mock object is expected to be called with certain arguments, and optionally controls how many times it should be called, in what order, and what it should do.

### Syntax Overview

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher)  // Optional
    .Times(cardinality)            // Optional
    .InSequence(sequences...)      // Optional
    .After(expectations...)        // Optional
    .WillOnce(action)              // Optional, repeatable
    .WillRepeatedly(action)        // Optional, once
    .RetiresOnSaturation();        // Optional
```

Each clause serves a specific purpose in controlling invocation matching and behavior:

- `.With(...)` restricts matching on all arguments together
- `.Times(...)` specifies expected call counts
- `.InSequence(...)` and `.After(...)` control call ordering
- `.WillOnce(...)` and `.WillRepeatedly(...)` define what the mock does
- `.RetiresOnSaturation()` controls expectation lifetime

### Cardinality (`.Times()`)

The cardinality defines how many times a call is expected. You can specify an exact number, a range, or use built-in policies such as `AnyNumber()` and `AtLeast(n)`.

If omitted, GoogleMock infers cardinality based on actions specified, assuming one call or the number of `.WillOnce()` methods.

### Ordering Controls (`.InSequence()` and `.After()`)

- Use `.InSequence()` with one or more `Sequence` objects to specify that calls must occur in the order declared.
- Use `.After()` to specify that a call must occur after one or more other expectations (can accept `Expectation` or `ExpectationSet`).

These controls help model partial or complete ordering for complex interaction sequences.

### Actions (`.WillOnce()` and `.WillRepeatedly()`)

An expectation defines what happens when a matching method call occurs via actions:

- `.WillOnce(action)` specifies behavior for a _single_ call.
- `.WillRepeatedly(action)` specifies behavior for all subsequent calls after `.WillOnce` actions are exhausted.

Actions include returning values, throwing exceptions, modifying arguments, invoking callbacks, or custom behavior.

### Retiring Expectations

Adding `.RetiresOnSaturation()` tells GoogleMock to deactivate the expectation after it has been fully satisfied (i.e., max number of calls reached), allowing subsequent calls to match other expectations.

Example:

```cpp
EXPECT_CALL(mock, Foo(7))
    .Times(2)
    .RetiresOnSaturation();
```

In this example, after two calls to `Foo(7)`, this expectation is retired and no longer matches further calls.

---

## 2. Setting Default Behaviors with `ON_CALL`

Use `ON_CALL()` to specify what the mock method should do by default when called, but without setting an expectation that it must be called.

Syntax:

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);         // Required
```

Unlike `EXPECT_CALL()`, `ON_CALL()` _does not_ verify that calls actually happen.

**Best Practice:** Use `ON_CALL` in test fixtures or mock constructors to define common default behaviors shared among tests, and reserve `EXPECT_CALL` for verifying that calls occur as part of test validation.

---

## 3. Understanding Matchers: Specifying Expected Arguments

**Matchers** enable you to precisely specify which arguments your mock methods must receive to meet an expectation.

### Types of Matchers

- **Literal values:** Equal matcher `Eq(value)` is implicitly applied when you specify a raw value.
- **Wildcard matcher `_`** matches any argument.
- **Built-in matchers:** e.g., `Lt(x)`, `Ge(x)`, `NotNull()`, `Pointee(m)`, `ElementsAre(...)`, and many more.
- **Composite matchers:** Built via `AllOf()`, `AnyOf()`, `Not()`, etc.
- **Custom matchers:** Create your own if built-ins don’t fit by implementing matcher interfaces or using macros.

### Matching Multiple Arguments Together

Use `.With()` combined with `Matcher<std::tuple<...>>` for matching argument tuples, such as ensuring one argument is less than another.

Example:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // Matches calls where first arg < second arg
```

### Matching Pointers and Members

Matchers like `Pointee(m)` match the content pointed at, not just the pointer value.

`Field(&Class::member, m)` and `Property(&Class::getter, m)` allow matching on object members or property methods.

### Tips for Using Matchers

- Use `_` for arguments you don't care about.
- Combine matchers for complex logic.
- Be mindful that matchers must be free of side effects.

---

## 4. Actions: What Your Mocks Do

When a mocked method is called, it doesn’t run real code but performs **actions** you specify.

### Built-in Actions

- `Return(value)` returns a value.
- `ReturnRef(variable)` returns a reference.
- `ReturnPointee(ptr)` returns the value pointed to by `ptr` at call time.
- `Assign(&var, value)` assigns a value to a variable.
- `SetArgPointee<N>(value)` modifies an output argument.
- `Throw(exception)` throws an exception.
- `Invoke(callable)` invokes a function, lambda, or method.
- Many others. See the [Actions Reference](../reference/actions.md) for complete list.

### Combining Actions

Use `DoAll(a1, a2, ..., an)` to chain multiple actions, with the last action’s result returned.

Example:

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(10), Return(true)));
```

### Using Lambdas and Callables

Pass custom behavior easily by providing lambdas or functors to `WillOnce` or `WillRepeatedly`.

Example:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillRepeatedly([](int x) { return x * x; });
```

### Returning Move-only Types

For methods returning move-only types like `std::unique_ptr<T>`, use lambdas in `WillOnce` or `WillRepeatedly` to create new objects on each call.

Example:

```cpp
EXPECT_CALL(mock, MakeBuzz("hello"))
    .WillRepeatedly([](StringPiece) {
      return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

### Invoking Arguments as Callbacks

Use `InvokeArgument<N>(args...)` to invoke the N-th callable argument with specified arguments.

Example:

```cpp
EXPECT_CALL(mock, DoWork(_, _))
    .WillOnce(InvokeArgument<1>(true));  // Call the second arg as callback.
```

---

## 5. How Expectations, Actions, and Matchers Work Together

Here’s a typical workflow to define mocking behavior:

1. **Create a mock object**.
2. **Use `ON_CALL` to define common default behavior** (e.g., default return values).
3. **Use `EXPECT_CALL` with matchers to specify which calls you expect** and what they will do.
4. **Chain actions** in `WillOnce` and `WillRepeatedly` to define side effects or return values.
5. **Use ordering constraints** (`InSequence`, `After`) as needed to model correct call sequences.
6. **Exercise your code under test, while GoogleMock verifies expectations** and executes actions.

---

## 6. Practical Tips and Best Practices

- Prefer `ON_CALL` for general defaults and `EXPECT_CALL` for enforcing call counts.
- Avoid over-specifying argument matchers unless necessary — use `_` if argument’s value is not important.
- Control ordering with sequences only when the order matters to avoid brittle tests.
- Use `.RetiresOnSaturation()` to avoid expectations remaining active beyond their use.
- For complex side effects, use lambdas or custom actions.
- Suppress uninteresting call warnings with `NiceMock` only if you truly don’t care about some calls.
- Use `StrictMock` to catch unexpected calls as errors.
- Match containers using `ElementsAre()`, `UnorderedElementsAre()`, or custom matchers for precise validations.
- Use `Invoke()` family to run existing functions and maintain DRY.

---

## 7. Troubleshooting Common Issues

### Unmatched Calls

- Check matchers in `EXPECT_CALL` and `ON_CALL` — argument mismatch leads to unexpected call errors.
- Use `--gmock_verbose=info` to get detailed logs of which expectations matched or failed.

### Unexpected or Uninteresting Call Warnings

- Add a catch-all expectation with `.Times(AnyNumber())` for methods called with variable args.
- Use `NiceMock` to suppress uninteresting warnings when appropriate.

### Overlapping Expectations

- Remember newer `EXPECT_CALL`s override older ones when arguments overlap; order expectations accordingly.

### Actions Running Out

- Provide a `WillRepeatedly()` after your `WillOnce()` list to avoid default action fallback warnings.

---

## 8. Illustrative Example

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::Sequence;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (int input), ());
  MOCK_METHOD(void, SetValue, (int value), ());
};

TEST(MyTest, ExampleUsage) {
  MockFoo mock;

  Sequence s;

  // Default behavior for any call to GetValue.
  ON_CALL(mock, GetValue(_)).WillByDefault(Return(0));

  // Expect GetValue(5) to be called once, returning 42.
  EXPECT_CALL(mock, GetValue(5))
      .Times(1)
      .WillOnce(Return(42))
      .RetiresOnSaturation();

  // Expect SetValue to be called twice, any arguments.
  EXPECT_CALL(mock, SetValue(_))
      .Times(2)
      .InSequence(s);

  // Expect GetValue(10) to be called at least once anytime after SetValue calls.
  EXPECT_CALL(mock, GetValue(10))
      .Times(::testing::AtLeast(1))
      .After(mock, SetValue(_));

  // Exercise code that calls mock methods...
  EXPECT_EQ(mock.GetValue(5), 42);    // Matches first expectation.
  mock.SetValue(100);
  mock.SetValue(200);
  EXPECT_EQ(mock.GetValue(10), 0);    // Uses ON_CALL default after sequence.
}
```

This example shows defining defaults, exact expectations, call counts, and sequences.

---

## 9. Summary

Expectations, actions, and matchers work together in GoogleMock to make mocking a concise, readable, and powerful process. They allow tests to focus on the interaction contract between components, enabling precise validation of method calls, arguments, invocation order, and custom behaviors.

Mastering these concepts unlocks effective test writing that is robust to internal changes but rigorous in adherence to interface contracts.

---

## References and Further Reading

- [Guide: Creating Your First Mock Object](../guides/getting-started/first-mock.md)
- [Mocking Reference: EXPECT_CALL and ON_CALL](../api-reference/mocking-apis/defining-expectations-actions.md)
- [Actions Reference](../reference/actions.md)
- [Matchers Reference](../api-reference/matchers-and-advanced-utils/builtin-matchers.md)
- [Mocking Best Practices](../guides/essential-testing-patterns/mocking-best-practices.md)
- [gMock for Dummies Tutorial](../docs/gmock_for_dummies.md)

---

Explore related concepts in [Mock Objects: Design and Usage](../concepts/mocking-and-behaviors/mock-objects-design.md) and [Mock Strictness Modes: Nice, Naggy, and Strict](../concepts/mocking-and-behaviors/mock-strictness-modes.md) for finer control of mock behavior.

---

### Callouts

<Note>
Setting overly strict expectations can lead to brittle tests; balance specificity with test maintainability.
</Note>

<Tip>
Use `.RetiresOnSaturation()` to avoid stale expectations blocking later calls.
</Tip>

<Warning>
Uninteresting calls can print warnings by default; use `NiceMock` to suppress if intentional, or add catch-all expectations.
</Warning>

---

This documentation will guide you progressively from defining expectations with matchers to specifying detailed actions and verifying mock interactions effectively in your C++ tests using GoogleMock.

---
