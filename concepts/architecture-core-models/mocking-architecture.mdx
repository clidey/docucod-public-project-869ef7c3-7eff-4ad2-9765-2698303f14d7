---
title: "Mock Objects and Expectations"
description: "Dive into the core architecture of GoogleMock, including how mock classes are defined, how methods are mocked, and how expectations are set and verified. Understand the design rationale behind expectation management and the lifecycle of mock interactions."
---

# Mock Objects and Expectations

Dive into the core architecture of GoogleMock, revealing how mock classes are defined, how mocking and expectations work, and the lifecycle of mock interactions. This guide focuses on the user-facing principles and workflows, empowering you to create, configure, and verify mock behaviors effectively.

---

## Introduction to Mock Objects in GoogleMock

At the heart of GoogleMock lies the ability to simulate and control dependencies through mock objects. A mock object is a special test double that mimics the behavior of real classes by implementing the same interface, but allows you to specify how it should behave and verify interactions during testing.

GoogleMock enables the creation of these mock classes easily via macros like `MOCK_METHOD` and provides flexible mechanisms to set up **expectations**—the expected method calls, argument values, call counts, ordering, and return behaviors. These expectations form the contract your tests assert against.


## Defining Mock Classes and Methods

When you want to mock a class, especially an abstract interface, you derive a mock class and use the `MOCK_METHOD` macro to declare mock methods. Each mocked method matches the signature of a virtual method in the base class.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};
```

The mock methods generate the machinery to: catch calls, check call arguments, run specified actions, and report violations immediately.

**Key points:**
- Mock methods must be declared `public` so `EXPECT_CALL` and `ON_CALL` can access them.
- Virtual destructors in base classes are critical to avoid memory issues when mocking.
- C++ specifics, including const qualifiers, noexcept and calling conventions, can be specified in the `MOCK_METHOD` macro.


## Expectations: Specifying How Mocks Should Behave

Expectations define what you anticipate your mock object to receive in terms of method invocations. Expectations are created with the `EXPECT_CALL` macro and specify:

- What method will be called
- How many times (`Times` cardinality)
- With what arguments (matchers)
- What the mock should do (`WillOnce`, `WillRepeatedly`)
- When calls should occur (ordering via `InSequence` or `After`)

Example:

```cpp
EXPECT_CALL(mock_obj, Foo(5))           // Expect Foo() called with argument 5
    .Times(2)                          // Exactly twice
    .WillOnce(Return(10))              // On first call returns 10
    .WillOnce(Return(20));             // On second call returns 20
```

### Expectation Lifecycle

Expectations are submitted before the code under test runs. Once the test exercises the code, gMock verifies:

- Methods are called the expected number of times.
- Arguments match the specified conditions.
- The correct call order is followed if sequencing is specified.
- Return values and side effects are executed as defined.

Failures in expectations are flagged immediately as errors, often with detailed diagnostics including the call, matcher mismatches, and call locations.


## Matching Arguments and Cardinalities

### Argument Matchers

Expectations must specify what arguments are expected in method calls. You can use exact values or versatile matchers:

- `_` matches any value (wildcard)
- `Eq(value)` matches exactly
- `Ge(n)`, `Le(n)` for inequalities
- Custom matchers let you define complex argument conditions

Example:

```cpp
EXPECT_CALL(mock, Bar(Ge(5), _));  // First arg >=5; second arg anything
```

### Cardinalities: How Many Times?

Cardinalities specify how many times the call is expected:

| Cardinality                    | Meaning                                |
|-------------------------------|----------------------------------------|
| `AnyNumber()`                  | Allow any number of calls               |
| `AtLeast(n)`                  | Call expected at least `n` times       |
| `AtMost(n)`                   | Call expected no more than `n` times   |
| `Between(m, n)`               | Between `m` and `n` calls (inclusive)  |
| `Exactly(n)` or `n`           | Exactly `n` times                       |

Omission of `Times()` infers cardinality based on the presence of `WillOnce()` and `WillRepeatedly()`.


## Controlling Call Ordering

By default, expectations are matched in any order. GoogleMock allows you to specify ordering when needed:

- **InSequence:** Expectations declared within an `InSequence` scope must be satisfied in order.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, Init());
  EXPECT_CALL(mock, Start());
}
```

- **After:** Specify that one expectation must occur after another or a set.

```cpp
Expectation e1 = EXPECT_CALL(mock, Open());
EXPECT_CALL(mock, Read()).After(e1);
```

This flexibility lets you specify strict sequences or partial orders suited to your test scenarios.


## Default Behavior vs. Expectations

Sometimes you want to specify a mock's default behavior without requiring that the method be called. Use `ON_CALL` to define these default actions:

```cpp
ON_CALL(mock_obj, Compute(_)).WillByDefault(Return(42));
```

Difference from `EXPECT_CALL`:

- `ON_CALL` sets default responses but does not require the call.
- `EXPECT_CALL` sets expectations that calls *must* occur with defined behavior.


## Handling Uninteresting Calls

- If a mock method is called without an expectation (`EXPECT_CALL`), it's an **uninteresting call**.
- By default, gMock warns about these calls as they may indicate missing expectations.
- Use **NiceMock** to suppress uninteresting call warnings.
- Use **StrictMock** to treat uninteresting calls as errors.

```cpp
NiceMock<MockFoo> nice_mock;  // Suppresses uninteresting warnings
StrictMock<MockFoo> strict_mock; // Fail on uninteresting calls
```


## Sticky Expectations and Retiring

- Expectations in gMock are **sticky**, meaning they remain active even after reaching their call limits, which allows detecting incorrect excess calls.
- Use `.RetiresOnSaturation()` to make an expectation inactive (retire) once its call count limit is reached.

This enables complex call patterns and subtle validation of call behavior.


## Verification of Expectations

GoogleMock automatically verifies expectations when mock objects are destructed. If mismatch or call count violations occur, test failures with detailed diagnostics occur.

You can also explicitly verify and clear expectations before destruction:

```cpp
EXPECT_TRUE(::testing::Mock::VerifyAndClearExpectations(&mock_obj));
```

This is useful if you want deterministic verification at specific points.


## Practical User Flow

1. **Define your mock classes** using `MOCK_METHOD`.
2. **Create mock objects** in your test.
3. **Set default behaviors** via `ON_CALL` when appropriate.
4. **Set expectations** with `EXPECT_CALL`, specifying argument matchers, cardinalities, and actions.
5. **Run test code**, invoking methods on mocks.
6. **Automatically or explicitly verify** that expectations are met.


## Common Pitfalls & Best Practices

- **Always set expectations before the code exercises mocks.** Setting expectations after calls leads to undefined behavior.
- Prefer to set **default actions via `ON_CALL`** and keep `EXPECT_CALL` scarcer for real verification needs.
- Use matchers wisely—don’t over-specify arguments to avoid fragile tests.
- Use `InSequence` or `After` to enforce necessary call orders.
- Use `RetiresOnSaturation` to handle expectations that should become inactive.
- When mocking classes you do not own, consider placing mocks in dedicated testing namespaces or adaptors.
- Prefer coding to interfaces to simplify mocking.


## Visualizing Expectation Ordering

```mermaid
flowchart TD
  subgraph SequenceExample
    E1[EXPECT_CALL(mock, Init())]
    E2[EXPECT_CALL(mock, Start())]
    E3[EXPECT_CALL(mock, Stop())]

    E1 --> E2 --> E3
  end

  style SequenceExample fill:#f9f9f9,stroke:#333,stroke-width:1px
```

This simple sequence enforces call order: `Init()` before `Start()`, before `Stop()`.


## Related Concepts and Next Steps

- **See [gMock for Dummies](docs/gmock_for_dummies.md)** for an approachable introduction to mocks and interaction-based testing.
- **Consult [gMock Cookbook](docs/gmock_cook_book.md)** for recipes addressing advanced mocking techniques, actions, and matchers.
- **Review [Mocking Reference](api-reference/mocking-actions-matchers/mock-objects-and-methods.md)** for full API details.
- **Explore [Expectations and Sequences](api-reference/mocking-actions-matchers/expectations-and-sequences.md)** for deeper understanding of ordering and call expectations.
- Leverage strictness wrappers like `NiceMock` and `StrictMock` to manage uninteresting calls' behavior.


---

This guide empowers you to harness GoogleMock effectively, enabling precise control and verification of interactions in your unit tests, leading to more reliable, expressive, and maintainable test suites.