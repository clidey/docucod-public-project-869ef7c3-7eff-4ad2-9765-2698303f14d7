---
title: "Matchers and Actions: Expressive Test Behavior"
description: "Explore the expressive matcher and action frameworks that define flexible test and mock behaviors. Learn how matchers encapsulate input expectations and how actions describe dynamic responses, enabling thorough, intention-revealing tests."
---

# Matchers and Actions: Expressive Test Behavior

Explore the expressive matcher and action frameworks that define flexible test and mock behaviors. Learn how matchers encapsulate input expectations and how actions describe dynamic responses, enabling thorough, intention-revealing tests.

---

## Introduction

In unit testing with GoogleMock, precisely describing *what* inputs are accepted (matchers) and *what* outputs or effects to produce (actions) forms the heart of flexible, intention-revealing test specifications. This page focuses exclusively on the matcher and action frameworks that empower you to create expressive, readable, and maintainable mock behaviors.

Matchers answer the question: **What arguments do we expect?**

Actions answer the question: **What should the mock method do?**

By mastering both, you gain fine control over mock behavior and verification, writing tests that embody your intent clearly.

---

## Understanding Matchers

### What Are Matchers?

Matchers are predicates used within `EXPECT_CALL` or `ON_CALL` macros to specify the conditions under which mock method arguments are accepted.

- Each matcher corresponds to a function argument and can be as simple as a literal or as complex as a custom condition.
- The special matcher `_` acts as a wildcard, accepting any value.

### How Matchers Work in Practice

```cpp
using ::testing::_;
using ::testing::Lt;

// Expect turtle to jump to some point where x = 50, y can be anything.
EXPECT_CALL(turtle, GoTo(50, _));

// Expect forward movement of at least 100 units.
EXPECT_CALL(turtle, Forward(Lt(100)));  // Incorrect, should be Ge(100). Correct:
EXPECT_CALL(turtle, Forward(Ge(100)));
```

- If a method is not overloaded, you can omit matchers, which implies all arguments match anything.
- For overloaded methods, matchers are necessary to disambiguate the overload.

### Composing Matchers

Use combinators like `AllOf()`, `AnyOf()`, and `Not()` to build compound conditions:

```cpp
EXPECT_CALL(foo, DoThis(AllOf(Gt(5), Ne(10))));
```

This expects the argument to be greater than 5 *and* not equal to 10.

### Multi-argument Matchers with `.With()` Clause

To match *all* arguments simultaneously on a higher level, use `.With()`:

```cpp
EXPECT_CALL(foo, SetPosition(_, _))
    .With(Lt());  // expects first arg less than second
```

`.With()` accepts a matcher on a tuple of all arguments, enabling cross-argument relations.

### Practical Tips for Matchers

- Use simple matchers (`Eq`, literals) for clarity.
- Use custom or parameterized matchers (`MATCHER`, `MATCHER_P`) for complex conditions.
- Avoid over-specifying to keep tests robust and focused.
- Prefer `_` to ignore unimportant arguments.

---

## Understanding Actions

### What Are Actions?

Actions specify what a mock method should *do* when invoked. This includes the return value, manipulating output parameters, side effects, or invoking callbacks.

### Basic Actions Example

```cpp
using ::testing::Return;

EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))       // On first call, return 100
    .WillOnce(Return(200))       // On second call, return 200
    .WillRepeatedly(Return(300)); // Afterwards, always return 300
```

### Common Built-in Actions

| Action                      | Description                                  |
|-----------------------------|----------------------------------------------|
| `Return(value)`             | Return the specified value.                   |
| `ReturnRef(variable)`       | Return reference to a variable.               |
| `ReturnPointee(ptr)`        | Return the value pointed to by a pointer.    |
| `SetArgPointee<N>(value)`   | Assign `value` to the `N`-th argument's pointee. |
| `DoAll(a1, a2, ..., an)`    | Perform all actions sequentially, return last |
| `Invoke(f)`                 | Call a function or functor with the arguments |
| `InvokeWithoutArgs(f)`      | Call a zero-argument callable ignoring mock args |
| `InvokeArgument<N>(args...)`| Invoke the N-th argument (a callable) with parameters |
| `IgnoreResult(action)`      | Execute an action, discarding its result      |

### Composite Actions

Sometimes you need multiple side effects and a return value:

```cpp
EXPECT_CALL(foo, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

The `DoAll` ensures the side effect happens first, and then `true` is returned.

### Using Callables as Actions

You can use lambdas, functions, or functors as actions if they match the mocked function's signature or can ignore extra arguments:

```cpp
EXPECT_CALL(mock, DoSomething(_))
    .WillOnce([](int arg) { return arg * 2; });
```

### Invoking Callable Arguments

Invoke callable arguments passed to the mock using `InvokeArgument`:

```cpp
EXPECT_CALL(foo, RegisterCallback(_))
    .WillOnce(InvokeArgument<0>(42)); // Calls the first argument (a callback) with 42
```

If the callable takes reference arguments, wrap those in `std::ref()`.

---

## How Matchers and Actions Work Together

With the expressive power of matchers controlling *which* mock call patterns are observed, and actions controlling *what* happens, you can:

- Specify detailed argument validation without sacrificing readability.
- Return sequences of values or side effects accurately reflecting multiple call scenarios.
- Coordinate expectations with order constraints (`InSequence`, `After`) and call behaviors.

This facilitates designing robust, intention-driven tests that break only when the underlying behavior truly deviates.

---

## Best Practices

- Use `EXPECT_CALL` for specifying *expected* calls requiring verification.
- Use `ON_CALL` to set *default* behaviors without requiring verification of call counts.
- Narrow matchers only as much as necessary to avoid brittle tests.
- Use `.With()` sparingly and with clarity to express multi-argument relationships.
- Use `RetiresOnSaturation()` to retire expectations that should only apply until saturation.
- Prefer lambdas or `Invoke()` for custom behaviors rather than overusing macro-based actions.
- Avoid side effects or mutable state inside matchers — matchers must be *pure*.

---

## Common Pitfalls

- Overly strict matchers cause brittle tests.
- Using `Return()` with move-only types incorrectly (prefer lambdas for returns producing new objects).
- Forgetting to wrap reference parameters in `std::ref()` when invoking callables.
- Misordering `EXPECT_CALL` statements leads to surprising matcher precedence.
- Setting expectations after mock method invocation leads to undefined behavior.

---

## Troubleshooting

- Use `--gmock_verbose=info` to see detailed logs of mock calls, matched expectations, and actions performed.
- Verify you don’t have conflicting or duplicate expectations.
- Confirm reference qualifications and overload disambiguations (with `Const()`) are correctly used in expectations.
- Check that `WillByDefault` or `WillOnce` clauses are not missing when needed to provide return values.

---

## Summary

Matchers and actions are the core expressive constructs that enable GoogleMock to mimic, verify, and control complex behavior in unit tests. By combining intuitive matchers for argument validation with versatile actions for mock behavior, GoogleMock empowers you to write tests that clearly reflect expectations and produce predictable outcomes, all while keeping test code readable and maintainable.

---

## Related Links

- [Matchers Reference](/api-reference/matchers-actions/matchers)
- [Actions Reference](/api-reference/matchers-actions/actions)
- [Mocking Reference](docs/reference/mocking.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md)
- [gMock Cookbook](docs/gmock_cook_book.md)

