---
title: "Cardinalities, Ordering, and Constraints"
description: "Delve into controlling how many times mock methods are expected to be called, in what order, and with which permissible variations. This page explains cardinality specifications, call sequencing, and advanced constraint composition for rigorous test validation."
---

# Cardinalities, Ordering, and Constraints

Delve into controlling how many times mock methods are expected to be called, in what order, and with which permissible variations. This guide explains cardinality specifications, how to sequence calls, and how to use advanced constraints in GoogleMock to rigorously validate interactions.

---

## Understanding Cardinalities: Specifying Call Counts

Cardinalities define **how many times** a mock method is expected to be invoked. They help express the volume and flexibility of calls your test requires for a given method, allowing precise or fuzzy constraints.

### Key Cardinality Specifiers

Use the `Times()` clause in an `EXPECT_CALL` to set cardinalities:

- `AnyNumber()` – allows the method to be called any number of times (0 or more).
- `AtLeast(n)` – expects the method to be called at least _n_ times.
- `AtMost(n)` – expects the method to be called at most _n_ times.
- `Between(m, n)` – expects the method to be called between _m_ and _n_ times (inclusive).
- `Exactly(n)` or simply `n` – expects the method to be called exactly _n_ times. `Exactly(0)` means the method must not be called at all.

#### Default Behavior When Not Specified

If you omit the `Times()` clause, GoogleMock infers cardinality based on the presence of action clauses:

- No `WillOnce` or `WillRepeatedly`: defaults to `Times(1)`.
- _n_ `WillOnce` clauses with no `WillRepeatedly`: defaults to `Times(n)`.
- _n_ `WillOnce` clauses with one `WillRepeatedly` clause: defaults to `Times(AtLeast(n))`.

### Practical Examples

```cpp
using ::testing::AtLeast;
using ::testing::Exactly;
using ::testing::AnyNumber;
using ::testing::Return;

EXPECT_CALL(mock_obj, Foo())
    .Times(Exactly(3))
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));

EXPECT_CALL(mock_obj, Bar(_))
    .Times(AnyNumber())
    .WillRepeatedly(Return(false));

EXPECT_CALL(mock_obj, Baz())
    .Times(AtLeast(1));  // Expect Baz to be called at least once
```

### Cardinality Validations and Error Reporting

GoogleMock tracks call counts in relation to cardinalities, generating errors when:

- A method is called fewer times than specified (low call count).
- A method is called more times than allowed (over-saturation).

Helpful messages describe the expected and actual call counts in natural language:

- _Never called_ (0 calls)
- _Called once_
- _Called twice_
- _Called n times_

---

## Controlling Call Ordering

By default, the order in which expected calls occur doesn't matter — any expectation matching the arguments will handle the call.

But sometimes order matters to your test's correctness and intent. GoogleMock provides powerful features for controlling ordering.

### InSequence: Enforce Full Sequential Ordering

`InSequence` is a helper RAII object that makes all expectations declared within its scope occur sequentially.

Example:

```cpp
using ::testing::InSequence;

{
  InSequence seq;  // All expectations are put in one sequence
  EXPECT_CALL(mock_obj, Foo(1));  // Must happen first
  EXPECT_CALL(mock_obj, Bar(_));  // Must happen second
  EXPECT_CALL(mock_obj, Foo(2));  // Must happen last
}
```

### Explicit Sequences and Partial Ordering

GoogleMock supports arbitrary partial ordering with `Sequence` objects and the `InSequence()` clause on expectations. One or more `Sequence` instances can be declared and assigned to expectations to form execution order constraints.

Example:

```cpp
using ::testing::Sequence;
Sequence s1, s2;

EXPECT_CALL(mock_obj, Init()).InSequence(s1, s2);
EXPECT_CALL(mock_obj, Load()).InSequence(s1);
EXPECT_CALL(mock_obj, Start()).InSequence(s2);
```

This defines that `Init()` must occur before `Load()` and before `Start()`, but `Load()` and `Start()` may run in any order relative to each other.

### After Clause: Flexible Post-Conditions

The `.After()` clause lets you specify that a particular expectation should occur after one or more other expectations have been satisfied, enabling complex partial orderings expressed as a directed acyclic graph (DAG).

Example:

```cpp
using ::testing::Expectation;
Expectation e1 = EXPECT_CALL(mock_obj, Setup());
Expectation e2 = EXPECT_CALL(mock_obj, Configure());
EXPECT_CALL(mock_obj, Run()).After(e1, e2);
```

Here, `Run()` must be called only after both `Setup()` and `Configure()` have completed.

---

## Constraints and Advanced Control

### RetiresOnSaturation: Making Expectations Non-Sticky

By default, expectations remain active after reaching their upper bound, which means further matching calls trigger failures. Use `.RetiresOnSaturation()` to tell GoogleMock to retire the expectation immediately when saturated. This allows other expectations to match subsequent calls instead.

Example:

```cpp
EXPECT_CALL(mock_obj, Save()).Times(2).RetiresOnSaturation();
EXPECT_CALL(mock_obj, Save()).Times(AnyNumber());
```

The first two calls to `Save()` match the first expectation, which then retires. Subsequent calls match the second expectation.

### Combining Clauses

GoogleMock expectations support chaining clauses to express rich behavior:

```cpp
EXPECT_CALL(mock_obj, Process(_))
    .Times(AtLeast(1))
    .InSequence(s1)
    .After(e1, e2)
    .WillOnce(Return(true))
    .WillRepeatedly(Return(false))
    .RetiresOnSaturation();
```

Each clause has restrictions on where it can appear and how many times.

---

## Best Practices and Troubleshooting

### Ordering Tips

- Use `InSequence` when you want strict sequential order for a block of expectations.
- Use explicit `Sequence` objects plus `InSequence` for partial orders where some calls must occur before others, but ordering between some calls is flexible.
- Use `.After()` to impose ad-hoc dependencies.

### Cardinality Recommendations

- Avoid overly strict exact cardinals unless the precise number of calls is critical.
- Use `AtLeast()` or `Between()` to allow flexibility.
- Remember that uninformed omission of `Times()` assumes exactly one call unless overridden by actions.

### Common Pitfalls

- Forgetting to place `RetiresOnSaturation()` on expectations with limited cardinalities can cause unintuitive 'sticky' behavior, leading to failures on additional calls.
- Declaring multiple `Times()` clauses in a single expectation triggers errors.
- Placing `Times()` after `InSequence()` is not allowed.
- Misordering clauses violates the well-defined syntax; `With()` must appear first.

### Diagnostics

When a test fails due to unmet cardinalities or order violations, GoogleMock emits detailed messages explaining expectations vs actual calls, including call counts and ordering constraints.

Use the `--gmock_verbose=info` flag to see detailed expectation and mock call logs to aid diagnosis.

---

## Summary

Controlling cardinalities, call ordering, and constraints in GoogleMock is vital for expressing precise and robust test expectations. Using `Times()` with cardinalities shapes the frequency of expected calls. Sequencing with `InSequence` and `After` lets you express execution order dependencies, while `RetiresOnSaturation()` manages expectation stickiness for flexible test flows.

By mastering these controls, you ensure your mocks enforce the interaction contracts your code relies on, catching deviations exactly when and how you intend.

---

## Additional Resources

- [Mocking Reference](../reference/mocking.md) - comprehensive reference for mock usage
- [gMock Cookbook: Setting Expectations](../gmock_cook_book.md#setting-expectations)
- [Expectations, Actions, and Call Sequencing API Reference](../api-reference/gmock-api/expectations-and-sequencing.md)
- [Matchers Reference](../reference/matchers.md) for argument matching
- [Actions Reference](../reference/actions.md) for specifying mock behaviors

---

## Code Examples Reference

```cpp
// Expect exactly 3 calls, returning 1, 2, and 3 in order
EXPECT_CALL(mock, Func())
    .Times(Exactly(3))
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));

// Partial ordering using Sequences
Sequence s1, s2;
EXPECT_CALL(mock, Initialize()).InSequence(s1, s2);
EXPECT_CALL(mock, Load()).InSequence(s1);
EXPECT_CALL(mock, Start()).InSequence(s2);

// Expectation depending on prior calls
Expectation e_setup = EXPECT_CALL(mock, Setup());
Expectation e_config = EXPECT_CALL(mock, Configure());
EXPECT_CALL(mock, Run()).After(e_setup, e_config);

// Retiring a sticky expectation
EXPECT_CALL(mock, Save()).Times(2).RetiresOnSaturation();
EXPECT_CALL(mock, Save()).Times(AnyNumber());
```
