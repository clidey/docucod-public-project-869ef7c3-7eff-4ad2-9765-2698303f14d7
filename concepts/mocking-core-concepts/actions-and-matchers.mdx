---
title: "Actions and Matchers"
description: "Discover the dual roles of actions (what a mock method does) and matchers (how arguments are validated) in the GoogleMock ecosystem. Learn how user-defined and built-in actions/matchers contribute to test clarity and reduce brittleness."
---

# Actions and Matchers

Explore the fundamental dual pillars of the GoogleMock ecosystem: **actions**, which define what a mock method does when invoked, and **matchers**, which determine how arguments are validated. Mastering these concepts empowers you to craft tests that are both clear in intent and robust against brittle failures.

---

## Understanding Actions: Defining Mock Method Behavior

When you mock a method, it exists without a real implementation. **Actions** specify what should happen when that method is called — whether it returns a specific value, invokes a callback, throws an exception, or performs side effects.

### The Role of Actions

- Provide mock methods with concrete behaviors.
- Control return values and side effects.
- Enable dynamic behavior conditional on input in sophisticated tests.

### Default Actions vs Explicit Actions

- **Default Actions:** Without explicit instructions, mock methods return default values (`void` returns do nothing, `bool` returns `false`, numeric types return `0`, etc.).
- **ON_CALL:** Defines the *default* behavior when a method is called but without an expectation to verify the call occurs.
- **EXPECT_CALL:** Defines both the expectation that the method will be called *and* the actions to perform.

### Common Built-In Actions

| Action                    | Description                                                      |
|---------------------------|------------------------------------------------------------------|
| `Return(value)`           | Mock method returns `value`.                                     |
| `ReturnRef(variable)`     | Returns a reference to `variable`.                              |
| `ReturnPointee(ptr)`      | Returns the value pointed to by `ptr`.                          |
| `DoDefault()`             | Performs the default action (e.g., from `ON_CALL`).             |
| `Invoke(callable)`        | Calls a function, functor, or lambda with the mock call’s args. |
| `InvokeWithoutArgs(f)`    | Calls a callable without any arguments.                         |
| `SetArgPointee<N>(val)`  | Sets the value pointed to by the N-th argument to `val`.        |
| `DeleteArg<N>()`          | Deletes the N-th argument if it’s a pointer.                    |
| `DoAll(a1, a2, ..., an)` | Performs multiple actions in sequence, returns the last result. |

### Example: Defining Actions in Tests

```cpp
using ::testing::Return;
using ::testing::Invoke;

EXPECT_CALL(mock_obj, GetNumber())
  .WillOnce(Return(10))
  .WillOnce(Return(20))
  .WillRepeatedly(Return(30));

EXPECT_CALL(mock_obj, Process(_))
  .WillOnce(Invoke([](int x) {
    std::cout << "Processing " << x << std::endl;
  }));
```

- First call to `GetNumber` returns `10`, second returns `20`, and all subsequent calls return `30`.
- `Process` logs processed values on the first call.


---

## Grasping Matchers: Specifying Argument Validation

**Matchers** let you define the constraints on method arguments that you expect in your tests. They are predicates that verify if the given argument satisfies certain conditions.

### Purposes of Matchers

- Ensure mock methods are called with the right arguments.
- Make tests expressive and intention-revealing.
- Avoid brittleness by allowing flexible argument validation.

### Using Built-In Matchers

- **Wildcard `_`**: Matches any value. Use when argument value doesn’t matter.
- **`Eq(value)`**: Matches equality with `value`.
- **Relational matchers**: `Lt(x)`, `Le(x)`, `Gt(x)`, `Ge(x)`, etc.
- **Container matchers**: `ElementsAre(...)`, `UnorderedElementsAre(...)`, `Contains(...)`.
- **Pointer matchers**: `IsNull()`, `NotNull()`, `Pointee(matcher)`.
- **Composite matchers**: Combine multiple matchers via `AllOf()`, `AnyOf()`, `Not()`.

### Matcher Usage in Expectations

Matchers appear within `EXPECT_CALL` or `ON_CALL` argument lists, making the expectation conditional on argument patterns:

```cpp
EXPECT_CALL(mock_obj, Foo(Ge(10), _)); // First arg >= 10, second arg anything
EXPECT_CALL(mock_obj, Bar(ElementsAre(1, 2, 3))); // Argument must be exactly {1,2,3}
EXPECT_CALL(mock_obj, Baz(Pointee(Eq(42)))); // Pointer argument pointing to 42
```

### Combining Matchers as a Whole with `.With()`

Sometimes matching individual arguments isn’t enough. `.With()` lets you capture a predicate over **all arguments as a whole** — useful for dependencies between parameters (e.g., one argument less than another). For example:

```cpp
EXPECT_CALL(mock_obj, Update(_, _))
  .With(Lt());  // Asserts first argument less than second
```

Here, `Lt()` is a built-in matcher comparing two-element tuples.

---

## Writing Clear and Robust Tests with Actions and Matchers

### Crafting Intent-Focused Expectations

- Use **matchers to specify only what matters**—avoid over-specifying.
- Leverage `_` when argument values are irrelevant to the test goal.
- Express argument interdependencies with `.With()`.

### Controlling Call Count with Cardinalities

- Use `.Times()` to specify exact or range of expected calls.
- Combine with `WillOnce`, `WillRepeatedly` to specify different behaviors across calls.

### Sequencing and Ordering

- Use `InSequence` and `.After()` to impose call order constraints.
- Sequences combined with actions and matchers give precise control over test interaction flow.

### Default Actions vs Expectations

- Use `ON_CALL` for setting defaults without asserting calls happen.
- Use `EXPECT_CALL` when you want to verify that calls actually occur as expected.

### Handling Uninteresting and Unexpected Calls

- Uninteresting calls (calls without expectations) use default action; may warn.
- Strict mocks (`StrictMock`) treat uninteresting calls as errors.
- Nice mocks (`NiceMock`) suppress warnings on such calls.

---

## Troubleshooting Common Pitfalls

### 1. Overly Strict Matchers Cause Brittle Tests

Avoid exact values unless necessary. Replace with broader constraints or wildcards where appropriate.

### 2. Action Side Effects Evaluated Once

Actions like `Return(n++)` are evaluated **once** when setting up expectations, not each time called. Use lambdas or custom actions for dynamic behavior.

### 3. Order of Expectations Matters

Later `EXPECT_CALL` statements override earlier ones for overlapping argument matchers.

### 4. Matcher Types Must Align

Ensure matcher types match argument types. Use `SafeMatcherCast` or specify types explicitly if needed.

### 5. Missing `MOCK_METHOD` on Virtual Methods

Only virtual methods can be mocked. Confirm methods are virtual and properly mocked.

### 6. Missing Virtual Destructor

Base classes must have virtual destructors to avoid undefined behavior when deleting mocks.

---

## Summary

Actions and matchers in GoogleMock serve as the heart of interaction-based testing: matchers confirm your code calls mocks correctly, actions define how mocks behave in response. Together, they make tests expressive, controllable, and maintainable.

---

## Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Beginner-friendly introduction to mocking.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — Details on macros like `EXPECT_CALL` and `ON_CALL`.
- [Actions Reference](https://google.github.io/googletest/reference/actions.html) — Comprehensive list of built-in actions.
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) — In-depth on matchers and usage.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Recipes for advanced mocking patterns.
- [Mock Strictness Guide](https://google.github.io/googletest/gmock_cook_book.html#the-nice-strict-and-the-naggy) — Controlling uninteresting call behavior.

---

<Tip>
Use `EXPECT_CALL` for *verifying* calls and `ON_CALL` for *specifying default behaviors without verification.* This distinction helps prevent brittle tests and clarifies test intent.
</Tip>

<Tip>
Leverage matchers like `_` liberally to specify only what matters in arguments — it improves readability and reduces brittleness.
</Tip>

<Tip>
Combine `WillOnce()` with a sequence of actions to specify detailed behaviors across calls; use `RetiresOnSaturation()` to retire expectations after they are satisfied.
</Tip>

<Tip>
Use `InSequence` and `.After()` clauses carefully to assert call orders when that order impacts correctness.
</Tip>
