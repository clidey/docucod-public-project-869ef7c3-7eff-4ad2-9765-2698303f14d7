---
title: "Actions and Matchers: Shaping Mocked Behavior"
description: "Discover how actions and matchers provide flexible mechanisms to control the output and behavior of mock methods. Explore the spectrum from simple return values to complex, user-defined actions and argument matching strategies."
---

# Actions and Matchers: Shaping Mocked Behavior

GoogleMock provides a powerful and flexible mechanism to control the behavior of mock methods and validate their invocation arguments: **actions** and **matchers**. Together, they let you shape what a mocked function does when called and define precisely which calls are expected.

---

## Understanding Actions: Defining What Mock Methods Do

An **action** specifies what happens when a mock method is invoked. This could be as simple as returning a fixed value or as complex as running custom functions, performing side effects, or even calling callbacks.

### The Role of Actions in Mocks

Imagine your mock method as a programmable stub waiting for instructions:

- When called, what value should it return?
- Should it modify some arguments?
- Should it invoke another function or simulate an asynchronous callback?

Actions nearly always accompany `EXPECT_CALL()` or `ON_CALL()` statements to define such behaviors.

### Common Built-in Actions

GoogleMock ships with many built-in actions that cover typical use cases:

| Action                  | Description                                                                                             |
|-------------------------|-----------------------------------------------------------------------------------------------------|
| `Return(value)`         | Return the specified value.                                                                            |
| `ReturnRef(variable)`   | Return a reference to the given variable.                                                             |
| `ReturnPointee(ptr)`    | Return the value pointed to by a pointer.                                                             |
| `ReturnNew<T>(...)`     | Return a new instance of `T` created with the given constructor arguments each time.                  |
| `ReturnNull()`          | Return a null pointer.                                                                                 |
| `DoDefault()`           | Executes the default action as specified by `ON_CALL()` or the built-in default.                      |
| `DoAll(...)`            | Perform a sequence of actions in order and return the result of the last one.                         |
| `SetArgPointee<N>(value)` | Assign `value` to the object pointed to by the N-th argument (indexing from zero).                  |
| `Invoke(f)`             | Invoke a callable (`function`, `lambda`, `functor`) with the arguments of the mock method.            |
| `InvokeWithoutArgs(f)`  | Invoke a callable that takes no arguments, ignoring the mock method parameters.                        |
| `InvokeArgument<N>(args...)` | Call the N-th argument (which must be a callable) of the mock method with the specified arguments.  |
| `IgnoreResult(action)`  | Perform `action` but ignore its return value (useful if the mock method returns void).                 |


### Example: Specifying Return Values and Side Effects

```cpp
using ::testing::Return;
using ::testing::SetArgPointee;
using ::testing::DoAll;

class MockFoo {
 public:
  MOCK_METHOD(bool, Mutate, (int* value), (override));
};

TEST(MyTest, SideEffectExample) {
  MockFoo mock;
  EXPECT_CALL(mock, Mutate(_))
      .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));

  int x = 0;
  EXPECT_TRUE(mock.Mutate(&x));
  EXPECT_EQ(x, 42);
}
```

### Defining Custom Actions

If the built-in actions don’t fulfill your needs, you can define custom actions using:

- Lambdas or functor objects compatible with the signature of your mock method.
- `Invoke()` to call existing functions or methods.
- The `ACTION()` macros for concise action definitions.
- `MakePolymorphicAction()` for reusable polymorphic actions.

For example:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int n) { return n * 10; });
```

### Important Tips for Actions

- Actions are evaluated **once** when expectations are set. To produce different results on consecutive calls, chain multiple `WillOnce()` with different actions.
- For mutable state across calls, consider capturing external variables by reference in lambdas.
- Use `IgnoreResult()` when you want to ignore the result of an action.

---

## Matchers: Specifying Expected Argument Patterns

A **matcher** is a predicate that checks whether a mock method argument meets certain criteria. Matchers let you express detailed constraints on arguments beyond simple equality.

### Using Matchers in Expectations

Matchers appear inside `EXPECT_CALL` and `ON_CALL` macros:

```cpp
EXPECT_CALL(mock, Process(
    Ge(10),            // First argument >= 10
    HasSubstr("foo"), // Second argument contains "foo"
    _                 // Third argument can be anything
));
```

If you omit arguments and your method is not overloaded, it matches calls with any arguments.

### Built-in Matchers

GoogleMock includes a rich set of built-in matchers:

| Matcher                | Description                                    |
|------------------------|------------------------------------------------|
| `_`                    | Matches anything (wildcard).                    |
| `Eq(value)`            | Matches values equal to `value`.                |
| `Ne(value)`            | Matches values that are not equal to `value`.   |
| `Lt(value)`            | Less than (`<`) `value`.                         |
| `Le(value)`            | Less than or equal (`<=`) to `value`.           |
| `Gt(value)`            | Greater than (`>`) `value`.                      |
| `Ge(value)`            | Greater than or equal (`>=`) to `value`.        |
| `Not(matcher)`         | Negation of `matcher`.                           |
| `AllOf(m1, m2, ...)`   | All of the matchers must be satisfied.          |
| `AnyOf(m1, m2, ...)`   | Any of the matchers must be satisfied.          |
| `Contains(substring)`  | String/array contains a substring.               |
| `StartsWith(value)`    | Checks string starts with `value`.               |
| `EndsWith(value)`      | Checks string ends with `value`.                  |
| `Pointee(matcher)`     | Matches pointer arguments if the pointee matches.| 

### Handling Overloads and Const Methods

To specify which overload you mean in cases where the method is overloaded, use:

- The `Const()` wrapper for const-qualified methods.
- Casting matchers or specifying argument types explicitly.

Example:

```cpp
EXPECT_CALL(Const(mock), GetValue()); // For const GetValue()
EXPECT_CALL(mock, GetValue());        // For non-const GetValue()
```

### Complex Argument Matching

You can match multiple arguments as a whole using `.With()` with a tuple matcher:

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .With(Lt()); // First argument less than second
```

Use `Args<>()` to select specific argument subsets and match them.

### Writing Custom Matchers

If built-in matchers don’t suffice, define custom matchers using `MATCHER()` or the matcher interface.

Example:

```cpp
MATCHER(IsEven, "checks if number is even") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock, Bar(IsEven()));
```

These produce descriptive failure messages that help debug test failures.

### Tips for Matchers

- Matchers must be *pure functions* with no side effects.
- Use `_` for arguments you don’t care about.
- Compose matchers with `AllOf()`, `AnyOf()`, and `Not()`.

---

## Putting It All Together: Workflow Example

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::Ge;

class MockTurtle {
 public:
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
};

TEST(DrawTest, DrawsAtOrigin) {
  MockTurtle turtle;

  // Expect GetX() to be called twice, first returning 0 then 100.
  EXPECT_CALL(turtle, GetX())
      .WillOnce(Return(0))
      .WillOnce(Return(100));

  // Expect GoTo() to be called with x >= 0 and any y.
  EXPECT_CALL(turtle, GoTo(Ge(0), _));

  // Exercise
  turtle.GoTo(0, 0);
  int x1 = turtle.GetX();  // returns 0
  int x2 = turtle.GetX();  // returns 100

  EXPECT_EQ(x1, 0);
  EXPECT_EQ(x2, 100);
}
```

---

## Troubleshooting Common Pitfalls

- **Uninteresting calls warning:** Occurs when a mock method is called but no `EXPECT_CALL` matches it. Use `ON_CALL()` to provide default behavior or wrap your mock in `NiceMock<>`.
- **Multiple matching expectations:** Remember that the *last* matching expectation overrides older ones.
- **Sticky expectations:** Expectations remain active even after being saturated, unless `RetiresOnSaturation()` or sequencing is used.
- **Order of clauses:** Follow the required order for clauses (e.g., `.With()` first, `.Times()`, then `.InSequence()` or `.After()`). Misordering causes runtime errors.

---

## Additional Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for recipes on using actions and matchers.
- [Matchers Reference](reference/matchers.md) for a complete list of built-in matchers.
- [Actions Reference](reference/actions.md) for detailed action APIs.
- [gMock for Dummies](docs/gmock_for_dummies.md) for beginner-friendly guidance.
- [Mocking and Setting Expectations Guide](guides/core-testing-workflows/mocking-and-expectations.mdx) for comprehensive mock usage.
- [Strictness Policies](api-reference/gmock-mocking-apis/strictness-policies.md) to understand NiceMock, NaggyMock, and StrictMock.

---
