---
title: "Expectations, Actions & Cardinalities"
description: "Examine how to specify, combine, and verify expectations on mock methods, including the use of matchers, actions, sequences, and cardinality constraints. Explains ON_CALL, EXPECT_CALL, and advanced techniques for deterministic and flexible behavioral tests."
---

# Expectations, Actions & Cardinalities

Explore how to specify, combine, and verify expectations on mock methods in GoogleMock. This page focuses on the usage of matchers, actions, sequences, and cardinality constraints to create deterministic and flexible behavioral tests. You'll learn about the key macros `ON_CALL` and `EXPECT_CALL`, how to write advanced expectation clauses, manage call sequences, and control invocation counts.

---

## Understanding Expectations on Mock Methods

At the core of GoogleMock’s functionality is the ability to define how you expect mock methods to be called during your tests. Expectations tell the framework:

- Which method is expected to be called
- What argument values it should receive
- How many times it should be called (cardinality)
- What actions to perform when called
- In which order calls are expected (sequences & ordering)

Contrasting expectations set by `EXPECT_CALL` with default behaviors set by `ON_CALL` is essential:

- `EXPECT_CALL`: Specifies an expectation that the mock method will be called matching certain criteria, and verifies that this happens.
- `ON_CALL`: Specifies default behavior for when a mock method is called, but does *not* imply any expectation about whether it will be called.

Typically, `ON_CALL` is used to provide fallback or default behavior across all calls, while `EXPECT_CALL` asserts specific expected interactions.

---

## Specifying Expectations with `EXPECT_CALL`

The primary macro to declare an expectation on a mock method is:

```cpp
EXPECT_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)    // Optional
    .Times(cardinality)              // Optional
    .InSequence(sequences...)        // Optional
    .After(expectations...)          // Optional
    .WillOnce(action)                // Zero or more times
    .WillRepeatedly(action)          // Optional
    .RetiresOnSaturation();          // Optional
```

### The `matchers...` List

Each argument to the method can be matched by a matcher that specifies acceptable values. For example, `_` matches anything, while `Eq(5)` matches only the value 5. You can omit the argument list entirely for non-overloaded methods to match any arguments.

### `.With(multi_argument_matcher)`

This single optional clause matches all arguments together as a tuple. For instance, you might require that the first argument is less than the second:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());
```

The matcher here applies to the tuple of arguments rather than individually.

### `.Times(cardinality)`

Controls how many times the mock method is expected to be called. Cardinalities include:

| Cardinality       | Meaning                         |
|-------------------|--------------------------------|
| `AnyNumber()`     | Any number of calls accepted   |
| `AtLeast(n)`      | At least *n* calls             |
| `AtMost(n)`       | At most *n* calls              |
| `Between(m, n)`   | Between *m* and *n* calls      |
| `Exactly(n)` or `n` | Exactly *n* calls               |

If `.Times()` is omitted, the cardinality is inferred based on action clauses:

- No `WillOnce` or `WillRepeatedly` => once
- n `WillOnce` and no `WillRepeatedly` => exactly n
- n `WillOnce` and one `WillRepeatedly` => at least n

### Call Sequences: `.InSequence` and `.After`

Ordering constraints can enforce that expectations occur in some partial or total order.

- `.InSequence(sequence1, sequence2, ...)` assigns the expectation to one or more sequences, meaning the expectations in the same sequence must be matched in the order declared.

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Reset()).InSequence(s1, s2);
EXPECT_CALL(mock, GetSize()).InSequence(s1);
EXPECT_CALL(mock, Describe()).InSequence(s2);
```

- `.After(expectation1, expectationSet, ...)` requires that the expectation only matches after specified other expectations have been satisfied.

```cpp
Expectation init_x = EXPECT_CALL(mock, InitX());
Expectation init_y = EXPECT_CALL(mock, InitY());
EXPECT_CALL(mock, Describe()).After(init_x, init_y);
```

Both clauses can be used multiple times on the same expectation.

### Actions: `.WillOnce` and `.WillRepeatedly`

Specify what the mock method will do when called.

- `.WillOnce(action)` specifies the action for a single call. Multiple `WillOnce` clauses can be chained for successive calls.

- `.WillRepeatedly(action)` specifies the action for all calls after the `WillOnce` actions are exhausted.

If no actions are specified, the default action is used (see below).

### `.RetiresOnSaturation()`

Indicates that once the expectation is saturated (its call limit reached), it becomes inactive (retires) and does not match further calls. This allows other expectations to take precedence after saturation.

---

## Specifying Default Behavior with `ON_CALL`

Use `ON_CALL` to set default behaviors on mock methods without asserting that calls must occur:

```cpp
ON_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);
```

### When to Use `ON_CALL`

- To specify default return values or side effects for methods when you do not want to enforce specific expectations.
- To provide common behavior broadly applied for all calls not covered by `EXPECT_CALL`.

### Behavior Precedence

- If multiple `ON_CALL`s match a call, the *last* declared matching default action takes effect.
- If an `EXPECT_CALL` matches the call, its action takes precedence over any matching `ON_CALL`.

---

## Call Cardinalities in Detail

GoogleMock's cardinality system is foundational to specifying call counts. Here are the key cardinalities:

- `AnyNumber()`: no limit on calls
- `Exactly(n)`: call count must be exactly *n*
- `AtLeast(n)`: call count must be at least *n*
- `AtMost(n)`: call count at most *n*
- `Between(m, n)`: between *m* and *n* inclusive

### Practical Tips

- Use `Times(0)` to explicitly disallow calls.
- Use `Times(AnyNumber())` for catch-all expectations.
- If you use `WillOnce` clauses but no `Times`, cardinality defaults to the number of `WillOnce` clauses.
- Use `RetiresOnSaturation()` to prevent a saturated expectation from blocking other matching expectations.

---

## Combining Multiple Expectations and Overriding

By default, GoogleMock searches expectations in *reverse declaration order* and picks the *last* matching active expectation. This lets you set broad default expectations early and specialize later:

```cpp
EXPECT_CALL(turtle, Forward(_));           // Default catch-all
EXPECT_CALL(turtle, Forward(10)).Times(2);  // More specific
```

Order matters. More specific expectations should come last.

### Sticky Expectations

Expectations remain *active* after being saturated, unless retired explicitly or via `RetiresOnSaturation` or sequence logic.

Consider this bad example:

```cpp
for (int i = n; i > 0; i--) {
  EXPECT_CALL(turtle, GetX())
      .WillOnce(Return(10 * i));  // Last expectation shadows earlier ones
}
```

Use `RetiresOnSaturation()` or sequences to ensure expectations fade out after use.

---

## Ordering Calls with Sequences

To enforce a strict order in call sequences, place expectations in an `InSequence` block or assign them to `Sequence` objects:

```cpp
using ::testing::InSequence;
InSequence s;
EXPECT_CALL(mock, Foo(1));
EXPECT_CALL(mock, Foo(2));
```

To specify partial orders with arbitrary DAGs, use multiple sequences or the `.After()` clause.

---

## Default Actions and Uninteresting Calls

- Mock methods have built-in default return values (e.g., zero, false, or default-constructed values).
- If no `ON_CALL` is specified, default actions apply.
- Uninteresting calls (calls without matching `EXPECT_CALL`) produce warnings by default.
- Use `NiceMock<T>` to suppress these warnings.
- Use `StrictMock<T>` to treat uninteresting calls as failures.

---

## Practical Examples

### Expecting Calls Exactly Twice with Specific Returns

```cpp
using ::testing::Return;
EXPECT_CALL(turtle, GetX())
    .Times(2)
    .WillOnce(Return(100))
    .WillOnce(Return(150));
```

### Setting Default Behavior

```cpp
using ::testing::Return;
ON_CALL(turtle, GetX())
    .WillByDefault(Return(42));
```

### Using Sequences to Enforce Order

```cpp
using ::testing::Sequence;
Sequence s1, s2;
EXPECT_CALL(mock, A()).InSequence(s1, s2);
EXPECT_CALL(mock, B()).InSequence(s1);
EXPECT_CALL(mock, C()).InSequence(s2);
```

### Using `.After()` to Define Partial Orders

```cpp
Expectation e1 = EXPECT_CALL(mock, First());
EXPECT_CALL(mock, Second()).After(e1);
```

---

## Common Pitfalls and Best Practices

- Always declare expectations before exercising the mock to avoid undefined behaviors.
- Avoid over-specifying argument matchers — be as general as possible to reduce brittleness.
- Use `.RetiresOnSaturation()` to prevent saturated expectations from blocking other calls.
- Use sequences and `.After()` clauses judiciously to enforce call orders.
- Use warnings and verbosity flags (`--gmock_verbose`) to help diagnose why expectations fail.

---

## Troubleshooting

### Too Many or Too Few Actions Warning

If the number of `WillOnce()` clauses does not match cardinality constraints, GoogleMock warns:

- Too many actions for the specified cardinality
- Too few actions without `WillRepeatedly()` clause

### Unexpected or Excessive Call Failures

- Calls that don't match any expectation cause failures.
- Calls that exceed `Times(...)` cardinality produce over-saturation errors.

### Uninteresting Calls

Warnings are printed for calls to mock methods without `EXPECT_CALL`.
Suppress this if expected by using `NiceMock` or an `EXPECT_CALL(...).Times(AnyNumber())` catchall.

---

## Summary

- Use `MOCK_METHOD` macros in mock classes to define mock methods.
- Set behaviors with `ON_CALL` for default actions.
- Enforce call expectations with `EXPECT_CALL`.
- Use argument matchers to specify expected arguments.
- Control call counts using `Times()` and cardinalities.
- Use `.WillOnce()`, `.WillRepeatedly()` to specify actions on calls.
- Control call order with `.InSequence()` and `.After()`.
- Use `.RetiresOnSaturation()` to retire expectations when saturated.
- Warnings and errors guide enforcing correct mock usage.

---

For detailed usage, advanced patterns, and code examples, see the [Mocking Reference](reference/mocking.md) and the [gMock Cookbook](gmock_cook_book.md).

---