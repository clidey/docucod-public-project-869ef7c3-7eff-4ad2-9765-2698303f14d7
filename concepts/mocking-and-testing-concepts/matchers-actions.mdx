---
title: "Matchers and Actions: Matching Behavior and Producing Results"
description: "Understand how matchers are used to express complex argument validations in mocks, and how actions determine what a mock method does when invoked, allowing detailed customization for test scenarios."
---

# Matchers and Actions: Matching Behavior and Producing Results

Understanding how mock methods interact with their arguments and behave upon invocation is fundamental to writing effective tests using GoogleMock. This guide covers how **matchers** are used to express sophisticated validations on mock function arguments, and how **actions** specify the responses mock functions produce. Together, they form the foundation of mock behavior customization.

---

## Matchers: Expressing Argument Constraints

Matchers describe the conditions arguments must satisfy for a mock expectation to trigger. They serve as predicates that allow you to specify not only exact values, but also complex conditions, ranges, patterns, and structural validations.

### Simple Matchers and Wildcards

- Use literals (e.g., `5`) to match exact values.
- Use the wildcard matcher `_` to accept any value for an argument.

Example:
```cpp
EXPECT_CALL(mock, Process(5));      // Exact match argument equals 5
EXPECT_CALL(mock, Process(_));      // Any argument accepted
```

### Composing Matchers

Match multiple conditions combinatorially using:

- `AllOf()`: all sub-matchers must match.
- `AnyOf()`: any sub-matcher must match.
- `Not()`: negates a matcher.

Example:
```cpp
EXPECT_CALL(mock, Process(AllOf(Ge(5), Le(10))));  // Argument between 5 and 10
EXPECT_CALL(mock, Process(Not(Eq(0))));            // Argument not equal to 0
```

### Matching Complex Types

Matchers support:

- Validating members via `Field()` and properties via `Property()`;
- Matching container contents using `ElementsAre()`, `UnorderedElementsAre()`;
- Validating pointers with `NotNull()`, `IsNull()`, and `Pointee()`.

Example:
```cpp
EXPECT_CALL(mock, SaveData(Field(&Data::id, Ge(100))));
EXPECT_CALL(mock, ProcessVector(ElementsAre(1, 2, 3)));
EXPECT_CALL(mock, UsePointer(Pointee(Eq(5))));
```

### Multi-Argument Matchers

You can impose constraints over multiple arguments collectively using the `.With()` clause in `EXPECT_CALL` or `ON_CALL`. This allows matching on combined argument states beyond individual conditions.

Example:
```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // First argument less than second
```

### Safe Matcher Casting and Overload Resolution

- Use `SafeMatcherCast<T>()` to convert matchers when type conversions are needed but enforced safely.
- To disambiguate overloaded methods, use type-specific matchers or wrappers like `Const()`.

Example:
```cpp
EXPECT_CALL(mock, OverloadedMethod(SafeMatcherCast<Derived*>(base_matcher)));
EXPECT_CALL(Const(mock), OverloadedMethod(5));
```

### Writing Custom Matchers

Define expressive yet reusable custom predicates using:

- Quick macros like `MATCHER` and `MATCHER_P`.
- Full matcher classes implementing the matcher interface.

Example:
```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}
EXPECT_CALL(mock, Process(IsDivisibleBy7()));
```

---

## Actions: Controlling Mock Method Behavior

Actions determine what the mock method does when called and can define return values, side effects, invocation sequences, and complex interactions.

### Common Built-in Actions

| Action                           | Description                                       |
|---------------------------------|--------------------------------------------------|
| `Return(value)`                 | Return the specified value.                       |
| `ReturnRef(variable)`           | Return a reference to variable.                   |
| `ReturnPointee(pointer)`        | Return the value pointed at by pointer.          |
| `DoDefault()`                   | Perform the default action.                       |
| `Invoke(function)`              | Call a function or functor with the mock args.   |
| `SetArgPointee<N>(value)`       | Set the `N`th argument's pointed value.          |
| `SetArrayArgument<N>(start,end)`| Copy array range to the `N`th argument.          |
| `DeleteArg<N>()`                | Deletes the pointer given as the `N`th argument. |
| `DoAll(action1, ..., actionN)` | Performs multiple actions sequentially.           |
| `IgnoreResult(action)`          | Ignores the return value of an action.            |

### Defining Default Behavior with `ON_CALL`

`ON_CALL()` sets what happens when a mock method is invoked but does *not* require an expectation that it must be called. It configures fallback or usual behavior.

Example:
```cpp
ON_CALL(mock, GetName()).WillByDefault(Return("default"));
```

### Specifying Expected Calls with `EXPECT_CALL`

`EXPECT_CALL()` configures behavior and sets expectations for how a mock method should be invoked. It supports chaining of clauses such as:

- `.Times()` to specify call counts;
- `.WillOnce()` and `.WillRepeatedly()` to specify return values or actions;
- `.InSequence()` and `.After()` to enforce call ordering;
- `.RetiresOnSaturation()` to deactivate expectations once fulfilled.

Example:
```cpp
EXPECT_CALL(mock, GetData(_))
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### Using Functions, Lambdas, and Functors as Actions

You can use any callable compatible with the mocked method's signature as an action.

Example:
```cpp
EXPECT_CALL(mock, Calculate(_))
    .WillOnce([](int x) { return x*2; });
```

### Combining Multiple Actions

Use `DoAll()` to perform several actions with a single call. The last action's result is used as the return value.

Example:
```cpp
EXPECT_CALL(mock, FillBuffer(_))
    .WillOnce(DoAll(SetArrayArgument<0>(data, data + size), Return(true)));
```

### Influencing Mock Behavior Based on State

Actions can link to external state or modify output arguments to simulate side effects. Use saving helpers (`SaveArg`, `SetArgPointee`) or lambdas capturing external variables.

Example:
```cpp
int called_count = 0;
EXPECT_CALL(mock, Process(_))
    .WillRepeatedly([&called_count](int arg) {
      called_count++;
      return arg + 1;
    });
```

### Delegation to Real Objects or Fakes

You can delegate calls to a real or fake instance to maintain realistic behavior while still setting expectations.

Example:
```cpp
ON_CALL(mock, Compute(_)).WillByDefault([&real](int x) { return real.Compute(x); });
```

### Special Considerations for Move-Only Types

Mock methods handling move-only types like `std::unique_ptr` require using lambdas or callables in actions since `Return()` with moved values can only be invoked once.

Example:
```cpp
EXPECT_CALL(mock, MakeObject())
    .WillRepeatedly([] { return std::make_unique<MyObject>(); });
```

---

## Matcher and Action Interaction Flow

When a mock method is called:

1. GoogleMock evaluates all expectations (`EXPECT_CALL`) in reverse order, selecting the first matching expectation where all argument matchers succeed.
2. If no matching expectation exists, it checks for default behavior (`ON_CALL`).
3. If no default behavior exists, it applies built-in default actions.
4. The selected action is executed, producing return value or side effects.
5. If call counts exceed specified cardinalities, GoogleMock reports failures or warnings.

This flow ensures precise control over when and how mocked methods respond to calls, enabling robust verification of interactions.

---

## Best Practices and Common Pitfalls

- Use `.With()` for complex argument state across multiple parameters.
- Prefer `ON_CALL` to define default behavior and minimal `EXPECT_CALL`s to verify critical interactions.
- Use `NiceMock` to silence warnings on uninteresting calls when appropriate; use `StrictMock` to enforce strict call expectations.
- Always place `MOCK_METHOD` declarations in the `public:` section, even if mocking protected or private base class methods.
- Use `.RetiresOnSaturation()` or sequences to avoid sticky expectations causing conflicts.
- Avoid over-specifying matchers to prevent brittle tests.
- When mocking overloaded methods, specify argument lists or use `using` declarations to avoid hiding base methods.

---

## Practical Examples

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, Add, (int x, int y), (override));
  MOCK_METHOD(void, Reset, (), (override));
};

TEST(MockFooTest, ReturnsCustomValues) {
  MockFoo mock;

  EXPECT_CALL(mock, Add(_, _))
      .WillOnce(Return(3))
      .WillRepeatedly([](int x, int y) { return x + y; });

  EXPECT_EQ(3, mock.Add(1, 2));  // First call returns 3
  EXPECT_EQ(7, mock.Add(3, 4));  // Subsequent calls return sum
}

TEST(MockFooTest, UsesMatchersForArgumentValidation) {
  MockFoo mock;

  EXPECT_CALL(mock, Add(Gt(0), Lt(0)))  // First arg > 0, second < 0
      .WillOnce(Return(0));

  mock.Add(5, -3);  // Matches
}
```

---

For detailed information on built-in matchers, see the [Matchers Reference](reference/matchers.md).

For further guidance and recipes on actions, see the [Actions Reference](reference/actions.md).

Explore the [gMock Cookbook](docs/gmock_cook_book.md) for extensive illustrative examples.
