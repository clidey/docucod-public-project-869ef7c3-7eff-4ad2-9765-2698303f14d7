---
title: "Actions & Call Expectations"
description: "Explains the mechanism for setting up call expectations on mock objects, specifying return values, side effects, and error simulation. Covers ON_CALL, EXPECT_CALL, and the cardinality system that defines how many times calls are allowed or required."
---

# Actions & Call Expectations

This guide explains the mechanism for setting up call expectations on mock objects in GoogleMock. It covers how to specify method behaviors, return values, side effects, and error simulations by using `ON_CALL` and `EXPECT_CALL`. Additionally, it explains the cardinality system that controls how many times calls are allowed or required, helping you precisely tailor your mocks to your test needs.

---

## Understanding the Role of Actions & Call Expectations

Mock objects let you replace real implementations with controllable and observable stand-ins. Setting expectations on how these mocks are called ensures your code interacts with its dependencies correctly.

GoogleMock offers two main constructs for this purpose:

- **`ON_CALL`**: Defines default behaviors for mock methods but does **not** require the method to be called.
- **`EXPECT_CALL`**: Defines both the expected call pattern and the behavior. It sets precise expectations about how many times and in what order a method will be invoked.

Knowing when and how to use these macros lets you write resilient and expressive tests that focus on the contract your code must fulfill.

---

## ON_CALL: Specifying Default Method Behavior Without Expectations

The `ON_CALL` macro specifies what should happen when a mock method is called with matching arguments but imposes *no requirement* that the call must happen.

### Syntax

```cpp
ON_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);        // Mandatory
```

- **`mock_object`**: The mock instance.
- **`method_name(matchers...)`**: The method with argument matchers (`_` matches any argument).
- **`.With()`**: Restricts the spec to arguments matching the multi-argument matcher tuple (only one allowed).
- **`.WillByDefault()`**: Defines the default action taken when the call matches.

### Key Points

- `ON_CALL` does not fail tests if the method is not called.
- Multiple `ON_CALL`s can be given; the *last matching* behavior takes precedence.
- Use `ON_CALL` to set up stable default behaviors in your test fixture or mock constructor.

### Example

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::Lt;

ON_CALL(my_mock, SetPosition(_, _))
    .With(Lt())
    .WillByDefault(Return(true));
```
This says when `SetPosition()` is called with two arguments where first is less than the second, return `true` by default.

---

## EXPECT_CALL: Setting Precise Call Expectations and Behavior

The `EXPECT_CALL` macro not only defines *how* a mock method behaves but also *how many times* and *when* it should be called.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)      // Optional (must be first if used)
    .Times(cardinality)                // Optional
    .InSequence(sequences...)          // Optional, can repeat
    .After(expectations...)            // Optional, can repeat
    .WillOnce(action)                  // Optional, can repeat
    .WillRepeatedly(action)            // Optional
    .RetiresOnSaturation();            // Optional
```

- If `Times()` is omitted, cardinality is inferred based on `WillOnce()` and `WillRepeatedly()` presence.
- Clauses must appear in the above order. Improper ordering triggers errors.

### Key Clauses Explained

#### With

`.With()` restricts the expectation to calls whose *whole argument tuple* matches a multi-argument matcher.

#### Times: Controlling Call Frequency

Defines how often the expected call should happen. Supported cardinalities include:

| Cardinality      | Meaning                                       |
| ---------------- | --------------------------------------------- |
| `AnyNumber()`    | No restriction on call count                   |
| `AtLeast(n)`     | Expected at least *n* calls                     |
| `AtMost(n)`      | Expected at most *n* calls                      |
| `Between(m, n)`  | Between *m* and *n* calls inclusive             |
| `Exactly(n)` or `n` | Exactly *n* calls (0 means never called)      |

If the call count is violated (too few or too many calls), the test will fail.

#### InSequence

Use one or more `Sequence` objects to require calls to happen in the order declared within sequences.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(my_mock, Reset()).InSequence(s1, s2);
EXPECT_CALL(my_mock, GetSize()).InSequence(s1);
EXPECT_CALL(my_mock, Describe()).InSequence(s2);
```
This enforces `Reset()` before both `GetSize()` and `Describe()`, while `GetSize()` and `Describe()`’s order is unconstrained relative to each other.

#### After

Enforces that this expectation is fulfilled only after other expectations are satisfied.

Example:

```cpp
Expectation init_x = EXPECT_CALL(my_mock, InitX());
Expectation init_y = EXPECT_CALL(my_mock, InitY());
EXPECT_CALL(my_mock, Describe()).After(init_x, init_y);
```

#### WillOnce

Defines the action to perform on a *single* matching call.

Example:

```cpp
EXPECT_CALL(my_mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));
```
The first three calls will return 1, then 2, then 3.

#### WillRepeatedly

Defines the action performed on *all subsequent* matching calls, after exhausting `WillOnce` actions.

Example:

```cpp
EXPECT_CALL(my_mock, GetName())
    .WillOnce(Return("John"))
    .WillRepeatedly(Return("Doe"));
```
The first call returns "John"; subsequent calls return "Doe".

#### RetiresOnSaturation

Automatically deactivates the expectation after it satisfies its call count.

Useful to avoid over-saturation from multiple similar expectations.

Example:

```cpp
EXPECT_CALL(my_mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
```
After two calls matching this expectation, further calls with argument `7` will no longer match this expectation.

---

## Cardinality System in Detail

Determines expectations about how many times a call should occur:

- **AnyNumber()**: no limits.
- **AtLeast(n)**: n or more calls required.
- **AtMost(n)**: no more than n calls allowed.
- **Between(m, n)**: between m and n calls inclusive.
- **Exactly(n)**: exactly n calls, including zero to disallow calls.

Cardinalities validate calls during runtime, helping catch unexpected behavior immediately.

### Inferencing Cardinality Rules

If you omit `.Times()`, it is inferred based on `.WillOnce()` and `.WillRepeatedly()` usage:

- No `WillOnce` nor `WillRepeatedly` → `Times(1)` is assumed.
- *n* `WillOnce` clauses but *no* `WillRepeatedly` → `Times(n)`.
- *n* `WillOnce` and *one* `WillRepeatedly` → `Times(AtLeast(n))`.

### Common Cardinality Examples

```cpp
EXPECT_CALL(mock, Func()).Times(AnyNumber());
EXPECT_CALL(mock, Func()).Times(AtLeast(3));
EXPECT_CALL(mock, Func()).Times(Exactly(2));
```

### Important Behavior

- `Times(0)` expresses that a call should never happen.
- Excess calls or too few calls cause immediate test failures.

---

## User Flow: Setting Up Expectations on Mock Methods

Follow these steps for robust mocking:

<Steps>
<Step title="Prepare your mock object">
Instantiate your mock class, e.g., `MockTurtle turtle;`.
</Step>
<Step title="Define default behaviors">
Use `ON_CALL` in your test setup if you want to specify usual behaviors but no mandatory expectations.
</Step>
<Step title="Declare precise expectations">
Use `EXPECT_CALL` before exercising code to set exact call counts, argument matchers, actions, and ordering.
</Step>
<Step title="Exercise your test code">
Run the code that uses the mock, triggering calls.
</Step>
<Step title="Verification and teardown">
GoogleMock automatically verifies if expectations were met at mock destruction. You can also verify early using `Mock::VerifyAndClearExpectations`.
</Step>
</Steps>

---

## Practical Tips & Best Practices

- **Set expectations before calling the mock method:** `EXPECT_CALL` must be set before the mock method is invoked.
- **Use `ON_CALL` for general behavior, `EXPECT_CALL` for verification:** Avoid over-specifying your tests.
- **Use matchers like `_` to avoid brittle tests when only partial argument matching is necessary.**
- **Leverage sequences (`Sequence` and `InSequence`) for ordered call requirements.**
- **Use `RetiresOnSaturation()` to prevent call after an expectation is met.**
- **Suppress uninteresting call warnings using `NiceMock` or explicit `EXPECT_CALL(...).Times(AnyNumber())`.**
- **Avoid setting expectations on overloaded methods without helping overload resolution (e.g., specify argument types).**

---

## Troubleshooting Common Issues

### Missing Expectations

If a method is called but no matching `EXPECT_CALL` matches the arguments or cardinality, GoogleMock reports an **unexpected call** failure.

### Too Many Calls

If a method is called more times than allowed by the cardinality, GoogleMock reports an **excessive call** failure.

### Uninteresting Calls

Calls to mock methods without any expectation (`EXPECT_CALL`) but with behaviors set by `ON_CALL` are *uninteresting*. By default, these print warnings but do not fail tests. Change mock strictness with `StrictMock`, `NiceMock`, or `NaggyMock`.

### Incorrect Clause Order

Improper order of chained clauses after `EXPECT_CALL` causes run-time errors. Refer to the specified order to avoid these.

### Action List Exhaustion

If the number of `WillOnce` actions is less than calls made without a `WillRepeatedly`, GoogleMock uses the default action and prints warnings.

---

## Summary

This page has guided you through the essential concepts of setting up mock method call expectations in GoogleMock.

- **ON_CALL**: Specify general default behaviors without enforcing call expectations.
- **EXPECT_CALL**: Set precise expectations on number, order, and arguments of calls with customizable behaviors.
- **Cardinality system**: Control how many times calls should happen and enforce test validation.
- Chaining clauses `.With()`, `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, `.RetiresOnSaturation()` to fine-tune mock behavior.

Mastering these constructs empowers you to write expressive, maintainable, and reliable tests that verify interactions and simulate complex behaviors effectively.

---

## Further Reading & Related Topics

- [Mocking Reference](docs/reference/mocking.md) — authoritative reference for mocking macros and classes.
- [gMock Cookbook](docs/gmock_cook_book.md) — practical recipes for mocking strategies and patterns.
- [gMock for Dummies](docs/gmock_for_dummies.md) — beginner-friendly introduction to mocking concepts.
- [Matchers Reference](reference/matchers.md) — for understanding argument matchers used in call expectations.
- [Actions and Returns](api-reference/mocking-and-stubbing/actions-and-returns.mdx) — detailed guide on defining mock method actions.

---

## Example: Full EXPECT_CALL Usage

```cpp
using ::testing::_;
using ::testing::AtLeast;
using ::testing::Return;
using ::testing::Sequence;

MockTurtle turtle;
Sequence seq1, seq2;

EXPECT_CALL(turtle, PenDown())
    .Times(1);
EXPECT_CALL(turtle, Forward(_))
    .Times(AtLeast(1))
    .InSequence(seq1)
    .WillRepeatedly(Return());
EXPECT_CALL(turtle, Turn(_))
    .InSequence(seq1)
    .After(EXPECT_CALL(turtle, PenDown()))
    .WillOnce(Return());
EXPECT_CALL(turtle, GoTo(50, _))
    .With(::testing::Lt())
    .RetiresOnSaturation();

// Code that exercises turtle...
```

This example sets various expectations including call count constraints, ordering with sequences, prerequisite call with `.After()`, argument constraints with `.With()`, and retiring expectations after saturation.
