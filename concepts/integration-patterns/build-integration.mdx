---
title: "Build System Integration"
description: "Review typical integration patterns for using GoogleTest and GoogleMock with CMake, Bazel, and custom build environments. Understand how to set up your project for efficient and maintainable test builds."
---

# Build System Integration

This guide reviews typical integration patterns for incorporating GoogleTest and GoogleMock into various build environments, namely CMake, Bazel, and custom build setups. It provides actionable insights to help you configure your project to build and run tests efficiently while maintaining clarity, modularity, and control.

---

## Understanding the Integration Landscape

Integrating GoogleTest and GoogleMock into your build system involves ensuring proper compilation, linking, and dependency management of test binaries alongside your production code. Each build environment—CMake, Bazel, or custom build scripts—offers unique idioms and best practices that, when followed, result in maintainable and scalable test setups.

## 1. CMake Integration

CMake remains one of the most popular cross-platform build systems, favored for its flexibility and vast ecosystem.

### Setting Up GoogleTest/GoogleMock with CMake

- **Adding GoogleTest and GoogleMock to your project**:
  You can add GoogleTest and GoogleMock as a subdirectory or include them as external dependencies via `FetchContent` or `ExternalProject_Add`.

- **Linking test targets**:
  After adding GoogleTest, declare your test executable and link it with `GTest::gtest` and `GMock::gmock` targets.

- **Example:**

  ```cmake
  include(FetchContent)

  # Fetch GoogleTest and GoogleMock
  FetchContent_Declare(
    googletest
    URL https://github.com/google/googletest/archive/refs/tags/release-1.12.1.zip)

  FetchContent_MakeAvailable(googletest)

  add_executable(MyTests test_main.cpp mock_foo.cpp)

  target_link_libraries(MyTests PRIVATE GTest::gtest GMock::gmock GTest::gtest_main)

  enable_testing()
  add_test(NAME MyTests COMMAND MyTests)
  ```

### Best Practices

- Keep `enable_testing()` and `add_test()` close to your test target declaration.
- Prefer linking against `GMock::gmock_main` for a provided `main()` function, unless you need to customize `main()`.
- Isolate mock and test definitions into dedicated directories to improve organizational clarity.

### Troubleshooting Tips

- Ensure your compiler supports C++17 or higher, as GoogleTest/GoogleMock requires it.
- If encountering linking or header-not-found issues, verify the include and library paths.
- Use CMake's `message()` to inspect variables like `GMock_DIR` and linked libraries.

## 2. Bazel Integration

Bazel provides a highly scalable and hermetic build environment, often tuned for large codebases.

### Declaring GoogleTest and GoogleMock in Bazel

- GoogleTest and GoogleMock are generally included via `http_archive` or workspace rules.

- In your `BUILD` file, define test targets using `cc_test` or `cc_binary` with proper deps on `@com_google_googletest//:gmock_main`.

- **Example:**

  ```python
  cc_test(
      name = "my_tests",
      srcs = ["test_main.cc", "mock_foo.cc"],
      deps = ["@com_google_googletest//:gmock_main"],
  )
  ```

### Recommended Patterns

- Use `gmock_main` as a dependency to simplify test code by using the built-in test `main()`.
- Leverage `cc_test` for test targets to take advantage of Bazel's test runner and caching.
- Manage external dependencies via Bazel WORKSPACE rules for consistent versioning.

### Pitfalls and Solutions

- Avoid mixing GoogleTest and GoogleMock versions manually; rely on Bazel's workspace rule version management.
- Resolve any symbol conflicts or linking errors by revisiting dependency declarations.

## 3. Custom Build Environments

When neither CMake nor Bazel is used, or you maintain your own build scripts (e.g., Makefiles or Ninja), you must ensure:

- All GoogleTest and GoogleMock source files or prebuilt libraries are compiled and linked.
- Header search paths include the GoogleTest include directories.
- Test binaries link against the threading library and any other required system libraries.

### Example Makefile Snippet

```makefile
GMOCK_DIR = /path/to/googletest/googlemock
GTEST_DIR = /path/to/googletest/googletest

CXXFLAGS += -I$(GMOCK_DIR)/include -I$(GTEST_DIR)/include -pthread -std=c++17

all: my_tests

my_tests: test_main.o mock_foo.o
	$(CXX) -o $@ $^ -L$(GMOCK_DIR)/lib -lgmock -lgtest -pthread
``` 

### Recommendations

- Consider building GoogleTest and GoogleMock separately as static libraries for linking.
- Use the supplied `gmock_main.cc` for a standard test entry point, or provide your own `main()`.
- Automate downloading and building GoogleTest and GoogleMock with your scripts for consistency.

## 4. Project Structure for Maintainability

Organize your project such that:

- Test sources and mocks live in dedicated directories like `tests/` and `mocks/`.
- The build system encapsulates dependency details, exposing a simple interface for test builds.
- Version updates of GoogleTest/GoogleMock are centralized, avoiding scattered dependency references.

## Troubleshooting Common Build Issues

- **Linker errors about missing functions:** Ensure proper linking order and presence of needed GoogleMock libraries.
- **Header not found:** Confirm include paths; verify that GoogleTest and GoogleMock source trees are correctly referenced.
- **Compiler errors about C++ standard:** Confirm your toolchain supports at least C++17 and that your build system specifies it correctly.

## Summary Workflow

Regardless of the build system, integration follows these steps:

1. **Fetch or include GoogleTest and GoogleMock sources or binaries.**
2. **Expose GoogleTest/GoogleMock includes and libraries to your build configuration.**
3. **Define test targets linking with GoogleTest and GoogleMock libraries.**
4. **Write test and mock codes using the APIs.**
5. **Build and run the tests, ideally integrating with your continuous integration setup.**

## Further Reading and References

- [GoogleTest CMake integration](https://github.com/google/googletest/blob/main/googletest/README.md#cmake-integration)
- [Bazel GoogleTest/Bazel GoogleMock workspace setup](https://github.com/bazelbuild/rules_go/wiki/Testing)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced usage of mocks in tests
- [GoogleTest Primer (Getting Started)](/overview/getting-started/introduction)
- [Configuration and Project Setup](/getting-started/setup-introduction/configuration-basics)
- [Building and Running Tests](/gtest-guides/getting-started/build_and_run)

---

## Visualization: Integration Flow Overview

```mermaid
flowchart TD
  A[Start - Prepare Build Environment] --> B{Choose Build System}
  B -->|CMake| C[CMakeLists.txt Setup]
  B -->|Bazel| D[WORKSPACE and BUILD Files Setup]
  B -->|Custom| E[Manual Build Scripts]

  C --> F[Add GoogleTest/GoogleMock as External or Submodule]
  D --> G[Declare Dependencies in Bazel Workspace]
  E --> H[Download and Build Libraries Manually]

  F --> I[Define Test Targets (add_executable)]
  G --> J[Define cc_test with Dependencies]
  H --> K[Compile & Link Tests with Libraries]

  I --> L[Link Test Targets with GTest and GMock]
  J --> M[Link Test Targets with gmock_main]
  K --> N[Ensure Proper Include and Link Flags]

  L & M & N --> O[Write Test and Mock Code]
  O --> P[Build and Run Tests]
  P --> Q[Test Result and Debug]

  Q --> R{Test Passed?}
  R -->|Yes| S[Integrate into CI Pipeline]
  R -->|No| T[Troubleshoot Build & Test Failures]
  T --> P

  style B fill:#f9f,stroke:#333,stroke-width:2px
  style R fill:#bbf,stroke:#333,stroke-width:2px
  style S fill:#cfc,stroke:#333,stroke-width:2px
  style T fill:#fcc,stroke:#333,stroke-width:2px
```

---

<Tip>
For modern C++ projects, always ensure your compiler supports at least C++17 and that the build system respects this setting to avoid obscure errors.
</Tip>

<Note>
GoogleTest and GoogleMock prefer having independent mock class definitions and test code, allowing tests to evolve without tightly coupling them to production code.
</Note>

<Warning>
Avoid mixing versions of GoogleTest and GoogleMock from disparate sources; version mismatches can lead to linking errors or unstable test behaviors.
</Warning>

---

## Troubleshooting Section

### Issue: Linker errors after adding GoogleMock

- Verify all required source files of GoogleMock are compiled or libraries linked.
- Confirm `-pthread` is included as a compiler and linker flag.
- Ensure that your test executable links with `gmock` and `gtest` libraries.

### Issue: Header files not found

- Double-check your include directories point to the correct GoogleTest and GoogleMock source or installed locations.
- For CMake, verify `GMock_INCLUDE_DIRS` or use targets like `GMock::gmock`.

### Issue: Compilation errors with C++ standard

- Confirm your compiler version supports C++17 or higher.
- Confirm your build system sets the C++ standard appropriately (e.g., `set(CMAKE_CXX_STANDARD 17)` for CMake).


## Summary

This page guides you through the essential steps to integrate GoogleTest and GoogleMock into popular and custom build systems with detailed best practices, troubleshooting, and example configurations. Following these patterns ensures clean, maintainable test builds and smoother developer experiences.
