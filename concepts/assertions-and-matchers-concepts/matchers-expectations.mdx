---
title: "Matchers and Expectation Expressions"
description: "Understand how matchers work within assertions and mock expectations. Explore the philosophy behind expressive checks and how users can extend matchers for domain-specific testing."
---

# Matchers and Expectation Expressions

GoogleMock (gMock) enables precise, expressive testing of C++ code by letting you specify expectations on mock methods and define how argument values should be matched using _matchers_. This page helps you understand the core concepts behind matchers and expectation expressions and shows you how to effectively use and extend them to create robust unit tests.

---

## Introduction to Matchers and Expectations

Matchers allow you to specify constraints on the arguments passed to mock methods in expectations. An expectation states what mock methods are expected to be called, with what arguments, how often, and what they should return or do.

Matchers are the key to making your mocks expressive and your tests precise without overspecifying or being brittle.

### Why Use Matchers?

A matcher is like a predicate: it tests whether a mock method argument satisfies a condition. For example, you may expect a method to be called with a value greater than 10, or with any pointer that is not null.

Matchers allow you to:

- Set exact argument constraints
- Combine matchers logically
- Validate complex domain-specific conditions
- Use predicate functions or lambdas
- Use custom matchers tailored to your types

### The Expectation Expression Model

Expectations are created using the `EXPECT_CALL` macro, specifying the mock object, method, and argument matchers. Expectations describe both what calls are allowed or expected and what actions to perform when they occur.

Example:

```cpp
using ::testing::Return;
using ::testing::_;

EXPECT_CALL(mock_turtle, Forward(Ge(100)))
    .Times(AtLeast(1))
    .WillRepeatedly(Return());
```

This says:

- The `Forward` method is expected to be called with an argument greater or equal to 100.
- It should be called at least once.
- Every call matching this expectation will return void (default behavior).

Uninteresting calls (calls to methods with no matching expectation) trigger warnings by default but can be controlled via behaviors.

---

## Using Matchers in Expectation Expressions

### Basic Matchers

Matchers can be literals (e.g., `100`), which are treated as equality matchers (`Eq(100)`), or explicit matchers like:

- `_` — wildcard matcher matching any argument
- `Ge(100)` — argument is greater or equal to 100
- `NotNull()` — pointer is not null

Example:

```cpp
EXPECT_CALL(mock_obj, DoWork(100, _));
```

### Combining Matchers

Matchers can be combined using logical combinators:

- `AllOf(matcher1, matcher2)` — both match
- `AnyOf(matcher1, matcher2)` — either matches
- `Not(matcher)` — inverse match

Example:

```cpp
EXPECT_CALL(mock_obj, DoWork(AllOf(Ge(5), Ne(10))));
```

This expects an argument >= 5 and not equal to 10.

### Multi-Argument Matchers with `.With()` Clause

Sometimes you want to impose conditions on multiple arguments jointly. Use `.With()` with a matcher for a tuple of all arguments.

Example:

```cpp
EXPECT_CALL(mock_obj, SetPosition(_, _))
    .With(Lt());  // The first argument must be less than the second
```

You can also select specific argument indices:

```cpp
EXPECT_CALL(mock_obj, Operation(_, _, _))
    .With(AllOf(Args<0,1>(Lt()), Args<1,2>(Lt())));
```

### Using Predicates as Matchers

If no suitable matcher exists, wrap a user-defined predicate function or functor inside `Truly()`:

```cpp
bool IsEven(int n) { return (n % 2) == 0; }
EXPECT_CALL(mock_obj, Process(Truly(IsEven)));
```

This expects the argument to be an even number.

### Matching Non-Copyable Arguments

When matching arguments that cannot be copied, pass them by reference using `std::ref()` inside a matcher:

```cpp
EXPECT_CALL(mock_obj, Foo(Eq(std::ref(bar))));
```

Make sure that the referenced value is stable and not modified after the call.

### Validating Members of Arguments

You can validate specific fields or the return value of a member method with `Field()` and `Property()`, respectively.

- `Field(&Class::member, matcher)` matches an argument whose member satisfies the matcher.
- `Property(&Class::getter, matcher)` matches when the getter method's output satisfies the matcher.

Example:

```cpp
EXPECT_CALL(mock_obj, Process(Field(&Foo::number, Ge(3))));
```

Matches when the argument's `number` field is >= 3.

### Matching Values Pointed by Pointer Arguments

Use `Pointee(m)` matcher to match the value pointed to by a pointer argument.

Example:

```cpp
EXPECT_CALL(mock_obj, Update(Pointee(Ge(5))));
```

Passes when the pointer points to a value >= 5. Also works recursively for pointer-to-pointer with multiple nested `Pointee()`.

### Overloaded Methods and Constness Disambiguation

To specify which overloaded mock method is expected, use:

- `Const(mock_obj)` wrapper for const method overloads.
- Explicit matcher casting or `TypedEq<T>()` to resolve ambiguous overloads based on argument types.

Example:

```cpp
EXPECT_CALL(mock_obj, OverloadMethod(An<int>()));
EXPECT_CALL(Const(mock_obj), OverloadMethod(An<int>()));
```

---

## Writing Expectations with Matchers

The primary macro is `EXPECT_CALL(mock_obj, Method(matchers...))`, which:

- Creates an expectation that the method will be called with arguments matching all matchers.
- Supports chaining clauses like `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, `.RetiresOnSaturation()`, and `.With()`.

### When to Use `ON_CALL` vs `EXPECT_CALL`

- `ON_CALL()` specifies **default behavior** but does not set an expectation that a call must be made.
- `EXPECT_CALL()` specifies **expected calls with verification**.

Preferring `ON_CALL` for default behaviors and sparing `EXPECT_CALL` to verify only necessary calls leads to less brittle tests.

### Setting Cardinalities with `.Times()`

Specifies how many times the method is expected to be called. Examples:

- `Times(1)` — exactly once (default if no `Will*()` clauses)
- `Times(AnyNumber())` — any number of times
- `Times(AtLeast(n))` — at least n times

### Call Ordering with Sequences

Use `.InSequence()` to require calls happen in order.

```cpp
{
  InSequence s;
  EXPECT_CALL(foo, A());
  EXPECT_CALL(bar, B());
}
```

Calls to A must happen before calls to B.

Use `.After()` with `Expectation` or `ExpectationSet` to specify partial ordering.

### Actions with `.WillOnce()` and `.WillRepeatedly()`

Specify behavior per call. Example:

```cpp
EXPECT_CALL(foo, GetX())
    .WillOnce(Return(100))
    .WillRepeatedly(Return(42));
```

Returns 100 the first time, and 42 thereafter.

---

## Extending Matchers

### Defining Custom Matchers

Use the `MATCHER` family of macros for quick custom matchers:

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}
```

Use like:

```cpp
EXPECT_CALL(foo, Bar(IsDivisibleBy7()));
```

### Parameterized Matchers

Use `MATCHER_P` and friends for matchers with parameters:

```cpp
MATCHER_P(IsMultipleOf, factor, "") {
  return (arg % factor) == 0;
}
```

### Writing Matcher Classes

For more complex matchers, implement a matcher class with:

- `bool MatchAndExplain(const T& value, std::ostream* os) const`
- `void DescribeTo(std::ostream* os) const`
- `void DescribeNegationTo(std::ostream* os) const`

Then implement a factory function returning `testing::Matcher<T>`.

### Defining Polymorphic Matchers

To match multiple types, make the matcher template-friendly:

```cpp
class NotNullMatcher {
 public:
  template<typename T>
  bool MatchAndExplain(T* p, std::ostream*) const { return p != nullptr; }
  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

NotNullMatcher NotNull() { return NotNullMatcher(); }
```

---

## Practical Tips and Common Pitfalls

- **Expectations are "sticky" by default:** Calls that saturate their expected count remain active unless `.RetiresOnSaturation()` is specified.
- **Order of expectations matters:** gMock searches expectations in reverse order; newer expectations override older ones.
- **Uninteresting calls:** Calls to mock methods without expectations are uninteresting and by default print warnings. Control this verbosity via mock wrappers (`NiceMock`, `NaggyMock`, `StrictMock`) or add catch-all expectations.
- **Use `_` matcher:** Most flexible for ignoring specific argument values.
- **Avoid over-specifying:** Verify only what you care about to keep tests maintainable.
- **Use `.With()` clause carefully:** It must be the first clause after `EXPECT_CALL` or `ON_CALL`.

---

## Troubleshooting

- If you get warnings about uninteresting calls, check whether missing an `EXPECT_CALL` or if a `NiceMock` wrapper could help.
- Use `--gmock_verbose=info` flag to see detailed mock call traces and diagnose expectation mismatches.
- For overload resolution, use `Const()` and fixed-type matchers like `TypedEq<T>()`.
- If your test fails unexpectedly, verify you set expectations before exercising the mock.
- Avoid defining expectations after exercising the mock; behavior is undefined.

---

## Summary of Key APIs

- `EXPECT_CALL(mock, Method(matchers)).Times(...).WillOnce(...).WillRepeatedly(...).InSequence(...)` — set expressive expectations
- `ON_CALL(mock, Method(matchers)).With(...).WillByDefault(...)` — define default actions
- `MATCHER` macros — define custom matchers
- `Truly()` — wrap predicates into matchers
- `SafeMatcherCast<T>(matcher)` — for safely casting matcher types
- `Const(mock)` — disambiguate const overloads

---

## Example: Using Matchers in Expectations

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::Lt;
using ::testing::AllOf;

class MockFoo {
 public:
  MOCK_METHOD(int, Calculate, (int a, int b), (override));
};

MockFoo foo;

EXPECT_CALL(foo, Calculate(AllOf(Lt(10), _)))
    .WillOnce(Return(42));

EXPECT_CALL(foo, Calculate(_, 5))
    .WillRepeatedly(Return(7));

int result1 = foo.Calculate(5, 3);  // Matches first expectation, returns 42
int result2 = foo.Calculate(15, 5); // Matches second, returns 7
```

---

## Related Documentation

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Practical recipes for mock classes, matchers, actions, and more.
- [GoogleTest Assertion Macros](../core-assertions-macros/googletest-assertions.md): For using matchers in assertions, see `EXPECT_THAT`.
- [Mock Classes and Methods API](../mocking-actions/mock-classes-methods.md)
- [Actions and Expectations Reference](../mocking-actions/actions-and-expectations.md)
- [Understanding Uninteresting vs Unexpected Calls](gmock_cook_book.md#uninteresting-vs-unexpected)

---

## Best Practices

- Prefer matchers over literals for flexible argument validation.
- Use `ON_CALL` to set default behavior, reserve `EXPECT_CALL` for calls you want to verify.
- Avoid overuse of `StrictMock` unless you want to make tests very exact and brittle.
- Use sequences and `.After()` to express call order precisely.
- Create custom matchers to better express domain-specific logic and to improve test readability.

---

This page is designed to give you mastery over how to use matchers and expectation expressions for precise and readable mock-based tests in GoogleMock.
