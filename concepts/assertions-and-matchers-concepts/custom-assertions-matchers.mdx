---
title: "Custom Assertions and User Extensions"
description: "Explore how GoogleTest encourages users to create their own assertions and matchers, enabling domain-driven testing and enhanced readability. Learn about best practices for extensibility without sacrificing test clarity."
---

# Custom Assertions and User Extensions

GoogleTest and GoogleMock empower you to enhance your testing precision and readability through custom assertions and user-defined matchers. This page guides you on creating your own assertion macros and matchers, enabling domain-driven testing that expresses your intent clearly while maintaining extensibility and test clarity.

---

## Why Create Custom Assertions and Matchers?

When your tests involve complex domain-specific logic, the built-in assertions may not express your intent as precisely or read as naturally as you'd like. Custom assertions and matchers allow you to:

- Encapsulate complex logic in reusable components.
- Produce clearer, more informative failure messages tailored to your domain.
- Improve test maintainability by reducing duplication.
- Integrate seamlessly with GoogleTest's assertion framework and GoogleMock's expectation syntax.

Consider the scenario where you want to verify that an object satisfies a specific invariant or property difficult to express using simple equality or Boolean conditions; defining a custom matcher is the elegant solution.

---

## Creating Custom Assertions

GoogleTest provides macros and utilities that let you write expressive assertions customized to your needs. There are three main approaches:

### 1. Custom Predicate Assertions with `AssertionResult`

You can write a function returning `::testing::AssertionResult` to provide success or failure along with a custom error message. This is useful when you want to:

- Include detailed reasons for assertion failure.
- Make Boolean checks more informative.

**Example:**

```cpp
#include <gtest/gtest.h>

testing::AssertionResult IsSorted(const std::vector<int>& v) {
  for (size_t i = 1; i < v.size(); ++i) {
    if (v[i] < v[i - 1]) {
      return testing::AssertionFailure() << "Element at index " << i
                                         << " is less than previous element";
    }
  }
  return testing::AssertionSuccess();
}

TEST(VectorTest, SortedCheck) {
  std::vector<int> data = {1, 2, 3, 2};
  EXPECT_TRUE(IsSorted(data));  // Failure with informative reason.
}
```

### 2. Using Predicate Assertions with Macros

Use `EXPECT_PRED_FORMAT*` macros, which allow you to create predicate-formatters that generate rich error messages including the expressions.

### 3. Writing Custom Assertion Macros

If you want assertion macros similar to built-in ones, encapsulate your `AssertionResult` functions with a macro:

```cpp
#define EXPECT_SORTED(container) \
  EXPECT_PRED_FORMAT1(IsSorted, container)
```

Then use `EXPECT_SORTED(my_vector);` in your tests.

---

## Writing Custom Matchers

GoogleMock's matcher interface empowers you to define expressive, reusable matchers that integrate seamlessly with `EXPECT_THAT` assertions,
`EXPECT_CALL`, and other GoogleMock APIs.

### Basic Matcher through `MATCHER` Macros

The quickest way to define a matcher is via the `MATCHER` family of macros.

**Example:**

```cpp
#include <gmock/gmock.h>

MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

// Usage in a test
EXPECT_THAT(4, IsEven());  // Passes
EXPECT_THAT(5, IsEven());  // Fails with message: "is even"
```

Use `MATCHER_P`, `MATCHER_P2`, etc., to write parameterized matchers. These take one or more parameters to customize the matcher.

**Example:**

```cpp
MATCHER_P(IsWithinRange, range, "checks if value is within given range") {
  return arg >= -range && arg <= range;
}

EXPECT_THAT(5, IsWithinRange(10));  // Passes
EXPECT_THAT(15, IsWithinRange(10)); // Fails
```

### Implementing Matcher Classes Directly

For complex, widely-reused matchers requiring better error messages or multi-type support, implement the matcher interface:

```cpp
class DivisibleByMatcher {
 public:
  explicit DivisibleByMatcher(int divisor) : divisor_(divisor) {}
  using is_gtest_matcher = void;  // Mark as a matcher

  template <typename T>
  bool MatchAndExplain(T n, ::testing::MatchResultListener* listener) const {
    if (n % divisor_ == 0) return true;
    *listener << "whose remainder is " << (n % divisor_);
    return false;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by " << divisor_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by " << divisor_;
  }

 private:
  const int divisor_;
};

::testing::Matcher<int> DivisibleBy(int divisor) {
  return ::testing::MakeMatcher(new DivisibleByMatcher(divisor));
}

// Usage
EXPECT_THAT(14, DivisibleBy(7));  // Passes
EXPECT_THAT(15, DivisibleBy(7));  // Fails with detailed message
```

### Polymorphic Matchers

To support matching values of different types, implement `MatchAndExplain` as a template function as above. Most `MATCHER` macros produce polymorphic matchers by default.

---

## Tips and Best Practices

- **Keep Matchers Pure:** Make sure your matcher does not have side effects. It must be a deterministic predicate returning the same result for the same input.

- **Use Descriptive Messages:** Stream helpful diagnostic messages in `MatchAndExplain` via the `MatchResultListener` to aid debugging on test failures.

- **Use Parameters:** Parameterize matchers when possible to maximize reuse.

- **Avoid Overly Complex Matchers:** If a matcher becomes too complex, consider breaking logic down or writing helper functions.

- **Leverage GoogleMock Macros:** Use the `MATCHER*` macros for quick matcher definitions. They provide automatic description generation and integration.

- **Integrate with Assertions:** Use custom matchers with `EXPECT_THAT` to improve test readability.


---

## Common Pitfalls

- **Matchers Must Be Stateless:** Do not store or rely on mutable internal state inside a matcher.

- **Do Not Throw Exceptions:** Matchers should not throw exceptions, as GoogleTest and GoogleMock expect predicates to be no-throw.

- **Care with Overloaded Methods:** Disambiguate overloaded methods using `Const()` and specify argument types explicitly to avoid ambiguity.

- **Matching Move-only Types:** For methods with move-only types, use lambdas or callable objects in `EXPECT_CALL` or `ON_CALL` actions.

- **Beware of Reference Binding:** Use `Ref()` matcher when you want to check if an argument is a specific reference.

---

## Advanced Topics

### Composite Matchers

Define matchers that take other matchers as parameters to build complex conditions.

### Custom Actions

Alongside assertions and matchers, GoogleMock allows you to define your own actions with flexible callables or functor objects.

### Teaching GoogleTest How to Print Your Values

Custom types can be made to print nicely in failure messages by:

- Overloading `<<` operator for `std::ostream`
- Providing a `PrintTo()` function
- Implementing `AbslStringify()`

### Using Matchers to Define Domain-Specific Validation

Matchers can verify container contents, string properties, or object member variables with the built-in utilities: `ElementsAre`, `Field`, `Property`, `Pointee`, etc.

---

## Related Documentation

- [GoogleTest Assertion Macros](../core-assertions-macros/googletest-assertions.md)
- [Matchers Reference](../core-assertions-macros/gmock-matchers.md)
- [Mocking Basics](../../googletest-guides/advanced-mocking/mocking-basics.md)
- [gMock Cookbook](../../docs/gmock_cook_book.md)

---

## Summary

Custom assertions and matchers enrich your tests by embedding domain-specific knowledge, making tests more expressive and maintenance-friendly. GoogleTest and GoogleMock provide powerful, flexible APIs and macros to create these extensions effortlessly.

---

## Example: Custom Matcher in Practice

```cpp
MATCHER_P(IsWithinDelta, delta, "checks if number is within delta") {
  return std::abs(arg) <= delta;
}

TEST(FooTest, CustomMatcherSample) {
  EXPECT_THAT(3.14, IsWithinDelta(0.1));  // Fails, 3.14 > 0.1
  EXPECT_THAT(0.05, IsWithinDelta(0.1)); // Passes
}
```

---

## Additional References

- Writing new matchers quickly: [gMock Cookbook #NewMatchers](../../docs/gmock_cook_book.md#NewMatchers)
- Using custom matchers with assertions: [`EXPECT_THAT`](../core-assertions-macros/googletest-assertions.md#EXPECT_THAT)



