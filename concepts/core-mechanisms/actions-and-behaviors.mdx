---
title: "Actions and Behavior Specification"
description: "Learn how to control mock behavior using action templates, cardinalities, and call sequencing. Discover how ON_CALL, EXPECT_CALL, and advanced action templates enable sophisticated, controlled testing."
---

# Actions and Behavior Specification

Learn how to control mock behavior using action templates, cardinalities, and call sequencing. Discover how `ON_CALL`, `EXPECT_CALL`, and advanced action templates enable sophisticated, controlled testing.

---

## Overview

Controlling the behavior of mock methods is central to writing effective and maintainable tests with GoogleMock. This page precisely explains how to specify what your mock methods should do when invoked, using the specialized syntax and facilities that gMock offers.

You will learn how to:

- Define default behaviors that run whenever a mock method is called (`ON_CALL`).
- Set up explicit expectations that verify the method is called as intended (`EXPECT_CALL`).
- Control the number of calls and their ordering.
- Use advanced action templates to define custom, complex mock behaviors.

These features, when combined, offer powerful control over mock method behavior, allowing you to simulate real-world object interactions and validate your code's logic robustly.

## Controlling Mock Behavior with `ON_CALL` and `EXPECT_CALL`

GoogleMock provides two main macros for specifying mock behavior:

- `ON_CALL(mock_object, method(matchers...))`:
  - Specifies the default behavior of a mock method *without* setting any requirement that it be called.
  - Useful for establishing baseline responses that apply unless an expectation overrides them.

- `EXPECT_CALL(mock_object, method(matchers...))`:
  - Establishes both behavior and expectation that the method will be called with matching arguments.
  - Supports rich modifiers to control how many times, in which order, and how the method behaves.

### `ON_CALL` Syntax and Usage

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // Optional, can be used once
    .WillByDefault(action);        // Required
```

- If `With()` is used, it refines the matching by applying a matcher on all arguments as a tuple.
- `WillByDefault()` defines the action to perform (e.g., `Return(value)`, invoking a function, throwing, or custom user actions).

`ON_CALL` never sets an expectation that the method must be called â€” the mock method can be called zero or more times without violating the test.

```cpp
ON_CALL(my_mock, GetValue(_))
    .WillByDefault(Return(42));
```

### `EXPECT_CALL` Syntax and Usage

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)        // Optional, at most once, and must be first
    .Times(cardinality)                  // Optional, at most once
    .InSequence(sequences...)            // Optional, supports multiple sequences
    .After(expectations...)              // Optional, supports multiple prerequisites
    .WillOnce(action)                    // Optional, repeatable
    .WillRepeatedly(action)              // Optional, at most once
    .RetiresOnSaturation();              // Optional, at most once, must be last
```

- `With()` allows combining argument matchers into a single condition for refined checking.
- `Times()` controls expected number of calls; built-in cardinalities include:
  - `AnyNumber()`, `AtLeast(n)`, `AtMost(n)`, `Between(m,n)`, `Exactly(n)`
- `InSequence()` and `After()` help specify call ordering and partial ordering respectively.
- `WillOnce()` defines one-shot actions applied in invocation order.
- `WillRepeatedly()` defines the default action after `WillOnce` actions are used.
- `RetiresOnSaturation()` makes an expectation retire as soon as it reaches its upper cardinality bound.

Example:

```cpp
using ::testing::Return;
using ::testing::AtLeast;
using ::testing::InSequence;

Sequence s;
EXPECT_CALL(my_mock, Foo(42))
    .Times(3)
    .InSequence(s)
    .WillOnce(Return(1))
    .WillRepeatedly(Return(2));
```

This says the mock's `Foo(42)` is expected *at least* 3 times in sequence `s`, returning 1 for the first call, then 2 for subsequent calls.

## Cardinalities: Specifying Call Counts

The `.Times()` clause explicitly controls how many times you expect a call matching an expectation. 
If omitted, gMock infers the cardinality based on actions specified.

| Cardinality Class       | Meaning                                      |
|------------------------|----------------------------------------------|
| `AnyNumber()`          | Expect any number of calls                    |
| `AtLeast(n)`           | Call expected at least n times                |
| `AtMost(n)`            | Call expected at most n times                 |
| `Between(m, n)`        | Call expected between m and n times inclusive |
| `Exactly(n)` or `n`    | Call expected exactly n times (0 means never) |

### Cardinality Inference Rules

- If there are no `WillOnce` or `WillRepeatedly` actions, inferred cardinality is `Times(1)`.
- If there are *n* `WillOnce` and no `WillRepeatedly`, inferred cardinality is `Times(n)`.
- If there are *n* `WillOnce` and one `WillRepeatedly`, inferred cardinality is `Times(AtLeast(n))`.

**Tip:** Use cardinalities to precisely express how many times your method is expected to be called without repeating expectations.

## Sequencing and Ordering of Calls

GoogleMock supports specifying the **order** and **partial order** of expected calls using:

### InSequence

Wrap multiple `EXPECT_CALL`s in the same `InSequence` scope to require that calls occur strictly in that order.

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Foo(1));
  EXPECT_CALL(mock, Foo(2));
}
```

Any call out of order will cause failures.

### Sequence and .InSequence Clause

Use `Sequence` objects to express partial orderings where some calls have ordering constraints and others don't.

```cpp
Sequence s1, s2;
EXPECT_CALL(mock1, Foo()).InSequence(s1);
EXPECT_CALL(mock2, Bar()).InSequence(s2);
EXPECT_CALL(mock3, Baz()).InSequence(s1, s2);
```

This means `Baz` must come after calls in `s1` and `s2`, reconstructing complex DAG orderings.

### Using `.After()` for Partial Pre-Requisites

`.After()` allows specifying that a call is expected only after one or more other expectations are satisfied, enabling fine-grained partial ordering.

```cpp
Expectation a = EXPECT_CALL(mock, Foo(1));
Expectation b = EXPECT_CALL(mock, Bar(2));
EXPECT_CALL(mock, Baz()).After(a, b);
```

`Baz` is expected only after `Foo(1)` and `Bar(2)` have been called.

## Actions: Specifying How Mock Methods Behave

Actions determine what a mock method does upon invocation.

### Built-in Action Templates

| Action                        | Description                                                    |
|------------------------------|----------------------------------------------------------------|
| `Return(value)`               | Return a specified value (copies value at expectation setup)    |
| `ReturnRef(variable)`         | Return a reference to a variable (live value)                   |
| `ReturnPointee(pointer)`     | Return value pointed by `pointer` at call time                  |
| `DoDefault()`                | Perform the default action (from `ON_CALL` or built-in)          |
| `Throw(exception)`           | Throw an exception                                                |
| `SetArgPointee<N>(value)`   | Set the `N`-th argument (a pointer) to `value` (side-effect)      |
| `SaveArg<N>(pointer)`        | Save copy of the `N`-th argument to specified pointer            |
| `IgnoreResult(a)`            | Execute action `a` and ignore its return value                   |
| `DoAll(a1, a2, ..., an)`     | Execute all listed actions, returning the last's return value    |
| `Invoke(f)`                  | Invoke callable `f` with mock args                               |
| `InvokeArgument<N>(args...)` | Invoke the `N`th argument (a callable) with provided args        |

### Composing Actions

You can combine multiple actions using `DoAll()` to perform several steps within a single method call:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

This sets the first parameter pointed to by argument 0 to 5 and returns `true`.

### Using Lambdas, Functors, and Callables

You can supply any callable compatible with the mock signature to capture complex behavior:

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce([](int x) { return x * 2; });
```

### Handling Move-Only Types

Mocking methods involving move-only types (e.g. `std::unique_ptr`) works as normal with support for:

- Return of move-only values via lambdas or actions
- Passing move-only arguments

Some built-in actions may not support move-only types; user-defined lambdas are the recommended workaround.

## Call Matching and Precedence

- When matching calls, `EXPECT_CALL`s and `ON_CALL`s are considered separately.
- Expectation searching happens **in reverse declaration order**, newer expectations override older ones.
- If multiple expectations could match, the latest matching one handles the call.

## Behavior When Expectations Are Exhausted or Not Matched

- If `WillOnce()` actions are exhausted and no `WillRepeatedly()` is specified, calls invoke default action or generate warnings.
- Excess calls beyond `Times()` expectations trigger warnings or test failures.

## Managing Multiple Actions per Expectation

- Several `WillOnce()` calls can be chained to specify different behaviors on successive calls.
- `WillRepeatedly()` can define fallback behavior.
- Excess or insufficient number of actions compared to `Times()` results in warnings.

## Using `RetiresOnSaturation()`

- By default, expectations are "sticky" and remain active even after the expected number of calls is reached.
- Use `.RetiresOnSaturation()` to automatically retire an expectation and make it inactive once saturated.
- This is crucial when you want later expectations to take precedence after some limit is reached.

## Practical Examples

### Setting Default Behavior

```cpp
ON_CALL(mock, GetValue(_))
    .WillByDefault(Return(42));
```

This ensures calls to `GetValue()` return 42 unless an expectation overrides it.

### Expectation With Multiple Call Outcomes

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

On first call returns 1, second call 2, subsequent calls 3.

### Ordered Calls with Sequences

```cpp
Sequence s;
EXPECT_CALL(mock, Init()).InSequence(s);
EXPECT_CALL(mock, Process()).InSequence(s);
EXPECT_CALL(mock, Finish()).InSequence(s);
```

The calls must happen in the order: Init() â†’ Process() â†’ Finish().

### Using `After()` to Express Partial Order

```cpp
Expectation e1 = EXPECT_CALL(mock, Start());
Expectation e2 = EXPECT_CALL(mock, Load()).After(e1);
EXPECT_CALL(mock, Process()).After(e2);
```

Process happens after Load, which happens after Start.

## Common Pitfalls and Best Practices

- Always set expectations *before* exercising the mock.
- Use `ON_CALL` for default behaviors shared by many tests.
- Use `EXPECT_CALL` sparingly to verify meaningful interactions.
- Chain `WillOnce()` actions in proper call order to avoid premature errors.
- Use `RetiresOnSaturation()` to avoid sticky expectations causing call count failures.
- Use sequences or `.After()` to explicitly specify call order where needed.
- Beware of complex action chaining where move-only types might present compilation issues; use lambdas instead.

## Troubleshooting

- If unexpectedly facing warnings about uninteresting calls, check that you have a proper `EXPECT_CALL` or use a `NiceMock` wrapper.
- Check verbose output with `--gmock_verbose=info` to see detailed call matching and reasoning.
- If too many `WillOnce` actions cause warnings, verify that your `Times()` cardinality matches.
- Use `EXPECT_CALL(mock, Method()).Times(0)` to explicitly disallow calls.

## Summary

Mastering `ON_CALL` and `EXPECT_CALL` allows you to precisely specify the behavior and expected interactions of mock objects. Employ cardinalities, sequencing, and call ordering modifiers strategically to express test intent clearly and avoid brittle tests. Harness the rich library of actions and the flexibility of lambdas and callables to simulate real-world scenarios with high fidelity.

### Further Reading and Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) â€” detailed recipes and patterns.
- [Actions Reference](../api-reference/mocking-apis/actions-and-side-effects) â€” full list of actions.
- [Matchers Reference](../api-reference/mocking-apis/using-matchers) â€” robust argument matching.
- [Mocking Reference](../docs/reference/mocking.md) â€” full macro and class details.

### Source

<Source url="https://github.com/google/googletest" branch="main" paths={[{ path: "googlemock/include/gmock/gmock-spec-builders.h", range: "1-472" }, { path: "googlemock/src/gmock-spec-builders.cc", range: "1-380" }]} />

---