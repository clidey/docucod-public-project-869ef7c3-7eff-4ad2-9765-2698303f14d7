---
title: "Expectations, Actions, and Matchers"
description: "Unpack the three core building blocks of GoogleMock: expectations for expressing required calls, actions for specifying outcomes, and matchers for argument inspection. Learn how these elements combine to allow expressive, precise test scenarios."
---

# Expectations, Actions, and Matchers

Unlock the powerful building blocks of GoogleMock that enable you to express precise, expressive unit tests: **Expectations**, **Actions**, and **Matchers**. These components work together to define what calls your mock objects should receive, how those calls should behave, and how to inspect their arguments.

---

## Expectations: Specifying Required Calls

Expectations let you state clearly the interactions your code under test must have with mock objects. They control **which methods must be called**, **how often**, and **in what order**.

### Defining an Expectation with `EXPECT_CALL`

The primary way to declare expectations is the `EXPECT_CALL` macro:

```cpp
EXPECT_CALL(mock_object, MethodName(argument_matchers))
  .With(multi_argument_matcher)  // optional
  .Times(cardinality)             // optional
  .InSequence(sequence1, ...)     // optional
  .After(expectation_or_set...)   // optional
  .WillOnce(action)               // optional
  .WillRepeatedly(action)         // optional
  .RetiresOnSaturation();         // optional
```

- `mock_object`: your mock instance.
- `MethodName`: the mocked method whose calls you expect.
- `argument_matchers`: patterns matching each individual argument. If omitted, defaults to accepting all arguments for non-overloaded methods.

The modifiers refine the expectation:

- `.With(...)`: Applies a matcher to all arguments as a tuple.
- `.Times(...)`: How many calls to expect (e.g., exactly, at least, any number).
- `.InSequence(...)`: Enforces order between expectations belonging to sequences.
- `.After(...)`: Defines partial ordering on calls related to other expectations.
- `.WillOnce(...)` and `.WillRepeatedly(...)`: Specify behaviors when the call happens.
- `.RetiresOnSaturation()`: Retire expectation as soon as call count reaches upper bound.

The order of chained modifiers matters and is enforced for clarity.

### Cardinalities with `.Times()`

Cardinalities express call count constraints, such as:

| Cardinality         | Meaning                                             |
|---------------------|-----------------------------------------------------|
| `AnyNumber()`       | Zero or more times                                  |
| `AtLeast(n)`        | At least `n` times                                 |
| `AtMost(n)`         | At most `n` times                                  |
| `Between(m,n)`      | Between `m` and `n` times, inclusive               |
| `Exactly(n)` or `n` | Exactly `n` times (0 means never called)           |

If `.Times()` is omitted, it is inferred from the usage of `WillOnce()` and `WillRepeatedly()` clauses.

### Ordering Calls with Sequences and `.After()`

By default, expectations match calls regardless of order. With **`Sequence`** objects, you can specify strict ordering:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, A()).InSequence(s1, s2);
EXPECT_CALL(mock, B()).InSequence(s1);
EXPECT_CALL(mock, C()).InSequence(s2);
```

Here, `A()` must be called before `B()` and `C()`, but `B()` and `C()` can happen in any order relative to each other.

Alternatively, `.After()` allows expressing partial ordering on expectations:

```cpp
Expectation e1 = EXPECT_CALL(mock, InitX());
Expectation e2 = EXPECT_CALL(mock, InitY());
EXPECT_CALL(mock, Finalize()).After(e1, e2);
```

The `Finalize()` call must occur after both `InitX()` and `InitY()`.

### Example: Controlling Call Order and Count

```cpp
Sequence seq;
EXPECT_CALL(mock, Open()).Times(1).InSequence(seq);
EXPECT_CALL(mock, Read(_)).Times(AtLeast(1)).InSequence(seq);
EXPECT_CALL(mock, Close()).Times(1).InSequence(seq);
```

This enforces `Open()`, then one or more `Read()`, then `Close()` in strict order.

### Sticky Expectations and Retiring

Expectations are "sticky" by default: they remain active even after reaching their call limit, causing errors on extra calls. Use `.RetiresOnSaturation()` to deactivate an expectation as soon as the upper limit is reached, avoiding overly rigid matching.

---

## Actions: Specifying Behavior When Calls Happen

While expectations specify *what* calls are expected, **actions** specify *how* your mock should respond when those calls occur.

### Specifying Behaviors

Use `.WillOnce(action)` for behaviors that happen *once* on a matching call, and `.WillRepeatedly(action)` for behaviors on all subsequent matching calls.

For example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

The first call returns 10, the second 20, and every other call returns 30.

### Built-in Actions and Custom Actions

You can use built-in actions like `Return()`, `ReturnRef()`, `SetArgPointee()`, `Invoke()`, etc., or define your own:

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce([](int x) { return x * 2; });
```

Actions can be functions, lambdas, functors, or pre-defined `Action` types.

### Default Actions and ON_CALL

If no expectation matches a call, GoogleMock uses default actions specified with `ON_CALL`, or a global default value where applicable. `ON_CALL` does not enforce call counts but sets default behaviors:

```cpp
ON_CALL(mock, Compute(_))
    .WillByDefault(Return(0));
```

When multiple `ON_CALL`s match a call, the last declared takes precedence.

---

## Matchers: Inspecting Call Arguments

Matchers define the conditions on a mock function's arguments for matching calls and checking interactions.

### Argument Matchers

When you write:

```cpp
EXPECT_CALL(mock, Foo(42, _));
```

`42` and `_` are matchers meaning "first argument equals 42" and "second argument can be anything".

### Using Built-in Matchers

GoogleMock includes numerous built-in matchers like `_` (wildcard), `Eq(value)`, `Ge(value)`, `HasSubstr(string)`, `NotNull()`, `Pointee(matcher)`, and combinators like `AllOf()`, `AnyOf()`, etc.

Examples:

```cpp
using ::testing::_;
using ::testing::NotNull;

EXPECT_CALL(mock, Save(NotNull()));
EXPECT_CALL(mock, Process(Ge(5)));
```

### Composite and Custom Matchers

Matchers can be combined:

```cpp
EXPECT_CALL(mock, Func(AllOf(Ge(10), Le(20))));
```

You can also define your own matchers using `MATCHER`, `MATCHER_P`, or by implementing matcher interfaces.

### Multi-Argument Matchers with `.With()` Clause

Sometimes you want to match **all** arguments *together* rather than individually:

```cpp
EXPECT_CALL(mock, Foo(_, _)).With(Lt());
```

Here, `.With()` takes a matcher on the tuple of arguments, e.g. `Lt()` matcher of 2-element tuples where first < second.

### Matchers for Overloaded Methods

When mocking overloaded functions, disambiguate expected methods with the `Const()` wrapper or explicit matcher typing:

```cpp
EXPECT_CALL(Const(mock), GetValue());  // For const overload
EXPECT_CALL(mock, SetValue(Eq(5)));    // For non-const overload
```

### Tips for Using Matchers

- Always use matchers or explicit values for each argument.
- Avoid relying on side effects in matchers – they must be pure functions.
- Use `SafeMatcherCast<T>()` to relax strict typing when safe.

---

## Interactions Between Expectations, Actions, and Matchers

- Each `EXPECT_CALL` defines an expectation with argument matchers and call count.
- On matching calls, the specified action(s) are executed.
- If no call matches, GoogleMock reports an unexpected call failure.
- If a call matches no expectation but matches an `ON_CALL`, that default action is invoked.

---

## Practical Advice and Best Practices

- Use `ON_CALL` to set sensible default behaviors without enforcing call counts.
- Use `EXPECT_CALL` *only* on calls you want to assert must happen.
- Avoid over-specifying expectations; prefer looser matchers or fewer `.Times()` constraints to reduce test brittleness.
- For ordered calls, use `InSequence` block or specify sequences explicitly.
- Clarify overloaded method expectations with `Const()` or by specifying argument matchers.
- Use the `.RetiresOnSaturation()` clause to mark expectations as fulfilled when their call count limit is reached.
- Use `NiceMock` or `StrictMock` wrappers to control treatment of uninteresting calls.
- Leverage the `With()` clause for expressing relationships across multiple parameters as a tuple.

---

## Example Scenario: Testing a Cache Mock

Imagine you have a mock cache class and want to assert that the `Get()` method is called exactly twice: first returning a cached value, second returning a new value.

```cpp
using ::testing::Return;
using ::testing::InSequence;

MockCache cache;
{
  InSequence s;  // enforce call order

  EXPECT_CALL(cache, Get("key"))
      .WillOnce(Return("cached_value"))
      .RetiresOnSaturation();

  EXPECT_CALL(cache, Get("key"))
      .WillOnce(Return("new_value"));
}

// Running code under test:
EXPECT_EQ(cache.Get("key"), "cached_value");
EXPECT_EQ(cache.Get("key"), "new_value");
```

This expresses clear expectations with actions, ordering, and return values.

---

## Troubleshooting

- **Uninteresting call warnings:** caused by calls to mock methods without `EXPECT_CALL`. Suppress with `NiceMock` or add `EXPECT_CALL(...).Times(AnyNumber())`.
- **Too many or too few actions:** GoogleMock warns if the number of `WillOnce()` and `WillRepeatedly()` actions don’t align with `.Times()`. Adjust your action clauses accordingly.
- **Ordering errors:** If calls occur out of the declared sequence, GoogleMock reports unexpected call errors.
- **Overloaded methods:** If the compiler is ambiguous about overloads, use `Const()` or specify the precise matcher types.

---

This page distills the essential constructs you must master to wield GoogleMock’s expressive powers efficiently and write robust, maintainable tests.

---

## See Also

- [MOCK_METHOD Macro](../docs/reference/mocking.md#MOCK_METHOD)
- [EXPECT_CALL Macro](../docs/reference/mocking.md#EXPECT_CALL)
- [ON_CALL Macro](../docs/reference/mocking.md#ON_CALL)
- [Matchers Reference](../api-reference/matchers-and-customization/builtin-matchers.mdx)
- [gMock Cookbook - Using Actions and Matchers](../docs/gmock_cook_book.md)
- [Designing Maintainable Mocks](../guides/mocking-best-practices/designing-better-mocks.mdx)

---

For a deeper dive, explore `googlemock/include/gmock/gmock-spec-builders.h` for detailed implementation insights and test cases in `googlemock/test/gmock-spec-builders_test.cc` demonstrating these concepts in action.