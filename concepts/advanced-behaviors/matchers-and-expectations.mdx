---
title: "Matchers, Expectations, and Verification"
description: "Gain a conceptual framework for how GoogleTest and GoogleMock implement flexible assertions and expectations. Learn about the matcher model, composable assertions, and how verification helps ensure correctness and robustness."
---

# Matchers, Expectations, and Verification

Gain a conceptual framework for how GoogleTest and GoogleMock implement flexible assertions and expectations. Learn about the matcher model, composable assertions, and how verification helps ensure correctness and robustness.

---

## Understanding Matchers in GoogleTest and GoogleMock

Matchers are the cornerstone of expressive and flexible assertions and expectations in GoogleTest and GoogleMock. They describe the conditions that function arguments or values should satisfy, going beyond simple equality checks.

### What Are Matchers?

- **Matchers** act as predicates that test whether an actual argument or value fulfills certain criteria defined in the test.
- Instead of specifying exact argument values for mock function calls, matchers offer *pattern-based* or *property-based* checks.
- For example, you can expect that an argument is any value, lies within a range, or satisfies a custom condition.

### Built-In Matcher Types

GoogleMock provides an extensive library of built-in matchers, including:

- **Wildcard Matcher:** `_` matches any argument of any type.
- **Comparison Matchers:** `Eq(value)`, `Ne(value)`, `Lt(value)`, `Le(value)`, `Gt(value)`, `Ge(value)` for equality and ordering tests.
- **Floating-Point Matchers:** approximate equality matchers suitable for floating-point comparisons considering precision errors.
- **String Matchers:** match by substring, regex, start/end of strings.
- **Container Matchers:** check container elements, their order, or unordered contents.
- **Member and Property Matchers:** validate members of objects or results of getter methods.
- **Composite Matchers:** combine multiple matchers with logical `AllOf()`, `AnyOf()`, and `Not()`.

Matchers can be combined, parameterized, and customized to capture complex argument expectations with readable, maintainable code.

### Defining Custom Matchers

Users can effortlessly define domain-specific matchers using macros like `MATCHER` and `MATCHER_P` for parameterized matchers. Custom matchers provide clear failure diagnostics by describing both the expectation and the actual mismatch, facilitating easier debugging.

---

## Expectations with `EXPECT_CALL` and Their Role in Verification

Expectations specify which calls to mock methods are anticipated, with what arguments and how many times.

### What Are Expectations?

- An **Expectation** links a mock method with argument matchers that filter the desired calls.
- GoogleMock verifies that these expectations are met during test execution.
- Expectations are specified with the `EXPECT_CALL()` macro.

### Components of an `EXPECT_CALL()` Statement

```cpp
EXPECT_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)  // Optional
    .Times(cardinality)            // Optional
    .InSequence(sequences...)      // Optional
    .After(expectations...)        // Optional
    .WillOnce(action)              // Optional, repeatable
    .WillRepeatedly(action)        // Optional
    .RetiresOnSaturation();        // Optional
```

- **Matchers** specify what arguments are acceptable.
- **With:** Allows matching the tuple of arguments collectively.
- **Times:** Specifies how many calls are expected — exact count, at least, at most, or any number.
- **InSequence:** Declares that calls occur in specified ordered sequences.
- **After:** Imposes dependency order between expectations.
- **WillOnce / WillRepeatedly:** Control the behavior (return, side effects) when the calls occur.
- **RetiresOnSaturation:** Retires expectation after meeting the specified call count to avoid “sticky” expectations.

### How Expectations Work

1. **Setup:** Expectations must be set *before* exercising the code that uses the mock, ensuring gMock can observe call violations immediately.
2. **Matching Behavior:** When a mock method is called, gMock matches the arguments against expectations, selecting the most recent active matching expectation.
3. **Over-Saturation:** Calling more times than specified by `Times` results in test failures or warnings.
4. **Ordering:** Sequences and `After()` clauses help model interaction order requirements precisely.

### Best Practices with Expectations

- Use specific matchers only where relevant to avoid brittle tests.
- Use catch-all expectations with `Times(AnyNumber())` to allow additional calls without failing unexpectedly.
- Mark expectations as **RetiresOnSaturation** for sequential calls with distinct expected behaviors.
- Manage call ordering with `InSequence` or `After` when order matters.
- Avoid mixing calls and expectations during the test to prevent undefined behavior.

---

## Default Behaviors with `ON_CALL`

While `EXPECT_CALL` specifies *expected* calls, `ON_CALL` defines what *actually* happens when a mock method is called without setting expectations.

### `ON_CALL` Syntax

```cpp
ON_CALL(mock_object, method_name(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);        // Required
```

Unlike `EXPECT_CALL`, `ON_CALL` does not verify that the method *is* called — it only specifies default behavior when the call happens.

### Practical Use of `ON_CALL`

- Set up general behaviors for mocks in test fixture setup.
- Avoid over-constraining tests with expectations for all calls.
- Later specialize or override behaviors in individual tests with `EXPECT_CALL`.

---

## Matchers, Expectations, and Verification Workflow Example

### Scenario:
You have a mock class `MockTurtle` and you want to verify that it moves to specific positions and changes pen state properly.

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
};

TEST(DrawingTest, MovesAndDraws) {
  MockTurtle turtle;

  // Set default action to allow PenUp to succeed without expectations.
  ON_CALL(turtle, PenUp()).WillByDefault(::testing::Return());

  // Expect turtle to be told precisely to go to (0, 0) exactly twice.
  EXPECT_CALL(turtle, GoTo(0, 0)).Times(2);

  // More flexible expectation: GoTo is called with any other coordinates any number of times.
  EXPECT_CALL(turtle, GoTo(::testing::_)).Times(::testing::AnyNumber());

  // Code under test called here...
  turtle.PenUp();
  turtle.GoTo(0, 0);
  turtle.GoTo(10, 10);
  turtle.GoTo(0, 0);
}
```

If `GoTo(0, 0)` is not called exactly twice as expected, or if unexpected calls occur, GoogleMock will report failures.

---

## Verification and Test Robustness

GoogleMock automatically verifies that all expectations on a mock are satisfied when the mock is destructed. Verification can be forced earlier:

```cpp
using ::testing::Mock;

// Verifies and clears expectations on mock_obj.
bool ok = Mock::VerifyAndClearExpectations(&mock_obj);
ASSERT_TRUE(ok);
```

- Use verification to catch subtle bugs early.
- Avoid setting new expectations after verification to prevent undefined behavior.
- Use `NiceMock` or `StrictMock` wrappers to control how uninteresting calls are handled, improving test clarity.

---

## Common Errors and Pitfalls

- **Setting expectations after exercising mocks:** Leads to undefined behavior.
- **Too strict matchers or cardinalities:** Can cause brittle tests that fail with refactoring.
- **Ignoring call ordering when important:** Leads to missed bugs or incomplete tests.
- **Not retiring expectations where appropriate:** Results in confusing failures for repeated calls.
- **Uninteresting calls warnings:** Use `NiceMock` to suppress or `StrictMock` to make failures.

---

## Summary

Matchers and expectations in GoogleTest and GoogleMock provide a flexible and powerful way to:

- Specify precisely which calls are expected and with what arguments.
- Define default behaviors for mock methods.
- Verify that actual calls conform to the expectations.
- Compose complex argument conditions with reusable, readable matchers.

Mastering these concepts is essential for writing robust, maintainable tests that clearly communicate intent and improve test reliability.

---

## Additional Resources

- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md)
- [Matchers Reference](https://github.com/google/googletest/blob/main/googlemock/include/gmock/gmock-matchers.h)
- [Actions Reference](https://github.com/google/googletest/blob/main/googlemock/include/gmock/gmock-actions.h)
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)

Cross-References:
- Core Concepts & Terminology
- Mocking Fundamentals with GoogleMock
- Assertions and Test Verification

---

<Tip>
Use `ON_CALL` to set default mock behaviors and `EXPECT_CALL` to enforce expected interactions. Overuse of `EXPECT_CALL` leads to brittle tests; be precise and thoughtful.
</Tip>

<Warning>
Never set expectations after the code under test has called the mock methods. Always define expectations before exercising mocks.
</Warning>

<Check>
Wrap mocks in `NiceMock<T>` to ignore uninteresting calls without warnings.
Use `StrictMock<T>` to treat uninteresting calls as errors.
</Check>

---

## Mermaid Diagram: Relationship of Matchers and Expectations in GoogleMock

```mermaid
flowchart TD
  A[User writes EXPECT_CALL] --> B[Defines matchers on mock method arguments]
  B --> C[Sets cardinality Times()]
  C --> D[Sets ordering: InSequence or After]
  D --> E[Defines actions: WillOnce / WillRepeatedly]

  subgraph Mock Method Call Process
    M1[Mock method invoked] --> M2{Match call to expectations?}
    M2 -->|Yes| M3[Execute matched expectation's next action]
    M2 -->|No| M4[Check ON_CALL defaults or global defaults]
    M3 --> M5{Upper bound exceeded?}
    M5 -->|Yes| M6[Report failure: call count exceeded]
    M5 -->|No| M7[Return or perform action]
    M4 --> M7
  end

  E --> M1

  B -.-> M2
  C -.-> M5

  Note1[Expectations must be set before mock method calls]:::note
  Note2[Matchers define argument validations for mock calls]:::note

  A --> Note1
  B --> Note2

  classDef note fill:#f9f,stroke:#333,stroke-width:1px,color:#000;
```

---