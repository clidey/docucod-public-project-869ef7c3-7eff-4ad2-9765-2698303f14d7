---
title: "Actions and Behavioral Composition"
description: "Understand how the action model in GoogleMock enables you to define, compose, and inject custom behaviors for mocked methods. Learn about built-in actions, custom actions, and the concept of invoking or forwarding real method logic."
---

# Actions and Behavioral Composition

Understanding how to define and compose behaviors for mock methods is essential to effectively control and verify interactions in tests using GoogleMock. This guide covers the concepts behind actions in GoogleMock, explaining the built-in actions, how to create custom actions, and how to compose actions to create rich, precise mock behavior.

---

## What Are Actions in GoogleMock?

Actions represent what a mock method *does* when it is called. Unlike real method implementations, mock actions define controllable, programmable behavior such as returning specific values, invoking callbacks, modifying arguments, or delegating to real methods.

When you set expectations on a mock object method, you not only specify *when* and *how* a method will be called, but also what that method should *do* via actions.

### Why Use Actions?

- **Control output:** Return values or modify output parameters according to each test’s need.
- **Simulate side effects:** Change passed-in arguments or signal state changes.
- **Invoke real or helper code:** Delegate calls to actual implementations or fakes.
- **Compose behaviors:** Combine multiple side effects and return values in a single action.

---

## Built-in Actions

GoogleMock comes with a rich set of predefined actions that cover the majority of common behaviors you will want to inject in your tests.

### Returning Values

| Action                 | Description                                                                                                     |
|------------------------|----------------------------------------------------------------------------------------------------------------|
| `Return()`             | Return from a `void` function (does nothing).                                                                 |
| `Return(value)`        | Return a specified `value`. Value conversion happens *when the expectation is set*, not at call time.          |
| `ReturnRef(variable)`  | Return a reference to the specified `variable`. Useful for reference return types.                             |
| `ReturnRefOfCopy(v)`   | Return a reference to a copy of `v` that is retained inside the action for its lifetime.                      |
| `ReturnNull()`         | Return a null pointer.                                                                                          |
| `ReturnPointee(ptr)`   | Return the value pointed to by `ptr`.                                                                           |
| `ReturnRoundRobin({})` | Cycle through the list, returning each element in sequence, restarting at the beginning.                         |

### Side Effects on Arguments

| Action                  | Description                                                                                                      |
|-------------------------|-----------------------------------------------------------------------------------------------------------------|
| `Assign(&var, val)`     | Assign `val` to a variable pointed to by `var`                                                                |
| `SetArgPointee<N>(val)` | Assign `val` to the variable pointed to by the Nth argument of the method                                      |
| `SetArrayArgument<N>(first, last)` | Copy the elements in `[first, last)` to the array pointed by the Nth argument                           |
| `SaveArg<N>(ptr)`       | Save the Nth argument by copy-assignment to the pointed `ptr`                                                  |
| `SaveArgByMove<N>(ptr)` | Move the Nth argument to the pointed `ptr`                                                                     |
| `DeleteArg<N>()`        | Delete the pointer passed as the Nth argument                                                                  |
| `SetErrnoAndReturn(err, val)` | Sets `errno` to `err` and returns `val`.                                                                     |

### Invoking Callbacks and Functions

| Action                                    | Description                                                                                                       |
|-------------------------------------------|------------------------------------------------------------------------------------------------------------------|
| `Invoke(f)`                               | Invoke a callable (function, lambda, or functor) `f` with the mock method arguments                               |
| `InvokeWithoutArgs(f)`                     | Invoke a callable `f` that takes no arguments                                                                     |
| `Invoke(object_ptr, &Class::method)`      | Invoke the specified method on an `object_ptr` object with the mock method arguments                              |
| `InvokeArgument<N>(args...)`               | Invoke the Nth argument, which must be callable, with the specified `args...`                                     |

### Composite and Modifier Actions

| Action                         | Description                                                                                                        |
|--------------------------------|-------------------------------------------------------------------------------------------------------------------|
| `DoAll(a1, a2, ..., an)`      | Perform all actions `a1` to `an`. Return the result of the last action. The first `n-1` actions must return void.   |
| `IgnoreResult(a)`             | Perform action `a` but ignore its return value                                                                    |
| `WithArg<N>(a)`               | Pass the Nth argument of the mock function to action `a`                                                          |
| `WithArgs<N1, N2,...>(a)`     | Pass specified arguments (by zero-based indices) to action `a`                                                   |
| `WithoutArgs(a)`              | Perform action `a` without arguments                                                                                |
| `DoDefault()`                 | Perform the default action set for the mock method or the built-in default action if none is set                  |

---

## Creating Custom Actions

While built-in actions provide extensive coverage, sometimes you need tailor-made behaviors.

### How to Define Custom Actions?

- Define a class or struct with a call operator that matches the signature of the mock function.
- The call operator should implement the behavior you want when that mock method is called.

Example:

```cpp
struct MultiplyBy {
  template <typename T>
  T operator()(T arg) { return arg * multiplier; }

  int multiplier;
};

// Usage in a test:
EXPECT_CALL(mock_obj, Func(_)).WillOnce(MultiplyBy{5});
```

You may also use lambdas for concise custom actions:

```cpp
EXPECT_CALL(mock_obj, Func(_)).WillOnce([](int x) { return x + 42; });
```

### Parameterized Actions

GoogleMock provides macros like `ACTION_P` and `ACTION_Pk` for defining parameterized actions if you want a friendlier syntax:

```cpp
ACTION_P(AddValue, n) {
  return arg0 + n;
}

EXPECT_CALL(mock, Foo(_)).WillOnce(AddValue(5));
```

These macros generate functor objects internally with the required interface.

---

## Composing and Sequencing Actions

Often, you need more than a simple return or single side effect — you want multiple things to happen in one mock method call.

- **Using `DoAll()`**: perform multiple actions in sequence.

  Example:
  ```cpp
  EXPECT_CALL(mock, Mutate(_))
      .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
  ```
  This sets the pointee of the first argument to 5 and returns `true`.

- **Using `WithArg()` or `WithArgs()`**: call an action with a subset or rearranged set of arguments.

  Example:
  ```cpp
  EXPECT_CALL(mock, Foo(_, _))
      .WillOnce(WithArgs<1>(Invoke(&helper, &Helper::Process)));
  ```

- **Ignoring results** when chaining actions with `IgnoreResult()` to use actions that return values in `void` functions.

---

## Delegating Calls to Real or Fake Implementations

You can integrate mock objects with existing implementations, leveraging the best of both worlds:

- **Delegate to a real object or parent method:**

```cpp
ON_CALL(mock, Method(_)).WillByDefault(
    [&](ArgType arg) { return real_.Method(arg); });
```

- **Delegate to a fake:**

```cpp
void DelegateToFake() {
  ON_CALL(*this, Method(_)).WillByDefault(
      [this](Arg arg) { return fake_.Method(arg); });
}
```

These patterns let you intercept calls for verification but preserve the original logic.

---

## Best Practices and Common Pitfalls

- Use **`ON_CALL`** to set default behavior that doesn’t impose calling expectations.
- Use **`EXPECT_CALL`** to specify that a method must be called.
- Avoid over-specifying expectations which can lead to brittle tests.
- Use `NiceMock` or `StrictMock` to control verbosity and strictness of uninteresting calls.
- Ensure move-only types are handled properly with lambdas or `WillOnce` actions.
- Avoid side effects in expectation arguments to prevent unexpected behavior.

---

## Troubleshooting

- If mock methods do not return expected values, check if the action is properly set.
- If functions aren’t called as expected, verify the order and cardinality using sequences or `.Times()`.
- Warnings about “Uninteresting mock function calls” mean method calls lacked explicit expectations.
  Use `NiceMock` or add matching `EXPECT_CALL` or `ON_CALL` for these.
- For complex sequence constraints, use `.InSequence()` or `.After()` clauses.

---

## Summary

The action model in GoogleMock enables flexible specification of behaviors for mock methods, providing built-in actions, mechanisms to compose them, and the ability to define custom behaviors.

Mastering actions empowers you to craft precise and robust interaction tests, controlling the outputs and side effects of dependencies under test with confidence.

---

## Related Documentation

- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html): Explains mock class and method declaration.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Recipes for setting expectations and using actions effectively.
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html): To control argument matching.
- [Advanced Mocking Techniques](https://google.github.io/googletest/reference/googlemock-mocking-apis/advanced-mocking-techniques.html): For delegation and strictness control.
- [Actions Reference](https://google.github.io/googletest/reference/actions.html): Complete list and details of built-in actions.

---

## Example: Using Multiple Actions Together

```cpp
class MockFoo {
 public:
  MOCK_METHOD(bool, Compute, (int* result), ());
};

TEST(MyTest, TestCompute) {
  MockFoo mock;
  EXPECT_CALL(mock, Compute(_))
      .WillOnce(DoAll(
          SetArgPointee<0>(42),  // sets *result = 42
          Return(true)));       // then returns true

  int output;
  bool success = mock.Compute(&output);

  EXPECT_TRUE(success);
  EXPECT_EQ(42, output);
}
```

This shows side-effect (modifying output argument) together with a return value.

---