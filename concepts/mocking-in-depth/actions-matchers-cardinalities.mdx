---
title: "Actions, Matchers, and Cardinalities"
description: "Explore the concept of actions (what a mock does), matchers (how arguments are validated), and cardinalities (how often calls are expected). Understand how these pieces interlock to create powerful, readable, and deterministic mocks."
---

# Actions, Matchers, and Cardinalities

Explore the concept of actions (what a mock does), matchers (how arguments are validated), and cardinalities (how often calls are expected). Understand how these pieces interlock to create powerful, readable, and deterministic mocks.

---

## Introduction

In GoogleMock, the power to create expressive, robust, and maintainable tests hinges on three foundational concepts:

- **Actions:** Define what a mock method does when invoked.
- **Matchers:** Specify how the arguments passed to a mock method are validated.
- **Cardinalities:** Control how many times a mock method is expected to be called.

Together, they enable you to precisely specify the behavior and expectations for mock methods, making your tests both readable and reliable.

---

## Actions: Defining Mock Method Behavior

When you write tests that use mocks, specifying _what_ a mock method does is crucial. An **Action** describes this behavior.

### What Are Actions?

- Actions tell the mock _how_ to respond when a method is called.
- They can return values, invoke callbacks, modify arguments, or even delete objects.
- If an action is not provided, GoogleMock uses a **default action** based on the return type (e.g., returns 0 or default-constructed objects).

### Common Built-in Actions

- `Return(value)`: Returns a specified value.
- `ReturnRef(variable)`: Returns a reference to an existing variable.
- `ReturnPointee(pointer)`: Returns the value pointed to by a pointer at call time.
- `Invoke(function or callable)`: Calls a user-provided function, method, or lambda.
- `DoAll(actions...)`: Performs several actions sequentially, with the last actionâ€™s result used as the return value.
- `SetArgPointee<N>(value)`: Sets the value pointed to by the Nth argument.
- `InvokeArgument<N>(args...)`: Calls the Nth argument if it's a callable, with the specified arguments.

### Specifying Actions Example

```cpp
using ::testing::Return;
...
EXPECT_CALL(mock_object, GetSize())
    .WillOnce(Return(5));
```

This sets the `GetSize()` mock method to return `5` the first time it is called.

### Custom Actions

You can define custom actions either with functors, lambdas, or by implementing action interfaces if your behavior is complex or reusable.

---

## Matchers: Validating Method Arguments

Matchers allow you to specify _how_ mock method arguments should be matched to expectations. They help test the interaction precisely without being brittle.

### What Are Matchers?

- Matchers test whether arguments satisfy certain conditions.
- The simplest matcher is `_`, which means "match anything".
- Matchers can be built-in (e.g., `Eq`, `Gt`, `Ne`) or custom-defined.
- Matchers are statically typed and checked by the compiler for type safety.

### Simple Matching Examples

```cpp
using ::testing::_;        // Matches anything
using ::testing::Eq;       // Equal to
using ::testing::Gt;       // Greater than
...
EXPECT_CALL(foo, DoSomething(Eq(5), _));  // 1st argument must be 5, 2nd any
EXPECT_CALL(bar, Process(Gt(0)));          // Argument must be > 0
```

### Combining Matchers

Matchers can be combined logically using `AllOf()`, `AnyOf()`, and `Not()`.

```cpp
EXPECT_CALL(foo, Calculate(AllOf(Gt(0), Lt(10))));  // Argument > 0 and < 10
```

### Multi-argument Matching

You can match arguments as a tuple (whole argument list) with `.With()` clause.

```cpp
EXPECT_CALL(foo, Func(_, _)).With(Lt());  // First arg less than second
```

### Custom Matchers

Define matchers using `MATCHER`, `MATCHER_P`, or implementation classes for fine control and descriptive errors.

---

## Cardinalities: Controlling Call Counts

GoogleMock lets you specify _how many times_ you expect a mock method to be called. This is handled via **cardinalities** typically set with the `.Times()` clause.

### Built-in Cardinalities

| Cardinality       | Description                            |
|-------------------|-------------------------------------|
| `AnyNumber()`     | Can be called any number of times.  |
| `AtLeast(n)`      | Called at least `n` times.           |
| `AtMost(n)`       | Called at most `n` times.            |
| `Between(m, n)`   | Called between `m` and `n` times.   |
| `Exactly(n)`      | Called exactly `n` times.            |

### Default Cardinality Inference

If you omit `.Times()`, GoogleMock infers the cardinality:

- No `WillOnce()` or `WillRepeatedly()`: `.Times(1)`
- `n` `WillOnce()` clauses, no `WillRepeatedly()`: `.Times(n)`
- `n` `WillOnce()` clauses and one `WillRepeatedly()`: `.Times(AtLeast(n))`

### Zero Times: Preventing Calls

To assert a method is **never** called:

```cpp
EXPECT_CALL(foo, Bar(_)).Times(0);  // Bar should never be called
```

### Cardinalities Example

```cpp
using ::testing::AtLeast;
...
EXPECT_CALL(mock_obj, DoSomething())
    .Times(AtLeast(2));  // Expect at least 2 calls
```

### Common Pitfalls

- Overly strict cardinalities lead to brittle tests.
- Overly loose cardinalities might allow bugs to slip through.

---

## How Actions, Matchers, and Cardinalities Work Together

A typical mock method expectation follows this pattern:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .Times(cardinality)
    .WillOnce(action_1)
    .WillOnce(action_2)
    .WillRepeatedly(action_n);
```

**Workflow:**
1. When `Method()` is called on `mock_object`, GoogleMock looks through the expectations.
2. It picks the last matching expectation whose argument matchers match the call's arguments and whose cardinality is not exceeded.
3. GoogleMock checks if the call count aligns with the cardinality (`Times()`).
4. The specified action is executed (e.g., return a value, invoke a callback).
5. If the call does not match any expectation, GoogleMock either performs a default action or reports an error depending on mock strictness.

---

## Best Practices & Tips

- Use `ON_CALL()` to specify default behaviors without creating strict expectations.
- Use `EXPECT_CALL()` to verify the interactions you really care about.
- Prefer matchers like `_` and `AnyNumber()` to keep tests flexible where argument values or call counts aren't important.
- Use sequences and partial ordering (`InSequence`, `After`) to verify call order.
- Use `.RetiresOnSaturation()` for expectations that should become inactive after the expected number of calls.
- Avoid mixing calls to `EXPECT_CALL()` and mock method invocations; set expectations before exercising your code.
- Use `NiceMock` or `StrictMock` wrappers to control how uninteresting calls are handled.
- Write custom matchers only when needed and keep them pure (no side effects).

---

## Troubleshooting

- **Unexpected calls:** When a mock method is called more times than expected or with unexpected arguments, GoogleMock reports an error including details on what was expected.
- **Uninteresting calls:** Calls to methods without expectations produce warnings in default mode; suppress them with `NiceMock` or suitable `EXPECT_CALL`s.
- **Actions ran out:** If your calls exceed the number of `WillOnce()` actions, GoogleMock logs a warning and uses the default or repeated action.
- **Order violations:** If calls occur out of the specified sequence, expect errors describing the violated order.
- To debug, run tests with `--gmock_verbose=info` to trace mock invocations and match failures.

---

## Example: Putting It All Together

```cpp
#include <gmock/gmock.h>

class MockTurtle {
 public:
  MOCK_METHOD(void, PenUp, (), ());
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(void, Forward, (int distance), ());
  MOCK_METHOD(void, Turn, (int degrees), ());
  MOCK_METHOD(int, GetX, (), (const));
  MOCK_METHOD(int, GetY, (), (const));
};

using ::testing::AtLeast;
using ::testing::Return;
using ::testing::_;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown())
      .Times(AtLeast(1));
  EXPECT_CALL(turtle, Forward(_))
      .Times(AnyNumber());
  EXPECT_CALL(turtle, GetX())
      .WillOnce(Return(10))
      .WillRepeatedly(Return(20));

  // ... exercise code using turtle...
}
```

This example:

- Expects `PenDown()` to be called at least once.
- Accepts any number of calls to `Forward()` with any arguments.
- Specifies return values for `GetX()` sequentially.

---

## Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html): Beginner-friendly introduction.
- [Mocking Reference](../reference/mocking.md): Detailed APIs for mocking.
- [Matchers Reference](../api-reference/advanced-mocking-matchers-actions/matchers-reference.md): All built-in matchers and how to create your own.
- [Actions Reference](../api-reference/advanced-mocking-matchers-actions/actions-reference.md): Predefined actions and creating custom ones.
- [Cardinalities & Expectations](../api-reference/advanced-mocking-matchers-actions/cardinalities-expectations.md): Full guide on controlling call counts and ordering.
- [gMock Cookbook](../docs/gmock_cook_book.md): Practical recipes to solve common mocking problems.

---

Embrace these concepts to write clean, efficient, and maintainable tests with GoogleMock, ensuring your code behaves exactly as expected.