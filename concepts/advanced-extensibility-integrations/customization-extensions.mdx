---
title: "Custom Actions, Matchers, and User Extensions"
description: "Unpack the core strategies for extending GoogleTest: defining custom actions, matchers, and user-specific primitives. This empowers users to tailor the framework to novel testing challenges and project-specific requirements."
---

# Custom Actions, Matchers, and User Extensions

Extending GoogleTest empowers you to tailor the framework for novel or project-specific testing challenges that go beyond its built-in capabilities. This guide unpacks the core strategies for defining custom actions, matchers, and user-specific primitives, enhancing your testing expressiveness and control.

---

## Why Extend GoogleTest?

The default set of matchers and actions in GoogleTest and GoogleMock covers a vast array of testing scenarios. However, your project's domain or particular testing goals may require specialized behaviors or validations that are not directly supported out-of-the-box.

Extending GoogleTest lets you:

- Create precise, reusable matchers for complex or domain-specific value constraints.
- Define custom actions that dictate how mocks behave when called.
- Build user primitives that integrate seamlessly with the mocking ecosystem.

These extensions improve test clarity, reduce duplication, and enhance maintainability.

---

## Defining Custom Matchers

Matchers specify how mock arguments are validated. While GoogleTest provides many built-in matchers, you can define your own for sophisticated checks.

### Quick Matcher Creation with MATCHER Macros

The simplest way to write a matcher is using the `MATCHER` family of macros:

```cpp
MATCHER(Name, "Optional descriptive string") {
  // 'arg' is the value being matched.
  // Return true if it matches, false otherwise.
  return /* bool condition */;
}
```

Example:

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}

// Usage:
EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

For parameterized matchers:

```cpp
MATCHER_P(IsCloseTo, value, "") {
  return std::abs(arg - value) < 0.001;
}

// Usage:
EXPECT_CALL(mock, Bar(IsCloseTo(42.0)));
```

#### Tips

- You can provide detailed failure explanations by streaming to `*result_listener` inside the matcher body.
- Use `arg_type` or `param_type` if needed to explicitly handle types for arguments and parameters.

### Creating Matcher Classes for Advanced Control

Beyond macros, define a class that:

- Declares `using is_gtest_matcher = void;`
- Implements `bool MatchAndExplain(const T& arg, std::ostream* os) const`
- Implements `void DescribeTo(std::ostream* os) const`
- Optionally implements `void DescribeNegationTo(std::ostream* os) const`

Example:

```cpp
class DivisibleBy7Matcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    int remainder = n % 7;
    if (remainder != 0 && os != nullptr) {
      *os << "the remainder is " << remainder;
    }
    return remainder == 0;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by 7";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by 7";
  }
};

::testing::Matcher<int> DivisibleBy7() {
  return ::testing::Matcher<int>(new ::testing::internal::MatcherWrapper<DivisibleBy7Matcher>(DivisibleBy7Matcher()));
}
```

This approach gives more typing control and better error messages.

### Polymorphic Matchers

To write matchers usable for multiple argument types, make `MatchAndExplain` a template:

```cpp
template <typename T>
bool MatchAndExplain(const T& arg, std::ostream* os) const {
  // Implement matching logic for type T
}
```

Example: A generic `NotNull()` matcher for any pointer.

---

## Defining Custom Actions

Actions specify what a mock function does when invoked. Custom actions allow you to model specialized behavior.

### Quick Action Definition with ACTION Macros

Define an action using:

```cpp
ACTION(Name) {
  // Return the mock function's return value
  return arg0;  // example returns first argument
}
```

For parameterized actions:

```cpp
ACTION_P(AddN, n) {
  return arg0 + n;
}
```

Usage:

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce(AddN(5));
```

### Implementing Action Classes

For precise control or polymorphic actions:

- Implement `::testing::ActionInterface<F>` where `F` is the function signature.
- Define `Result Perform(const ArgumentTuple& args)` method.

Example:

```cpp
template <typename F>
class MyAction : public ::testing::ActionInterface<F> {
  // Implement Perform() returning appropriate result.
};

// Create a user-facing helper:
::testing::Action<F> MakeMyAction() {
  return ::testing::MakeAction(new MyAction<F>());
}
```

### Polymorphic Actions

Use the `MakePolymorphicAction()` helper to allow actions to work with multiple function signatures.

Example: Return the second argument of any compatible mock function:

```cpp
class ReturnSecondArgumentAction {
 public:
  template <typename Result, typename ArgumentTuple>
  Result Perform(const ArgumentTuple& args) const {
    return std::get<1>(args);
  }
};

inline ::testing::PolymorphicAction<ReturnSecondArgumentAction> ReturnSecondArgument() {
  return ::testing::MakePolymorphicAction(ReturnSecondArgumentAction());
}
```

---

## Integrating Custom Matchers and Actions

- Custom matchers can be chained and composed with built-in matchers.
- Actions can combine effects with `DoAll()`, ignore results with `IgnoreResult()`, and manipulate arguments.
- Registered custom actions and matchers behave seamlessly within `EXPECT_CALL()` and `ON_CALL()`.

---

## Best Practices

- Write clear, descriptive matchers to ease debugging.
- Avoid side effects in matchers; they must be pure functions.
- Use parameterized macros for concise definitions of common patterns.
- Leverage polymorphism to maximize matcher and action reusability.
- Document custom extensions for team reference.

---

## Troubleshooting and Tips

- Ensure your matchers implement `DescribeTo` and optionally `DescribeNegationTo` for good failure messages.
- Use `--gmock_verbose=info` to trace mock calls and understand interactions.
- Remember ownership rules when using `Invoke()` with callbacks.
- Validate your custom matchers and actions with simple unit tests.

---

## Resources and Further Reading

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) – full of practical examples.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) – core API and detailed explanations.
- [Actions Reference](https://google.github.io/googletest/reference/actions.html) – details on built-in actions and defining new ones.
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) – comprehensive guide to matchers.

---

By mastering custom actions and matchers, you transform your tests into precise, expressive contracts that verify behavior exactly as required by your project's unique demands.