---
title: "Matchers, Actions, and Cardinalities"
description: "Understand the expressive patterns available for matching arguments to mock functions, selecting actions in response, and specifying expected call counts (cardinalities). Discover how to combine these concepts for versatile test design."
---

# Matchers, Actions, and Cardinalities

Unlock the full expressive power of GoogleMock by mastering how to specify argument matchers, define actions for mocked methods, and control how many times these mocked methods are expected to be called (cardinalities). This guide walks you through these foundational concepts, empowering you to write precise, flexible, and maintainable C++ tests.

---

## 1. Matchers: Specifying Expected Argument Patterns

Matchers let you define what kinds of arguments a mocked method is expected to receive. They act like predicates that validate the arguments passed during test execution.

### 1.1 Exact Matching
You can specify exact argument values by passing them directly:

```cpp
EXPECT_CALL(foo, DoThis(5))  // expects argument exactly 5
    .WillOnce(Return('a'));
```

### 1.2 Using Wildcards and Simple Matchers
Often, you don’t need to be so specific. Use `_` (underscore) as a wildcard matcher to accept any value:

```cpp
EXPECT_CALL(foo, DoThat(_, NotNull()));  // second argument must not be null
```

Other built-in matchers include `Ge()`, `Lt()`, `Eq()`, `NotNull()`, etc., providing a rich vocabulary to express constraints.

### 1.3 Combining Matchers
You can compose complex matchers using combinators like `AllOf()`, `AnyOf()`, and `Not()`:

```cpp
EXPECT_CALL(foo, DoThis(AllOf(Gt(5), Ne(10))));  // arg > 5 and != 10
```

### 1.4 Matching Multiple Arguments as a Tuple
Sometimes you want to validate the combined relationship of multiple arguments:

```cpp
EXPECT_CALL(foo, InRange(Ne(0), _)).With(Lt());  // arg0 != 0 and arg0 < arg1
```

Here the `.With()` clause receives a matcher over the whole tuple of arguments.

### 1.5 Custom Matchers
When built-in matchers fall short, define your own with `MATCHER` or `MATCHER_P` macros:

```cpp
MATCHER(IsDivisibleBy7, "") { return (arg % 7) == 0; }
EXPECT_CALL(foo, Bar(IsDivisibleBy7()));
```

For more power, implement matcher classes directly or write polymorphic matchers.

### 1.6 Matching Containers
Matchers like `ElementsAre()`, `UnorderedElementsAre()`, and `Pair()` enable flexible, expressive validation on container arguments:

```cpp
EXPECT_CALL(mock, Foo(ElementsAre(1, Gt(0), _, 5)));
EXPECT_THAT(map, UnorderedElementsAre(Pair("a", 1), Pair("b", 2)));
```

### 1.7 Handling Non-Copyable Arguments
If an argument cannot be copied, use `std::ref()` in your matcher to save a reference instead:

```cpp
EXPECT_CALL(mock, Foo(Eq(std::ref(bar))));
```

### 1.8 Tips & Best Practices
- Matchers must be *pure functions* with no side effects.
- Use `SafeMatcherCast<T>()` when you need to cast matchers safely between compatible types.
- To disambiguate overloaded methods, use `Const()`, `TypedEq<T>()`, or `An<T>()`.
- Use matcher variables to share complex matchers across expectations.

---

## 2. Actions: Defining Mock Method Behaviors

Actions specify what a mock method does when it is called. They allow tests to simulate behavior, inject side effects, or return values.

### 2.1 Returning Values
- `Return(value)`: Returns a copy of `value`.
- `ReturnRef(variable)`: Returns a reference to `variable`.
- `ReturnPointee(pointer)`: Returns the value pointed to by `pointer` at call time.

Example:

```cpp
EXPECT_CALL(foo, GetBar())
    .WillOnce(ReturnRef(bar_instance));
```

### 2.2 Combining Multiple Actions
Use `DoAll()` to execute multiple actions on a call (only the last action’s return value is returned):

```cpp
EXPECT_CALL(foo, Bar(_))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

### 2.3 Mocking Side Effects
Built-in side-effect actions include:
- `SetArgPointee<N>(value)`: sets the value pointed to by the Nth argument.
- `SetArrayArgument<N>(first, last)`: copies a range into an array argument.
- `Invoke()`: calls a real function/lambda/functor.
- `InvokeArgument<N>(args...)`: invokes a callable argument.

Example:

```cpp
EXPECT_CALL(mock, Mutate(true, _)).WillOnce(SetArgPointee<1>(5));
```

### 2.4 Using Lambdas and Callables
You can specify an arbitrary callable as an action, for example:

```cpp
EXPECT_CALL(foo, Sum(_, _)).WillOnce([](int a, int b) { return a + b; });
```

### 2.5 Delegating Calls
- To a fake object for default behavior.
- To the real method of a parent class.

### 2.6 Default Actions and ON_CALL
Set default behavior (with no expectation) using `ON_CALL`:

```cpp
ON_CALL(mock, Sign(_)).WillByDefault(Return(-1));
```

`EXPECT_CALL` takes precedence over `ON_CALL`. Default actions fill gaps for calls not covered by expectations.

### 2.7 Tips & Best Practices
- Use `IgnoreResult()` to discard return values from actions returning non-void when needed.
- Use `WithArgs<>` or `WithoutArgs()` to adapt arguments passed to called functions.
- Share complex actions by assigning them to variables.

---

## 3. Cardinalities: Specifying Expected Call Counts

Cardinalities let you define how many times a mock method is expected to be called.

### 3.1 Built-in Cardinalities
| Cardinality     | Meaning                          |
|-----------------|---------------------------------|
| `AnyNumber()`   | Called zero or more times        |
| `AtLeast(n)`    | Called at least `n` times        |
| `AtMost(n)`     | Called at most `n` times         |
| `Between(m,n)`  | Called between `m` and `n` times |
| `Exactly(n)` or `n` | Called exactly `n` times       |

### 3.2 Cardinality Inference
If `Times()` is omitted, GoogleMock infers cardinality:
- No `WillOnce`, no `WillRepeatedly`: `Times(1)`
- `n` `WillOnce`s, no `WillRepeatedly`: `Times(n)`
- `n` `WillOnce`s and one `WillRepeatedly`: `AtLeast(n)`

### 3.3 Custom Cardinalities
Implement `CardinalityInterface` to define your own cardinalities:

```cpp
class EvenNumberCardinality : public CardinalityInterface {
 public:
  bool IsSatisfiedByCallCount(int call_count) const override {
    return (call_count % 2) == 0;
  }

  bool IsSaturatedByCallCount(int) const override {
    return false;
  }

  void DescribeTo(std::ostream* os) const override {
    *os << "called even number of times";
  }
};

Cardinality EvenNumber() { return MakeCardinality(new EvenNumberCardinality); }
```

Use it as:

```cpp
EXPECT_CALL(foo, Bar()).Times(EvenNumber());
```

### 3.4 Sticky Expectations and Retiring
Expectations normally stay "sticky" — they remain active even after the expected number of calls is reached, causing errors if called too often. Use `.RetiresOnSaturation()` to retire an expectation after saturation:

```cpp
EXPECT_CALL(foo, Bar(7))
    .Times(2)
    .RetiresOnSaturation();
```

Advanced call ordering can be managed with `Sequence` and `InSequence`.

---

## 4. Bringing It All Together: A Typical Workflow

Here's how you combine matchers, actions, and cardinalities to write expressive tests:

```cpp
using ::testing::AtLeast;
using ::testing::Return;
using ::testing::_;
using ::testing::Lt;

TEST(FooTest, WorksWithMatchersAndActions) {
  MockFoo mock;
  EXPECT_CALL(mock, GetValue(Lt(10))) // match argument less than 10
      .Times(AtLeast(2))              // call at least twice
      .WillRepeatedly(Return(42));    // always return 42

  EXPECT_CALL(mock, SetValue(_, _))  // catch all arguments
      .WillOnce([](int key, int val) { /* side effect */ });

  // exercise code using mock...
}
```

---

## 5. Troubleshooting Common Pitfalls

- **Uninteresting calls warning:** Methods called without matching `EXPECT_CALL`. Consider using `ON_CALL` for default behavior or wrapping mocks in `NiceMock`.
- **Expectation order issues:** Use `InSequence` or `After` to enforce call order.
- **Confusing matching behavior:** Remember newer expectations override older ones.
- **Matcher side effects:** Ensure matchers are pure functions with no side effects.

---

## 6. Further Learning and References

- [GoogleMock Matchers Reference](reference/matchers.md)
- [GoogleMock Actions Reference](api-reference/gmock-apis/actions-reference)
- [GoogleMock Cardinalities and Call Expectations](api-reference/gmock-apis/cardinalities-reference)
- [Writing Custom Matchers and Actions](guides/advanced-usage-and-integration/writing-custom-matchers-and-actions)
- [Common Use Cases & Workflows](overview/feature_overview_and_use_cases/common_use_cases)
- [Mocking API & Expectations](concepts/mocking-concepts/mock-methods-expectations)

---

For comprehensive examples, patterns, and advanced techniques, visit the [gMock Cookbook](docs/gmock_cook_book.md) and explore related guides and API references.

---

<Callout title="Key Insight">
Matchers, Actions, and Cardinalities form the core grammar of GoogleMock: Matchers define *what* calls look like, Actions define *what happens* when calls occur, and Cardinalities define *how often* calls are expected. Mastering these enables tests that are robust, clear, and maintainable.
</Callout>