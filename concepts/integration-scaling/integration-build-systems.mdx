---
title: "Integration & Build System Patterns"
description: "Review the conceptual patterns for integrating GoogleTest and GoogleMock with CMake, Bazel, and other build tools, including entry points for test runners and configuration. Understand how to organize tests for maintainability and discoverability."
---

# Integration & Build System Patterns

Integrating GoogleTest and GoogleMock into your C++ project’s build and test systems requires thoughtful organization and configuration. This guide presents conceptual patterns for embedding testing frameworks with popular build tools such as CMake and Bazel. You'll also understand how to structure test entry points, manage dependencies, and organize tests to ensure maintainability and discoverability.

---

## 1. Typical Integration Patterns

GoogleTest and GoogleMock are designed to fit naturally within modern C++ build environments. Your key goals when integrating them include:

- Ensuring your test binaries link correctly against the testing framework libraries.
- Defining and using appropriate test entry points (`main()` functions) without redundant code.
- Simplifying the build configurations to maximize portability and minimize user effort.

### Standalone vs Embedded Build Configurations

You have two primary options when incorporating GoogleTest/GoogleMock:

- **Standalone Build**: Compile and build GoogleTest/GoogleMock libraries separately (e.g., via their own CMake project), then link your test binaries against them.

- **Embedded Build**: Add the GoogleTest/GoogleMock source as a subdirectory within your main project’s build system. This allows sharing compiler flags and ensures consistent build settings.


## 2. Entry Points for Test Runners

Most test users do not need to write their own `main()` function because GoogleTest provides a ready-to-use entry point library. The key components:

- **gtest_main**: Provides a default `main()` that initializes GoogleTest and runs tests.
- **gmock_main**: Similar to `gtest_main`, but also initializes GoogleMock. Typically used if you are using mock features.

If you need custom setup or teardown beyond what fixtures can provide, you can define your own `main()` and initialize GoogleTest and GoogleMock yourself:

```cpp
#include <gtest/gtest.h>
#include <gmock/gmock.h>

int main(int argc, char **argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This approach allows you to control initialization order or inject additional logic before running tests.

## 3. Integration with CMake

CMake is the officially recommended build system for GoogleTest and GoogleMock, supported with official build scripts.

### 3.1 Standalone GoogleTest CMake Integration

A typical workflow:

```bash
git clone https://github.com/google/googletest.git
cd googletest
mkdir build
cd build
cmake ..
make
sudo make install
```

To build only GoogleTest and exclude GoogleMock:

```bash
cmake .. -DBUILD_GMOCK=OFF
```

Once installed, you can link your test targets:

```cmake
find_package(GTest REQUIRED)
add_executable(my_tests test.cpp)
target_link_libraries(my_tests GTest::gtest_main)
add_test(NAME my_tests COMMAND my_tests)
```

### 3.2 Embedding GoogleTest/GoogleMock in Your Project

Often, you add GoogleTest and GoogleMock as git submodules or external dependencies. Then, in your `CMakeLists.txt`, include:

```cmake
add_subdirectory(googletest)

add_executable(my_tests test.cpp)
target_link_libraries(my_tests gtest_main gmock_main)
add_test(NAME my_tests COMMAND my_tests)
```

This approach ensures consistent compiler flags and reduces version mismatch risks.

### 3.3 Handling Compiler Runtime Settings

On Windows, mismatches between dynamic and static runtimes cause linker errors. GoogleTest has the option `gtest_force_shared_crt` to align runtimes dynamically:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

This option should be set to avoid conflicts.

### 3.4 Advanced: Using `FetchContent` for Ease of Setup

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

target_link_libraries(my_tests GTest::gtest_main GMock::gmock_main)
```

This method automates dependency fetching and building.

## 4. Integration with Bazel

Bazel users can include `@com_google_googletest//` as an external repository.

- Import `googletest` and `googlemock` sources as targets.
- Use rule definitions to build test binaries linking against these dependencies.

Exact Bazel usage is outside this document’s scope but follow analogous principles: Import, link, and run with provided test entry points.

---

## 5. Organizing Tests for Maintainability and Discoverability

A well-structured test codebase improves maintainability and speeds up debugging.

### 5.1 Group Tests into Suites and Fixtures

Group logically related tests using GoogleTest test suites and fixtures:

- Use `TEST` for independent tests.
- Use `TEST_F` with fixtures when shared setup/teardown is needed.

### 5.2 Directory Layout

Maintain a clear directory structure aligned with your source hierarchy:

```
project_root/
  src/
    ...
  tests/
    unit/
      component_a_test.cc
      component_b_test.cc
    integration/
      service_test.cc
```

### 5.3 Naming Conventions

- Follow Google C++ style for naming suites and tests.
- Avoid underscores in test names.
- Use descriptive names reflecting the behavior or component tested.

### 5.4 Test Discoverability

GoogleTest automatically discovers tests based on suites declared with `TEST` and `TEST_F`. You don’t need to register tests manually.

Structure your build rules to compile and link all test sources to ensure comprehensive test execution.

---

## 6. Customization and Tweaking Build Integration

### 6.1 Controlling Build Parameters

Build macros like `GTEST_HAS_PTHREAD` and others can be defined to tailor GoogleTest behavior on some platforms.

### 6.2 Linking with Shared or Static Libraries

You may build or link GoogleTest and GoogleMock as shared libraries or static libraries depending on your project needs using `-DGTEST_CREATE_SHARED_LIBRARY=1` and related compiler flags.

### 6.3 Avoiding Macro Name Clash

GoogleTest uses common macro names that can cause clashes. Define flags like:

```bash
-DGTEST_DONT_DEFINE_TEST=1
```

to prefix macros with `GTEST_`. This is essential in mixed codebases.

---

## 7. Troubleshooting Common Integration Issues

- **Link errors**: Verify all required GoogleTest/GoogleMock libs are linked and runtime mismatches (especially on Windows) are resolved.
- **Test not discovered or run**: Ensure tests are registered (no manual registration needed if macros used), correct entry point and linking.
- **Multiple main() definitions**: Use either provided main (gtest_main or gmock_main) or provide your own but not both.
- **Compiler incompatibilities**: Ensure C++17 support and consistent compiler flags across projects.

Refer to [Troubleshooting Common Setup Issues](/getting-started/troubleshooting/common-setup-issues) for detailed diagnostic advice.

---

## 8. Summary Workflow Example (CMake)

<Steps>
<Step title="Clone and Prepare GoogleTest">
Clone the Googletest repository and prepare build directory.
</Step>
<Step title="Build or Fetch GoogleTest">
Build GoogleTest as standalone or use CMake FetchContent for automatic integration.
</Step>
<Step title="Configure Your Project's Test Target">
Create executable targets linking against gtest_main and/or gmock_main.
</Step>
<Step title="Run Tests">
Invoke tests using `ctest` or directly execute test binaries.
</Step>
</Steps>

---

## 9. Conceptual Diagram of Integration Flow

```mermaid
flowchart TD
  subgraph Build System
    A[Configure Build System]
    B[Includes googletest & googlemock]
    C[Compiler & Linker Setup]
    D[Build Test Executables]
  end
  subgraph Test Runner
    E[Initialize GoogleMock & GoogleTest in main()]
    F[Discover Tests]
    G[Run All Tests]
    H[Report Results]
  end

  A --> B --> C --> D --> E --> F --> G --> H
```

---

For a comprehensive technical foundation, consult:

- Official [googletest README.md](https://github.com/google/googletest/blob/main/README.md) for build commands.
- [GoogleMock README.md](https://github.com/google/googletest/blob/main/googlemock/README.md) for mocking integration.
- [GoogleTest Primer](../docs/primer.md) to understand test writing and running.

---

This document helps you establish robust patterns to incorporate GoogleTest and GoogleMock effectively into your projects, ensuring scalable, maintainable, and discoverable testing infrastructure.


---

<Check>
Remember to choose the integration style that best suits your project needs—standalone builds for simplicity or embedded builds for version and configuration consistency.
</Check>
<Info>
Use `gtest_main` or `gmock_main` libraries for default test entry points unless you need customized startup logic.
</Info>
<Warning>
Avoid defining multiple `main()` functions across your test binaries to prevent linker conflicts.
</Warning>
