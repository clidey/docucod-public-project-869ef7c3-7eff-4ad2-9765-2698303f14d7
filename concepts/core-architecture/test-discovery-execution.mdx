---
title: "Test Discovery and Execution"
description: "Understand how GoogleTest and GoogleMock automatically register and run tests, including the main entry points and how tests are executed in various environments."
---

# Test Discovery and Execution

Understanding how GoogleTest and GoogleMock automatically register and run tests is fundamental to leveraging the framework’s full power. This guide explains the processes around test registration, the entry points for executing tests, and how tests run in different environments.

---

## 1. Test Registration: Automatic Discovery of Tests

GoogleTest and GoogleMock use a powerful automatic test registration mechanism that eliminates the need for manual test enumeration. When you define a test with the `TEST()` or `TEST_F()` macro, the framework automatically registers it during static initialization.

### How Test Registration Works:

- Each `TEST()` or `TEST_F()` macro invocation creates a unique test object.
- These test objects register themselves into global internal test registries before `main()` runs.
- This enables the framework to know all available tests at runtime without user intervention.
- Tests from different translation units and source files are collected seamlessly.

This automation allows you to add or remove tests without modifying any central list or configuration.

<Check>
Always use the `TEST()` or `TEST_F()` macros to ensure proper registration. Defining tests without these macros will result in tests not being discovered or executed.
</Check>

---

## 2. Test Execution: Running Your Tests

The central entry point for running all registered tests is the macro `RUN_ALL_TESTS()`. This macro is usually called from your `main()` function or through the provided `gtest_main` or `gmock_main` libraries that supply a default main.

### Typical Usage Flow:

1. **Initialization:**
   - Call `testing::InitGoogleTest(&argc, argv)` or `testing::InitGoogleMock(&argc, argv)`, which parse command-line flags for test filtering, output formatting, and other runtime options.
   - These functions also ensure GoogleMock and GoogleTest are prepared for execution.

2. **Run Tests:**
   - Call `RUN_ALL_TESTS()`
   - This triggers the test framework to iterate over all registered tests.
   - For each test:
     - Construct a fresh test fixture object.
     - Invoke `SetUp()` on the fixture.
     - Execute the test body.
     - Invoke `TearDown()` then destruct the fixture.
     - Report the test result (success or failure).

3. **Return Status:**
   - `RUN_ALL_TESTS()` returns `0` if all tests pass, otherwise a non-zero value.

### Important Notes:

- Only call `RUN_ALL_TESTS()` once per run, as multiple invocations interfere with internal test lifecycle management and features such as thread-safe death tests.

- Always return the value of `RUN_ALL_TESTS()` from your program’s `main()` to enable external tools or CI systems to detect test success or failure accurately.

---

## 3. How Tests Run in Different Environments

### Desktop and Server Platforms (Linux, Windows, macOS)

- The `main(int argc, char** argv)` function calls `InitGoogleTest()` or `InitGoogleMock()` followed by `RUN_ALL_TESTS()`.
- Command-line arguments can filter tests, control output verbosity, and configure environment variables.

### Embedded and Arduino-like Platforms

- Programs do not use the conventional `main()`.
- Instead, GoogleMock provides `setup()` and `loop()` functions (e.g., for ESP8266, ESP32, NRF52).
- `setup()` calls `InitGoogleMock()`, and `loop()` runs `RUN_ALL_TESTS()`.
- This accommodates platforms where a standard `main()` is either unavailable or not used.

### QuRT Platforms

- Platforms like QuRT use `main()` but do not provide usable command-line arguments.
- GoogleMock initializes and runs tests with adapted startup code suited to the environment.

---

## 4. Test Lifecycle: What Happens During a Test Execution

When a test is run, GoogleTest follows this precise lifecycle to promote test isolation, repeatability, and accurate reporting:

1. **Test Fixture Object Creation:**
   - Each test runs on a new instance of the test fixture class (if any).

2. **Test Setup:**
   - `SetUp()` method runs to prepare the environment.

3. **Test Body Execution:**
   - The user-defined test code runs.

4. **Test Teardown:**
   - `TearDown()` method runs to clean up.

5. **Test Fixture Destruction:**
   - The test fixture object is destructed.

6. **Result Reporting:**
   - Outcomes, such as passed assertions or failures, are collected and displayed.

<Note>
Every test has its own fixture lifecycle, ensuring that state or side effects from one test do not affect others.
</Note>

---

## 5. Practical Example: Custom `main()` Using GoogleTest and GoogleMock

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);  // Initializes both GoogleTest and GoogleMock
  return RUN_ALL_TESTS();                // Runs all registered tests
}
```

Most users do not need to implement a custom `main()` as GoogleTest and GoogleMock provide `gtest_main` and `gmock_main` libraries that supply appropriate entry points. Linking with these saves boilerplate coding.

---

## 6. Troubleshooting Common Issues

<AccordionGroup title="Common Test Execution Issues">
<Accordion title="Tests Not Running">
- Ensure you have properly used `TEST()` or `TEST_F()` macros to define your tests.
- Confirm that the test files are compiled and linked into your test executable.
- Verify that `RUN_ALL_TESTS()` is called in your main function.
</Accordion>
<Accordion title="Tests Running but No Output">
- Check if test filtering flags (`--gtest_filter`) might be hiding tests.
- Make sure `InitGoogleTest()` or `InitGoogleMock()` is called before `RUN_ALL_TESTS()`.
- Adjust verbosity flags (e.g., `--gtest_verbose=info`).
</Accordion>
<Accordion title="Multiple `main()` Definitions or Linking Errors">
- If providing custom main, link with `gtest` or `gmock` libraries, not `gtest_main` or `gmock_main`.
- If using `gtest_main` or `gmock_main`, do not write your own main.
</Accordion>
</AccordionGroup>

---

## 7. Summary Diagram of Test Discovery and Execution Flow

```mermaid
flowchart TD
  A[User Defines Tests via TEST/TEST_F Macros]
  A --> B[Automatic Test Registration at Static Init]
  B --> C[Program Starts with main()]
  C --> D[InitGoogleTest or InitGoogleMock Parses Args]
  D --> E[RUN_ALL_TESTS() Called]
  E --> F[Test Registry Iteration Begins]
  F --> G[For Each Test Instance: Create Fixture Object]
  G --> H[Run SetUp()]
  H --> I[Run User Test Body]
  I --> J[Run TearDown()]
  J --> K[Destroy Fixture Object]
  K --> L[Collect and Report Test Results]
  L --> M{More Tests?}
  M -- Yes --> F
  M -- No --> N[RUN_ALL_TESTS() Returns Passing or Failing Code]
```

---

## 8. Best Practices and Tips

- **Define tests with provided macros only** (`TEST()`, `TEST_F()`) to ensure registration.
- **Initialize GoogleTest/GoogleMock before running tests** with `InitGoogleTest()` or `InitGoogleMock()`.
- **Run `RUN_ALL_TESTS()` only once** per process.
- Use **`gtest_main` or `gmock_main` libraries** to avoid writing boilerplate main functions unless customization is required.
- Take advantage of **command-line test filters** and flags parsed during initialization to run subsets of tests.

---

## 9. Additional Resources

- [Writing Your First Test](../gtest-guides/getting-started/write_first_test)
- [Building and Running Tests](../gtest-guides/getting-started/build_and_run)
- [GoogleTest Primer](../docs/primer.md)
- [Mocking with GoogleMock](./mocking-architecture)
- [Running and Configuring Tests (API Reference)](/api-reference/core-apis/running-tests)

---

Harnessing automated test discovery and execution empowers you to write scalable, maintainable, and reliable test suites that integrate smoothly with modern development workflows and CI/CD pipelines.