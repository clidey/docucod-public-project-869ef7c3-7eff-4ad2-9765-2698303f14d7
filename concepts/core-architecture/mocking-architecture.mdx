---
title: "Mocking Model and Call Expectations"
description: "Understand how GoogleMock enables behavior-driven development by simulating objects, specifying expected calls, and defining custom actions for mock methods. This page unpacks the conceptual model for mocks, expectations, and action sequences."
---

# Mocking Model and Call Expectations

Understand how GoogleMock enables behavior-driven development by simulating objects, specifying expected calls, and defining custom actions for mock methods. This page unpacks the conceptual model for mocks, expectations, and action sequences.

---

## Introduction to the Mocking Model

GoogleMock facilitates precise control over C++ object behaviors in tests through *mock objects*. These mocks replace real implementations, letting you simulate how objects behave and interact in your system. The mocking model revolves around:

- **Mock Objects & Methods:** Stand-ins for real objects with mocked methods creating flexible interfaces.
- **Expectations:** Declarations of expected calls, including argument matchers, order, and frequency.
- **Actions:** Behaviors assigned to the mocked methods when called — including returning values, side effects, or invoking callbacks.
- **Sequences & Ordering Constraints:** Mechanisms to enforce call order and dependencies in tests.

This framework supports behavior-driven development by letting you specify the expected *interactions* between objects and then verify them automatically during test execution.

## Mock Objects: Simulated Collaborators

A *mock object* acts as a proxy for a real class instance, enabling you to set expectations on method calls dynamically. To create a mock:

- Define a mock class inheriting from the abstract or concrete class.
- Use the `MOCK_METHOD` macro to specify mock methods.

Example:

```cpp
#include <gmock/gmock.h>

class Interface {
 public:
  virtual ~Interface() = default;
  virtual int Compute(int x) = 0;
  virtual void Process(const std::string& data) = 0;
};

class MockInterface : public Interface {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));
  MOCK_METHOD(void, Process, (const std::string& data), (override));
};
```

Mock methods can be overridden further to handle constness, noexcept, or calling conventions as needed.

### Mock Object Lifecycle and Verification

When a mock object is destroyed, GoogleMock automatically verifies that all *expectations* set on the mock have been met. You can also manually verify and clear expectations early using:

```cpp
::testing::Mock::VerifyAndClearExpectations(&mock_object);
// or
::testing::Mock::VerifyAndClear(&mock_object); // also clears default actions
```

If expectations are unmet or violated, GoogleMock reports failures immediately to aid debugging.

---

## Setting Expectations with EXPECT_CALL

To specify that a mock method should be called with particular arguments a certain number of times, use the `EXPECT_CALL` macro.

### Syntax Overview

```cpp
EXPECT_CALL(mock_object, MethodName(argument_matchers...))
    .With(multi_arg_matcher)?
    .Times(cardinality)?
    .InSequence(sequences...)*
    .After(expectations...)*
    .WillOnce(action)*
    .WillRepeatedly(action)?
    .RetiresOnSaturation()?;
```

- Clauses marked with a question mark are optional.
- `With` is at most once, must be the first clause if used.
- `Times` is optional; default is inferred.
- `InSequence` and `After` can appear multiple times to specify ordering.
- `WillOnce` and `WillRepeatedly` specify the behavior when matched.
- `RetiresOnSaturation` controls expectation lifetime.

### Understanding the Components

- **Argument Matchers:** Specify how each argument should be matched (e.g., specific values, wildcards `_`, or sophisticated predicates). Missing matchers imply matching any value.

- **With Clause:** Matches the full tuple of arguments against a multi-argument matcher, adding more complex constraints on arguments collectively.

- **Times Clause:** Specifies how many times the call is expected. Possible values include exact counts (`Exactly(3)`), ranges (`Between(2,4)`), or open bounds (`AnyNumber()`, `AtLeast(n)`). If omitted, GoogleMock infers based on actions specified.

- **Sequence & After Clauses:** Define ordering constraints among expectations:
  - `InSequence` places expectations in a particular sequence.
  - `After` specifies that the current expectation must occur only after some other expectations have been satisfied.

- **Actions:** Define what happens when the mock method is called and the expectation matches.
  - `WillOnce` actions are performed for individual calls.
  - `WillRepeatedly` action is performed for all subsequent calls after `WillOnce` actions are exhausted.

- **RetiresOnSaturation:** Once the expected number of calls is reached, the expectation retires and no longer matches further calls.

### Example: Specifying Expectations

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::InSequence;

MockInterface mock;

EXPECT_CALL(mock, Compute(5))
    .Times(2)
    .WillOnce(Return(10))
    .WillOnce(Return(20));

EXPECT_CALL(mock, Process(_))
    .Times(::testing::AnyNumber());

{
  InSequence s;
  EXPECT_CALL(mock, Compute(3)).WillOnce(Return(7));
  EXPECT_CALL(mock, Compute(4)).WillOnce(Return(8));
}
```

In this example:
- `Compute(5)` is expected twice, returning 10 first and then 20.
- `Process` can be called any number of times with any argument.
- Calls to `Compute(3)` and `Compute(4)` are expected in sequence.

---

## Default Behavior with ON_CALL

While `EXPECT_CALL` sets *expectations* (verifying calls must happen), `ON_CALL` specifies default *behavior* without imposing requirements on call counts.

Syntax:

```cpp
ON_CALL(mock_object, MethodName(argument_matchers...))
    .With(multi_arg_matcher)?
    .WillByDefault(action);
```

- `ON_CALL` lets you define what a mock method returns or does when called but does *not* expect the call.
- These default behaviors are superseded by matching `EXPECT_CALL` actions.

Example:

```cpp
ON_CALL(mock, Compute(_)).WillByDefault(Return(0));
```

This sets a fallback behavior for all `Compute` calls with any argument.

---

## Calls and Matching

### Matching Expectations

When a mock method is called, GoogleMock searches the expectations in reverse order of declaration and picks the *last* matching active expectation:

- If none matches but an *ON_CALL* default is present, its action executes.
- If none matches and no default, the built-in default action runs (e.g., return 0 for numeric types).
- If the call matches an expectation but exceeds the specified `Times()` count, it is an error unless `RetiresOnSaturation()` is set.

### Uninteresting vs Unexpected Calls

- An *uninteresting call* occurs when a mock method is called that has no matching `EXPECT_CALL` expectation. By default, this emits a warning but does not fail the test.
- An *unexpected call* occurs when a mock method is called with arguments not matching any set `EXPECT_CALL`. This results in a test failure.

Use `NiceMock` and `StrictMock` wrappers to control warning and failure behavior on uninteresting calls:

- `NiceMock`: suppresses uninteresting call warnings.
- `StrictMock`: treats uninteresting calls as errors.

---

## Actions: Customizing Mock Method Behavior

An *action* defines what the mock method does when invoked and the expectation matches.

### Common Built-in Actions

- `Return(value)`: Returns the given value.
- `ReturnRef(variable)`: Returns a reference to a variable.
- `ReturnPointee(pointer)`: Returns the value pointed to by a pointer at call time.
- `Invoke(function/functor/lambda)`: Calls a user-defined callable.
- `DoAll(action1, action2, ...)`: Performs a sequence of actions, returning the last one's result.
- `SetArgPointee<N>(value)`: Sets the N-th pointer argument's pointee to a value.
- `SetArrayArgument<N>(begin, end)`: Copies an array of values into a pointer argument.
- `InvokeArgument<N>(args...)`: Invokes the N-th argument if it is callable.
- `IgnoreResult(action)`: Ignores the return value of an action, useful when the mock method returns void.

### Defining Custom Actions

You can write your own actions by:

- Using lambdas or functors compatible with the mock method's signature.
- Implementing the `ActionInterface` for fine control.
- Using the `ACTION` macros for less verbose but type-inferred simple actions.

Example of a simple lambda action:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 2; });
```

### Handling Move-only Types

GoogleMock supports mocking methods with move-only arguments (e.g., `std::unique_ptr`). Use lambdas or explicitly specify actions returning new move-only instances to handle such cases. Example:

```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](const std::string& text) {
      return std::make_unique<Buzz>(text);
    });
```

### Chaining Actions

Use `WillOnce` multiple times to specify actions on successive calls and `WillRepeatedly` to specify behavior after exhausting `WillOnce` actions. Use `DoAll` to sequence side effects plus a return value.

---

## Managing Call Order and Expectations

### Sequences with `InSequence`

To enforce strict call ordering across multiple expectations, wrap expectations in an `InSequence` block:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

The calls to `FirstCall()` and `SecondCall()` must then occur in that order.

### Partial Ordering with `After`

You can relax ordering to a DAG (directed acyclic graph) using the `.After()` clause:

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Use()).After(e1);
```

Here, `Use()` must happen after `Init()`, but other calls can interleave.

### Retiring Expectations

Use `.RetiresOnSaturation()` to retire expectations after their call limits are met, allowing subsequent matching by other expectations.

Example:

```cpp
EXPECT_CALL(mock, SetValue(7))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, SetValue(_))
    .Times(AnyNumber());
```

Once two calls to `SetValue(7)` happen, further calls to `SetValue(7)` match the catch-all expectation.

---

## Advanced Concepts and Best Practices

- **Uninteresting Calls:** By default, calling a mock method without an `EXPECT_CALL` leads to a warning but not failure; use `NiceMock` to silence these warnings.
- **Repeated Actions:** `WillRepeatedly` defines fallback behavior after `WillOnce` actions.
- **Match Argument Purposely:** Use argument matchers like `_`, `Eq()`, `Ge()`, or custom matchers to define flexible expectations.
- **Avoid Over-specification:** Only specify expectations and matchers necessary to verify your test's intent.
- **Verify Early If Needed:** Use `Mock::VerifyAndClearExpectations()` to verify mock usage before destruction.
- **Manage Mock Lifetime:** Avoid memory leaks to ensure expectations are verified, or explicitly allow leaks with `Mock::AllowLeak()`.

---

## Diagram: Expectation Matching and Call Handling

```mermaid
sequenceDiagram
    participant Test
    participant MockObj
    participant MockMethod
    participant ExpectationList

    Test->>MockObj: Call mocked method(args)
    MockObj->>MockMethod: Receive call
    MockMethod->>ExpectationList: Search expectations in reverse order
    alt Expectation matches and call count within limit
        ExpectationList-->>MockMethod: Matched expectation
        MockMethod-->>Test: Perform matched action
    else Expectation matches but saturated
        MockMethod-->>Test: Error (Too many calls)
        MockMethod-->>Test: Perform default or fallback action
    else No matching expectation
        alt Default action defined via ON_CALL
            MockMethod-->>Test: Perform ON_CALL action
        else
            MockMethod-->>Test: Perform built-in default action
    end
```

---

## Troubleshooting

### Common Issues

- **Warning: Uninteresting function call** – means a method was called without an `EXPECT_CALL`. If intended, suppress via `NiceMock` or add `EXPECT_CALL(...).Times(AnyNumber())`.
- **Unexpected mock function call** – a call's arguments don't match any `EXPECT_CALL`; verify your matchers and call sites.
- **Too many actions** – more `WillOnce` than expected calls; ensure actions correspond precisely with expected call counts.
- **Unmet expectations** – an expected call was never made; check test logic and ordering.

### Tips

- Use the `--gmock_verbose=info` flag to get detailed logs on how calls were matched.
- Use sequences and `.After()` to enforce call ordering if your test requires it.
- Always set expectations (`EXPECT_CALL`) before exercising the mock.
- If compilation slows with large mocks, move mock class constructor and destructor implementations out of inline headers.

---

## References and Next Steps

- [gMock Cookbook](gmock_cook_book.md): Practical recipes for creating and using mocks.
- [gMock for Dummies](gmock_for_dummies.md): Beginner-friendly introduction.
- [Mock Object Creation & Configuration](api-reference/mocking-apis/mock-object-creation.md): API details on defining mocks.
- [Expectations & Cardinalities](api-reference/mocking-apis/expectations-cardinalities.md): Understanding and controlling call expectations.
- [Actions & Return Values](api-reference/mocking-apis/actions-and-return-values.md): How to customize mock method behavior.
- [Matchers Reference](api-reference/mocking-apis/matchers.md): Using argument matchers effectively.

Consider exploring guides on advanced testing patterns and integration for deeper mastery:
- Parameterized and typed tests to improve test coverage.
- Death tests for verifying program termination behavior.

---

*This guide empowers you to leverage GoogleMock’s mocking model effectively for behavior-driven testing in C++ applications, ensuring robust, maintainable, and precise unit tests.*
