---
title: "The Mocking Model"
description: "Explore the conceptual model behind GoogleMock's approach to mocking C++ classes and functions. Learn how mock objects, expectations, actions, and verifications interact to simulate and validate behaviors in isolation."
---

# The Mocking Model

Explore the conceptual foundations of GoogleMock's approach to mocking C++ classes and functions. This guide illuminates the core components—mock objects, expectations, actions, and verifications—and explains how they interplay to simulate behaviors and validate isolated units effectively.

---

## Understanding Mock Objects

Mock objects are stand-ins for real C++ classes or interfaces, providing programmable behavior and verification for testing. GoogleMock enables you to create mock classes by defining mock methods that simulate real methods. These mocks not only mimic interfaces but also track interactions — who called what, with which arguments, and when.

### Defining Mock Classes

Mock classes are regular C++ classes using the `MOCK_METHOD` macro to declare mock methods. Each `MOCK_METHOD` specifies a method's return type, name, and argument list, along with optional qualifiers like `const` or `override`. For example:

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

**Key points:**
- Always declare mocks in the `public:` section, even if the base class method is `private` or `protected`. This allows `EXPECT_CALL` and `ON_CALL` to access these methods.
- Handle overloaded methods by mocking each overload explicitly.
- For methods with complex argument types involving commas, wrap them in parentheses or use `using` aliases.
- Mock class templates and non-virtual methods by creating mock methods with matching signatures.

<Note>
Make sure that overridden virtual destructors are declared `virtual` in your base classes to avoid memory and behavior issues.
</Note>

---

## Expectations: Specifying Desired Interactions

At the heart of gMock testing is setting **expectations** on mock methods. Expectations declare how many times a method is expected to be called, with which arguments, and what it should return or do.

### The EXPECT_CALL Macro

Use `EXPECT_CALL(mock_obj, Method(matchers))` to express an expectation. It allows chaining optional modifiers:

```cpp
EXPECT_CALL(mock_obj, Method(matchers...))
    .With(multi_arg_matcher)      // Restricts to calls matching as a whole
    .Times(cardinality)           // How many times the method is expected
    .InSequence(sequences...)     // Enforces the order with sequences
    .After(expectations...)       // Specifies prerequisite calls
    .WillOnce(action)             // Action for the first matching call
    .WillRepeatedly(action)       // Action for subsequent calls
    .RetiresOnSaturation();       // Deactivates expectation after usage
```

### How Expectations Work

- **Argument Matchers:** You can specify exact values or use matcher expressions like `_` for "anything", `Ge(n)` for greater or equal, or custom predicates.
- **Times:** Defines call count constraints such as `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`, or `Times(0)` for disallowing calls.
  By default, if neither `Times()` nor `WillRepeatedly()` are specified, gMock infers appropriate cardinalities based on actions.
- **Ordering:** Use `InSequence` or `.After()` clauses to control when calls occur, enabling precise simulation of call sequences or partial orderings.
- **Sticky Expectations:** By default, once an expectation saturates, it remains active and causes failures on additional calls unless marked with `.RetiresOnSaturation()`.

### Best Practice Tips

- Avoid over-specification in tests — only verify what actually matters.
- Use `ON_CALL` to specify default behaviors without enforcing expectations.
- Provide catch-all expectations with `.Times(AnyNumber())` if some calls are allowed but uninteresting.

---

## Actions: Defining Mock Behavior

An action specifies what a mock method does when called. If no action is specified, a suitable default is taken (e.g., returning zero or default-constructed objects).

### Setting Actions

Actions are assigned inside `EXPECT_CALL` or `ON_CALL` clauses using:
- `.WillOnce(action)` — for a single invocation.
- `.WillRepeatedly(action)` — for subsequent or all calls.

Actions include:
- `Return(value)` — returns a value.
- `ReturnRef(variable)` — returns a reference.
- `ReturnPointee(ptr)` — returns the value pointed by a pointer at execution time.
- `Invoke(function_or_lambda)` — calls a callable with mock's arguments.
- `SetArgPointee<N>(value)` — sets the value pointed to by argument N.
- `DoAll(...)` — performs multiple sub-actions sequentially.

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly(Invoke([]() { return GenerateLiveValue(); }));
```

<Note>
Be careful to avoid side effects inside `Return()` arguments, which are evaluated once when the expectation is set, not per call. Use lambdas for dynamic behaviors.
</Note>

---

## Default Actions and ON_CALL

While `EXPECT_CALL` sets an expectation and an action, `ON_CALL` just sets a default action for when no expectation matches. It is used for specifying how a mock method behaves generally without enforcing that it must be called.

```cpp
ON_CALL(mock, Method(_)).WillByDefault(Return(default_value));
```

Use `ON_CALL` to avoid verbose and brittle tests that specify too many `EXPECT_CALL`s.

---

## Call Verification

GoogleMock verifies that all expectations were satisfied when a mock object is destroyed. You can also explicitly trigger verification:

```cpp
ASSERT_TRUE(Mock::VerifyAndClearExpectations(&mock_obj));
```

Mistakes like calling a mock method more than expected or with unexpected arguments cause immediate test failures. This helps catch bugs early and keeps interaction testing robust.

<Warning>
Avoid setting expectations on mocks after they have been used or after verification to prevent undefined behaviors.
</Warning>

---

## Mock Strictness: Nice, Naggy, and Strict

By default, mocks are "naggy" — they warn on uninteresting calls (calls with no matching `EXPECT_CALL`). You can change this behavior:

- `NiceMock<T>` suppresses such warnings.
- `NaggyMock<T>` enables warnings (default).
- `StrictMock<T>` treats uninteresting calls as errors.

```cpp
NiceMock<MockFoo> nice_mock;
EXPECT_CALL(nice_mock, DoIt());

StrictMock<MockFoo> strict_mock;
EXPECT_CALL(strict_mock, DoIt());
```

Use strict mocks sparingly as they can make tests brittle.

---

## Interaction and Data Flow Among Components

1. **Mock Object Creation:** You declare a mock class with `MOCK_METHOD`s.
2. **Default Action Setup:** Use `ON_CALL` to specify default behaviors.
3. **Setting Expectations:** Declare expectations using `EXPECT_CALL`, defining argument matchers, action sequences, call counts, and ordering.
4. **Test Execution:** Code under test interacts with the mock; calls are intercepted and verified.
5. **Verification:** On test completion or mock destruction, all expectations are validated for correctness.

---

## Common Scenarios & Pitfalls

- **Overlapping Expectations:** Place more specific `EXPECT_CALL`s after general ones so they take precedence.
- **Order of Calls:** Use `InSequence` or `After()` to enforce call ordering.
- **Match All Arguments:** Use `_` to accept any argument (wildcard matcher).
- **Avoid Unexpected Calls:** Use `.Times(0)` to disallow certain method calls.
- **Managing Expectations for Overloaded Methods:** Explicitly mock all overloads or use `using Base::Method` to avoid hiding warnings.

---

## Practical Example

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(PainterTest, MovesTurtle) {
  MockTurtle mock_turtle;

  ON_CALL(mock_turtle, GetX()).WillByDefault(Return(100));

  {
    InSequence seq;
    EXPECT_CALL(mock_turtle, PenUp());
    EXPECT_CALL(mock_turtle, Forward(100)).Times(1);
  }

  Painter painter(&mock_turtle);
  EXPECT_TRUE(painter.DrawLineTo(100));
}
```

In this test, the mock turtle is expected to have its pen lifted then moved forward by 100 units.

---

## Troubleshooting and Debugging

- Run tests with `--gmock_verbose=info` to see detailed traces of matching expectations and calls.
- Use `NiceMock` to suppress uninteresting call warnings during early test development.
- Beware of expectation saturation errors when mock methods are called more than specified.
- Verify mocks explicitly if they outlive the test scope.

---

## Further Learning and References

For deeper understanding and advanced scenarios, consult:

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — detailed recipes for mock usage.
- [Mocking Reference](../api-reference/core-apis/mocking-and-methods.html) — technical reference for mock methods and expectations.
- [Actions Reference](../api-reference/advanced-behaviors/mock-actions.html) — explore the full range of available actions.
- [Matchers Reference](../api-reference/advanced-behaviors/argument-matchers.html) — comprehensive matcher documentation.
- [Using Mocks and Writing Tests Guide](/guides/effective-testing-techniques/mocking-workflows) — practical guidance for writing tests with mocks.

---

This explanation is focused keenly on the conceptual model underlying GoogleMock's mocking approach, showing how mock objects, expectations, actions, and verifications entwine to form reliable and maintainable C++ tests.
