---
title: "Mocking Fundamentals in C++"
description: "Understand GoogleMock's approach to creating and controlling mocks, including the role of mock classes, expectation setting, and strictness policies. Learn how mocks simulate dependencies and enforce contract-based testing through programmable behavior."
---

# Mocking Fundamentals in C++

GoogleMock (gMock) is Google's powerful and easy-to-use C++ framework for creating and controlling mock objects in tests. Mocks simulate dependencies, allowing you to precisely specify and verify interactions between components, and enforce contract-based testing by programming expected behaviors.

---

## What is a Mock Object?

A mock object is a test double that mimics a real object by implementing the same interface but allowing test authors to specify:

- **Which methods will be called**
- **With what arguments**
- **In what order**
- **How many times**
- **And what those methods should return or do**

Unlike fakes (partial or simplified working implementations), mocks focus on *interaction-based testing*: verifying the sequence and parameters of calls made on them.

---

## Creating Mock Classes

Mock classes are normal C++ classes where you declare mock methods using `MOCK_METHOD` macros. These macros generate all the plumbing to track method calls and support expectation setting.

### Defining Mock Methods

The `MOCK_METHOD` macro definition syntax is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Specifiers...));
```

- `ReturnType`: the return type of the method.
- `MethodName`: the method name.
- `Args...`: argument types wrapped in parentheses.
- `Specifiers...` (optional): method qualifiers like `const`, `override`, `noexcept`, calling convention, and reference qualifiers.

Example:

```cpp
class MockTurtle : public Turtle {
 public:
   MOCK_METHOD(void, PenUp, (), (override));
   MOCK_METHOD(void, Forward, (int distance), (override));
   MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Important Notes

- **Comma issues**: If the return type or arguments contain commas (e.g. templates), wrap them in parentheses or use type aliases to avoid macro parsing errors.

```cpp
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD(BoolAndInt, GetPair, ());
```

- **Access Level**: Always place `MOCK_METHOD` declarations in the `public:` section even if mocking private or protected virtual methods.

- **Overloaded methods**: Mock each overload explicitly. Use `using Base::Method;` in your mock class if you want to avoid hiding some overloads.

- **Class templates**: Mocking templated classes is supported similarly by defining templates as usual.

Example for overloaded & const methods:

```cpp
class MockFoo : public Foo {
 public:
   MOCK_METHOD(int, Add, (Element x), (override));
   MOCK_METHOD(int, Add, (int times, Element x), (override));
   MOCK_METHOD(const Bar&, GetBar, (), (const, override));
};
```

---

## Setting Expectations

Expectations specify what calls you expect your mock object to receive and prescribe their behavior.

### Using `EXPECT_CALL`

Syntax:

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- **Matchers** describe expected argument values (e.g., `5`, `_` for any, or predicate matchers like `Ge(10)`).
- **Times** controls how many times the call is expected.
- **WillOnce** and **WillRepeatedly** specify behavior for calls.

Example:

```cpp
EXPECT_CALL(turtle, Forward(Ge(10)))
    .Times(AtLeast(1))
    .WillRepeatedly(Return());
```

If `Times` is omitted, GoogleMock infers it:

- No action clauses: `Times(1)`
- With `n` `WillOnce` clauses: `Times(n)`
- With `n` `WillOnce` + `WillRepeatedly`: `Times(AtLeast(n))`


### `ON_CALL` for Default Behavior

Use `ON_CALL` to specify default behavior without an expectation that the method will be called:

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .WillByDefault(action);
```

This sets what happens when the method is called but doesn’t enforce an expectation.

### Uninteresting vs Unexpected Calls

- **Uninteresting call**: method has *no* `EXPECT_CALL` set for it. By default, this logs a warning but is not an error.
- **Unexpected call**: method *has* `EXPECT_CALL`s but none match the arguments. This is always an error.

---

## Mock Strictness Policies

GoogleMock supports three strictness levels to control uninteresting call handling:

| Policy       | Behavior on Uninteresting Calls                           |
|--------------|----------------------------------------------------------|
| **NaggyMock** (default) | Logs warnings on uninteresting calls, but test continues.    |
| **NiceMock**            | Suppresses warnings, allowing uninteresting calls silently. |
| **StrictMock**          | Treats uninteresting calls as test failures (errors).       |

These wrap your mock class:

```cpp
NiceMock<MockFoo> nice_mock;  // suppress warnings
NaggyMock<MockFoo> naggy_mock; // warnings
StrictMock<MockFoo> strict_mock; // errors
```

Use **NiceMock** when you want cleaner output and are confident uninteresting calls are harmless. Use **StrictMock** in tests where you want to ensure all calls are anticipated explicitly.

### Example

```cpp
class MockFoo {
 public:
   MOCK_METHOD(void, DoSomething, ());
};

// Usage:
NiceMock<MockFoo> mock;
EXPECT_CALL(mock, DoSomething());
mock.DoSomething();  // No warning on other calls
```

### Caveats

- Works only for methods mocked *directly* in your mock class, not methods inherited via base classes.
- Requires destructors to be virtual for correct behavior.

---

## Writing Actions

Actions specify what a mock method does when called.

- `Return(value)` makes the method return `value`.
- `ReturnRef(variable)` returns a reference to `variable`.
- `Invoke(function)` calls a function/lambda/functor.
- `SetArgPointee<N>(value)` changes the N-th pointer argument’s pointee.
- Composite actions like `DoAll()` chain multiple actions.

Example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly([]() { return 7; });
```

---

## Key User Workflows

### Defining a Mock Class

1. Derive from the interface you want to mock.
2. Declare mock methods with `MOCK_METHOD` in the public section.
3. Use qualifiers like `(const, override)` as needed.

### Creating and Using Mocks

1. Import GoogleMock names (`using ::testing::...`).
2. Instantiate mock objects or strictness wrappers.
3. Use `ON_CALL` to define default behavior.
4. Use `EXPECT_CALL` to specify expected calls.
5. Exercise your code under test.
6. Let the mock object’s destructor verify expectations.

### Handling Uninteresting Calls

- Ignore with `NiceMock`.
- Expect explicitly or suppress warnings with `EXPECT_CALL(...).Times(AnyNumber())`.
- Fail fast by using `StrictMock`.

### Controlling Call Order

- Use `InSequence` for strict sequential expectations.
- Use `Sequence` and `.InSequence(...)` for partial ordering.
- Use `.After(...)` to enforce that some calls happen after others.

### Dealing with Complex Actions

- Combine actions with `DoAll()`.
- Pass lambdas or existing functions via `Invoke()`.
- Use `SaveArg<N>(&var)` to capture arguments for later assertions.

---

## Best Practices

- Define mocks only for interfaces you own when possible.
- Use `ON_CALL` for default behavior, minimizing `EXPECT_CALL` to essential verifications.
- Use strictness wrappers logically; prefer `NiceMock` during development, `StrictMock` for strict contract enforcement.
- Retire expectations on saturation when using multiple `WillOnce` calls with `.RetiresOnSaturation()`.
- Avoid over-specifying tests; expect only what matters.

---

## Troubleshooting Frequent Issues

- **Uninteresting call warnings**: consider using `NiceMock` or add catch-all permissive expectations.
- **Failure due to unexpected calls**: verify matchers and ensure expectations cover call arguments.
- **Compiler errors mocking methods with commas in signatures**: wrap types in parentheses or typedef aliases.
- **Mock methods not called or matched**: check the order and presence of `EXPECT_CALL` before invoking mock.

---

## Summary

GoogleMock enables writing mocks in C++ with ease, specifying expected calls, argument verification, and mock method behaviors. Using `MOCK_METHOD`, you define mock methods; `EXPECT_CALL` and `ON_CALL` control expectations and default behaviors. Strictness policies regulate how unanticipated calls are handled, helping maintain clean and robust tests.

For more detailed instructions and advanced usage, consult the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) and [Mocking Reference](https://google.github.io/googletest/reference/mocking.html).

---

## Further Reading & Links

- [Creating and Using Basic Mocks](../guides/mocking-scenarios/creating-basic-mocks.mdx)
- [Mock Strictness Best Practices](../guides/mocking-scenarios/mock-strictness-best-practices.mdx)
- [Matchers Reference](../api-reference/matcher-actions/matcher-reference.mdx)
- [Actions Reference](../api-reference/matcher-actions/action-reference.mdx)
- [Cardinalities and Expectations](../api-reference/mocking-apis/cardinalities-and-expectations.mdx)

---

<AccordionGroup title="Useful Code Examples">
<Accordion title="Defining a Simple Mock Class">
```cpp
class MockPrinter : public Printer {
 public:
   MOCK_METHOD(void, Print, (int n), (override));
   MOCK_METHOD(void, Print, (char c), (override));
};
```
</Accordion>
<Accordion title="Setting Expectations and Default Actions">
```cpp
using ::testing::Return;

MockPrinter mock;

ON_CALL(mock, Print(42))
    .WillByDefault(Return());

EXPECT_CALL(mock, Print(10))
    .Times(1);

mock.Print(10);  // Expected call
mock.Print(42);  // Default action
```
</Accordion>
<Accordion title="Choosing Strictness">
```cpp
using ::testing::NiceMock;

NiceMock<MockPrinter> nice_mock; // ignores uninteresting calls
EXPECT_CALL(nice_mock, Print(10));
nice_mock.Print(5);  // no warning here
```

```cpp
using ::testing::StrictMock;

StrictMock<MockPrinter> strict_mock; // fails on uninteresting calls
EXPECT_CALL(strict_mock, Print(10));
strict_mock.Print(5);  // test failure
```
</Accordion>
<Accordion title="Dealing with Overloads">
```cpp
class MockFoo : public Foo {
 public:
   MOCK_METHOD(int, Add, (int x), (override));
   MOCK_METHOD(int, Add, (double x), (override));
};

// When calling EXPECT_CALL, must disambiguate overload:
EXPECT_CALL(mock, Add(::testing::An<int>()));
EXPECT_CALL(mock, Add(::testing::An<double>()));
```
</Accordion>
</AccordionGroup>
