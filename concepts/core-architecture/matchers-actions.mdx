---
title: "Matchers and Actions"
description: "Discover how the matcher and action systems allow expressive, flexible specification of behaviors and validations. Learn about built-in matchers, custom matchers, and how actions drive test execution."
---

# Matchers and Actions

Discover how the matcher and action systems allow expressive, flexible specification of behaviors and validations. This guide covers how to use built-in matchers, create custom matchers, and control the execution flow of tests through actions, empowering you to write precise, maintainable mock-based tests.

---

## Understanding Matchers

Matchers are predicates or conditions that specify what arguments mock methods expect to receive. They are fundamental in defining expectations and controlling test behavior.

### Basic Usage
- Matchers can be simple values or complex predicates.
- Use the wildcard matcher `_` to accept any value.
- Combine matchers to express complex conditions.

### Examples
```cpp
using ::testing::_;      // wildcard matcher
using ::testing::Ge;     // Greater or equal matcher

// Expect the method DoThis() to be called with an argument >= 5.
EXPECT_CALL(foo, DoThis(Ge(5)));

// Accept any int as the first argument and a non-null pointer as the second.
EXPECT_CALL(foo, DoThat(_, NotNull()));
```

### Multi-Argument Matchers
Matchers can also be applied to all arguments combined as a tuple.

```cpp
// Expect DoThis(x, y) only when x < y
EXPECT_CALL(foo, DoThis(_, _))
    .With(Lt());
```

Where `With()` receives a matcher of the full argument tuple.

### Combining Matchers
Build complex matchers from simpler ones:

- `AllOf(m1, m2, ...)` — all matchers must pass.
- `AnyOf(m1, m2, ...)` — any matcher passes.
- `Not(m)` — negates matcher `m`.

Example:
```cpp
EXPECT_CALL(foo, Process(AllOf(Ge(5), Ne(10))));
```

### Common Built-in Matchers
- Equality and relational: `Eq()`, `Ne()`, `Lt()`, `Le()`, `Gt()`, `Ge()`
- Containers: `ElementsAre()`, `UnorderedElementsAre()`, `Contains()`, `Each()`
- Strings: `StrEq()`, `HasSubstr()`, `StartsWith()`, `EndsWith()`
- Pointers: `IsNull()`, `NotNull()`, `Pointee(matcher)` — matches the pointed-to value

### Matching Object Members
Use `Field()` and `Property()` to match specific members or properties of complex objects.

```cpp
EXPECT_CALL(foo, Update( Field(&MyClass::bar, Ge(10)) ));
EXPECT_CALL(foo, Update( Property(&MyClass::baz, StartsWith("John")) ));
```

### Custom Matchers
Define your own matchers using macros or matcher classes for specialized validation logic:

```cpp
MATCHER(IsDivisibleBy7, "is divisible by 7") {
  return (arg % 7) == 0;
}

EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

Tips for custom matchers:
- Include detailed failure explanations.
- Ensure matchers have no side-effects.
- Consider parameterized matchers if arguments are needed.

---

## Setting Expectations and Actions

Matchers specify "_what_" to expect; actions specify "_what to do_" when those expectations are met.

### `EXPECT_CALL`
Defines an expectation on a mock method call with specific arguments.

Syntax:
```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)   // optional, once
    .Times(cardinality)        // optional, once
    .InSequence(sequences...)  // optional
    .After(expectations...)    // optional
    .WillOnce(action)          // any number
    .WillRepeatedly(action)    // at most once
    .RetiresOnSaturation();    // optional
```

### `ON_CALL`
Defines a default action for a mock method call without setting expectations.

Syntax:
```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)  // optional, once
    .WillByDefault(action);   // required once
```

`ON_CALL` actions apply when no `EXPECT_CALL` matches a call.

### Key Points on Expectations
- Use `EXPECT_CALL` to verify particular interactions.
- Use `ON_CALL` to provide default behaviors.
- `Times()` controls how many calls are expected.
  - `Times(0)` means the call is disallowed.
  - Omitted `Times()` is inferred from `WillOnce` and `WillRepeatedly` usage.
- `.InSequence()` enforces ordered calls.
- `.After()` enforces partial order dependencies.
- `.RetiresOnSaturation()` makes an expectation inactive after reaching its call limit.

### Examples
```cpp
using ::testing::AtLeast;
using ::testing::Return;
using ::testing::InSequence;

{
  InSequence s;
  EXPECT_CALL(mock, Initialize()).Times(1);
  EXPECT_CALL(mock, Execute()).Times(AtLeast(1)).WillRepeatedly(Return(true));
}

ON_CALL(mock, Initialize()).WillByDefault(Return());
```

### Understanding Call Matching Order
Newer expectations take precedence over older ones. To avoid surprises:
- Put generic catch-all expectations (with `_`) first.
- Then add more specific expectations later.

Example:
```cpp
EXPECT_CALL(mock, Foo(_)).Times(AnyNumber());  // Default catch-all
EXPECT_CALL(mock, Foo(42)).Times(2).RetiresOnSaturation(); // Specific override
```

### Uninteresting vs Unexpected Calls
| Call Type     | Description                          | Behavior                     |
| ------------- | ------------------------------------ | ------------------------------ |
| Uninteresting | No `EXPECT_CALL` for the method      | Warning by default; ignored  |
| Unexpected    | `EXPECT_CALL`s present but did not match args | Test failure (error)   |

Use `NiceMock` to suppress warnings on uninteresting calls, or `StrictMock` to turn uninteresting calls into errors.

---

## Actions: Defining Mock Behaviors

Actions define what a mock method returns or does when called.

### Built-in Actions
- `Return(value)` — returns a fixed value.
- `ReturnRef(variable)` — returns a reference to a variable.
- `ReturnPointee(pointer)` — returns the value pointed to, evaluated at call time.
- `DoAll(action1, action2, ...)` — performs multiple actions in order; last return used.
- `SetArgPointee<N>(value)` — sets the value pointed to by argument N.
- `SetArrayArgument<N>(first, last)` — copies a range to an output array argument.
- `Invoke(function)` — calls a real function or method instead of returning a value.
- `InvokeWithoutArgs(function)` — calls a function taking no arguments.
- `InvokeArgument<N>(args...)` — invokes callable argument N with given args.
- `IgnoreResult(action)` — ignores the return value of an action.
- `DeleteArg<N>()` — deletes the pointer passed as argument N.

### Defining Actions for Move-Only Types
Use lambdas or compatible callables within `WillOnce` or `WillRepeatedly`.

Example:
```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
        return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

### Combining Actions
Multiple side-effects can be chained:
```cpp
EXPECT_CALL(fake, Mutate(true, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

### Changing Behavior over Time
Use sequences or variables to model state changes.

Example:
```cpp
{
  InSequence seq;

  EXPECT_CALL(mock, IsDirty()).WillRepeatedly(Return(true));
  EXPECT_CALL(mock, Flush());
  EXPECT_CALL(mock, IsDirty()).WillRepeatedly(Return(false));
}
mock.FlushIfDirty();
```

### Default Values
Mock methods return default values if not specified. Customize with `DefaultValue<T>::Set()`.

### Using Functions or Lambdas as Actions
Any callable compatible with the mock signature can be used.

Example:
```cpp
EXPECT_CALL(mock, Sum(_, _))
    .WillOnce(&CalculateSum)
    .WillRepeatedly(Invoke([](int x, int y) { return x + y + 1; }));
```

---

## Best Practices and Tips

- Use `ON_CALL` to set sensible default behaviors.
- Use `EXPECT_CALL` to verify important interactions only.
- Use `NiceMock` and `StrictMock` wisely for control over warnings and failures.
- Use `RetiresOnSaturation()` to avoid sticky expectations that cause tests to break on repeated calls.
- Define custom matchers and actions to express domain-specific constraints cleanly.
- Avoid over-specifying tests to reduce brittleness.
- Order your expectations carefully to ensure the correct match precedence.
- Use sequences or partial ordering for controlling call order only when necessary.
- For methods with complex arguments, use `SaveArg` and verify separately.

---

## Common Pitfalls & Troubleshooting

<Tip>
If you see warnings about "Uninteresting mock function call," check if you have forgotten an `EXPECT_CALL`. If calls are expected but warnings occur, consider using `NiceMock` or add explicit `EXPECT_CALL` with `Times(AnyNumber())` for less important calls.
</Tip>

<Warning>
Mock methods without virtual destructors may cause resource leaks or undefined behavior. Ensure base classes for mocks have virtual destructors.
</Warning>

<Note>
Sticky expectations keep matching calls even after saturation, which can cause unexpected test failures. Use `.RetiresOnSaturation()` or sequences to avoid this.
</Note>

<Info>
Use `--gmock_verbose=info` to enable verbose logging of mock calls and expectation matches to debug test failures.
</Info>

---

## Additional Resources

For more detailed recipes and examples, see:

- [GoogleMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)
- [GoogleMock for Dummies](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](reference/actions.md)
- [Mocking Reference](reference/mocking.md)

Explore related documentation sections:
- [Mock Method Definition (MOCK_METHOD)](/api-reference/core-mocking-api/mock-method-definition)
- [Setting Expectations and Actions](/api-reference/core-mocking-api/setting-expectations-actions)
- [NiceMock, NaggyMock, and StrictMock Controls](/api-reference/mock-behavior-extensions/nice-naggy-strict-mocks)

---

**Master the expressive GoogleMock matchers and actions to write robust, readable, and maintainable tests that precisely verify your C++ code interactions.**
