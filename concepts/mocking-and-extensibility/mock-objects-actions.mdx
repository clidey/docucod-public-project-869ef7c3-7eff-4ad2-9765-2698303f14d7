---
title: "Mock Objects and Actions"
description: "Understand the conceptual model behind creating, configuring, and using mocks in GoogleMock. This page explains how mock objects leverage actions and cardinality expectations to model interactions and drive test outcomes, including the use of custom actions and advanced behaviors."
---

# Mock Objects and Actions

Understanding how mocks function within GoogleMock is essential to effectively testing interactions and behaviors in C++ code. This guide demystifies the conceptual model underlying the creation, configuration, and usage of mock objects, focusing on how they use actions and cardinality expectations to simulate and verify interactions. It covers how expectations define method call patterns, how actions govern mock method behavior, and explores advanced features such as sequencing and custom actions.

---

## Introduction to Mocks

A *mock object* in GoogleMock implements the same interface as a real object but enables specification at runtime of expected method calls, their order, frequency, arguments, and behaviors. Mocks allow verification of interactions between the code under test and its dependencies, increasing test robustness and clarity.

### Core Idea

- You define *expectations* on mock methods using `EXPECT_CALL`, declaring which methods should be called, how often, with what arguments.
- You specify *actions* describing what happens when a mocked method is invoked.
- GoogleMock automatically verifies expectations during test execution and reports violations immediately.


## Creating Mock Methods: `MOCK_METHOD`

Mocks are implemented by mocking virtual methods in a mock class, created by the macro `MOCK_METHOD`:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
```

- Defines a method that overrides the base class virtual method.
- Place inside the `public:` section of the mock class regardless of base method access level.
- Supports qualifiers like `const`, `override`, `noexcept`, calling conventions (`Calltype()`), and reference qualifiers (`ref()`).

**Example:** Mocking a Turtle interface:

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

**Tip:** Use parentheses or typedefs to handle types with commas properly.


## Setting Expectations: `EXPECT_CALL`

After defining mocks, expectations about their usage specify *what* calls are expected and *how they behave*.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)?
    .Times(cardinality)?
    .InSequence(sequences...)*
    .After(expectations...)*
    .WillOnce(action)*
    .WillRepeatedly(action)?
    .RetiresOnSaturation()?;
```

- The `matchers...` define argument conditions; omitting them implies wildcard matchers.
- Clauses after the macro modify expectations. The `?` indicates optional, `*` multiple allowed.

### Understanding Clauses

- **`.With(multi_arg_matcher)`**: Applies compound matching on all arguments as a tuple; can be used once at most and must appear first.

- **`.Times(cardinality)`**: Specifies how many times the call is expected, supporting exact, at least, at most, range, or any number calls. If omitted, GoogleMock infers cardinality.

- **`.InSequence(sequences...)`**: Specifies that this call must occur in order relative to others in the provided sequences.

- **`.After(expectations...)`**: Declares that this expectation will only match after certain other expectations occur.

- **`.WillOnce(action)`**: Defines behavior for a matched call, used for one occurrence. The order of multiple `.WillOnce` clauses correlates to successive calls.

- **`.WillRepeatedly(action)`**: Defines behavior for all subsequent matched calls after `.WillOnce`s are exhausted.

- **`.RetiresOnSaturation()`**: Marks that the expectation becomes inactive once its upper bound on calls is reached.

### Example

```cpp
EXPECT_CALL(turtle, GetX())
    .Times(3)  // Expect exactly three calls
    .WillOnce(Return(100))  // Return 100 first call
    .WillOnce(Return(150))  // Return 150 second call
    .WillRepeatedly(Return(200));  // Return 200 after
```


## Default Behavior: `ON_CALL`

`ON_CALL` specifies the default behavior of a mock method without asserting it *must* be called.

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)?
    .WillByDefault(action);
```

Useful for specifying fallback behaviors that allow tests to run when specific expectations are not set.


## Cardinalities: Controlling Call Counts

Cardinalities direct how often a mock method is expected to be invoked.

- `Exact(n)`, `AtLeast(n)`, `AtMost(n)`, `Between(m, n)`, `AnyNumber()`
- `Times(0)` disallows calls with given arguments.
- Cardinality can be inferred from the presence and count of `.WillOnce()` and `.WillRepeatedly()` clauses.

Correct use of cardinality ensures tests validate interaction frequencies precisely.


## Actions: Defining Mock Method Behaviors

Actions describe *what happens* when a mock method is invoked. GoogleMock provides many built-in actions such as:

- `Return(value)`: Returns a value.
- `ReturnRef(variable)`: Returns a reference.
- `SetArgPointee<index>(value)`: Sets an output argument.
- `Invoke(function)`: Runs a function or lambda.
- `DoAll(...)`: Chains multiple actions sequentially.

Users can also define custom actions using lambdas or functors compatible with the method signature.


## Ordering and Sequences

GoogleMock supports ordering expectations to verify correct invocation order.

- **Unordered:** By default, calls may match expectations in any order.
- **Strict Order:** Using an `InSequence` object or `.InSequence` clause to require sequential matching.
- **Partial Order:** Use `.After()` clauses to define dependency relationships between expectations, capturing complex call orders in DAG form.


## Sticky Expectations and Retirement

Expectations are *sticky* by default, meaning they remain active after reaching call count limits to detect overshoot errors. Use `.RetiresOnSaturation()` to deactivate expectations when saturated, which prevents overshoot failures and is especially important when layering expectations.


## Using Nice, Naggy, and Strict Mocks

GoogleMock provides wrappers to adjust how uninteresting calls (calls with no associated expectations) are treated:

- **NiceMock<T>**: Suppresses warnings for uninteresting calls.
- **NaggyMock<T>**: Generates warnings for uninteresting calls (default behavior).
- **StrictMock<T>**: Treats uninteresting calls as test failures.

Choosing the right strictness controls test noise and brittleness.


## Advanced Behaviors

- **Custom Actions:** Users define arbitrary behaviors using lambdas or action classes, allowing mocking complex side effects or state changes.
- **Delegation:** Mock methods can delegate calls to real or fake implementations to combine behavior verification and functional correctness.
- **Matching as a Tuple:** `.With()` clauses allow validating relationships between arguments collectively.
- **Overloaded Methods:** Use overload disambiguation helpers like `Const()` to specify const overloads.


## Example: Putting it All Together

```cpp
class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(int, Query, (const std::string& sql), (override));
};

TEST(DatabaseTest, UsesConnection) {
  MockDatabase db;
  EXPECT_CALL(db, Connect(_))
      .Times(Exactly(1))
      .WillOnce(Return(true));
  EXPECT_CALL(db, Query("SELECT * FROM users"))
      .Times(AtLeast(1))
      .WillRepeatedly(Return(42));

  MyApp app(&db);
  app.Initialize();  // should call Connect once
  int result = app.ListUsers();  // should call Query
  EXPECT_EQ(result, 42);
}
```


## Troubleshooting Common Issues

- Set expectations *before* exercising mock methods to avoid undefined behavior.
- Be cautious about sticky expectations producing unexpected saturation errors; use `.RetiresOnSaturation()` or sequences.
- Use the `--gmock_verbose=info` flag to see detailed call matching logs to debug mismatches.
- Prefer `ON_CALL` for default behaviors, reserving `EXPECT_CALL` for calls you need to verify.
- To suppress warnings on uninteresting calls, use `NiceMock` or add `.Times(AnyNumber())` catch-all expectations.


## Summary

Mock objects in GoogleMock provide a powerful model to declare and verify expected interactions with dependencies. Expectations specify call counts, argument conditions, ordering, and behaviors via actions. Advanced features like sequences and `.After()` allow precise control of call order, while default behavior and strictness settings let you fine-tune test feedback.

Understanding and leveraging this conceptual model empowers you to write robust, maintainable, and expressive interaction-based tests in C++.

---

## Additional Resources

- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html): Beginner guide to mock basics.
- [Mocking Reference](../docs/reference/mocking.md): Detailed API reference for mocks, expectations, and actions.
- [gMock Cookbook](../docs/gmock_cook_book.md): Recipes and best practices for advanced mock usage.
- [Matchers Reference](../api-reference/advanced-testing/matchers.mdx): Guide for argument matchers used in expectations.
- [Mocking Cheat Sheet](../docs/gmock_cheat_sheet.md): Quick reference for mock macros and usage patterns.


<Source url="https://github.com/google/googletest" paths={[{"path": "docs/reference/mocking.md", "range": "all"},{"path": "docs/gmock_for_dummies.md", "range": "all"},{"path": "docs/gmock_cook_book.md", "range": "all"}]} />