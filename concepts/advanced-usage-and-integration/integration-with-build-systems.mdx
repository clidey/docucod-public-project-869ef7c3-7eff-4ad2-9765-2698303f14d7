---
title: "Integration Patterns: Build Systems & Environments"
description: "Learn recommended integration patterns with build tools and environments such as CMake and Bazel. Gain insight into configuration files, entry points, and how GoogleTest integrates into automated builds and CI pipelines."
---

# Integration Patterns: Build Systems & Environments

Learn recommended integration patterns with build tools and environments such as CMake and Bazel. Gain insight into configuration files, entry points, and how GoogleTest integrates into automated builds and CI pipelines.

---

## Overview

Integrating GoogleTest into your build system is a critical step to enable seamless compilation, linking, and execution of tests as part of your development and continuous integration processes. This page focuses specifically on how GoogleTest fits into common build environments like CMake and Bazel, including details about configuration files, the role of main entry points, and how to incorporate testing frameworks within automated build pipelines.

Understanding these integration patterns ensures efficient test builds, minimal manual setup, and smoother workflows from coding to automated validation.

---

## Using GoogleTest with CMake

CMake provides a flexible, cross-platform build system generator that suits many modern C++ projects. GoogleTest supports CMake out of the box, and there are established patterns to either build GoogleTest as a standalone project or integrate it within an existing CMake project.

### Standalone GoogleTest Build

1. **Cloning the Repository:**

   Begin by cloning the GoogleTest repository with the version tag you need:

   ```bash
   git clone https://github.com/google/googletest.git -b v1.17.0
   cd googletest
   mkdir build && cd build
   ```

2. **Generating Build Files:**

   By default, `cmake ..` generates build files including GoogleMock.
   To build GoogleTest only, pass the option to disable GoogleMock:

   ```bash
   cmake .. -DBUILD_GMOCK=OFF
   ```

3. **Building and Installing:**

   On Unix-like systems, run:

   ```bash
   make
   sudo make install
   ```

   This installs the GoogleTest headers and libraries system-wide, typically under `/usr/local/`.

4. **Outcome:**

   The installed libraries include `libgtest.a` and possibly `libgtest_main.a`.

### Incorporating GoogleTest Into an Existing CMake Project

There are two main approaches:

#### A. Linking Against Installed GoogleTest Libraries

Use `find_package` or `pkg_check_modules` in your `CMakeLists.txt`:

```cmake
find_package(GTest CONFIG REQUIRED)
target_link_libraries(your_test_target PRIVATE GTest::gtest_main)
```

This relies on a prior installation of GoogleTest (e.g., from the steps above). You then link your test targets against `gtest_main` to use the default `main()` entry point GoogleTest provides.

#### B. Building GoogleTest As Part of Your Project

Make GoogleTest source available within your project (e.g., as a git submodule or by downloading).

Then add it via CMake’s `add_subdirectory()`:

```cmake
add_subdirectory(path/to/googletest)

target_link_libraries(your_test_target PRIVATE gtest_main)
```

**Advantages:** Ensures compiler and linker flags are consistent across your project and tests, avoids versioning mismatches, and eases integration on Windows.

### CMake Configuration Details

GoogleTest installs the `gtest_main.pc.in` file, a pkg-config template resembling:

```pc
libdir=@CMAKE_INSTALL_FULL_LIBDIR@
includedir=@CMAKE_INSTALL_FULL_INCLUDEDIR@

Name: gtest_main
Description: GoogleTest (with main() function)
Version: @PROJECT_VERSION@
URL: https://github.com/google/googletest
Requires: gtest = @PROJECT_VERSION@
Libs: -L${libdir} -lgtest_main @CMAKE_THREAD_LIBS_INIT@
Cflags: -I${includedir} @GTEST_HAS_PTHREAD_MACRO@
```

This file helps build systems discover GoogleTest libraries and include paths automatically, including thread flags as needed.

### Entry Point: Using `gtest_main` or a Custom `main()`

When linking against `gtest_main`, GoogleTest provides a defined `main()` method which initializes GoogleTest and runs all tests automatically.

```c++
#include <gtest/gtest.h>

int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

If you need to customize test setup or command line processing, you may define your own `main()` instead and link only against `gtest`.

---

## GoogleMock Integration

GoogleMock builds on GoogleTest and shares similar integration patterns.

- Its CMake build respects similar approaches, with targets `gmock` and `gmock_main`.
- `gmock_main` provides a `main()` entrypoint that initializes both GoogleMock and GoogleTest.

Example linking:

```cmake
target_link_libraries(your_mock_test PRIVATE gmock_main)
```

This instructs your build system to use GoogleMock's main entry point.

---

## Using GoogleTest with Bazel

Bazel is a build tool tailored for large-scale projects with strong caching and parallelism.

- GoogleTest has native Bazel support, allowing integration with Bazel build and test workflows.
- Tests can be incorporated by defining `cc_test` rules that depend on the GoogleTest library targets.

Example usage in Bazel `BUILD` file:

```bazel
cc_test(
    name = "example_test",
    srcs = ["example_test.cc"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

- Bazel automatically handles test discovery and execution, integrating with CI pipelines.

---

## Practical Integration Tips and Best Practices

- **Prefer linking against `gtest_main` or `gmock_main`** unless you require custom test initialization logic.

- **Ensure your build system sets the required compiler flags** (e.g., C++17 standard, pthread linking) as GoogleTest depends on those.

- **Use CMake’s `FetchContent` for GoogleTest sources** when you want tight control and reproducible builds:

  ```cmake
  include(FetchContent)
  FetchContent_Declare(
    googletest
    URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
  )
  set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)  # For Visual Studio compatibility
  FetchContent_MakeAvailable(googletest)
  ```

- **Be mindful of the Visual Studio runtime mismatch:** GoogleTest builds with static CRT by default which might conflict with your project. Use the `gtest_force_shared_crt` option to fix this.

- **Use installed pkg-config files when possible** to simplify discovery if your build supports pkg-config.

- **Run your tests as part of your CI pipeline** by invoking the test executable. GoogleTest's output and exit status inform your automation.

- For embedded or Arduino-like environments, `gtest_main.cc` and `gmock_main.cc` provide alternative entry points using `setup()` and `loop()` instead of `main()`.

---

## Troubleshooting

<AccordionGroup title="Common Integration Issues and Resolutions">
<Accordion title="Test Executable Linker Errors">
Often caused by missing libraries (e.g., pthread) or runtime mismatch.

**Fix:**
- Link pthread explicitly or ensure CMake links it via `@CMAKE_THREAD_LIBS_INIT@`.
- Use `gtest_force_shared_crt` for Visual Studio to unify CRT linkage.
</Accordion>

<Accordion title="Incorrect main Entry Point Conflicts">
If building your own `main()` alongside linking `gtest_main`, you'll get duplicate symbol errors.

**Fix:**
- Link either `gtest_main`/`gmock_main` _or_ provide your own `main()`, not both.
</Accordion>

<Accordion title="Version Mismatches Between gtest and gmock">
Mixing mismatched versions of GoogleTest and GoogleMock can cause build or runtime errors.

**Fix:**
- Use the bundled GoogleMock with GoogleTest.
- Synchronize repository versions or use the GoogleTest distribution repository.
</Accordion>

<Accordion title="Build System Cannot Find GoogleTest">
Build failures due to missing headers or libs.

**Fix:**
- Verify installation paths.
- Use `find_package` with correct CMake-prefix paths.
- Use `FetchContent` or submodules for clean source inclusion.
</Accordion>
</AccordionGroup>

---

## Summary

Integrating GoogleTest and GoogleMock into your build system is straightforward when following recommended patterns. CMake offers flexible options for standalone builds, subdirectory inclusion, and consuming installed libraries. Bazel facilitates native GoogleTest integration with minimal setup. Using the provided `gtest_main` and `gmock_main` targets simplifies defining test executables via the default `main()` function. Keeping build flags, threading support, and runtime linkage consistent ensures smooth builds and test runs. This integration enables automated, repeatable testing within CI pipelines, unlocking the full value of GoogleTest.

---

## Further Reading and References

- [GoogleTest README on GitHub](https://github.com/google/googletest/blob/main/README.md) (Build instructions and environment details)
- [GoogleTest CMakeLists.txt](https://github.com/google/googletest/blob/main/googletest/CMakeLists.txt) (Integration patterns and options)
- [GoogleMock CMakeLists.txt](https://github.com/google/googletest/blob/main/googlemock/CMakeLists.txt) (Mock integration with build)
- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) (Getting started with tests)
- [GoogleTest Main Entry Point (`gtest_main.cc`)](https://github.com/google/googletest/blob/main/googletest/src/gtest_main.cc) (Source code overview for automatic test runner)
- [Managing GoogleTest in CMake projects](https://cmake.org/cmake/help/latest/module/FindGTest.html)
- Bazel documentation for [C++ testing](https://docs.bazel.build/versions/main/be/c-cpp.html#cc_test) with GoogleTest

---