---
title: "Expectations, Matchers, & Actions"
description: "Master the triad that defines mocking power in GoogleMock: expectations declare expected interactions, matchers validate arguments and values, and actions trigger return values or side effects. Explore these core concepts and see how their composition builds precise, powerful tests."
---

# Expectations, Matchers, & Actions

Master the triad that defines mocking power in GoogleMock: expectations declare expected interactions, matchers validate arguments and values, and actions trigger return values or side effects. Explore these core concepts and see how their composition builds precise, powerful tests.

---

## Introduction

When working with GoogleMock, the core mechanism that empowers your tests revolves around three fundamental concepts:

- **Expectations** — declarations of how a mock method is expected to be called,
- **Matchers** — rules that verify the arguments supplied in those calls,
- **Actions** — behaviors that determine what the mock method returns or does when called.

Understanding these interrelated concepts is key to crafting effective, reliable, and maintainable mock-based tests.

This guide walks you through these foundational ideas with practical illustrations, usage patterns, and guidance to ensure you make the most out of GoogleMock's expressive power.

---

## Expectations: Declaring Expected Interactions

Expectations specify exactly which mock method calls your test cares about and how many times they should occur.

The primary tool to define expectations is the `EXPECT_CALL()` macro.

### General Workflow of `EXPECT_CALL()`

1. **Specify the mock object and method:** 
   ```cpp
   EXPECT_CALL(mockObject, MethodName(matchers...))
   ```
2. **Add optional clauses to refine behavior:**
   - `.Times(cardinality)` — how many times the call should occur.
   - `.WillOnce(action)` / `.WillRepeatedly(action)` — what to do when the call happens.
   - `.InSequence(sequenceObjects...)` — enforce call order.
   - `.After(expectations...)` — specify order dependencies.
   - `.RetiresOnSaturation()` — retire expectation when fulfilled.

#### Example

```cpp
using ::testing::AtLeast;
using ::testing::Return;

EXPECT_CALL(mockTurtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This sets the expectation that `GetX()` will be called exactly five times, first returning 100, then 150, then 200 thereafter.

### Sticky Expectations and Retiring

Expectations in GoogleMock are "sticky" by default: once an expected number of calls occurs, the expectation remains active and further matching calls cause errors — unless you explicitly call `.RetiresOnSaturation()` or use sequences that automatically retire prior expectations.

### Setting Expectations Before Calls

Always set expectations before invoking the mock methods. Doing otherwise leads to undefined behavior. Think of `EXPECT_CALL()` as a "promise" that a call will happen in the future, helping GoogleMock catch violations early.

---

## Matchers: Verifying Argument Values

Matchers allow you to specify the expected properties of mock method arguments.

### Using Matchers in `EXPECT_CALL()`

Matchers are passed as arguments to `EXPECT_CALL()` to specify constraints.

- The most permissive matcher is the wildcard matcher `_`, which matches any argument.
- You can use built-in matchers like `Eq()`, `Ge()`, `Ne()`, `NotNull()`, `HasSubstr()` to express specific conditions.

#### Example

```cpp
using ::testing::_;
using ::testing::Ge;

EXPECT_CALL(mockTurtle, Forward(Ge(100)));
EXPECT_CALL(mockTurtle, GoTo(50, _));
```

This specifies that `Forward()` should be called with at least 100, and `GoTo()` should be called with `x==50` and any `y`.

### Omitting Argument List for Non-overloaded Methods

If you don't care about any arguments in a non-overloaded method call, you can omit them entirely:

```cpp
EXPECT_CALL(mockObject, MethodName);
```

This is treated as expecting the method to be called with any arguments.

### Matching Multiple Arguments as a Whole

Sometimes you want to specify relationships across multiple arguments. Use the `.With()` clause with a multi-argument matcher (e.g., a tuple matcher) to enforce constraints involving multiple arguments as a whole:

```cpp
EXPECT_CALL(mockFoo, InRange(_, _))
    .With(Lt());  // enforces first_arg < second_arg
```

### Custom Matchers

You can write your own matchers using the `MATCHER` macros or by implementing matcher classes (see the [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#new-matchers) for detailed recipes).

---

## Actions: Specifying Behavior on Calls

Actions determine what happens when a mock method is called. They can return values, modify arguments, invoke callbacks, or perform complex side effects.

### Default Actions

If you don't specify any `ON_CALL` or `EXPECT_CALL` actions,:

- For methods returning `void`, nothing is done.
- For methods returning built-in types or default-constructible types, GoogleMock returns default values (`0`, `false`, default-constructed objects).

### Setting Default Actions with `ON_CALL()`

`ON_CALL()` allows you to specify a behavior for matching calls without setting expectations:

```cpp
ON_CALL(mockObject, MethodName(matchers...))
    .WillByDefault(action);
```

This sets the default action that runs when a matching call occurs and there's no overriding expectation. `ON_CALL()` declarations typically go in fixture setup or mock constructors.

### Overriding Actions with `EXPECT_CALL()`

While `ON_CALL()` governs default behavior, `EXPECT_CALL()` not only expects calls but can specify actions using:

- `.WillOnce(action)` — runs the given action exactly once on a matching call.
- `.WillRepeatedly(action)` — runs the given action on subsequent matching calls.

Example:

```cpp
EXPECT_CALL(mockFoo, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

This specifies a sequence of return values.

### Common Built-in Actions

- `Return(value)`: returns a copy of `value`.
- `ReturnRef(object)`: returns the reference `object`.
- `Invoke(function)`: calls a real function or functor instead.
- `DoAll()`: performs a sequence of actions.
- `SetArgPointee<N>(value)`: sets the value pointed to by the N-th argument.
- `InvokeArgument<N>(args...)`: invokes the callable passed as the N-th argument.

### Writing Custom Actions

You can define your own actions by supplying lambdas, functors, or callable objects, which must have a compatible signature with the mocked method.

Example:

```cpp
EXPECT_CALL(mockFoo, Bar(_))
    .WillOnce([](int n) { return n * 2; });
```

### Combining Side Effects and Return Values

Use `DoAll()` to chain multiple actions, such as setting an output argument and returning a value:

```cpp
EXPECT_CALL(mockMutator, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

### Important Notes on Actions

- Actions specified in `EXPECT_CALL()` are evaluated *once*, so careful with side effects inside action arguments (e.g., do not use `Return(n++)` inside `EXPECT_CALL()`). Use lambdas to delay evaluation.
- When returning move-only types (e.g., `std::unique_ptr`), use lambdas or callables returning a freshly created value each time.

---

## Relationships Between the Concepts

- An **expectation** uses **matchers** to determine when it applies based on arguments.
- When a mock method is called, GoogleMock searches expectations in *reverse order* to find a matching one.
- The matching expectation defines the **actions** to perform for that call.
- If no expectations match, the default **action** from `ON_CALL` (or a built-in default) is used.

Together, these enable precise, expressive, and flexible testing behaviors.

---

## Practical Tips & Best Practices

- **Set expectations only for calls you intend to verify.** Use `ON_CALL` to specify default behavior without constraining your tests.
- Use `Times()` with cardinalities like `Exactly(n)`, `AtLeast(n)`, `AnyNumber()` to express how many times calls are expected.
- To ignore unexpected calls silently, consider using a `NiceMock` wrapper.
- Use `InSequence` or `After` clauses to enforce call ordering when necessary.
- Prefer lambdas for actions involving side effects or move-only types.
- When matching complex argument relations, use the `.With()` clause with tuple matchers.
- Avoid over-specification to keep tests robust to implementation changes.

### Common Pitfalls

- Forgetting to call `EXPECT_CALL` before calling the mocked method can create undefined behavior.
- Not using `.RetiresOnSaturation()` when defining multiple `WillOnce` actions in callable order can cause errors.
- Using literal values or variables with side effects inside actions may not behave as expected.
- Overlapping expectations without careful ordering may cause unexpected match precedence.

---

## Troubleshooting Common Issues

### "Uninteresting Mock Function Call"
If you receive warnings about uninteresting calls (mock methods invoked with no `EXPECT_CALL`), confirm if you really care about these calls.

- If not, use `ON_CALL()` to specify default behaviors or wrap the mock with `NiceMock`.
- Do not suppress warnings by adding trivial `EXPECT_CALL`s unless you want to verify those calls.

### Expectations Not Satisfied
Run tests with `--gmock_verbose=info` to get detailed traces of mock calls and expectations, including which expectation matched and why.

### Actions Ran Out
If you provide fewer `WillOnce()` clauses than expected call count, GoogleMock warns and uses default actions. Add `.WillRepeatedly()` or more `WillOnce()` clauses as needed.

### Over-saturated Calls
If a mock method is called more than expected, an error is reported. Review and adjust cardinalities and call counts.

---

## Quick Reference

### Declaring Mock Methods

```cpp
class MockFoo {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...), (qualifiers));
};
```

### Setting an Expectation

```cpp
EXPECT_CALL(mockObject, MethodName(matchers...))
    .Times(Exactly(3))
    .WillOnce(Return(value1))
    .WillOnce(Return(value2))
    .WillRepeatedly(Return(value3));
```

### Setting Default Behavior

```cpp
ON_CALL(mockObject, MethodName(matchers...))
    .WillByDefault(Return(defaultValue));
```

### Example: Enforcing Call Order

```cpp
using ::testing::InSequence;

{
  InSequence seq;

  EXPECT_CALL(mock, Init());
  EXPECT_CALL(mock, Process(5));
  EXPECT_CALL(mock, Finish());
}
```

### Specifying Argument Matchers

```cpp
EXPECT_CALL(mock, Foo(Ge(10), _, NotNull()));
```

### Using `.With()` for Multi-argument Conditions

```cpp
EXPECT_CALL(mock, Func(_, _))
    .With(Lt()); // first arg less than second
```

---

## Related Resources

- [Mocking Reference](reference/mocking.md): Detailed information on mock classes and methods.
- [gMock Cookbook](guides/mocking-best-practices/actions-matchers-sequences.md): Recipes and examples on matchers, actions, and sequences.
- [Matchers Reference](reference/matchers.md): List of built-in and custom matchers.
- [Actions Reference](reference/actions.md): Available mock method actions.
- [Cardinalities and Strictness](concepts/mocking-essentials/cardinalities-strictness.md): Managing times called and strictness.

For more details, explore the "Basics of Mocking Functions and Classes" and "Specifying Behavior: Actions, Matchers, and Sequences" guides.

---