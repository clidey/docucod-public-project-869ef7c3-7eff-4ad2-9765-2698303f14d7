---
title: "Mock Object Lifecycle and Expectations"
description: "Understand how mock objects are created, initialized, and destroyed, how expectations are set and verified, and how call cardinalities (times, orders) are handled."
---

# Mock Object Lifecycle and Expectations

Understanding the lifecycle of mock objects, how expectations are set and verified, and the management of call cardinalities is central to using GoogleMock effectively. This guide walks you through these core concepts, focusing on user goals such as creating reliable tests, defining precise expectations, and debugging interaction issues.

---

## Overview of Mock Object Lifecycle

GoogleMock manages the lifecycle of mock objects to provide automatic verification of expectations and safety against leaks.

### Creation and Initialization

- When a mock object is created, GoogleMock registers the mock and tracks its methods.
- Setting expectations (`EXPECT_CALL`) or specifying default behaviors (`ON_CALL`) registers those handlers and associates them with the mock object.

### Usage

- As your test exercises the code under test, calls to mock methods are intercepted.
- GoogleMock checks these calls against the active expectations, invoking defined actions or default behaviors.

### Verification and Destruction

- By default, when a mock object is destructed, GoogleMock verifies that all expectations have been met, producing test failures if any are not satisfied.
- You can also explicitly force verification and clearing of expectations using APIs like `Mock::VerifyAndClearExpectations()`.

### Leaked Mocks

- GoogleMock can catch mock objects that are leaked (not deleted) to warn you that expectations may not be verified.
- If you intentionally want to allow mock leaks (for example, to avoid verification), you can call `Mock::AllowLeak(mock_object)`.

---

## Setting Expectations on Mock Methods

Expectations specify **what calls you expect on your mock methods** and **what those calls should do**.

### Using `EXPECT_CALL`

The primary macro to set expectations.

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action)
    .InSequence(sequences...)
    .After(expectations...)
    .With(multi_argument_matcher)
    .RetiresOnSaturation();
```

- **Match Arguments:** Use matchers to specify expected arguments. Use `_` to match any value.
- **Times:** Controls how many times a call is expected (Examples: `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`).
- **Actions:** Define what the mock method does (`Return()`, `Invoke()`, etc.).
- **Order:** Use `.InSequence()` or `.After()` to specify call ordering.
- **Additional Constraints:** Use `.With()` to match all arguments as a tuple.
- **RetiresOnSaturation:** Makes the expectation inactive after its maximum invocation count.

### Order of Expectations

- GoogleMock searches expectations in *reverse declaration order*, so later expectations override earlier ones.
- Use sequences or explicit ordering if calls must occur in a specific order.

### Stickiness of Expectations

- Expectations remain *active* even after reaching their call limit, causing failures on excessive calls.
- Use `.RetiresOnSaturation()` to retire an expectation once fully satisfied.
- Expectations in sequences automatically retire as the sequence advances.

### Uninteresting, Unexpected, and Excessive Calls

- **Uninteresting calls:** Calls to mock methods with no expectations set. By default, generate warnings but not failures.
- **Unexpected calls:** Calls that don't match any active expectations; always an error.
- **Excessive calls:** Calls beyond an expectation's specified cardinality; fail the test.

---

## Default Behaviors with `ON_CALL`

`ON_CALL` lets you specify what your mock methods do by default, without setting an expectation that the method will be called.

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher)
    .WillByDefault(action);
```

- The default action is used when no `EXPECT_CALL` matches the call.
- You can define multiple `ON_CALL`s for different argument matchers; the last one matching applies.
- Use wildcards (`_`) to catch all calls.

If a method has neither `ON_CALL` nor `EXPECT_CALL` with an action, GoogleMock uses built-in default actions (e.g., returning default-constructed values).

---

## Call Cardinalities and Behavior

Call cardinality determines the expected number of mock method invocations.

| Cardinality       | Meaning                              |
|-------------------|------------------------------------|
| `Exactly(n)`      | Expect the call exactly `n` times  |
| `AtLeast(n)`      | Expect the call at least `n` times |
| `AtMost(n)`       | Expect the call at most `n` times  |
| `Between(m, n)`   | Expect between `m` and `n` calls   |
| `AnyNumber()`     | Call any number of times            |

If omitted, cardinality is inferred based on `WillOnce` and `WillRepeatedly` clauses.

### Excessive Calls

- If a mock method is called more than the specified cardinality, GoogleMock immediately reports an error.
- `RetiresOnSaturation()` can limit such failures by retiring the expectation once saturated.

---

## Managing Call Ordering

Call ordering constraints ensure your tests verify interactions in the order you expect.

### Using `InSequence`

Wrap expectations within an `InSequence` block to require calls occur in that order:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, MethodA());
  EXPECT_CALL(mock, MethodB());
}
```

### Using `.InSequence()` Clause

Assign one or multiple `Sequence` objects to expectations to create partial orders.

### Using `.After()` Clause

Specify that one expectation occurs after one or more others.

---

## Verification of Expectations

- When a mock object is destructed, all expectations are verified automatically.
- If any expectation was not satisfied (e.g., a required call was never made), a test failure is reported immediately.
- You can manually verify at any point with `Mock::VerifyAndClearExpectations(&mock_obj);`.
- Manually clearing also removes the expectations so no further matching occurs.

---

## Controlling Uninteresting Calls: Nice, Naggy, and Strict Mocks

GoogleMock provides wrappers to control the behavior on uninteresting calls:

| Wrapper             | Behavior                             |
|---------------------|------------------------------------|
| `NiceMock<T>`       | Suppresses warnings on uninteresting calls. |
| `NaggyMock<T>`      | (Default) Prints warnings on uninteresting calls. |
| `StrictMock<T>`     | Treats uninteresting calls as errors. |

Using these wrappers helps tune your test's strictness and maintainability.

---

## Practical Example

Here's an example of setting expectations, default actions, and call ordering using `EXPECT_CALL` and `ON_CALL`:

```cpp
#include <gmock/gmock.h>
using ::testing::AtLeast;
using ::testing::_;
using ::testing::Return;
using ::testing::InSequence;

class MockTurtle {
 public:
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(void, Forward, (int distance), ());
  MOCK_METHOD(int, GetX, (), (const));
};

TEST(DrawingTest, DrawsLine) {
  MockTurtle turtle;

  // Set default behavior
  ON_CALL(turtle, GetX()).WillByDefault(Return(0));

  {
    InSequence seq;
    EXPECT_CALL(turtle, PenDown()).Times(1);
    EXPECT_CALL(turtle, Forward(100)).Times(AtLeast(1));
  }

  // Exercise code using mock object
  turtle.PenDown();
  turtle.Forward(100);
  int x = turtle.GetX();  // Returns 0 due to ON_CALL
}
```

---

## Troubleshooting Common Issues

- **`Uninteresting mock function call` warnings:** Means a mock method was called with no matching `EXPECT_CALL`. Consider if you should add an expectation or use `NiceMock`.
- **Failed expectations due to argument mismatch:** Check matcher correctness.
- **Excessive call errors:** Review cardinalities and whether expectations should retire.
- **Non-destruction of mock objects:** Leads to leaked mocks; use `Mock::AllowLeak()` if intentional.
- **Order violations:** Use sequences or `.After()` to specify call order explicitly.

---

## Summary

This guide helps you master the lifecycle, expectations setting, call cardinalities, and verification rules of mock objects in GoogleMock. By leveraging `EXPECT_CALL`, `ON_CALL`, call ordering primitives, and strictness wrappers like `NiceMock`, you can write robust and maintainable interaction-based tests ensuring your codeâ€™s correct behavior and interaction patterns.

---

## See Also

- [MOCK_METHOD and Mock Class Definition](reference/mocking.md#MOCK_METHOD)
- [Setting Expectations with EXPECT_CALL](reference/mocking.md#EXPECT_CALL)
- [Setting Default Actions with ON_CALL](reference/mocking.md#ON_CALL)
- [Nice, Naggy, and Strict Mocks](api-reference/mocking-framework/nice-strict-mocks.md)
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)
- [GoogleMock Cookbook](docs/gmock_cook_book.md)

---