---
title: "Argument Matching and Actions"
description: "Explore how matchers and actions work together to enable expressive verification of function calls and to define dynamic mock behavior. Gain clarity on composing matchers, injecting side effects, and controlling return values within your tests."
---

# Argument Matching and Actions

Explore how matchers and actions work together to enable expressive verification of function calls and to define dynamic mock behavior. Gain clarity on composing matchers, injecting side effects, and controlling return values within your tests.

---

## Introduction

When writing tests with GoogleMock, much of the power and flexibility comes from two core concepts: **argument matchers** and **actions**. They allow you to precisely specify:

- *Which function calls you expect or allow* by matching on arguments,
- *How the mock function behaves* at each invocation.

Understanding how to combine matchers and actions effectively helps you write clear, robust, and maintainable tests.

---

## Argument Matching: Defining What to Expect

### What Are Matchers?
Matchers are predicates that specify the required conditions an argument must satisfy for a mock call to be considered a match. They enable you to express expectations beyond exact equality.

For example, to expect a mock method called with an argument exactly equal to 5:

```cpp
EXPECT_CALL(mock_obj, Method(Eq(5)));
```

More often, you want flexible matching:

- Match anything: `_`
- Range checks: `Ge(5)` (greater or equal), `Lt(10)` (less than 10)
- Combinational logic: `AllOf(Gt(10), Ne(42))` (greater than 10 and not equal to 42)

If you don't care about certain arguments, use `_` (wildcard matcher) to simplify expectations.

### How Matchers Work Together
Matchers can be used in the argument list of `EXPECT_CALL` or `ON_CALL`. Each matcher applies to the corresponding argument. When the function is called, all matchers must be satisfied for the expectation to apply.

You can also match all arguments at once using the `.With()` clause by passing a matcher on the entire argument tuple:

```cpp
EXPECT_CALL(mock, Func(_, _)).With(Lt());
```

This example matches calls where the first argument is less than the second.

### Parameterized and Composite Matchers

- **Parameterized matchers** allow you to create matchers that take arguments, for example:
  ```cpp
  EXPECT_CALL(mock, Func(HasSubstr("test")));
  ```

- **Combining matchers** lets you combine multiple conditions:
  ```cpp
  EXPECT_CALL(mock, Method(AllOf(Ge(5), Ne(10))));
  ```

- **Custom matchers** can be defined using `MATCHER` or by implementing matcher interfaces.

### Matchers for Complex Arguments
- Use `Field()` and `Property()` to match specific fields or properties inside an object:
  ```cpp
  EXPECT_CALL(mock, Method(Field(&MyClass::value, Eq(5))));
  ```
- Use `Pointee()` to match the value pointed to by a pointer argument:
  ```cpp
  EXPECT_CALL(mock, Method(Pointee(Eq(42))));
  ```

### Matching Overloaded and Const Methods
For overloaded methods, specify the argument types or use helpers like `Const()` to disambiguate:

```cpp
EXPECT_CALL(mock, GetBar()).WillOnce(ReturnRef(bar1));
EXPECT_CALL(Const(mock), GetBar()).WillOnce(ReturnRef(bar2));
```

### Tips and Best Practices
- Prefer loose matchers (e.g., `_`) when argument values are not critical.
- Use combinational matchers (`AllOf`, `AnyOf`, `Not`) to express complex logic succinctly.
- Share complex matchers by assigning them to matcher variables.

---

## Actions: Defining Mock Behavior

Actions define what a mock method does when invoked. This can be:

- Returning a value or reference
- Executing custom code, such as invoking callbacks or modifying arguments
- Performing side effects like setting output parameters

### Common Built-in Actions
- `Return(value)`: Returns a copy of value
- `ReturnRef(variable)`: Returns a reference to variable
- `ReturnPointee(pointer)`: Returns the value pointed to by a pointer
- `DoAll(...)`: Combines multiple actions executed sequentially, returning the last one's value
- `SetArgPointee<N>(value)`: Sets the N-th argument (indexed from 0) pointed-to value
- `Invoke(function_or_lambda)`: Calls the provided callable

### Usage Patterns
Actions are specified using `.WillOnce()` and `.WillRepeatedly()` clauses after an expectation. For example,

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

This sets the mock to return 42 the first time, and 0 thereafter.

If you need multiple side effects, chain them with `DoAll()`:

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

### Using Custom Actions
If built-in actions aren't sufficient, you can write:

- Lambdas or functors:
  ```cpp
  EXPECT_CALL(mock, Compute(_))
      .WillOnce([](int x) { return x * 2; });
  ```

- Use `Invoke()` to call existing functions or methods:
  ```cpp
  EXPECT_CALL(mock, Compute(_))
      .WillOnce(Invoke(&RealCompute));
  ```

- Define new actions by implementing `ActionInterface` or using `MakePolymorphicAction` for more complex behavior.

### Special Cases
- **Returning Live Values:** Use `ReturnRef()` or `ReturnPointee()` to return a value reflecting the current state, not a stored copy.
- **Move-only Types:** Mocking methods that return or take move-only types (like `std::unique_ptr<>`) is supported; lambdas are often required for complex actions.

### Controlling Action Sequences
- Multiple `WillOnce()` calls specify actions for the initial calls.
- `WillRepeatedly()` specifies the fallback action once all `WillOnce()` actions are used.

### Ignoring Action Return Values
Sometimes you want to ignore an action's return value, for example, on `void` mocks or when combining actions via `DoAll()`. Use `IgnoreResult()`:

```cpp
EXPECT_CALL(mock, Func())
    .WillOnce(IgnoreResult(Return(42)));
```

Be careful: do not apply `IgnoreResult()` to actions already returning `void`.

### Tips and Best Practices
- Specify default actions via `ON_CALL()` to reduce the need for every test to specify behavior.
- Use `WillOnce()` for specific cases and `WillRepeatedly()` for general behavior.
- Use `DoAll()` to combine side-effects with return values.
- Be mindful of action evaluation timing to avoid unintended side effects.

---

## Integration of Matchers and Actions

Matchers and actions work jointly in defining expectations:

1. **Expecting a Call:** You specify *what* argument values to match using matchers.
2. **Defining Behavior:** You specify *what the mock does* in response to matched calls via actions.

GoogleMock selects the most recently defined matching expectation and applies its associated actions. You can specialize behavior based on argument-dependent matchers.

Example:

```cpp
EXPECT_CALL(foo, DoThis(_))
    .WillRepeatedly(Return('b'));
EXPECT_CALL(foo, DoThis(Lt(5)))
    .WillRepeatedly(Return('a'));
```

Here, calls with arguments less than 5 return `'a'`, others return `'b'`.

---

## Common Pitfalls and Troubleshooting

### Mistakes in Matchers
- Over-specifying exact values when unnecessary leads to brittle tests.
- Failing to disambiguate overloaded methods can cause compilation errors.
- Using matchers with side effects is prohibited; matchers must be pure functions.

### Incorrect Use of Actions
- `Return(std::ref(x))` does not return the live value; prefer `ReturnPointee(&x)`.
- Excessive use of `EXPECT_CALL` instead of `ON_CALL` can make tests brittle.

### Ignoring Uninteresting Calls
If mock methods are called without matching expectations, GoogleMock warns about "uninteresting calls." Use `NiceMock<T>` to suppress such warnings when the calls are benign.

### Call Ordering or Cardinality Failures
Misunderstanding how sticky expectations behave or improperly sequencing calls can cause errors. Use sequences (`InSequence`), cardinalities (`Times`), and `RetiresOnSaturation()` to better control.

### Debugging Tips
- Use the `--gmock_verbose=info` flag to trace matching expectations and mock calls.
- Write focused tests with clear single-property verification.

---

## Summary

Matchers and actions are fundamental to defining clear, expressive, and powerful mock behaviors in tests. Matchers specify the conditions mock call arguments must meet, allowing for fine-grained control over what calls are expected or allowed. Actions define how mocks react when matched calls occur, including return values, side effects, and custom behaviors. Together, they form a flexible DSL enabling robust interaction-based testing.

---

## Additional Resources

For more details and practical examples, see:

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) â€” recipes for advanced matcher and action usage.
- [Matchers Reference](/api-reference/mocking-framework-api/built-in-actions-matchers)
- [Mocking Reference](/api-reference/mocking-framework-api/defining-mocks)
- [gMock for Dummies guide](https://google.github.io/googletest/gmock_for_dummies.html)

---