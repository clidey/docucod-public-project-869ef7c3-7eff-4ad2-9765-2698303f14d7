---
title: "Integration with Build Systems and External Tools"
description: "Understand common patterns for integrating with CMake, Bazel, and CI pipelines. Overview of key configuration files, entry points, and recommended practices for seamless test automation."
---

# Integration with Build Systems and External Tools

GoogleTest and GoogleMock offer flexible and robust patterns to integrate with popular C++ build systems such as CMake and Bazel, as well as seamless incorporation into Continuous Integration (CI) pipelines. This guide walks you through common integration workflows, key configuration files, recommended entry points, and best practices for smooth test automation.

---

## 1. Integration Patterns with CMake

CMake is the most widely used cross-platform build system supported for GoogleTest and GoogleMock integration. GoogleTest includes community-supported CMake scripts designed to facilitate building the framework itself and linking it into your test projects.

### 1.1 Building GoogleTest and GoogleMock with CMake

- Clone the repository and create a build directory:
  ```bash
  git clone https://github.com/google/googletest.git -b main
  cd googletest
  mkdir build
  cd build
  cmake ..
  cmake --build .
  ```
- By default, GoogleMock builds alongside GoogleTest. To exclude GoogleMock, pass `-DBUILD_GMOCK=OFF` to `cmake`.

### 1.2 Incorporating GoogleTest into Your Project

You have multiple options:

- **Find Installed GoogleTest:** After system-wide installation, use CMake's `find_package(GTest CONFIG REQUIRED)` to locate installed GoogleTest and GoogleMock libraries. Link to them with `GTest::gtest`, `GTest::gtest_main`, `GTest::gmock`, or `GTest::gmock_main`.

- **Add as Subdirectory:** Include the GoogleTest source in your project and add it via `add_subdirectory(googletest)`, ensuring consistent compiler and linker settings across your project and tests.

- **FetchContent:** Use CMake's `FetchContent` module to download and build GoogleTest as part of your project's configuration step. Example:

  ```cmake
  include(FetchContent)
  FetchContent_Declare(
    googletest
    URL https://github.com/google/googletest/archive/main.zip
  )
  FetchContent_MakeAvailable(googletest)

  add_executable(my_tests my_tests.cpp)
  target_link_libraries(my_tests GTest::gtest_main)
  add_test(NAME my_tests COMMAND my_tests)
  ```

### 1.3 Linking Against gtest_main and gmock_main

GoogleTest and GoogleMock provide convenience libraries with main functions — `gtest_main` and `gmock_main` — to simplify test executables, removing the need to write your own `main()`. Link your test binary against one of these for quick start:

- Use `GTest::gtest_main` for GoogleTest-only setups.
- Use `GTest::gmock_main` if using GoogleMock.

If a custom `main()` function is required (for special initialization), link against the base libraries (`gtest` or `gmock`) and implement your own entry point.

### 1.4 Key Configuration Files

- `CMakeLists.txt` in the root of GoogleTest configures all targets, dependencies, and installation rules.
- `googletest/cmake/hermetic_build.cmake` defines hermetic build functions used internally.
- `googletest/cmake/internal_utils.cmake` manages compiler and linker flags.

### 1.5 Best Practices

- Prefer linking to `gtest_main`/`gmock_main` for standard entry points.
- Use CMake's testing features (`enable_testing()` and `add_test()`) to register test executables for automated test runners.
- Match compiler flags and runtime linkage between your project and GoogleTest to avoid runtime mismatches (e.g., debug vs release, static vs dynamic CRT).
- Pass `-DGTEST_HAS_PTHREAD=1` on platforms where GoogleTest does not auto-detect pthread support.

---

## 2. Integration with Bazel

While this guide does not cover extensive Bazel instructions, GoogleTest supports Bazel for embedded testing in Google’s build infrastructure:

- GoogleTest ships Bazel build rules that allow defining `cc_test` targets using GoogleTest and GoogleMock.
- Use `deps` in Bazel to reference the testing libraries and source files.
- Bazel’s sandboxing ensures hermetic test environments enhancing reproducibility.

Refer to Bazel community documentation and GoogleTest’s official repository for Bazel examples.

---

## 3. Continuous Integration (CI) Pipeline Integration

Integrating GoogleTest/GoogleMock into CI pipelines involves:

- **Build Automation:** Use your existing build system (e.g., CMake or Bazel) commands in CI scripts to build the test binaries.
- **Test Execution:** Use `ctest` (if using CMake) or directly execute test binaries via their entry points.

- **Results Collection:** Enable test result output in XML format (`--gtest_output=xml:<file>`) for integration with CI servers such as Jenkins, GitHub Actions, or GitLab.

- **Parallel Execution:** Utilize GoogleTest sharding and parallel test runs as documented in the scaling guides for faster feedback cycles.

- **Custom Setup:** If your test environment requires special initializations, implement a custom `main()` or test environment setup and link accordingly.

Example command for Jenkins pipeline:

```bash
cmake --build .
ctest --output-on-failure
```

Or run tests with XML report:

```bash
./my_tests --gtest_output=xml:test_results.xml
```

---

## 4. Understanding the Main Entry Points

Both GoogleTest and GoogleMock provide pre-written main functions in their `gtest_main` and `gmock_main` libraries respectively. These establish standard initialization and execution flows:

- **Normal Platform (e.g., Linux, Windows, Mac):**
  ```cpp
  int main(int argc, char** argv) {
    testing::InitGoogleTest(&argc, argv);
    return RUN_ALL_TESTS();
  }
  ```

- **Special Cases:** For embedded or limited platforms (such as Arduino or QuRT), alternate entry points (e.g., `setup()` and `loop()` functions) are provided.

Refer to `googletest/src/gtest_main.cc` and `googlemock/src/gmock_main.cc` for implementation details.

---

## 5. Troubleshooting Integration Issues

### Common Pitfalls

- **Linker Errors:** Usually due to missing linkage to `gtest_main` or `gmock_main` or mismatched runtime libraries.
- **Duplicate `main()` Function:** Occurs when linking both your own `main()` and `gtest_main` or `gmock_main` libraries. Choose one approach.
- **Threading Issues:** Ensure platform pthread support is correctly configured using the `GTEST_HAS_PTHREAD` macro.
- **C++ Standard Mismatch:** GoogleTest requires C++17 or later. Make sure project and GoogleTest are compiled with compatible standard flags.

### Recommended Fixes

- Confirm linkage for your test target includes either `GTest::gtest_main` or `GTest::gmock_main` if not providing your own `main()`.
- Sync runtime library linkage settings (static/dynamic CRT) especially on Windows.
- Use CMake’s `config_compiler_and_linker()` functions if applicable to manage flags.
- Use GoogleTest's and GoogleMock's CMake options to build tests separately or together as needed.

---

## 6. Summary

Integrating GoogleTest and GoogleMock with modern C++ build systems and CI environments is streamlined by:
- Using community-supported CMake scripts for native builds and project linkage.
- Linking with `gtest_main` and `gmock_main` to avoid writing custom entry points.
- Employing CMake’s FetchContent or subdirectory addition to incorporate GoogleTest code in your builds.
- Leveraging standard testing commands like `RUN_ALL_TESTS()` and CI-friendly test outputs.

With these practices, you gain reliable and maintainable automated test runs that fit into existing development workflows seamlessly.

---

## References

- [GoogleTest CMake Build Instructions](https://github.com/google/googletest/blob/main/googletest/README.md#build-with-cmake)
- [googlemock/CMakeLists.txt](https://github.com/google/googletest/blob/main/googlemock/CMakeLists.txt)
- [googletest/src/gtest_main.cc](https://github.com/google/googletest/blob/main/googletest/src/gtest_main.cc)
- [googlemock/src/gmock_main.cc](https://github.com/google/googletest/blob/main/googlemock/src/gmock_main.cc)
- [Guide: Getting Started with GoogleTest](https://github.com/google/googletest/blob/main/docs/primer.md)
- [Guide: Scaling, Performance, and Parallelism](https://github.com/google/googletest/blob/main/guides/advanced-usage/scaling-and-optimization.md)
- [GoogleTest Flags and Macros Documentation](https://github.com/google/googletest/blob/main/googletest/include/gtest/internal/gtest-port.h)

---

## Example: Minimal CMakeLists.txt Using GoogleTest

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyTests)

set(CMAKE_CXX_STANDARD 17)

include(FetchContent)

FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/main.zip
)

FetchContent_MakeAvailable(googletest)

add_executable(my_test_executable test.cpp)

# Link with gtest_main for automatic main() function
target_link_libraries(my_test_executable GTest::gtest_main)

enable_testing()
add_test(NAME my_test COMMAND my_test_executable)
```

This setup builds and links your test executable with GoogleTest and lets you run it using CTest or directly.
