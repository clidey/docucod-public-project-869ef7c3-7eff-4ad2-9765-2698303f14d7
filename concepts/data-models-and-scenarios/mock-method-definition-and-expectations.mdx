---
title: "Defining Mock Methods and Setting Expectations"
description: "Describes the recommended pattern for building C++ mock classes using MOCK_METHOD, setting up expectations via ON_CALL and EXPECT_CALL, and composing flexible mock behaviors to represent dependencies in unit tests."
---

# Defining Mock Methods and Setting Expectations

This page details the recommended approach for defining mock classes and methods using the `MOCK_METHOD` macro in GoogleMock, as well as setting up expectations and default behaviors on these mocks using `EXPECT_CALL` and `ON_CALL`. Through concrete examples and practical guidelines, you will learn how to effectively create flexible mock behaviors to simulate dependencies in your unit tests.

---

## 1. Defining Mock Classes Using `MOCK_METHOD`

GoogleMock's `MOCK_METHOD` macro is the cornerstone for creating mock classes. It generates mock methods that mirror the signatures of the methods you want to replace in your tests.

### Basic Syntax

```cpp
class MyMockClass {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
};
```

- **ReturnType**: The return type of the mocked method.
- **MethodName**: The name of the method being mocked.
- **Args...**: The argument list, enclosed in parentheses.
- **Qualifiers** (optional): method qualifiers like `const`, `override`, `noexcept`, or `Calltype(...)`.

**Example:**

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Handling Types with Commas

If the return type or any argument type contains commas (e.g., templates like `std::pair<int, int>`), wrap the type in extra parentheses or use type aliases:

```cpp
using BoolInt = std::pair<bool, int>;
using MapIntDouble = std::map<int, double>;

class MyMock {
 public:
  MOCK_METHOD((BoolInt), GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((MapIntDouble), bool));
};
```

### Location of `MOCK_METHOD`

Always place `MOCK_METHOD` declarations in the `public:` section of your mock classâ€”even if you are mocking `protected` or `private` methods. This ensures `EXPECT_CALL` and `ON_CALL` can be used seamlessly from outside the mock class.

### Mocking Overloaded Methods

Simply mock each overload with `MOCK_METHOD` using its exact signature. Use `using Base::Method;` to avoid compiler warnings if you mock only some overloads.

### Advanced Qualifiers

- Use `const`, `override`, and `noexcept` qualifiers as appropriate.
- For Windows calling conventions, use `Calltype(STDMETHODCALLTYPE)`.
- Use reference qualifiers like `ref(&)` when overriding methods qualified with references.

## 2. Setting Default Behaviors with `ON_CALL`

`ON_CALL` defines what happens when a mock method is invoked, without setting any expectation on how many times or in which way.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // optional
    .WillByDefault(action);
```

- Does not require the method to be called.
- Sets the *default* behavior for matching calls.

### Example

```cpp
ON_CALL(my_mock, GetSize())
    .WillByDefault(Return(10));
```

This means calls to `GetSize()` without other expectations will return 10.

### Using `.With()` Clause

The `.With()` clause lets you match arguments as a whole tuple rather than individually.

### Important Guidelines

- Use `ON_CALL` primarily to establish common default behavior shared by multiple tests.
- The last matching `ON_CALL` takes precedence.
- It is normal to see warnings when mock methods without `EXPECT_CALL` are invoked; to suppress these, consider using `NiceMock` or setting an `EXPECT_CALL` with `Times(AnyNumber())` if you actually expect calls.

## 3. Setting Expectations with `EXPECT_CALL`

`EXPECT_CALL` expresses that a mock method *must* be called, along with constraints on its arguments, call count, order, and behavior.

### General Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)  // optional
    .Times(cardinality)            // optional
    .InSequence(sequences...)      // optional
    .After(expectations...)        // optional
    .WillOnce(action)              // optional
    .WillRepeatedly(action)        // optional
    .RetiresOnSaturation();        // optional
```

Clauses must follow the order shown above.

### Argument Matchers

- Use literal values or built-in matchers like `_` (wildcard), `Ge()`, `NotNull()`, etc.
- For complex validations, use custom or composite matchers.

### Call Cardinalities (via `.Times()`)

| Cardinality          | Description                                   |
|---------------------|-----------------------------------------------|
| `AnyNumber()`        | No constraint on call count.                   |
| `AtLeast(n)`         | Expect at least n calls.                        |
| `AtMost(n)`          | Expect at most n calls.                         |
| `Between(m, n)`      | Expect between m and n calls inclusive.        |
| `Exactly(n)` or `n`  | Expect exactly n calls. If n=0, call must not occur.|

If `.Times()` is omitted, it is inferred:
- If no `WillOnce` or `WillRepeatedly` are specified, `.Times(1)` is default.
- If *n* `WillOnce`s and no `WillRepeatedly`, `.Times(n)`.
- If *n* `WillOnce`s and one `WillRepeatedly`, `.Times(AtLeast(n))`.

### Specifying Return Behavior

- Use `.WillOnce(action)` for behavior on a single matching call.
- Use `.WillRepeatedly(action)` for behavior on all subsequent matching calls.

Example:

```cpp
EXPECT_CALL(mock, GetCount())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

This means:
- First call returns 1
- Second call returns 2
- All subsequent calls return 3

### Enforcing Call Order

- Use `.InSequence(sequence1, sequence2, ...)` to require calls match the order of expectations in the sequences.
- Use `.After(expectation1, expectationSet2, ...)` to specify partial ordering constraints.
- Use the `InSequence` helper to automatically place all expectations in a sequence.

### Using `.RetiresOnSaturation()`

- When upper bounds for `.Times()` are reached, call expectation *retires* and stops matching further calls.
- Useful to avoid overlapping expectations causing errors.

### Example with Order and Cardinality

```cpp
Sequence s;
EXPECT_CALL(mock, Init()).InSequence(s);
EXPECT_CALL(mock, Process(_)).InSequence(s).Times(3);
EXPECT_CALL(mock, Cleanup()).InSequence(s);
```

### Important Best Practices

- Set expectations *before* exercising the code under test.
- Use argument matchers sparingly to avoid brittle tests.
- Prefer `ON_CALL` for default, `EXPECT_CALL` only when verification of calls is required.
- Use `NiceMock` to suppress warnings for uninteresting calls when appropriate.

## 4. Composing Flexible Mock Behaviors

By combining `MOCK_METHOD`, `ON_CALL`, and `EXPECT_CALL`, you can build mocks that represent dependencies with nuanced behaviors.

### Workflow Example

1. **Define your mock class:** Use `MOCK_METHOD` to declare methods.

2. **Set up default behaviors:** Use `ON_CALL` in the test fixture setup or constructor to define general behaviors that apply across multiple tests.

3. **Specify test-specific expectations:** Use `EXPECT_CALL` in individual test cases to enforce behaviors for that test.

4. **Exercise your code:** Run the code under test, which will call your mock methods.

5. **Automatic verification:** When the mock object goes out of scope, GoogleMock verifies all expectations.

### Delegation to Fake or Real Objects

For complex behaviors, delegate calls from mocks to existing fake or real implementations via `ON_CALL` with lambda calls.

```cpp
ON_CALL(mock, Method(_)).WillByDefault([&real](ArgType arg) {
  return real.Method(arg);
});
```

### Troubleshooting Tips

- If expectations are not met, use `--gmock_verbose=info` to trace calls.
- If unexpected calls occur, check argument matchers and call order constraints.
- Avoid mixing `EXPECT_CALL` and method calls; always set expectations first.

---

## Summary

- Use `MOCK_METHOD` within the public section of your mock classes for mocking methods, including overloads and special qualifiers.
- Use `ON_CALL` to set default mock behaviors without strict call count verification.
- Use `EXPECT_CALL` to define explicit expectations including argument matchers, call counts, order, and behaviors.
- Combine these techniques to create mocks that flexibly and reliably simulate dependencies.
- Leverage sequences and partial orders for controlling call ordering.
- `RetiresOnSaturation` controls expectation activity to avoid overlapping call matches.

---

## Practical Example

```cpp
class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(void, Disconnect, (), (override));
  MOCK_METHOD(std::string, Query, (int id), (const, override));
};

// Default behaviour for Connect
ON_CALL(mock_db, Connect(_))
    .WillByDefault(Return(true));

// Test-specific expectation
EXPECT_CALL(mock_db, Query(42))
    .Times(1)
    .WillOnce(Return("Answer to Everything"));

// Code under test
if (mock_db.Connect("localhost")) {
  std::string result = mock_db.Query(42);
  // ... use result ...
  mock_db.Disconnect();
}
```

This setup ensures `Connect` always returns true by default, while the `Query(42)` call is expected exactly once and returns a specific string.

---

For more detailed examples and recipes, see the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) and the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html).

---