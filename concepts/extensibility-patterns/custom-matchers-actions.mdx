---
title: "Custom Matchers and Actions"
description: "Discover how to go beyond built-in assertions and behaviors by defining your own matchers and actions. Learn the conceptual model for customizations and how these enhance test expressiveness and maintainability."
---

# Custom Matchers and Actions

Explore the power of GoogleMock by learning how to create custom matchers and actions that extend beyond the built-in assertions and behaviors. This guide introduces the conceptual model behind custom matchers and custom actions, explaining how these tools enhance the expressiveness and maintainability of your tests.

---

## Why Define Custom Matchers and Actions?

Standard matchers and actions provide a great toolkit for common testing patterns, but complex or domain-specific testing scenarios often demand more tailored solutions. By creating custom matchers and actions, you can:

- Express complex test conditions clearly and concisely
- Encapsulate reusable logic to reduce duplication
- Improve the readability of your test assertions and behaviors
- Gain precise control over mock method behaviors

This guide focuses on the concepts and user-oriented workflow of writing custom matchers and actions that integrate seamlessly with GoogleMock's framework.

---

## Understanding Custom Matchers

### What is a Custom Matcher?

A matcher is a predicate that tests whether a mock function's argument meets certain criteria. Custom matchers allow you to define your own predicate logic to match arguments in ways that built-in matchers cannot.

### Conceptual Model

- A custom matcher encapsulates logic to evaluate an argument against a user-defined condition.
- It must provide meaningful descriptions of both successful and failed matches to aid debugging.
- Custom matchers maintain purity: they have no side effects and their result depends only on the input argument and parameters.

### Types of Custom Matchers

- **Basic (Monomorphic) Matcher:** Matches a specific type and is implemented with methods like `MatchAndExplain`, `DescribeTo`, and `DescribeNegationTo`.
- **Polymorphic Matcher:** Can be used across multiple argument types by templating the matching logic.
- **Parameterized Matcher:** Accepts parameters to customize matching behavior at runtime.

### Creating a Custom Matcher

The simplest way to create a custom matcher is using the `MATCHER` family of macros. For advanced or widely reused matchers, define matcher classes explicitly.

#### Example: Basic Custom Matcher Using Macro
```cpp
MATCHER(IsDivisibleBy7, "checks if a number is divisible by 7") {
  return (arg % 7) == 0;
}
```
Use:
```cpp
EXPECT_CALL(mock_obj, Foo(IsDivisibleBy7()));
```

#### Example: Custom Matcher Class
```cpp
class BarPlusBazEqMatcher {
 public:
  using is_gtest_matcher = void;

  explicit BarPlusBazEqMatcher(int expected_sum) : expected_sum_(expected_sum) {}

  bool MatchAndExplain(const Foo& foo, std::ostream* os) const {
    bool match = (foo.bar() + foo.baz()) == expected_sum_;
    if (!match && os != nullptr) {
      *os << "bar() + baz() equals " << (foo.bar() + foo.baz());
    }
    return match;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "bar() + baz() equals " << expected_sum_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "bar() + baz() does not equal " << expected_sum_;
  }

 private:
  int expected_sum_;
};

::testing::Matcher<const Foo&> BarPlusBazEq(int expected_sum) {
  return BarPlusBazEqMatcher(expected_sum);
}
```

Use:
```cpp
EXPECT_THAT(foo, BarPlusBazEq(5));
```

### Tips for Writing Effective Custom Matchers

- Provide informative messages in the `Describe*` methods to help diagnose assertion failures.
- Avoid side effects inside matcher logic.
- Use parameterized matchers to enhance reusability.
- Leverage existing matchers inside your matcher for composing complex predicates.

---

## Understanding Custom Actions

### What is a Custom Action?

An action specifies what a mock method should do when invoked (e.g., return a value, set an output parameter, invoke a callback). Custom actions allow you to define new behaviors tailored to your testing needs.

### Conceptual Model

- Actions implement a call operator that matches or is compatible with the mocked function's signature.
- They can perform side effects, return values, or a combination.
- Custom actions integrate with `EXPECT_CALL` or `ON_CALL` to control mock behavior.

### Creating Custom Actions

You can create custom actions using one of these primary approaches:

- **Lambda or Functor**: Define a callable with a matching signature and pass it directly.
- **ACTION Macros**: Use `ACTION`, `ACTION_P`, and `ACTION_Pk` macros to define named actions.
- **Implement ActionInterface**: For finer control, implement `::testing::ActionInterface<F>`.
- **Polymorphic Actions**: Use `MakePolymorphicAction()` to create actions reusable across multiple signatures.

#### Example: Action with Lambda
```cpp
EXPECT_CALL(mock_obj, Method(_))
    .WillOnce([](int arg) { return arg * 2; });
```

#### Example: Custom Named Action Using Macro
```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}

EXPECT_CALL(mock_obj, Foo(_))
    .WillOnce(IncrementArg1());
```

### Composite and Convenience Actions

GoogleMock provides composite actions and operators to help build complex behaviors:

- `DoAll(action1, action2, ..., actionN)`: Runs multiple actions in order and returns the last action's result.
- `IgnoreResult(action)`: Executes an action but discards its return value (useful for void-returning mocks).
- `WithArg<N>(action)`, `WithArgs<N1, N2, ...>(action)`: Invokes `action` with selected mock arguments.
- `WithoutArgs(action)`: Invokes `action` without passing any arguments.
- `Invoke`, `InvokeWithoutArgs`: Executes existing functions, methods, or functors as actions.
- `InvokeArgument<N>(args...)`: Invokes a callable passed as an argument to the mock method.

### Tips for Custom Actions

- When mocking methods with output parameters, use actions like `SetArgPointee<N>(value)` or combine with `DoAll` for return values.
- `WillOnce` supports move-only actions (with `&&`-qualified call operator). `WillRepeatedly` requires copyable actions.
- Lambdas are often the simplest way to create custom behaviors.
- For reusable or complex actions, consider creating named `ACTION` or implementing `ActionInterface`.

---

## Practical Workflow for Customizing Matchers and Actions

### 1. Identify the Need
Understand what aspect of the default mocking framework doesn't suffice—complex argument validation or custom side effects.

### 2. Choose the Approach
- Simple predicates? Use `MATCHER` macros.
- Reusable, parameterized checks? Create matcher classes or use `MATCHER_P` macros.
- Custom behavior for mock methods? Prefer lambdas or `ACTION` macros for clarity.
- Cross-signature polymorphism? Implement polymorphic matcher or action.

### 3. Implement
Write your matcher or action following the conventions discussed.

### 4. Use in Tests
- Apply custom matchers in `EXPECT_CALL` or `ON_CALL` to check arguments.
- Use custom actions with `.WillOnce()`, `.WillRepeatedly()`, or `.WillByDefault()` to define behavior.

### 5. Maintain and Reuse
- Package your custom matchers and actions in utility headers for reuse across test suites.

---

## Common Pitfalls and How To Avoid Them

- **Side Effects in Matchers:** Do not mutate state in matchers; they can be called multiple times.
- **Non-const Methods in Matchers:** Avoid calling non-const or virtual methods on arguments inside matchers.
- **Action Ownership:** When using `Invoke` or `InvokeWithoutArgs`, remember that the action takes ownership of callbacks.
- **Move-only Types:** Use lambdas or functors that support move semantics for methods accepting or returning move-only types.
- **Retiring Expectations:** Use `.RetiresOnSaturation()` on expectations when you want them not to remain sticky after saturation.

---

## Additional Resources

- [gMock Cookbook: Writing New Matchers](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers) 
- [Mocking Reference: EXPECT_CALL and ON_CALL](https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL) 
- [Actions Reference](https://google.github.io/googletest/reference/actions.html) 
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) 

---

For a complete understanding and practical examples on customizations, consult the gMock Cookbook and API references. Embrace the flexibility of GoogleMock’s extensibility to write effective, expressive, and maintainable tests.
