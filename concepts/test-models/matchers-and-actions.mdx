---
title: "Matchers & Actions in Mocking"
description: "Unpack the powerful matchers and actions infrastructure, which enables expressive, composable definitions of expected behavior and responses in mocks. This page explains how these constructs empower flexible, readable, and maintainable test code."
---

# Matchers & Actions in Mocking

Unpack the powerful matchers and actions infrastructure, which enables expressive, composable definitions of expected behavior and responses in mocks. This page explains how these constructs empower flexible, readable, and maintainable test code.

---

## Introduction

In GoogleMock, *matchers* and *actions* form the heart of flexible and precise mocking. They empower you to describe, with remarkable expressiveness, what your mock methods expect as inputs and how they respond during tests. This infrastructure is designed from the ground up to promote readable, maintainable, and composable test code, freeing you from brittle, over-specified mocks.

This guide focuses exclusively on the user-facing concepts of matchers and actions, how to harness their power to craft robust test expectations, and practical tips to avoid common pitfalls.

---

## Matchers: Defining Expected Inputs

Matchers specify *what arguments* a mock method should accept. They act as flexible predicates that validate individual arguments or even the entire argument list of a mock method call.

### The Role of Matchers

Imagine you are testing a component that depends on an interface with mocked methods. Matchers allow you to:

- **Precisely specify argument constraints:** For example, expect that an integer argument is greater than 5, or a string argument contains a particular substring.
- **Create readable tests:** Using built-in matchers or custom ones, you can write expectations that clearly convey your intent.
- **Compose complex conditions:** Combine multiple matchers logically to reflect nuanced requirements.

### Basic Usage

Matchers are used inside `EXPECT_CALL` or `ON_CALL` to describe the expected argument values.

```cpp
using ::testing::_;            // Matches anything
using ::testing::Ge;           // Greater or equal matcher
using ::testing::NotNull;      // Non-null pointer matcher
using ::testing::HasSubstr;    // Checks substring in strings

// Matches GetFoo() called with an integer >= 5
EXPECT_CALL(mock_object, GetFoo(Ge(5))).WillOnce(Return(42));

// Matches DoBar() with any first argument, and a non-null second argument
EXPECT_CALL(mock_object, DoBar(_, NotNull()));
```

The special matcher `_` acts as a wildcard matching anything, letting you ignore particular arguments.

### Composing Matchers

Matchers can be combined using the following combinators:

- `AllOf(m1, m2, ...)` — all matchers must be true
- `AnyOf(m1, m2, ...)` — at least one matcher must be true
- `Not(m)` — negation of a matcher

Example:

```cpp
EXPECT_CALL(mock, Foo(AllOf(Gt(5), Ne(10))))  // Matches Foo(x) with 5 < x != 10
    .WillOnce(Return(true));
```

### Advanced Argument Matching

- **With clause:** Use `.With()` on `EXPECT_CALL` or `ON_CALL` to match the entire argument tuple with a multi-argument matcher, enabling constraints involving multiple arguments at once.

  ```cpp
  EXPECT_CALL(mock, Range(_, _)).With(Lt());  // 1st arg < 2nd arg
  ```

- **Field and Property:** Match arguments based on object members or getters.
  ```cpp
  using ::testing::Field;
  using ::testing::Property;

  // Matches an argument `obj` whose member `count` equals 3
  EXPECT_CALL(mock, Foo(Field(&MyClass::count, 3)));

  // Matches an argument `obj` whose method `size()` returns 5
  EXPECT_CALL(mock, Foo(Property(&MyClass::size, 5)));
  ```

- **Pointee:** Match the value pointed to by pointer arguments.

  ```cpp
  EXPECT_CALL(mock, Bar(Pointee(Ge(3))));  // Pointer argument points to value >= 3
  ```

- **Safe Matcher Casting:** When argument types are not exactly compatible with a matcher’s expected type, use `SafeMatcherCast<T>` to ensure safe conversion.

- **Selecting Between Overloads:** When mocking overloaded methods, use explicit disambiguation tools like `Const()` or specify the exact matcher types to help the compiler.

### Writing Custom Matchers

If built-in matchers are insufficient, write custom matchers:

- Use the `MATCHER` macros for quick custom matchers.
- For more complex cases, define a matcher class implementing `MatchAndExplain()`, `DescribeTo()`, etc.

Example:

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}

EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

### Best Practices for Matchers

- Always specify only what is *relevant* to the test to prevent brittle tests.
- Reuse complex matchers by assigning them to variables.
- Matchers must be *pure*: no side effects or calls to mocks inside matchers.
- Leverage composite matchers for clarity.

---

## Actions: Defining Mock Behavior

Once your expectation is set with matchers describing input arguments, *actions* define *what the mock method does* when invoked under those expectations.

### What Actions Do

Actions enable you to:

- Return values or references.
- Set or modify output parameters.
- Invoke functions, callbacks, or lambdas.
- Throw exceptions.
- Combine multiple actions in sequence.

### Built-In Actions

GoogleMock provides an extensive built-in action repertoire:

- `Return(value)`: Returns a value.
- `ReturnRef(variable)`: Returns a reference.
- `ReturnPointee(ptr)`: Returns the value pointed to by a pointer at call time.
- `SetArgPointee<N>(value)`: Sets the value pointed to by the Nth argument.
- `SetArrayArgument<N>(first, last)`: Copies elements to the Nth argument array.
- `Invoke(function_or_functor)`: Calls a callable with the mock function’s arguments.
- `InvokeWithoutArgs(function_or_functor)`: Invokes a callable with no arguments.
- `InvokeArgument<N>(args...)`: Invokes the Nth argument as a callable with the specified args.
- `Throw(exception)`: Throws an exception when called.
- `DoAll(a1, a2, ..., aN)`: Performs multiple actions in order, returning the last result.

Example:

```cpp
EXPECT_CALL(mock, Foo(5))
    .WillOnce(Return(10));
EXPECT_CALL(mock, Bar(_))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

### Custom Actions

Write your own actions when built-ins fall short:

- Use lambdas or functors directly in `WillOnce`.
- Use `ACTION` macros for reusable action definitions.
- Create polymorphic actions via `MakePolymorphicAction` for use in various mocks.

Example:

```cpp
ACTION(Increment) {
  return ++arg0;
}

EXPECT_CALL(mock, IncrementCounter(_)).WillOnce(Increment());
```

### Action Composition

- Combine actions with `DoAll()` to perform side effects followed by a return.
- Use `IgnoreResult()` to ignore action return values when needed.
- Use `WithArg<N>(action)` or `WithArgs<N1, N2>(action)` to call an action with a subset or rearrangement of arguments.

### Controlling Action Lifetimes and Repetitions

- Use `.WillOnce()` to specify behaviors for single invocations.
- Use `.WillRepeatedly()` for default or fallback behavior after `.WillOnce()`s.
- Understand that `.WillOnce()` actions can be move-only and are invoked at most once.

### Best Practices for Actions

- Avoid unintended side effects by clear action definitions.
- Use `ReturnPointee` to return live values instead of copies.
- Chain `SetArgPointee` with `Return` using `DoAll` when you need to set output parameters *and* return a value.
- For asynchronous code, consider using actions that synchronize test execution.

---

## User Workflow Example

1. **Define Mock Class:** Use `MOCK_METHOD` macros to declare mock methods.
2. **Set Default Behavior:** Set default actions with `ON_CALL` for typical calls.
3. **Set Expectations:** Use `EXPECT_CALL` with matchers to specify expected arguments and times.
4. **Assign Actions:** Define method behaviors with `WillOnce` or `WillRepeatedly` actions.
5. **Run Tests:** Execute code under test; GoogleMock verifies calls and arguments.

---

## Troubleshooting & Tips

- **Uninteresting vs Unexpected Calls:**
  - *Uninteresting*: No `EXPECT_CALL` specified; allowed but causes warnings.
  - *Unexpected*: Arguments do not match any `EXPECT_CALL`; triggers errors.

- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Use `StrictMock<T>` to fail tests on uninteresting calls.
- Beware of method overloading ambiguity; disambiguate using explicit cast or `Const()`.
- If a mock class has a non-virtual destructor, behavior is undefined; always use virtual destructors.
- Use `.RetiresOnSaturation()` to make expectations non-sticky and more precise.

---

## Summary

Matchers and actions are the lenses through which you specify the *expected interactions* and *behavior* of your mocks. Mastering this infrastructure unlocks the full power of GoogleMock — enabling you to write tests that are expressive, resilient, and maintainable.

For a deeper dive, explore the following key documents:

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html#using-matchers)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)

Integrate these techniques into your testing workflow, and watch your tests become powerful tools — not just safety nets.

---