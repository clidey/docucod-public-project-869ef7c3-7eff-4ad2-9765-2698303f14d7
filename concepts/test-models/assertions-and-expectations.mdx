---
title: "Assertions & Expectations"
description: "Dive into the assertion model, differentiating between fatal and non-fatal assertions, and learn how expectations drive automated verification in unit tests. Understand how these mechanisms interact to catch regressions and ensure correctness."
---

# Assertions & Expectations

Understanding assertions and expectations is central to making your unit tests effective and maintainable in GoogleTest and GoogleMock. This page explains the assertion model, clarifies the difference between fatal and non-fatal assertions, and explores how expectations automate verification during test execution. Together, these mechanisms help you catch regressions and ensure code correctness confidently.

---

## 1. Overview of Assertions

Assertions form the backbone of test verification in GoogleTest. They express conditions that must hold true for the test to pass.

### 1.1 Fatal vs Non-Fatal Assertions

- **Fatal Assertions (`ASSERT_*`)**:
  - When a fatal assertion fails, it immediately terminates the current test function.
  - Use them when further execution in the test would be meaningless or might lead to crashes.

- **Non-Fatal Assertions (`EXPECT_*`)**:
  - When a non-fatal assertion fails, the test continues running.
  - Useful to accumulate multiple test failures within the same test and get a comprehensive report at the end.

### 1.2 Example of Assertion Use

```cpp
TEST(MyTestSuite, SampleTest) {
  int x = CalculateSomething();
  ASSERT_NE(x, 0) << "x must not be zero";  // Fatal assertion.

  int y = ComputeRelatedValue(x);
  EXPECT_GT(y, 5) << "y should be greater than 5";  // Non-fatal assertion.

  // More test logic...
}
```

In this example:

- The test stops if `x` is zero with `ASSERT_NE`.
- The test continues even if `y` is not greater than 5 with `EXPECT_GT`.

---

## 2. Expectations in GoogleMock: Driving Automated Verification

While assertions check conditions inside a test, **expectations** in GoogleMock specify how mocked methods should be called during the test. They automate verification of interactions between your code and dependencies.

### 2.1 Defining Expectations with `EXPECT_CALL`

- `EXPECT_CALL` sets an expectation on a mock object's method.
- It declares:
  - Which method is expected to be called.
  - The expected argument values or matchers.
  - The number of invocations (cardinality).
  - The behavior when called (via actions).

Example:

```cpp
using ::testing::_;  // Matches any argument
using ::testing::Return;

MockTurtle turtle;
EXPECT_CALL(turtle, Forward(100))    // Forward called with 100
    .Times(1)                      // Expected exactly once
    .WillOnce(Return());           // Provide action on call

// Exercise code that uses turtle...
```

### 2.2 Expectation Cardinalities

Use `Times()` to specify how many calls you expect:

| Cardinality           | Meaning                            |
|----------------------|----------------------------------|
| `Exactly(n)` or `n`  | Called exactly `n` times           |
| `AtLeast(n)`          | Called at least `n` times          |
| `AtMost(n)`           | Called at most `n` times           |
| `Between(m, n)`       | Called between `m` and `n` times  |
| `AnyNumber()`         | Called any number of times         |

If omitted, GoogleMock infers cardinality based on the usage of `.WillOnce` and `.WillRepeatedly`.

### 2.3 Using Matchers to Specify Arguments

Matchers allow flexible specification of expected arguments.

```cpp
EXPECT_CALL(turtle, GoTo(50, _));  // x=50, y=anything
EXPECT_CALL(mock, DoSomething(Ge(5)));  // Argument >= 5
```

Omitting parameters means "accept any arguments" but only works for non-overloaded methods.

### 2.4 Actions: Controlling Behavior on Calls

- Use `.WillOnce()` and `.WillRepeatedly()` to specify what the mock does when a call matches.
- Common actions:
  - `Return(value)` to return a value.
  - `Invoke(function)` to call a function/lambda.
  - `SetArgPointee<N>(value)` to change output parameters.

Example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

### 2.5 Sticky Expectations and Retiring

Expectations remain "sticky": they stay active even after reaching their call limit unless explicitly instructed otherwise.

To let an expectation retire immediately after being satisfied, use `.RetiresOnSaturation()`:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(10))
    .RetiresOnSaturation();
```

This is crucial when setting multiple expectations with overlapping matchers.

---

## 3. Interaction Between Assertions and Expectations

- **Assertions** verify conditions inside test logic.
- **Expectations** verify that mocked methods are called according to specification.

Violations of expectations cause immediate test failures with detailed diagnostics, helping catch regressions early.

---

## 4. Ordering and Sequences of Expectations

By default, expectations do not enforce call order unless specified.

### 4.1 Sequential Expectations with `InSequence`

Enforce strict call order:

```cpp
using ::testing::InSequence;
{
  InSequence s;

  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

`SecondCall()` must only happen after `FirstCall()`.

### 4.2 Partial Ordering with `After`

Create Directed Acyclic Graphs (DAGs) for call order:

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Process()).After(e1);
```

---

## 5. Controlling Uninteresting and Unexpected Calls

### 5.1 Uninteresting Calls

- Calls to mock methods without `EXPECT_CALL` are "uninteresting".
- By default, these generate warnings but do not fail the test.
- Use `NiceMock<T>` to suppress warnings, or `StrictMock<T>` to make uninteresting calls fail.

### 5.2 Unexpected Calls

- Calls that do not match any existing `EXPECT_CALL` are unexpected and always cause test failures.

### 5.3 Best Practice

- Use `ON_CALL` to set default behavior without introducing expectations.
- Use `EXPECT_CALL` to verify essential interactions.
- Provide catch-all expectations with `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` if other calls are tolerated.

---

## 6. Troubleshooting Common Expectation Issues

- **Calls not matching any expectation:** Verify argument matchers and ordering.
- **Calls made too many times:** Increase `Times()` or add `.RetiresOnSaturation()`.
- **Unexpected calls without expectation:** Add matching `EXPECT_CALL` or adjust mock strictness.
- **Warnings about uninteresting calls:** Confirm if they are intentional; suppress via `NiceMock` or specific expectations.

---

## 7. Practical Tips & Best Practices

- Define the minimal necessary expectations per test - avoid overspecification.
- Use sequences to enforce call order only when essential.
- Prefer `EXPECT_CALL` for critical behavior verifications.
- Use `ON_CALL` for default stub behaviors.
- Use `RetiresOnSaturation()` with multiple `WillOnce()` expectations to avoid sticky expectation issues.
- Check verbose output (`--gmock_verbose=info`) to debug unexpected or unmatched calls.

---

## 8. Summary of Key APIs

| API            | Purpose                          |
| -------------- | --------------------------------|
| `ASSERT_*`     | Fatal assertion - stop test on failure |
| `EXPECT_*`     | Non-fatal assertion - continue test on failure |
| `EXPECT_CALL`  | Expect method call on mock object with arguments, cardinality, and actions |
| `ON_CALL`      | Define default action on mock method without setting expectations |
| `InSequence`   | Define a sequence that orders expectations |
| `Times()`      | Define the number of expected calls (cardinality) |
| `WillOnce()`   | Specify the action for one call match |
| `WillRepeatedly()` | Specify repeated action after `WillOnce()`s |
| `RetiresOnSaturation()` | Retire expectation after being satisfied |

---

## 9. Further Reading & References

- [GoogleMock Cookbook (Expectations)](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#setting-expectations)
- [GoogleMock Reference: EXPECT_CALL](https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [Understanding Uninteresting vs Unexpected Calls](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#uninteresting-vs-unexpected)

---

This page fits within the broader Concepts guide under **Test Models & Mechanisms** and builds on foundational knowledge from the Overview and Mocking Architecture concepts. For coding specifics, refer to the API Reference section on Call Expectations and Cardinalities.


---

<AccordionGroup title="Common User Scenarios">
<Accordion title="Setting an Expectation with Argument Matchers and Action">

```cpp
using ::testing::_; 
using ::testing::Return;

MockTurtle turtle;
EXPECT_CALL(turtle, Forward(_))    // Will match any argument
    .Times(1)                      // Exactly once
    .WillOnce(Return());           // Do nothing, just return
```

</Accordion>
<Accordion title="Controlling Call Order with InSequence">

```cpp
using ::testing::InSequence;

{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

This enforces that the mocked methods must be called in this exact order.

</Accordion>
<Accordion title="Handling Uninteresting Calls">

Use `NiceMock` to silence warnings for calls you don't care to expect:

```cpp
using ::testing::NiceMock;
NiceMock<MockTurtle> mock_turtle;

// Expectations only on some methods
EXPECT_CALL(mock_turtle, PenDown());

// Other calls to mock_turtle methods will not generate warnings
```

</Accordion>
</AccordionGroup>

<Note>
GoogleMock automatically verifies that all expectations are satisfied at the end of the test or when the mock object is destroyed.
If expectations are unmet, the framework provides detailed failure messages including call counts and argument mismatches to pinpoint the problem.
</Note>

<Check>
Remember: Always set expectations before the mock methods are called. Failing to do so results in undefined behavior and unreliable tests.
</Check>

---

### Debugging Expectations with Verbose Output

Run your tests with `--gmock_verbose=info` to see detailed tracing of mock calls, expectations matched, and any mismatches or unexpected calls. This is invaluable for diagnosing why a test failed.

---

<Info>
For advanced control, consider combining expectations with sequences and `After` clauses to define complex call orderings. Use cardinalities to flexibly specify call counts, avoiding brittle tests.
</Info>