---
title: "Mock Objects and Behavior Control"
description: "Unpack the conceptual model behind mock objects in GoogleMock, including method interception, expectations, default actions, and behavior configuration. Discover how the specification builders and mocker macros let you precisely shape fake behavior for testing."
---

# Mock Objects and Behavior Control

Understand the core concepts behind mock objects in GoogleMock, including how mock methods intercept calls, how you set expectations and default behaviors, and how behavior modifiers control uninteresting calls. This guide equips you with a clear mental model to precisely tailor mock behavior using the available macros and spec builders.

---

## What Is a Mock Object?

A mock object simulates the behavior of a real object in your test environment. Unlike real or fake objects that implement functionality, mocks let you specify *expectations*—the calls you *expect* to happen, with which arguments, in what order, and what they return or invoke. GoogleMock uses mock objects to verify interactions between your code and its dependencies, enhancing test reliability and expressiveness.

## How Mock Methods Intercept Calls

Every mock method generated by the `MOCK_METHOD` macro overrides a virtual method in your interface. When your code calls this mocked method, the call is intercepted by GoogleMock’s internal machinery. It uses pre-set expectations to determine if the call is expected, which action to perform, and whether to report errors or warnings.

This interception happens atomically to avoid race conditions even in multithreaded tests. GoogleMock guarantees that actions are executed outside the critical section to prevent deadlocks.

## Setting Expectations with `EXPECT_CALL`

The `EXPECT_CALL` macro lets you define detailed expectations about calls to a mock method. The syntax reads like an English sentence:

```cpp
EXPECT_CALL(mock_object, MethodName(arg_matchers...))
    .With(multi_arg_matcher)    // Optional, once
    .Times(cardinality)         // Optional, once
    .InSequence(sequence_objs)  // Optional, multiple
    .After(expectations)        // Optional, multiple
    .WillOnce(action)           // Optional, multiple
    .WillRepeatedly(action)     // Optional, once
    .RetiresOnSaturation();     // Optional, once
```

- **`.With()`**: Restricts calls by matching *all* arguments as a tuple, useful for complex argument conditions.
- **`.Times()`**: Specifies how many times this call is expected, e.g. `Exactly(n)`, `AtLeast(n)`, or `AnyNumber()`.
- **`.InSequence()`**: Groups expectations into a sequence object to enforce call order.
- **`.After()`**: Specifies partial order constraints; call happens only after specified expectations.
- **`.WillOnce()` / `.WillRepeatedly()`**: Define the behavior or side effects for matching calls.
- **`.RetiresOnSaturation()`**: Makes the expectation inactive once it has been fully satisfied, preventing further matches.

### Expectation Matching Logic

When a mock method is called, GoogleMock searches expectations in reverse order (newer expectations supersede older ones). It finds the first active expectation whose matchers accept the call arguments and whose pre-requisites are all satisfied. If none matches, it may fall back to default actions or report an error.

### Sticky Expectations

Expectations are "sticky" by default: they remain active even after their `.Times()` upper bound is hit, unless `.RetiresOnSaturation()` is specified or they are in a sequence that advances. This design helps model common scenarios more naturally.

## Defining Default Behavior with `ON_CALL`

Use `ON_CALL` to specify default behavior for mock methods when calls happen that don't match any `EXPECT_CALL` expectation or when no expectations are set:

```cpp
ON_CALL(mock_object, MethodName(arg_matchers...))
    .With(multi_arg_matcher)  // Optional
    .WillByDefault(action);   // Required
```

Unlike `EXPECT_CALL`, `ON_CALL` doesn't set expectations about invocation counts or order. It provides the fallback behavior.

Multiple `ON_CALL`s can be set, and the last matching one is used. Use them to define stable default behavior shared across many tests.

## Specifying Behavior and Actions

Actions define what happens when your mock method is called and matches an expectation. Common actions include:

- Returning a value (`Return(value)`)
- Returning a reference (`ReturnRef(variable)`)
- Invoking a function or lambda (`Invoke(func)`)
- Setting output parameters (`SetArgPointee<N>(value)`)
- Calling callbacks passed as arguments (`InvokeArgument<N>(args...)`)
- Performing multiple things on a call (`DoAll(action1, action2, ...)`)

Actions passed to `WillOnce` (called once per invocation) support move-only types and `&&` call operators, while those passed to `WillRepeatedly` need to be copyable.

### Default Actions and Using `WillByDefault`

Default actions specified by `ON_CALL(...).WillByDefault(...)` are overridden by actions specified by matching `EXPECT_CALL` expectations' `WillOnce` or `WillRepeatedly` clauses.

If no explicit action is set, GoogleMock uses a built-in default action based on the return type (e.g., zero for numeric types, `false` for booleans, default-constructed objects, or void).

## Sequences and Ordering

GoogleMock enables you to enforce call order in tests:

- **`Sequence` objects**: Define a chain or DAG of expectations. Use `.InSequence(seq1, seq2, ...)` to assign an expectation to sequences.
- **`InSequence` helper**: Scoped object to automatically place all `EXPECT_CALL`s in its block into a single anonymous sequence.
- **`.After()` clause**: Specify complex partial orders that are not easily expressed by sequences.

Ordering constraints cause earlier expectations to retire once successors match, disabling them from further matches.

## Expectations and Call Counts

Cardinalities control how many times an expectation should match:

| Cardinality       | Meaning                               |
| ----------------- | ------------------------------------- |
| `AnyNumber()`     | The call may occur any number of times |
| `AtLeast(n)`      | At least n times                      |
| `AtMost(n)`       | At most n times                       |
| `Between(m, n)`   | Between m and n times inclusive       |
| `Exactly(n)` or n | Exactly n times                      |

If cardinality is omitted, GoogleMock infers it based on `WillOnce` and `WillRepeatedly` clauses.

Violations cause tests to fail immediately when they occur, or upon verification if calls are missing.

## Handling Uninteresting Calls

An *uninteresting call* is one for which no `EXPECT_CALL` expectation exists.

- **By default**, uninteresting calls generate warnings but do not fail tests.
- **`NiceMock<T>`** suppresses warnings for uninteresting calls for a mock object.
- **`NaggyMock<T>`** (default) warns on uninteresting calls.
- **`StrictMock<T>`** treats uninteresting calls as test failures.

To specify strictness, wrap your mock type:

```cpp
NiceMock<MockFoo> nice_mock;  // Allows uninteresting calls silently
NaggyMock<MockFoo> naggy_mock;  // Warns on uninteresting calls (default)
StrictMock<MockFoo> strict_mock;  // Fails on uninteresting calls
```

Note:
- These wrappers apply only to mock methods defined *directly* in the mock class via `MOCK_METHOD`.
- Destructors of the mock class must be `virtual` for full correctness.

## Controlling Mock Object Verification

GoogleMock automatically verifies that all expectations on mocks are met upon destruction.

Programmatically, you can:

- Verify and clear expectations:

  ```cpp
  bool success = ::testing::Mock::VerifyAndClearExpectations(&mock_object);
  ```

- Verify and clear both expectations and default actions:

  ```cpp
  bool success = ::testing::Mock::VerifyAndClear(&mock_object);
  ```

- Allow intentional leaks (skip verification):

  ```cpp
  ::testing::Mock::AllowLeak(&mock_object);
  ```

Ensure *not* to set new expectations after verification, as the behavior is undefined.

---

## Practical Tips and Best Practices

- **Set expectations *before* exercising your mock object.** Interleaving calls and expectations leads to undefined behavior.
- Use `ON_CALL` to define stable default behavior shared by multiple tests.
- Use `EXPECT_CALL` to specify the exact calls you want to verify.
- Leverage sequences and `.After()` to model call order precisely but avoid over-specifying order unnecessarily.
- Use `RetiresOnSaturation()` to mark expectations inactive when they are fully satisfied to avoid "sticky" expectation issues.
- When a mock method returns a reference, use `ReturnRef()` to avoid dangling references.
- For move-only types, use lambdas or callable objects with `WillOnce()` or `WillRepeatedly()` instead of `Return()`, which only works with copyable types.
- Use `NiceMock` for cleaner test output when uninteresting calls are expected and not worth warning about.
- Use `StrictMock` when you want the test to enforce that *no* uninteresting calls occur.
- If you want your mock to delegate to a real or fake object, set default actions using `ON_CALL` with lambdas.

---

## Related Concepts and References

- [MOCK_METHOD Macro - Defining Mock Methods](https://github.com/google/googletest/blob/main/docs/gmock_cheat_sheet.md#mockclass)
- [EXPECT_CALL - Setting Expectations and Actions](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#EXPECT_CALL)
- [ON_CALL - Setting Default Behavior](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#ON_CALL)
- [Strictness Wrappers: NiceMock, NaggyMock, StrictMock](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#NiceMock)
- [Sequences, Ordering, and Partial Orders](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#Sequence)
- [Actions Reference - Available Actions](https://github.com/google/googletest/blob/main/docs/reference/actions.md)

---

### Troubleshooting

- **Unexpected calls:** Ensure all expected calls are set with `EXPECT_CALL` before exercising mocks.
- **Uninteresting call warnings:** Use `NiceMock` or add an `EXPECT_CALL` with `Times(AnyNumber())` for methods frequently called but not under test.
- **Sticky expectations causing failures:** Use `.RetiresOnSaturation()` to disable expectations once saturated.
- **Order violations:** Review sequences and `.After()` clauses to ensure correct ordering.
- **Default action missing for non-default-constructible return types:** Define explicit default actions via `ON_CALL`.

---