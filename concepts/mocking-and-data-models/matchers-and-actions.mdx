---
title: "Matchers and Actions"
description: "Explains GoogleMock's matcher framework for argument pattern matching and result actions. Outlines the purpose of built-in vs. custom matchers and actions, their flexibility, and usage patterns for readable, robust test code."
---

# Matchers and Actions

GoogleMock’s matcher framework allows you to express expectations on the arguments that mock methods receive and to specify behaviors of those methods via actions. This page explains the core concepts behind matchers and actions, the difference between built-in and custom implementations, and how to use them effectively for writing readable, robust tests.

---

## Understanding Matchers

Matchers are predicates that test whether a function argument satisfies a certain condition. They are fundamental to controlling and verifying interactions in mock objects.

### What Matchers Do

Matchers let you specify patterns that mock method arguments should match. Rather than hardcoding exact values, matchers offer flexible ways to express conditions, such as:

- Exact equality
- Range constraints (e.g., greater than, less than)
- Type-based conditions
- Combinations and negations
- Custom domain-specific logic

For example, instead of expecting a method to be called with integer 5 exactly, you might want to expect any integer greater than 0.

### Built-in Matchers

GoogleMock provides an extensive set of built-in matchers supporting many common cases:

- **Wildcard:** `_` matches any value.
- **Comparison:** `Eq(x)`, `Ne(x)`, `Lt(x)`, `Le(x)`, `Gt(x)`, `Ge(x)`
- **Logical Combinators:** `AllOf(...)`, `AnyOf(...)`, `Not(...)`
- **Container Matchers:** `ElementsAre()`, `UnorderedElementsAre()`
- **Pointer Matchers:** `IsNull()`, `NotNull()`, `Pointee()`
- **Field and Property Matchers:** `Field(&Type::member, matcher)`, `Property(&Type::method, matcher)`

Built-in matchers support composing complex expectations with intuitive expressions.

### Custom Matchers

When built-in matchers do not suffice, you can define your own:

- **Simple custom matcher macros:** Use `MATCHER` and `MATCHER_P` macros to easily create predicate-based matchers.

- **Advanced custom matcher classes:** Implement matching interfaces directly for fine-grained control and better diagnostics.

Custom matchers integrate seamlessly with GoogleMock’s APIs and produce clear failure messages.

### Example: Using Matchers in Expectations

```cpp
using ::testing::_;          // wildcard
using ::testing::Gt;         // greater than
using ::testing::Return;

EXPECT_CALL(mock_obj, Foo(Gt(5), _))
    .WillOnce(Return(true));

// Matcher condition: first argument is > 5; second argument can be anything.
```

### Matching Multiple Arguments Together

Matchers can also inspect all arguments at once using multi-argument matchers with `.With()` and helpers like `Args<>`, `AllArgs()`. This is useful when the relationship between parameters is important:

```cpp
EXPECT_CALL(mock, Func(_, _))
    .With(AllOf(Args<0,1>(Lt()), Args<1>(Gt(10))));
```

### Best Practices With Matchers

- Use `_` for arguments you don't care about.
- Compose matchers to express precise constraints.
- Use `.With()` sparingly to avoid over-specification.
- Create custom matchers for repeated domain logic.

---

## Understanding Actions

Actions specify what a mock method should **do** when invoked, controlling the simulated behavior.

### Built-in Actions

GoogleMock includes many built-in actions:

| Action               | Description                                   |
|----------------------|-----------------------------------------------|
| `Return(value)`      | Return the specified value (copied when set). |
| `ReturnRef(var)`     | Return a reference to a variable.
| `ReturnPointee(ptr)` | Return the value pointed to by `ptr` at call time.
| `DoDefault()`        | Perform the default action specified by `ON_CALL` or the built-in default.
| `SetArgPointee<N>(val)` | Set the value pointed to by the Nth argument.
| `SaveArg<N>(ptr)`    | Save the Nth argument to the pointer `ptr`.
| `Invoke(func)`       | Call a callable with the mock's arguments.
| `InvokeWithoutArgs(func)` | Call a callable ignoring the mock arguments.
| `InvokeArgument<N>(args...)` | Call the Nth argument if callable, passing `args...`.
| `DoAll(a1, a2, ..., an)` | Do all actions in sequence; return the last action’s result.

### Using Actions to Control Behavior

You attach actions to expectations using `.WillOnce()` and `.WillRepeatedly()`. The chained `.WillOnce()` calls specify the action for sequential calls, and `.WillRepeatedly()` specifies action for all subsequent calls.

```cpp
EXPECT_CALL(mock_obj, Foo(_))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

This makes the first call return 42, and all subsequent calls return 0.

### Modifying Output Arguments

Use actions like `SetArgPointee<>` or `SetArrayArgument<>` to change output or inout parameters, optionally chaining them with `Return` via `DoAll()`.

### Using Callables as Actions

Lambdas, functors, and functions can be used as actions, giving you full control:

```cpp
EXPECT_CALL(mock_obj, Foo(_))
    .WillRepeatedly([](int x) { return x * 2; });
```

### Special Actions

- `IgnoreResult(action)`: Wraps an action to ignore its return value.
- `WithArg<N>(action)`, `WithArgs<N1, N2>(action)`: Selects certain arguments for inner action.
- `WithoutArgs(action)`: Calls an action with no arguments.

### Custom Actions

You can define custom actions by implementing `ActionInterface` or by providing callable objects or lambdas compatible with the mocked function signature.

### Example: Mocking Side Effects

```cpp
EXPECT_CALL(mock_obj, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

This sets the pointed-to value of argument 1 to 5 and returns true.

### Best Practices With Actions

- Use `ON_CALL` for default behaviors, `EXPECT_CALL` with `.WillOnce`/`.WillRepeatedly` for specific behaviors and verification.
- Chain actions with `DoAll` when needed.
- Beware of evaluation timing in `Return()`; use lambdas for live values.

---

## Combining Matchers and Actions in Test Flows

1. **Define mock classes** using `MOCK_METHOD` macros reflecting the interface.
2. **Specify expectations** with `EXPECT_CALL(mock, Method(matchers))` to state which calls are expected and how many times.
3. **Attach actions** to expectations to simulate the behavior.
4. **Use matchers** inside `EXPECT_CALL` to assert argument properties precisely.
5. Keep tests robust by specifying **only necessary constraints** to avoid brittleness.

#### Example: Specifying Different Behaviors Based on Arguments

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillRepeatedly(Return(0));
EXPECT_CALL(mock, Compute(Gt(100)))
    .WillRepeatedly(Return(42));
```

Calls with argument > 100 return 42, otherwise 0.

---

## Common Patterns and Pitfalls

- **`ON_CALL` vs `EXPECT_CALL`:** Use `ON_CALL` to define default behavior without enforcing call counts. Use `EXPECT_CALL` to specify expected calls and verify them.
- **Matchers must be pure:** They must not have side effects, as they may be called multiple times or not at all.
- **Beware uninteresting calls:** Calls without matching `EXPECT_CALL`s generate warnings; use `NiceMock` to suppress.
- **Order sensitivity:** The last matching expectation or default action takes precedence; order your `EXPECT_CALL`s accordingly.
- **Custom matcher descriptions:** Enhance failure message clarity by customizing matcher descriptions.

---

## Further Reading and References

- [GoogleMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Actions Reference](../api-reference/mocking-apis/actions.mdx)
- [Matchers Reference](../api-reference/core-testing-apis/matchers.mdx)
- [Mocking Basics Guide](../guides/getting-started-guides/mocking-basics.mdx)

---