---
title: "Extending and Customizing Mocks"
description: "Explore how to build custom actions, matchers, and assertions to adapt the framework for complex or large-scale projects. Learn best practices for maintaining readable and maintainable test code as your test suite grows."
---

# Extending and Customizing Mocks

Explore how to build custom actions, matchers, and assertions to adapt the GoogleTest/GoogleMock framework for complex or large-scale projects. This guide provides best practices for maintaining readable and maintainable test code as your test suite grows, helping you harness the full power and flexibility of mocking.

---

## Overview

When your testing needs surpass basic mock methods and simple expectations, GoogleMock offers robust extensibility through custom matchers, actions, and behavioral controls. By mastering these extension points, you can tailor verifications and behaviors to match your domain, improve test clarity, and manage complexity effectively.

This guide walks you through:

- Creating custom matchers to express domain-specific argument validations.
- Defining custom actions to simulate complex or stateful behaviors.
- Writing powerful composite matchers and actions to keep tests clean and expressive.
- Best practices for maintaining test readability and stability over time.


## Custom Matchers: Making Argument Expectations Expressive and Precise

Matchers let you specify *what* mock method arguments should satisfy, not merely exact values. While built-in matchers cover common cases, crafting your own matchers unlocks elegant and reusable verifications tailored to your testing domain.

### Why Create Custom Matchers?

- Express complex invariants or relationships among arguments.
- Provide clear and meaningful failure messages for debugging.
- Encapsulate argument validation logic once for reuse across tests.

### Basic Structure of a Custom Matcher

A matcher must define how it determines whether an argument matches and how to describe the matcher in error messages.

Example: Define a matcher that checks whether an integer is divisible by a given divisor.

```cpp
#include <gmock/gmock.h>

class DivisibleByMatcher {
 public:
  explicit DivisibleByMatcher(int divisor) : divisor_(divisor) {}

  // Returns true if arg is divisible by divisor_, provides explanation.
  bool MatchAndExplain(int arg, std::ostream* os) const {
    if (arg % divisor_ == 0) return true;
    if (os) *os << "which leaves a remainder " << (arg % divisor_);
    return false;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by " << divisor_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by " << divisor_;
  }

 private:
  const int divisor_;
};

// Factory function
::testing::Matcher<int> DivisibleBy(int divisor) {
  return ::testing::MakeMatcher(new ::testing::MatcherInterface<int>(
      DivisibleByMatcher(divisor)));
}
```

Usage in tests:

```cpp
EXPECT_CALL(mock_object, Foo(DivisibleBy(5)));
```

### Simplified Macros for Custom Matchers

GoogleMock provides `MATCHER` and `MATCHER_P` macros to define matchers swiftly.

Example:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return (arg % divisor) == 0;
}
```

This makes your tests clearer and your matcher reusable.

### Tips for Writing Good Matchers

- Ensure your matcher is *pure*: no side effects, and the result depends only on the input.
- Provide informative failure messages by writing to the result listener.
- Avoid heavy computation inside matchers to keep tests fast.


## Custom Actions: Beyond Simple Return Values

Actions define the behavior of mock functions when invoked. While standard actions like `Return()` and `SetArgPointee()` suffice for many cases, complex scenarios require custom actions that modify multiple arguments, track state, or interact with external systems.

### Why Use Custom Actions?

- Simulate complex side effects, like modifying multiple output parameters.
- Implement stateful behavior that evolves with multiple invocations.
- Call out to helper methods, real objects, or lambdas to produce results dynamically.

### Defining a Simple Action

You can define a callable object, struct, or lambda that matches the signature of the mocked method.

Example: An action that increments a given integer pointer argument.

```cpp
struct IncrementArg {
  void operator()(int* p) const {
    (*p)++;
  }
};

EXPECT_CALL(mock, Mutate(_)).WillOnce(IncrementArg());
```

### Writing More Complex Actions Using `ActionInterface` (for Experts)

When you need full control over argument tuples and return types, implement `ActionInterface<F>`, where `F` is the mock function's signature.

This lets your action be polymorphic, reused across different function types.

### Using Existing Callables

You can easily wrap functions, member pointers, or lambdas using `Invoke()` and related helpers.

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce(::testing::Invoke(&RealFoo::Bar, &real_foo));
```


## Composite and Parameterized Matchers and Actions

### Composing Matchers

Use combinators like `AllOf()`, `AnyOf()`, and `Not()` to create expressive conditions.

Example:

```cpp
EXPECT_CALL(mock, Bar(AllOf(Ge(5), Le(10))));
```

### Parameterized Matchers and Actions

- Parameterized matchers (`MATCHER_P`, `MATCHER_P2`, ...) let you write matchers with parameters.
- Parameterized actions let you create configurable behaviors.

Example:

```cpp
MATCHER_P(IsCloseTo, value, "") { return abs(arg - value) < 0.01; }
EXPECT_CALL(mock, SetVolume(IsCloseTo(0.5)));
```


## Managing Mock Strictness and Verbosity

GoogleMock supports multiple mock strictness levels that affect how uninteresting calls are treated:

- **NiceMock**: Suppresses warnings on uninteresting calls.
- **NaggyMock (default)**: Warns on uninteresting calls.
- **StrictMock**: Fails tests on uninteresting calls.

Usage:

```cpp
using ::testing::NiceMock;
NiceMock<MockClass> nice_mock;
```

Use these wrappers to control the balance between test strictness and noise.

You can also control verbosity of mock call messages with the `--gmock_verbose` flag:

- `info` – Logs all mock calls and expectations.
- `warning` – Logs warnings and errors (default).
- `error` – Logs errors only.


## Best Practices for Maintaining Extensible Mocks

- Prefer **custom matchers** over complex argument lists to keep test calls simple.
- Use **custom actions** to encapsulate complex state changes or side effects.
- Keep your mocks focused: delegate complex behaviors to fakes or real objects when practical.
- Document the intent behind custom matchers and actions to ease maintenance.
- Use strictness wrappers judiciously to avoid brittle tests.
- Test in isolation and keep test logic clear and resilient to implementation changes.


## Troubleshooting Common Pitfalls

- Ensure that custom matchers do not have side effects that could affect test outcomes.
- Beware of the stickiness of expectations; use `.RetiresOnSaturation()` when needed.
- Use `SafeMatcherCast<T>()` when needed to help resolve matcher and argument type mismatches.
- When action state must evolve, prefer stateful custom action objects or lambdas.
- Use `--gmock_verbose=info` for detailed call traces to debug unexpected or uninteresting calls.


## Summary

Customizing and extending GoogleMock through actions and matchers empowers you to write tests that are both precise and maintainable, even in complex codebases. By crafting clear expectations on argument values and behaviors, you make failures meaningful and debugging efficient.

---

## Additional Resources

- [gMock Cookbook](gmock_cook_book.md) — Detailed recipes for custom matchers, actions, and advanced usage.
- [Mocking Reference](reference/mocking.md) — Comprehensive guide on APIs related to mocks.
- [gMock for Dummies](gmock_for_dummies.md) — Beginner-friendly introduction to mocking basics.
- [NiceMock, NaggyMock, and StrictMock Explained](concepts/behavior-strictness/mock-strictness-levels.md) — Understanding mock strictness control.
- [Matchers Reference](reference/matchers.md) — For built-in and composing matchers.
- [Actions Reference](reference/actions.md) — For built-in and creating custom actions.
- [Using Mocks in Tests](guides/core_workflows/mocking-basics.mdx) — Practical application of mocks in tests.

---

By mastering these techniques, your tests will scale gracefully and your confidence in code correctness will grow accordingly.
