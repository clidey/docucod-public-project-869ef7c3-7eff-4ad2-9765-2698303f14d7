---
title: "Matchers and Actions"
description: "Examine how matchers model argument validation for mock calls and assertions, and how actions define responses to those calls. Learn about built-in matchers/actions and how to write custom ones for advanced scenarios."
---

# Matchers and Actions

Explore how GoogleMock uses **matchers** to validate arguments passed to mock methods and **actions** to define the behavior that mock methods exhibit when invoked. This guide covers the built-in matchers and actions, how to combine and customize them, and how to write your own for specialized scenarios.

---

## Introduction

Matchers and actions are the cornerstones of GoogleMock's expressive and flexible API for specifying mock behavior.

- **Matchers** specify predicates that validate each argument passed to a mock method call. They allow tests to declare which argument values are expected or accepted.
- **Actions** describe what happens when a mock method is called — such as returning a value, invoking a callback, or modifying an argument.

Understanding how to use and combine matchers and actions lets you create tests that precisely express your intent, enabling robust interaction-based testing of C++ code.

---

## Matchers: Validating Mock Call Arguments

### Purpose
Matchers let you define expectations on the arguments passed to a mock function, adding precision beyond simply expecting the function to be called.

### Common Matchers
- `_` — *Wildcard matcher*, matches any argument.
- `Eq(value)` — Matches argument equal to `value`.
- `Ge(n)`, `Le(n)`, `Gt(n)`, `Lt(n)`, `Ne(n)` — Matchers for ordering or inequality.
- `NotNull()`, `IsNull()` — Pointer nullity matchers.
- `Ref(variable)` — Matches if argument refers to `variable`.
- `ContainsRegex(regex)` — Matches string arguments matching regex.
- `ElementsAre(...)` — Matches containers with specified elements.

### Matching Multiple Arguments as a Whole

Matchers can also evaluate all function arguments collectively using `.With()`:

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .With(Lt());  // Matches calls where first < second
```

### Matchers for Containers

Use matchers like `ElementsAre()` or `UnorderedElementsAre()` for STL containers or any container supporting iterators to specify expected element sequences.

### Writing Custom Matchers

Write your own matcher classes or use the `MATCHER` macros. Example:

```cpp
MATCHER(IsDivisibleBy7, "") { return (arg % 7) == 0; }
EXPECT_CALL(foo, Bar(IsDivisibleBy7()));
```

This outputs meaningful messages if a test fails, such as reporting remainders.

---

## Actions: Defining Mock Method Behavior

### Purpose
Actions specify what a mock method should do when it’s invoked: return a value, modify arguments, throw exceptions, etc.

### Built-In Actions

#### Returning Values

| Action                | Description                                              |
|-----------------------|----------------------------------------------------------|
| `Return()`            | Return from a `void` mock function.                       |
| `Return(value)`       | Return the specified value. Converts at expectation set. |
| `ReturnArg<N>()`      | Return the N-th (0-based) argument.                       |
| `ReturnRef(variable)` | Return a reference to `variable`.                        |
| `ReturnPointee(ptr)`  | Return the dereferenced value of `ptr`.                   |
| `ReturnNew<T>(...)`   | Return a new `T(...)` constructed with given args.       |
| `ReturnNull()`        | Return a null pointer.                                    |

#### Side Effects and Argument Modifications

| Action                     | Description                                              |
|----------------------------|----------------------------------------------------------|
| `SetArgPointee<N>(value)`  | Assign `value` to what N-th argument points to.          |
| `SetArrayArgument<N>(first, last)` | Copy array range to N-th argument pointer.       |
| `SaveArg<N>(pointer)`      | Save the N-th argument to `*pointer`.                     |
| `DeleteArg<N>()`           | Deletes the N-th argument (must be pointer).            |
| `Throw(exception)`         | Throws the provided exception object.                    |

#### Invoking Callbacks or Functions

| Action                            | Description                                                      |
|----------------------------------|------------------------------------------------------------------|
| `Invoke(f)`                      | Invoke global function or functor `f` with mock args.           |
| `Invoke(object, &Class::method)` | Invoke method on object with mock args.                         |
| `InvokeWithoutArgs(f)`           | Invoke function or functor `f` with no arguments.               |
| `InvokeArgument<N>(args...)`     | Invoke N-th argument (a callable) with the specified `args`.   |

#### Composite and Miscellaneous Actions

| Action        | Description                                       |
|---------------|-------------------------------------------------|
| `DoAll(a1,...,an)` | Perform all actions sequentially; return last result. |
| `IgnoreResult(a)`   | Perform action `a`, but ignore returned value.  |
| `DoDefault()`       | Perform default action (from `ON_CALL` or built-in). |

### Defining Actions Inline

You can use lambdas or functors as actions, for example:

```cpp
EXPECT_CALL(mock, Foo(5))
    .WillOnce([](int n) { return n * 2; });
```

### Combining Actions with `DoAll`

Allows running multiple actions and returning the last action's result:

```cpp
WillOnce(DoAll(SetArgPointee<0>(5), Return(true)))
```

### Returning Move-Only Types

Use lambdas or `Return(std::make_unique<T>(...))` carefully:

- `Return(std::make_unique<T>(...))` evaluated once, returns same pointer.
- Use lambdas to return a fresh value each call.

### Delegating to Fake or Real Implementations

You may delegate default actions to existing implementations using `ON_CALL` with lambdas.

---

## Using Matchers and Actions Together

A typical workflow:

1. Use `EXPECT_CALL(mock, method(matcher1, matcher2, ...))` to set an expectation with matchers.
2. Attach `.Times(cardinality)` to specify call count.
3. Define return behavior with `.WillOnce(action)` and/or `.WillRepeatedly(action)`.

Example:

```cpp
EXPECT_CALL(mock, Compute(Ge(0), _))
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

---

## ON_CALL: Specifying Default Behavior

Unlike `EXPECT_CALL`, which sets expectations and behavior, `ON_CALL` only sets default behavior for calls that don’t have explicit expectations.

Example:

```cpp
ON_CALL(mock, Foo(_))
    .WillByDefault(Return(42));
```

The `ON_CALL` behavior is overridden by matching `EXPECT_CALL`s if present.

---

## Best Practices and Common Pitfalls

- **Match what you care about:** Use specific matchers only where necessary to avoid brittle tests.
- **Use `_` as wildcard:** For arguments you do not want to constrain.
- **Order expectations carefully:** More specific expectations should be declared *after* more general ones.
- **Use `RetiresOnSaturation()` judiciously:** To avoid sticky expectations that remain active even after saturation.
- **Avoid setting expectations after mock calls:** This results in undefined behavior.
- **Consider use of `NiceMock` or `StrictMock`:** To control behavior of uninteresting calls (warnings or errors).

---

## Troubleshooting

- If you get warnings about uninteresting calls, either add `EXPECT_CALL(...).Times(AnyNumber())` or switch to `NiceMock`.
- Use `--gmock_verbose=info` for detailed call tracing.
- When actions run out (e.g., more calls than `WillOnce` clauses), a warning is issued and default action is used.
- Matchers must be pure functions without side effects.

---

## Writing Custom Matchers

Use the `MATCHER` family of macros or implement matcher classes that:

- Provide `MatchAndExplain()` returning `bool`.
- Implement `DescribeTo()` / `DescribeNegationTo()` for clear failure messages.

Example using `MATCHER_P`:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return (arg % divisor) == 0;
}
EXPECT_CALL(mock, Compute(IsDivisibleBy(5)));
```

---

## Writing Custom Actions

Define a callable object or lambda that can be used with `WillOnce()` or `WillRepeatedly()`. For example:

```cpp
struct MultiplyBy {
  int factor;
  template <typename T>
  T operator()(T arg) const { return arg * factor; }
};
EXPECT_CALL(mock, Foo(_)).WillOnce(MultiplyBy{3});
```

Alternatively, implement `ActionInterface` for advanced use.

---

## Summary

Matchers empower you to define precise argument constraints, while actions specify the dynamic response of mocks. Mastering these concepts unlocks the expressive power of GoogleMock for refined, maintainable, and robust C++ testing.

---

## Additional Resources

- [Matchers Reference](/api-reference/gmock-mocking-framework/matchers-and-cardinalities.mdx)
- [Actions Reference](/docs/reference/actions.md)
- [Mocking Reference](/docs/reference/mocking.md)
- [Using Mocks for Beginners](../getting_started/first_test_and_validation/using_googlemock_basics.mdx)
- [Effective Mocking Patterns](/guides/core-workflows/mocking-patterns.mdx)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

---

## Example: Combining Matchers and Actions

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::Ge;

class MockCalculator {
 public:
  MOCK_METHOD(int, Compute, (int x, int y), (override));
};

TEST(CalculatorTest, ComputeBehavior) {
  MockCalculator mock;

  EXPECT_CALL(mock, Compute(Ge(0), _))
      .Times(2)
      .WillOnce(Return(100))
      .WillOnce(Return(200));

  EXPECT_CALL(mock, Compute(_, _))
      .WillRepeatedly(Return(-1));

  EXPECT_EQ(100, mock.Compute(10, 5)); // Matches first expectation
  EXPECT_EQ(200, mock.Compute(0, 1));  // Matches first expectation
  EXPECT_EQ(-1, mock.Compute(-5, 3));  // Matches fallback expectation
}
```

This test shows use of argument matchers to control return values through actions.


