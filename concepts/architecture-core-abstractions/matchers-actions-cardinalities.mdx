---
title: "Matchers, Actions, and Cardinalities"
description: "Delve into how matchers, actions, and cardinalities empower flexible test definition. Matchers assert argument properties, actions define outcomes for mocked calls, and cardinalities specify how often interactions should happen—a trio that expands expressive power and control in tests."
---

# Matchers, Actions, and Cardinalities

Unlock the triad of expressive power in GoogleMock tests: **Matchers**, **Actions**, and **Cardinalities**. They work together to define flexible, controllable mock interactions that align precisely with your testing goals.

---

## Understanding Matchers: Asserting Argument Expectations

Matchers are the powerful predicates that verify the arguments passed to your mock methods. They allow your test to assert that calls happen with arguments meeting specific properties rather than exact values only.

### Basic Usage

When setting expectations on mocked methods, matchers describe what arguments you expect. For example:

```cpp
EXPECT_CALL(mock_obj, Method(Ge(5), "hello", _));
```

This says the first argument should be greater than or equal to 5, the second must exactly equal 'hello', and the third can be anything (`_` is the wildcard matcher).

### Why Use Matchers?

Matchers provide the flexibility to catch calls whose arguments satisfy certain conditions without over-specifying.

- Match specific values precisely with `Eq(value)` or literals
- Validate ranges, nullity, or string patterns (e.g., `Ge(5)`, `NotNull()`, `HasSubstr("text")`)
- Combine conditions using `AllOf()`, `AnyOf()`, and `Not()` for complex logic
- Match specific fields or object properties with `Field()` and `Property()` for fine-grained argument validation

### Real-World Scenario:

Suppose you mock a database query interface and want to verify it only processes queries with a positive ID:

```cpp
EXPECT_CALL(mock_db, Query(Ge(1)));  // Argument must be >= 1
```

This expression filters out invalid call patterns, focusing your test on valid usage.

### Combining Matchers

Use `AllOf()`, `AnyOf()`, and logical negation to compose matchers for intricate conditions:

```cpp
EXPECT_CALL(mock, Process(AllOf(Gt(10), Ne(42))));
```

This means the argument must be greater than 10 and *not* equal to 42.

### Handling Overloaded Methods

When mocking overloaded methods, typing matchers or using explicit casts avoids ambiguity (see later subsections).

---

## Setting Actions: Defining Mocked Behavior

Actions describe what your mock methods should do when called with matching arguments. This can be:

- Returning a value
- Modifying output parameters
- Calling user-defined functions or lambdas
- Executing multiple sub-actions in sequence

### Common Actions

- `Return(value)`: Returns a preset value
- `ReturnRef(variable)`: Returns a reference
- `ReturnPointee(pointer)`: Returns dereferenced value at call time
- `SetArgPointee<N>(value)`: Sets the Nth output pointer argument
- `Invoke(callable)`: Run a function, method, or lambda
- `DoAll(action1, action2, ..., actionN)`: Chain multiple actions

### Example: Returning Different Results on Calls

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

This setup returns 10 on the first call, 20 on the second, and 30 thereafter.

### Side Effects on Output Parameters

Sometimes methods signal results via output parameters. You can use:

```cpp
EXPECT_CALL(mock, FetchData(_, _))
    .WillOnce(DoAll(
        SetArgPointee<1>(42), // sets second argument's pointee
        Return(true)));      // returns true
```

### Using Lambdas and Other Callable Objects

You can write custom actions with lambdas or function objects for complex logic:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 2; });
```

### Delegating Calls

Actions also enable delegating calls to real or fake implementations, preserving behavior while validating interaction (detailed in Cookbook).

---

## Cardinalities: Specifying How Often Calls Happen

Cardinalities define the expected number of times a mock method is called within an `EXPECT_CALL`. These range from exact counts to flexible bounds.

### Built-in Cardinalities

| Cardinality           | Meaning                                         |
|----------------------|------------------------------------------------|
| `Exactly(n)`         | Exactly *n* calls                               |
| `AtLeast(n)`         | At least *n* calls                              |
| `AtMost(n)`          | At most *n* calls                               |
| `Between(m, n)`      | Between *m* and *n* calls (inclusive)          |
| `AnyNumber()`        | Any number of calls (including zero)            |

### Using Cardinalities

```cpp
EXPECT_CALL(mock, Method())
    .Times(Exactly(3));

EXPECT_CALL(mock, Method(_))
    .Times(AtLeast(1));
```

By default, if no `.Times()` is specified, it is inferred based on actions:

- No `WillOnce` or `WillRepeatedly`: `Times(1)`
- n `WillOnce`s, no `WillRepeatedly`: `Times(n)`
- n `WillOnce`s with `WillRepeatedly`: `Times(AtLeast(n))`

### Custom Cardinalities

GoogleMock allows users to define custom cardinalities by implementing the `CardinalityInterface` when builtin clauses don’t meet specific needs (e.g., calls must be even times).

### Practical Value

Controlling cardinality precisely prevents false positives and false negatives in tests by catching unexpected number of invocations or missing calls.

### Example: Expecting No Calls

To verify that a method should **never** be called:

```cpp
EXPECT_CALL(mock, Method(_))
    .Times(0);
```

Any invocation will fail the test.

---

## Bringing It All Together: Defining Flexible, Meaningful Tests

The combination of matchers, actions, and cardinalities allows you to express rich mock specifications that focus on *what* behavior matters to your test, *how* the mock responds, and *how often* interactions occur.

### User Workflow Illustrated

1. **Define Expectations** with `EXPECT_CALL` specifying argument *matchers*.
2. **Specify Call Frequency** using cardinalities via `.Times()`.
3. **Define Behavior** by chaining `.WillOnce()` and `.WillRepeatedly()` with *actions*.
4. **Run Test**, letting GoogleMock verify calls meet all criteria.

### Example

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::AtLeast;
using ::testing::Gt;

EXPECT_CALL(mock, Calculate(Gt(10)))  // Argument must be > 10
    .Times(AtLeast(1))                // Called one or more times
    .WillOnce(Return(42))             // Returns 42 first time
    .WillRepeatedly(Return(0));      // Returns 0 thereafter
```

This example captures a typical scenario: flexible input matching, controlled call counts, and orchestrated behavior.

### Common Pitfalls and Tips

- Avoid over-specifying arguments; use `_` to declare arguments insignificant to the test.
- When expecting multiple calls with different returns, remember to chain `WillOnce` strictly in call order.
- Use `.RetiresOnSaturation()` if you want expectations to retire after matching their specified number of calls, avoiding conflicts with more general expectations.
- Prefer `ON_CALL` for default behaviors when you're not verifying call counts.

---

## Troubleshooting Common Issues

### Unexpected Calls

When a call does not match any `EXPECT_CALL`, it fails the test. To avoid:

- Ensure expectations cover all important scenarios.
- Add catch-all expectations with `.Times(AnyNumber())` if some calls are allowed without strict verification.

### Over-Saturation

Calling a mock method more times than allowed triggers failure, especially without `.RetiresOnSaturation()` or careful cardinality design.

### Order Dependencies

Use `InSequence` or use `.After()` and `.InSequence()` with `Sequence` objects to enforce call ordering to avoid surprises.

---

## Related Concepts and Next Steps

- Review the [gMock Cookbook](gmock_cook_book.md) for practical recipes on intricate usages.
- Explore [Matchers](matchers.md) and [Actions](actions.md) for detailed built-in options.
- Consult the [Cardinalities](cardinalities.md) docs for examples of custom cardinalities.
- Investigate [Mock Strictness](concepts/control-behavior-security-performance/strictness-and-mock-behavior-control) for controlling warnings and test failure behaviors.

---

## Summary Diagram

```mermaid
flowchart TD
  A[Set Expectations with Matchers]
  B[Define Cardinalities (Times)]
  C[Set Actions (Behavior)]
  D[Run Test & Make Calls]
  E{Verify Calls Match Expectations}
  F[Test Passes]
  G[Test Fails: Mismatch or Unexpected Calls]

  A --> B --> C --> D --> E
  E -->|Yes| F
  E -->|No| G

  classDef important fill:#f9f,stroke:#333,stroke-width:2px;
  class A,B,C,D,E,F,G important;
```

---

## See Also

- [Mocking API Reference](../api-reference/core-apis/mocking)
- [Matchers Reference](../api-reference/core-apis/matchers)
- [Actions Reference](../api-reference/core-apis/actions)
- [Cardinalities and Call Counting](../api-reference/advanced-mocking/cardinalities)
- [gMock Cookbook](gmock_cook_book.md)
- [gMock Cheat Sheet](gmock_cheat_sheet.md)

---

<Callout>
**Tip:** For readability and manageability, start simple with broad matchers (`_`) and generic actions. Then refine matchers and actions for increasing precision as your tests mature.
</Callout>
