---
title: "Extending Assertions and Matchers"
description: "Learn how GoogleTest lets you define custom assertions, matchers, and actions to express test logic uniquely suited to your domain. See how the framework enables extensibility while upholding type safety and composability."
---

# Extending Assertions and Matchers

GoogleTest and GoogleMock provide powerful tools for defining test expectations and validating behavior through assertions, matchers, and actions. This page delves into how you can extend these mechanisms by creating your own custom assertions, matchers, and actions tailored to your specific domain needs while maintaining type safety, composability, and expressiveness.

---

## Introduction to Extensibility in GoogleMock

GoogleMock supports extensibility in a way that empowers you to express complex test logic succinctly. Instead of being limited to built-in matchers like `Eq()`, `Lt()`, or actions like `Return()`, you can define domain-specific assertions and matchers that encapsulate reusable logic and produce clear, informative failure messages.

This page focuses on

- Writing custom matchers and parameterized matchers
- Defining new actions
- Extending assertion styles

These extensions enable more readable and maintainable tests, especially for specialized interfaces or complex data structures.

---

## Custom Matchers

A matcher in GoogleMock is a predicate object that can be checked against arguments in mock calls. Custom matchers let you represent complex validations clearly, improving test readability and failure diagnostics.

### Basic Custom Matcher with `MATCHER`

GoogleMock provides macros to define lightweight matchers quickly.

```cpp
MATCHER(NameOfMatcher, "Description string") {
  // 'arg' is the value being matched
  return /* boolean condition based on arg */;
}
```

Example:

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

// Usage
EXPECT_CALL(mock_obj, Func(IsEven()));
```

If the matcher fails, GoogleMock will print "checks if a number is even" along with the actual argument value.

### Parameterized Matchers with `MATCHER_P` and `MATCHER_Pn`

Custom matchers often need parameters to specify dynamic criteria.

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return (arg % divisor) == 0;
}

// Usage
EXPECT_CALL(mock_obj, Func(IsDivisibleBy(7)));
```

You can define up to 10 parameters (e.g., `MATCHER_P2` for 2 parameters).

### Writing Matchers as Classes

For more control and better compile-time checks, define matcher classes implementing:

- `bool MatchAndExplain(const T& value, std::ostream* os) const`
- `void DescribeTo(std::ostream* os) const`
- `void DescribeNegationTo(std::ostream* os) const`

Example skeleton:

```cpp
class EvenMatcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* /* os */) const {
    return n % 2 == 0;
  }
  void DescribeTo(std::ostream* os) const {
    *os << "is even";
  }
  void DescribeNegationTo(std::ostream* os) const {
    *os << "is odd";
  }
};

::testing::Matcher<int> IsEven() {
  return ::testing::MakeMatcher(new EvenMatcher());
}
```

### Polymorphic Matchers

Polymorphic matchers can match arguments of different types; for example, `Eq(5)` matches int, float, double, etc. You can write polymorphic matchers by templating `MatchAndExplain`.

Example:

```cpp
template <typename T>
bool MatchAndExplain(const T& val, std::ostream* os) const { ... }
```

GoogleMock’s `MakePolymorphicMatcher()` helps you wrap such a matcher to become polymorphic.

### Composite Matchers

You can combine existing matchers to build new ones, supporting expressive tests:

- `AllOf()` — all submatchers must succeed
- `AnyOf()` — any submatcher can succeed
- `Not()` — negates a matcher

This allows you to compose rich logic from simple building blocks.

---

## Custom Actions

Actions define what happens when a mock method is called matching a certain expectation.

- Returning values
- Invoking callbacks
- Changing arguments

### Defining Simple Actions

GoogleMock makes it easy to define new actions simply by defining a callable object compatible with the mocked method's signature.

Example:

```cpp
struct MultiplyBy {
  int factor;

  template <typename T>
  T operator()(T arg) const {
    return arg * factor;
  }
};

// Usage
EXPECT_CALL(mock_obj, Func(_))
    .WillOnce(MultiplyBy{7});
```

### Using Lambdas as Actions

You can also use lambdas for concise custom actions:

```cpp
EXPECT_CALL(mock_obj, Func(_))
    .WillOnce([](int x) { return x * 10; });
```

Lambdas can capture test state and perform complex operations inline.

### Polymorphic Actions

When you want an action usable with multiple mock function types, implement a class with a templated `Perform()` method and wrap it using `MakePolymorphicAction()`.

Example:

```cpp
class ReturnFirstArgAction {
 public:
  template <typename Result, typename ArgTuple>
  Result Perform(const ArgTuple& args) const {
    return std::get<0>(args);
  }
};

auto ReturnFirstArg() {
  return ::testing::MakePolymorphicAction(ReturnFirstArgAction());
}
```

### Legacy Actions

Older code may contain `ACTION` and `ACTION_P` macros to create actions. New code should prefer callable objects and lambdas for clarity and stronger type safety.

---

## Guidelines and Best Practices for Extensions

- **Keep matchers pure:** Matchers must not have side effects nor call mock methods.
- **Provide meaningful failure explanations:** Use `MatchAndExplain` to provide helpful context.
- **Leverage parameterized matchers:** Avoid duplicating code by parameterizing your matchers.
- **Prefer lambdas and callables for actions:** They offer clarity, flexibility, and type safety.
- **Understand action and cardinality interactions:** Too many or too few actions relative to `.Times()` can trigger warnings.
- **Use prototyping for complex logic:** Encapsulate complex expectation behavior in custom actions or matchers for reuse.

---

## Troubleshooting Common Issues

### When a Custom Matcher Doesn't Match as Expected

- Verify the matcher is correctly matching expected values.
- Run tests with `--gmock_verbose=info` to see call traces.
- Ensure the matcher type matches argument types or use `SafeMatcherCast` to handle type conversions.

### Warnings About Action Counts

- The number of `WillOnce()` clauses must be coherent with `.Times()`.
- If you receive "Too many actions specified", adjust `.Times()` or remove extraneous `WillOnce()` calls.

### Unexpected Behavior with Custom Actions

- Check that the callable signature matches the mock method.
- Avoid capturing state that may be invalidated.
- Test actions in isolation where possible.

---

## Examples

### Defining a Custom Matcher to Validate a Complex Condition

```cpp
MATCHER_P(IsWithinRange, range, "checks if value is within +/- range") {
  return arg >= -range && arg <= range;
}

EXPECT_CALL(mock_obj, SomeFunc(IsWithinRange(10)));
```

### Defining a Custom Action Using a Lambda

```cpp
EXPECT_CALL(mock_obj, Compute(_))
    .WillOnce([](int x) { return x * x; });
```

### Combining Multiple Expectations with Custom Matchers

```cpp
// A matcher that checks a pair's elements individually
MATCHER_P2(IsPoint, x_matcher, y_matcher, "matches point coordinates") {
  return ::testing::Value(arg.first, x_matcher) &&
         ::testing::Value(arg.second, y_matcher);
}

EXPECT_CALL(mock_obj, ProcessPoint(IsPoint(Eq(0), Lt(10))));
```

---

## Additional References

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)

---

Extending assertions and matchers is a key skill to write expressive, maintainable tests with GoogleMock. By defining custom matchers and actions, you tailor the framework to speak the language of your domain, making test failures informative and tests easier to write. This aligns perfectly with GoogleMock's flexible and powerful mocking philosophy.
