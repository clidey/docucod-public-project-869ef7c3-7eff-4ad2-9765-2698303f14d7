---
title: "Creating Custom Utilities and Extensions"
description: "Investigate the available extension points—macros, templates, and helper types—that let you introduce custom logic into test workflows, such as tailor-made logging, internal matchers, or type traits for advanced testing scenarios."
---

# Creating Custom Utilities and Extensions

GoogleMock provides a rich set of extension points that empower you to introduce custom logic into your testing workflows. Whether you need tailor-made logging, specialized internal matchers, or type traits for advanced scenarios, understanding these extension points helps you craft more robust, flexible tests.

This guide examines the main extension points available—macros, templates, and helper types—and illustrates how you can leverage them to enhance your mock behavior beyond built-in capabilities.

---

## Overview of Extension Points

GoogleMock's architecture was designed to be extensible from the ground up. It offers several mechanisms to hook your own logic into the mocking framework, including:

- **Custom Action Macros:** Define new behaviors for mock functions when the built-in actions don’t quite fit.
- **Parameterized Action Templates:** Create generic, reusable actions that accept explicit template parameters.
- **Helper Types and Traits:** Influence type traits and mocking behavior via specialized helper constructs.

Through these extension points, you gain fine control over how your mocks behave during test execution.

---

## Defining Custom Actions Using ACTION Macros

The simplest way to introduce new mock function behavior is by defining custom actions using the `ACTION` family of macros. These allow you to provide concrete implementation logic that runs when the mock function is called.

### Basic Syntax

```cpp
ACTION(Name) {
  // Use arg0, arg1, ... to access mock function arguments
  // Return a value compatible with the mocked function's return type
  statements;
}
```

- `ACTION(Name)` defines an action named `Name`.
- Inside the action body, use `argK` for the K-th argument (0-based) of the mock function.
- You can also access `args` as a tuple, and see types via `argK_type` and `return_type`.

### Example

```cpp
ACTION(IncrementArg0) {
  return arg0 + 1;
}

// Usage:
EXPECT_CALL(mock, Method(_))
    .WillOnce(IncrementArg0());
```

### Parameterized Actions

When you want actions that accept parameters, use `ACTION_P` and related macros:

```cpp
ACTION_P(PlusN, n) {
  return arg0 + n;
}

// Usage:
EXPECT_CALL(mock, Method(_))
    .WillOnce(PlusN(5));  // returns arg0 + 5
```

There are `ACTION_P2`, `ACTION_P3`, …, up to `ACTION_P10` for multiple parameters.

### Advanced: ACTION_TEMPLATE

If your action needs explicit template parameters that cannot be deduced from the function arguments, use `ACTION_TEMPLATE`. This allows you to define actions parametrized by template arguments as well as value parameters.

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

// Usage:
int n;
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(DuplicateArg<1, unsigned char>(&n));
```

---

## Leveraging Helper Types and Type Traits

Beyond defining new actions, GoogleMock allows controlling more intricate aspects of mocking through helper types and traits.

### Purpose of Helper Types

These types influence:
- How arguments are matched and treated
- How return types are handled
- Internal behaviors of mock methods when special types are involved

### Common Use Cases

- **Supporting Incomplete Types:** By defining how a type should be printed or handled, you can mock methods that take arguments of types whose full definition is not visible.
- **Customize Printing:** Providing `PrintTo()` functions for your types lets GoogleMock generate meaningful error messages during failures.
- **Controlling Template Deduction:** Helper traits help gMock handle subtle C++ template rules, ensuring your mocks compile and behave correctly.

### Example: Printing Incomplete Types

Sometimes you may mock methods accepting incomplete types. To make the mock usable and error messages meaningful, define a `PrintTo()` overload:

```cpp
class Incomplete;

void PrintTo(const Incomplete& x, std::ostream* os) {
  *os << "incomplete";
}
```

This allows setting expectations even with incomplete argument types.

---

## Practical Use Cases for Extension Points

### Custom Logging Inside Mocks

By defining custom actions, you can inject logging behavior that fits your test's diagnostics needs.

```cpp
ACTION(LogCall) {
  std::cout << "Mock called with arg0=" << arg0 << std::endl;
  return arg0;
}

EXPECT_CALL(mock, Method(_)).WillOnce(LogCall());
```

This makes it easy to trace test execution without breaking the test logic.

### Writing Internal Matchers

By crafting custom matchers via the `MATCHER` macros or matcher classes, you extend argument validation capabilities before calls are accepted.

Custom matchers work hand-in-hand with actions to verify and simulate complex conditions.

### Complex Type Traits and Mocking Patterns

Advanced mocking sometimes requires specializing templates or type traits for your own types or external libraries. GoogleMock’s extensibility framework accommodates these needs cleanly.

---

## Best Practices and Tips

- **Define Actions Outside Functions or Classes:** Action macros must be in the global or namespace scope.
- **Avoid Side Effects in Matchers:** Matchers and actions should be pure and side-effect free to maintain test stability.
- **Use `RetiresOnSaturation()` Appropriately:** When your custom actions model limited calls, retiring expectations prevents false failures.
- **Mix with Built-In Actions When Convenient:** Combine your custom actions with built-ins (e.g., `Return`, `DoAll`) for flexibility.
- **Leverage Template Parameterization for Reuse:** `ACTION_TEMPLATE` allows creating highly generic and reusable mock actions.

---

## Troubleshooting Common Issues

**Custom Action Not Invoked?**
- Check that the action is used in `EXPECT_CALL` or `ON_CALL` correctly.
- Verify that the mock method signature matches the action's expected argument signature.

**Compilation Errors in Action Macros?**
- Ensure no unescaped commas exist in your parameter types; wrap such types with extra parentheses or use type aliases.
- Confirm your action macro is declared at namespace or global level.

**Mocking Incomplete Types Fails?**
- Provide a `PrintTo()` overload to handle their display.
- Use explicit declarations or helper traits if the type has complex behavior.

---

## Further Exploration

Explore these related documentation topics for deeper mastery:

- [gMock Cookbook](gmock_cook_book.md#QuickNewActions) — practical recipes for defining new actions
- [Actions Reference](reference/actions.md) — comprehensive list of built-in actions and examples
- [Mocking Reference](reference/mocking.md#WritingNewActions) — details on custom actions and their interfaces

---

Leveraging GoogleMock's extension points unlocks the full power of C++ mocking, enabling you to tailor mock behaviors and validations precisely to your project's needs. These mechanisms allow sophisticated test designs, foster reusable testing utilities, and ensure your tests remain expressive, maintainable, and efficient.