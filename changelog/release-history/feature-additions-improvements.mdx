---
title: "Features Added & Improvements"
description: "Detailed breakdowns of major new features, enhancements, and performance improvements introduced in each release. Users will learn how the framework’s functionality has expanded and how these improvements can be leveraged in their projects."
---

# Features Added & Improvements

This documentation provides an in-depth look into the major new features, enhancements, and performance improvements introduced in each GoogleTest release. By understanding these changes, users can leverage expanded framework capabilities to write more effective tests and mocks, optimize their workflows, and adopt best practices enabled by the latest improvements.

---

## 1. Enhanced Mock Method Definition and Usage

GoogleTest's mocking framework, GoogleMock, has evolved with improvements that simplify the creation and use of mock classes and methods.

### 1.1 Flexible `MOCK_METHOD` Macro

- **Simplified Syntax**: The `MOCK_METHOD` macro defines mock methods with up to four parameters that closely mirror the original method's declaration. This macro supports virtual, const, noexcept, and reference-qualified methods.
- **Handling Complex Types**: Types with embedded commas (such as `std::pair<bool, int>`) require either wrapping the entire type in an extra pair of parentheses or defining type aliases for clarity and correctness.

Example:

```cpp
class MockFoo {
 public:
  // Wrap return type with parentheses to avoid parsing errors
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  
  // Using type alias instead
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
};
```

### 1.2 Mocking Class Templates

Mocking template classes is straightforward, allowing users to mock template parameters in the same manner as regular mocks:

```cpp
template <typename Elem>
class MockStack : public StackInterface<Elem> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const Elem& x), (override));
};
```

### 1.3 Creating “Nice,” “Naggy,” and “Strict” Mocks

- **NiceMock** suppresses warnings for uninteresting calls.
- **NaggyMock** (the default) warns on uninteresting calls.
- **StrictMock** treats uninteresting calls as test failures.

Example:

```cpp
NiceMock<MockFoo> nice_foo;      // Suppresses warnings
NaggyMock<MockFoo> naggy_foo;    // Default
StrictMock<MockFoo> strict_foo;  // Fails on uninteresting calls
```

## 2. Setting Expectations and Default Behaviors

GoogleMock provides a rich domain-specific language (DSL) for defining mock behaviors and expectations.

### 2.1 `EXPECT_CALL` and `ON_CALL` Syntax

- `EXPECT_CALL` sets expectations that a method will be called with specific arguments, possibly restricting cardinality and call sequences.
- `ON_CALL` defines default behaviors without requiring calls to be expected.

Both share similar modifier clauses like `.With()`, `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()`.

### 2.2 Chaining Modifiers and Their Constraints

The modifiers must follow a strict order and usage rules:

- `.With()` appears at most once and must be the first clause.
- `.Times()` can be used once and defines how many times a call is expected.
- `.InSequence()` can be used multiple times to enforce call ordering across sequences.
- `.After()` specifies call ordering after other expectations or sets.
- `.WillOnce()` specifies actions for single calls and can be repeated.
- `.WillRepeatedly()` sets a fallback action and can appear only once.
- `.RetiresOnSaturation()` marks expectations as inactive after saturation.

Violations of these rules generate runtime errors or warnings.

### 2.3 Cardinality and Invocation Count Inference

- If no `.Times()` is specified, cardinality is inferred from `.WillOnce()` and `.WillRepeatedly()` usage.
- For example, if there are *n* `.WillOnce()` clauses and no `.WillRepeatedly()`, `.Times(n)` is inferred.

### 2.4 Default Actions and Last-Match-Wins Behavior

- The most recently defined matching `EXPECT_CALL` or `ON_CALL` takes precedence.
- This search order enables setting up general default expectations early and overriding with more specific ones later.

## 3. Rich Argument Matching

GoogleMock's matcher system lets users express complex argument expectations.

### 3.1 Individual and Composite Matchers

- Use simple matchers (like `_`, `Eq()`, `Ne()`, `Lt()`, etc.) to specify individual argument constraints.
- Combine multiple argument matchers with `.With()` to match tuple arguments as a whole.

Example:

```cpp
EXPECT_CALL(mock, SetPosition(_, _)).With(Lt()); // First argument < second
```

### 3.2 Polymorphic and Custom Matchers

- Users can define custom matchers using `MATCHER`, `MATCHER_P`, and other macros to encapsulate domain-specific logic.
- Polymorphic matchers can work with multiple types, enhancing reusability.

### 3.3 Matching Containers and Pointer Targets

- Match container arguments with `ElementsAre`, `UnorderedElementsAre`, `ElementsAreArray`, etc.
- Use `Pointee(matcher)` to validate values that pointers reference, including smart pointers.

### 3.4 Working With Overloaded Methods

Disambiguate overloaded methods using:

- `Const()` wrapper for const overloads
- Explicit matcher types (`An<T>`, `TypedEq<T>`, `Matcher<T>`) for argument type differentiation

## 4. Actions and Side Effects

Actions specify what a mock call does when matched.

### 4.1 Built-in Actions

- Return values (`Return()`, `ReturnRef()`, `ReturnPointee()`, etc.)
- Side effects (`SetArgPointee()`, `SaveArg()`, `DeleteArg()`, etc.)
- Composite actions (`DoAll()`, `IgnoreResult()`, `WithArg<N>`) allow chaining and argument manipulation

### 4.2 Using Callables as Actions

- Invoke arbitrary functions, methods, functors, lambdas using `Invoke()`, `InvokeWithoutArgs()`, and `InvokeArgument<N>()`.

Example:

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce(Invoke(&my_function));
```

### 4.3 Custom Action Implementations

- Users can define new actions by implementing `ActionInterface<F>` for monomorphic actions.
- For polymorphic behavior across function types, `MakePolymorphicAction()` simplifies creating generic actions.

### 4.4 Handling Move-Only Types

- Move-only method arguments and return types are supported naturally with lambdas or actions.
- For returning new unique objects on each call, write lambdas instead of using `Return(std::make_unique<T>())`.

### 4.5 Delegating Calls

- Default actions can delegate to a fake or real object to preserve behavior while allowing expectation checks.

```cpp
ON_CALL(*this, Method).WillByDefault([this](...) { return real_.Method(...); });
```

## 5. Verifying and Resetting Mocks

### 5.1 Automatic Verification

- Upon destruction, mock objects verify that all expectations have been met. Failures produce descriptive messages.

### 5.2 Manual Verification

- `Mock::VerifyAndClearExpectations(mock_obj)` verifies and clears expectations explicitly.

### 5.3 Clearing Default Actions

- `Mock::VerifyAndClear(mock_obj)` clears default actions (from `ON_CALL`) and expectations.

### 5.4 Allowing Leaks

- Users can explicitly mark mocks as leakable via `Mock::AllowLeak(&mock)` to bypass leak checking.

## 6. Managing Call Ordering and Partial Sequences

### 6.1 Specifying Exact Order

Use the `InSequence` scoped object to enforce strict ordering on all expectations within its scope.

### 6.2 Specifying Partial Orders

- Use `Sequence` objects with `.InSequence()` to specify partial ordering DAGs.
- Use `.After()` to specify prerequisites and enforce partial call orders flexibly.

### 6.3 Retiring Expectations

- Expectations remain active after saturation by default.
- Use `.RetiresOnSaturation()` to mark an expectation inactive after it is fulfilled, allowing more refined control over overlapping expectations.

## 7. Debugging and Verbosity Control

### 7.1 Verbosity Levels

- Controlled via `--gmock_verbose=info|warning|error`
- `info` logs all informational messages, including successful expectations and uninteresting calls with stack traces.
- `warning` (default) logs warnings but omits stack traces for uninteresting calls.
- `error` logs only failures.

### 7.2 Diagnosing Failures

- GoogleMock prints detailed diagnostics showing unmatched arguments, call order violations, and unmet expectations.
- Stack traces help locate sources of expectation failures.

### 7.3 Tips

- Use `EXPECT_THAT` with matchers to get expressive assertions.
- Employ `--gmock_verbose=info` to trace mock call sequences during test failures.

## 8. Multithreading Considerations

- Set expectations before executing code that calls mock methods.
- Calls to mocks can be from multiple threads; GoogleMock synchronizes calls internally.
- Do not set expectations concurrently with mock method invocations; such behavior is undefined.

---

## Practical Example: Using Mock Methods and Expectations

```cpp
#include <gmock/gmock.h>

class MockFoo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};

TEST(FooTest, BasicUsage) {
  MockFoo foo;

  // Set a default action
  ON_CALL(foo, GetSize()).WillByDefault(::testing::Return(10));

  // Expect Describe to be called with "test" 3 times, returning "desc"
  EXPECT_CALL(foo, Describe("test"))
      .Times(3)
      .WillRepeatedly(::testing::Return("desc"));

  EXPECT_EQ(foo.GetSize(), 10);
  for (int i = 0; i < 3; ++i) {
    EXPECT_EQ(foo.Describe("test"), "desc");
  }
}
```

This example demonstrates mock method definitions, setting default behavior with `ON_CALL`, and setting strict expectations with `EXPECT_CALL`.

---

## Troubleshooting & Best Practices

- **Expectations Before Calls**: Always set `EXPECT_CALL` before exercising mock to avoid undefined behavior.
- **Order-sensitive Tests**: Use `InSequence` or `.After()` to enforce call order explicitly.
- **Default Actions**: Use `ON_CALL` for default behavior to reduce verbosity while writing expectations.
- **Uninteresting Calls**: Suppress warnings by using `NiceMock` or adding catch-all expectations with `.Times(AnyNumber())`.
- **Handling Move-only Types**: Prefer lambdas over `Return(std::move(...))` to avoid one-time return value issues.
- **Verification**: Use `Mock::VerifyAndClearExpectations` when mock object lifetime is ambiguous.

## Related Topics and Links

- [Creating & Using Mocks](/api-reference/googlemock-api/creating-and-using-mocks)
- [Setting Expectations](/api-reference/googlemock-api/setting-expectations)
- [Actions & Cardinalities](/api-reference/googlemock-api/actions-and-cardinalities)
- [Matchers API](/api-reference/googletest-core-api/matchers-api)
- [Effective Mocking Guide](/guides/advanced-features-and-patterns/effective-mocking)
- [Writing Custom Matchers and Actions](/guides/advanced-features-and-patterns/writing-custom-matchers-and-actions)

---

By mastering these new features and improvements in GoogleMock, users can create robust, maintainable mocks that accurately represent dependencies, precisely control behaviors, and improve test reliability and clarity.