---
title: "Recent Features & Improvements"
description: "A focused look at recently added capabilities that expand or refine GoogleTest’s and GoogleMock’s offerings. This page spotlights features and enhancements with practical examples, making it easy to adopt new workflows."
---

# Recent Features & Improvements

This page highlights the latest additions and refinements in GoogleTest's mocking capabilities, specifically focusing on GoogleMock's rich features for creating, configuring, and managing mock objects in C++. Each feature is presented with practical, relatable examples to help you smoothly incorporate new workflows into your tests.

---

## 1. Enhanced Mock Method Behavior Control with EXPECT_CALL and ON_CALL

GoogleMock continues to improve how you define and control the behavior of mock methods through the `EXPECT_CALL` and `ON_CALL` constructs:

- `EXPECT_CALL` now impeccably balances expectation verification with action flexibility. It lets you precisely specify:
  - Which method calls are expected,
  - How many times they should occur,
  - What actions they will perform, including sequencing and prerequisite relationships.

- `ON_CALL` complements `EXPECT_CALL` by enabling you to set default actions for mock methods without creating expectations, preventing over-specification and making tests more robust.

### Practical Use Case

Imagine you are testing a component that interacts with a database connection object. Use `ON_CALL` to specify default return values for query methods so most tests don’t have to clutter expectations, then selectively use `EXPECT_CALL` to verify specific query calls with expected arguments and behaviors in particular tests.

```cpp
using ::testing::Return;
using ::testing::_;

class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (), ());
  MOCK_METHOD(bool, Query, (const std::string&), ());
};

MockDatabase mock_db;

// Default action for Query to return true unless overridden
ON_CALL(mock_db, Query(_)).WillByDefault(Return(true));

// Test where a specific query call is expected exactly once
EXPECT_CALL(mock_db, Query("SELECT * FROM users"))
    .Times(1)
    .WillOnce(Return(false));

// The rest of Query calls return true
EXPECT_TRUE(mock_db.Query("SELECT * FROM products"));
```


## 2. Advanced Ordering with Sequences, After Clauses, and Partial Orders

GoogleMock strengthens your ability to enforce order and dependency constraints between mock method calls through:

- **Sequences (`InSequence`)**: Automatically groups expectations to ensure calls occur strictly in declared order.
- **After Clauses**: Lets you declare that a call should only happen after one or more specific expectations have been satisfied.
- **Partial Orders**: Specify complex acyclic dependency graphs by combining multiple sequences and after clauses, allowing more flexible but well-defined call ordering.

### Real-World Scenario

Consider a service initialization workflow, where you want to ensure that a method `InitializeNetwork()` is called before any `SendData()` calls on a mock network interface, but allow other calls to happen in any order.

```cpp
using ::testing::Sequence;

Sequence s;
EXPECT_CALL(mock_network, InitializeNetwork())
    .InSequence(s);
EXPECT_CALL(mock_network, SendData(_))
    .InSequence(s);
```

For partial orders:

```cpp
using ::testing::After;
Expectation init = EXPECT_CALL(mock_network, InitializeNetwork());
EXPECT_CALL(mock_network, Authenticate()).After(init);
EXPECT_CALL(mock_network, SendData(_)).After(init);
```

This setup precisely models real dependencies between actions.


## 3. Rich Support for Overloaded Methods and Const Methods

GoogleMock enhances your productivity with fully supported mocking of overloaded functions and const-qualified methods.

- Overloaded methods require no special workaround beyond standard `MOCK_METHOD` usage.
- The `Const()` wrapper facilitates distinguishing const from non-const methods in expectations.

### Example

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), (const));
  MOCK_METHOD(void, SetValue, (int value));
};
MockFoo mock;
EXPECT_CALL(mock, GetValue());  // Matches const method.
EXPECT_CALL(mock, SetValue(42));
```

If overloads cause ambiguity, disambiguating with `Const()` or casting in matchers resolves the issue.


## 4. Improved Handling of Move-Only Types

Mocking functions with move-only arguments and return types (e.g., `std::unique_ptr`) is streamlined.

- Use `MOCK_METHOD` with move-only types naturally.
- When returning move-only types, it is recommended to use lambdas or functors in `WillOnce`/`WillRepeatedly` to correctly create fresh instances on each call.

### Example

```cpp
MOCK_METHOD(std::unique_ptr<MyObject>, Create, (int id), (override));

EXPECT_CALL(mock, Create(5))
    .WillRepeatedly([](int) { return std::make_unique<MyObject>(); });
```


### Legacy Workaround Avoidance

Previous patterns of delegating move-only arguments to custom mock methods are no longer necessary with current gMock’s native support.


## 5. Diagnostic Improvements via Verbosity Flags and Detailed Warnings

GoogleMock’s diagnostic messages are now more informative and adjustable, helping you pinpoint why expectations fail or are unmet:

- The `--gmock_verbose` flag lets you control verbosity:
  - `info` shows detailed logs including stack traces and all calls.
  - `warning` (default) shows warnings with limited details.
  - `error` shows only errors.

- Warnings for uninteresting calls, unexpected calls, excessive calls, and insufficient actions now clearly indicate the nature of the error and where the call occurred.

### Best Practice

Use `--gmock_verbose=info` during debugging to get full insight into mock interactions, then reduce verbosity for normal test runs.


## 6. Helpful Utilities: VerifyAndClear and AllowLeak for Managing Mock Lifecycles

New and improved facility functions enhance your ability to manage expectations and lifecycle of mocks:

- `Mock::VerifyAndClearExpectations(mock_obj)`: Check all expectations on a mock object have been satisfied and clears them.
- `Mock::VerifyAndClear(mock_obj)`: Additionally clears default actions.
- `Mock::AllowLeak(mock_obj)`: Mark a mock as allowed to leak, suppressing leak warnings for deliberately kept mocks.

These utilities enable better control for scenarios where mock destruction may be delayed or managed externally.


## 7. Practical Tips and Best Practices

- **Prefer ON_CALL over EXPECT_CALL for non-verification behavior**: Avoid over-constraining tests.
- **Use sequences judiciously**: Only enforce order where required to keep tests flexible.
- **Retire expectations with `.RetiresOnSaturation()`** to avoid sticky expectations causing unexpected failures.
- **Suppress uninteresting call warnings with `NiceMock`** or selectively use `EXPECT_CALL(...).Times(AnyNumber())`.
- **Always set expectations before exercising mocks**: Setting expectations late causes undefined behavior.

---

For detailed examples and explanations, consult the [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) and the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html).

---

### Example Workflow: Setting Expectations and Default Behavior for a Mock

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;
using ::testing::Sequence;

class MockService {
 public:
  MOCK_METHOD(int, Compute, (int x), ());
  MOCK_METHOD(void, Notify, (const std::string&), ());
};

void TestExample() {
  MockService mock;

  // Set default behavior for Compute to return 0
  ON_CALL(mock, Compute(_)).WillByDefault(Return(0));

  // Expect Compute(5) to be called once, returning 10
  EXPECT_CALL(mock, Compute(5)).WillOnce(Return(10));

  // Expect Notify to be called exactly twice in order
  Sequence s;
  EXPECT_CALL(mock, Notify("start")).InSequence(s);
  EXPECT_CALL(mock, Notify("end")).InSequence(s);

  // Exercising mock
  int result = mock.Compute(5);          // Returns 10
  int result2 = mock.Compute(8);         // Uses default, returns 0
  mock.Notify("start");
  mock.Notify("end");
}
```

This example demonstrates combining expected calls with default actions, ordered call expectations, and the use of sequences.

---

## Troubleshooting

- **Unmatched calls**: Check argument matchers and ordering constraints.
- **Unexpected calls**: Verify whether you have set appropriate expectations.
- **Excessive calls**: Use `.RetiresOnSaturation()` or `Times()` carefully.
- **Warnings about uninteresting calls**: Consider using `NiceMock` or specify `EXPECT_CALL(...).Times(AnyNumber())`.
- **Move-only type errors**: Use lambdas or functors in `.WillOnce()` or `.WillRepeatedly()` to return fresh objects.

---

_For more details, consult:_
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [GoogleMock Verbosity Flags and Diagnostics](https://google.github.io/googletest/gmock_cook_book.html#Controlling-How-Much-Information-gMock-Prints)

---

GoogleMock’s ongoing improvements empower you to write precise, efficient, and maintainable tests by elegantly specifying expected interactions and method behaviors, all backed by thorough diagnostics and utilities.

---

**Repository and source:** [GoogleTest GitHub Repository](https://github.com/google/googletest)

---

<section style="font-style:italic; font-size:small;">Last updated on branch `main`.</section>
