---
title: "Upgrade Guides"
description: "Step-by-step instructions for upgrading from major previous versions, including code migration, dependency management, and integration tips. These guides offer a checklist approach to ensure smooth transitions."
---

# Upgrade Guides

This guide provides a detailed, step-by-step approach to upgrading your GoogleTest and GoogleMock integration from major previous versions. It focuses on ensuring a smooth transition by covering code migration strategies, dependency management, integration tips, and compatibility considerations.

---

## 1. Preparing Your Environment

Before starting the upgrade process, verify that your development environment meets the essential requirements:

- **C++17 Support:** The GoogleTest 1.17.x branch requires a compiler and build environment that supports at least C++17. Ensure your toolchain is updated accordingly.
- **CMake Version:** CMake 3.14 or later is recommended, especially to use features like `FetchContent_MakeAvailable()` for streamlined dependency management.
- **Platform Compatibility:** Check that your target platform aligns with supported platforms (Linux, macOS, Windows). Also, ensure that `pthreads` support and multi-threading capabilities are enabled if needed.

### Tip
Use the `set(CMAKE_CXX_STANDARD 17)` and `set(CMAKE_CXX_STANDARD_REQUIRED ON)` directives in your project's CMakeLists.txt to enforce the necessary C++ standard.

---

## 2. Updating Build and Integration Workflow

### Using CMake for GoogleTest Integration

GoogleTest provides flexible ways to integrate into your existing CMake-based projects:

- **Standalone Build:** Build GoogleTest and GoogleMock as standalone projects. This method is useful for isolated testing needs.

- **In-Project Build using add_subdirectory():** The recommended approach is to add GoogleTest's source as a subdirectory of your existing project using `add_subdirectory()`. This ensures consistent build settings and avoids issues like runtime library mismatches, particularly on Windows.

- **FetchContent Download:** For a fully automated approach, add the following snippet to your CMakeLists.txt:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)
```

Then link your test targets against `gtest` or `gtest_main`.

> **Note:** Set `gtest_force_shared_crt` option to `ON` on Visual Studio platforms if you use dynamic runtime libraries to avoid linker errors.

### Handling Visual Studio Runtime Mismatch

GoogleTest by default links C runtime statically which can clash with dynamically linked projects. Use the `gtest_force_shared_crt` option to force dynamic linkage of runtimes:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

---

## 3. Migration of Mocking APIs

### Modern MOCK_METHOD Usage

Prior versions of GoogleMock used the legacy `MOCK_METHODn` macros. These are now deprecated in favor of the generalized `MOCK_METHOD` syntax:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

#### Examples

- Mocking a non-const method:

```cpp
MOCK_METHOD(int, Foo, (int x));
```

- Mocking a const method:

```cpp
MOCK_METHOD(int, Foo, (int x), (const));
```

- Mocking a method with `override` and `noexcept` qualifiers:

```cpp
MOCK_METHOD(void, Bar, (), (override, noexcept));
```

If your mocks still use the old macros (e.g., `MOCK_CONST_METHOD3`), update them to the new syntax for improved clarity, better compiler diagnostics, and future-proofing.

### Strictness Control: NiceMock, NaggyMock, and StrictMock

The handling of uninteresting and unexpected calls can be managed by wrapping your mock classes with:

- `NiceMock<T>` suppresses warnings for uninteresting calls.
- `NaggyMock<T>` (default behavior) warns on uninteresting calls.
- `StrictMock<T>` treats uninteresting calls as failures.

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
EXPECT_CALL(mock_foo, ImportantMethod());
```

Use nice mocks to reduce noise in logs and strict mocks to enforce tight contract adherence.

---

## 4. Default Actions and Expectations

GoogleMock distinguishes between `ON_CALL` and `EXPECT_CALL`:

- `ON_CALL` defines *default behavior* without enforcing that a method must be called.
- `EXPECT_CALL` sets expectations on *when* and *how often* a mocked method is called, including behaviors.

### Best Practices for Upgrading

- Use `ON_CALL` to declare default mock behavior and reserve `EXPECT_CALL` for verifying specific interactions.
- Avoid adding unused `EXPECT_CALL` statements to suppress warnings; use `NiceMock` or `.Times(AnyNumber())` appropriately.

Example default behavior setup:

```cpp
ON_CALL(mock_obj, Method(_))
    .WillByDefault(Return(true));
```

---

## 5. Move-Only Type Support

GoogleMock now supports mocking methods with move-only types such as `std::unique_ptr`. To upgrade:

- Use the modern `MOCK_METHOD` macro; no special wrappers are needed.
- When returning move-only types, prefer lambdas in `WillOnce` or `WillRepeatedly`:

```cpp
EXPECT_CALL(mock, CreateInstance(_))
    .WillRepeatedly([](int) {
      return std::make_unique<MyClass>();
    });
```

- For parameters that are move-only, use lambdas or functors where necessary to handle parameter passing.

> Legacy workarounds using helper mock methods without move-only parameters can be removed in favor of native support.

---

## 6. Mock Method Overloads and Const Methods

When mocking overloaded functions or const-qualified methods, specify qualifiers and handle overload disambiguation explicitly:

```cpp
// Mock overloaded non-const and const methods
MOCK_METHOD(int, GetValue, (), (override));
MOCK_METHOD(int, GetValue, (), (const, override));
```

To disambiguate calls to const methods in expectations, use the `Const()` helper in your test:

```cpp
EXPECT_CALL(Const(mock), GetValue())...
```

---

## 7. Forward Compatibility and Deprecation Notices

- The legacy `MOCK_METHODn` macros are deprecated. Begin migrating to the unified `MOCK_METHOD` macro as early as possible.
- Tests using old mocking patterns might face compilation or runtime issues with newer GoogleTest versions.
- Deprecated features will be clearly marked in documentation and release notes.

---

## 8. Troubleshooting Common Upgrade Issues

- **Link Errors:** Check `gtest_force_shared_crt` setting particularly when building with Visual Studio.
- **Runtime Mismatches:** Ensure all parts of your project use the same runtime libraries and compiler flags.
- **Compiler Support:** Confirm your compiler version is compatible with at least C++17 and the required language features.

Refer to [Build and Link Errors FAQ](../faq/troubleshooting-and-best-practices/build-and-link-errors.md) for detailed troubleshooting.

---

## 9. Summary Checklist for Upgrading

- Verify your environment supports C++17.
- Replace all `MOCK_METHODn` macros with `MOCK_METHOD`.
- Update CMakeLists.txt to include GoogleTest using `FetchContent` or `add_subdirectory`.
- Adjust mocks to use `NiceMock` or `StrictMock` as appropriate.
- Refactor tests to separate `ON_CALL` for default mock behaviors and `EXPECT_CALL` for interactions.
- Recompile and run all tests, paying attention to warnings and errors.
- Consult migration guides and update per deprecation notices.

---

## 10. Additional Resources

- [GoogleTest User's Guide](https://google.github.io/googletest/)
- [gMock Cookbook](../guides/gmock_cook_book.md)
- [Mocking Reference](../docs/reference/mocking.md)
- [Build and Link Errors FAQ](../faq/troubleshooting-and-best-practices/build-and-link-errors.md)
- [Nice, Naggy, and Strict Mocks Guide](../guides/mocking-advanced-usage/nice-strict-mocks.md)

---

<Callout title="Tip" type="info">
Always back up your tests and verify test runs independently after each upgrade step to isolate any issues introduced during migration.
</Callout>

---

_Source: Based on the official GoogleTest and GoogleMock documentation and upgrade best practices._

<Source url="https://github.com/google/googletest" />
