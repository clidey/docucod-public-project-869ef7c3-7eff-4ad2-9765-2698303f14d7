---
title: "Breaking Changes"
description: "Proactively identify all breaking API changes, removed features, or behavioral shifts requiring user intervention. Call out affected usage patterns with practical examples and mitigation steps to minimize disruption during upgrades."
---

# Breaking Changes

GoogleTest and GoogleMock occasionally introduce breaking changes in their APIs and behaviors to improve design, performance, or usability. This page highlights those changes so users can adapt their tests and mocks accordingly with minimal disruption.

---

## 1. Overview of Breaking Changes

Breaking changes are modifications that make older code incompatible or require modification to continue working correctly. These can include:

- Removed or renamed macros, functions, or classes
- Changes in default behavior of mock objects
- Modifications in macros' syntax or semantics
- Adjustments in internal expectations matching order
- Changes in default strictness and warning behaviors

This document focuses on user-facing breaking changes related to the mocking API and expectations syntax.

---

## 2. Common Breaking Changes and Their Impact

### 2.1 Changes in `EXPECT_CALL` and `ON_CALL` Syntax and Semantics

- **.With() Clause Ordering:**
  - `.With()` must be the first clause after the `EXPECT_CALL()` or `ON_CALL()` macro invocation.
  - Adding `.With()` after other clauses like `.Times()`, `.InSequence()`, or `.WillOnce()` now results in runtime errors.

- **.Times() Clause Usage:**
  - `.Times()` clause must appear before `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()`.
  - Multiple `.Times()` clauses on the same `EXPECT_CALL` are disallowed.

- **Actions Order in `EXPECT_CALL`:**
  - `.WillOnce()` clauses must appear before `.WillRepeatedly()`.
  - `.WillRepeatedly()` may appear at most once.
  - Violations of this order now trigger runtime failures.

### 2.2 Mock Behavior Changes

- **Default Strictness:**
  - Default mock objects are now "naggy" by default, i.e., they emit warnings on uninteresting calls.
  - Moving from "naggy" to "nice" mock behavior requires explicit use of `NiceMock<T>`.

- **Search Order for Matching Expectations:**
  - When matching a call to multiple expectations, gMock searches expectations in reverse order (newest expectations first). This impacts tests with overlapping expectations.

- **Sticky Expectations:**
  - By default, expectations remain active even after hitting their upper call limit unless `.RetiresOnSaturation()` is specified.
  - Tests relying on old semantics where expectations retire automatically may need updating.

### 2.3 Mocking Non-Virtual and Overloaded Methods

- **Non-Virtual Method Mocking:**
  - Mocking non-virtual methods now requires a different pattern (e.g., header reference) compared to mocking virtual methods. Users must adapt their mock classes to this.

- **Overloaded Methods Resolution:**
  - Users must sometimes explicitly disambiguate overloaded mock methods using typed matchers or casting. Implicit resolution may fail or behave differently.

### 2.4 Move-Only Types Support

- **Move-Only Types in Mock Methods:**
  - Support for mocking methods with move-only argument or return types (e.g., `std::unique_ptr`) requires specific handling.
  - Legacy workarounds such as delegating calls to non-move-only mock methods may be replaced with direct support.

### 2.5 Virtual Destructor Requirement

- When mocking a class, the base type **must have a virtual destructor** to avoid undefined behavior and heap corruption.
  - User code that mocks interfaces or classes without virtual destructors must update those base classes.

---

## 3. Migration Guidance

### 3.1 Adjusting `EXPECT_CALL` and `ON_CALL` Usages

If you previously wrote `EXPECT_CALL` or `ON_CALL` statements with `.With()` appearing after other clauses, reorder calling `.With()` immediately after `EXPECT_CALL(...)` or `ON_CALL(...)`. For example:

```cpp
// Old (will fail):
EXPECT_CALL(foo, Bar(5)).Times(1).With(_);

// New (correct):
EXPECT_CALL(foo, Bar(5)).With(_).Times(1);
```

Ensure `.Times()` appears before `.InSequence()`, `.After()`, or action clauses.

### 3.2 Handle Sticky Expectation Behavior

If your tests fail because expectations remain active after their call count is reached, add `.RetiresOnSaturation()` to those expectations:

```cpp
EXPECT_CALL(foo, Bar())
    .Times(2)
    .RetiresOnSaturation(); // Ensures the expectation deactivates as soon as it is saturated.
```

Alternatively, use `InSequence` scope which automatically retires expectations in sequence.

### 3.3 Use `NiceMock` and `StrictMock` Explicitly

To control the default warning behavior for uninteresting calls:

- Wrap mocks in `testing::NiceMock<T>` to suppress uninteresting call warnings.
- Wrap mocks in `testing::StrictMock<T>` to treat uninteresting calls as failures.

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
EXPECT_CALL(mock_foo, DoSomething());
```

### 3.4 Mocking Overloads

Use typed matchers or `SafeMatcherCast` to disambiguate overloads when necessary:

```cpp
EXPECT_CALL(mock, Func(SafeMatcherCast<int>(Eq(5))));
```

When mocking const overloads, use `Const(mock)` to explicitly specify const context.

### 3.5 Move-Only Type Methods

Use lambdas or `Invoke` with move semantics to handle move-only types properly in actions, e.g.,

```cpp
EXPECT_CALL(mock, Process(std::unique_ptr<Buzz> b))
    .WillOnce([](std::unique_ptr<Buzz> b) { /* handle b */ return true; });
```

Avoid chaining actions that copy move-only parameters.

### 3.6 Virtual Destructors

Make sure all base interfaces of mocks declare destructors as `virtual`:

```cpp
class Foo {
 public:
  virtual ~Foo() = default;
  virtual void Bar() = 0;
};
```

Without virtual destructors, deleting mocks via base pointers can cause subtle bugs.

---

## 4. Examples of Breaking Changes in Code

### Before

```cpp
// Using .With() after .Times() - deprecated and now a runtime error
EXPECT_CALL(foo, Bar(5))
    .Times(1)
    .With(_);
```

### After

```cpp
EXPECT_CALL(foo, Bar(5))
    .With(_)
    .Times(1);
```

### Before

```cpp
// Sticky expectations without retiring
EXPECT_CALL(foo, Bar())
    .Times(2);
foo.Bar();
foo.Bar();
foo.Bar(); // Causes failure now
```

### After

```cpp
EXPECT_CALL(foo, Bar())
    .Times(2)
    .RetiresOnSaturation();
foo.Bar();
foo.Bar();
foo.Bar(); // Matches older expectation or fails based on new configuration
```

### Before

```cpp
// Implicit match to non-const overload
EXPECT_CALL(foo, GetBar())
    .WillOnce(ReturnRef(bar));
```

### After

```cpp
// Disambiguate const and non-const overloads
EXPECT_CALL(foo, GetBar()) // non-const
    .WillOnce(ReturnRef(bar1));
EXPECT_CALL(Const(foo), GetBar()) // const
    .WillOnce(ReturnRef(bar2));
```

---

## 5. Troubleshooting Common Breaking Changes

### Unexpected Runtime Errors in `EXPECT_CALL` / `ON_CALL`

- Check clause ordering (`.With()` first, `.Times()` before `.InSequence()` etc.).
- Verify no multiple `.Times()` or `.WillRepeatedly()`.

### Tests Failing Due to Sticky Expectations

- Add `.RetiresOnSaturation()` where applicable.
- Use `InSequence` for ordered calls.

### Compiler Errors for Overloaded Methods

- Use typed matchers or `SafeMatcherCast`.
- Use `Const()` to specify const overloads.

### Memory Issues with Mocking

- Confirm base classes have virtual destructors.
- Check proper call and mock lifecycle.

### Move-Only Types Compilation Issues

- Use lambdas or callable objects that perfectly match signatures with move semantics.

---

## 6. Summary

Adoption of breaking changes requires reviewing mock usage, especially `EXPECT_CALL` and `ON_CALL` clause order, expectation stickiness, explicit mock strictness control, and move-only type handling. The GoogleMock team aims to improve user experience while balancing backward compatibility; following the migration guides will ensure smooth upgrades.

For further help, consult the [gMock Cookbook](gmock_cook_book.md), [Mocking Reference](reference/mocking.md), and [gMock Cheat Sheet](gmock_cheat_sheet.md).

---

_For detailed examples and further tips, see the [gMock Cookbook](gmock_cook_book.md) and [Mocking Reference](reference/mocking.md)._