---
title: "Upgrade Instructions"
description: "Step-by-step guidance for migrating from earlier releases, including changes in platform or compiler support, new dependencies, and practical examples of updating your code or build files for a smooth adoption of the latest release."
---

# Upgrade Instructions

This guide provides clear, practical steps to help users migrate their projects to the latest version of GoogleTest and GoogleMock. It highlights important changes, new dependencies, and platform or compiler support updates, while offering actionable examples for code and build file updates, ensuring a seamless upgrade experience.

---

## 1. Prepare Your Environment

### 1.1 Verify Compiler Support

Since release 1.17.0, GoogleTest requires a C++17-compliant compiler. Ensure your build environment meets this requirement:

- **Recommended Compilers:** GCC (7 or later), Clang (5 or later), MSVC (2017 or later)
- **Check your compiler version:** For example, run `g++ --version` or `clang++ --version`
- **Update your build tools:** Ensure CMake version 3.14 or higher is used to allow FetchContent and other modern features.

### 1.2 Update Build Tools and Dependencies

- GoogleTest now depends on C++17; set the appropriate compiler flags. For example, add `-std=c++17` to your compiler options if not set.
- If using CMake, update your `CMakeLists.txt` to specify:

  ```cmake
  set(CMAKE_CXX_STANDARD 17)
  set(CMAKE_CXX_STANDARD_REQUIRED ON)
  ```

- Remove or update any deprecated build flags that are incompatible with C++17.

---

## 2. Source Code Adjustments

### 2.1 Transition to New Mock Method Macros

GoogleMock has simplified mock class declarations. Replace older `MOCK_METHODn` or other legacy macros with the modern `MOCK_METHOD` macro:

```cpp
// Before (Legacy macro)
MOCK_METHOD1(Foo, bool(int));

// After (Modern macro)
MOCK_METHOD(bool, Foo, (int));
```

**Note:** Ensure arguments containing commas are properly wrapped in parentheses or use type aliases to avoid parse errors. For example:

```cpp
using PairBoolInt = std::pair<bool, int>;
MOCK_METHOD(PairBoolInt, GetPair, ());
```

### 2.2 Qualifiers on Mock Methods

Include necessary qualifiers like `(const)`, `(override)`, and `(noexcept)` in the `MOCK_METHOD` definition to match the base class functions. For reference:

| Qualifier | Purpose |
|-----------|---------|
| `const`   | Mark method const if overriding const method |
| `override`| Recommended to specify you're overriding a virtual method |
| `noexcept`| Required if overriding a noexcept method |

Example:

```cpp
MOCK_METHOD(void, Reset, (), (override, noexcept));
```

### 2.3 Mocking Non-Virtual Methods

If your code employs high-performance dependency injection via non-virtual methods, continue to mock them similarly but without `override`:

```cpp
MOCK_METHOD(int, GetValue, (), (const));  // No override
```

### 2.4 Update Use of NiceMock, NaggyMock, StrictMock

Review usages of `NiceMock`, `NaggyMock`, and `StrictMock` wrappers to ensure they apply correctly only to mock classes directly declaring `MOCK_METHOD` macros. If you receive unexpected warnings or failures on uninteresting calls, check that these wrappers are applied on the correct class types.

---

## 3. Expectation Syntax and Usage

### 3.1 Leverage ON_CALL and EXPECT_CALL Correctly

- Use `ON_CALL` to set default behaviors **without** expressing a call expectation.
- Use `EXPECT_CALL` to set explicit call expectations with argument matching and call counts.

Example:

```cpp
ON_CALL(mock_object, Method(_)).WillByDefault(Return(true));
EXPECT_CALL(mock_object, Method(42)).Times(1).WillOnce(Return(false));
```

### 3.2 Clause Ordering and Limits

Ensure your use of expectation modifiers follows the enforced order:

```
EXPECT_CALL(mock, Func(args))
   .With(...)       // optional, must be first if used
   .Times(...)      // optional, at most once
   .InSequence(...) // optional, any number
   .After(...)      // optional, any number
   .WillOnce(...)   // optional, any number
   .WillRepeatedly(...) // optional, at most once
   .RetiresOnSaturation() // optional, at most once
```

Violations of this order can cause compile-time or runtime failures. Review and adjust any clauses accordingly when upgrading.

### 3.3 Handle Move-Only Types in Mocks

Support for move-only types (e.g., `std::unique_ptr`) has been modernized. Declare mock methods returning or accepting move-only types with the standard `MOCK_METHOD` macros.

Example:

```cpp
MOCK_METHOD(std::unique_ptr<Foo>, CreateFoo, (int id), (override));
```

Use lambda actions for producing or handling move-only types:

```cpp
EXPECT_CALL(mock, CreateFoo(_))
    .WillRepeatedly([](int id) {
      return std::make_unique<Foo>(id);
    });
```

Review your tests to replace legacy workarounds using delegating mock methods.

### 3.4 Verify and Clear Expectations Explicitly

For complex test scenarios, you can verify mock expectations before destruction to catch unsatisfied expectations early:

```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(&mock_object));
```

Add these calls as needed to maintain testing clarity and prevent leaks.

---

## 4. Build and Integration Updates

### 4.1 Update CMake Configuration

In `CMakeLists.txt`, ensure:

- Use of modern `FetchContent` to incorporate GoogleTest/GoogleMock:
  ```cmake
  include(FetchContent)
  FetchContent_Declare(
    googletest
    URL https://github.com/google/googletest/archive/release-1.17.0.tar.gz
  )
  FetchContent_MakeAvailable(googletest)
  ```
- `target_link_libraries` includes `gtest`, `gmock`, and `gmock_main` as appropriate.
- Set `CMAKE_CXX_STANDARD` to 17.

### 4.2 Linker and Runtime Considerations

On Windows, handle the C runtime linkage properly with options such as:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

To synchronize runtime linkage settings between your project and GoogleTest.

### 4.3 Platform-Specific Adjustments

Follow platform-specific guidance on threading, environment variables, and other considerations mentioned in the Platform-specific Notes documentation to ensure stable builds and executions after upgrading.

---

## 5. Testing and Validation

### 5.1 Regression Testing

After upgrading, rerun your entire test suite to verify:

- Expectations set on mocks behave as intended.
- No warnings related to uninteresting calls occur unless intentional.
- Move-only type handling works correctly.
- Tests compiling and linking succeed with C++17.

### 5.2 Utilize Verbose Mock Logging

If debugging expectation issues, run tests with `--gmock_verbose=info` to gain detailed insight into mock function call matching and failures.

```shell
./your_test --gmock_verbose=info
```

### 5.3 Address Broken Expectations

If expectations are not met or unexpected warnings appear:

- Check if your `ON_CALL` and `EXPECT_CALL` usages follow the updated order and semantics.
- Verify that mock methods have the proper qualifiers matching base class methods.
- Use matchers judiciously to allow flexibility rather than over-specifying calls.

---

## 6. Practical Code Examples

### Updating a Mock Class

#### Before (Legacy style):

```cpp
class MockFoo {
 public:
  MOCK_METHOD1(Foo, bool(int arg));
  MOCK_CONST_METHOD0(GetBar, int());
};
```

#### After (Modern style):

```cpp
class MockFoo {
 public:
  MOCK_METHOD(bool, Foo, (int arg));
  MOCK_METHOD(int, GetBar, (), (const));
};
```

### Setting Expectations with Updated Modifier Order

```cpp
EXPECT_CALL(mock, Foo(_))
    .Times(2)
    .WillOnce(Return(true))
    .WillOnce(Return(false));
```

### Handling Move-only Returns

```cpp
EXPECT_CALL(mock, CreateResource(_))
    .WillRepeatedly([](int id) {
      return std::make_unique<Resource>(id);
    });
```

### Using ON_CALL to Set Default Behavior

```cpp
ON_CALL(mock, GetValue(_)).WillByDefault(Return(42));
```

---

## 7. Additional Resources

- [Mocking Reference](docs/reference/mocking.md): Detailed macros and class usage for mocks.
- [gMock Cookbook](docs/gmock_cook_book.md): Practical recipes for mocking strategies.
- [Legacy gMock FAQ](docs/gmock_faq.md): Answers to common concerns during transition.
- [Platform-Specific Notes](getting-started/installation/platform-specific-notes.md): Important installation info per platform.
- [Integration with Build and CI Systems](overview/integration-adoption/integration-workflow.md): Best practices for build integration.

---

## 8. Summary

Migrating to the latest GoogleTest and GoogleMock version requires updating your environment to support C++17, revising your mock definitions to use modern `MOCK_METHOD` macros with proper qualifiers, and adjusting your expectations syntax accordingly. Ensuring build files are aligned with modern CMake practices and verifying your tests post-upgrade will deliver a smooth transition and access to enhanced mocking capabilities.

<Tip>
Prioritize reading and integrating the [Mocking Reference](docs/reference/mocking.md) and [gMock Cookbook](docs/gmock_cook_book.md) during migration to master updated idioms and best practices.
</Tip>

<Warning>
Avoid mixing legacy and modern mock macros to prevent compilation and behavioral inconsistencies.
</Warning>

---

## 9. Troubleshooting Common Upgrade Issues

<AccordionGroup title="Upgrade Troubleshooting">
<Accordion title="Compilation Fails Due to Missing C++17 Support">
Ensure your compiler and build environment are set to use C++17. Update compiler flags and toolchains accordingly.
</Accordion>
<Accordion title="Warnings About Mock Method Qualifiers">
Review your mock methods to include correct qualifiers (`const`, `override`, `noexcept`) matching the base class declaration.
</Accordion>
<Accordion title="Unintended Uninteresting Call Warnings After Upgrade">
Consider wrapping your mocks with `NiceMock` to suppress warnings or add explicit `EXPECT_CALL`s to signal expected calls.
</Accordion>
<Accordion title="Runtime Failures on Move-Only Type Mocks">
Use lambda functions for actions returning or taking move-only types instead of `Return()` macros.
</Accordion>
<Accordion title="Build System Issues with CMake Integration">
Update your CMake scripts to use `FetchContent` and specify the required C++ standard explicitly.
</Accordion>
</AccordionGroup>