---
title: "Upgrade & Migration Guide"
description: "Step-by-step guidance for upgrading between supported major versions, focusing on core configuration files and code usage changes. Includes practical tips tailored to the most common user environments and clarifies when manual intervention is required."
---

# Upgrade & Migration Guide

This guide provides clear, step-by-step directions for upgrading between major supported versions of GoogleMock and GoogleTest. It focuses on identifying and applying necessary changes in core configuration files and code usage, emphasizing the most common environments and scenarios encountered by users. Practical advice is included to streamline transitions and highlight points where manual intervention is necessary.

---

## 1. Preparing for the Upgrade

### 1.1 Verify Prerequisites
- Ensure your build environment supports **C++17 or newer**, a minimum requirement for recent GoogleMock versions.
- Confirm updated compiler compatibility as per [Build, Linking, and Compiler Issues](https://github.com/google/googletest/blob/main/docs/faq/troubleshooting-optimization/build-link-errors.md).

### 1.2 Backup and Version Control
- Commit all current changes and create backups before beginning.
- Use branches to isolate upgrades, enabling easy rollback if necessary.

### 1.3 Review Release Notes and Breaking Changes
- Read [Breaking Changes](./breaking-changes.md) documentation carefully.
- Check [Deprecations & Removals](./deprecations-removals.md) and [Upgrade & Migration Guide](this document).


## 2. Configuration and Build System Updates

### 2.1 CMake and Build Scripts
- Ensure your `CMakeLists.txt` or build scripts specify C++17 standard explicitly:

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

- For integration, update GoogleMock and GoogleTest references to point to the new version.
- If using FetchContent or submodules, synchronize the repository to the new version tag or commit.

### 2.2 Threading and Linking
- Check for changes in threading model or flags. If required, update `-DGTEST_HAS_PTHREAD=1` or similar flags.
- Adjust linker and compiler flags if warnings about runtime library mismatches occur (see [Build, Linking, and Compiler Issues](./faq/troubleshooting-optimization/build-link-errors.md)).

### 2.3 Flags and Environment Variables
- New command-line flags or updated flag semantics may affect mock behavior (e.g., `--gmock_verbose`).
- Review and update any custom flag settings to align with the latest version.

## 3. Code Changes: Mock Definitions and Expectations

### 3.1 Replace Old Macros `MOCK_METHODn` with `MOCK_METHOD`

The older `MOCK_METHODn` family macros are deprecated. Migrate to the unified `MOCK_METHOD` macro:

```cpp
// Old style
MOCK_METHOD1(Foo, bool(int));

// New style
MOCK_METHOD(bool, Foo, (int), (override));
```

- Wrap complex template types or return types with parentheses if they contain commas:

```cpp
MOCK_METHOD((std::pair<int, int>), GetPair, ());
```

- Always put mock methods in the `public:` section, regardless of base method visibility.

### 3.2 Mocking Non-Virtual and Overloaded Methods

- Non-virtual functions require different pattern (see the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html#MockingNonVirtualMethods)).
- For overloaded methods, mock all overloads to avoid hiding base methods or use `using`:

```cpp
using BaseClass::Method;
MOCK_METHOD(...);  // only on selected overloads
```

### 3.3 Strictness Wrappers: NiceMock, NaggyMock, StrictMock

- Validate that usage of wrappers conforms to updated semantics (some behavior refinements).
- Nesting these wrappers is unsupported.

### 3.4 Action and Matcher Updates

- Replace deprecated actions and matchers with their modern equivalents.
- For move-only types, prefer `MOCK_METHOD` and lambdas for `WillOnce` to generate fresh return values.

### 3.5 Expectation Ordering and RetiresOnSaturation

- Explicitly use `.RetiresOnSaturation()` where expectations are non-sticky to avoid upper bound errors.
- Prefer `InSequence` blocks or `Sequence` objects for ordered calls.

### 3.6 Initialization and Framework Entry Points

- Initialize GoogleMock and GoogleTest properly using `InitGoogleMock(&argc, argv);`.
- Replace any custom main functions with updated versions where applicable (consult [Test Runner Entrypoints](./api-reference/test-execution-and-integration/test-runner-entrypoint.md)).

## 4. Common Upgrade Scenarios

### 4.1 Upgrading Mock Classes

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
};
```

- Replace any old macro usages.
- Add qualifiers like `override` and `const` as appropriate.

### 4.2 Replacing Deprecated Macros

- Replace `EXPECT_CALL` and `ON_CALL` usage with updated matchers.
- Avoid defining multiple expectations that conflict in order without sequences.

### 4.3 Migrating Custom Actions and Matchers

- Check that custom matchers use recommended polymorphic or typed matcher patterns.
- Refactor custom actions with `ACTION`, `ACTION_P`, or `MakePolymorphicAction` where possible.

## 5. Manual Intervention Points

### 5.1 Complex Mock Macros

- When mocking methods with complicated signatures (e.g., with templates or commas), manually wrap types or create type aliases.

### 5.2 Handling Virtual Destructors

- Ensure interfaces and mock classes have **virtual destructors** to avoid runtime errors.

### 5.3 Review of Strictness Levels

- Assess whether existing tests require changing mocks wrapped in `StrictMock` or `NiceMock`.

### 5.4 Adjusting Test Cases for Behavior Changes

- Some warnings and errors have been tightened; review tests for unexpected calls or argument mismatches.

## 6. Verification and Troubleshooting

- Use `--gmock_verbose=info` flag to trace mock call matching during test execution.
- Verify that all expectations are set before the mocks are exercised.
- Use `Mock::VerifyAndClearExpectations(&mock)` to force verification early if needed.

## 7. Best Practices and Tips

- Prefer setting default behaviors with `ON_CALL` and only set strict expectations with `EXPECT_CALL` when mandatory.
- Use `NiceMock` to suppress warnings for uninteresting calls when appropriate.
- Add catch-all expectations with `.Times(AnyNumber())` for methods expected but not strictly verified.
- Chain actions with `DoAll()` to combine side effects and return values.

## 8. Legacy Code Considerations

- Avoid old `MOCK_METHODn` macros; migrate to avoid future compatibility issues.
- Replace deprecated idioms with modern patterns.

## 9. Additional Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Breaking Changes and Migration](./breaking-changes.md)
- [Mocking Reference](./reference/mocking.md)
- [Setup and Installation](./getting-started/essentials/installation-platforms.md)
- [Test Runner Entrypoints](./api-reference/test-execution-and-integration/test-runner-entrypoint.md)
- [Matchers and Actions](./api-reference/core-mocking-api/mock-behavior-actions.md)

---

# Visual Summary Diagram
```mermaid
flowchart TD
  Start([Start Upgrade Process]) --> VerifyEnv["Verify C++17 support & compiler compatibility"]
  VerifyEnv --> Backup["Backup existing code & configs"]
  Backup --> ReviewDocs["Review breaking changes and release notes"]
  ReviewDocs --> UpdateBuild["Update build system & CMake files"]
  UpdateBuild --> ReplaceMacros["Replace MOCK_METHODn with MOCK_METHOD"]
  ReplaceMacros --> AdjustMocks["Adjust mock classes, add qualifiers"]
  AdjustMocks --> AdaptExpectations["Modify EXPECT_CALL, ON_CALL usage"]
  AdaptExpectations --> VerifyDestructors["Ensure virtual destructors on interfaces"]
  VerifyDestructors --> FixStrictness["Review strictness wrappers & ordered calls"]
  FixStrictness --> UpdateInit["Update init code and entry points"]
  UpdateInit --> TestAndDebug["Run tests with --gmock_verbose=info"]
  TestAndDebug --> FixIssues["Fix reported errors & warnings"]
  FixIssues --> Finish[End]

  classDef staging fill:#eef,stroke:#aac,stroke-width:2px;
  class VerifyEnv,Backup,ReviewDocs,UpdateBuild,ReplaceMacros,AdjustMocks,
  AdaptExpectations,VerifyDestructors,FixStrictness,UpdateInit,TestAndDebug,
  FixIssues staging;
```

---

## Callout
<Tip>
Always pin to a specific GoogleMock version in your build system to avoid unexpected incompatibilities.
</Tip>

<Warning>
Manual adjustment of complex mock method signatures or build configurations might be necessary.
</Warning>

<Check>
Run your full test suite with increased verbosity to catch silent errors early in the upgrade.
</Check>
