---
title: "Upgrade Examples"
description: "Showcases before-and-after code snippets and real-world scenarios to illustrate moving from older to newer versions, ensuring users can visualize and validate their upgrade process."
---

# Upgrade Examples

This page demonstrates practical "before-and-after" code snippets and real-world scenarios illustrating how to upgrade GoogleMock from older versions to newer ones. By walking through these examples, users will clearly visualize the necessary code changes and validate their upgrade process, ensuring compatibility and leveraging new features effectively.

---

## 1. Migrating from Old MOCK_METHODn Macros to Modern MOCK_METHOD

### Before (Using Old-Style MOCK_METHODn)

```cpp
class MockFoo {
 public:
  MOCK_METHOD1(Foo, bool(int));
  MOCK_CONST_METHOD2(Bar, int(const std::string&, double));
};
```

### After (Using New MOCK_METHOD)

```cpp
class MockFoo {
 public:
  MOCK_METHOD(bool, Foo, (int), (override));  // simple mock method
  MOCK_METHOD(int, Bar, (const std::string&, double), (const, override));  // const method
};
```

### Explanation
- New `MOCK_METHOD` macro takes the return type, method name, argument list (with parentheses), and an optional specifier list.
- Use `(override)` qualifier if overriding a virtual method.
- Commas in template types should be wrapped with parentheses or type aliases.

---

## 2. Handling Method Overloads Explicitly

### Before

Trying to mock overloaded methods without disambiguation:

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, Add, (int), (override));
  // Missing other overload leads to hidden base methods warning.
};
```

### After

```cpp
class MockFoo : public Foo {
 public:
  using Foo::Add;  // Bring all overloads into scope
  MOCK_METHOD(int, Add, (int), (override));
  MOCK_METHOD(int, Add, (int, int), (override));  // mock other overload explicitly
};
```

### Explanation
Always mock all overloads you intend to test or use `using BaseClass::MethodName;` to avoid hidden method warnings.

---

## 3. Adapting to C++17 Requirement (Since GoogleMock 1.17.0)

### Before

Older tests built with C++11 or before:

```cmake
set(CMAKE_CXX_STANDARD 11)
```

### After

Update your build system and compiler flags to support C++17 or newer:

```cmake
set(CMAKE_CXX_STANDARD 17)
```

### Explanation
GoogleTest & GoogleMock 1.17.0 onwards require a C++17 compliant compiler and standard, because of modernization in mock implementations and standard library usage.

---

## 4. Switching from Old MOCK_METHOD Macros to MOCK_METHOD for Mock Methods with Commas

### Before

```cpp
MOCK_METHOD(std::pair<bool, int>, GetPair, ());  // Won't compile!
MOCK_METHOD(bool, CheckMap, (std::map<int, double>, bool));  // Won't compile!
```

### After (Option 1: Use Parentheses Wrapping)

```cpp
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
```

### After (Option 2: Use Type Aliases)

```cpp
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD(BoolAndInt, GetPair, ());
using MapIntDouble = std::map<int, double>;
MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
```

### Explanation
To avoid parsing errors caused by unprotected commas in template types, wrap the argument or return type in extra parentheses or use clear type aliases.

---

## 5. Leveraging NiceMock and StrictMock Wrappers

### Before

```cpp
MockFoo mock_foo;
EXPECT_CALL(mock_foo, DoThis());
// Warning generated for uninteresting calls.
```

### After (Make Mock Nice to Silence Uninteresting Call Warnings)

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
EXPECT_CALL(mock_foo, DoThis());
// Warnings suppressed for uninteresting calls.
```

### After (Make Mock Strict to Error on Uninteresting Calls)

```cpp
using ::testing::StrictMock;
StrictMock<MockFoo> mock_foo;
EXPECT_CALL(mock_foo, DoThis());
// Test fails if uninteresting calls occur.
```

### Explanation
Wrapping mocks with `NiceMock` suppresses warnings on uninteresting calls, while `StrictMock` treats them as test failures. These wrappers inherit constructors from the underlying mock, maintaining usability.

---

## 6. Delegating Calls to Real or Fake Objects

### Scenario
You have a `FakeFoo` object implementing the same interface as `MockFoo`, and you want your mock to delegate actual logic to this fake by default.

### Example
```cpp
class FakeFoo : public Foo {
public:
  char DoThis(int n) override { return ...; }
  void DoThat(const char* s, int* p) override { ... }
};

class MockFoo : public Foo {
public:
  MOCK_METHOD(char, DoThis, (int n), (override));
  MOCK_METHOD(void, DoThat, (const char* s, int* p), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault(
        [this](int n) { return fake_.DoThis(n); });
    ON_CALL(*this, DoThat).WillByDefault(
        [this](const char* s, int* p) { fake_.DoThat(s, p); });
  }

private:
  FakeFoo fake_;
};

// Usage
MockFoo mock;
mock.DelegateToFake();
EXPECT_CALL(mock, DoThis(5));
EXPECT_CALL(mock, DoThat(_, _));
```

### Explanation
Delegating to a fake allows you to validate method calls while retaining real behavior. You can override default behaviors with specific `ON_CALL` or `EXPECT_CALL` setups.

---

## 7. Updating Mock Setup and Expectations After VerifyAndClear

### After Calling `Mock::VerifyAndClear()`

```cpp
MockFoo mock;
EXPECT_CALL(mock, Foo(42)).WillOnce(Return(true));
mock.Foo(42);

Mock::VerifyAndClear(&mock);

// Now safe to set new expectations
EXPECT_CALL(mock, Foo(7)).WillOnce(Return(false));
```

### Explanation
After verifying and clearing expectations, mocks are reset and safe to reconfigure for new expectations.

---

## 8. Use Modern Features for Move-Only Types in Mock Methods

### Before

Legacy workaround for mocking methods that accept move-only types:

```cpp
class MockBuzzer : public Buzzer {
 public:
  MOCK_METHOD(bool, DoShareBuzz, (Buzz* buzz, Time timestamp));

  bool ShareBuzz(std::unique_ptr<Buzz> buzz, Time timestamp) override {
    return DoShareBuzz(buzz.get(), timestamp);
  }
};
```

### After (Modern Method using MOCK_METHOD and Lambdas)

```cpp
class MockBuzzer : public Buzzer {
 public:
  MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
  MOCK_METHOD(bool, ShareBuzz,
              (std::unique_ptr<Buzz> buzz, int64_t timestamp),
              (override));
};

// Usage
EXPECT_CALL(mock_buzzer, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
      return std::make_unique<Buzz>(AccessLevel::kInternal);
    });

EXPECT_CALL(mock_buzzer, ShareBuzz(NotNull(), _)).WillOnce(Return(true));
```

### Explanation
Support for move-only types in mock methods is now native, allowing straightforward use of `MOCK_METHOD` with move-only argument types such as `std::unique_ptr`.

---

## 9. Example: Using Sequences to Enforce Call Order

```cpp
using ::testing::InSequence;
using ::testing::Return;

{
  InSequence s;
  EXPECT_CALL(mock, Initialize()).WillOnce(Return(true));
  EXPECT_CALL(mock, Process()).Times(2);
  EXPECT_CALL(mock, Cleanup()).WillOnce(Return());
}

// Calls to mock will be verified to respect this order.
```

### Explanation
The `InSequence` scope causes all expectations declared within to enforce strict call order.

---

## 10. Sample Upgrade in Test Cases

### Before

```cpp
TEST(FooTest, OldSyntax) {
  MockFoo mock_foo;
  EXPECT_CALL(mock_foo, DoSomething(42));
  ...
}
```

### After

```cpp
TEST(FooTest, ModernSyntax) {
  MockFoo mock_foo;
  EXPECT_CALL(mock_foo, DoSomething(42))
      .Times(1)
      .WillOnce(Return(true));

  ...
}
```

### Explanation
Specifying `.Times(1)` and `.WillOnce()` explicitly documents test intent and controls mock behavior precisely.

---

## Tips for a Smooth Upgrade

- Prefer `MOCK_METHOD` over legacy `MOCK_METHODn` macros.
- Wrap argument or return types containing commas with parentheses or use type aliases.
- Add explicit `(override)` qualifiers.
- Upgrade your compiler and build environment to C++17 standards.
- Use `NiceMock` and `StrictMock` wrappers to control warning behavior.
- Utilize sequences to enforce expected call order.
- Delegate to fakes or real objects where appropriate.
- Clear expectations between tests with `Mock::VerifyAndClear` to avoid leftover state.

---

## Further Reading and Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Breaking Changes & Deprecations](../migration-and-upgrade-guides/breaking-changes.md)
- [Migration Tips](../migration-and-upgrade-guides/migration-tips.md)
- [Mocking API Reference](../../api-reference/mocking-api/specifying-expectations.md)

---

These upgrade examples will help you confidently transition your GoogleMock usage to the latest interfaces and best practices, ensuring your tests remain robust, maintainable, and compatible with future GoogleTest releases.

---

> For detailed migration guides and breaking changes, consult the [Breaking Changes & Deprecations](../migration-and-upgrade-guides/breaking-changes) page, and for strategy and troubleshooting, review the [Migration Tips](../migration-and-upgrade-guides/migration-tips) guide.