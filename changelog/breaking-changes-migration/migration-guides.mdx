---
title: "Migration & Upgrade Guides"
description: "Step-by-step recommendations for migrating test code to comply with new versions, including sample fixes, compatibility strategies, and references to edited behaviors. Essential for maintainers managing large test suites or CI systems."
---

# Migration & Upgrade Guides

Ensure your test suites and mocking code stay reliable and maintainable as GoogleTest and GoogleMock evolve. This guide provides clear, step-by-step recommendations for migrating your existing test code to new GoogleTest/GoogleMock versions. Learn how to adapt to updated syntax, modified behaviors, and deprecated features with practical examples and strategies.

---

## 1. Overview of Migration

Upgrading GoogleTest and GoogleMock often introduces syntactic improvements, behavior clarifications, and occasionally breaking changes to enhance reliability and usability. Maintaining large test suites or continuous integration (CI) systems demands awareness of relevant changes and systematic migration to prevent test failures.

This guide focuses specifically on migration of test code -- particularly the mocking layer -- to comply with new versions, reducing maintenance overhead and improving test robustness.

---

## 2. Key Migration Topics

### 2.1 Migrating from Old `MOCK_METHODn` Macros to `MOCK_METHOD`

Older GoogleMock versions use `MOCK_METHODn` macros, which are now deprecated:

- Replace all instances of `MOCK_METHODn(MethodName, ReturnType(Args))` with `MOCK_METHOD(ReturnType, MethodName, (Args))`.
- For const methods, use `MOCK_METHOD(ReturnType, MethodName, (Args), (const))`.
- When call type qualifiers or reference qualifiers are required, use the corresponding syntax with the optional 4th parameter in `MOCK_METHOD`.

**Example:**

```cpp
// Old style
MOCK_CONST_METHOD1(Foo, bool(int));

// New style
MOCK_METHOD(bool, Foo, (int), (const));
```

This migration improves compatibility with various compilers and enhances maintainability.

### 2.2 Adjusting Call Expectation Modifiers Order

GoogleMock now enforces a stricter order for chained clauses in `EXPECT_CALL` and `ON_CALL` macros. The order must follow:

- `.With()` (at most once, and should come first)
- `.Times()` (at most once)
- `.InSequence()` (any number of times)
- `.After()` (any number of times)
- `.WillOnce()` (any number of times)
- `.WillRepeatedly()` (at most once)
- `.RetiresOnSaturation()` (at most once, and must come last)

Review and update your call expectations to adhere to this order. Failure to do so results in compilation errors to avoid ambiguous behavior.

### 2.3 Handling Behavior Changes in Strict, Nice, and Naggy Mocks

- **NaggyMock** is now the default behavior for mocks.
- **StrictMock** emits errors on uninteresting calls.
- **NiceMock** suppresses warnings but allows calls without expectations.

If you rely on strictness modes, verify your mocks are wrapped appropriately to achieve your test intent.

### 2.4 Migrating Overloaded Methods and Qualified Methods

Ensure all overloads and const/ref-qualified methods are mocked explicitly using `MOCK_METHOD` with the necessary `(const)`, `(override)`, or `(ref(&))` qualifiers.

Use `using BaseClass::MethodName;` in mock classes to prevent hiding base overloads after introducing mocks for only some versions.

### 2.5 Transitioning Away from Variadic Functions to Overloads

GoogleMock does not support mocking variadic functions directly. If your code uses ellipsis (`...`), migrate to overloads with explicitly declared parameters, which can be mocked naturally.

### 2.6 Updating Default Actions and ON_CALL Usage

- Use `ON_CALL` to specify default behaviors without imposing call count expectations.
- Use `EXPECT_CALL` when you want to enforce call count or argument constraints.

Replace any use of `EXPECT_CALL` for merely setting default behaviors with `ON_CALL` to reduce brittleness and test flakiness.

---

## 3. Sample Migration: Fixing Modifier Order and Deprecated Syntax

### Before

```cpp
EXPECT_CALL(mockObj, Foo(_))
    .WillOnce(Return(42))
    .Times(2)
    .RetiresOnSaturation();

MOCK_CONST_METHOD1(Bar, void(int));
```

### After

```cpp
EXPECT_CALL(mockObj, Foo(_))
    .Times(2)
    .WillOnce(Return(42))
    .RetiresOnSaturation();

MOCK_METHOD(void, Bar, (int), (const));
```

**Outcome:** Compile-time enforcement avoids unexpected behaviors, and tests become more predictable.

---

## 4. Compatibility Strategies

- **Gradual Migration:** Introduce migration changes incrementally in branches or test refactoring cycles.
- **Automated Checks:** Use compiler warnings and static analysis to detect deprecated usage.
- **Test Coverage:** Ensure all mock usages are covered by tests that will catch broken behaviors.
- **Default Actions:** Employ `ON_CALL` for default behaviors to minimize maintenance during refactoring.

---

## 5. References to Edited Behaviors

Stay informed about GoogleMock behavioral changes in:

- [Breaking Changes](https://google.github.io/googletest/changelog/breaking-changes.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

These provide in-depth migration details and best practices.

---

## 6. Best Practices for Large Test Suites

- Avoid tight coupling between mocks and implementation details.
- Use `StrictMock` selectively to prevent brittle tests.
- Use sequences and `RetiresOnSaturation()` to control call order and lifecycle.
- Prefer interfaces and adapters over mocking concrete classes.
- Regularly update your mocks alongside production code to reduce technical debt.

---

## 7. Troubleshooting Common Migration Issues

- **Compilation Errors:** Usually due to out-of-order modifiers or old macros. Correct order and migrate macros.
- **Unexpected Call Failures:** Ensure all expected calls are declared and default actions are in place.
- **Warnings about Uninteresting Calls:** Consider wrapping the mock in `NiceMock` or declare permissive `EXPECT_CALL`s with `Times(AnyNumber())`.
- **Overload Ambiguities:** Fully mock all overloaded variants or use `using BaseClass::MethodName;`.

---

## 8. Additional Migration Tips

- Use the verbose flag `--gmock_verbose=info` during migration to trace mock calls.
- Check your CI pipelines to catch silent failures due to updated mock behaviors.
- Review the [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html) for known caveats.

---

## 9. Summary

Effective migration is critical for maintaining robust tests and taking full advantage of GoogleMock improvements. This guide delivers actionable steps, concrete examples, and references to ensure your mocking layer evolves safely and efficiently.


---

_This guide is an essential resource for maintainers managing large GoogleTest and GoogleMock codebases or integrating into CI systems._
