---
title: "Upgrade Instructions"
description: "Step-by-step upgrade guidance for moving between major versions, including any required source changes, configuration updates, or new build prerequisites (such as minimum C++ standards). Links to relevant files and config templates where adjustments are needed."
---

# Upgrade Instructions

Upgrade Instructions provide clear, step-by-step guidance for transitioning between major versions of GoogleTest and GoogleMock. This page focuses exclusively on upgrade-related changes, detailing any required changes users must make to their source code, configurations, and build environments to ensure smooth migration. It also highlights new prerequisites such as minimum C++ standards and points to relevant template files to aid configuration adjustments.

---

## 1. Introduction

Upgrading GoogleTest and GoogleMock between major versions can involve critical changes that impact your test code, build setup, and mocking patterns. This page guides you through these changes with concrete steps and examples to ensure your transition is seamless and your tests continue to provide reliable verification.

Upgrade instructions here concentrate on source-level adaptations, configuration updates, and build prerequisites mandated by newer versions.

---

## 2. Key Upgrade Considerations

### 2.1 Minimum C++ Standard Requirement

The latest GoogleTest and GoogleMock versions now require **minimum C++17 support**. Ensure your compiler and build environment are configured accordingly.

- Update your build system to specify the C++17 language standard explicitly.
- Verify compatibility of all dependent code and libraries with C++17.

### 2.2 Source Code and API Changes

Some key macros and methods have revised usage patterns and stricter syntax enforcement:

- `MOCK_METHOD` macro syntax is now more stringent. When mocking methods with argument types containing commas (e.g., `std::pair<bool,int>`), wrap those types in parentheses or use type aliases to avoid parsing errors. For example:

  ```cpp
  // Use parentheses to avoid parsing errors
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());

  // Or define a type alias
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
  ```

- The macro parameters and qualifiers must correctly mirror the overridden method's signature, including `const`, `override`, `noexcept`, reference qualifiers, and calling conventions if used.

- `EXPECT_CALL` and `ON_CALL` clauses must appear in the correct sequence. For example, `.With()` must be the first clause in the chain, and `.RetiresOnSaturation()` must be last.

### 2.3 Strict Enforcement on Expectation Clauses

The order and frequency of clauses in `EXPECT_CALL` have been strictly enforced:

- `.With()` can be used at most once and must appear before `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()`.
- `.Times()` can be specified once and must precede `.InSequence()` and `.After()`.
- `.WillOnce()` can be chained multiple times but must come before `.WillRepeatedly()`.
- `.WillRepeatedly()` can be used once at most and must come before `.RetiresOnSaturation()`.
- `.RetiresOnSaturation()` must be the last in the chain and used only once.

Incorrect clause orders will cause compilation or runtime failures.

### 2.4 Handling Move-Only Types

GoogleMock now supports mocking of methods with move-only types like `std::unique_ptr`. Use the modern `MOCK_METHOD` syntax to mock such methods directly. When specifying return actions for methods returning move-only types, use lambdas or functors rather than `Return()` with temporary objects to avoid runtime errors.

Example:

```cpp
MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));

EXPECT_CALL(mock_buzzer_, MakeBuzz("hello"))
  .WillOnce([](StringPiece) {
    return std::make_unique<Buzz>(AccessLevel::kInternal);
  });
```

If you still need legacy support, see the delegation pattern described in the [gMock Cookbook](docs/gmock_cook_book.md#MockingMethodsThatUseMove-OnlyTypes).

### 2.5 Build Configuration Updates

Your build scripts might require adjustment for updated installation layouts and requirements:

- Ensure C++17 standard enforcement (e.g., in CMake: `set(CMAKE_CXX_STANDARD 17)`).
- If using pkg-config, update to use `gmock.pc` and `gmock_main.pc` accordingly.
- Review any changes in linking flags or dependencies introduced by newer releases.

Template files for config and CMake can serve as references for updates.

---

## 3. Step-by-Step Upgrade Workflow

Follow these steps to upgrade your tests and build environment safely:

<Steps>
<Step title="Verify Environment Compatibility">
Confirm your compiler supports C++17 and update build files to require it explicitly.
</Step>

<Step title="Update MOCK_METHOD Macros">
Review your mock classes for `MOCK_METHOD` uses.
- Wrap argument types containing commas in parentheses or use type aliases.
- Confirm qualifiers (`const`, `override`, etc.) match the overridden method precisely.
</Step>

<Step title="Check EXPECT_CALL and ON_CALL Clause Order">
Ensure chained methods on expectations follow the prescribed order:
\.With() → .Times() → .InSequence()/.After() → .WillOnce() → .WillRepeatedly() → .RetiresOnSaturation()
Correct any misuse that might cause errors.
</Step>

<Step title="Adapt Move-Only Type Mocking">
If mocking methods with move-only arguments or return values:
- Use lambdas or callables for actions.
- Avoid returning temporary objects via `Return()`.
- Consider delegation patterns if necessary.
</Step>

<Step title="Update Build Configurations">
Adjust your build system to:
- Enforce C++17 standard.
- Update linking to use latest GoogleMock and dependencies.
- Incorporate any config template adjustments.
</Step>

<Step title="Test and Debug">
Run your tests with verbose logging enabled (`--gmock_verbose=info`) to observe mock call matching and diagnose any expectation mismatches.
</Step>
</Steps>

---

## 4. Practical Tips and Best Practices

- **Use `NiceMock` or `StrictMock` wisely:** Balance warnings and failures from uninteresting calls.
- **Leverage `ON_CALL` for default behaviors:** Use it in test fixtures or mock constructors for common default actions.
- **Use sequences and ordering when call order matters:** Use `InSequence` and `After` clauses to enforce strict or partial call ordering.
- **Prefer lambdas for complex actions:** This avoids common pitfalls with move-only types and side effects.
- **Wrap complex argument types with aliases:** Improves readability and prevents macro parsing errors.
- **Verify mocks early if needed:** Use `Mock::VerifyAndClearExpectations` to force verification before destruction if your mock lifetime is uncertain.

---

## 5. Troubleshooting Common Upgrade Issues

<AccordionGroup title="Common Issues & Solutions">
<Accordion title="Macro Parsing Errors with Commas in Types">
If your `MOCK_METHOD` calls fail to compile due to argument types containing commas, wrap those types with extra parentheses or define using type aliases before the mock declaration.
</Accordion>
<Accordion title="Unexpected Clause Order in EXPECT_CALL">
Compilation or runtime errors may occur if chained expectation clauses are ordered incorrectly. Review the order and correct it as per the prescribed sequence.
</Accordion>
<Accordion title="Uninteresting Call Warnings After Upgrade">
If warnings appear for calls not explicitly expected:
- Either use `NiceMock` to suppress warnings
- Or add catch-all expectations with `.Times(AnyNumber())` for those methods
- Avoid adding unused `EXPECT_CALL`s just to silence warnings.
</Accordion>
<Accordion title="Mocking Methods with Move-Only Arguments or Return Types">
Ensure you are using lambdas or appropriate callables as actions. Avoid repeating `Return(std::move(...))`. If needed, apply delegation techniques from the cookbook.
</Accordion>
<Accordion title="Build Failures Due to C++ Standard Mismatch">
Make sure your build system enforces the minimum C++17 standard and your compiler supports it. Consult the build system configuration templates.
</Accordion>
</AccordionGroup>

---

## 6. Upgrade Reference Files and Templates

For your convenience, refer to the following files for example configurations and build scripts reflecting the new minimum requirements and layouts:

- `googlemock/cmake/gmock.pc.in`
- `googlemock/cmake/gmock_main.pc.in`

Use these as a basis to update your pkg-config and CMake integration accordingly.

---

## 7. Related Documentation

- [Breaking Changes & Deprecations](/changelog/breaking-changes-upgrade/breaking-changes) — Details on all breaking API and behavioral changes.
- [Mocking Reference](docs/reference/mocking.md) — Detailed API reference for mocking.
- [gMock Cookbook](docs/gmock_cook_book.md) — Practical recipes on mocking, actions, and expectations.
- [gMock for Dummies](docs/gmock_for_dummies.md) — Beginner-friendly tutorial on mocking basics.
- [Getting Started with GoogleMock](getting_started/first_test_and_validation/using_googlemock_basics.md) — Guide to begin writing tests with mocks.
- [Common Installation Issues](getting_started/troubleshooting/common_install_issues.md) — Fixes for setup and upgrade-related build problems.

---

## 8. Conclusion

Upgrading GoogleTest and GoogleMock requires attention to new language standard requirements, changes in mocking macro syntax, strictness in expectation clauses, and updated build configurations. By following the structured workflow and consulting reference templates and docs, your upgrade will be smooth and maintain test accuracy.

If you encounter unexpected behaviors or build problems, revisit your mock declarations, expectations clause order, and build environment settings, and consult the troubleshooting section.

---

<Callout title="Helpful Command-Line Flag">
Run your tests with increased verbosity to gain insight into mock calls and expectation matching:

```sh
./your_test_binary --gmock_verbose=info
```

This outputs detailed information useful during upgrade troubleshooting.
</Callout>

---

_Last updated: June 2024_

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "docs/changelog/breaking-changes-upgrade/upgrade-instructions.md", "range": "1-100"}]} />