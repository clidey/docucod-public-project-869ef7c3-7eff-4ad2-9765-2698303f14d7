---
title: "Breaking Changes & Migration Notes"
description: "Summarizes any changes that may impact backward compatibility between major releases, with practical advice for migrating your tests and code. Includes migration checklists and highlighted differences for affected APIs and behaviors."
---

# Breaking Changes & Migration Notes

This chapter helps you navigate backward compatibility issues and guides you through migrating your tests and code when upgrading between major GoogleTest and GoogleMock releases. Understanding these breaking changes ensures your test suites remain functional and that your mocking practices stay current with evolving APIs.

---

## 1. Overview of Breaking Changes

Backward compatibility breaks occasionally occur to improve usability, fix design limitations, or enable new features. These changes may affect:

- Mocking macros (`MOCK_METHOD`, `EXPECT_CALL`, `ON_CALL`) usage and syntax.
- Behavior of mocking objects concerning call order, default actions, and expectation evaluation.
- Interface and qualifiers required in mock method declarations.

GoogleTest aims to minimize such breaks but prioritizes correctness and expressive power.

---

## 2. Key Breaking Changes Impacting Mocking API

### 2.1 Migration to the Unified `MOCK_METHOD` Macro

Older versions of gMock supported `MOCK_METHODn` family macros for mocking methods with a fixed number of arguments. These macros have been superseded by the generic `MOCK_METHOD` macro:

```cpp
MOCK_METHOD(return_type, method_name, (args...), (qualifiers));
```

**Why migrate?**

- The unified macro reduces complexity and improves compiler error messages.
- Supports move-only types seamlessly.
- Enables richer qualifier support.

**Migration tips:**

- Replace `MOCK_METHOD3(Foo, bool(int, int, int));` by `MOCK_METHOD(bool, Foo, (int, int, int));`
- Add qualifiers as the optional fourth parameter, e.g., `(const, override)`.
- Wrap argument and return types with commas (`,`) in parentheses if they contain commas themselves.

Example:

```cpp
class MockExample {
 public:
  MOCK_METHOD(void, Func, (std::pair<int, int> p), (override));
};
```

### 2.2 Improved Mock Method Qualifiers Support

The new `MOCK_METHOD` supports various qualifiers required for overriding methods properly:

- `const` — For const methods.
- `override` — Strongly recommended for overriding virtuals.
- `noexcept` — For noexcept methods.
- `Calltype(...)` — For specifying calling conventions (e.g. `STDMETHODCALLTYPE` on Windows).
- `ref(&)` / `ref(&&)` — For reference-qualified methods.

Ensure your mock methods specify the correct qualifiers to match the base class declarations exactly.

---

## 3. Expectation and Default Behavior Semantics Changes

### 3.1 Order of Expectations and Calls

Expectations (`EXPECT_CALL`) are now matched in reverse order (latest declared expectation takes precedence). This permits setting default behaviors earlier and overriding with more specific expectations later.

**Migration tips:**

- When expecting calls in a fixed order, use the `InSequence` construct to enforce call ordering explicitly.

Example:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Start()).Times(1);
  EXPECT_CALL(mock, Process()).Times(1);
}
```

### 3.2 Expectation Stickiness and `.RetiresOnSaturation()`

Expectations are "sticky" by default — they remain active even after their expected call count is reached, potentially causing failures for extra calls.

- Use `.RetiresOnSaturation()` to make expectations retire immediately after reaching the upper bound.

Example:

```cpp
EXPECT_CALL(mock, DoStuff())
    .Times(3)
    .RetiresOnSaturation();
```

### 3.3 Separation of Default Actions (`ON_CALL`) and Expectations (`EXPECT_CALL`)

- `ON_CALL` specifies default responses but does *not* set expectations.
- `EXPECT_CALL` both specifies behavior and expectations.

New versions enforce stricter separation and ordering of chaining clauses like `.With()`, `.Times()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()` — the sequence matters and must follow documented order.

Violations will trigger errors or warnings;
- `.With()` must appear first.
- `.Times()` must appear prior to `.InSequence()` or `.After()`.
- `.WillOnce()` and `.WillRepeatedly()` order is enforced.

---

## 4. Migration Checklist

Use this checklist to prepare your codebase for upgrading:

- [ ] Review all mock classes and update method declarations to using the new `MOCK_METHOD` macro syntax.
- [ ] Ensure all mock methods specify correct qualifiers matching the base or interface class.
- [ ] Audit all `EXPECT_CALL` and `ON_CALL` chaining clauses for correct clause order.
- [ ] Replace usage of older `MOCK_METHODn` macros with `MOCK_METHOD`.
- [ ] For call ordering dependencies, explicitly define `InSequence` or use `.After()` appropriately.
- [ ] Add `.RetiresOnSaturation()` to expectations that should retire immediately after their expected calls.
- [ ] Test with `--gmock_verbose=info` to observe mock call matching and diagnose expectation mismatches.

---

## 5. Common Pitfalls and Troubleshooting

### 5.1 Incorrect Mock Method Declarations

- Failing to match constness, noexcept, or reference qualifiers breaks overriding and may cause silent failures or compilation errors.
- Ensure every mocked method is declared in public scope.

### 5.2 Ordering Errors in Expectation Clauses

- Using `.With()` after `.Times()` or `.WillOnce()` will error.
- Calling `.Times()` multiple times on the same expectation causes failures.
- Violating the chaining order will lead to non-obvious runtime errors.

### 5.3 Unexpected Calls or Uninteresting Calls

- Missing or overly restrictive `EXPECT_CALL` may cause "unexpected" call failures.
- Uninteresting calls (calling mock methods without expectations) produce warnings by default (naggy behavior).
- Use the right strictness modifier: `NiceMock` suppresses warnings; `StrictMock` treats uninteresting calls as failures.

### 5.4 Mock Objects and Virtual Destructors

- Always verify base classes/interfaces have virtual destructors to avoid memory leaks or undefined behavior during mock destruction.

---

## 6. Example Migration

Original (old MOCK_METHODn style):

```cpp
class MockFoo : public IFoo {
 public:
  MOCK_METHOD2(Add, int(int, int));
  MOCK_CONST_METHOD0(GetValue, int());
};
```

New unified style:

```cpp
class MockFoo : public IFoo {
 public:
  MOCK_METHOD(int, Add, (int, int), (override));
  MOCK_METHOD(int, GetValue, (), (const, override));
};
```

Setting expectations with new clause order:

```cpp
EXPECT_CALL(mock_foo, Add(3, 4))
    .Times(1)
    .WillOnce(Return(7));

ON_CALL(mock_foo, GetValue())
    .WillByDefault(Return(42));
```

Enforcing call order explicitly:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock_foo, Add(_, _));
  EXPECT_CALL(mock_foo, GetValue());
}
```

---

## 7. Additional Resources

- [Mocking Reference](../reference/mocking.md) for detailed mock usage
- [gMock Cookbook](../gmock_cook_book.md) for recipes and advanced mocking scenarios
- [Breaking Changes & Migration Notes](../changelog/upgrades-and-migration/breaking-changes.md) for the latest upgrade information
- [Nice, Strict and Naggy Mocks](../gmock_cook_book.md#NiceStrictNaggy) for controlling mock strictness

---

For continued success, always pin to a released version, run your full test suite on upgrade, and consult this guide along with GoogleTest's official changelog pages when adopting new versions.


---

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "googlemock/test/gmock-spec-builders_test.cc", "range": "8-438"},{"path": "docs/reference/mocking.md", "range": "5-433"}]} />

