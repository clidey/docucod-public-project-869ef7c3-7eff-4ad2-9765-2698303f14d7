---
title: "Features & Improvements"
description: "Enumerates new features and notable behavioral enhancements, mapped to their primary header or source files. Highlights in which areas users can expect improved capabilities or better ergonomics."
---

# Features & Improvements

This page enumerates the new features and notable behavioral enhancements in GoogleMock's expectation and default action specification system, focusing on the core syntax macros `EXPECT_CALL` and `ON_CALL`. These changes reflect improved capabilities for users to define mock method behaviors, set flexible expectations, and gain better control and transparency in their tests.

---

## Overview of `EXPECT_CALL` and `ON_CALL`

GoogleMock provides two primary macros to manage mock method behaviors:

- `EXPECT_CALL`: Defines an expectation that a mock method will be called with certain arguments, specifying how many times, in what order, and what actions are performed.
- `ON_CALL`: Defines the default behavior of a mock method when no explicit expectation applies, without asserting an expected call.

This system allows users to express detailed interaction contracts and default behaviors for mock objects, enhancing test expressiveness and clarity.


## Key Improvements and Features

### Flexible and Expressive Syntax

- **Matchers Support:** Both `EXPECT_CALL` and `ON_CALL` accept argument matchers, enabling precise or wildcard matching for method arguments. You can specify exact values, wildcards (`_`), range conditions, composite matchers, or custom predicates.

- **Chained Clauses:** `EXPECT_CALL` supports chainable clauses in a well-defined order:
  - `.With(multi_argument_matcher)`: Further restricts matching based on combined argument tuples.
  - `.Times(cardinality)`: Specifies how many times the call should occur (e.g., `Exactly`, `AtLeast`, `AnyNumber`).
  - `.InSequence` and `.After`: Control order of calls among expectations.
  - `.WillOnce` and `.WillRepeatedly`: Define actual actions or return values per call.
  - `.RetiresOnSaturation`: Allows expectations to become inactive after saturation.

- **Default Action Specification:** `ON_CALL` lets you define default mock behaviors with a required `.WillByDefault` clause, enabling handling uninteresting calls gracefully.


### Intuitive Expectation Behaviors

- **Inference of Call Counts:** When you omit `.Times()`, GoogleMock infers the expected call count based on actions specified, reducing verbosity while preserving clarity.

- **Handling Different Call Scenarios:**
  - **Uninteresting Calls:** Calls without expectations generate warnings (naggy), but can be suppressed with `NiceMock` or treated as errors with `StrictMock`.
  - **Unexpected Calls:** Calls that don't match any active expectation fail clearly with informative messages.
  - **Excessive Calls:** Calls beyond expected counts also trigger errors, preventing silent failures.

- **Order Control:** Combine `InSequence` or `After` clauses to specify strict or partial call order dependencies, avoiding brittle tests while capturing interaction protocols.


### Advanced Features for Test Writers

- **Support for Overloaded and Template Methods:** The macros and matching mechanisms support defining expectations on all method variants, including overloads and template-instantiated methods, with helper macros and type-disambiguation techniques.

- **Delegation Patterns:** Facilitate delegating mock method calls to real or fake implementations for greater flexibility and realistic behavior.

- **Move-Only Types Support:** Support for mocking methods taking or returning move-only types (`std::unique_ptr`), enabling modern C++ idioms.

- **Custom Matchers and Actions:** Users can easily define domain-specific matchers and actions, and chain multiple actions using `DoAll`, simplifying complex test scenarios.

- **Better Error Reporting and Debugging:**
  - Enable `--gmock_verbose=info` to see full traces of expected and uninteresting calls with stack info.
  - Warning and error messages include detailed descriptions of the match failures, arguments, and call counts.

- **Thread Safety:** The mock specification system supports concurrent calls and expectations, with clear rules to avoid race conditions.


## Best Practices and Recommendations

- Use `ON_CALL` by default for defining behaviors without enforcing call expectations, reserving `EXPECT_CALL` for cases where verification of call presence or order is needed.

- For uninteresting calls that are valid and frequent, prefer wrapping mock objects with `NiceMock` to suppress noisy warnings.

- For strict verification, use `StrictMock` as it treats unexpected and uninteresting calls as failure conditions.

- Use `.RetiresOnSaturation()` to allow expectations to become inactive after their call count limit is reached, helpful to avoid upper-bound violations in loops or repetitive calls.

- When mocking complex or overloaded interfaces, fully specify the expected method to avoid ambiguity and compilation errors.

- Use sequences or `.After()` to express partial or total order among calls to improve robustness and detect ordering mistakes.

- For mock methods returning references, use `ReturnRef()` instead of `Return()` to correctly specify return behaviors.


## Example: Typical Usage Flow

```cpp
using ::testing::_;             // Wildcard matcher
using ::testing::Return;        // Action to return a value
using ::testing::InSequence;    // Sequence control

class MockFoo {
 public:
  MOCK_METHOD(int, Bar, (int x), (override));
};

TEST(FooTest, Basic) {
  MockFoo mock;

  {
    InSequence seq;  // Ensures calls occur in order.

    EXPECT_CALL(mock, Bar(5))
      .WillOnce(Return(10));
    EXPECT_CALL(mock, Bar(_))
      .WillRepeatedly(Return(0));
  }

  EXPECT_EQ(10, mock.Bar(5));
  EXPECT_EQ(0, mock.Bar(3));
  EXPECT_EQ(0, mock.Bar(3));
}
```


## Troubleshooting Tips

- If expectations are not met or matched as expected, rerun tests with `--gmock_verbose=info` to trace mock calls and see matching details.

- Ensure you set expectations before exercising the code under test because setting expectations afterward results in undefined behavior.

- Avoid over-specifying argument matchers which can cause brittle tests; prefer using wildcards (`_`) or partial matching as needed.

- Use `Mock::AllowLeak(obj)` cautiously if you deliberately want to skip verification of a mock object's expectations.


## Additional Resources

- [gMock Cheat Sheet](https://github.com/google/googletest/blob/main/docs/gmock_cheat_sheet.md) for quick syntax and usage patterns.
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) for in-depth API descriptions.
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) for recipes and advanced usage.
- [Using `NiceMock`, `NaggyMock`, and `StrictMock`](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#nice-strict-naggy) to handle uninteresting calls.

For a broader understanding of the mocking framework and test architecture, also consult the Core Concepts & Terminology and System Architecture Overview documentation.


---

This page fits into the Changelog documentation, focusing on detailed user-facing changes in mocking specifications and behaviors.

---

<Check>
Ensure expectations are set before code execution to avoid undefined behavior.
</Check>

<Note>
Uninteresting calls without expectations trigger warnings by default; use `NiceMock` or explicit expectations to manage noise.
</Note>

<Tip>
Use `.RetiresOnSaturation()` to retire expectations automatically after being fulfilled and prevent errors on repeated calls.
</Tip>

---
