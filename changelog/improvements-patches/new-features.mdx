---
title: "New Features"
description: "Showcases significant new testing capabilities, advanced assertion types, new command-line options, and other additions. Explains how these can benefit your workflow and provides quick usage examples."
---

# New Features

Explore the latest additions to GoogleTest’s mocking and testing capabilities, delivered to enhance test expressiveness, improve failure diagnostics, and streamline your test workflows. This page spotlights significant new testing capabilities, advanced assertion types, newly introduced command-line options, and other valuable enhancements. By diving into the examples and practical usage scenarios provided here, you'll understand how to leverage these new features to write more robust and maintainable tests.

---

## Enhanced Mocking Specifications

### Improved `ON_CALL` and `EXPECT_CALL` Syntax Enforcement

GoogleMock now strictly enforces the syntax rules for `ON_CALL` and `EXPECT_CALL` statements to ensure precise, unambiguous mock setup.

Key improvements:

- **`.With()` Clause** is optional but when used, can only appear once and must be the first clause following the call.
- **`.WillByDefault()`** is mandatory and must appear exactly once on `ON_CALL`.
- **`.Times()`**, **`.InSequence()`**, **`.WillOnce()`**, **`.WillRepeatedly()`**, and **`.RetiresOnSaturation()`** clauses in `EXPECT_CALL` have ordering requirements that prevent misuse and increase clarity.

<Tip>
If you misuse these clauses (e.g., placing `.With()` after `.Times()`), GoogleMock generates friendly runtime errors to guide corrections.
</Tip>

### Support for Incomplete Types in Mock Methods

You can now define mock methods taking arguments of incomplete types by providing a `PrintTo` function for those types. This enables cleaner modularization and separation of test code.

Example:

```cpp
class Incomplete;
class MockIncomplete {
 public:
  MOCK_METHOD(void, ByRefFunc, (const Incomplete& x));
};

void PrintTo(const Incomplete& x, std::ostream* os) {
  *os << "incomplete";
}
```

This allows expectations and actions on such mock methods without full type definitions upfront.

### Robust Handling of Overloaded and Const Methods

The `MOCK_METHOD` macro fully supports overloaded and `const` methods with no special workaround required. Use the qualifiers in the fourth parameter to indicate `const` or `override` seamlessly.

Example:

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (int times, int x), (override));
  MOCK_METHOD(int, GetBar, (), (const, override));
  MOCK_METHOD(const Bar&, GetBar, (), (const, override));
};
```

### Evaluation Guarantee for Arguments

`ON_CALL` and `EXPECT_CALL` evaluate both the mock object and method arguments exactly once, preventing side-effects from occurring multiple times unintentionally.

Example:

```cpp
int n = 0;
EXPECT_CALL(mock, DoSomething(n++));
// n will be incremented once only.
```

This ensures consistency and safer use of expressions with side-effects in expectations.

### Extended Support for Non-Default-Constructible Return Types

Mock methods returning non-default constructible types require explicit return values in expectations or default actions, ensuring you handle object lifecycles and avoid undefined behavior.

<Tip>
Always specify a return value in `.WillOnce()` or `.WillRepeatedly()` for methods returning non-default-constructible objects.
</Tip>

### Uninteresting and Unexpected Call Diagnostics

GoogleMock improvements include:

- Clear, detailed warnings on uninteresting calls (calls to methods with no matching `EXPECT_CALL`).
- Distinct, helpful messages on unexpected calls violating set expectations.
- Nature of failures include argument mismatches, retired expectations, and call count violations with explicit call information.

You can control verbosity via the new `--gmock_verbose` flag.

---

## Advanced Assertion and Diagnostics Features

### New `--gmock_verbose` Flag for Runtime Output Control

Control the level of GoogleMock diagnostic output using:

```
--gmock_verbose=LEVEL
```

Where `LEVEL` can be:

- `info`: Enables verbose logs including every expected and uninteresting call, stack traces included.
- `warning`: Shows warnings and errors but hides stack traces for uninteresting calls. (This is the default.)
- `error`: Displays only failures and suppresses all warnings and information logs.

Example Usage:

```bash
your_test_binary --gmock_verbose=info
```

This helps when debugging complex mocks or when you need a quieter output.

### Informative Stack Traces on Mock Calls

When verbosity is set to `info`, GoogleMock includes stack traces in its output for both expected and uninteresting calls, helping you trace where method calls and expectations originate.

<Tip>
You can combine `--gmock_verbose=info` with `--gtest_stack_trace_depth=0` to get detailed mock call logs without the clutter of stack traces.
</Tip>

### Improved Warnings with Argument and Return Value Printing

Warnings for uninteresting calls now print detailed function arguments and return values, significantly aiding diagnosis.

Example snippet from output:

```
GMOCK WARNING:
Uninteresting mock function call - returning default value.
    Function call: DoB(1)
          Returns: 0
```

For void functions, arguments are printed but no return value appears since there is none.

### Dynamic Default Actions with ON_CALL

Default actions configured with `ON_CALL` can be specific to parameter matchers, allowing your mock's default behavior to respond dynamically to calls without explicit expectations.

Example:

```cpp
ON_CALL(mock, Compute(_))
    .WillByDefault(Return(42));
```

Multiple `ON_CALL` statements are evaluated in precedence order, enabling flexible default behaviors.

### Sticky and Retiring Expectations

By default, expectations remain active even after saturation. The `.RetiresOnSaturation()` clause lets you retire expectations immediately once the upper call bound is reached, allowing fallback to other expectations.

Example:

```cpp
EXPECT_CALL(mock, Foo(7))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, Foo(_))
    .Times(AnyNumber());
```

This makes tests easier to write when dealing with conditional expected calls.

---

## New Mock Control and Verification Utilities

### `Mock::AllowLeak()`

You can now explicitly mark a mock object as allowed to leak. This is useful when a mock is deliberately kept alive outside test scope without deletion, avoiding false leak detection failures.

Usage:

```cpp
Mock::AllowLeak(&my_mock);
```

### `Mock::VerifyAndClearExpectations()` and `Mock::VerifyAndClear()`

These static functions let you verify that all expectations on a mock are met and clear them explicitly before mock object destruction.

- `VerifyAndClearExpectations()` verifies and clears only expectations.
- `VerifyAndClear()` verifies and clears both expectations and default actions.

These enable safe manual lifecycle management of mocks, especially beneficial for heap-allocated mocks.

### Support for Verifying Const Mock Objects

`VerifyAndClear()` and `VerifyAndClearExpectations()` fully support const-qualified mocks, enabling safe usage in various test contexts.

### Safe Multiple Calls to Verify Functions

You can call `VerifyAndClear()` or `VerifyAndClearExpectations()` multiple times on the same mock safely.

### Deadlock Avoidance

Internal GoogleMock state management prevents deadlocks when chained mocks hold references to each other and are destroyed.

<Tip>
Avoid setting expectations after clearing verifications or after the mock has been used for testing; this leads to undefined behavior.
</Tip>

---

## Practical Examples

### Setting Default Behavior for All Calls to a Mock Function

```cpp
ON_CALL(mock_object, Method(_))
    .WillByDefault(Return(default_value));
```

This setup ensures any call to `Method` not covered by explicit expectations uses the specified default.

### Defining Multiple `EXPECT_CALL`s with Ordered Actions

```cpp
EXPECT_CALL(mock_object, Method())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

First and second calls return 1 and 2 respectively; all subsequent calls return 3.

### Using `ExpectCall` with `.After()` for Partial Ordering

```cpp
Expectation e1 = EXPECT_CALL(mock, Func1());
EXPECT_CALL(mock, Func2()).After(e1);
```

Enforces that `Func1` must be called before `Func2`.

### Controlling Verbose Mock Output from a Test

```cpp
GMOCK_FLAG_SET(verbose, "info");
EXPECT_CALL(mock, SomeMethod());
mock.SomeMethod();
```

Enables detailed logs about mock events to aid in diagnosis.

---

## Troubleshooting

### Common Issues

- Incorrect clause ordering in `EXPECT_CALL` or `ON_CALL` triggers runtime errors.
- Forgetting `.WillByDefault()` in `ON_CALL` results in failures when mock methods are called.
- Over-specifying expectations without `.RetiresOnSaturation()` may cause upper bound violations.
- Using non-virtual destructors can cause leaks and prevent mock verification on destruction.

### Tips

- Use `NiceMock` or `StrictMock` wrappers to control warning behavior on uninteresting calls.
- Employ the `--gmock_verbose` flag to adjust diagnostic verbosity during test runs.
- Leverage `VerifyAndClear` functions to explicitly verify expectations in tests with complex mock lifecycles.

---

## Summary

This page covered important new features in GoogleTest’s mocking and assertion framework that improve test robustness, diagnostics, and usability. The enhanced syntax rules for mock clauses, comprehensive call diagnostics, advanced verification utilities, and dynamic control over verbosity collectively support user workflows in crafting precise and maintainable tests.

For next steps, consult related pages such as:

- [Mocking Reference](/docs/reference/mocking.md)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Effective Assertions Guide](/guides/testing-patterns/effective-assertions.md)
- [Breaking Changes and Migrations](/changelog/breaking-changes-migrations/breaking-changes)

Explore these resources to deepen your mastery of the new capabilities and integrate them effectively into your projects.
