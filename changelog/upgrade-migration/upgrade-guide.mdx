---
title: "Upgrade Guide"
description: "Step-by-step instructions for upgrading from previous major releases, including common pitfalls, code samples, and best practices to ensure a smooth transition with minimal regression risk."
---

# Upgrade Guide

The Upgrade Guide provides detailed, step-by-step instructions to help you transition from previous major releases of GoogleMock. Whether you are upgrading your mock classes, refactoring expectations, or adopting new features, this guide ensures a smooth upgrade experience with minimal risk of regression.

---

## 1. Preparing for the Upgrade

Before starting your upgrade, it's vital to understand the key changes introduced in the new major release and how they impact your existing mock code:

- **Review Deprecations and Breaking Changes:** Consult the [Breaking Changes & Deprecations](./breaking-changes) page to identify any removed or modified APIs.
- **Ensure Supported Compiler and Platform Compatibility:** Verify that your environment meets the requirements outlined in [Prerequisites & Supported Platforms](../../getting-started/setup-prerequisites-installation/prerequisites-supported-platforms).
- **Backup Your Current Mocks:** Safeguard your existing mock classes and test code to enable rollback if necessary.

---

## 2. Upgrading Your Mock Classes

### 2.1 Transitioning to the New `MOCK_METHOD` Macro Syntax

GoogleMock consolidates older `MOCK_METHODn` macros into a generic `MOCK_METHOD` macro with improved expressiveness and support. When upgrading:

- Replace all usages of `MOCK_METHODn` and related macros with the new `MOCK_METHOD` macro syntax, which takes the return type, method name, argument list, and optional specifiers separately.
- Wrap argument or return types containing commas in parentheses or use type aliases to avoid parsing issues.

**Example transformation:**

```cpp
// Old style
MOCK_METHOD1(Foo, bool(int));

// New style
MOCK_METHOD(bool, Foo, (int), ());
```

For complex signatures:

```cpp
// Using parentheses to protect commas
MOCK_METHOD((std::pair<bool, int>), GetPair, ());

// Or use type aliasing
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD(BoolAndInt, GetPair, ());
```

### 2.2 Adding Qualifier Support

If your mocked method overrides a const, noexcept, or ref-qualified function, add these qualifiers explicitly in the fourth parameter:

```cpp
MOCK_METHOD(int, GetValue, (), (const, override));
MOCK_METHOD(void, Process, (), (noexcept, override));
MOCK_METHOD(void, RefMethod, (), (ref(&), override));
```

### 2.3 Mocking Overloaded Methods

Disambiguate overloaded methods appropriately by specifying the correct qualifiers and argument types. Use `Const()` wrapper to refer to const overloads and carefully mock each variant.

### 2.4 Mock Class Constructors Compatibility

The new `NiceMock`, `NaggyMock`, and `StrictMock` wrappers preserve the constructors of your mock classes, so passing constructor arguments remains supported.

---

## 3. Updating Expectations and Default Behaviors

### 3.1 Leveraging `ON_CALL` vs. `EXPECT_CALL`

- Use `ON_CALL` to specify default mock behaviors without enforcing call count constraints.
- Use `EXPECT_CALL` to set explicit call expectations, including call order, arguments, and repetition.

**Best Practice:** Favor `ON_CALL` for shared default behavior and minimize `EXPECT_CALL` usage to the specific calls you want to verify.

### 3.2 Managing Call Counts

Use the `.Times()` clause effectively with cardinalities such as `Exactly(n)`, `AtLeast(n)`, and `AnyNumber()` to express call expectations clearly.

If you omit `.Times()`, gMock infers call counts based on the presence of `WillOnce` and/or `WillRepeatedly` clauses.

### 3.3 Using `.RetiresOnSaturation()` for Sticky Expectations

To prevent expectations from remaining active after saturation (which can cause unexpected test failures), use `.RetiresOnSaturation()` on expectations you want to retire immediately upon full usage.

### 3.4 Setting Ordered Expectations

Use `InSequence` objects or the `.InSequence()` clause to enforce call ordering and partial orders, enabling precise control over invocation sequences.

### 3.5 Updating Matchers and Actions

Update your expectations to use the latest matchers and action syntaxes. If you were using custom or legacy matchers, verify their compatibility with the latest GoogleMock APIs.

---

## 4. Adjusting Mock Strictness Behavior

GoogleMock introduces three strictness wrappers for mocks:

- **`NiceMock<T>`**: Suppresses warnings on uninteresting calls.
- **`NaggyMock<T>`**: (Current default) Emits warnings on uninteresting calls.
- **`StrictMock<T>`**: Treats uninteresting calls as test failures.

When upgrading, consider adopting `NiceMock` to reduce noise in test outputs, or `StrictMock` to enforce stricter validations depending on your test requirements.

**Example Usage:**

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock_foo;       // Suppresses unnecessary warnings.
StrictMock<MockFoo> strict_mock_foo;   // Treats all unexpected calls as errors.
```

Note:
- These wrappers only affect uninteresting calls (calls to methods without expectations).
- They work properly only when the mock methods are defined directly in the mock class using `MOCK_METHOD`.
- Ensure your mock class destructors are virtual for reliable behavior.

---

## 5. Refactoring Your Tests

### 5.1 Confirm Expectation Placement and Order

All expectations must be set before the mocked methods are invoked. Avoid interleaving `EXPECT_CALL` declarations with test logic that triggers mock usage.

### 5.2 Verify and Clear Mocks Explicitly

Consider using `Mock::VerifyAndClear()` to verify and reset mock expectations where needed, especially when reusing mocks within the same test or across multiple phases.

### 5.3 Handle Move-Only Types Correctly

With improved support for move-only types, update your mocks that accept or return such types (e.g., `std::unique_ptr`) to the new `MOCK_METHOD` syntax and prefer lambdas or actions over `Return(std::move(...))` for repeated returns.

### 5.4 Simplify Complex Argument Matching

Where applicable, use composite matchers, `With()` clause, or parameter matching helpers (`Args`, `AllArgs`) to validate multi-argument constraints neatly.

### 5.5 Use `ON_CALL` for Default Behavior

Leverage `ON_CALL` wisely to establish default mock behaviors, and reserve `EXPECT_CALL` for specific verification points.

---

## 6. Common Pitfalls and Troubleshooting

### 6.1 Parsing Errors Due to Commas in Types

If `MOCK_METHOD` fails to compile due to unprotected commas in argument or return types, wrap them in parentheses or use type aliases.

### 6.2 Mistaken Call Counts Because of Sticky Expectations

Remember that default expectations remain active after saturation, possibly causing upper-bound call failures; use `.RetiresOnSaturation()` to avoid this.

### 6.3 Unexpected Warnings for Uninteresting Calls

Switch to `NiceMock` to suppress warnings on uninteresting calls if they clutter test output without aiding debugging.

### 6.4 Overuse of `EXPECT_CALL`

Avoid setting expectations on methods you're not interested in. Over-specifying via numerous `EXPECT_CALL`s leads to brittle tests.

### 6.5 Strictness Wrappers Limitations

Applying `NiceMock` or `StrictMock` to mocks whose methods are defined in base classes may not behave as expected.

### 6.6 Verify Consistent `virtual` Destructors

Ensure all mocked interfaces and classes have virtual destructors to prevent memory leaks and undefined behavior.

---

## 7. Example: Upgrading a Mock Class

Suppose you have an old mock class:

```cpp
class MockWidget : public Widget {
 public:
  MOCK_METHOD1(DoStuff, bool(int));
  MOCK_CONST_METHOD0(GetName, std::string());
};
```

Upgrade it by:

1. Switching to new `MOCK_METHOD`:

```cpp
class MockWidget : public Widget {
 public:
  MOCK_METHOD(bool, DoStuff, (int), (override));
  MOCK_METHOD(std::string, GetName, (), (const, override));
};
```

2. Utilizing `NiceMock` to suppress uninteresting call warnings:

```cpp
using ::testing::NiceMock;
NiceMock<MockWidget> mock_widget;
```

3. Setting expectations and default behaviors appropriately with `EXPECT_CALL` and `ON_CALL`.

---

## 8. Additional Resources

- [Mock Method Definition (`MOCK_METHOD`)](../../api-reference/core-mocking-api/mock-method-definition)
- [Setting Expectations and Actions](../../api-reference/core-mocking-api/setting-expectations-actions)
- [NiceMock, NaggyMock, StrictMock Controls](../../api-reference/mock-behavior-extensions/nice-naggy-strict-mocks)
- [gMock for Dummies](../../docs/gmock_for_dummies.md)
- [gMock Cookbook](../../docs/gmock_cook_book.md)
- [Breaking Changes & Deprecations](./breaking-changes)

Use these resources alongside this guide to ensure a successful upgrade.

---

By following this Upgrade Guide, your tests will benefit from the latest GoogleMock enhancements, improved code readability, better test maintainability, and more robust mock behavior controls. Upgrade confidently and enjoy the improved mocking experience!