---
title: "Upgrade & Migration Guide"
description: "Step-by-step instructions to help users upgrade to the latest version, including code migration tips, environment changes (such as C++17 requirements), and integration notesâ€”ensuring a smooth transition."
---

# Upgrade & Migration Guide

This guide provides step-by-step instructions to help users smoothly upgrade to the latest version of GoogleMock and GoogleTest. It includes detailed code migration tips, environment changes (such as the new C++17 requirement), and important integration notes, ensuring your existing tests and mocks continue working correctly with modern features.

---

## 1. Preparing Your Environment

Before upgrading, confirm your development environment meets the updated requirements:

- **C++17 Standard**: The latest GoogleTest and GoogleMock versions require compiling with C++17 or later. Ensure your compiler supports C++17 (e.g., GCC 7+, Clang 5+, MSVC 2017+).
- **Compiler Compatibility**: Verify that your build environment supports required flags and standards to avoid build errors during migration.

Refer to the [System Requirements](../getting_started/requirements_installation/system_requirements) page for full platform and toolchain compatibility details.

<Tip>
Upgrading your compiler and build tools to support C++17 is essential for leveraging new gMock features and improved mock method handling.
</Tip>

---

## 2. Migrating Mock Classes: Transition from Legacy Macros to `MOCK_METHOD`

### What Has Changed?

The traditional `MOCK_METHODn` macros are deprecated in favor of the unified, more powerful `MOCK_METHOD` macro:

```cpp
// Legacy format
MOCK_METHOD1(Foo, bool(int arg));

// New recommended format
MOCK_METHOD(bool, Foo, (int arg));
```

### Migration Steps

1. **Replace all `MOCK_METHODn` and `MOCK_CONST_METHODn` macros with `MOCK_METHOD`.**

2. **Adapt to the new parameter format:**
   - The new macro takes the return type first, then the method name, then argument types in parentheses.
   - Use a fourth parameter for qualifiers like `(const, override)` if needed.

3. **Example migration:**

Before:

```cpp
class MockFoo {
 public:
   MOCK_METHOD1(Foo, bool(int arg));
   MOCK_CONST_METHOD0(Bar, int());
};
```

After:

```cpp
class MockFoo {
 public:
   MOCK_METHOD(bool, Foo, (int arg), (override));
   MOCK_METHOD(int, Bar, (), (const, override));
};
```

4. **Handling commas in types:** If argument or return types include commas (e.g., template types), wrap them in parentheses or use `using` aliases to avoid parsing issues.

### Benefits of the New Macro

- Improved support for mock methods with complex signatures, including move-only types.
- Simplified syntax and consistent usage.
- Better integration with strictness modifiers and default actions.

<Note>
Legacy `MOCK_METHODn` macros remain supported temporarily but will be removed in future releases. Begin migration early to avoid last-minute refactoring.
</Note>

---

## 3. Using Strictness Wrappers: `NiceMock`, `NaggyMock`, and `StrictMock`

GoogleMock introduces strictness wrappers to control the behavior of uninteresting calls:

- `NiceMock<T>`: suppresses warnings for uninteresting calls.
- `NaggyMock<T>`: (default) warns on uninteresting calls.
- `StrictMock<T>`: treats uninteresting calls as errors.

### How to Apply

Instead of using `MockFoo` directly, wrap it as:

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock;
StrictMock<MockFoo> strict_mock;
```

These wrappers inherit all constructors of `MockFoo`, so you can pass constructor arguments transparently.

### Important Considerations

- Strictness wrappers only affect methods defined with `MOCK_METHOD` directly in the mock class.
- Nesting wrappers is not supported.
- The mock class must have a virtual destructor for correct behavior.

For details, see the [Strictness and Behavior Concept](../concepts/mocking-strategies-extensibility/strictness-and-behavior).

---

## 4. Expectation Syntax and Semantics Updates

### Evaluation of Expressions

- Both `EXPECT_CALL` and `ON_CALL` evaluate their matcher arguments exactly once to avoid side effects.

### Ordering of Clauses

- Clauses such as `.With()` must be the first in the chain.
- `.Times()` can appear at most once and must come before `.InSequence()`, `.WillOnce()`, `.WillRepeatedly()`, or `.RetiresOnSaturation()`.
- Calling `.Times()` multiple times results in a runtime failure.

### Expectation Lifecycle and Retiring

- Expectations remain "sticky" after saturation unless specified otherwise via `.RetiresOnSaturation()`.
- Partial orders can be specified with `.InSequence()` and `.After()`, including DAGs.

### Actions

- `WillOnce()` and `WillRepeatedly()` clauses control mock method behavior.
- `WillByDefault()` is required for `ON_CALL` statements.

### Default Cardinalities

- If no `.Times()` is specified, cardinalities infer based on the presence of `WillOnce()` and `WillRepeatedly()`:
  - No actions: `Times(1)`
  - `n` `WillOnce()` only: `Times(n)`
  - `n` `WillOnce()` plus one `WillRepeatedly()`: `Times(AtLeast(n))`

### Warning and Error Behavior

- GoogleMock warns about mismatched count of `WillOnce()` actions and expected call cardinalities.
- Excess actions or too few actions compared to expectations print warnings or errors.
- The verbosity of warnings can be controlled by `--gmock_verbose` flag.

<Check>
Use `--gmock_verbose=info` to get detailed traces of call matching and diagnostic messages.
</Check>

---

## 5. Handling Move-Only Types

- Native support for mocking methods with move-only arguments and return types is now fully integrated.
- Use lambdas or callable objects with `WillOnce()` or `WillRepeatedly()` to generate fresh move-only instances each time.

Example:

```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
       return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

- The old workaround of delegating move-only calls to a non-move-only mock method is deprecated but still valid for older code.

---

## 6. New Features in Spec Builder Syntax

- The `.With()` clause allows matching all arguments as a tuple, providing expressive multi-argument matching.
- More robust support for sequences, expectations, cardinalities, and call orders.
- Enhanced diagnostics help identify unsatisfied prerequisites and argument mismatches.

Example of `.With()` usage:

```cpp
EXPECT_CALL(mock, SomeMethod(_, _))
    .With(Lt())  // First argument less than second.
    .Times(1);
```

---

## 7. Integration Notes and Tips

- When upgrading, ensure your build system configures C++17 compilation.
- Update any mock classes to use the new `MOCK_METHOD` macro for compatibility and maintainability.
- Consider wrapping mocks with `NiceMock` or `StrictMock` to control uninteresting call behaviors explicitly.
- Check test logs carefully for warnings or errors about action count mismatches.
- Use the `Mock::VerifyAndClearExpectations()` API to force verification before mock destruction if lifecycle is uncertain.
- For advanced usage patterns, see related guides on [Advanced Mocking Patterns](../guides/writing-and-structuring-tests/advanced-mocking-patterns) and [Expectation Ordering](../concepts/architecture-core-models/mocking-architecture).

---

## 8. Troubleshooting Common Upgrade Issues

### Build Failures

- Ensure all mock headers use `MOCK_METHOD` syntax.
- Confirm your compiler and standard library support C++17 fully.

### Unexpected Mock Behavior or Test Failures

- Check for unintentional mixing of legacy and new macros.
- Use `--gmock_verbose=info` to debug call matching and expectation resolution.
- Verify the strictness mode of your mocks if warnings/errors about uninteresting calls appear.

### Deprecated Macros and Functions

- Avoid `MOCK_METHODn` macros and migrate to `MOCK_METHOD`.
- Replace old-style mocking APIs and idioms as shown in migration examples.

<Tip>
If you encounter issues during upgrade, consult the [Legacy gMock FAQ](../docs/gmock_faq.md) and [Mocking Reference](../docs/reference/mocking.md) for detailed explanations.
</Tip>

---

## 9. Additional References

- [Migration from MOCK_METHODn to MOCK_METHOD](../changelog/upgrade-migration/breaking-changes)
- [Strict, Naggy, and Nice Mocks](../concepts/mocking-strategies-extensibility/strictness-and-behavior)
- [Using gMock Expectations and Sequences](../api-reference/mocking-actions-matchers/expectations-and-sequences)
- [Handling Move-Only Types in Mock Methods](../guides/writing-and-structuring-tests/advanced-mocking-patterns#mocking-move-only-types)
- [gMock Cookbook - Migration Recipes](../docs/gmock_cook_book.md#Old-Style-`MOCK_METHODn`-Macros)

---

By following this guide, users will ensure their test suites take full advantage of the latest GoogleMock improvements, maintain stability, and benefit from modern, expressive mocking capabilities.


---

## Example Migration Snippet

Before:
```cpp
class MockFoo {
 public:
  MOCK_METHOD1(FooMethod, int(int));
  MOCK_CONST_METHOD0(ConstMethod, void());
};
```

After:
```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, FooMethod, (int), (override));
  MOCK_METHOD(void, ConstMethod, (), (const, override));
};
```

Use `NiceMock<MockFoo>` if you want to suppress warnings for uninteresting calls:

```cpp
NiceMock<MockFoo> mock_foo;
```

---

## Correct Usage of Strictness Wrappers

```cpp
using ::testing::StrictMock;

StrictMock<MockFoo> strict_mock;
EXPECT_CALL(strict_mock, FooMethod(5))
    .Times(1)
    .WillOnce(Return(10));

// Calls to methods without expectations will cause test failures.
```

---

## Controlling Verbosity for Diagnostics

Use the command-line flag:

```bash
--gmock_verbose=info
```

for detailed call logs, or

```bash
--gmock_verbose=error
```

for minimal output.

---

## Useful Commands During Upgrade

- `Mock::AllowLeak(&mock_obj)` - Suppress leaked mock errors for a particular mock.
- `Mock::VerifyAndClearExpectations(&mock_obj)` - Verify expectations before destruction.

---

For more detailed migration instructions, visit the [Breaking Changes](../changelog/upgrade-migration/breaking-changes) and [Deprecations & Removals](../changelog/upgrade-migration/deprecation-notices) pages.



---

<Source url="https://github.com/google/googletest" branch="main" paths='[{"path": "docs/gmock_cook_book.md", "range": "1-600"},{"path": "docs/reference/mocking.md", "range": "1-1100"},{"path": "googlemock/include/gmock/gmock-nice-strict.h", "range": "1-230"}]'/>