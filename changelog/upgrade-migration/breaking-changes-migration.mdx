---
title: "Breaking Changes & Migration Guide"
description: "Details about breaking API or behavioral changes in recent versions, with clear migration instructions and code samples to help users update tests with confidence."
---

# Breaking Changes & Migration Guide

Understand the critical API or behavior changes introduced in recent releases of GoogleMock, with clear, actionable migration instructions designed to help you update your tests confidently and efficiently. This guide is your reliable companion for navigating breaking changes, minimizing disruptions, and ensuring your test suite keeps pace with evolving GoogleMock capabilities.

---

## Understanding Breaking Changes in GoogleMock

Breaking changes are updates that alter the behavior or interfaces in ways that may require you to change your existing test code. In GoogleMock, these generally involve:

- Adjustments to mocking macros and method definitions.
- Changes in function mocking semantics or expectation syntax.
- Behavioral shifts in how expectations, actions, or sequences are handled.
- Modifications to flag usage or default mock object behavior.

Anticipating these changes and adapting your tests appropriately preserves test validity and harnesses new features effectively.

---

## Common Breaking Change Patterns and Migration Strategies

### 1. Changes to `MOCK_METHOD` Macro

**Impact:** If GoogleMock modifies `MOCK_METHOD` usage or semantics, prior mock classes might not compile or behave as intended.

**Migration Steps:**

- Review your mock class definitions.
- Ensure method signatures align with the updated `MOCK_METHOD` syntax, including qualifiers like `(const)`, `(override)`, and `Calltype()`.
- For argument types with commas in templates (e.g., `std::pair` or `std::map`), make sure to wrap them in extra parentheses or use type aliases as per the new guidance.

**Example:**
```cpp
// Old problematic syntax:
MOCK_METHOD(std::pair<bool, int>, GetPair, ()); // Won't compile

// Updated working version:
MOCK_METHOD((std::pair<bool, int>), GetPair, ());
// or
using BoolInt = std::pair<bool, int>;
MOCK_METHOD(BoolInt, GetPair, ());
```

---

### 2. `EXPECT_CALL` and `ON_CALL` Clause Changes

**Impact:** Alterations in clause ordering, allowed usages of `.With()`, `.Times()`, `.InSequence()`, and `.After()` may invalidate old expectations.

**Key Rules to Observe:**

- `.With()` must be the first modifier clause and can appear at most once.
- `.Times()` can appear at most once and must precede `.InSequence()` or `.After()`.
- `.InSequence()` may be used any number of times but must appear before `.WillOnce()` or `.WillRepeatedly()`.
- `.After()` must appear before `.WillOnce()` clauses.
- `.WillRepeatedly()` can appear at most once and must be the last action clause before `.RetiresOnSaturation()`.
- `.RetiresOnSaturation()` can only appear once and must come last.

**Migration Guidance:**

- Reorder clauses if you see compile errors or warnings.
- Avoid multiple `.With()` or `.Times()` clauses.
- Use sequences and `.After()` explicitly when ordering matters.

**Example:**
```cpp
EXPECT_CALL(mock, Func(_))
  .With(...)          // must come first
  .Times(1)           // exactly once
  .InSequence(seq)    // can appear multiple
  .After(prereq)      // appears before will clauses
  .WillOnce(Return(42))
  .WillRepeatedly(Return(0))
  .RetiresOnSaturation();
```

---

### 3. Mock Object Strictness Wrappers

**Impact:** Changes to `NiceMock`, `NaggyMock`, and `StrictMock` behaviors may affect warnings and test failures related to uninteresting or unexpected calls.

**Migration Tips:**

- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Use `StrictMock<T>` to treat uninteresting calls as failures.
- Recognize that these wrappers only affect methods defined directly in the mock class.

---

### 4. Default Actions and Verbosity Flag Changes

**Impact:** Changes in default action semantics and verbosity levels affect how default-return values and messages appear.

**Migration Advice:**

- Review usages of `ON_CALL` for setting default behaviors.
- Adjust `--gmock_verbose` flag or `GMOCK_FLAG_SET(verbose, value);` calls to desired verbosity levels: `info`, `warning`, or `error`.
- Understand that unexpected and uninteresting calls' reporting depends on this setting.

---

## Detailed Migration Examples

### Adapting to New `InitGoogleMock` Behavior

Recent versions refine command-line flag parsing. To ensure your tests initialize GoogleMock correctly:

```cpp
int main(int argc, char** argv) {
  ::testing::InitGoogleMock(&argc, argv);
  // ...
  return RUN_ALL_TESTS();
}
```

Avoid manually handling Google's internal flags; rely on `InitGoogleMock` to parse and remove recognized flags.

---

### Handling Expectation Clause Reordering

Buggy usage like:
```cpp
EXPECT_CALL(mock, Func(_))
  .WillOnce(Return(1))
  .Times(1);  // Invalid order
```

Must be updated to:
```cpp
EXPECT_CALL(mock, Func(_))
  .Times(1)
  .WillOnce(Return(1));
```

---

### Dealing with Sticky Expectations

If tests fail with repeated calls exceeding expectations, apply `.RetiresOnSaturation()` to prevent expectations from remaining active after their cardinality is met:

```cpp
EXPECT_CALL(mock, Get())
    .WillOnce(Return(10))
    .RetiresOnSaturation();
EXPECT_CALL(mock, Get())
    .WillOnce(Return(20))
    .RetiresOnSaturation();
```

Or express the calls in sequence with the `InSequence` helper.

---

### Example of Delegating Calls with `ON_CALL`

To help tests migrate gracefully, use `ON_CALL` to specify fallback or default behaviors while retaining existing expectations:

```cpp
ON_CALL(mock, Compute(_))
    .WillByDefault([](int x) { return x * 2; });
```

This reduces the need to repeatedly update all tests for routine default call behaviors.

---

## Troubleshooting Common Migration Issues

### Compilation Errors Around `MOCK_METHOD`

- Ensure template types with commas are wrapped properly.
- Check that all method qualifiers are correct.

### Unexpected Match Failures

- Validate all expectations have matching arguments.
- Use `--gmock_verbose=info` to trace matching decisions during test runs.

### Warning or Failure on Uninteresting Calls

- Use `NiceMock` to suppress warnings for intentional uninteresting calls.
- Add `EXPECT_CALL(...).Times(AnyNumber())` for methods where calls are allowed without verification.

### Assertion Failures Linked to Sequences or Prerequisites

- Review usage of `.InSequence()` and `.After()` clauses.
- Confirm call order adheres to expectations.

---

## Summary

This guide has equipped you with:

- Key changes to mocking macros and clauses with migration advice.
- Strategies to handle expectation lifecycle changes and strictness wrappers.
- Practical examples illustrating necessary code adjustments.
- Tips for leveraging verbosity flags and default actions to tune output and behavior.
- Troubleshooting guidance to resolve common upgrade hitches.

By following these instructions and best practices, you will maintain robust, reliable, and maintainable tests through GoogleMock upgrades.

---

## Additional Resources

- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — for detailed use of `EXPECT_CALL`, `ON_CALL`, and matchers
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — practical recipes and examples
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) — quick reference for mocking constructs
- [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html) — common questions on migration and errors
- [GoogleMock Initialization Tests](https://github.com/google/googletest/blob/main/googlemock/test/gmock_test.cc) — real tests verifying flag parsing and setup

---

For context, see also related documentation on:

- Nice, Naggy, and Strict Mocks — control of uninteresting call warnings
- Expectation Ordering — managing call sequences
- Using Actions and Default Values — controlling mock behaviors

---

## Best Practices When Migrating

- Migrate incrementally: update a few tests as you upgrade.
- Use `--gmock_verbose=info` to debug test failures.
- Start with fixing compilation errors, then tackle behavioral changes.
- Use `RetiresOnSaturation` to make sequence-based tests less brittle.
- Review all mock method declarations for qualifier changes or syntax updates.
- Consider wrapping existing mock classes with `NiceMock` or `StrictMock` selectively to control test strictness.

---

This guide focuses solely on breaking changes and migration in the mocking framework and does not address unrelated GoogleTest features or integration details.
