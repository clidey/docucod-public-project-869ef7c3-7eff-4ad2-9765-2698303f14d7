---
title: "Upgrade Advice & Known Issues"
description: "Tips and best practices for upgrading safely, with guidance on avoiding common pitfalls and documenting any known upgrade issues from previous releases."
---

# Upgrade Advice & Known Issues

This page provides practical tips and best practices for safely upgrading GoogleTest and GoogleMock in your projects. It highlights key strategies to avoid common pitfalls, describes known issues from prior releases, and outlines how to mitigate upgrading challenges. Whether you are maintaining legacy test suites or adopting new features, this guide will help you ensure smooth upgrade paths.

---

## 1. Planning Your Upgrade

Upgrading your test framework is a critical step that requires care and preparation. Here's how to approach it:

- **Review the Release Notes Thoroughly**: Before upgrading, study the [Latest Release Highlights](../releases-version-history/latest-release-summary.mdx) and [Breaking Changes & Migration Guide](../upgrade-migration/breaking-changes-migration.mdx). These documents detail new features, API changes, and migration steps.

- **Audit Your Codebase for Deprecated and Legacy Features**: Use the [Deprecated Features](../upgrade-migration/deprecated-features.mdx) page to identify any outdated macros or APIs your tests might be using.

- **Set Up a Dedicated Branch or Environment for Upgrading**: Avoid disrupting your stable codebase. Test changes in isolation and ensure continuous integration pipelines reflect the changes.

- **Gradual Rollout Strategy**: Upgrade incrementally if possible. Test and verify each phase, especially in large codebases with extensive mocking.

---

## 2. Common Upgrade Pitfalls and How to Avoid Them

Upgrades bring changes that can cause tests to fail unexpectedly. Being aware of common pitfalls can help you resolve or prevent such issues:

### 2.1 Changes in `MOCK_METHOD` Macro Usage

The modern `MOCK_METHOD` macro replaces older `MOCK_METHODn` variants and offers richer qualifier support.

- **Pitfall**: Incorrect handling of complex argument types containing commas leading to compilation errors.

- **Solution**: Wrap such argument types in parentheses or use type aliases. For instance:

  ```cpp
  // Incorrect usage - may fail
  MOCK_METHOD(std::pair<bool, int>, GetPair, ());
  MOCK_METHOD(bool, CheckMap, (std::map<int, double>, bool));

  // Correct usage with parentheses
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));

  // Or with type aliases
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
  using MapIntDouble = std::map<int, double>;
  MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
  ```

### 2.2 Mock Method Qualifier Adjustments

Changes in qualifiers such as `const`, `override`, and `noexcept` need to be correctly expressed in mock declarations.

- **Tip**: Always update mock methods to match the base class signatures exactly, including those qualifiers.

### 2.3 Using Nice, Naggy, and Strict Mocks

The behavior of uninteresting calls depends on the mock wrapper type.

- **Known Issue**: Wrapping mocks inconsistently with `NiceMock`, `NaggyMock`, or `StrictMock` may cause unexpected warnings or failures.

- **Best Practice**: Choose the appropriate mock wrapper per your test's strictness requirements. `NiceMock` suppresses warnings for uninteresting calls, whereas `StrictMock` fails tests on such calls. Be aware that these wrappers work only for methods defined with the modern `MOCK_METHOD` macro inside the mock class itself.

### 2.4 Managing Default Actions and Expectations

- **Advice**: Use `ON_CALL` primarily to set default behaviors without enforcing call expectations, reserving `EXPECT_CALL` for verifying interactions.

- Avoid redundant `EXPECT_CALL`s that do not specify clear expectations to prevent brittle tests.

### 2.5 Move-Only Type Support

Support for mocking move-only types like `std::unique_ptr` has been added in recent releases.

- **Before Upgrade**: If your mocks use legacy workarounds for move-only types, consider refactoring to native support using `MOCK_METHOD`.

- Review the [Mocking Methods That Use Move-Only Types](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#mocking-methods-that-use-move-only-types) section for migration guidance.

### 2.6 Behavioral Changes in Expectation Matching

The order in which `EXPECT_CALL`s are declared affects which expectations match calls. GoogleMock resolves newer expectations before older ones.

- **Tip**: When setting expectations with different behaviors based on arguments, declare more general expectations before more specific ones to avoid unintentional matching.

- Use explicit sequencing (`InSequence`, `After`) to enforce call order when needed.

---

## 3. Known Issues from Prior Releases

Some issues detected in earlier versions may impact your upgrade. Here are notable ones:

### 3.1 Overlapping Expectations and Retiring

- Without `.RetiresOnSaturation()`, expectations with upper-bounded call counts do not retire automatically, possibly leading to failures on exceeding call limits.

- **Workaround**: Use `.RetiresOnSaturation()` on expectations with bounded cardinalities to retire them promptly.

### 3.2 Mock Method Destructors

- `MOCK_METHOD` does not support mocking destructors directly.

- **Recommendation**: For tests requiring verification of destruction order, add a mock method (e.g., `Die()`) called from the destructor and set expectations on it.

### 3.3 Visual C++ Compiler Warnings

- Certain versions of MSVC emit warnings related to const-qualified parameters in mock methods.

- **Temporary Fix**: Remove redundant `const` from top-level parameters to suppress false warnings, acknowledging that `const` on parameters passed by value is ignored in C++.

- Stay updated with compiler updates or patches from GoogleTest when upgrading your toolchain.

### 3.4 Compilation Performance with Large Mocks

- Large numbers of mock methods can slow down compilation.

- **Best Practice**: Move mock class constructors and destructors to `.cc` files rather than defining them inline.

---

## 4. Tips for a Smooth Upgrade

### 4.1 Use Feature Branching and Continuous Integration

Test new versions in a dedicated branch and automate your test suite to catch issues early.

### 4.2 Incremental Migration

Remove deprecated macros and update to modern API incrementally, not in huge bulk.

### 4.3 Set Verbose Logging During Migration

Use the `--gmock_verbose=info` command-line flag to get detailed mock call traces for understanding unexpected failures.

### 4.4 Leverage Migration Guides

Refer extensively to the [Breaking Changes & Migration Guide](../upgrade-migration/breaking-changes-migration.mdx) for detailed steps and examples.

### 4.5 Consult Mocking References

Cross-reference the [Mocking Reference](../reference/mocking.md), [gMock Cookbook](../docs/gmock_cook_book.md), and [Best Practices for Mocking](../guides/mocking-techniques/best-practices-mocking.mdx) to align your test code with recommended idioms.

---

## 5. Troubleshooting Common Upgrade Problems

### Problem: Tests break after upgrade without code changes

- Ensure new required qualifiers are added to mock method declarations.
- Check for deprecated `MOCK_METHODn` macros that need migration.
- Inspect new warnings or errors related to expectation ordering or uninteresting calls.

### Problem: Unexpected warnings for uninteresting calls

- Use `NiceMock` if you want to suppress warnings.
- Consider adding explicit `EXPECT_CALL(...).Times(AnyNumber())` for catch-all scenarios.

### Problem: Compilation errors due to argument commas in macros

- Wrap argument types with parentheses or use type aliases as shown above.

### Problem: Move-only types fail to mock or compile

- Update to native support with modern `MOCK_METHOD` syntax.
- Use lambdas or `WillOnce()/WillRepeatedly()` with lambdas as action implementations.

### Problem: Tests fail unexpectedly due to expectation overriding

- Use `InSequence` or `After` for ordering constraints.
- Review the order of `EXPECT_CALL` declarations.

---

## 6. Additional Resources

- [Breaking Changes & Migration Guide](../upgrade-migration/breaking-changes-migration.mdx)
- [Deprecated Features](../upgrade-migration/deprecated-features.mdx)
- [Mocking Reference](../reference/mocking.md)
- [gMock Cookbook](../docs/gmock_cook_book.md)
- [Best Practices for Mocking](../guides/mocking-techniques/best-practices-mocking.mdx)
- [Latest Release Highlights](../releases-version-history/latest-release-summary.mdx)

For further assistance or community support, see the [Support and Resources](../../faq/support-and-resources/where-to-get-help.mdx) section.

---