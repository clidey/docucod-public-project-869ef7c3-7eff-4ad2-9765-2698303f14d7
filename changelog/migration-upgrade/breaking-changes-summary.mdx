---
title: "Breaking Changes & Migration Paths"
description: "Detail the versions introducing breaking changes, what those changes are, and examined best practices for migrating affected codebases. This page presents code examples, deprecated pattern replacements, and links to further migration tips."
---

# Breaking Changes & Migration Paths

This page is your essential guide to GoogleMock's breaking changes, detailing exactly when these changes were introduced, how they impact your existing mock code, and offering practical advice on migrating your codebase efficiently. We provide clear code examples, recommended replacements for deprecated patterns, and direct you to further migration resources to ensure a smooth upgrade.

---

## Understanding Breaking Changes

Breaking changes occur when modifications to GoogleMock's API or behavior require users to update their test code. These changes often improve usability, safety, or performance but can cause existing tests to fail or misbehave if not adapted.

### Key Objectives:

- Identify versions with breaking changes
- Understand what changed and why
- Learn how to update your tests with minimal disruption

---

## Versions Introducing Breaking Changes

While GoogleMock rarely introduces breaking changes, when it does, these are carefully documented and accompanied by migration guidance.

Refer to the [Release History & Highlights](/changelog/release-history/all-releases-overview) page for detailed version timelines.

For concrete migration help, always check the release notes corresponding to your upgrade path.

---

## Common Breaking Changes and Migration Strategies

### 1. Transition from Old Style `MOCK_METHODn` Macros to `MOCK_METHOD`

**What changed:**

- Older `MOCK_METHODn` macros (e.g. `MOCK_METHOD1`) have been superseded by the more flexible `MOCK_METHOD` macro.
- The new `MOCK_METHOD` syntax improves compatibility with complex types and qualifiers.

**What to do:**

Replace old macros like:

```cpp
MOCK_METHOD1(Foo, bool(int));
```

with the new syntax:

```cpp
MOCK_METHOD(bool, Foo, (int));
```

**Tips:**

- Use the fourth parameter to specify qualifiers like `(const, override)`.
- This change improves template support and reduces compiler errors.

See the [gMock Cookbook: Old-Style MOCK_METHODn Macros](https://google.github.io/googletest/gmock_cook_book.html#OldStyleMOCK_METHODnMacros) for more details and example conversions.

---

### 2. Changes in `EXPECT_CALL` and `ON_CALL` Syntax Constraints

**What changed:**

- The ordering of clauses like `.With()`, `.Times()`, `.WillOnce()`, `.RetiresOnSaturation()`, etc. is strictly enforced.
- Some invalid usages (e.g. multiple `.With()` or `.WillByDefault()` calls) now cause test failures or compilation errors.

**Migration best practices:**

- Ensure `.With()` is used at most once and always as the first clause.
- Use exactly one `.WillByDefault()` for each `ON_CALL`.
- Use `.RetiresOnSaturation()` at most once, and as the last clause.

Failure to follow these rules will result in clear runtime failures:

```cpp
// Invalid: .With() twice
ON_CALL(a, ReturnResult(_))
    .With(_)
    .With(_)
    .WillByDefault(Return(Result()));
```

**Fix:** Remove extra `.With()` calls and confirm clause order.

Refer to the [Reference: EXPECT_CALL Syntax](https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL) for full details.

---

### 3. Handling Non-Default Constructible Return Types

**Breaking behavior:**

- Methods returning types without default constructors now require explicit return values.
- Calling such mock methods without specifying an action or return value results in an exception or a death test failure.

**Example:**

```cpp
class NonDefaultConstructible {
 public:
   explicit NonDefaultConstructible(int dummy);
};

class MockA {
 public:
   MOCK_METHOD(NonDefaultConstructible, ReturnNonDefaultConstructible, (), ());
};

MockA mock;
EXPECT_CALL(mock, ReturnNonDefaultConstructible()).WillOnce(Return(NonDefaultConstructible(42)));
```

**Migration:**

Always specify a `WillOnce(Return(...))` or similar action for these methods.

See test coverage in `gmock-spec-builders_test.cc` for illustration.

---

### 4. Changes to Match Argument Evaluation and Action Ordering

**What changed:**

- `ON_CALL` and `EXPECT_CALL` macros now guarantee each argument is evaluated exactly once.
- Chaining of `.WillOnce()` and `.WillRepeatedly()` enforces strict ordering.

**Migration tips:**

- Avoid side effects in argument expressions.
- Use sequences (`InSequence`) to specify call order explicitly instead of relying on expectation order.

---

## Migration Patterns with Code Examples

### Migrating Deprecated Syntax:

Old style:

```cpp
EXPECT_CALL(foo, DoSomething(5)).Times(1).WillOnce(Return(true));
```

New style with enforced ordering and retirement:

```cpp
EXPECT_CALL(foo, DoSomething(5))
    .WillOnce(Return(true))
    .RetiresOnSaturation();
```

### Using `.After()` and `.InSequence()` for Call Order

Explicitly specify order to prevent brittle tests:

```cpp
Sequence s;
EXPECT_CALL(foo, Init()).InSequence(s);
EXPECT_CALL(foo, Process()).After(init_expectation);
EXPECT_CALL(foo, Cleanup()).InSequence(s);
```

### Adapting to Strict Clause Rules

Invalid multiple `.With()` calls:

```cpp
EXPECT_CALL(foo, Bar(5)).With(_).With(_).WillOnce(Return(true));  // Fails
```

Correct usage:

```cpp
EXPECT_CALL(foo, Bar(5)).With(_).WillOnce(Return(true));
```

---

## Best Practices for a Smooth Migration

- **Upgrade incrementally:** Update tests for each breaking release to isolate issues.
- **Use sequences and `RetiresOnSaturation`:** To model call order and manage expectation lifecycle clearly.
- **Avoid side effects in matchers or action arguments:** Each argument is evaluated exactly once now.
- **Check for deprecated macros:** Replace old `MOCK_METHODn` and other legacy constructs.
- **Use the verbose flag during migration:** Run tests with `--gmock_verbose=info` to trace mock interaction and debug mismatches.

---

## Troubleshooting Common Migration Issues

<AccordionGroup title="Common Migration Issues & Tips">
<Accordion title="Uninteresting Call Warnings After Migration">
If you receive unexpected warnings about uninteresting calls:

- Confirm if all expected calls have appropriate `EXPECT_CALL` or catch-all `EXPECT_CALL` with `Times(AnyNumber())`.
- Switch mocks to `NiceMock<T>` if the uninteresting calls are intentional but should suppress warnings.
</Accordion>
<Accordion title="Runtime Failures on `.With()` Usage">
- Check that only one `.With()` clause exists.
- Confirm `.With()` appears before `.WillOnce()`, `.Times()`, etc.
</Accordion>
<Accordion title="Unexpected Behavior on Non-Default Constructible Returns">
- Ensure all mock methods returning such types have explicit `WillOnce(Return(...))` or `WillRepeatedly(Return(...))`.
- Adjust tests to provide valid return values at mock declaration.
</Accordion>
<Accordion title="Mock Methods Not Invoked As Expected">
- Make sure `EXPECT_CALL` clauses precede any invocations.
- Use sequences or `.After()` to enforce call order when necessary.
</Accordion>
</AccordionGroup>

---

## Further Migration Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) - Comprehensive recipes and migration tips.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) - Detailed API description and usage rules.
- [Release History & Highlights](../release-history/all-releases-overview) - Track version changes and release notes.
- [Upgrade Checklist & Best Practices](/changelog/migration-upgrade/upgrade-checklist) - Checklist for safe and effective upgrading.

---

## Summary Diagram of Migration Flow

```mermaid
flowchart TD
  Start([Start Migration]) --> CheckVersion{Does your version include breaking changes?}
  CheckVersion -->|No| Done([Continue Using Your Version])
  CheckVersion -->|Yes| IdentifyChanges[Identify breaking changes introduced]
  IdentifyChanges --> PlanMigration[Plan migration based on official guides]
  PlanMigration --> UpdateMocks[Update mocks macros and syntax]
  UpdateMocks --> EnforceOrdering[Apply `.With()`, `.Times()`, `.RetiresOnSaturation()` rules]
  EnforceOrdering --> HandleReturnTypes[Fix non-default-constructible returns]
  HandleReturnTypes --> TestAndDebug[Run tests with `--gmock_verbose=info` for debugging]
  TestAndDebug --> Complete([Migration Complete])
```

---

For hands-on examples and up-to-date migration guidance, always refer to the official [gMock documentation](https://google.github.io/googletest/gmock_cook_book.html) and [GoogleTest release notes](https://github.com/google/googletest/releases).

---

### Code Sample: Correct Usage of EXPECT_CALL Clauses

```cpp
using ::testing::_; // Wildcard matcher
using ::testing::Return;
using ::testing::Sequence;

Sequence seq;

class MockExample {
 public:
  MOCK_METHOD(bool, DoWork, (int input), ());
};

MockExample mock;

EXPECT_CALL(mock, DoWork(5)).Times(1).WillOnce(Return(true));
EXPECT_CALL(mock, DoWork(_)).Times(AnyNumber()).RetiresOnSaturation();

// Enforce call order
EXPECT_CALL(mock, DoWork(10)).InSequence(seq).WillOnce(Return(false));
EXPECT_CALL(mock, DoWork(20)).InSequence(seq).WillOnce(Return(true));

// Correct placement of `.With()`
EXPECT_CALL(mock, DoWork(_)).With([](auto&& args) { return true; }).WillRepeatedly(Return(true));
```

---

### Troubleshooting Migration with Verbose Output

Run your tests with:

```bash
--gmock_verbose=info
```

This prints detailed matched expectations and helps identify:

- Which expectation matched a call
- Which calls were unexpected or uninteresting
- Ordering violations

Use this to systematically debug and refine expectations.

---