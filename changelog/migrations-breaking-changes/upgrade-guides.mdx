---
title: "Upgrade & Migration Guides"
description: "Step-by-step instructions for migrating projects across major versions, including code examples, configuration changes, and best practices for a pain-free upgrade. This guide reduces friction and accelerates adoption of new versions."
---

# Upgrade & Migration Guides

Seamless migration across major GoogleTest and GoogleMock versions is vital for maintaining robust and up-to-date tests. This guide walks you through the critical steps, code adaptations, configuration updates, and best practices necessary for a smooth upgrade while minimizing disruptions.

---

## 1. Preparing for Migration

### Understand Versioning and Compatibility
- Review the semantic versioning scheme to identify major, minor, and patch releases.
- Focus on breaking changes and deprecated APIs introduced since your current version.
- Validate compiler and platform support requirements, particularly the C++17 baseline.

### Backup and Assess Your Codebase
- Ensure your test and mock implementations are well backed up before migration.
- Identify all usages of mocked classes, macros, and APIs that may be affected by changes.

### Read Breaking Changes and Deprecation Notices
- Consult the [Breaking Changes & Deprecation Notices](./breaking-changes) documentation to understand key incompatibilities.
- Pay close attention to changes affecting macro usage, mocking patterns, or strictness modes.

<Tip>
Upgrading to a newer version can improve test reliability and unlock powerful new features. Early preparation avoids costly rewrites later.
</Tip>

---

## 2. Migrating Mock Class Definitions

### Transition from Old `MOCK_METHODn` macros to New `MOCK_METHOD`
GoogleMock now encourages using the generic `MOCK_METHOD` macro:

```cpp
// Old style
MOCK_METHOD2(Foo, bool(int, std::string));

// New style
MOCK_METHOD(bool, Foo, (int, std::string));
```

- The new macro supports advanced qualifiers such as `const`, `override`, `noexcept`, and calling conventions.
- Wrap complicated argument types with parentheses where necessary:

```cpp
MOCK_METHOD((std::pair<int, bool>), GetData, ());
```

### Handle Mocking of Overloaded and Template Methods
- You must mock each overload explicitly using fully qualified signatures.
- Use the new `MOCK_METHOD` syntax consistently for clarity and compiler compatibility.

### Mocking Move-Only Types
- The new GoogleMock versions support move-only types (`std::unique_ptr`, etc.) natively:

```cpp
MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
```

- Use lambdas or callable objects to provide return values involving move-only types.

### NiceMock, NaggyMock, and StrictMock Usage
- Wrap mock classes with `NiceMock<T>`, `NaggyMock<T>`, or `StrictMock<T>` to control uninteresting call handling:

```cpp
NiceMock<MockFoo> nice_mock;  // Suppresses warnings for uninteresting calls.
StrictMock<MockFoo> strict_mock;  // Treats uninteresting calls as errors.
```

- Confirm your mock classes have virtual destructors and use `MOCK_METHOD` macros directly in the class to ensure strictness modifiers work correctly.

<Warning>
Nesting strictness wrappers (e.g., `NiceMock<StrictMock<T>>`) is unsupported and may cause undefined behavior.
</Warning>

---

## 3. Updating Expectation and Default Action Patterns

### Prefer `ON_CALL` for Default Behavior
- Use `ON_CALL` to specify default mock method behaviors without setting call count expectations.
- Avoid `EXPECT_CALL` without `.Times()` if you only want to stub methods.

### Write Precise `EXPECT_CALL` Statements
- Set expectations only when you want to verify that a call is made.
- Use `_` matcher to ignore parameters when not relevant.

### Use Updated Cardinality and Ordering Clauses
- Use clauses like `.Times()`, `.InSequence()`, `.After()` to express call counts and partial ordering.
- Remember that newer `EXPECT_CALL`s override earlier ones, so order your expectations accordingly.

### Handle Mocks with Complex or Overloaded Methods
- Resolve ambiguity in overloaded methods using helpers like `Const()` or explicit casting.
- Use `SafeMatcherCast<T>` to cast matchers safely when Types differ but conversion exists.

---

## 4. Revising Action Definitions

### Replace Legacy `ACTION` Macros with Lambdas or Functors
- Prefer modern C++ lambdas for side effects, return values, or composite actions:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int x) { return x * 2; });
```

### Combine Multiple Effects with `DoAll()`
- Use `DoAll()` to execute multiple actions in sequence, returning the last result.

### Use `Invoke()` and `InvokeWithoutArgs()`
- Use `Invoke()` to call existing functions, methods, or lambdas with mock call arguments.
- Use `InvokeWithoutArgs()` to call functions ignoring mock arguments.

### Actions with Move-Only Parameters or Return Types
- Use lambdas to manage life cycles of move-only resources.
- Avoid using `Return(std::move(...))` repeatedly as it can cause runtime errors.

---

## 5. Managing Configuration Flags and Initialization

### Adjust Test Initialization Calls
- Use `InitGoogleMock(&argc, argv)` to initialize GoogleMock, which processes flags like `--gmock_verbose`.

### Control Verbosity
- Adjust `--gmock_verbose` level to `info`, `warning`, or `error` to tailor test output verbosity.

### Handling Leaked Mocks
- If issues with leaked mocks arise, consider setting `--gmock_catch_leaked_mocks=1` or use `Mock::AllowLeak()` to suppress errors for known leaks.

<Check>
Verify your codebase uses appropriate main function signatures and calls to framework initialization for consistent behavior across platforms.
</Check>

---

## 6. Testing and Validation Post-Migration

### Run All Existing Tests
- Execute the full test suite to identify failures linked to mocking and expectations.
- Turn on verbose output (`--gmock_verbose=info`) to gain deeper insights into call expectations and mismatches.

### Address Failures
- Use detailed failure messages to refine matchers and actions.
- Look for warnings about uninteresting calls and decide whether to suppress or repair.

### Verify Mock Object Behavior
- Use `Mock::VerifyAndClearExpectations()` when necessary to force verification in code that manages mock lifetimes manually.

---

## 7. Best Practices for a Smooth Migration

- Incrementally migrate large codebases by adapting mocks and expectations module by module.
- Use the `NiceMock` wrapper by default unless strict checking is explicitly needed.
- Automate tests run immediately after migration steps to detect regressions early.
- Utilize the community resources and official guides to resolve issues quickly.

---

## Useful References

- [GoogleMock gMock Cheat Sheet](./gmock_cheat_sheet.md) — Quick syntax and macro references.
- [gMock Cookbook](./gmock_cook_book.md) — Practical recipes for advanced mocking.
- [Mocking Reference](./reference/mocking.md) — Complete list of mocking APIs and examples.
- [Strictness Modes Guide](./guides/advanced-and-integrations/mock-object-strictness.mdx) — Understanding NiceMock, NaggyMock, and StrictMock.
- [Breaking Changes & Deprecation Notices](./breaking-changes) — Key compatibility notes.

---

## Troubleshooting Tips

- If unexpected warnings or failures occur for uninteresting calls, consider switching to `NiceMock` or refining your `EXPECT_CALL` coverage.
- When dealing with overloaded methods, use explicit casts or wrappers to disambiguate.
- Always ensure mocked methods have virtual destructors to avoid undefined behavior during mock deletions.
- Use verbose logging modes to identify the source of mismatched expectations.

---

For a comprehensive understanding, begin with your existing test codebase assessment, proceed to refactor mocks and expectations according to the new syntax and behavioral rules, then validate exhaustively. This structured flow ensures painless discovery, adoption, and utilization of modern GoogleTest mocking capabilities.

<Info>
Happy migrating! For continual updates, follow the GoogleTest changelog and community forums.
</Info>
