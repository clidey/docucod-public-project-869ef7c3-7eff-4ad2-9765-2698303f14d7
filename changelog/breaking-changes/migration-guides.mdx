---
title: "Upgrade and Migration Guides"
description: "Practical, step-by-step guides for migrating projects between major versions or handling substantial internal changes. Focuses on mitigating risks and ensuring confidence when adopting upgraded releases."
---

# Upgrade and Migration Guides

Upgrading projects to newer major versions of GoogleTest and GoogleMock can introduce significant internal changes that may affect compatibility, behavior, or APIs. This guide offers practical, step-by-step instructions to ease migration risks, ensures confidence in adopting upgraded releases, and provides actionable advice to help you succeed.

---

## 1. Overview of Breaking Changes

Major version upgrades often involve API changes, deprecated functionality removal, and behavioral updates. To safeguard your project and tests:

- Carefully review **Release Notes** and **Breaking Changes** documentation for the upgraded version.
- Check for any deprecated macros, changed method signatures, or shifted default behaviors.
- Identify sections of your codebase and test suites that use affected APIs.

Refer to [Breaking Changes Summary](breaking-changes-summary.md) for a comprehensive list.

## 2. Preparing for Migration

### 2.1 Audit Your Test Code

- Locate all usage of **deprecated mocking macros** (such as old `MOCK_METHODn` series).
- Identify tests relying on behaviors that may have changed (e.g., expectation ordering, default actions).
- Check for expected compiler warnings about deprecated or obsolete features.

### 2.2 Back Up and Branch

- Create a dedicated branch for migration work to isolate changes.
- Ensure your current setup has a stable baseline with all tests passing before starting.

### 2.3 Development Environment

- Confirm your build system is updated to support the newer GoogleTest/GMock version requirements.
- Verify compiler compatibility and switched flags if necessary.

## 3. Updating Mock Definitions

### 3.1 Transition from Old Mock Macros to `MOCK_METHOD`

- Replace usages of legacy `MOCK_METHODn`, `MOCK_CONST_METHODn`, or `MOCK_METHODn_WITH_CALLTYPE` macros to the modern `MOCK_METHOD` syntax:

```cpp
// Legacy style
MOCK_METHOD1(Foo, bool(int));
// Updated style
MOCK_METHOD(bool, Foo, (int));
```

- Remember to wrap return types or parameter types containing commas with parentheses if needed.

### 3.2 Specify Qualifiers Explicitly

- For const, override, noexcept, or calling conventions, the new syntax supports an optional 4th parameter. Add them explicitly:

```cpp
MOCK_METHOD(int, GetValue, (), (const, override));
```

- This clarifies intent and aligns with the new API.

### 3.3 Mocking Non-Virtual Methods

- If your code relies on mocking non-virtual functions, migrate to the new high-performance dependency injection techniques documented in the [gMock Cookbook](gmock_cook_book.md#MockingNonVirtualMethods).

## 4. Revising Expectations and Actions

### 4.1 Update Expectation Clauses

- Confirm your `EXPECT_CALL` uses clauses such as `Times()`, `WillOnce()`, and `WillRepeatedly()` in the correct order.
- Replace any deprecated or obsolete clauses.

### 4.2 Use `ON_CALL` for Default Actions

- Shift from `EXPECT_CALL()` with `Times(AnyNumber())` for specifying default behaviors toward using `ON_CALL()` with `WillByDefault()` as recommended. This improves test clarity and maintenance.

### 4.3 Retiring Expectations

- Explicitly add `.RetiresOnSaturation()` to expectations intended to be non-sticky for proper mock behavior after saturation.

## 5. Handling Strictness of Mocks

- If upgrading alters how uninteresting calls are reported, consider adopting explicit mock strictness wrappers:

```cpp
NiceMock<MockFoo> nice_mock;   // Suppresses warnings on uninteresting calls.
StrictMock<MockFoo> strict_mock; // Treats uninteresting calls as errors.
```

- Adapt your tests to the stricter or less chatty behavior to avoid false positives or missing bugs.

## 6. Dealing with New or Changed Flags

- Update your invocation or test runner setup to use updated or new flags, like `--gmock_verbose=LEVEL` for verbosity control.
- Remove deprecated flags or macro definitions as per [Customization Points](googlemock/internal/custom/README.md).

## 7. Validating Migration

- Run all tests under increased verbosity (`--gmock_verbose=info`) to reveal detailed mock interactions.
- Investigate any unexpected failures using the verbose logs to detect mismatched expectations or API changes.

<Tip>
Running tests with verbose mock tracing helps identify mismatched expectations and subtle behavioral differences after migration.
</Tip>

- Gradually revert `.RetiresOnSaturation()` or expectation order changes if failing tests indicate timeline issues.
- Consider adding additional `EXPECT_CALL` or `ON_CALL` clauses to cover newly added or altered calls reported during verbose run.

## 8. Rollback Strategy

- Keep the original branch intact until the new version passes all tests reliably.
- Use version control to compare behaviors side-by-side.
- Document any temporary workarounds or code accommodations needed during the migration phase.

## 9. Common Pitfalls and Troubleshooting

### 9.1 Confusing Constness in Method Parameters

- Be aware MSVC compilers can warn about differing const modifiers in parameters which are ignored in C++. Remove redundant `const` annotation on parameters where possible.

### 9.2 Variadic Function Mocking

- Remember `gMock` cannot mock variadic functions directly. Overload these functions in the interface for mocking.

### 9.3 Mock Object Leaks

- Ensure virtual destructors on all interfaces and mock classes to avoid memory leaks reported by heap checkers.

### 9.4 Expectation Ordering

- Explicitly specify sequences using `InSequence` or `After` clauses when upgrading, as behavior might be stricter or reversed in new versions.

## 10. Additional Resources

- [Breaking Changes Summary](breaking-changes-summary.md)
- [gMock Cookbook for Migration Recipes](gmock_cook_book.md)
- [Mocking Reference](reference/mocking.md)
- [Legacy gMock FAQ](gmock_faq.md)
- [Customization Points for Flags](googlemock/internal/custom/README.md)

---

### Example Migration Code Snippet

```cpp
#include <gmock/gmock.h>

class MockFoo : public Foo {
 public:
  // Old style
  // MOCK_METHOD1(FooMethod, bool(int));

  // New style
  MOCK_METHOD(bool, FooMethod, (int), (override));

  // For const method
  MOCK_METHOD(int, GetValue, (), (const, override));
};
```

---

### Troubleshooting Tips Checklist

- Run tests with `--gmock_verbose=info` to diagnose mock call matching.
- Confirm virtual destructors exist to prevent leaks.
- Check for removed or changed deprecated mocks/macros.
- Use strictness wrappers to detect unexpected calls early.

---

By following these structured steps and leveraging available guides and references, your migration to major GoogleTest and GoogleMock versions will be systematic, minimizing disruptions and maintaining test reliability.


---

## Changelog & Migration Links

| Link | Description |
|-------|-------------|
| [Breaking Changes Summary](breaking-changes-summary.md) | Complete list of all breaking changes and how to address them. |
| [gMock Cookbook](gmock_cook_book.md) | Recipes and best practices for mocking patterns and migration. |
| [Mocking Reference](reference/mocking.md) | Up-to-date API reference for mocks, expectations, and actions. |

## Related Documentation

- [Legacy gMock FAQ](gmock_faq.md) — Address common issues faced when migrating.
- [Customization Points](googlemock/internal/custom/README.md) — Manage flag and macro changes.
- [gMock Cheat Sheet](gmock_cheat_sheet.md) — Quick syntax and idioms reference.

---

<Check>
Ensure all your mocks are defined with `MOCK_METHOD` macro and avoid deprecated old-style macros.
Review your test suite for expectation clauses ordering, and clarify default vs explicit actions.
Run your migration branch tests under higher verbosity to observe detailed mock call patterns.
</Check>

---

## Final Notes
Migration between major versions might require incremental porting, especially for large projects. Adopting new idiomatic patterns for mocks and expectations will future-proof your tests and leverage GoogleTest and GoogleMock’s latest capabilities.

Good luck and happy testing!
