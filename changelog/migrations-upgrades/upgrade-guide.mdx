---
title: "How to Safely Upgrade"
description: "Step-by-step guide to upgrading GoogleTest and GoogleMock. Includes advice for handling code migrations, updating build files, and validating success, ensuring a smooth and reliable upgrade process."
---

# How to Safely Upgrade GoogleTest and GoogleMock

This guide walks you through the complete process of safely upgrading your GoogleTest and GoogleMock versions. Whether you are updating to a newer release or moving between major versions, following these steps ensures your tests continue to work smoothly with minimal disruption.

---

## 1. Preparing for the Upgrade

Before applying any changes, make sure you have a clear understanding of the current state of your tests and build infrastructure.

- **Backup your existing codebase and tests.** This lets you easily revert if unexpected issues arise.
- **Review your current version of GoogleTest and GoogleMock.** Note the exact version numbers.
- **Read release notes and migration guides** for the target version to assess any breaking changes or deprecations.

<Info>
Tip: Consult the [Breaking Changes & Migration Notes](https://github.com/google/googletest/blob/main/docs/changelog/migrations-upgrades/breaking-changes.md) for detailed compatibility and upgrade advice.
</Info>

---

## 2. Upgrade Workflow

Follow this step-by-step flow to ensure a structured upgrade process:

### Step 1: Fetch and Integrate New Version

- Clone or download the new release of GoogleTest and GoogleMock from the official repository.
- If using CMake, consider embedding the new source as a subdirectory (`add_subdirectory()`) or update your `find_package` references accordingly.
- For system-installed versions, update your package or rebuild and reinstall using the provided build instructions.

### Step 2: Update Build Files

- Adjust your build scripts (CMakeLists, Bazel, Makefiles, etc.) to point to the new headers and libraries.
- Check any `pkg-config` scripts if used, and regenerate them as needed.
- Verify that compiler flags such as `-DGTEST_HAS_PTHREAD`, `-DGTEST_CREATE_SHARED_LIBRARY`, or C++ standard flags (at least C++17) are correctly set.

### Step 3: Migrate Code

- Examine your test code for any deprecated macros or APIs; update them as per the new version's documentation.
- Pay special attention to mocking macros: migrate old-style `MOCK_METHODn` macros to the unified `MOCK_METHOD` syntax.
- Update any custom actions, matchers, or expectation code that may be affected by changes in mock strictness or invocation order.

### Step 4: Compile and Build

- Build your updated test code with the newly integrated GoogleTest and GoogleMock.
- Address any compiler errors or warnings that arise from API changes.
- Use CMakeâ€™s recommended idioms for integration to avoid issues with runtime library mismatches, especially on Windows (consider `gtest_force_shared_crt`).

### Step 5: Run and Validate Tests

- Execute your entire test suite.
- Confirm that all tests pass without new failures or warnings.
- Investigate any failures that may stem from API or behavioral changes.

<Tip>
Use GoogleTest's verbosity flags (e.g., `--gtest_verbose=info`) to gain insight into test execution and mock call matching during validation.
</Tip>

---

## 3. Handling Specific Upgrade Considerations

### C++ Standard Compliance

- The newer versions of GoogleTest require at least C++17. Ensure your compiler and build environment reflect this requirement.
- Set C++17 explicitly in your build files:

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

### Mocking Macros Migration

- Replace deprecated `MOCK_METHODn` and `MOCK_CONST_METHODn` with the unified `MOCK_METHOD` macro.
- Properly wrap template or comma-containing types in extra parentheses or use type aliases to avoid macro parsing issues.

Example:

```cpp
// Old style (deprecated)
MOCK_METHOD1(Foo, bool(int));

// New style (recommended)
MOCK_METHOD(bool, Foo, (int));

// For complicated types:
using PairType = std::pair<int, bool>;
MOCK_METHOD(PairType, GetPair, ());
```

### Build Flags and Threading

- For multi-threaded tests, verify that `-DGTEST_HAS_PTHREAD=1` is set if using pthreads.
- On Windows, avoid runtime library mismatches by enabling `gtest_force_shared_crt` option.

### Shared vs Static Libraries

- Decide whether to build GoogleTest and GoogleMock as static or shared libraries.
- Set `-DGTEST_CREATE_SHARED_LIBRARY=1` when building shared libraries and `-DGTEST_LINKED_AS_SHARED_LIBRARY=1` when linking your tests.

---

## 4. Troubleshooting Common Issues

### Compilation Errors

- Check for missing or incorrect include directories.
- Verify all macros required for your environment are set, such as disabling or enabling pthread support.
- Ensure consistent run-time library flags, especially on Windows.

### Linking Failures

- Confirm your linker flags include GoogleTest and GoogleMock libraries.
- Ensure `pkg-config` or CMake find_package correctly locates the installed libraries.

### Test Failures After Upgrade

- Investigate deprecated or changed assertions and matchers.
- Check mock object behavior (nice, naggy, strict) if test failures are related to unexpected or uninteresting calls.
- Use increased verbosity options for detailed failure analysis.

### Build System Integration

- If your build system caches aggressively, consider a clean rebuild.
- Validate submodule or FetchContent URL updates if used.

---

## 5. Validating Successful Upgrade

After upgrading, success is evident when:

- All existing tests compile and run without warnings or errors.
- Mocking behavior remains consistent and expectations verified.
- No unexpected test failures or flaky test behavior appear.

Use the GoogleTest and GoogleMock logs and verbose output to confirm no unexpected calls or warnings occur.

---

## 6. Reference Links and Further Reading

- [GoogleTest Build with CMake](https://github.com/google/googletest/blob/main/googletest/README.md#build-with-cmake)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Breaking Changes & Migration Notes](https://github.com/google/googletest/blob/main/docs/changelog/migrations-upgrades/breaking-changes.md)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [GoogleTest User's Guide](https://google.github.io/googletest/)

---

By following these structured upgrade best practices, you will minimize disruption in your testing workflow and fully leverage the improvements in GoogleTest and GoogleMock with confidence and clarity.
