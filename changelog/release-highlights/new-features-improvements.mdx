---
title: "New Features and Improvements"
description: "Highlights significant enhancements, new functionality in the test framework and mocking APIs, and quality-of-life improvements introduced in recent releases. Helps users leverage the latest capabilities and optimize their testing workflows."
---

# New Features and Improvements

Welcome to the comprehensive guide on the latest enhancements and new features in the GoogleTest and GoogleMock framework. This page highlights significant improvements in the test framework and mocking APIs that empower you to write more expressive, maintainable, and efficient tests. Whether you are introducing advanced mock behaviors, refining your expectations, or optimizing test flows, these updates will elevate your testing experience.

---

## 1. Enhanced Mocking API Features

### Robust Support for Incomplete Types in Mocks
You can now define mock methods whose arguments are references to incomplete types, as long as Google Mock knows how to print them. This allows separation of interface and implementation files while still enabling rich mocking capabilities. For example:

```cpp
class Incomplete;  // Forward declaration

class MockIncomplete {
 public:
  MOCK_METHOD(void, ByRefFunc, (const Incomplete& x));
};
```

> Key benefit: You can mock APIs that use forward-declared types without requiring their full definitions in your test code.

---

### Improved Macro Expansion Compatibility
Mock method names that coincide with macros (e.g., `Method` defined as a macro) now fully compile and behave correctly when used with `EXPECT_CALL()` and `ON_CALL()`. This reduces friction when mocking codebases with platform-specific macros, such as Windows API naming.

---

### Single Evaluation of Call Arguments
`EXPECT_CALL()` and `ON_CALL()` now guarantee that their arguments are evaluated exactly once. This shields you from potential side effects or inconsistent state changes during expectation setup.

```cpp
int n = 0;
EXPECT_CALL(obj, Func(n++));  // n is incremented only once here
```

---

## 2. Expectation Syntax and Usage Enforcements

### Chainable Clause Restrictions and Usage Rules
The ordering and occurrence of clauses like `.With()`, `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()` are now strictly enforced at runtime. Common misuses produce clear diagnostic messages that help you write correct and predictable expectations.

- `.With()` may appear at most once and must be the first clause.
- `.Times()` can appear once and must precede `.InSequence()`.
- `.InSequence()` can appear multiple times but must precede `.WillOnce()`.
- `.After()` precedes `.WillOnce()` and `.InSequence()`.
- `.WillOnce()` and `.WillRepeatedly()` appear in the correct order.

This strictness ensures your expectation specifications adhere to best practices and avoid subtle logic bugs.

---

### Cardinality Inference and Validation
Google Mock infers call cardinalities based on the presence and number of `WillOnce()` and `WillRepeatedly()` clauses when `.Times()` is omitted:

- No `WillOnce()` or `WillRepeatedly()` implies `.Times(1)`.
- `n` `WillOnce()` clauses without `WillRepeatedly()` imply `.Times(n)`.
- `n` `WillOnce()` clauses with `WillRepeatedly()` imply `.Times(AtLeast(n))`.

Additionally, Google Mock warns if the number of `WillOnce()` actions is inconsistent with the cardinality (too many or too few), guiding you to correct your expectation setups.

---

## 3. Sophisticated Default and Explicit Call Actions

### Priority and Selection Between `ON_CALL` and `EXPECT_CALL`
Actions specified by `EXPECT_CALL` take precedence over those in `ON_CALL`. In cases of overlapping matchers, the last matching `EXPECT_CALL` is selected.

Example:

```cpp
ON_CALL(mock, Func(_)).WillByDefault(Return(3));
EXPECT_CALL(mock, Func(2)).WillRepeatedly(Return(2));
EXPECT_CALL(mock, Func(_)).WillRepeatedly(Return(1));

mock.Func(2); // Returns 2
mock.Func(3); // Returns 1
```

### Improved Handling for Uninteresting, Unexpected, and Excessive Calls
The framework now clearly manages calls that are:

- **Uninteresting**: Calls with no matching expectation but allowed to proceed with a default action.
- **Unexpected**: Calls with expectations but no match, causing test failures with detailed diagnostic messages including argument mismatches and sequence prerequisites.
- **Excessive**: Calls that exceed the allowed call count, properly triggering failure messages, while returning defaults or invoking default actions.

Diagnostic messages provide function call arguments, the number of times expected vs actual, and pre-requisite expectations, improving debugging efficiency.

---

## 4. Sequence and Partial Ordering of Expectations

### Fully Supported and Nested Sequence Scopes
Wrapping expectations inside `InSequence` blocks imposes call-order constraints as intended, supporting nested sequences for fine-grained control.

```cpp
{ InSequence s1; 
  EXPECT_CALL(mock, Func(1));
  { InSequence s2;
    EXPECT_CALL(mock, Func(2));
    EXPECT_CALL(mock, Func(3));
  }
}
```

### Multiple Sequence Membership for Partial Order Graphs
`EXPECT_CALL().InSequence()` now supports multiple `Sequence` objects for defining Directed Acyclic Graph (DAG) style partial ordering, enabling precise control over complex call order dependencies.

Example DAG:

```
       +---> B
       |
  A ---|
       |
       +---> C ---> D
```

Enforced by associating expectations with sequences `s1` and `s2`.

---

### Expectation Retirement on Saturation and Sequence Progression

- `.RetiresOnSaturation()` automatically deactivates expectations after their upper bound is reached, preventing oversaturation failures.
- Expectations in sequences retire as subsequent expectations are matched, shaping active expectations dynamically during test execution.

---

## 5. The `.After()` Clause for Dependent Expectations

### Support for Single and Multiple Prerequisite Expectations
Use `.After()` with one or multiple `Expectation` or `ExpectationSet` arguments to ensure dependent expectations fire only after prerequisites are satisfied.

Examples:

```cpp
Expectation e1 = EXPECT_CALL(mock, Func(1));
ExpectationSet es;
es += EXPECT_CALL(mock, Func(2));
EXPECT_CALL(mock, Func(3)).After(e1, es);
```

### Enforced Strict Call Order
Calls violating `.After()` constraints produce failures, ensuring your tests maintain the correct execution dependencies and partial orders.

### Multiple `.After()` Calls and Handling of Duplicates
You can chain `.After()` calls multiple times and include duplicate expectations without altering behavior, providing flexibility in complex scenarios.

### Lifecycle Considerations
Google Mock handles expectation retirement and mock object lifetimes gracefully even when dependencies involve objects destroyed earlier.

---

## 6. Support for Complex and Move-Only Types

### Returning Non-Movable Objects
Google Mock now supports returning non-movable, non-copyable types from mock methods in C++17 and above, enhancing compatibility with complex return types.

### Mocking Overloaded and Const Methods
You can define expectations and default actions for overloads and const-qualified methods explicitly using `Const()` wrapper and correct `MOCK_METHOD` specifications.

---

## 7. Mock Lifecycle and Verification Helpers

### `Mock::AllowLeak()`
Use this method to mark mock objects that you intend to leak (e.g., global mocks), suppressing unexpected leak failures during test runs.

### Verify and Clear Functions

- `Mock::VerifyAndClearExpectations()` checks all existing expectations on an object and clears them upon success or failure.
- `Mock::VerifyAndClear()` additionally clears default actions and thus fully resets the mock state.

These utilities help enforce test correctness in complex scenarios where mock objects persist across multiple test phases.

---

## 8. Enhanced Logging and Verbosity Control

### `--gmock_verbose` Flag Levels
Configure message verbosity with `info`, `warning` (default), or `error` levels.

- **info:** Prints all message types including stack traces for expected and uninteresting calls.
- **warning:** Prints warnings and errors without stack traces on uninteresting calls.
- **error:** Prints error messages only, minimizing output noise.

Users can also set verbosity programmatically within tests.

### Informative Warning Messages
Warnings are now more descriptive, including the nature of the call (expected, uninteresting, excessive, unexpected), arguments, and return values.

---

## 9. Multithreading and Deadlock Avoidance

Google Mock ensures thread safety across asynchronous mock method calls, including:

- Non-blocking destruction of mocks even when chained through other mocks.
- Safe invocation of mock methods inside other mock method actions.
- Proper synchronization via internal locking without deadlocks.

This lets you write multithreaded tests and test asynchronous code confidently.

---

## 10. New Utilities and Testing Patterns

### Parameterless Expectations
Set expectations and default actions without argument matchers, especially useful for overloaded or const-qualified methods.

### Delegation to Fake or Real Objects
Easily delegate mock default behavior to real or fake implementations by combining `ON_CALL` with lambdas.

### Testing Uninteresting and Unexpected Calls with Context
Warnings and errors include detailed context, including stack traces and argument summaries when verbosity permits.

---

## Practical Examples

### Using Sequences for Ordered Calls
```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Func1());
  EXPECT_CALL(mock, Func2());
}
```
Ensures `Func1()` is called before `Func2()`.

### Using `.After()` to Express Partial Ordering
```cpp
Expectation e1 = EXPECT_CALL(mock, Func1());
EXPECT_CALL(mock, Func2()).After(e1);
```
Means `Func2()` can be called only after `Func1()` has been called.

### Managing Expectations with Multiple `.WillOnce()`
```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```
The method returns 1 on first call, 2 on second, and 3 thereafter.

---

## Troubleshooting and Best Practices

- **Expectation Ordering:** Use sequences and `.After()` to clarify call dependencies.
- **Using `ON_CALL` and `EXPECT_CALL` Correctly:** Prefer `ON_CALL` for default behaviors; `EXPECT_CALL` for enforced expectations.
- **Managing Uninteresting Calls:** Use `NiceMock` to suppress warnings or explicitly expect such calls.
- **Call Count Controls:** Always specify `.Times()` or rely on automatic inference combined with `.WillOnce()` and `.WillRepeatedly()`.
- **Verbose Output Config:** Adjust verbosity to debug unexpected failures or reduce log noise.
- **Thread Safety:** Set expectations only in single-threaded context; mock methods may be called concurrently.

---

For a full exploration of these new capabilities and practical examples, consult related pages:
- [Mocking Reference](../../api-reference/mocking-apis/mock-methods)
- [Using Mocks: Patterns and Best Practices](../../guides/mocking-and-advanced-techniques/using-mocks)
- [Call Count Expectations (Cardinalities)](../../api-reference/matchers-and-actions/call-cardinalities)
- [Mock Class Behaviors (Nice, Naggy, Strict)](../../api-reference/mocking-apis/mock-class-behaviors)
- [Test Discovery and Structure](../../api-reference/core-testing-apis/test-discovery-and-structure)

---

<Check>
Remember that writing expectations before invoking mock methods is critical for correct behavior. Use `.RetiresOnSaturation()` to avoid sticky expectations causing unexpected failures.
</Check>

<Note>
When upgrading to versions with these new features, review your mocks for any redundant or incompatible calls, especially if you relied on looser enforcement of expectation order or call counts.
</Note>

---

For source code, tests, and deeper insights, explore the official GoogleTest repository: [https://github.com/google/googletest](https://github.com/google/googletest)

---