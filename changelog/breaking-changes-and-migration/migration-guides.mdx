---
title: "Migration Guides"
description: "Practical, step-by-step guides to help users transition to new versions when breaking changes occur. Includes code snippets, configuration file adjustments, and troubleshooting tips specific to recent upgrades."
---

# Migration Guides

This page provides practical, step-by-step instructions to assist users in transitioning their codebases when upgrading GoogleMock and GoogleTest versions that introduce breaking changes. The guides focus on helping you adapt your mock class definitions, expectation clauses, and test configurations to the latest API conventions and behavioral changes without disruption.

---

## Why Migration Guides Matter

When upgrading to newer versions of GoogleMock, certain API patterns and behaviors may change to improve usability, correctness, or performance. These changes can be breaking, requiring you to adapt your existing tests to continue functioning correctly. This page serves as a reliable companion during that transition, offering clear, actionable advice to guide you through common breaks and how to fix them effectively.

---

## Understanding Key Breaking Changes

Before diving into specific migrations, let’s outline some critical changes that often trigger migration needs:

- **Unified `MOCK_METHOD` Macro:** Older mock declarations using legacy macros (`MOCK_METHODn`, `MOCK_CONST_METHODn`, etc.) have been superseded by the generic and consistent `MOCK_METHOD` macro. Migrating code to use the new macro ensures better maintainability and compatibility.

- **Clause Ordering in `EXPECT_CALL` and `ON_CALL`:** The introduction of strict ordering rules for clauses such as `.With()`, `.Times()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()` helps avoid ambiguous mock behavior but requires reordering existing expectations.

- **Handling of Move-Only Types:** Support for mocking methods taking or returning move-only types like `std::unique_ptr` has improved. Where legacy workarounds were used, migration to direct support is encouraged.

- **Mock Destructor Testing:** Mocking destructors directly is not supported. Instead, replace destructor tests with a mock method called from the destructor.

- **Strictness Modes:** Changes in default mocking behavior and recommendation to use `NiceMock` or `StrictMock` wrappers where appropriate.

---

## Migration Step 1: Converting Old-Style Mock Method Macros to New `MOCK_METHOD`

Legacy mock method macros are being deprecated for the unified `MOCK_METHOD` macro. This macro improves clarity and compatibility by requiring explicit specification of return types, method names, argument lists, and optional specifiers like `const` and `override`.

### What You Had (Legacy Macro)

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD1(FooMethod, bool(int));
  MOCK_CONST_METHOD0(GetValue, int());
};
```

### What to Use Now

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(bool, FooMethod, (int), (override));
  MOCK_METHOD(int, GetValue, (), (const, override));
};
```

### Practical Tips

- Wrap argument or return types containing commas in extra parentheses or use `using` alias to avoid macro parsing issues.
- Always place `MOCK_METHOD` declarations in the `public:` section.
- Add `override` for virtual overrides to ensure correctness.

---

## Migration Step 2: Correct Ordering of Clause Specifiers in `EXPECT_CALL` and `ON_CALL`

GoogleMock now enforces the order in which expectation modifiers appear. Incorrect ordering leads to compiler or runtime errors.

### Correct Clause Ordering

1. `.With()` - Optional, and must be the first modifier if used.
2. `.Times()` - Optional, must follow `.With()` if present.
3. `.InSequence()` - Optional, can be repeated, after `.Times()`.
4. `.After()` - Optional, after `.InSequence()`.
5. `.WillOnce()` - Optional, multiple allowed, after `.After()`.
6. `.WillRepeatedly()` - Optional, once, after `.WillOnce()`.
7. `.RetiresOnSaturation()` - Optional, once, last modifier.

### What You Might See (Incorrect Ordering)

```cpp
EXPECT_CALL(foo, Bar())
    .Times(1)
    .With(_)
    .WillOnce(Return(5)); // Invalid: .With() must be before .Times()
```

### Corrected Version

```cpp
EXPECT_CALL(foo, Bar())
    .With(_)
    .Times(1)
    .WillOnce(Return(5));
```

### Recommendations

- Review your existing mocks for any violations.
- Use the migration guides or compiler diagnostics to identify incorrect usages.

---

## Migration Step 3: Mocking Methods With Move-Only Types

GoogleMock now natively supports mocking methods that accept or return move-only types (e.g., `std::unique_ptr`).

### Legacy Workaround Example

```cpp
class MockBuzzer : public Buzzer {
 public:
  MOCK_METHOD(bool, DoShareBuzz, (Buzz* buzz, Time timestamp));

  bool ShareBuzz(std::unique_ptr<Buzz> buzz, Time timestamp) override {
    return DoShareBuzz(buzz.get(), timestamp);
  }
};
```

### Modern Approach

```cpp
class MockBuzzer : public Buzzer {
 public:
  MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
  MOCK_METHOD(bool, ShareBuzz, (std::unique_ptr<Buzz> buzz, int64_t timestamp), (override));
};
```

### Usage Tips

- When returning a move-only value, prefer lambdas in `.WillOnce` or `.WillRepeatedly` clauses rather than `Return(std::move(...))`.
- If the mock method accepts move-only arguments, use lambdas to specify behavior where built-in actions fail.

---

## Migration Step 4: Testing Mock Destructors

Since mocking destructors directly is unsupported, adapt tests to use a mock method invoked from the destructor.

### Pattern

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(void, Die, ());

  ~MockFoo() override { Die(); }
};
```

### Test Usage

```cpp
Sequence s;
EXPECT_CALL(*bar, A());
EXPECT_CALL(*foo, Die());  // Expect destruction here
EXPECT_CALL(*bar, B());

// Your test code exercising foo and bar
```

### Benefits

- You can specify ordering constraints involving object destruction.
- Avoids issues with virtual destructor mocking.

---

## Migration Step 5: Leveraging Strictness Wrappers (`NiceMock` and `StrictMock`)

GoogleMock now recommends explicit use of `NiceMock`, `StrictMock`, or default naggy mocks for better control over uninteresting call warnings.

### Usage

- Use `NiceMock<YourMock>` to suppress uninteresting call warnings.
- Use `StrictMock<YourMock>` to treat uninteresting calls as errors.
- Default mocks are naggy and print warnings for uninteresting calls.

### Example

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
EXPECT_CALL(mock_foo, DoThis());
```

### Best Practices

- Use `NiceMock` for cleaner test output when you don't care about certain calls.
- Use `StrictMock` to catch unexpected calls comprehensively.

---

## Troubleshooting Common Migration Issues

### Expectation Not Met After Migration

- Verify any reordered clauses are correctly placed.
- Check that all mocked methods use the new `MOCK_METHOD` signature.
- Confirm `override` is present for all mock methods.

### Compilation Errors from Legacy Macros

- Replace all `MOCK_METHODn` and variants with the modern `MOCK_METHOD`.
- Wrap complex argument or return types containing commas with extra parentheses or use type aliases.

### Unrecognized Clause Usage Errors

- Double-check clause order in `EXPECT_CALL` and `ON_CALL` statements.
- Avoid chaining multiple `.With()` or repeated `.Times()` clauses.

---

## Example Migration Patch Snippet

Before:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_CONST_METHOD0(GetValue, int());
  MOCK_METHOD1(DoSomething, bool(int x));
};

EXPECT_CALL(mock_foo, DoSomething(5))
    .Times(1)
    .With(_)
    .WillOnce(Return(true));
```

After:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(bool, DoSomething, (int x), (override));
};

EXPECT_CALL(mock_foo, DoSomething(5))
    .With(_)
    .Times(1)
    .WillOnce(Return(true));
```

---

## Additional Resources

- [Mocking Reference](reference/mocking.md) — Comprehensive details on the mocking API.
- [gMock Cookbook](gmock_cook_book.md) — Practical recipes and usage patterns.
- [Legacy gMock FAQ](gmock_faq.md) — Common questions about migration and usage.
- [Basics of Mocking](guides/mocking-best-practices/basics-of-mocking.md) — Best practices.
- [Specifying Behavior: Actions, Matchers, and Sequences](guides/mocking-best-practices/actions-matchers-sequences.md) — For setting expectations.

For extensive upgrade scenarios or more detailed migration scripts, please refer to the main [Breaking Changes Summary](breaking-changes-summary.md) page.
