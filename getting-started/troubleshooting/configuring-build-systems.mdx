---
title: "Build System Configuration Pitfalls"
description: "Address typical project or toolchain misconfigurations—such as header not found, linking errors, or incompatible compiler versions—with targeted advice for CMake and Bazel users."
---

# Build System Configuration Pitfalls

This page addresses common pitfalls and configuration issues encountered by CMake and Bazel users when integrating GoogleTest and GoogleMock into their projects. By understanding and avoiding typical misconfigurations such as missing headers, linking errors, and incompatible compiler options, you can streamline your build setup and ensure reliable test compilation and execution.

---

## 1. Common Misconfigurations in GoogleTest and GoogleMock Builds

GoogleTest and GoogleMock rely on careful coordination between your build system, compiler, and linker settings. Misalignment in these areas often leads to typical errors:

- **Headers not found:** Build scripts must correctly specify include directories to locate GoogleTest and GoogleMock headers.
- **Linking failures:** Missing or incorrectly linked GoogleTest/GoogleMock static or shared libraries.
- **Runtime library conflicts:** Mismatched runtime linking (static vs dynamic CRT) especially on Windows with MSVC.
- **C++ standard compatibility:** GoogleTest requires at least C++17; using older standards causes compilation errors.
- **Threading support flags:** Missing `-DGTEST_HAS_PTHREAD=1` or related flags can cause mysterious link errors.

Understanding these common pitfalls will save time troubleshooting and allow a smoother development experience.

---

## 2. Troubleshooting Tips for CMake Users

### 2.1 Ensure Include and Link Directories Are Set Correctly

GoogleTest and GoogleMock packages provide include paths and libraries that should be properly referenced:

- Use CMake's `find_package(GTest CONFIG REQUIRED)` to locate installed packages.
- Link to targets `GTest::gtest` and `GTest::gmock` rather than manual paths.
- When embedding GoogleTest sources directly via `add_subdirectory()`, confirm source paths and include directories reflect accurate locations.


### 2.2 Handle Visual Studio Runtime Library Mismatches

A very common issue occurs on Windows when your project uses dynamic CRT (/MD or /MDd) but GoogleTest is linked against static CRT (/MT or /MTd). This causes linker errors similar to:

```
gtest.lib(gtest-all.obj) : error LNK2038: mismatch detected for 'RuntimeLibrary'
```

To fix this:

- Use the CMake option `-Dgtest_force_shared_crt=ON` when configuring GoogleTest to force it to link dynamic CRT libraries matching your project.

Example:

```bash
cmake .. -Dgtest_force_shared_crt=ON
```


### 2.3 Specify the C++ Standard Explicitly

Ensure your project and GoogleTest set at least C++17 standard by adding:

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

When GoogleTest is embedded via `add_subdirectory()`, it's essential that these settings are consistent and applied before GoogleTest targets are added.


### 2.4 Configure Pthread Support Correctly

GoogleTest uses pthread on POSIX systems. If linking errors related to pthread occur, define the macro explicitly:

```cmake
add_compile_definitions(GTEST_HAS_PTHREAD=1)
```

Or confirm that CMake finds pthread by checking your logs for `Threads::Threads` linking. Misconfiguration leads to undefined references to pthread functions.


### 2.5 Use CMake FetchContent for Simpler Dependency Management

Embedding GoogleTest sources using `FetchContent` automates downloads and integration, eliminating many common setup errors.

Example snippet for `CMakeLists.txt`:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE) # Match CRT link
FetchContent_MakeAvailable(googletest)

add_executable(mytests test.cpp)
target_link_libraries(mytests gtest_main)
add_test(NAME mytests COMMAND mytests)
```

This centralizes configuration and reduces version drift.


### 2.6 Avoid Mixing Static and Shared Libraries

When using shared libraries (`BUILD_SHARED_LIBS=ON`), avoid linking static GoogleTest or GoogleMock libraries and vice versa. Inconsistent linkage leads to missing symbols or runtime failures.

Explicitly configure:

```cmake
set(BUILD_SHARED_LIBS ON)
```

before adding GoogleTest targets.

---

## 3. Bazel Users: Avoiding and Diagnosing Common Errors

Bazel users often face issues related to workspace setup and declaration of dependencies.

### 3.1 Ensure Proper Workspace Configuration

- Declare googletest and googlemock repositories in your WORKSPACE file using `http_archive` or equivalent.
- Use Bazel-provided build rules referencing their libraries, e.g., `@com_google_googletest//:gtest_main`.

### 3.2 Correctly Link Tests

- In BUILD files, ensure `deps` reference the correct targets.
- Link test binaries against `gmock_main` or `gtest_main` as needed.


### 3.3 Manage Compiler Flags

- Pass required compiler options to enable C++17 standard and threading support.


### 3.4 Typical Errors and Solutions

- **Header not found:** Check include paths and workspace setup.
- **Undefined references:** Confirm dependencies include appropriate GoogleTest/Mock libraries.
- **Incompatible compiler versions:** Use supported compilers compatible with C++17.

Refer to Bazel's official docs and GoogleTest integration examples for specific patterns.

---

## 4. Frequently Encountered Errors and How to Fix Them

| Error Message                                 | Cause                                           | Solution                                                   |
|-----------------------------------------------|-------------------------------------------------|------------------------------------------------------------|
| `fatal error: gtest/gtest.h: No such file or directory` | Missing or incorrect include directories        | Add proper include paths or use `find_package(GTest)`       |
| `undefined reference to 'testing::InitGoogleTest'`       | Missing linked GoogleTest library                   | Link against `gtest` or `gtest_main` library                |
| `mismatch detected for 'RuntimeLibrary'`                  | Runtime library mismatch (static vs dynamic CRT)   | Use `-Dgtest_force_shared_crt=ON` or unify build settings  |
| `error: no matching function for call to 'RUN_ALL_TESTS'` | Failed to initialize GoogleTest properly             | Call `InitGoogleTest` or `InitGoogleMock` before running tests |
| Link errors on pthread symbols                           | Pthread support missing or not linked                | Add `-DGTEST_HAS_PTHREAD=1` and link pthread explicitly     |

---

## 5. Best Practices and Recommendations

- Always synchronize GoogleTest and GoogleMock versions and build settings with your project.
- Prefer using CMake's package config or `FetchContent` approaches for repeatable builds.
- For Visual Studio builds, explicitly set runtime library linkage to avoid CRT conflicts.
- Pass necessary macros like `-DGTEST_HAS_PTHREAD=1` for POSIX systems.
- When using shared libraries, build all dependencies consistently as shared.
- Use `target_compile_features(... PUBLIC cxx_std_17)` to enforce C++17 usage.
- For Bazel, ensure workspace declarations and dependencies are precise and follow official examples.
- Test your build configuration early by compiling and running a minimal GoogleTest example.

---

## 6. Additional Resources

- [GoogleTest CMake Build Guide](https://github.com/google/googletest/tree/main/googletest#building-and-installing)
- [CMake `FetchContent` Documentation](https://cmake.org/cmake/help/latest/module/FetchContent.html)
- [Handling Runtime Library Conflicts in Visual Studio](https://github.com/google/googletest/blob/main/googletest/README.md#visual-studio-dynamic-vs-static-runtimes)
- [PkgConfig Integration Tips](https://github.com/google/googletest/blob/main/docs/pkgconfig.md)
- [Bazel Integration with GoogleTest](https://docs.bazel.build/versions/main/testing/gtest.html)
- [GoogleTest Troubleshooting Guide](https://github.com/google/googletest/blob/main/docs/faq.md#why-wont-googletest-or-googlemock-build-or-install)

---

## 7. Troubleshooting Checklist

<AccordionGroup title="Common Build Issues and Solutions">
<Accordion title="Headers Not Found">
- Verify `include_directories()` or `target_include_directories()` include GoogleTest/GoogleMock source or installed headers.
- Use CMake’s `find_package(GTest CONFIG REQUIRED)` when possible.
- Confirm file system paths are correct and that dependencies are installed.
</Accordion>
<Accordion title="Linker Errors">
- Ensure `target_link_libraries()` includes `gtest`, `gtest_main`, `gmock`, or `gmock_main` as appropriate.
- Check that static vs shared library builds are consistent.
- On Windows, set `-Dgtest_force_shared_crt=ON` to match runtime linkage.
</Accordion>
<Accordion title="Runtime Library Mismatches">
- Adjust project settings to unify runtime library usage (either all static /MT or all dynamic /MD).
- Rebuild GoogleTest and your project with matching options.
</Accordion>
<Accordion title="Pthread Link Errors">
- Confirm that threading libraries are linked.
- Define `GTEST_HAS_PTHREAD=1` explicitly if CMake doesn’t find threads.
</Accordion>
<Accordion title="Compiler Version Issues">
- Use compilers supporting at least C++17.
- Set `CMAKE_CXX_STANDARD` and `CMAKE_CXX_STANDARD_REQUIRED` early in your `CMakeLists.txt`.
</Accordion>
</AccordionGroup>

---

# Summary

The "Build System Configuration Pitfalls" page provides targeted advice to help CMake and Bazel users avoid and resolve common integration issues with GoogleTest and GoogleMock.

It covers header inclusion errors, linking mistakes, compiler and runtime mismatches, threading support troubles, and best practice recommendations for a smooth testing environment setup.

Users are guided through practical tips, configuration checks, and troubleshooting actions aimed at delivering a robust and reliable build configuration.

---