---
title: "Mocking: How-To and Best Practices"
description: "Answers to typical questions about creating and using mocks, defining expectations, and best practices for leveraging the GoogleMock facilities within your tests. Emphasizes correct macro usage, test design, and covers edge-cases users are likely to encounter."
---

# Mocking: How-To and Best Practices

## Frequently Asked Questions on GoogleMock Usage

GoogleMock (gMock) is an essential tool for defining and using mocks in C++ unit tests. This FAQ focuses specifically on common questions and best practices around creating mocks, defining expectations, and understanding how to leverage gMock's facilities effectively. Whether you're crafting mock classes, managing expectations, or troubleshooting tricky test scenarios, this guide will clarify user intent and help you avoid pitfalls.

---

### 1. How do I define mock methods correctly using `MOCK_METHOD`?

- Use the `MOCK_METHOD` macro **inside the `public:` section** of your mock class irrespective of whether the original methods are public, protected, or private.
- The syntax is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (optional_qualifiers));
```

- Qualifiers can be `(const)`, `(override)`, `(noexcept)`, `(Calltype(...))`, or `(ref(...))` depending on the method's signature.
- Wrap any return or argument types that contain unprotected commas (e.g., `std::pair<int, int>`) in parentheses or use type aliases.

Example:

```cpp
class MockFoo {
 public:
  MOCK_METHOD(void, DoSomething, (int x), (override));
  MOCK_METHOD((std::pair<int, int>), GetPair, ());
};
```

---

### 2. How can I mock overloaded or templated methods?

- Mock each overload separately with the exact signature.
- Use modifiers `(const, override)` for const-qualified methods.
- For class templates, mock as normal classes with `MOCK_METHOD` macros.
- Use `using BaseClass::MethodName` to bring overloaded base class methods into scope where you don't want to mock them.

Example:

```cpp
class MockFoo : public Foo {
  using Foo::Add;  // Bring unmocked overloads into scope
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (int times, Element x), (override));
};

template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
};
```

---

### 3. When should I use `EXPECT_CALL` versus `ON_CALL`?

- Use `EXPECT_CALL` when you want to **verify that a call happens** with specific arguments and frequency.
- Use `ON_CALL` to **specify default behavior** for calls that may or may not happen, but without verification.

Best practice:

- Default your mock's behaviors with `ON_CALL` in the mock constructor or test setup.
- Use sparse `EXPECT_CALL`s in your test cases to assert expected interactions.
- Avoid over-constraining tests by adding unnecessary expectations.

---

### 4. What do 'uninteresting', 'unexpected', 'nice', 'naggy', and 'strict' mocks mean?

- **Uninteresting call:** A call to a mock method with *no* matching `EXPECT_CALL` set.
- **Unexpected call:** A call that matches a mock method with some `EXPECT_CALL` but does not satisfy *any* expectation.

**Default behavior:**

- Naggy mocks (default) print warnings for uninteresting calls.
- Nice mocks suppress warnings for uninteresting calls.
- Strict mocks treat uninteresting calls as test failures.

Use `NiceMock<T>` or `StrictMock<T>` wrappers for controlling these behaviors.

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock;  // No warnings on extra calls

using ::testing::StrictMock;
StrictMock<MockFoo> strict_mock;  // Extra calls fail tests
```

---

### 5. How can I specify call sequences or partial order constraints on expected calls?

By default, gMock does not require calls to happen in the order expectations are declared.

- Use `InSequence` to **enforce strict order** of calls within a scope.
- Use `Sequence` objects combined with `.InSequence(seq1, seq2, ...)` on expectations for more complex partial orders.
- Use `.After(expectation)` to specify that a call happens after other specific calls.

Example:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}

Sequence seq1, seq2;
EXPECT_CALL(mock, Init()).InSequence(seq1);
EXPECT_CALL(mock, Run()).InSequence(seq1, seq2);
EXPECT_CALL(mock, Finish()).InSequence(seq2);
```

---

### 6. How do I specify how many times a mock method should be called?

Use `.Times(cardinality)` following `EXPECT_CALL`:

- `Times(0)` means the call is expected never
- `Times(1)` means exactly once
- `Times(AnyNumber())` means any number of calls
- `Times(AtLeast(n))` or `Times(AtMost(n))` can specify bounds

If `.Times()` is omitted, and there are `WillOnce` clauses, gMock infers:
- If *n* `WillOnce`s and no `WillRepeatedly`: `Times(n)`
- If *n* `WillOnce`s and a `WillRepeatedly`: `Times(AtLeast(n))`
- Otherwise: defaults to `Times(1)`

Example:

```cpp
EXPECT_CALL(mock, Foo())
    .Times(2)
    .WillOnce(Return(1))
    .WillOnce(Return(2));
```

---

### 7. How can I handle mock methods returning references or move-only types?

- Use `ReturnRef()` to return a reference from a mock method.
- For move-only types (e.g., `std::unique_ptr`), use lambdas or callables inside `WillOnce` or `WillRepeatedly` to return a new object each time.
- Avoid `Return(std::move(...))` on move-only types more than once as the moved object will be in an invalid state for subsequent calls.

Example:

```cpp
EXPECT_CALL(mock, GetRef())
    .WillOnce(ReturnRef(my_ref));

EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
       return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

---

### 8. How do I verify that my mock expectations have been met before the mock goes out of scope?

By default, gMock verifies expectations when mock objects are destructed.

If your mock is heap-allocated or owned by production code that may not delete it, use:

```cpp
::testing::Mock::VerifyAndClearExpectations(&mock);
```

This forcibly verifies expectations and clears them. Avoid setting further expectations on a mock after verification.

---

### 9. Can I use GoogleMock when mocking methods that are called from multiple threads?

Yes, but with caveats:

- Set expectations and default actions on the mock only when *no other thread* is accessing the mock.
- Calls to mock functions can happen from multiple threads safely.
- Actions will execute in the calling thread.
- Synchronize your actions if they are not thread-safe.

---

### 10. How can I suppress or control the verbosity of gMock warning messages?

Use the `--gmock_verbose=LEVEL` flag, where `LEVEL` can be:

- `info`: prints all informational messages, warnings, and errors (most verbose)
- `warning`: prints warnings and errors (default)
- `error`: prints errors only

You can also set this flag inside tests:

```cpp
::testing::FLAGS_gmock_verbose = "error";
```

---

### 11. What do I do if gMock warns about 'Uninteresting mock function call...'? Should I panic?

No. This warning means a mock method was called without an explicit expectation.

If this is expected, you can:

- Use a `NiceMock<T>`, which suppresses these warnings for that mock object.
- Add an `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` if you want to explicitly allow any calls.

If this warning is unexpected, investigate your test setup or actual calls.

---

### 12. How can I mock non-virtual methods or free functions?

- For non-virtual methods, use template-based dependency injection with unrelated mock classes defining methods with identical signatures.
- For free functions, refactor your code to use an interface wrapper and mock the interface.
- Alternatively, mock `std::function` objects with `MockFunction<R(Args...)>`.

---

### 13. What is the recommended way to avoid brittle tests due to over-constraining expectations?

- Prefer `ON_CALL` to set default behavior.
- Use `EXPECT_CALL` sparingly, only to verify essential interactions.
- Avoid expecting exact call counts or exact sequences unless strictly necessary.
- Use `NiceMock` to tolerate uninteresting calls.
- Add specific expectations for critical methods where interaction correctness matters.

---

### 14. How do I specify actions or behaviors on mock methods?

- Use `WillOnce()` to specify action on the next matching call.
- Use `WillRepeatedly()` for behavior on subsequent calls after `WillOnce`s are exhausted.
- Common actions include `Return(value)`, `ReturnRef(variable)`, `Invoke(functor)`, `SetArgPointee<N>(value)`, `DoAll(...)`, and more.
- Chain multiple `WillOnce()` for sequential call behaviors.

Example:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

---

### 15. How can I simplify mocking signatures that are complex or overload heavy?

- Use a wrapper mock method with trimmed arguments in the mock class and delegate calls.
- This makes expectations and actions easier to write.

Example:

```cpp
class MockLogger : public Logger {
 public:
  void Log(int severity, const char* file, int line, const char* msg) override {
    LogSimple(severity, std::string(file), std::string(msg));
  }
  MOCK_METHOD(void, LogSimple, (int severity, const std::string& file_path, const std::string& message));
};
```

---

### Additional Tips and Best Practices

- **Place all `MOCK_METHOD` macros in the public section.**
- **Add the `override` qualifier where applicable for clarity and safety.**
- **Be mindful of the order of your `EXPECT_CALL`s: the later ones take precedence.**
- **Use `.RetiresOnSaturation()` to make expectations non-sticky and easier to sequence.**
- **Avoid mocking concrete classes unless necessary. Prefer interfaces and adaptors.**
- **To test destruction order, mock a `Die()` method and call it in the destructor.**
- **Run tests with `--gmock_verbose=info` to get insightful call matching logs during debugging.**
- **Use sequences to make call order explicit and your tests more robust.**

---

## Troubleshooting Common Issues

### I get compiler errors about commas in `MOCK_METHOD`. What should I do?

Wrap template types with commas in parentheses or use type aliases to avoid parsing errors.

### My mock method returns a non-copyable or move-only type; how to deal with it?

Use lambdas in `WillOnce` or `WillRepeatedly` to return a new object each time.

### Why do my expectations fail even though the calls seem correct?

Run tests with `--gmock_verbose=info` to see detailed call and matching information. Verify argument matchers and call order.

### Can I mock destructors?

You cannot mock destructors directly. Instead, add a mock method like `Die()` called from the destructor, then expect calls to `Die()`.

### Multiple calls cause warnings about too many actions

Ensure the number of `WillOnce()` clauses does not exceed the expected calls or use `WillRepeatedly()` to define repeating behavior.

---

## Quick Reference Links

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) – Recipes for common mocking scenarios
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) – Macro and class reference
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) – Beginner guide
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) – Handy cheat sheet
- [Core Concepts & Terminology](../overview/architecture-concepts/core-concepts-terminology) – High-level glossary

---

This FAQ page fits in the broader GoogleTest documentation as the go-to guide for users seeking pragmatic, actionable answers about mocking usage, macro nuances, and designing effective mocks with GoogleMock.


