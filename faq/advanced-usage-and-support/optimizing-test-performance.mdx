---
title: "How can I optimize the performance of my test suite?"
description: "Shares best practices for reducing test runtime, leveraging parallelism, optimizing mock usage, and avoiding common pitfalls that slow down test execution."
---

# How can I optimize the performance of my test suite?

Optimizing test suite performance is critical for maintaining fast, reliable development feedback loops and scalable test infrastructure. This page shares best practices and real-world strategies for reducing test runtime, leveraging parallel execution, writing efficient mocks, and avoiding common pitfalls that slow down test execution with GoogleTest and GoogleMock.

---

## 1. Write Focused, Efficient Tests

- **Keep tests small and focused:** Isolate functionality and test only one behavior per test case to avoid expensive setups.
- **Avoid unnecessary dependencies:** Replace heavy dependencies with mocks or fakes to minimize resource consumption.
- **Minimize expensive operations:** Avoid slow operations such as large file I/O, network access, or heavy computations inside tests.

<Tip>
Optimizing your test suite starts with writing lean, purposeful tests. Each test should verify a clear behavior without doing extra work.
</Tip>

---

## 2. Use Mock Objects Wisely

Mocks help isolate the unit under test but can affect compile time and test runtime:

- **Define mocks carefully:** Use `MOCK_METHOD` macros appropriately without overspecification.
- **Use NiceMock, NaggyMock, or StrictMock selectively:** Default mocks are naggy and print warnings on uninteresting calls, which can add overhead.
  - Use `NiceMock` to suppress uninteresting call warnings.
  - Use `StrictMock` to detect unexpected calls impactfully.

- **Avoid heavyweight mocks:** Complex mocked methods or large mock class templates increase compile and runtime costs.
- **Optimize mock expectations:** Use `ON_CALL` for default behaviors and reserve `EXPECT_CALL` only for calls that need verification.
- **Leverage default actions:** Provide sensible default actions with `ON_CALL` to avoid excessive `EXPECT_CALL` setups.

<Note>
Overusing expectations (`EXPECT_CALL`) can slow down tests due to extra runtime verification and matching logic. Prefer `ON_CALL` for unverified default behavior.
</Note>

---

## 3. Manage Test Parallelism

Parallel test execution dramatically reduces wall-clock test duration:

- **Run tests in parallel threads/processes:** Use tools like `gtest-parallel` to distribute test workloads.
- **Shard your test suite:** Break tests into smaller groups or shards to enable parallel distribution in CI.
- **Avoid shared mutable state:** Ensure tests do not depend on global mutable state to avoid race conditions.
- **Isolate expensive resources:** Mock or fake shared dependencies or external systems.

---

## 4. Optimize Test Compilation Time

Large test suites with many mocks or template-heavy code suffer slow compilation:

- **Move mock constructors/destructors to `.cc` files:** Declare but donâ€™t define mock constructors/destructors inline to minimize recompilation.
- **Reduce mock bloating:** Only mock the methods you actually need.
- **Split large test files:** Break monolithic test sources into smaller files.
- **Use precompiled headers (PCH):** Accelerate compilation by including common headers in a PCH.

<Tip>
Defining mock class constructors and destructors out-of-line (in `.cc` files) can significantly reduce compile times when mocks are included in many translation units.
</Tip>

---

## 5. Control Mock Expectations Strictness & Verbosity

- **Adjust strictness modes:**
  - Use `NiceMock<T>` to suppress warnings about uninteresting calls, reducing noise and overhead.
  - Use `NaggyMock<T>` (default) if you want warnings for unexpected usage.
  - Use `StrictMock<T>` to fail fast on unexpected/uninteresting calls, useful in critical testing phases.

- **Modify logging verbosity:**
  - The `--gmock_verbose` flag controls runtime output verbosity.
  - Values: `info`, `warning` (default), `error`. Setting it to `error` reduces logging overhead.

<Note>
Excessive logging during test execution can add latency, so adjust verbosity appropriately for your scenario.
</Note>

---

## 6. Avoid Common Pitfalls That Slow Tests

- **Unintentional multiple expectation overrides:** Later `EXPECT_CALL` statements override earlier ones; structure expectations thoughtfully.
- **Sticky expectations without retiring:** Use `.RetiresOnSaturation()` to retire expectations once saturated to avoid overhead.
- **Overuse of complex matchers:** Complex and computationally heavy matchers can slow down call matching. Simplify where possible.
- **Unnecessary excessive use of sequences:** Restrictive orderings (`InSequence` or `.After`) may force serializations, harming parallelism.

---

## 7. Verify and Clear Mocks to Avoid Leak Overhead

- Use:
  ```cpp
  Mock::VerifyAndClearExpectations(&mock_obj);
  // or
  Mock::VerifyAndClear(&mock_obj);
  ```
  to verify and clear expectations early.
- Leaked mocks generate final test errors and can increase test resource usage.
- Explicitly allow leaks if intentional with `Mock::AllowLeak(&mock_obj);`.

---

## 8. Profiling and Performance Measurement

- Profile your test to identify bottlenecks.
- Use GoogleTest's built-in test time summaries.
- Isolate slow tests and consider mocking or refactoring.

---

## 9. Related Documentation

- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md): Recipes and best practices for mocking.
- [Mocking Best Practices](https://github.com/google/googletest/blob/main/guides/mocking-best-practices/mocking-best-practices.md): Tips for writing efficient mocks.
- [Performance and Test Suite Scaling](https://github.com/google/googletest/blob/main/guides/advanced-and-integrations/performance-scaling.md): Extensive coverage on parallel test execution.
- [Strict, Nice, and Naggy Mocking Modes](reference/gmock-api/strictness-and-mock-behavior.md): How to specify and use different mock strictness levels.

---

## Summary
Optimizing your test suite requires a holistic approach: writing clear, focused tests, managing mocks efficiently, leveraging parallelism, and fine-tuning expectations and verbosity. Avoid common traps like over-specification and unretired expectations to keep tests fast and maintainable. Use the rich tooling and configuration options GoogleTest and GoogleMock provide to measure and improve your test runtime continuously.

---

## Example: Using NiceMock and RetiresOnSaturation for Better Performance

```cpp
#include <gmock/gmock.h>
using ::testing::NiceMock;
using ::testing::Return;
using ::testing::AtLeast;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), ());
  MOCK_METHOD(void, SetValue, (int), ());
};

TEST(FastTest, UsesNiceMock) {
  NiceMock<MockFoo> mock_foo;

  EXPECT_CALL(mock_foo, GetValue())
      .WillRepeatedly(Return(42));

  EXPECT_CALL(mock_foo, SetValue(5))
      .Times(AtLeast(1))
      .RetiresOnSaturation();  // Retires after first saturation

  // Test code exercises mock_foo ...
}
```

This configuration suppresses unnecessary warnings, avoids repeated active expectations after they're saturated, and thus minimizes runtime overhead.

---

For more detailed techniques and guidance, please review the linked guides and references.

---

