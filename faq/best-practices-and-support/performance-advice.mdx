---
title: "How can I write fast and reliable tests?"
description: "Tips for optimizing test performance, minimizing flakiness, and structuring tests for speed and maintainability. Includes recommendations for test isolation and use of fatal/non-fatal assertions."
---

# How can I write fast and reliable tests?

Optimizing test performance and reliability is critical to maintaining an efficient development workflow. This guide focuses on actionable strategies to write tests that execute quickly, minimize flakiness, and remain maintainable over time. By doing so, you not only accelerate your feedback loop but also reduce the overhead of debugging intermittent failures.

---

## 1. Designing Tests for Speed and Reliability

### Test Isolation: The Foundation of Fast, Reliable Tests
Each test should be self-contained and independent. Avoid relying on shared state or external dependencies which can introduce nondeterminism and slow down execution.

- **Use fresh test fixtures:** GoogleTest creates a new test fixture for each test, ensuring a clean slate.
- **Minimize resource sharing:** If you must share resources, use cached or static setups with careful teardown.

### Minimize Test Setup and Teardown Costs
Keep initialization and cleanup lightweight where possible. For expensive setup:

- Use `SetUpTestSuite()` and `TearDownTestSuite()` for shared resources across tests in a suite.
- Avoid unnecessary global initialization to prevent startup delays.

### Avoid Flaky Tests
Flakiness undermines trust in your suite and wastes time.

- Write deterministic tests without hidden dependencies or race conditions.
- When testing multi-threaded code, carefully synchronize expectations (see **Use of Sequences and Partial Ordering** below).

---

## 2. Structuring Tests for Speed and Maintainability

### Use Fatal and Non-fatal Assertions Wisely
GoogleTest provides two types of assertions:

| Type               | Effect                                           | Use Case
|--------------------|-------------------------------------------------|---------
| `ASSERT_*` (Fatal)  | Aborts the current function on failure          | When continuing makes no sense
| `EXPECT_*` (Non-fatal) | Records failure but allows function to continue | When you want to catch multiple failures in a test

**Best Practice:** Use `ASSERT_*` when a subsequent step depends on the success of the previous one to prevent cascading errors.

### Clear, Expressive Tests
Make test failures easy to diagnose:

- Use rich assertion macros like `EXPECT_EQ`, `EXPECT_TRUE`, and GoogleMock matchers.
- Leverage custom failure messages to clarify intent, e.g. `ASSERT_NE(ptr, nullptr) << "Pointer must not be null";`

### Logical Grouping and Naming
Organize tests in suites that reflect the structure of the code. Use descriptive test and suite names to quickly identify failures.

---

## 3. Recommendations for Test Isolation and Concurrency

When your code uses mocks or multi-threading, avoiding race conditions and managing ordering becomes essential.

### Expectations with Sequences and Partial Ordering
GoogleMock provides tools to structure call expectations order:

- **Sequences:** Use `Sequence` to strictly order expectations.
- **Partial order:** Specify ordering across multiple sequences for concurrent threads.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(foo, Bar(0));  // No sequence = can happen anytime
EXPECT_CALL(foo, Bar(1)).InSequence(s1, s2);
EXPECT_CALL(foo, Bar(2)).Times(2*kRepeat).InSequence(s1).RetiresOnSaturation();
EXPECT_CALL(foo, Bar(3)).Times(2*kRepeat).InSequence(s2);
```

This controls the interleaving of calls among threads more predictably.

### Handling Mock Objects Across Threads
Avoid sharing mock objects unsafely across threads.

- Use separate mocks per thread when feasible.
- If sharing mocks, synchronize access or define clear thread-safe behavior.

### Thread Safety of GoogleTest
GoogleTest is thread-safe on platforms supporting pthreads or Windows threads, but be cautious with assertions from multiple threads.

---

## 4. best Practices in Assertions

### Fatal vs Non-fatal Assertions
- Use fatal assertions (`ASSERT_*`) for precondition checks to stop tests early on critical failures.
- Use non-fatal assertions (`EXPECT_*`) to collect multiple failure points within a test without exiting early.

### Propagating Failures from Helper Functions
GoogleTest fatal assertions abort only the current function, not the whole test. Use strategies such as:

- Return early with `if (::testing::Test::HasFatalFailure()) return;` after helper calls.
- Wrap helper calls in `ASSERT_NO_FATAL_FAILURE()`.

Example:

```cpp
void Helper() {
  ASSERT_EQ(1, 2); // Fatal failure aborting Helper()
}

TEST(Foo, Bar) {
  Helper();
  if (HasFatalFailure()) return;  // Prevents running faulty code
  ...
}
```

### Scoping Failure Traces
Use `SCOPED_TRACE` to add context to failures within helper functions or loops, improving diagnosis.

---

## 5. Practical Tips and Common Pitfalls

### Test Flakiness from Concurrency
Data races, unsynchronized mocks, or nondeterministic ordering can cause flaky failures. Use synchronization primitives and sequences to order calls.

### Avoid Expensive Operations in Tests
Tests should be fast. Avoid:
- Disk or network I/O
- Sleeping or waiting longer than needed
- Heavy data setup unless critical

Use mocks and fakes to substitute slow components.

### Use `ON_CALL` to Define Default Mock Behavior
This avoids repeated setup in every test and keeps tests focused on relevant expectations.

### Leverage `RetiresOnSaturation` for Expectation Lifecycle
When an expectation is fulfilled, `RetiresOnSaturation()` stops it from matching further calls, preventing unexpected call failures.

---

## 6. Summary

By:

- Isolating tests and managing resources efficiently,
- Writing clear assertions with appropriate fatality,
- Structuring call expectations carefully for concurrency,
- And preventing flakiness through careful synchronization,

You achieve fast, reliable, and maintainable tests that empower efficient development.

---

## 7. Troubleshooting Common Issues

<AccordionGroup title="Common Testing Performance and Reliability Issues">
<Accordion title="Tests are Slow or Hang">
- Check for expensive setup/teardown operations.
- Avoid long sleeps or network calls.
- Use shared setup with `SetUpTestSuite()` where appropriate.
</Accordion>
<Accordion title="Tests Are Flaky When Run Concurrently">
- Ensure thread-safe use of mocks.
- Use `Sequence` and `InSequence` clauses to control ordering.
- Avoid shared mutable state without synchronization.
</Accordion>
<Accordion title="Assertions Fail Unexpectedly or Are Ignored">
- Confirm use of `ASSERT_*` vs `EXPECT_*` matches intended behavior.
- Use `ASSERT_NO_FATAL_FAILURE` when running subroutine assertions.
- Use `SCOPED_TRACE` to add context.
</Accordion>
</AccordionGroup>

---

## 8. Additional Resources

- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md): Basics of writing tests
- [Advanced GoogleTest Topics](https://github.com/google/googletest/blob/main/docs/advanced.md): Deep dives into assertions and failure handling
- [GoogleMock Documentation](https://github.com/google/googletest/blob/main/docs/reference/mocking.md): For mock method definitions and expectation management
- [Mocking Best Practices](https://github.com/google/googletest/blob/main/guides/mocking-techniques-integration/creating-and-using-mocks.md): Practical advice on using mocks

---

<Check>
To write fast and reliable tests:
- Isolate tests and keep setups lightweight
- Use fatal (`ASSERT_*`) assertions to halt on critical failures
- Use non-fatal (`EXPECT_*`) assertions to gather multiple errors
- Control mock expectations with sequences and order
- Avoid flakiness by synchronizing concurrent tests
- Use `SCOPED_TRACE` for clearer failure context
- Utilize suite-level setup for shared resource efficiency
</Check>

---

## Source
For reference, see the GoogleMock stress test demonstrating concurrent mock usage and managing ordering:

- File: `googlemock/test/gmock_stress_test.cc` ([View on GitHub](https://github.com/google/googletest/blob/main/googlemock/test/gmock_stress_test.cc))

Example snippet controlling ordering with sequences:

```cpp
Sequence s1, s2;
EXPECT_CALL(foo, Bar(2))
    .Times(2 * kRepeat)
    .InSequence(s1)
    .RetiresOnSaturation();
EXPECT_CALL(foo, Bar(3)).Times(2 * kRepeat).InSequence(s2);
```

This illustrates structuring expectations for thread-safe test behavior.

---

For more on assertion handling and propagating failures, consult [Advanced GoogleTest Topics](https://github.com/google/googletest/blob/main/docs/advanced.md#propagating-fatal-failures).


---