---
title: "Test Performance and Optimization Tips"
description: "Shares proven strategies for speeding up test execution, reducing flakiness, and handling large numbers of tests efficiently with GoogleTest and GoogleMock."
---

# Test Performance and Optimization Tips

This page presents proven strategies for speeding up test execution, reducing flakiness, and efficiently managing large test suites using GoogleTest and GoogleMock. It focuses exclusively on practical techniques users can apply to improve their testing workflows.

---

## Frequently Asked Questions

### How can I speed up my GoogleTest test runs?

To make your test suite run faster:

- **Avoid unnecessary set-up and tear-down work:** Use test fixtures efficiently, and reuse expensive resources when possible.
- **Limit use of slow mocks/actions:** Minimize heavy or complex mock behaviors during tests.
- **Group tests logically:** Run faster tests more frequently and longer-running ones less often.
- **Use parameterized tests:** Avoid duplicating similar tests; they save compilation and runtime resources.
- **Run tests in parallel:** Use build system features or CI integration to distribute tests.


### What causes flaky tests in GoogleTest, and how can I reduce flakiness?

Flaky tests often arise from:

- **Tests depending on shared mutable state:** Make tests independent with fresh fixtures.
- **Dependence on timing or asynchronous behavior:** Use mocks to simulate dependencies.
- **Uncontrolled external dependencies:** Mock external calls to isolate behavior.

Mitigation tips:

- Use `NiceMock` to suppress false warnings but avoid hiding real issues.
- Leverage `StrictMock` to catch unexpected calls early.
- Control test order using sequences (`::testing::Sequence`) when call order matters.
- Use `ON_CALL` to set default mock behaviors and `EXPECT_CALL` sparingly to verify essential interactions.


### How do I handle large numbers of tests efficiently?

- **Split the test suite into smaller groups:** Run related tests in batches.
- **Use selective test execution:** GoogleTest supports filtering tests by name or tags.
- **Leverage build system integration:** Tools like Bazel and CMake manage dependencies and incremental builds.
- **Employ parallel test execution:** Maximize CPU usage and reduce wall time.


## Common Performance Optimization Tips

### Use Fixtures Wisely

- Share expensive resources within a test fixture but reset state before/after each test.
- Avoid unnecessary global initialization inside fixtures that run before every test.

### Minimize Mocking Overhead

- Use mocks only where necessary to verify interactions.
- Prefer `ON_CALL` for default behavior instead of heavy `EXPECT_CALL`s everywhere.
- Use `NiceMock` if uninteresting calls are frequent but expected.

### Avoid Over-Specification

- Write matching rules loose enough to allow implementation changes without test breakage.
- Use argument matchers like `_` or `AnyNumber()` for calls you do not need to validate tightly.

### Leverage `WillOnce` and `WillRepeatedly` Properly

- Define expected return values or actions clearly to avoid surprises and overhead.
- Chain `WillOnce()` clauses for sequential return values, `WillRepeatedly()` for defaults.


## Practical Examples

```cpp
// Example: Using NiceMock to reduce noise from uninteresting calls.
using ::testing::NiceMock;

class MockDependency {
 public:
  MOCK_METHOD(void, PerformAction, (), ());
};

TEST(FooTest, DoesNotReportUninterestingCalls) {
  NiceMock<MockDependency> mock_dep;

  EXPECT_CALL(mock_dep, PerformAction());  // Only expect this one

  // Code under test calls other methods that are uninteresting
}
```

```cpp
// Example: Speeding up tests with proper default actions.
ON_CALL(mock_obj, GetValue()).WillByDefault(Return(42));
EXPECT_CALL(mock_obj, GetValue()).Times(AtLeast(1));
```

## Best Practices for Maintaining Test Performance

- Profile test execution to identify bottlenecks.
- Refactor tests periodically to remove redundant mocks or expectations.
- Monitor flaky test patterns and use strictness modes appropriately.
- Use `RetiresOnSaturation()` for expectations that should stop matching after being used.

## Troubleshooting Common Issues

### Tests Run Slowly or Hang

- Check for expensive resource initialization in fixtures.
- Look for unintended infinite loops or deadlocks in mock actions.
- Ensure asynchronous code in tests is handled correctly (e.g., use notifications or callbacks).

### Unexpected or Flaky Mock Failures

- Verify all expectations (`EXPECT_CALL`) are set before exercising tested code.
- Use verbose mode (`--gmock_verbose=info`) to get detailed mock invocation traces.
- Check for interaction mismatches or order dependencies using sequences.

### Compilation Bottlenecks with Large Mocks

- Move mock class constructors and destructors to `.cc` files.
- Simplify mock method signatures when possible.
- Avoid mocking unnecessary methods.

## Additional Tips

- Use `DefaultValue<T>::Set()` judiciously to control mock return values globally.
- Control verbosity during development to reduce noise or increase diagnostics.
- Use `With()` clause in `EXPECT_CALL` or `ON_CALL` to match complex argument combinations efficiently.

## Getting Help & Resources

- Review [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for recipes on custom actions and expectations.
- Consult [Mocking Reference](https://google.github.io/googletest/reference/mocking-framework.html) for API details.
- Participate in community forums and GitHub issues for collective troubleshooting.
- Use the [Support and Community FAQ](https://google.github.io/googletest/faq/support-and-community-faq/where-to-get-help.html) to find official support channels.

---