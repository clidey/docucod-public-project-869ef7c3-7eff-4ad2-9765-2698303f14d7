---
title: "Writing and Using Matchers"
description: "Addresses frequently asked questions on applying built-in and custom matchers, understanding matcher behaviors, and troubleshooting unexpected matcher failures."
---

# FAQ: Writing and Using Matchers in GoogleMock

This FAQ addresses frequently asked questions about 
using GoogleMock's built-in and custom matchers, understanding matcher behaviors,
and troubleshooting unexpected matcher failures.

---

## 1. What is a Matcher and How Do I Use It?

A **matcher** is a predicate-like object used to specify constraints on function arguments in mock expectations or assertions. Use them within `EXPECT_CALL()`, `ON_CALL()`, and the `EXPECT_THAT()` or `ASSERT_THAT()` macros to validate values or arguments.

Matchers can be simple (e.g., `_` matches any value) or complex (e.g., `AllOf()`, `AnyOf()`, or custom matchers).

Example:
```cpp
EXPECT_CALL(mock_object, Method(Ge(5)));  // Matches any argument >= 5.
EXPECT_THAT(value, StartsWith("prefix"));  // Checks string starts with "prefix".
```

---

## 2. How Do I Define Custom Matchers?

GoogleMock provides `MATCHER` macros to write custom matchers simply.

```cpp
MATCHER(IsEven, "") { return (arg % 2) == 0; }
```
Use:
```cpp
EXPECT_CALL(mock, Bar(IsEven()));
EXPECT_THAT(value, IsEven());
```

For parameterized matchers:
```cpp
MATCHER_P(IsDivisibleBy, n, "") { return (arg % n) == 0; }
```
Usage:
```cpp
EXPECT_THAT(value, IsDivisibleBy(3));
```

When providing descriptions that depend on matcher parameters or negation, use string expressions referencing `negation` and parameters.

---

## 3. What Types of Built-in Matchers Are Available?

The built-in matchers cover categories including:

- **Wildcard**: `_`, `A<T>()` matches any value of type `T`.
- **Generic Comparison**: `Eq()`, `Ne()`, `Lt()`, `Le()`, `Gt()`, `Ge()`, `Not()`, `Truly()`, and more.
- **Floating-point**: `DoubleEq()`, `FloatEq()`, `NanSensitiveDoubleEq()`, and their variants supporting approximate and NaN-tolerant comparisons.
- **String**: `StartsWith()`, `EndsWith()`, `HasSubstr()`, `StrEq()`, `StrCaseEq()`, and regex matchers.
- **Container**: `ElementsAre()`, `UnorderedElementsAre()`, `Contains()`, `Each()`, `SizeIs()`, `Pointwise()`, `WhenSorted()`, etc.
- **Pointer and Member**: `IsNull()`, `NotNull()`, `Pointee()`, `Field()`, `Property()`, `Key()`, `Pair()`.
- **Exception**: `Throws<E>()`, `Throws<E>(m)`, `ThrowsMessage<E>(m)`.

See the [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) for a complete list.

---

## 4. How Are Matchers Typed and What if They Don’t Match the Argument Type?

Matchers are statically typed. The compiler can catch mismatch errors if your matcher type doesn’t match the argument type.

- Use `SafeMatcherCast<T>(m)` to cast a matcher `m` safely to a matcher of type `T`. This enforces implicit conversion rules ensuring type safety.

Example:
```cpp
EXPECT_CALL(mock, Func(SafeMatcherCast<Derived*>(base_matcher)));
```
- `MatcherCast<T>(m)` is more permissive but potentially unsafe. Use with caution.

---

## 5. What Are Polymorphic Matchers?

Polymorphic matchers can be used to match arguments of multiple types, adapting to the argument type at compile time. Common examples: `Eq()`, `NotNull()`, and matchers built via `MATCHER` macros.

They behave like matcher factories that instantiate monomorphic matchers depending on argument types.

---

## 6. How Do I Match Multiple Arguments as a Whole?

You may want to apply a matcher to multiple arguments as a tuple using `.With()`. This expects a `Matcher<std::tuple<A1, A2, ...>>`.

Example:
```cpp
EXPECT_CALL(mock, Method(_, _))
    .With(Lt());  // The tuple (arg0, arg1) satisfies Lt()
```

You can also use `AllArgs(m)` synonymously.

---

## 7. How Do Composite and Multi-argument Matchers Work?

Use combinators like:

- `AllOf(m1, m2, ...)` — argument satisfies all matchers.
- `AnyOf(m1, m2, ...)` — argument satisfies any matcher.
- `Not(m)` — argument does not satisfy matcher `m`.

For tuples and multiple arguments, use:

- `Args<N1, N2, ...>(m)` — matcher on a subset of arguments.
- Multi-argument matchers like `Lt()`, `Eq()` on pairs.

---

## 8. How Can I Match Containers?

Several container matchers allow flexible verification:

- `ElementsAre(e0, e1, ...)` — container has these elements in order.
- `UnorderedElementsAre(...)` — elements in any order.
- `Contains(e)` — container contains an element matching `e`.
- `Each(m)` — every element matches `m`.
- `SizeIs(m)` — container size matches `m`.
- `Pointwise(m, container)` — matches elements pairwise using a tuple matcher.

Nested and composite matchers make it easy to validate complex container contents.

---

## 9. How Do I Handle Matching Pointers and Member Fields?

- Use `IsNull()` and `NotNull()` to match null and non-null pointers.
- Use `Pointee(m)` to match the value pointed to by a pointer or smart pointer.
- Use `Field(&Class::field, m)` or `Property(&Class::property, m)` to match fields or properties of objects.
- For `std::pair`, use `Pair(m1, m2)`; for maps, use `Key(m)`.

These matchers handle raw and smart pointers transparently and provide more precise control.

---

## 10. What Are Some Best Practices and Common Gotchas?

- **Specify matchers only as needed**: Over-specification leads to brittle tests.
- **Use `_` matcher to accept any value** when argument values are unimportant.
- **Parameterize matchers** using `MATCHER_P*` macros for reusability.
- **Retire expectations** with `.RetiresOnSaturation()` to avoid “sticky” expectations causing upper-bound violations unexpectedly.
- **Use `SafeMatcherCast` when matching different types** to avoid compiler errors.
- **Avoid side effects inside matcher bodies**; matchers must be pure functions.

---

## 11. What Should I Do When a Matcher Fails Unexpectedly?

- Check if the argument type matches the matcher's expected type.
- Use verbose mode (`--gmock_verbose=info`) to see which expectations matched or didn’t.
- Ensure that expectations are set before exercising the code under test.
- If using sequences or `.After()`, verify call order correctness.
- Review custom matchers for correct matching logic and description.
- Use `ExplainMatchResult()` helper to diagnose matching failures in complex matchers.

---

## 12. Where Can I Find More Information?

- The [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) provides a comprehensive list of all built-in matchers.
- The [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) shows recipes for effective mock and matcher usage.
- The [Writing Your First Test](https://google.github.io/googletest/gmock_for_dummies.html) guide introduces mock usage with matchers.
- For defining custom matchers, see the section on [Writing New Matchers](https://google.github.io/googletest/gmock_cook_book.html#writing-new-matchers-quickly).

---

## 13. Example: Defining and Using a Custom Parameterized Matcher

```cpp
// Define a matcher that checks if a value is within a range [low, high].
MATCHER_P2(InClosedRange, low, high,
           absl::StrCat(negation ? "isn't" : "is", " in range [",
                       PrintToString(low), ", ", PrintToString(high), "]")) {
  return arg >= low && arg <= high;
}

// Usage:
EXPECT_THAT(value, InClosedRange(10, 20));
```

If `value` is outside [10, 20], the failure message clearly indicates the expected range.

---

## 14. Troubleshooting Tips

- **Compiler errors about matcher types?** Use `SafeMatcherCast<T>(matcher)` to fix implicit casting issues.
- **Matcher unexpectedly matches or fails?** Run your test with `--gmock_verbose=info` for detailed call logs.
- **Uninteresting mock function call warnings?** Consider switching to `NiceMock` to suppress warnings.
- **Too many or too few actions in expectations?** Check that the number of `WillOnce()` and `WillRepeatedly()` matches your cardinality (`Times()`), and reorder expectations accordingly.
- **Overloaded methods ambiguous error?** Use `Const()` or `TypedEq<T>()` to disambiguate the overload in your expectation.

---

## 15. Additional FAQ Topics

- [How to create and use mocks](https://google.github.io/googletest/faq/mocking-matchers-usage/creating-mocks.html)
- [Writing your first mock method](https://google.github.io/gmock_for_dummies.html)
- [Setting expectations with ON_CALL and EXPECT_CALL](https://google.github.io/gmock_cook_book.html#Expectations)
- [Using matchers with multiple arguments](https://google.github.io/googletest/reference/matchers.html#multi-argument-matchers)

---

For detailed, authoritative explanations and more examples, explore the official GoogleTest and GoogleMock documentation.


---

### Additional Resources

- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [GoogleTest Mocking Reference](https://google.github.io/googletest/reference/mocking.html)

---

*Happy mocking!*