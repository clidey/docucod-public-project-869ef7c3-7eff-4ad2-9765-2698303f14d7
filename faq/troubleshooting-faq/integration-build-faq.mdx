---
title: "Integrating with existing projects and build systems"
description: "Addresses questions on linking GoogleTest/GoogleMock with CMake, Bazel, and cross-platform builds. Provides solutions for resolving dependency issues, namespace conflicts, and harmonizing with multiple toolchains."
---

# Integrating with Existing Projects and Build Systems

This FAQ addresses common questions and challenges developers face when linking GoogleTest and GoogleMock with popular build systems such as CMake and Bazel. It also tackles cross-platform build considerations, resolving dependency issues, namespace conflicts, and harmonizing usage with multiple toolchains.

---

## 1. How do I integrate GoogleTest/GoogleMock into a CMake-based project?

### Using GoogleTest as a Standalone or Subproject

GoogleTest offers several ways to integrate with CMake:

- **Standalone Build:** Clone GoogleTest, build it separately, and then install it to your system. You can then refer to the installed libraries in your project.

- **Embedding via `add_subdirectory()`:** Incorporate GoogleTest's source code directly into your project's source tree or fetch it during the configure phase using CMake's `FetchContent` module. This approach ensures consistent compiler and linker settings across your main project and tests, avoiding mismatch issues such as debug vs release or dynamic vs static runtimes.

### Example: Embedding with FetchContent

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)

# On Windows, ensure runtime matches
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_test test.cpp)
target_link_libraries(my_test gtest_main)
add_test(NAME my_test COMMAND my_test)
```

This setup:
- Downloads GoogleTest automatically during configuration
- Builds GoogleTest with your project
- Links your test executable against `gtest_main` which supplies a main function
- Registers your test runnable via CTest's `add_test`

### Important Notes

- GoogleTest requires at least **C++17** support. Ensure your project sets appropriate C++ standard flags.
- On Windows, resolving runtime library mismatches is critical. Use the `gtest_force_shared_crt` CMake option to align runtimes (dynamic vs static).

---

## 2. How do I link tests with GoogleMock and GoogleTest?

GoogleMock depends on GoogleTest and provides its own main function variant `gmock_main`. You can:

- Link directly with `gmock_main` to get mocking and testing combined, with a predefined `main`.
- Or link separately with `gmock` and implement your own `main` if you need custom test runners.

Example using CMake:

```cmake
add_executable(my_mock_test mock_test.cpp)
target_link_libraries(my_mock_test gmock_main)
add_test(NAME my_mock_test COMMAND my_mock_test)
```

If you create your own `main`, initialize GoogleMock like this:

```cpp
int main(int argc, char **argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

---

## 3. What if I encounter linking or runtime conflicts between GoogleTest and my project's build settings?

### Common Causes

- **Runtime Library Mismatches on Windows:** By default, Visual Studio links the C runtime dynamically (`MDd`), but GoogleTest links statically (`MTd`). This causes linker errors.

- **Multiple definitions of `main()` function:** Link against both `gtest_main` and provide your own `main()`.

- **Debug vs Release conflicts:** Use consistent build configurations across your project and the GoogleTest libraries.

### Solutions

- Use the CMake option `-Dgtest_force_shared_crt=ON` to make GoogleTest link with dynamic CRT and align with your project.
- Only link to one `main` implementation — either link with `gtest_main` or define your own `main`, but not both.
- Build GoogleTest sources as part of your project to share compiler flags, avoiding ABI incompatibilities.

---

## 4. How do I incorporate GoogleTest with Bazel build system?

GoogleTest provides [Bazel support](https://github.com/google/googletest/tree/main/bazel). To use:

- Add GoogleTest to your `WORKSPACE` as a dependency.
- In your `BUILD` files, declare `cc_test` rules that link with `@com_google_googletest//:gtest_main` or `gmock_main`.

Example Bazel `BUILD` snippet:

```bazel
cc_test(
    name = "my_test",
    srcs = ["my_test.cpp"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

This sets up the test with GoogleTest as dependency managed by Bazel.

---

## 5. How to resolve namespace conflicts or macro clashes?

### Problem
In complex projects, multiple libraries might define macros with identical names, causing conflicts with GoogleTest macros such as `ASSERT_EQ`, `TEST`, etc.

### Solution
Add compile definitions to rename GoogleTest macros, for example:

```cmake
-DGTEST_DONT_DEFINE_TEST=1
```

You then need to prefix GoogleTest macros with `GTEST_` explicitly:

```cpp
GTEST_TEST(MyTestSuite, TestName) {
  GTEST_ASSERT_EQ(1, 1);
}
```

This avoids collision with other libraries defining macros of the same name.

---

## 6. How to manage cross-platform builds for embedded or exotic platforms?

GoogleTest adapts internally to program entry points, like for Arduino-like platforms or QuRT (Qualcomm real-time OS). It provides default main or adapted hooks (e.g., `setup()` and `loop()` for Arduino platforms).

If you are building for an embedded platform:

- Use the provided source files that implement `main()` suitably for your target (`gtest_main.cc` or `gmock_main.cc`).
- If the platform requires custom setup or entry points, integrate initialization accordingly.

---

## 7. What are best practices for consistent integration with multiple toolchains?

- Align compiler and linker flags between GoogleTest and your project to avoid ABI incompatibilities.
- Prefer building GoogleTest sources as part of your project instead of relying on pre-built binaries.
- Use CMake's `add_subdirectory()` or `FetchContent_MakeAvailable()` to embed GoogleTest.
- On Windows, handle runtime library settings explicitly with `gtest_force_shared_crt`.
- For cross-platform portability, always specify C++17 as the minimal standard in your project and GoogleTest build.

---

## 8. Where can I find example configurations and troubleshooting tips?

- The [googletest README](https://github.com/google/googletest/blob/main/README.md) contains clear, step-by-step instructions for CMake build and integration.
- The [Integration and Scalability documentation](https://github.com/google/googletest/tree/main/docs/concepts/integration-scalability) explains build system integration strategies.
- Look at existing projects and Continuous Integration configs that embed GoogleTest.

---

# Troubleshooting Common Integration Issues

### Error: `gtest.lib(gtest-all.obj) : error LNK2038: mismatch detected for 'RuntimeLibrary'`

- Set `gtest_force_shared_crt` to `ON` when adding GoogleTest to your CMake build on Windows.
- Make sure both GoogleTest and your project use the same runtime linkage (dynamic or static).

### Multiple `main()` definitions

- Link against either `gtest_main`/`gmock_main` OR implement `main()` yourself — never both.

### Linker errors for pthread

- If building on “*unix-like” systems without CMake, add pthread explicitly to linker flags (e.g., `-pthread`).

### Macro conflicts with other testing libraries

- Rename GoogleTest macros using `DGTEST_DONT_DEFINE_XXX` macros.

---

# Summary

Integrating GoogleTest and GoogleMock into existing projects and build systems is streamlined using CMake and Bazel support. Embedding the testing framework ensures consistent compilation settings and smoother maintenance, while addressing runtime library mismatches and macro conflicts ensures reliable builds across platforms. For custom or embedded platforms, GoogleTest adapts entry points to match environment constraints.

---

# Further Reading and Resources

- [googletest README.md (CMake Build Instructions)](https://github.com/google/googletest/blob/main/README.md)
- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) — Learn basic usage after integration
- [Integration and Scalability Patterns](https://github.com/google/googletest/tree/main/docs/concepts/integration-scalability)
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) for linking and using gMock
- [Guides on Real-World Integration](https://github.com/google/googletest/tree/main/guides/real-world-guidance/project-integration.md)

---

For specific build errors or platform questions, consult community forums or file issues with detailed build environment descriptions.