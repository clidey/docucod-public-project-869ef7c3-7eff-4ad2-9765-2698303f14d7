---
title: "Mocking and Expectation Failures"
description: "Explains typical causes of failed mocks or unmet expectations, and provides practical steps for identifying, fixing, and preventing these errors. Covers ON_CALL, EXPECT_CALL usage mistakes, and how Google Mock interprets uninteresting calls."
---

# Mocking and Expectation Failures

This FAQ page addresses common causes of mock failures and unmet expectations in Google Mock. It guides you through identifying, understanding, and resolving issues related to incorrect usage of `ON_CALL` and `EXPECT_CALL`, uninteresting calls, unexpected calls, and call ordering problems. By learning these troubleshooting strategies, you will improve your test reliability and ensure your mocks behave as intended.

---

## Frequently Asked Questions

### Why am I seeing errors that a mock method is called more or less times than expected?
If your test complains about a mock method being called too many or too few times, it means the call count constraints set in `EXPECT_CALL` are not met:

- **Too few calls**: The code under test did not invoke the mock method enough times according to your specified cardinality (e.g., `Times(2)`, `AtLeast(1)`).
- **Too many calls**: The method was called more times than allowed (e.g., `Times(1)`) without being disabled or retired.

**How to fix:**

- Check your `.Times()` clauses or allow flexible counts using `AnyNumber()`, `AtLeast()`, etc.
- Use `.RetiresOnSaturation()` to make expectations inactive once fulfilled, preventing errors from extra calls.
- Consider sequencing or ordering constraints if calls depend on a particular order.

### What is the difference between `ON_CALL` and `EXPECT_CALL` and when should I use each?
- **`ON_CALL`** configures the *default behavior* of mock methods when they are called; it does *not* set an expectation for the call to happen.
- **`EXPECT_CALL`** both sets up an expectation that a mock method *will* be called with specified arguments and defines the behavior for such calls.

**Guidance:**

- Use `ON_CALL` for setting up common default responses for your mock.
- Use `EXPECT_CALL` when you want to verify that certain calls happen, with specific arguments, counts, and sequences.

Misusing `ON_CALL` to try to verify calls will not cause failures on missing or extra calls.

### What causes the "uninteresting mock function call" warnings and how can I handle them?
An *uninteresting call* happens when a mock method is invoked but no matching `EXPECT_CALL` was defined for it.

By default, Google Mock:

- Treats uninteresting calls as allowed but issues a warning to catch unexpected calls that might indicate test issues.

You can manage this behavior by:

- Using `NiceMock` to **suppress warnings** on uninteresting calls.
- Using `StrictMock` to **treat uninteresting calls as failures**.
- Adding a catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` to explicitly allow calls.

### Why am I getting unexpected call errors even though I set up `ON_CALL` for that method?
`ON_CALL` sets the default action on a mock method but does *not* declare an expectation that the method will be called.

If your code calls a mock method with arguments that do not match any active `EXPECT_CALL` expectation, Google Mock reports an *unexpected* call.

**To fix this:**

- Add an appropriate `EXPECT_CALL` to cover the call and specify behavior.
- Use a catch-all `EXPECT_CALL` with wildcard matchers to allow calls not explicitly checked.

### How does Google Mock determine which `EXPECT_CALL` matches a method call?
Google Mock tries to find the most recent `EXPECT_CALL` that matches the method name and argument matchers.

- Expectations are searched in reverse order of definition; newer expectations override older ones.
- If multiple expectations match, the *last matching* active expectation handles the call.

This allows you to set up a general expectation early and refine or override it later.

### What does it mean that expectations are "sticky" and how do I manage that?
Expectations are "sticky" by default, meaning they remain *active* even after reaching their expected call count upper bound.

This means:

- After being satisfied, repeated calls to the method will *still* match the same expectation, causing errors for exceeding calls.

To manage stickiness:

- Use `.RetiresOnSaturation()` to make an expectation inactive once saturated.
- Use sequences to order expectations, which implicitly retire earlier ones when successors run.

### How do I ensure calls happen in a specific order?
By default, calls can match expectations in any order.

To enforce ordering, Google Mock provides:

- **`InSequence`**: All expectations in scope are expected in the declared order.
- **`After()` clause**: Declare dependencies so an expectation only matches after other expectations are satisfied.
- **`Sequence` objects**: Assign expectations to sequences to represent partial orders.

Use these tools to reflect your intended call ordering constraints accurately.

### What should I do when I get errors stating "Unexpected mock function call"?
This happens when your code calls a mock method with arguments that don't match any `EXPECT_CALL`.

Steps to resolve:

1. Confirm you have an `EXPECT_CALL` for the method and arguments.
2. Add a catch-all `EXPECT_CALL` with wildcard matchers to cover omitted cases.
3. Verify that argument matchers are correct and not too restrictive.
4. Check call ordering or sequence constraints that may block calls.

### How do I verify or reset a mock's expectations mid-test?
Google Mock automatically verifies expectations upon mock object destruction.

To verify earlier:

```cpp
using ::testing::Mock;
... 
bool success = Mock::VerifyAndClearExpectations(&mock_obj);
EXPECT_TRUE(success);
```

To verify and clear *all* expectations and default actions:

```cpp
bool success = Mock::VerifyAndClear(&mock_obj);
EXPECT_TRUE(success);
```

Note: do *not* set new expectations after verifying and clearing.

### Why do I sometimes see double error messages for failed expectations?
Google Mock reports failed expectations at multiple points in the test lifecycle to provide detailed debugging information covering different states and call instances.

These repeated messages describe the state at the time of error and when verification occurs and are intentional.

### How can I avoid warnings about leaked mock objects?
Google Mock detects mock objects that were never deleted and warns about leaked mocks.

If you intentionally leak a mock:

- Use `Mock::AllowLeak(&mock_obj);` to suppress the warning.

Otherwise, ensure that mocks are properly deleted after usage to allow verification.

### How do I control the verbosity of mock call logs and warnings?
- Use the `--gmock_verbose=` command-line flag with values:
  - `info` : Logs all actions and warnings (most verbose).
  - `warning` : Logs warnings and errors (default).
  - `error` : Logs errors only.

- You can also set verbosity programmatically via:

  ```cpp
  ::testing::FLAGS_gmock_verbose = "error";  // or "info", "warning"
  ```

Set appropriate verbosity to balance helpful information and noise.

---

## Common Issues & Solutions

### 1. Mismatched or Missing Expectations
- Causes: Forgetting to set `EXPECT_CALL` for required calls; using wrong argument matchers.
- Fixes: Add missing `EXPECT_CALL`s; replace literal arguments with wildcard `_` for flexibility.

### 2. Unretired Expectations Causing Failures
- Causes: Expectations are sticky and remain active after saturation.
- Fixes: Add `.RetiresOnSaturation()` to expectations to retire them after use.

### 3. Order-Dependent Failures
- Causes: Calls happen in unexpected order.
- Fixes: Use `InSequence` or `.After()` to specify call order.

### 4. Uninteresting Call Warnings
- Causes: Mock methods called without corresponding `EXPECT_CALL`s.
- Fixes: Use `NiceMock` to suppress warnings or add catch-all `EXPECT_CALL`s.

### 5. Unexpected Call Failures Despite `ON_CALL`
- Causes: `ON_CALL` defines behavior but no expectation; unexpected calls occur.
- Fixes: Add matching `EXPECT_CALL`s or catch-all expectations.

### 6. Confusing Multiple `EXPECT_CALL`s on Same Method
- Causes: Newer expectations override older ones in reverse order.
- Fixes: Define most general `EXPECT_CALL` first, then more specific later.

---

## Best Practices

- **Set expectations *before* code execution.** Defining expectations after calls is undefined behavior.
- **Use argument matchers prudently.** Replace unnecessary literals with `_` to reduce brittleness.
- **Use sequences or `.After()` for ordering when needed.** Prefer partial orders when full ordering is too strict.
- **Avoid over-specification.** Use `ON_CALL` for default behaviors and `EXPECT_CALL` only when verifying a call.
- **Use `RetiresOnSaturation()` to avoid sticky expectations interfering with later calls.**
- **Manage mock strictness** using `NiceMock` to suppress warnings or `StrictMock` to enforce strictness.
- **Add catch-all `EXPECT_CALL`s for methods called multiple times with varying arguments.**

---

## Troubleshooting Steps

<Steps>
<Step title="Verify Mock Method is Virtual">
Google Mock only mocks virtual methods. Ensure the method in the interface is declared virtual.
</Step>
<Step title="Confirm Expectation Setup">
Check that you wrote `EXPECT_CALL` matching the method call and arguments. Use `_` to wildcard match arguments if needed.
</Step>
<Step title="Check Call Order Constraints">
If you use sequences or `.After()`, verify that the order of calls in your code respects them.
</Step>
<Step title="Review Sticky Expectations">
Add `.RetiresOnSaturation()` if an expectation is correct but causes errors on repeated calls.
</Step>
<Step title="Use Verbose Logging">
Run your test with `--gmock_verbose=info` to get detailed logs of matching expectations and calls.
</Step>
<Step title="Add Catch-All Expectations for Uninteresting Calls">
If warnings about uninteresting calls appear, consider adding an `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` for those methods.
</Step>
<Step title="Check for Leaked Mocks">
Ensure your mock objects are deleted properly or use `Mock::AllowLeak(&mock_obj)` if intentional.
</Step>
</Steps>

---

## Related Topics

- [Creating and Using Mocks Guide](https://github.com/google/googletest/blob/main/docs/guides/mocking-best-practices/creating-mocks.md)
- [Writing Expectations and Actions Guide](https://github.com/google/googletest/blob/main/docs/guides/mocking-best-practices/writing-expectations-actions.md)
- [Mock Strictness Documentation](https://github.com/google/googletest/blob/main/docs/api-reference/mock-behavior-config/nice-naggy-strict-mock.md)
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md)

---

## Example: Suppressing Uninteresting Call Warnings with NiceMock

```cpp
using ::testing::NiceMock;
using ::testing::_;

class MockFoo {
 public:
  MOCK_METHOD(void, Bar, (int x), ());
};

TEST(FooTest, Example) {
  NiceMock<MockFoo> mock_foo;

  // No expectations set on Bar(). Calling it won't print warnings.
  mock_foo.Bar(42);
}
```

## Example: Ordering Calls With InSequence

```cpp
using ::testing::InSequence;
using ::testing::StrictMock;

class MockFoo {
 public:
  MOCK_METHOD(void, Init, (), ());
  MOCK_METHOD(void, Run, (), ());
};

TEST(FooTest, CallOrder) {
  StrictMock<MockFoo> mock_foo;
  {
    InSequence seq;
    EXPECT_CALL(mock_foo, Init());
    EXPECT_CALL(mock_foo, Run());
  }

  // The calls below must happen in order.
  mock_foo.Init();
  mock_foo.Run();
}
```
