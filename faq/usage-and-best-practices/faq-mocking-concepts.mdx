---
title: "How Do I Use Mocks Effectively?"
description: "Insightful answers for common questions about designing and using mocks in tests, leveraging GoogleMock's advanced features, and understanding the recommended use of strict, nice, and naggy mocks."
---

# How Do I Use Mocks Effectively?

This FAQ page provides insightful answers to common questions about designing and using mocks effectively in tests. It focuses on leveraging GoogleMock's advanced features, understanding mocking strategies, and using strict, nice, and naggy mocks appropriately. Whether you are defining mock classes, setting expectations, or troubleshooting test behaviors, this guide will help you optimize your use of mocks.

---

### 1. What Are Mocks and When Should I Use Them?

Mocks are objects that simulate the behavior of real objects, allowing you to verify interactions rather than just state. Use mocks when you want to test the interaction between components, such as ensuring a particular method is called with specific arguments or in a certain order.

**Example:**

Suppose you have a `Turtle` interface for drawing, and your program needs to call `PenDown()` before drawing lines. Instead of verifying pixels on a screen, you can mock `Turtle` and expect `PenDown()` to be called:

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  // ... other mock methods ...
};

// In your test:
MockTurtle turtle;
EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
// Exercise your drawing code
```

---

### 2. How Do I Define and Use Mock Methods Correctly?

- Always declare mock methods using `MOCK_METHOD` macro in the `public` section of your mock class, regardless of the access level in the base class.
- The parameters of `MOCK_METHOD` mirror your method's signature.
- If your method is `const`, add `(const)` or `(const, override)` as the 4th parameter to `MOCK_METHOD`.
- For overloaded methods, mock all overloads or use `using` declarations to avoid hiding base methods.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, SetValue, (int x), (override));
  MOCK_METHOD(int, Add, (int a), (override));
  MOCK_METHOD(int, Add, (int a, int b), (override));
  using Foo::Add;  // Bring base overloads into scope
};
```

---

### 3. How Do EXPECT_CALL and ON_CALL Differ, and When Should I Use Each?

- **`ON_CALL`** sets default behavior for mock methods _without_ requiring the call. This is useful for specifying general mock responses.
- **`EXPECT_CALL`** sets an expectation that a method _will_ be called with specified arguments, and defines behavior.

**Recommendation:** Use `ON_CALL` for general default behaviors shared by tests, and apply `EXPECT_CALL` only when you want to verify the call occurs.

**Example:**

```cpp
ON_CALL(mock, Foo(_)).WillByDefault(Return(42)); // Default return
EXPECT_CALL(mock, Foo(5)).Times(1).WillOnce(Return(100)); // Verify call
```

---

### 4. How Does gMock Determine the Number of Expected Calls?

Use the `.Times()` clause to specify how many times a method is expected to be called:

| Cardinality                 | Meaning                                   |
|-----------------------------|-------------------------------------------|
| `AnyNumber()`               | Called any number of times (including 0) |
| `AtLeast(n)`                | Called at least n times                    |
| `AtMost(n)`                 | Called at most n times                     |
| `Between(m, n)`             | Called between m and n times inclusive    |
| `Exactly(n)` or `n`         | Called exactly n times                     |

If omitted, gMock infers cardinality from the presence of `.WillOnce()` and `.WillRepeatedly()` clauses.

---

### 5. How Can I Control the Order of Expected Calls?

By default, calls can occur in any order. To enforce order:

- Use `InSequence` for strictly ordered calls:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Foo(1));
  EXPECT_CALL(mock, Foo(2));
}
```

- Use `.After()` and `.InSequence()` clauses for more complex partial orders.

---

### 6. What Are NiceMock, NaggyMock, and StrictMock? When Should I Use Them?

These wrappers control how gMock reacts to calls on mock methods without expectations (uninteresting calls):

- **NiceMock** suppresses warnings on uninteresting calls.
- **NaggyMock** (the default) prints warnings on uninteresting calls.
- **StrictMock** treats uninteresting calls as errors.

**Best Practice:** Use `NiceMock` by default to avoid noisy output, use `NaggyMock` for debugging, and `StrictMock` only when you want to enforce strict interaction guarantees.

**Example:**

```cpp
NiceMock<MockFoo> nice_foo;  // suppresses warnings
NaggyMock<MockFoo> naggy_foo; // warnings printed
StrictMock<MockFoo> strict_foo; // failures on uninteresting calls
```

---

### 7. How Do I Specify Different Behaviors for Different Argument Patterns?

Since gMock searches expectations backward, later `EXPECT_CALL`s override earlier ones when matching calls.

```cpp
EXPECT_CALL(foo, Bar(_))
    .WillRepeatedly(Return('b'));  // Default
EXPECT_CALL(foo, Bar(Lt(5)))
    .WillRepeatedly(Return('a'));  // Specific for arg < 5
```

A call with argument 3 returns `'a'`, others return `'b'`.

---

### 8. How Can I Perform Multiple Actions When a Mock Method Is Called?

Use `DoAll()` to combine multiple actions executed in sequence; only the final action's return value is returned.

```cpp
EXPECT_CALL(mock, Func(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

This sets an output argument then returns `true`.

---

### 9. How Can I Verify That a Function Is Never Called?

Use `.Times(0)` in `EXPECT_CALL`:

```cpp
EXPECT_CALL(mock, Foo(_)).Times(0);
```

Any call to `mock.Foo()` will cause the test to fail.

---

### 10. What to Do If I See Warning "Uninteresting function call"?

This means a mock method was called without any expectation set for it. This is an **uninteresting call** warning, not an error.

If you intend to allow calls, suppress warnings by:

- Using `NiceMock` for the mock object, or
- Explicitly specifying `EXPECT_CALL(...).Times(AnyNumber())`.

Avoid suppressing warnings by blindly adding `EXPECT_CALL` without intent.

---

### 11. How Can I Debug Why Expectations Are Not Satisfied?

- Run tests with `--gmock_verbose=info` to print detailed logs of mock calls and expectation matching.
- Review call traces to see which expectation matched or failed.
- Ensure method parameters and matcher patterns align with calls.

---

### 12. What is the Rule About “Newer Expectations Override Older Ones”?

gMock searches expectations in **reverse order** (last specified first). This allows you to:

- Set up common or default behaviors early (e.g., in the mock constructor).
- Add more specific, customized behaviors later nearer test logic.

If conflicting expectations exist, the later (more specific) will be matched first.

**Example:**

```cpp
EXPECT_CALL(foo, Bar())  // Default behavior
    .WillRepeatedly(Return(2));
EXPECT_CALL(foo, Bar(5))  // Specialized case
    .WillRepeatedly(Return(1));
```

Calls with argument 5 use specialized return.

---

### 13. How Do I Use ON_CALL to Set Default Behaviors Properly?

- Each `ON_CALL` must be complemented with one `.WillByDefault()` clause.
- When multiple `ON_CALL`s match, the last one takes precedence.
- `ON_CALL` does not set expectations; calls matching only `ON_CALL` are uninteresting unless `EXPECT_CALL` is set.

Use `ON_CALL` in test fixture setup or mock constructors for common behaviors.

---

### 14. Can I Mock Non-Virtual or Static/Global Functions?

- gMock requires methods to be virtual for mocking.
- For non-virtual methods, use template-based techniques or dependency injection.
- For static or global functions, prefer introducing an interface wrapper you can mock.

---

### 15. How Can I Mock Functions That Take or Return Move-Only Types?

- Define mock methods with `MOCK_METHOD` as usual.
- Use lambdas or callables in actions to return or manipulate move-only types.
- Avoid returning a moved object multiple times via `Return(std::move(obj))`.

**Example:**

```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](StringPiece) {
      return std::make_unique<Buzz>(...);
    });
```

---

### 16. How Can I Delegate Calls To a Fake or Real Object?

You can set default actions in your mock that delegate calls to a real or fake instance:

```cpp
ON_CALL(*this, Foo(_))
    .WillByDefault([this](int n) { return real_.Foo(n); });
```

This ensures the mock verifies calls and the real/fake executes the behavior.

---

### 17. How Can I Control When Expectations Retire?

- Normally, expectations are *sticky* and remain active after saturation.
- Use `.RetiresOnSaturation()` to have an expectation retire (become inactive) after its cardinality is saturated.

This prevents conflicts with overlapping expectations.

---

### 18. How Do I Handle Overloaded Methods in Expectations?

- Use the `Const()` wrapper to specify const-qualified overloads.
- Provide explicit argument matchers or use `Matcher<type>()` to disambiguate overloads.

Example:

```cpp
EXPECT_CALL(mock, Overloaded(An<int>()));
EXPECT_CALL(Const(mock), Overloaded(5));
```

---

### 19. How to Set Default Return Values for Types?

Use `DefaultValue<T>::Set()` to specify or override default return values for mock methods returning type `T`.

```cpp
DefaultValue<int>::Set(42);
EXPECT_CALL(mock, GetNumber());
EXPECT_EQ(mock.GetNumber(), 42);
DefaultValue<int>::Clear();
```

---

### 20. What Are Best Practices to Avoid Over-Specifying Tests?

- Use `ON_CALL` liberally for defaults; use `EXPECT_CALL` sparingly only for behaviors you want to verify.
- Avoid specifying matchers too strictly unless necessary.
- Avoid enforcing strict call order unless logically required.
- Use `NiceMock` to reduce noise from uninteresting calls during test development.

---

### Troubleshooting

- **“Method calls real object method instead of mock”:** Ensure the method being mocked is virtual.
- **Warnings about uninteresting calls:** Use `NiceMock` or add generic `EXPECT_CALL(...).Times(AnyNumber())` to suppress false alarms.
- **Expectations not satisfied:** Use `--gmock_verbose=info` to trace what calls gMock receives and how they match expectations.
- **Compiler warnings about const parameters:** Remove top-level `const` qualifiers on parameters in mock methods (MSVC bug).

---

### References

For a deeper dive, consult the following guides and references:

- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Nice, Strict, and Naggy Mocks](https://google.github.io/googletest/reference/mocking.html#NiceStrictNaggy)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Setting Expectations and Actions](https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL)

---

Harness GoogleMock powerfully and judiciously: focus on verifying what truly matters, keep tests resilient, and reduce maintenance overhead by choosing the right mocking strategies for your test workflows.
