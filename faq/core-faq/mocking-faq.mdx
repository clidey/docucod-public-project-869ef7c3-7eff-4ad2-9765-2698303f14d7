---
title: "Using Mocks and Matchers"
description: "Provides answers to common queries on mocking techniques, creating custom matchers, managing expectations, and leveraging GoogleMock’s powerful features for more effective test doubles."
---

# Using Mocks and Matchers

This page provides comprehensive answers to common questions regarding mocking techniques, creating custom matchers, managing expectations, and effectively using GoogleMock’s powerful features to create robust and maintainable test doubles.

---

## 1. What Are Mock Objects and Why Use gMock?

Mock objects simulate interfaces for testing interactions in C++ code, enabling you to:

- Validate calls your code makes to dependencies.
- Specify call order, frequency, and argument expectations.
- Return controlled values or perform custom actions.

GoogleMock (gMock) automates mock generation and provides a domain-specific language (DSL) to fluently express these behaviors.

**Key Concept:** Mocks differ from fakes — mocks check interaction, fakes provide simplified working implementations.

---

## 2. Defining Mock Classes

To create a mock class for an interface:

- Derive from the interface.
- Use the `MOCK_METHOD` macro to define mock methods matching virtual methods.

Example for a `Turtle` interface:

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

Place mock classes where they can best be maintained; for example, alongside the interface or in a dedicated test directory.

---

## 3. Using Mocks in Tests — The Typical Workflow

1. **Import gMock symbols:** use namespace `testing` for clarity.
2. **Create mock objects:** instantiate your mock classes.
3. **Set expectations:** use `EXPECT_CALL` to declare how the mocks should behave and be called.
4. **Exercise code under test:** invoke the module that uses mocks.
5. **Verify expectations:** happens automatically when mocks are destructed.

Example:

```cpp
using ::testing::AtLeast;

TEST(PainterTest, CanDrawSomething) {
  MockTurtle turtle;
  EXPECT_CALL(turtle, PenDown())
      .Times(AtLeast(1));

  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

Expected calls must be set **before** exercising the code — otherwise behavior is undefined.

---

## 4. Setting Expectations with `EXPECT_CALL`

General syntax:

```cpp
EXPECT_CALL(mock_object, MethodName(matchers))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- **Matchers** specify the expected arguments (e.g., `_` for "anything").
- **Cardinality** defines how many times the call is expected:
  - `Times(0)` means "never called."
  - Use helpers like `AtLeast(n)` or `AnyNumber()` for flexible counts.
- **Actions** specify behavior on call:
  - `Return(value)`, `ReturnRef(variable)`, `Invoke(lambda)`, etc.

#### Examples

Expecting at least one call:

```cpp
EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
```

Expecting specific arguments with flexible matching:

```cpp
EXPECT_CALL(turtle, GoTo(50, _));  // First parameter must be 50, second can be anything
```

Define multiple return values:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(200))
    .WillRepeatedly(Return(300));
```

Ordering expectations — strict sequence:

```cpp
{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

---

## 5. Handling Multiple Expectations and Overrides

- gMock evaluates expectations in reverse declaration order — later ones override earlier ones.
- This allows setting generic "catch-all" expectations first, then more specific ones later.

Example:

```cpp
EXPECT_CALL(turtle, Forward(_));            // Catch all forwards
EXPECT_CALL(turtle, Forward(10)).Times(2);  // Specifically expect Forward(10) twice
```

If `Forward(10)` is called more than twice, the third call triggers an error.

Use `RetiresOnSaturation()` to have an expectation automatically retire once matched to limit lifetime.

---

## 6. Working with Uninteresting Calls and Mock Strictness

- **Uninteresting calls:** calls to mock methods without any `EXPECT_CALL` expectations.
- By default, gMock warns about uninteresting calls but does not fail tests.

gMock provides wrappers for controlling uninteresting call behavior:

- `NiceMock<T>`: suppresses warnings on uninteresting calls.
- `NaggyMock<T>`: (default) warns on uninteresting calls.
- `StrictMock<T>`: treats uninteresting calls as test failures.

Example:

```cpp
NiceMock<MockTurtle> turtle;  // Silences uninteresting call warnings
EXPECT_CALL(turtle, PenDown());
// ... test code ...
```

Use strict mocks sparingly; they can make tests more brittle.

---

## 7. Using Matchers to Specify Call Arguments

Matchers provide flexible predicates to specify expected argument values:

- `_` matches any value.
- `Eq(value)` or a bare value matches exact equality.
- `Ge(n)`, `Le(n)`, `NotNull()`, `Pointee(m)`, `AllOf()`, `AnyOf()`, etc. provide expressive matching.

Examples:

```cpp
EXPECT_CALL(foo, DoSomething(Ge(100), _));   // First argument >= 100, second is anything
EXPECT_CALL(foo, DoSomething(Pointee(Eq(5)))); // Pointer argument points to 5
```

Build complex matchers by combining simpler ones, or writing custom matchers using `MATCHER` macros.

---

## 8. Creating Custom Matchers

- Use `MATCHER(name, description)` macro for simple custom predicates.
- Use `MATCHER_P(name, param, description)` for parameterized matchers.

Example: Define a matcher to check divisibility by 7:

```cpp
MATCHER(IsDivisibleBy7, "") { return (arg % 7) == 0; }

EXPECT_CALL(mock, ProcessValue(IsDivisibleBy7()));
```

Provide custom failure messages and streaming for better diagnostics.

---

## 9. Defining Actions for Mock Methods

Actions specify what the mock method does when called:

- Built-in: `Return()`, `ReturnRef()`, `SetArgPointee<index>(value)`, `Invoke()`, `DoAll()`, etc.
- Specify actions in `EXPECT_CALL` using `.WillOnce(...)` and `.WillRepeatedly(...)`.

Example: Returning different values on sequential calls:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

Use lambdas or `Invoke()` to define complex logic or side effects:

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce([](int x) { return x * 2; });
```

Chaining actions with `DoAll()` allows side effects plus return values.

---

## 10. Delegating Calls to Real or Fake Implementations

- Delegate mock method calls to existing implementations to combine behavior validation with actual logic.

Example of delegating to a fake:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Compute, (int), (override));

  void DelegateToFake() {
    ON_CALL(*this, Compute)
      .WillByDefault([this](int x) { return fake_.Compute(x); });
  }

 private:
  FakeFoo fake_;
};
```

Delegate to a parent class' concrete method similarly using `ON_CALL` or in `EXPECT_CALL`.

---

## 11. Tips for Handling Overloaded Methods and Non-Virtual Functions

- Mock each overload explicitly using `MOCK_METHOD` with correct signature.
- Use `using BaseClass::Method;` in mock class to avoid hiding overloaded base methods.
- Non-virtual methods can be mocked by defining an unrelated mock class with matching methods and using compile-time polymorphism.
- For free functions, wrap calls in an interface and mock that interface.

---

## 12. Controlling Test Granularity: Ordering, Cardinalities, and Partial Ordering

- Use `InSequence` scoped block or `Sequence` objects plus `.InSequence` to enforce call order.
- Use `.After()` clauses to express complex ordering dependencies (DAGs).
- Use cardinalities in `.Times()` to specify exactly how many times calls should or should not occur.

Example for partial ordering:

```cpp
Sequence s1, s2;
EXPECT_CALL(foo, A()).InSequence(s1, s2);
EXPECT_CALL(foo, B()).InSequence(s1);
EXPECT_CALL(foo, C()).InSequence(s2);
EXPECT_CALL(foo, D()).InSequence(s2);
```

This means A before B and C; C before D; B and C order independent.

---

## 13. Diagnosing and Debugging Mock Expectations

- Run tests with `--gmock_verbose=info` to trace every EXPECT_CALL and mock call.
- Use IDE integration (e.g., Emacs with `google-compile`) to jump directly to failed expectations.
- Understand warnings about uninteresting calls to detect missing or incomplete expectations.

---

## 14. Managing Mock Object Lifecycle and Verification

- `EXPECT_CALL` expectations are verified automatically when mocks are destructed.
- In long-lived or heap-allocated mocks, call `Mock::VerifyAndClearExpectations(&mock)` to verify explicitly before destruction.
- Use `Mock::AllowLeak(&mock)` to suppress leak detection if deliberately leaking mocks.

---

## 15. Controlling Warning Behavior with Nice, Naggy, and Strict Mocks

- Use `NiceMock` to suppress uninteresting call warnings.
- Use `NaggyMock` (default) to print warnings for uninteresting calls.
- Use `StrictMock` to treat uninteresting calls as errors.

Example:

```cpp
using ::testing::StrictMock;
StrictMock<MockFoo> strict_mock;
EXPECT_CALL(strict_mock, DoThis());
strict_mock.DoThat();  // fails: uninteresting
```

Caveats:

- These wrappers affect only methods directly mocked in the mock class.
- Nesting `NiceMock<StrictMock<Mock>>` is not supported.

---

## References and Related Documentation

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Beginner-friendly introduction to mocking.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Recipes for advanced mocking patterns.
- [Mocking Reference](../api-reference/mocking-framework/mock-objects-and-methods.md) — API reference for mock classes and methods.
- [Matchers Reference](../api-reference/actions-matchers-extensions/matchers-library-and-customization.md) — Full list of built-in matchers and how to create custom ones.
- [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html) — Answers common problems and pitfalls.

For foundational knowledge, see [What is GoogleTest?](../overview/introduction-and-value/what-is-googletest.md) and the [GoogleTest Primer](primer.md).

---

## Quick Tips

- Always set `EXPECT_CALL` **before** exercising the system under test.
- Use wildcards (`_`) judiciously to avoid brittle tests.
- Prefer `ON_CALL` for default behaviors and reserve `EXPECT_CALL` for actual expectations.
- Use `RetiresOnSaturation()` when an expectation should be disabled once it's fulfilled.
- Use `InSequence` to impose strict order only when necessary.
- Use `NiceMock` to suppress noisy uninteresting call warnings.

---

This page empowers you to harness GoogleMock’s full power to create expressive, reliable, and maintainable mock-based tests tailored to your C++ project’s testing needs.