---
title: "Performance & Parallelization Tips"
description: "Answers questions about speeding up tests, running them in parallel, and optimizing execution time using GoogleTest and related community tools."
---

# Performance & Parallelization Tips

This page addresses key strategies and best practices to speed up your test suites, run tests in parallel efficiently, and optimize overall test execution time when using GoogleTest and GoogleMock. By mastering these tips, you can achieve faster feedback cycles, improved resource utilization, and maintain test reliability across large or complex codebases.

---

## 1. Speeding Up Your Test Execution

When tests take too long to run, it slows down development and reduces productivity. Here are actionable ways to improve test speed:

### 1.1 Use Mock Objects to Isolate Code Under Test
Mocks help replace slow or complex dependencies (like databases, file systems, or networks) with lightweight objects. This eliminates external delays and makes tests run almost instantly.

- **Example**: Instead of querying a real database, use GoogleMock to simulate the database interface, defining expected calls and return values.

### 1.2 Avoid Expensive Setup or Tear-down
Heavy initialization or cleanup in test fixtures can drastically increase test time.

- **Tip**: Use global or shared fixtures when possible.
- Use SetUpTestSuite/TearDownTestSuite in googletest to share expensive resources for many tests.

### 1.3 Write Focused Small Tests
Divide large tests into smaller ones focused on specific behaviors to minimize the amount of setup required and speed up execution.

- Smaller tests tend to execute and diagnose failures faster.

### 1.4 Use Efficient Matchers and Actions
Avoid overly complex matchers or actions in mocks that add runtime overhead.

- Prefer simple matchers if detailed validation isn’t necessary.
- Use `WillByDefault` for common behaviors rather than repeated calls to move-only actions that construct resources every time.

---

## 2. Running Tests in Parallel

GoogleTest supports parallel test execution, which can significantly reduce the elapsed test time by leveraging multiple CPU cores.

### 2.1 Shard Your Tests
Divide your test suite into shards that can run independently. Many build systems and test runners support test sharding.

- Use `--gtest_shard_index` and `--gtest_total_shards` to specify the shard of tests to run.

### 2.2 Ensure Test Isolation
To run tests concurrently, each test must:

- Not share global mutable state without synchronization.
- Use proper fixture management to avoid race conditions.
- Use mocks and fakes that are thread-safe or instantiated per test.

### 2.3 Use Thread-safe Mocks
GoogleMock is designed to be safe to use across multiple threads concurrently.

- You can call mock methods and set expectations safely when test logic requires concurrent calls.
- Remember to synchronize tests carefully when verifying call ordering under concurrency.

### 2.4 Beware of Flaky Tests
Tests that fail intermittently under parallel execution usually indicate shared state or synchronization bugs.

- Identify and fix shared resource issues.
- Use synchronization primitives or redesign tests to ensure determinism.

---

## 3. Optimizing GoogleMock Usage for Performance

### 3.1 Use Default Actions Efficiently
`ON_CALL` defines default behavior without requiring a matching expectation. Use it to define fallback behaviors that avoid unnecessary overhead.

- Define broad default actions early (e.g., in test fixture constructors).
- Override default actions for specific cases with `EXPECT_CALL`.

### 3.2 Control Verbosity Flags
GoogleMock outputs helpful diagnostic info, but verbose output can slow down test runs.

- Use the `--gmock_verbose` flag to adjust output verbosity:

  - `info`: prints detailed call traces (useful when debugging but slower).
  - `warning`: default, shows warnings.
  - `error`: minimal output, best for performance-sensitive runs.

### 3.3 Use `RetiresOnSaturation()` When Appropriate
An expectation can be made to retire as soon as it is saturated, reducing matching overhead.

- Use for expectations that will only be matched a limited number of times.

### 3.4 Minimize Excessive Actions
Avoid setting too many `WillOnce` actions unnecessarily, which can slow dispatch.

- Consider using `WillRepeatedly` combined with fewer `WillOnce`s.

### 3.5 Use `NiceMock` or `StrictMock` Wisely
- `NiceMock` suppresses warnings for uninteresting calls, reducing noise.
- `StrictMock` treats uninteresting calls as failures, useful but can slow down debugging.

Choose the mock type that balances performance with feedback requirements.

---

## 4. Advanced Tips for Parallelization and Robust Tests

### 4.1 Use Sequences Carefully
Using `InSequence` enforces call ordering but doesn’t scale well with threads.

- Prefer sequences only when strict order is essential.

### 4.2 Use Partial Ordering with `After` Clause
When full ordering is unnecessary, use partial order dependencies to allow more concurrency.

### 4.3 Avoid Mocking Non-thread-safe Dependencies
If your mocks or underlying dependencies aren’t thread-safe, wrap or isolate them to avoid concurrency issues.

### 4.4 Limit Shared Use of Mocks
Reuse of mocks across threads must be done with care to avoid race conditions.

- Consider per-thread mocks where possible.

### 4.5 Use Thread-Safe GoogleMock Features
GoogleMock provides built-in synchronization to protect internal state, allowing simultaneous calls.

- You can safely set expectations in one thread and invoke mocked methods in another as long as your test logic keeps it consistent.

---

## 5. Troubleshooting Performance and Parallelization Issues

### 5.1 Slow Tests Despite Mocks
- Check if mock expectations or actions use heavy computations.
- Simplify matchers or actions.

### 5.2 Failures Under Concurrency
- Look for unsynchronized shared state outside mocks.
- Use thread sanitizers or race detection tools.

### 5.3 Excessive Logging Slows Tests
- Reduce verbosity with `--gmock_verbose=error`.
- Disable or limit output from mocks.

### 5.4 Deadlocks With Mock Ownership
- Avoid circular references in mocks owning each other.
- Use `Mock::AllowLeak()` cautiously to bypass destruction if necessary.

---

## 6. Example: Running GoogleMock Tests Concurrently

```cpp
// Example showing basic concurrency with GoogleMock
#include "gmock/gmock.h"
#include "gtest/gtest.h"
#include <thread>

class MockFoo {
 public:
  MOCK_METHOD(int, Bar, (int n));
};

void ThreadFunc(MockFoo* mock) {
  ON_CALL(*mock, Bar(_)).WillByDefault(testing::Return(1));
  EXPECT_CALL(*mock, Bar(testing::_)).Times(testing::AtLeast(0));

  for (int i = 0; i < 100; ++i) {
    mock->Bar(i);
  }
}

TEST(ConcurrentMockTest, MultiThreadedCalls) {
  MockFoo mock;

  std::thread t1(ThreadFunc, &mock);
  std::thread t2(ThreadFunc, &mock);
  t1.join();
  t2.join();
}
```

This example shows how mocks can be used safely across multiple threads.

---

## Additional Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Practical recipes for common mocking scenarios, including threading and timing.
- [Mocking Reference](reference/mocking.md): Detailed API and concepts for setup and verification.
- [Performance & Scaling Guide](googletest-guides/integration-and-realworld/performance-scaling.mdx): Broader performance strategies beyond mocking.
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md): Quick reference for macros, matchers, and actions.

---

> For optimal test speed and reliability, plan your mocking strategy to isolate external dependencies, minimize setup cost, and structure tests for parallel execution. Harness GoogleMock's thread-safe mocks and consider test shard execution to leverage available hardware fully.

---

## See Also
- [Writing and Running Your First Test](getting-started/configuration-first-run-validation/first-test)
- [Using Parameterized and Typed Tests](googletest-guides/advanced-testing-patterns/parameterized-tests)
- [GoogleTest and GoogleMock Integration with Build Systems](overview/workflow-integration/integration-build-systems)
- [Troubleshooting Common Setup Errors](getting-started/troubleshooting-common-issues/troubleshooting-setup-errors)


---