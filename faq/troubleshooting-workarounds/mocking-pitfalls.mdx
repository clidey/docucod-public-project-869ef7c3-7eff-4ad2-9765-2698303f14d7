---
title: "Mocking: Pitfalls & Best Practices"
description: "Delivers practical advice for avoiding common mistakes with GoogleMock, such as incorrect use of expectations, uninteresting calls, and best practices for reliable mocks."
---

# Mocking: Pitfalls & Best Practices

GoogleMock is a powerful framework for creating mock objects in C++ tests. However, the flexibility it offers can lead to common mistakes and hard-to-diagnose issues if not used with care. This guide delivers practical advice on avoiding common pitfalls when setting expectations, handling uninteresting calls, managing call sequences, and choosing the right mock strictness levels to create reliable and maintainable tests.

---

## 1. Common Mistakes with Expectations

### a. Ordering and Overlapping Expectations

- **Issue:** Writing multiple `EXPECT_CALL` statements for the same method without understanding the precedence order leads to unexpected matches and confusing failures.
- **Why it happens:** GoogleMock matches calls against expectation rules in reverse order (newest overrides older).
- **Best Practices:**
  - Write more general expectations *first* and more specific ones *last*.
  - Use `.RetiresOnSaturation()` to retire expectations as soon as saturated to avoid sticky expectations causing failures.
  - Use `Sequence` or `InSequence` to enforce order of calls explicitly when order matters.

```cpp
EXPECT_CALL(mock, Func(_)).Times(AnyNumber());  // General catch-all
EXPECT_CALL(mock, Func(5)).Times(2).RetiresOnSaturation();  // More specific
```

### b. Not Setting Cardinalities (`Times()`) Correctly

- **Issue:** Omitting or misusing `Times()` can cause unexpected behaviors:
  - Default is `Times(1)` if no `WillOnce()` or `WillRepeatedly()`.
  - If multiple `WillOnce()` are given but no explicit `Times()`, the count is inferred.
- **Best Practices:**
  - Always clarify `Times()` when your test logic depends on precise call counts.
  - Avoid expecting a method multiple times with varying `WillOnce()` calls but without an explicit `Times()` or proper `RetiresOnSaturation()`.

### c. Ignoring the Difference Between `EXPECT_CALL` and `ON_CALL`

- `EXPECT_CALL` sets an expectation and behavior; the method *must* be called as specified.
- `ON_CALL` sets default behavior without an expectation; method can be called any number of times or not at all.

**Mistake:** Using `EXPECT_CALL` excessively to silence uninteresting call warnings.

**Best Practice:**
- Use `ON_CALL` for default behaviors.
- Add a catch-all `EXPECT_CALL(...).Times(AnyNumber())` only when you explicitly want to permit any calls without failure or warning.


## 2. Managing Uninteresting Calls and Mock Strictness

Uninteresting calls are calls to mock methods without a matching `EXPECT_CALL`. They do not cause test failures by default but generate warnings.

###  a. Mock Strictness Levels

- **NaggyMock (Default Behavior):** Warns on uninteresting calls.
- **NiceMock:** Suppresses warnings on uninteresting calls; useful when you want cleaner test output.
- **StrictMock:** Treats uninteresting calls as errors; ensures all calls are expected.

```cpp
NiceMock<MockFoo> nice_mock;   // ignores uninteresting call warnings
NaggyMock<MockFoo> naggy_mock; // warns on uninteresting calls
StrictMock<MockFoo> strict_mock; // errors on unexpected calls
```

### b. When and Why to Use Each

- **NiceMock:** Recommended for most tests to keep them readable and focused. It reduces noisy warnings.
- **NaggyMock:** Useful during test development or debugging.
- **StrictMock:** Use sparingly when you require tight enforcement of expectations.

### c. Common Pitfall: Unnoticed Unexpected Calls

Even with a NiceMock, calling a method without an `EXPECT_CALL` that has side effects or critical behaviors can hide test failures.

### d. How to Suppress Warnings Safely

- Avoid adding `EXPECT_CALL` silencing warnings without intention.
- Use `NiceMock` or `ON_CALL` for defaults to allow calls without expectation.

### e. Exception: Non-default Constructible Return Types

- If the method returns a type without a default constructor and no `ON_CALL` default is set, an unexpected call may cause exceptions or test crashes.

```cpp
EXPECT_CALL(mock, ReturnSomething()).Times(0);
// Calling mock.ReturnSomething() causes exception if no default action is set.
```

Set a default action explicitly with `ON_CALL` or expect the call.

## 3. Pitfalls with Call Ordering and Sequences

### a. Calls Without Order Constraints Are Matched in Any Order

By default, expectations can be satisfied in any call order. This can cause tests to falsely pass if you care about call order.

### b. Use `InSequence` or `Sequence` to Enforce Ordering

```cpp
using ::testing::Sequence;
Sequence s;
EXPECT_CALL(mock, FirstCall()).InSequence(s);
EXPECT_CALL(mock, SecondCall()).InSequence(s);
```

This enforces `FirstCall()` before `SecondCall()`.

### c. Partial Ordering with Multiple Sequences

You can specify complex call order DAGs by assigning expectations to multiple sequences.

### d. Common Mistakes

- Declaring expectations inside an `InSequence` block but performing calls out of order.
- Misusing `.After()` or `.InSequence()` clauses without understanding precedence.

### e. `.RetiresOnSaturation()` Helps When Chaining Expectations

This helps by retiring an expectation immediately after its upper call count is reached, allowing subsequent expectations to become active and avoid sticky conflicts.

## 4. Best Practices for Reliable Mocks

### a. Use `ON_CALL` to Describe Default Behavior

Set typical/mundane behavior in `ON_CALL` in test fixture or mock constructor, keeping tests concise and focused.

### b. Use Specific `EXPECT_CALL` Only to Verify Important Behavior

Set expectations only where you want to validate calls—do not clutter tests with unnecessary expectations.

### c. Avoid Mixing Expectations and Calls

Set all expectations before exercising your code. Interleaving them will cause undefined behavior.

### d. Use `NiceMock` to Reduce Noise

Suppress irrelevant warnings with `NiceMock`. This enhances focus on real issues.

### e. Use Meaningful Matchers

Match arguments selectively using `_` or other matchers to avoid over-specifying and brittle tests.

### f. Chain `WillOnce` and `WillRepeatedly` Correctly

Specify behaviors for repeated calls carefully. Remember the order of `WillOnce`s matters.

### g. Verify and Clear Expectations When Needed

If you have mocks that outlive the tests or are reused, call `Mock::VerifyAndClear()` or `Mock::VerifyAndClearExpectations()` to reset state and verify expectations explicitly.

```cpp
Mock::VerifyAndClearExpectations(&mock);
// or
Mock::VerifyAndClear(&mock);
```

### h. Be Careful with Move-Only Types

- Use lambdas or callables with `WillOnce` or `WillRepeatedly` for move-only return types.
- Returning move-only values with `Return()` requires care as source moves out on the first call.

## 5. Handling Common Error Scenarios

### a. Too Many or Too Few Actions

- GoogleMock warns when actions specified by `WillOnce` and `WillRepeatedly` don't match the call count.
- Adjust `Times()` accordingly or add/remove actions.

### b. Unexpected Calls

- Occur when a call matches no `EXPECT_CALL`.
- Result in test failures; ensure all expected calls are declared or catch unexpected ones with `Times(0)`.

### c. Uninteresting Calls

- Calls to methods without any `EXPECT_CALL`. May lead to warnings or errors depending on mock strictness.
- Use `ON_CALL` to define default actions or `NiceMock` to suppress warnings.

### d. Calls Out-of-Order

- When call order violates sequence or `After` constraints, tests fail.
- Define sequences carefully or relax order constraints where possible.

### e. Mock Object Leaks

- If mocks allocated on the heap are never deleted, expectations will never be verified.
- Use `Mock::AllowLeak()` explicitly when leaks are intentional, else delete mocks properly to avoid false positives.

## 6. Practical Tips

- Always make destructors of interfaces virtual for mocks to work reliably.
- Avoid nesting `NiceMock`, `NaggyMock`, and `StrictMock` as they are not supported and may cause incorrect behavior.
- Use `EXPECT_CALL(...).Times(0)` explicitly to disallow unwanted calls.
- Use the flag `--gmock_verbose=info` during development to get detailed call traces for debugging expectations and matches.

## 7. Example: Correct Use of `NiceMock` with Expectations

```cpp
using ::testing::NiceMock;
using ::testing::Return;
using ::testing::_;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), ());
  MOCK_METHOD(void, DoWork, (int n), ());
};

TEST(FooTest, Sample) {
  NiceMock<MockFoo> mock;
  ON_CALL(mock, GetValue()).WillByDefault(Return(42));
  EXPECT_CALL(mock, DoWork(5)).Times(1);

  // Code exercising mock
  mock.DoWork(5);
  int val = mock.GetValue();
  EXPECT_EQ(val, 42);
}
```

## 8. Summary

By following these best practices and understanding common pitfalls, you can leverage GoogleMock to write clear, reliable, and maintainable unit tests. Proper expectation setup, using the right mock strictness, understanding call ordering, and carefully managing default actions will lead to smoother testing workflows and more actionable test outcomes.

---

### Related Documentation

- [Mocking Reference](../docs/reference/mocking.md) — Detailed API usage of `EXPECT_CALL`, `ON_CALL`, cardinalities, and classes.
- [gMock Cookbook](../docs/gmock_cook_book.md) — Practical recipes and patterns.
- [Core Concepts & Terminology](../overview/architecture-core-concepts/core-terminology.md) — Understanding mocks in the bigger GoogleTest architecture.
- [Mock Method Macros](../api_reference/mocking_core/mock_method_macros.md) — How to define mock methods.
- [NiceMock, NaggyMock, and StrictMock](../api_reference/mocking_core/nice_naggy_strict_mocks.md) — For controlling uninteresting call behavior.

<Tip>
Consider using `--gmock_verbose=info` while diagnosing failing expectations or unexpected calls. This flag provides detailed information about every mock call and the matching expectations.
</Tip>

<Warning>
Avoid mixing `NiceMock`, `NaggyMock`, or `StrictMock` modifiers on the same class hierarchy; it is unsupported and may cause unexpected behavior.
</Warning>

<Note>
Always set expectations before the code exercises the mock methods to avoid undefined behavior and ensure correct verification.
</Note>

<Info>
Use `.RetiresOnSaturation()` on expectations when chaining multiple calls with sequences or consecutive `WillOnce()` clauses to avoid sticky expectations causing conflicts.
</Info>
