---
title: "How do I integrate with my build system (CMake, Bazel, etc.)?"
description: "Provides answers and proven solutions for integrating GoogleTest and GoogleMock with popular build systems. Outlines recommended practices and common pitfalls for CMake, Bazel, and other build tools."
---

# How do I integrate with my build system (CMake, Bazel, etc.)?

Integrating GoogleTest and GoogleMock with your build system is a critical step in automating testing within your C++ projects. This guide provides practical solutions, best practices, and common pitfalls to make your integration smooth and reliable with popular build tools like CMake and Bazel.

---

## 1. Overview of Build System Integration

The primary goal of integration is to make building, running, and maintaining your tests as easy as possible. You want your test suite to:

- Automatically discover and run all tests.
- Link correctly against GoogleTest and GoogleMock libraries.
- Support optional overriding of main() when needed.
- Respect platform and compiler requirements.

Both GoogleTest and GoogleMock provide pre-built libraries and source files that you can link or compile as part of your project.

---

## 2. Integration with CMake

CMake is the most widely used build system for C++ projects and provides excellent support to integrate GoogleTest and GoogleMock.

### 2.1 Using Installed Libraries via `find_package`

If you have GoogleTest installed on your system, the recommended pattern is:

```cmake
find_package(GTest CONFIG REQUIRED)

add_executable(your_test test_file.cpp)
target_link_libraries(your_test PRIVATE GTest::gtest_main)
add_test(NAME your_test COMMAND your_test)
```

- `GTest::gtest_main` links the GoogleTest library including a provided `main()` function, so you don't need to define your own.
- `add_test()` registers your test executable with CTest to enable running it with `ctest`.

### 2.2 Building GoogleTest as Part of Your Project

If you prefer tight integration ensuring compiler flags and compatibility are aligned (especially important on Windows), you can add GoogleTest as a subdirectory in your CMake project:

```cmake
include(FetchContent)

FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)

# For Windows: avoid runtime mismatch
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(googletest)

add_executable(your_test test_file.cpp)
target_link_libraries(your_test PRIVATE gtest_main)
add_test(NAME your_test COMMAND your_test)
```

This approach downloads the GoogleTest sources at configuration time and compiles them as part of your build. Benefits include compatibility with your project settings and automatic updates.

### 2.3 Linking GoogleMock

GoogleMock depends on GoogleTest and provides additional mocking functionality. To use GoogleMock in CMake:

```cmake
find_package(GTest CONFIG REQUIRED)

add_executable(your_mock_test your_mock_test.cpp)
target_link_libraries(your_mock_test PRIVATE gmock_main)
add_test(NAME your_mock_test COMMAND your_mock_test)
```

- `gmock_main` includes GoogleMock and a ready-to-use `main()` function.
- If you want to provide your own `main()`, link against `gmock` instead.

### 2.4 Important Best Practices

- Always ensure your compiler supports C++17 as GoogleTest requires it.
- Use the appropriate target (`gtest_main` or `gmock_main`) to avoid writing your own `main()` function unless customization is needed.
- On Windows with Visual Studio, use `gtest_force_shared_crt` option to avoid runtime library conflicts.
- Register your tests with `add_test()` for easy execution with CTest.

### 2.5 Common Pitfalls

- Missing include directories or library linking leads to compilation or linker errors.
- Multiple definitions of `main()` cause conflicts when both GoogleTest and your project define entry points. Avoid by linking the correct main library.
- Incompatible compiler flags between your project and GoogleTest cause subtle runtime failures.

---

## 3. Integration with Bazel

Bazel users benefit from a robust, reproducible build system that supports large-scale projects.

### 3.1 Workspace Setup

Add GoogleTest and GoogleMock dependencies in your `WORKSPACE` file, for example:

```python
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.tar.gz"],
    strip_prefix = "googletest-release-1.17.0",
)
```

### 3.2 BUILD File Example

Define your test targets with dependencies on GoogleTest and GoogleMock:

```python
cc_test(
    name = "my_test",
    srcs = ["my_test.cpp"],
    deps = ["@com_google_googletest//:gtest_main"],
)

cc_test(
    name = "my_mock_test",
    srcs = ["my_mock_test.cpp"],
    deps = ["@com_google_googletest//:gmock_main"],
)
```

- Use `gtest_main` or `gmock_main` to link the libraries including `main()`.
- If you want to supply a custom entry point, depend on `gtest` or `gmock` instead.

### 3.3 Running Tests

You can run your tests using Bazel's test command:

```bash
bazel test //path/to:my_test
```

### 3.4 Troubleshooting

- Ensure that workspace and dependencies versions match your installed toolchain and compiler compatibility.
- If tests fail to discover tests, verify Bazel rules and dependencies include GoogleTest targets correctly.

---

## 4. Alternative and Custom Build Systems

If you use other build systems, the general strategy applies:

1. Download or add the GoogleTest and GoogleMock source or libraries.
2. Add Google's include directories to your compiler's include paths.
3. Link against `gtest`/`gtest_main` or `gmock`/`gmock_main` accordingly.
4. Use `RUN_ALL_TESTS()` in your `main()` if you provide one; otherwise, rely on `gtest_main` or `gmock_main` libs for `main()`.

Refer to your build system documentation for linking static or shared libraries and setting include directories.

---

## 5. Understanding `main()` in GoogleTest and GoogleMock

GoogleTest and GoogleMock provide implementation of `main()` in the `gtest_main` and `gmock_main` libraries respectively.

- Linking against `gtest_main` or `gmock_main` gives you a ready-to-run test executable.
- If you link only `gtest` or `gmock` libraries, you must provide your own `main()`.

### Example of default `main()` (from `gmock_main.cc`):

```c++
int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

`InitGoogleMock` initializes both GoogleMock and GoogleTest frameworks and parses flag arguments. After setup, `RUN_ALL_TESTS()` runs all registered tests.

---

## 6. Summary of Recommended Integration Steps

<Steps>
<Step title="Set up your build environment">
Make sure your compiler supports C++17 and your system meets [system requirements](/getting-started/prerequisites-installation/system-requirements).
</Step>
<Step title="Add GoogleTest/GoogleMock sources or binaries">
Use system-installed versions, fetch contents in CMake, or include in Bazel workspace.
</Step>
<Step title="Configure your build files">
Use `find_package` and link GoogleTest libraries in CMake or declare dependencies in Bazel.
</Step>
<Step title="Handle the `main()` function">
Link against `gtest_main`/`gmock_main` for default `main()`, or write your own main function calling `InitGoogleTest()` or `InitGoogleMock()`.
</Step>
<Step title="Register and run your tests">
Use the facility of your build system (e.g., CTest with CMake's `add_test`) to discover and run tests.
</Step>
</Steps>

---

## 7. Troubleshooting Common Issues

<AccordionGroup title="Common Integration Issues">
<Accordion title="Linker errors related to missing symbols or duplicate main()">
- Verify you're linking with exactly one of `gtest_main` or `gmock_main` if you don't provide a `main()`.
- Avoid linking both and defining your own entry point simultaneously.
- Check library search paths and dependency orders.
</Accordion>
<Accordion title="Compilation errors regarding include paths">
- Confirm that you added GoogleTest include directories to your build configuration.
- Using CMake, favorite `find_package` or `FetchContent` approaches handle this automatically.
</Accordion>
<Accordion title="Test discovery failures or zero tests run">
- Ensure you link properly to the test libraries.
- Confirm the test files are compiled and linked into the test executable.
- Use verbose logging flags like `--gtest_list_tests` to verify test registration.
</Accordion>
<Accordion title="Runtime failures or crashes related to mismatched runtime libraries on Windows">
- Use the CMake option `gtest_force_shared_crt` to align your runtime with GoogleTest.
- Consult your compiler and linker documentation to handle runtime library settings.
</Accordion>
</AccordionGroup>

---

## 8. Additional Resources

- [GoogleTest Primer](../docs/primer.md) for detailed getting started steps.
- [Build System Integration Guide](../guides/integration-and-optimization/build-system-integration) for advanced integration workflows.
- [Installation via Bazel](../getting-started/prerequisites-installation/install-via-bazel) for Bazel-specific installation.
- [Common Issue Troubleshooting](../getting-started/troubleshooting-validation/common-issues) for errors and fixes.

---

By carefully following the integration strategies outlined in this guide, users will enjoy automated, reliable, and scalable testing suited to both simple and advanced C++ development workflows.
