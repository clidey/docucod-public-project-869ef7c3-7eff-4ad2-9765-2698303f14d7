---
title: "How Does Mocking Work and What Are Best Practices?"
description: "Addresses common design questions around using GoogleMock, writing mock classes, setting expectations, and handling uninteresting calls. Answers typical integration pain points and anti-patterns."
---

# How Does Mocking Work and What Are Best Practices?

Mocking is an essential technique in unit testing that allows you to replace complex or unavailable parts of your system with controllable substitutes, known as **mock objects**. GoogleMock (gMock) facilitates this in C++ by allowing you to create mock classes and set precise expectations about interactions. This page addresses common design questions, clarifies the user workflow for writing mock classes, setting expectations, handling uninteresting calls, and avoiding anti-patterns.

---

## What Is Mocking in GoogleMock?

Mocking enables you to substitute real objects with test doubles that simulate their behavior. These test doubles:

- Implement the same interface as the real object, so they can be used interchangeably.
- Allow you to specify which methods will be called, with what arguments, how many times, and what they should return.
- Help you validate interactions between modules instead of just their state.

Using mocks, you can isolate your tests from dependencies that are slow, unreliable, or hard to trigger certain states for.

### The Life of a Mock

Your journey with a mock object typically follows these steps:

1. **Define the mock class:** Use the `MOCK_METHOD` macro to declare mock methods corresponding to virtual methods in the interface.
2. **Create mock instances:** Instantiate mock objects in your test code.
3. **Set up default behaviors:** Define default actions your mocks should perform when called using `ON_CALL`.
4. **Set expectations:** Use `EXPECT_CALL` to specify how your mock methods are expected to be invoked.
5. **Exercise your system under test:** Run code that depends on the mocks.
6. **Automatic verification:** GoogleMock verifies that all expectations were met when mock objects are destroyed.

---

## Writing Mock Classes

The cornerstone of mocking in gMock is correctly defining your mock classes.

### Using `MOCK_METHOD`

`MOCK_METHOD` is the macro you use inside your mock class to declare mocked methods:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
};
```

- Place `MOCK_METHOD` declarations in the `public:` section of your mock class, regardless of the original method’s access level.
- Include qualifiers such as `const`, `override`, or `noexcept` if the real method has them.

#### Handling Comma-Separated Types

If the return or argument types include commas (e.g., `std::pair<bool, int>`), wrap the entire type with parentheses or define a type alias:

```cpp
class MyMock {
 public:
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());

  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPairToo, ());
};
```

### Mocking Overloaded Methods

Declare each overload of the mocked method separately, including qualifiers, to clearly distinguish them. You may need to bring base class methods into scope via `using` to prevent hiding.

```cpp
MOCK_METHOD(int, GetSize, (), (const, override));
MOCK_METHOD(string, Describe, (int type), (override));
MOCK_METHOD(string, Describe, (const char* name), (override));
```

### Mocking Class Templates

Templates can be mocked the same way:

```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

### Tips

- Always ensure the base class destructor is virtual.
- If mocking private or protected methods, you must declare mocks as public for external access.

---

## Setting Expectations: What, When, and How Often?

The heart of interaction testing is controlling how and when mock methods are called.

### Using `EXPECT_CALL`

The `EXPECT_CALL(mock_object, method(matchers...))` macro defines an expectation:

- Which mock object and method are involved.
- What arguments are expected, expressed via matchers.
- How many times the method should be called.
- The action the method performs when called.

Example:

```cpp
using ::testing::Return;
EXPECT_CALL(mock_foo, GetSize())
    .Times(3)
    .WillOnce(Return(100))
    .WillOnce(Return(200))
    .WillOnce(Return(300));
```

This expects exactly three calls to `GetSize()`, returning different values each time.

### Understanding Matchers

Match arguments precisely or loosely:

- Use `_` to match any argument.
- Use built-in matchers like `Eq()`, `Ge()`, `Lt()` for specific constraints.
- You can leave out argument lists for unambiguous non-overloaded methods to match any arguments.

### Cardinality Control: `Times()`

Control invocation counts with cardinalities like:

| Cardinality         | Meaning                     |
|---------------------|-----------------------------|
| `AnyNumber()`       | Allow any number of calls    |
| `AtLeast(n)`        | Called at least n times      |
| `AtMost(n)`         | Called at most n times       |
| `Between(m, n)`     | Called between m and n times |
| `Exactly(n)` or `n` | Called exactly n times       |

If omitted, `Times()` is inferred based on actions:

- No actions: `Times(1)`.
- n `WillOnce` clauses, no `WillRepeatedly`: `Times(n)`.
- n `WillOnce` clauses with a `WillRepeatedly`: `Times(AtLeast(n))`.

### Controlling Behavior: `WillOnce()` and `WillRepeatedly()`

- `WillOnce(action)`: defines the behavior for a single call, can be chained multiple times.
- `WillRepeatedly(action)`: defines behavior for all subsequent calls after `WillOnce()`s are exhausted.

Example:

```cpp
EXPECT_CALL(mock_foo, Calculate())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

### Ordering Calls

- By default, expected calls may occur in any order.
- Use `InSequence` to force strict call order:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

- Partial orders can be expressed using `InSequence(sequences...)` and `After()` clauses on expectations.

### Retiring Expectations

By default, expectations remain active after the expected calls are satisfied, causing errors if exceeded. Use `.RetiresOnSaturation()` to automatically retire an expectation once it's fulfilled.

---

## Handling Default Behaviors and Uninteresting Calls

In tests, not every call to mocks needs explicit expectations.

### `ON_CALL` Sets Default Actions Without Expectations

`ON_CALL(mock, method(matchers))` specifies what a mock should do when a matching call is made, without setting an expectation the call must occur.

Example:

```cpp
ON_CALL(mock_foo, GetSize()).WillByDefault(Return(10));
```

### Uninteresting Calls

An **uninteresting call** is a call to a mock method with *no* matching `EXPECT_CALL` expectation.

- Generates a warning to alert the user.
- Does **not** cause test failure by default.
- The mock executes the default action (`ON_CALL` or built-in default).

You can suppress uninteresting call warnings by:

- Using `NiceMock<T>` wrapper to silence warnings for a mock object.
- Setting a catch-all `EXPECT_CALL(...).Times(AnyNumber())` for the method.

### Unexpected Calls

A call that matches one or more expectations but none is active or matches the arguments is an **unexpected call**. These always cause test failures.

---

## Choosing Between NiceMock, NaggyMock, and StrictMock

The handling of uninteresting calls depends on the mock object's strictness mode.

| Mock Type       | Behavior on Uninteresting Calls           |
|-----------------|-------------------------------------------|
| **NaggyMock** (default) | Prints warnings (does not fail tests)   |
| **NiceMock**    | Silences warnings, smooth tests            |
| **StrictMock**  | Fails test on any uninteresting call      |

Wrap your mock instances using these templates as needed:

```cpp
NiceMock<MockFoo> nice_foo;
NaggyMock<MockFoo> naggy_foo;
StrictMock<MockFoo> strict_foo;
```

Notes:

- These wrappers inherit constructors from the underlying mock class.
- They only affect mock methods defined *directly* on the mock class using `MOCK_METHOD`.
- Mixing wrappers (e.g., `NiceMock<StrictMock<...>>`) is not supported.

---

## Best Practices

- **Define mocks for interfaces you own:** Avoid mocking external classes directly unless absolutely necessary.
- **Set expectations *before* exercising code:** `EXPECT_CALL` must precede the code calling mock methods.
- **Be explicit about argument expectations only as needed:** Use wildcards (`_`) liberally to avoid brittle tests.
- **Use `ON_CALL` for general default behavior:** Reserve `EXPECT_CALL` for calls you want to strictly verify.
- **Prefer NiceMock for general compatibility in tests:** Switch to strict mocks only when you need to enforce call restrictions tightly.
- **Use sequences or `.RetiresOnSaturation()` to manage call order or repeat call expectations gracefully.**
- **Avoid over-specifying expectations:** Too many constraints reduce test maintainability.
- **Only mock virtual methods:** To have mock methods work, ensure the methods you want to mock are virtual.

---

## Troubleshooting Common Issues

### Unexpected Real Method Calls

If your mock method calls the real method, check:

- Is the method `virtual`?
- Did you use `MOCK_METHOD` correctly in the mock class?

### Warning About Uninteresting Calls Despite Using `ON_CALL`

- `ON_CALL` sets default behaviors but does *not* enable call expectations.
- To suppress warnings, use `NiceMock` or add `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())`.

### Compiler Warnings With Const Parameters

Some compilers warn about `const` parameters that do not affect function signatures. Only const-qualify pointer or reference types.

### Action and Call Count Mismatches

Ensure the number of `WillOnce` clauses matches expected call counts or provide `WillRepeatedly`.

### Mock Destructors

You cannot mock destructors directly with `MOCK_METHOD`. Instead, define a `Die()` mock method and call it in your destructor to test destructor behavior.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(void, Die, ());
  ~MockFoo() override { Die(); }
};
```

### Slow Compilation

To speed up compiling mocks, move mock class constructors and destructors to `.cc` files to reduce template instantiations.

---

## Example Workflow

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetValue() const = 0;
  virtual void DoSomething() = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, DoSomething, (), (override));
};

TEST(FooTest, ExampleUsage) {
  MockFoo mock_foo;

  ON_CALL(mock_foo, GetValue())
      .WillByDefault(::testing::Return(5));

  EXPECT_CALL(mock_foo, DoSomething()).Times(1);

  // Code under test...
  mock_foo.DoSomething();
  EXPECT_EQ(mock_foo.GetValue(), 5);
}
```

---

For advanced use cases and recipes, see the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html).


---

## Related Resources

- [Defining and Using Mocks](https://google.github.io/googletest/api/gmock_reference/html/index.html) — API Reference
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Beginner Guide
- [Setting Expectations and Actions](https://google.github.io/googletest/reference/mocking.md#EXPECT_CALL) — How to use `EXPECT_CALL` and `ON_CALL`
- [Mock Behavior Modes (Nice, Strict, Naggy)](https://google.github.io/googletest/api/gmock-nice-strict_8h_source.html) — Control uninteresting call handling
- [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html) — Troubleshooting common problems

---

<Tip>
For clearer tests, always set `EXPECT_CALL`s before your code executes and use `NiceMock` to reduce noisy warnings on uninteresting calls.
</Tip>
<Warning>
Avoid mocking non-virtual or static functions directly. Instead, mock interfaces or use other design patterns.
</Warning>