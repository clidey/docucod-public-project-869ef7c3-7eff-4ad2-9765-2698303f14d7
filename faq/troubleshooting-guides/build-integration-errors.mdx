---
title: "Build & Integration Problems"
description: "Step-by-step guidance on diagnosing and fixing common build errors, linker issues, and challenges that arise when integrating GoogleTest/GoogleMock into CMake, Bazel, or other environments."
---

# Build & Integration Problems FAQ

This FAQ provides step-by-step guidance to diagnose and fix common build errors, linker issues, and integration challenges specifically encountered when incorporating GoogleTest and GoogleMock into projects using CMake, Bazel, or other build environments.

---

## 1. Common Build Errors and How to Fix Them

### Why do I get linker errors such as "undefined reference" for GoogleTest or GoogleMock symbols?

This usually means that your test program is not linked against the GoogleTest or GoogleMock libraries correctly.

- **Solution:**
  - Ensure you link your test executable with `gtest`, `gtest_main` (for automatic main), `gmock`, or `gmock_main` as appropriate.
  - For CMake projects, link targets as `target_link_libraries(your_test_target gtest_main)`, or if you're using GoogleMock, `gmock_main`.
  - For Bazel, make sure your `BUILD` file dependencies include `@com_google_googletest//:gmock_main` or `:gtest_main`.

### What if I get multiple definition errors linking GoogleTest or GoogleMock?

Multiple definition errors are often caused by incorrect or multiple linking of sources.

- **Solution:**
  - Avoid compiling the GoogleTest/GoogleMock source files directly in your test targets.
  - Prefer linking pre-built libraries (`gtest`, `gtest_main`, `gmock`, `gmock_main`) provided by your build system.
  - In CMake, avoid adding GoogleTest source files multiple times or mixing static and shared linkage improperly.

### How can I resolve issues with CMake not finding GoogleTest or GoogleMock?

GoogleMock’s CMake support is community driven; the maintainers do not use CMake internally, so some quirks exist.

- **Solution:**
  - When including GoogleMock with CMake, use `add_subdirectory()` to add GoogleMock and GoogleTest sources, for example:

    ```cmake
    add_subdirectory(googletest) # or gmock depending on your source tree
    ```

  - Set `gmock_build_tests` option to `OFF` if you do not want to build GoogleMock's own tests to speed up your build.
  - Ensure your CMake minimum version is at least 3.13.
  - Use the official CMake configuration targets like `GTest::gtest` and `GMock::gmock` if you installed via `make install`.

### Why does linking fail with errors about pthread when building on Linux?

GoogleTest and GoogleMock require linking against `pthread` on Linux when multi-threading support is enabled.

- **Solution:**
  - In CMake, this is handled by GoogleTest's CMake files internally, but if you manually build or use other build systems, link your test binary with `-lpthread`.
  - For custom build systems, explicitly add pthread to your link flags.

### How do I build GoogleMock and tests that use it as shared libraries?

Building shared libraries requires setting the appropriate flags.

- **Solution:**
  - Define `-DBUILD_SHARED_LIBS=ON` when configuring with CMake.
  - For shared GoogleMock, ensure you compile with `-DGTEST_LINKED_AS_SHARED_LIBRARY=1`.
  - Google Mock's CMakeLists.txt supports building `shared_gmock_main` target.

## 2. Integration Challenges with GoogleTest/GoogleMock

### How do I integrate GoogleTest/GoogleMock into my existing CMake project?

- Add GoogleTest and/or GoogleMock as a subdirectory or via `find_package` if installed.
- Link your test targets with the appropriate targets: `gtest_main`, `gmock_main`, `gtest`, or `gmock`.
- Include GoogleTest/GoogleMock headers by adding include directories from these imported targets.

Example:

```cmake
add_subdirectory(googletest)
add_executable(my_test test_main.cc my_test.cc)
target_link_libraries(my_test PRIVATE gtest_main gmock)
```

### Bazel Build Integration Issues

Make sure your BUILD files list correct dependencies, such as:

```bazel
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = ["@com_google_googletest//:gmock_main"],
)
```

This ensures linking with GoogleMock including a main function.

### What about custom build systems?

- You need to include GoogleTest and GoogleMock headers and compile/link the sources or libraries manually.
- Link against required pthread and system dependencies.
- Follow GoogleTest Primer and GoogleMock README for source dependencies.

## 3. Troubleshooting Step-by-Step

### Step 1: Verify Your Build Configuration

- Confirm that GoogleTest and GoogleMock source files or libraries are accessible.
- Verify the correct linking libraries are specified.

### Step 2: Check Compiler and Linker Flags

- Ensure `-pthread` is included on Linux.
- Ensure `-DGTEST_LINKED_AS_SHARED_LIBRARY=1` if linking shared GoogleTest.
- Verify include paths contain GoogleTest/GoogleMock headers.

### Step 3: Inspect Logs and Error Messages

- Look for missing symbols indicating linking errors.
- Check for multiple definition errors indicating duplication.

### Step 4: Simplify Your Build

- Start from a minimal test executable that links only with `gtest_main` or `gmock_main`.
- Gradually add your sources and dependencies.

### Step 5: Consult Documentation and Examples

- Use official CMakeLists.txt files in `googletest` and `googlemock` directories as a reference.
- Review GoogleMock README and GoogleTest Primer for common build setups.

## 4. Best Practices and Tips

- Prefer using GoogleTest’s `gtest_main` or GoogleMock’s `gmock_main` libraries to avoid writing your own `main()`.
- Use CMake's FetchContent to include GoogleTest and GoogleMock sources to ensure consistent compiler flags.
- For Windows, be mindful of runtime library linking (static vs dynamic CRT).
- If you encounter link errors on Windows related to `MSVC`, verify that `cxx_library` and linking are configured correctly.
- Avoid mixing different GoogleTest or GoogleMock versions.

## 5. Example: Minimal CMake Setup for GoogleMock

```cmake
cmake_minimum_required(VERSION 3.13)
project(MyProject CXX)

# Add GoogleMock and GoogleTest
add_subdirectory(path/to/googlemock)

add_executable(my_test test.cc)
target_link_libraries(my_test PRIVATE gmock_main)
```

**Running tests:**

```bash
cmake --build .
ctest
```

## 6. Common Pitfalls and How to Avoid Them

- **Forgetting to link with `gtest_main` or `gmock_main`** causing missing `main()` errors.
- **Misnaming macro `SetUp()` as `Setup()`**, which prevents test fixture setup.
- **Linking GoogleTest sources directly both in your project and GoogleMock**, causing multiple definitions.
- **Using old deprecated `TEST_CASE` macros instead of current `TEST_SUITE` or `TEST` macros.**
- **Not calling `InitGoogleTest()` or `InitGoogleMock()` before `RUN_ALL_TESTS()`.**
- **Not linking pthread on Linux when GoogleTest multi-threading is used.**

## 7. Where to Get Help

- Consult the official [GoogleTest Primer](primer.md) and [GoogleMock README](googlemock/README.md).
- Check community forums, GitHub issues at https://github.com/google/googletest.
- Review the CMakeLists.txt files in GoogleMock repository for advanced build options.

---

### Related Documentation

- [GoogleTest Primer](primer.md) – Understanding basic tests and fixtures
- [GoogleMock README](googlemock/README.md) – Mocking framework overview and setup
- [Troubleshooting Setup Issues](getting-started/support-and-troubleshooting/troubleshooting-setup.md) – Detailed installation and configuration troubleshooting
- [Integrating with Build Systems](guides/real-world-integrations/integrating-with-build-systems.md) – Guide to integrate GoogleTest/GoogleMock with various build tools

---

### Summary Diagram of Build Integration Flow

```mermaid
flowchart TD
    A[Prepare Source Code] --> B[Configure Build System]
    B --> C{Build System Type}
    C -->|CMake| D[Add_subdirectory(googletest & googlemock)]
    C -->|Bazel| E[Add Workspace and BUILD dependencies]
    C -->|Custom| F[Add Sources & Link Libraries Manually]
    D --> G[Target Link Libraries with gtest_main/gmock_main]
    E --> H[Depend on @com_google_googletest//:gmock_main]
    F --> I[Link pthread for Linux]
    G & H & I --> J[Compile and Link Tests]
    J --> K[Run Tests with RUN_ALL_TESTS()]

    classDef step fill:#cce5ff,stroke:#004085,stroke-width:2px;
    class A,B,C,D,E,F,G,H,I,J,K step;
```

---