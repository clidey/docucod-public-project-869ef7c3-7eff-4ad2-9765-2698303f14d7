---
title: "What are the most common mistakes or pitfalls?"
description: "Uncover the typical challenges new users encounter, such as linking errors, macro misusage, version mismatches, or missing dependencies. Find actionable tips and references for avoiding or resolving these issues."
---

# What are the most common mistakes or pitfalls?

This guide uncovers the typical challenges that new users of GoogleMock face when defining and using mocks, such as linking errors, improper use of macros, version incompatibilities, or missing dependencies. Below you'll find actionable advice to avoid or resolve these issues, helping you achieve smooth mocking and reliable tests.

---

## 1. Forgetting to Make Methods Virtual

**Problem:** You define mock methods to override real class methods but forget to declare those methods as `virtual` in the base class.

**Why it matters:** GoogleMock relies on virtual functions to intercept calls. If a method isn't virtual, the real method gets called instead of the mock one, defeating the purpose of mocking.

**How to avoid:**

- Always declare methods as `virtual` in interfaces or base classes you intend to mock.
- Ensure destructors are virtual in base classes to prevent undefined behavior and memory leaks.

**Example:**

```cpp
class Foo {
public:
  virtual ~Foo();  // Make destructor virtual
  virtual int GetSize() const = 0;
};

class MockFoo : public Foo {
public:
  MOCK_METHOD(int, GetSize, (), (const, override));
};
```


## 2. Misusing the `MOCK_METHOD` Macro

**Problem:** Incorrectly specifying the parameters or qualifiers in `MOCK_METHOD` causes compilation failures.

**Common pitfalls:**

- Commas in argument or return types not properly wrapped in parentheses.
- Forgetting to place `MOCK_METHOD` in the public section.
- Omitting required qualifiers like `(const, override)` when overriding const methods.

**How to avoid:**

- Wrap complex types containing commas in extra parentheses: `MOCK_METHOD((std::pair<int,int>), Foo, ());`.
- Always place `MOCK_METHOD` declarations under `public:` regardless of the base class method's access.
- Add required qualifiers explicitly.

**Example:**

```cpp
class MockFoo : public Foo {
public:
  // Correctly mocking a method returning a pair
  MOCK_METHOD((std::pair<int, int>), GetPair, (), (override));
  // Correctly mocking a const method
  MOCK_METHOD(int, GetSize, (), (const, override));
};
```


## 3. Using `EXPECT_CALL` After Exercising the Mock Object

**Problem:** Setting expectations after the mock methods have already been called.

**Impact:** This leads to undefined behavior because expectations must be set before the mock is used.

**How to avoid:**

- Define all `EXPECT_CALL` statements before exercising the system under test.
- Treat `EXPECT_CALL` as a promise about future interactions.

**Wrong:**

```cpp
mock.GetSize();  // Called before expectation
EXPECT_CALL(mock, GetSize());
```

**Right:**

```cpp
EXPECT_CALL(mock, GetSize());
mock.GetSize();
```


## 4. Confusing Uninteresting Calls with Unexpected Calls

**Explanation:**

- **Uninteresting calls:** Calls to mock methods with no expectations set. By default, these generate warnings but not errors.

- **Unexpected calls:** Calls that match some expectations but don't match any specified matcher or violate expectations; these are errors.


**How to handle:**

- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Use `StrictMock<T>` to convert uninteresting call warnings into errors.
- Prefer setting catch-all expectations with `.Times(AnyNumber())` for expected irrelevant calls to avoid warnings.


## 5. Order of Expectation Definitions Matters

GoogleMock matches mock method invocations to expectations in reverse order of declaration. Newly declared expectations override older ones.

**Common pitfall:** More general expectations declared *after* more specific ones can shadow them.

**How to avoid:**

- Place general expectations (e.g., matching any argument with `_`) **before** more specialized expectations.

- Use `InSequence` or `Sequence` objects to enforce call order if required.

**Example:**

```cpp
EXPECT_CALL(mock, Foo(_)).Times(AnyNumber());  // General catch-all
EXPECT_CALL(mock, Foo(42)).Times(1);          // Specific
```


## 6. Leaking Mock Objects Prevents Verification

**Problem:** If mock objects allocated on the heap aren't deleted properly, their expectations are never verified.

**Symptom:** The test appears to pass but leaves leaked mocks, which is usually a bug.

**Detection:** GoogleMock reports leaked mocks at program exit.

**How to avoid:**

- Ensure all heap-allocated mocks are deleted when no longer needed.
- Alternatively, explicitly allow leaks with `testing::Mock::AllowLeak(&mock_obj);` if intentional.


## 7. Setting Default Actions But Still Seeing Warnings

You may configure default behaviors for mock methods using `ON_CALL`, but still see warnings about uninteresting calls.

**Cause:** `ON_CALL` only sets default actions but does **not** indicate that calls are expected.

**How to avoid:**

- Use `EXPECT_CALL(...).Times(AnyNumber())` to express that calls are expected any number of times.
- Or wrap your mock instance in `NiceMock<T>` to suppress warnings on uninteresting calls.


## 8. Not Handling Overloaded Methods Properly

**Issue:** When mocking overloaded methods, ambiguous references to overloads result in compilation errors or unexpected matches.

**How to avoid:**

- Mock all overloaded variants.
- Use `using Base::method;` in the mock class to bring unmocked overloads into scope, avoiding hiding.
- Use gMock utilities like `Const()` to disambiguate const overloads.

**Example:**

```cpp
class MockFoo : public Foo {
public:
  using Foo::Add;  // Bring other overloads into scope
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (double y), (override));
};
```


## 9. Returning References Incorrectly

If mock methods return references, always use `ReturnRef()` instead of `Return()`.

**Example:**

```cpp
MOCK_METHOD(Bar&, GetBar, (), (override));
EXPECT_CALL(mock, GetBar()).WillOnce(ReturnRef(some_bar_instance));
```


## 10. Trying to Mock Free or Static Functions Directly

GoogleMock cannot mock free functions or static methods directly.

**Recommended solution:**

- Wrap free or static functions in an interface with virtual methods.
- Mock the interface instead.


## 11. Confusing `ON_CALL` and `EXPECT_CALL`

- `ON_CALL` sets the **default** behavior without expectation.
- `EXPECT_CALL` sets an expectation that the method **will be called**.

**Pitfalls:** Using `ON_CALL` alone when test intent requires an `EXPECT_CALL` can cause unexpected warnings or silent test gaps.

## 12. Compiler or Toolchain Warnings with Qualifiers

Visual Studio might warn if you declare `const` parameters in function signatures since the top-level const on primitives is ignored by C++ and can cause collision.

**How to avoid:** Strip unnecessary const qualifiers on parameters of primitive types.

## 13. Actions with Side Effects Mistakenly Evaluated Once

Actions passed to `WillOnce` or `WillRepeatedly` are evaluated once when the expectation is defined, not at each call.

**Example mistake:**

```cpp
int n = 0;
EXPECT_CALL(mock, Foo()).WillRepeatedly(Return(n++));  // The increment happens once only
```

**Correct:** Use lambdas that perform actions on each invocation.


## Useful Links and References

- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html): Syntax reference and usage patterns.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Recipes and best practices.
- [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html): Troubleshooting common mocking issues.
- [Mock Object Creation](../api_reference/mocking_and_matchers/mock_object_creation.md)
- [Expectations and Actions](../api_reference/mocking_and_matchers/expectations_and_actions.md)

---

<Tip>
Prevent these common pitfalls by carefully following mocking best practices: always declare mock methods `virtual`, set expectations before mock usage, differentiate between default and expected behaviors using `ON_CALL` vs `EXPECT_CALL`, and manage mock object lifetimes to avoid memory leaks and silent verification skips.
</Tip>

<Note>
Use the GoogleMock verbose flag `--gmock_verbose=info` to get detailed call traces that help debug unexpected or uninteresting call warnings.
</Note>

<Warning>
Never ignore warnings about uninteresting calls outright. Investigate if your test's expectations are incomplete or if the mock behavior needs adjustment.
</Warning>

---

## Summary of Avoidance Steps

<Steps>
<Step title="Ensure Virtual Methods">
Declare all mockable methods, including destructors, as `virtual`.
</Step>
<Step title="Setup Expectations First">
Before using mock objects, set all `EXPECT_CALL` statements.
</Step>
<Step title="Use Proper `MOCK_METHOD` Syntax">
Wrap complex types properly, apply necessary qualifiers, and place macro calls inside the public section.
</Step>
<Step title="Use `NiceMock` or Explicit Expectations for Uninteresting Calls">
Suppress warnings only with purpose using `NiceMock` or `.Times(AnyNumber())` where appropriate.
</Step>
<Step title="Manage Mock Objects Lifetime">
Delete heap-allocated mocks or explicitly allow leaks with `Mock::AllowLeak()`.
</Step>
<Step title="Use Correct Return Actions">
Use `ReturnRef()` for references and lambdas for live values.
</Step>
<Step title="Disambiguate Overloaded Methods">
Mock all overloads and use `using` declarations and wrappers like `Const()`.
</Step>
</Steps>

---

## Troubleshooting Common Errors

<AccordionGroup title="Common Error Scenarios and Resolutions">
<Accordion title="Linker Errors Related to Missing Symbols">
Often due to missing `virtual` destructors or incomplete mock method signatures. Confirm base class methods are virtual and mock methods have correct signatures and correct linkage.
</Accordion>
<Accordion title="Compiler Errors Using `MOCK_METHOD` Macro">
Check for unprotected commas in arguments, missing parentheses around complex types, or misused qualifiers.
</Accordion>
<Accordion title="Uninteresting Mock Function Call Warnings">
Use `NiceMock<T>` or add catch-all expectations with `.Times(AnyNumber())` to suppress warnings when unimportant calls happen.
</Accordion>
<Accordion title="Expectations Not Being Verified">
Verify mock objects are deleted properly, or call `Mock::VerifyAndClearExpectations()` before the test ends.
</Accordion>
<Accordion title="Unexpected Calls or Argument Mismatches">
Run tests with `--gmock_verbose=info` to see call traces and find mismatches in argument matchers.
</Accordion>
</AccordionGroup>

---

## Next Steps

- Review the [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) to solidify syntax knowledge.
- Study [Mocking Best Practices](../guides/scenarios-patterns/mocking-best-practices.md) to learn how to write stable, maintainable tests.
- Explore the [Expectations and Actions Reference](../api_reference/mocking_and_matchers/expectations_and_actions.md) for advanced test behaviors.


---