---
title: "Best Practices for Writing and Running Tests"
description: "Answers to frequent questions on designing, structuring, and running tests efficiently. Covers the use of core assertions, test discovery, using test macros, and organizing tests for maintainability."
---

# Best Practices for Writing and Running Tests

Efficient testing is crucial for maintaining high-quality software that is both reliable and easy to modify. This guide provides actionable best practices to help you design, implement, and run tests effectively using GoogleTest and GoogleMock.

---

## 1. Designing Your Tests

### Focus on Test Purpose

- Write tests that verify **one specific behavior or property** at a time.
- Avoid over-constraining tests; only verify what's necessary to prevent brittleness.

### Name Your Tests Clearly

- Use descriptive test and test suite names that convey intent.
- Good naming greatly assists debugging and maintenance.

### Prefer Small, Fast Tests

- Aim for unit tests that run quickly and isolate behaviors.
- Faster tests encourage more runs and immediate feedback.

---

## 2. Organizing Your Test Suites

### Group Related Tests

- Use test suites (`TEST_F` or `TEST_P`) to group logically related tests.
- Common setup/teardown logic should go into fixtures to avoid duplication.

### Use Parameterized and Typed Tests When Applicable

- When testing a function with many inputs, use [value-parameterized tests](https://google.github.io/googletest/reference/testing.html#value-parameterized-tests) (`TEST_P`) to reuse test code.
- For templated code or type-specific variations, use typed tests (`TYPED_TEST`).

### Keep Tests Independent

- Avoid dependencies between tests; each should be self-contained and order-independent.

---

## 3. Writing Effective Assertions

### Use the Right Assertion Macros

- Use `EXPECT_*` for non-fatal failures that allow the test to continue.
- Use `ASSERT_*` when a failure should abort the test (e.g., prerequisites).

### Leverage Matchers for Richer Validation

- Use GoogleTestâ€™s matcher library to write expressive, readable assertions, e.g., `EXPECT_THAT(x, Contains(...))`.
- Custom matchers can clarify intent and improve failure diagnostics.

### Avoid Over-Checking

- Test only the externally visible behavior.
- Resist including internal implementation details in assertions to improve test resilience.

---

## 4. Mocking and Test Doubles

### Use Mocks to Verify Interactions

- Use `EXPECT_CALL` to specify expected method calls, arguments, and call counts.
- Use `ON_CALL` to define default behaviors without enforcing call expectations.

### Manage Strictness Appropriately

- Use `NiceMock` to suppress warnings on uninteresting calls during development.
- Use `StrictMock` sparingly when you want all unexpected calls to cause test failures.

### Use Sequences and Ordering When Necessary

- Use `InSequence` to specify that mock calls must occur in order.
- Use `After` and multiple sequences to enforce partial orderings.

### Retiring Expectations

- Call `.RetiresOnSaturation()` when you want an expectation to become inactive after its calls are saturated, allowing fallback to other expectations.

---

## 5. Running and Managing Tests

### Run Frequently and Early

- Integrate tests into continuous integration systems.
- Quick feedback from small, fast tests reduces debugging time.

### Use Filtering and Sharding

- Use GoogleTest filters (`--gtest_filter`) to run specific tests.
- Use test sharding to run subsets of tests in parallel for faster feedback.

### Handle Failures Effectively

- Use the `--gmock_verbose` flag (`info`, `warning`, `error`) to control test output verbosity especially for mock debugging.
- Investigate failure messages carefully; the test failure paths include source info.

### Verify and Clear Mocks When Needed

- Use `Mock::VerifyAndClearExpectations(&mock_obj)` to force eager verification before destruction.
- Avoid setting new expectations on mocks after verifying and clearing.

---

## 6. Tips and Common Pitfalls

### Expectation Setup Timing

- Set `EXPECT_CALL` and `ON_CALL` expectations **before** exercising the code under test.
- Never set expectations after mock methods have already been invoked.

### Avoid Over-Specifying Calls

- Use wildcards (`_`) for arguments you don't care about.
- Use cardinalities like `Times(AnyNumber())` for calls that can happen any number of times.

### Use Default Actions Wisely

- Specify default actions via `ON_CALL` for common behavior.
- Only use `EXPECT_CALL` when you want to verify calls.

### Suppress Uninteresting Call Warnings Carefully

- Switch mocks to `NiceMock` to suppress warnings about uninteresting calls.
- Alternatively, add catch-all expectations with `Times(AnyNumber())` when needed.

### Beware of Mock Object Lifetime

- Ensure mock objects are properly destructed to trigger verification.
- Use `Mock::AllowLeak(&mock_obj)` if you intentionally want to avoid verification, but only with good reason.

---

## 7. Troubleshooting

### Test Not Running?

- Confirm test names follow `TEST` or `TEST_F` macros and are linked correctly.
- Ensure `main()` is properly set up or use `gtest_main` library.

### Unexpected Mock Call Failures

- Use `--gmock_verbose=info` to trace how calls match expectations.
- Check argument matchers and call order.
- Ensure all expected calls are set before test execution.

### Compilation Issues with Mock Classes

- If compiler errors arise due to commas in types, wrap the types in extra parentheses or use type aliases (see [MOCK_METHOD docs](reference/mocking.md#MOCK_METHOD)).

---

## 8. Further Reading and Resources

- [GoogleTest Primer](primer.md) - For understanding basic test writing
- [Mocking for Dummies](gmock_for_dummies.md) - Beginner guide to mocking
- [gMock Cookbook](gmock_cook_book.md) - Recipes for common mocking patterns
- [Matchers Reference](reference/matchers.md) and [Actions Reference](reference/actions.md) - For expressive expectations
- [GoogleTest Troubleshooting](getting-started/troubleshooting-and-help/troubleshooting-installation.md)

---

## 9. Example: Writing a Clear Test with Mocks

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;
using ::testing::_;
using ::testing::InSequence;

class Foo {
 public:
  virtual ~Foo() = default;
  virtual int GetValue(int x) = 0;
  virtual void Display() = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (int x), (override));
  MOCK_METHOD(void, Display, (), (override));
};

TEST(FooTest, ValidatesMockBehavior) {
  MockFoo mock;
  EXPECT_CALL(mock, GetValue(_))
      .WillRepeatedly(Return(42));

  {
    InSequence s;
    EXPECT_CALL(mock, Display());
    EXPECT_CALL(mock, GetValue(10));
  }

  mock.Display();       // Must be called before GetValue(10)
  EXPECT_EQ(mock.GetValue(5), 42);  // Returns default value (42)
  EXPECT_EQ(mock.GetValue(10), 42); // Ordered after Display()
}
```

This test:

- Sets a default return value for `GetValue` via `WillRepeatedly`.
- Specifies a strict call order using `InSequence`.
- Uses wildcards to match any argument (`_`) where appropriate.

---

<Tip>
Regularly refactor your tests as you do production code to keep them maintainable and easy to understand.
</Tip>

<Note>
Always set your expectations (`EXPECT_CALL`) before your code under test runs to avoid undefined behavior.
</Note>