---
title: "How does mocking work in GoogleMock?"
description: "Understand the concept of mocking, expectations, and how GoogleMock enables you to simulate and verify interactions in your C++ tests. Find out when and why you should use mock objects."
---

# How Does Mocking Work in GoogleMock?

Understand the concept of mocking, expectations, and how GoogleMock enables you to simulate and verify interactions in your C++ tests. Discover when and why you should use mock objects to design better tests and verify interactions precisely.

---

## What Is Mocking?

Mocking is a technique that lets you create **mock objects** which simulate real objects by providing controlled behavior and recording how they are used. This is crucial for:

- Isolating the unit under test by replacing complex or slow dependencies
- Verifying interactions — that certain methods are called with expected arguments, orders, and frequency
- Modeling error conditions that are hard to reproduce

Unlike fakes, which provide a simplified working implementation, mocks are pre-programmed with *expectations* describing their expected usage.

## Defining Mock Classes

In GoogleMock, you define mock classes by inheriting an interface or base class and declaring `MOCK_METHOD` macros for each virtual method to mock.

### The `MOCK_METHOD` Macro

This macro generates mock implementations for your methods. The syntax is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- **ReturnType:** The function's return type.
- **MethodName:** The method's name.
- **Args...:** The parenthesized argument types.
- **Qualifiers (optional):** Like `(const, override)`, `noexcept`, or calling conventions.

Example:

```cpp
#include <gmock/gmock.h>

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Handling Complex Types and Overloads

- Wrap types with commas in extra parentheses or use type aliases to avoid parsing errors.
- Mock overloaded methods by defining all variants and use `Const()` to disambiguate const overloads.

## Using Mock Objects in Tests

Mock objects are used to:

1. **Set expectations** about which methods will be called, with what arguments, how many times, and in which order.
2. **Specify behavior** for called methods (what they return or side effects).
3. **Verify** those expectations automatically when the mock object is destroyed.

### Setting Expectations with `EXPECT_CALL`

The main mechanism to express your expectations is `EXPECT_CALL`:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `mock_object`: the mock instance.
- `Method(matchers...)`: the method name and argument matchers specifying expected call arguments. Use `_` to match any value.
- `.Times()`: how many times the method is expected to be called.
- `.WillOnce()/.WillRepeatedly()`: the action(s) to perform when the call occurs (e.g., return a value).

Example:

```cpp
using ::testing::Return;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown())
      .Times(1);
  EXPECT_CALL(turtle, GetX())
      .WillOnce(Return(10));

  Painter p(&turtle);
  p.DrawCircle(0, 0, 5);
}
```

### Matchers

GoogleMock supports a sophisticated matcher system to specify argument constraints, from simple value matching (`Eq(5)`) to complex predicates (`AllOf()`, `Field()`, custom matchers).

If you don't care about an argument, use the wildcard matcher `_`.

### Cardinalities

Control how many times a call is expected using `Times()` with options such as:

| Cardinality    | Description                             |
|----------------|---------------------------------------|
| `Exactly(n)`   | Called exactly n times                  |
| `AtLeast(n)`   | Called at least n times                 |
| `AtMost(n)`    | Called at most n times                  |
| `Between(m,n)` | Called between m and n times inclusive |
| `AnyNumber()`  | Called any number of times              |

If `.Times()` is omitted, GoogleMock infers it based on `WillOnce()` and `WillRepeatedly()`.

### Specifying Behavior with Actions

By default, mock methods return default values where applicable:

- `void` functions do nothing.
- Numeric types return zero.
- `bool` types return false.

You can override behavior:

- `.WillOnce(Return(value))` to return a value just once.
- `.WillRepeatedly(Return(value))` to keep returning the same value.
- Use lambdas or `Invoke()` to plug in custom functions.

Example:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

Calls return 100, then 150, then 200 for subsequent calls.

### Actions with Side Effects

You can perform side effects during calls using built-in actions like `SetArgPointee<N>(value)` to set pointer arguments or compose multiple actions using `DoAll()`.

## Default Behavior with `ON_CALL`

`ON_CALL` declares the *default* behavior of mock methods but does **not** set any expectation that the method will be called.

Use it to:

- Define default return values or side effects used when no specific expectation matches.
- Avoid over-constraining tests when you don't care if a method is called or not.

Example:

```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(0));
```

If a matching `EXPECT_CALL` exists, it takes precedence over `ON_CALL`.

## Managing Uninteresting Calls: Nice, Naggy, and Strict Mocks

GoogleMock has three levels of strictness for uninteresting calls (calls without matching `EXPECT_CALL`):

- **NaggyMock** (default): warns on uninteresting calls.
- **NiceMock**: suppresses warnings for uninteresting calls.
- **StrictMock**: treats uninteresting calls as test failures.

Example usage:

```cpp
NiceMock<MockTurtle> nice_turtle;
StrictMock<MockTurtle> strict_turtle;
```

Choose according to how strict you want tests to be about unexpected interactions.

## Ordering and Sequences

By default, expectations can be fulfilled in any order. To enforce call order:

- Use `InSequence` block to group `EXPECT_CALL`s:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, A());
  EXPECT_CALL(mock, B());
}
```

Here, call to `A()` must occur before `B()`.

- Use `After()` and `InSequence()` clauses to define partial orderings of expectations.

## Retiring Expectations

By default, expectations are *sticky* — they remain active after saturation (maximum call count reached), causing errors on extra calls.

Use `.RetiresOnSaturation()` to retire expectations as soon as saturated, allowing other expectations matching later calls.

## Verifying and Resetting Mocks

GoogleMock verifies expectations automatically at mock destruction.

You can force early verification using:

```cpp
Mock::VerifyAndClearExpectations(&mock_obj);

Mock::VerifyAndClear(&mock_obj);  // also clears default actions
```

Do **not** add expectations after calling `VerifyAndClear...`.

## Common Pitfalls & Best Practices

- Always set expectations before exercising code that triggers mock calls.
- Use `ON_CALL` for default behavior; only use `EXPECT_CALL` when you want to verify calls.
- Be mindful of sticky expectations and retire them explicitly when needed.
- Use matchers to avoid brittle tests caused by too strict argument matching.
- Suppress unwanted warnings with `NiceMock` if uninteresting calls are expected.

---

## Summary

GoogleMock’s mocking works by letting you define mock classes with `MOCK_METHOD` macros, then setting expectations (`EXPECT_CALL`) and default behaviors (`ON_CALL`) on the mock methods. These let you precisely simulate and verify interactions in your tests — including call counts, argument matching, return values, call order, and side effects — all within an expressive syntax. Managing uninteresting calls via `NiceMock`, `NaggyMock`, or `StrictMock` tunes the strictness of your tests.

---

## Example Full Test

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;
using ::testing::AtLeast;

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenDown() = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(PainterTest, DrawsCircle) {
  MockTurtle mock_turtle;

  ON_CALL(mock_turtle, GetX())
      .WillByDefault(Return(0));

  EXPECT_CALL(mock_turtle, PenDown())
      .Times(AtLeast(1));
  EXPECT_CALL(mock_turtle, GetX())
      .WillOnce(Return(10));

  Painter painter(&mock_turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 5));
}
```

## Related Links

- [Mocking Basics Guide](https://google.github.io/googletest/guides/core-workflows/mocking-basics.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [GoogleMock Nice, Strict, and Naggy](https://google.github.io/googletest/gmock_cook_book.html#NiceStrictNaggy)

---

## Troubleshooting Tips

- Ensure mocked methods are declared as `virtual` in base interfaces.
- Always set expectations before calls to mock methods to avoid undefined behavior.
- Use `--gmock_verbose=info` to trace mock calls and expectation matching.
- Use `RetiresOnSaturation()` to avoid sticky expectation pitfalls.
- Use `NiceMock` to suppress warnings on uninteresting calls when appropriate.

---

Mocking in GoogleMock empowers you to rigorously test your C++ code’s interactions with dependencies. By mastering expectations, actions, matchers, and mock strictness levels, you write tests that are precise, maintainable, and fast.

---
