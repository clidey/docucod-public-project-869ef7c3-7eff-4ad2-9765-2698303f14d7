---
title: "How do I handle flaky or non-deterministic tests?"
description: "Explains best practices for debugging intermittent test failures, leveraging value- and type-parameterized tests, and techniques to stabilize CI pipelines. Points out relevant tools and commands for isolating sources of instability."
---

# How do I handle flaky or non-deterministic tests?

This guide helps you identify, understand, and mitigate flaky tests—tests that fail intermittently without changes to test code or its environment. It covers best practices for isolating sources of instability, techniques to stabilize test execution, and advanced constructs like parameterized tests to improve test robustness. It also offers practical commands and tools for debugging and controlling nondeterministic behavior in Continuous Integration (CI) environments.

---

## 1. What is a flaky test?

A **flaky test** is a test that sometimes passes and sometimes fails without any changes to the test or tested code. This non-deterministic behavior typically results in wasted time, delayed feedback, and loss of confidence in test reliability.

Common symptoms include:
- Sporadic failures unrelated to recent code changes.
- Inconsistent test results on repeated runs.
- Tests that pass locally but fail on CI.

---

## 2. Common causes of flaky tests

Understanding root causes helps in applying targeted remedies.

### a. Shared State and Unsafe Concurrency
- Tests inadvertently sharing global or static state.
- Race conditions in multithreaded code.
- Improper synchronization.

### b. Timing Dependencies
- Tests relying on real-time delays or wall-clock timing.
- Use of `sleep()` or waiting on events with timeouts.

### c. External Dependencies
- Network, file systems, or databases that are unreliable or not properly isolated.

### d. Order-Dependent Tests
- Tests depend on running order or side effects from previous tests.

### e. Uninitialized or Improperly Mocked Resources
- Mock expectations not correctly set up, or mocks causing side effects.

---

## 3. Strategies for stabilizing flaky tests

Focus on making tests independent, deterministic, and properly isolated.

### a. Isolate Shared State
- Use test fixtures to provide fresh setup for each test.
- Avoid or carefully control mutable global/static variables.

### b. Control Concurrency
- Limit multithreading in tests or use synchronization primitives explicitly.
- Use GoogleMock’s thread-safe mocking support cautiously, following thread safety recommendations.

### c. Avoid Reliance on Real Time
- Substitute real time dependencies with mocks or fakes.
- Use mock clocks or inject time providers.

### d. Use Parameterized and Typed Tests
- Use [Value-Parameterized Tests](https://google.github.io/googletest/parameterized_tests.html) and [Type-Parameterized Tests](https://google.github.io/googletest/typed_tests.html) to run stable, repeatable test variations.

### e. Rely on ON_CALL and EXPECT_CALL Correctly
- Use `ON_CALL` to set default mock behaviors.
- Use `EXPECT_CALL` only when you want to validate interactions explicitly.
- Prefer `NiceMock` to reduce uninteresting call noise but use `StrictMock` when strict validation is required.

### f. Set Explicit Expectations for External Behavior
- Mock external dependencies consistently with known stable behavior.
- Avoid flaky dependency access during testing (e.g., network, filesystem).

### g. Make Tests Idempotent and Order-Independent
- Each test should be able to run in isolation.
- Use GoogleTest [Test Fixtures](https://google.github.io/googletest/primer.html#test-fixtures) for setup/teardown.

### h. Use Sequences and Order Constraints Wisely
- Use `InSequence` and `After` clauses to specify expected call order carefully.
- Over-sequencing can make tests brittle; keep sequences as strict as necessary.

---

## 4. Debugging flaky tests

### a. Run with verbose logging

Use GoogleMock’s `--gmock_verbose=info` flag to trace mock function calls and expectation matching, revealing unexpected calls or argument mismatches.

```bash
./your_test_binary --gmock_verbose=info
```

### b. Leverage `--gtest_repeat` and `--gtest_shuffle`

- Use `--gtest_repeat=N` to run a flaky test multiple times continuously to surface failures.
- Use `--gtest_shuffle` to randomize test execution order and catch order dependencies.

### c. Analyze logs for patterns

- Identify specific calls or interactions that fail intermittently.
- Check for inconsistent mocks or missing expectations.

### d. Temporary Isolation

- Disable flaky tests to unblock CI temporarily, but prioritize investigation.

---

## 5. Using Value- and Type-Parameterized Tests to Reduce Flakiness

Parameterized tests allow running the same test logic with different inputs repeatedly and reliably, reducing duplication and surface for flaky behavior.

### Example: Value-Parameterized Test

```cpp
#include <gtest/gtest.h>

// Test fixture for parameterized tests
class MyTest : public ::testing::TestWithParam<int> {
};

TEST_P(MyTest, HandlesVariousValues) {
  int input = GetParam();
  // Your test logic here
  EXPECT_GT(input, 0);
}

INSTANTIATE_TEST_SUITE_P(PositiveValues, MyTest, ::testing::Values(1, 2, 3, 5, 8));
```

### Example: Type-Parameterized Test

```cpp
#include <gtest/gtest.h>

template <typename T>
class MyTypeTest : public ::testing::Test {
};

using MyTypes = ::testing::Types<int, float, double>;
TYPED_TEST_SUITE(MyTypeTest, MyTypes);

TYPED_TEST(MyTypeTest, BasicTest) {
  TypeParam value{};
  EXPECT_EQ(value, TypeParam{});
}
```

---

## 6. Tools and commands to assist

| Tool / Flag                     | Description                                                   |
| ------------------------------ | -------------------------------------------------------------|
| `--gmock_verbose=info`          | Logs rich details of mock calls for debugging expectations.   |
| `--gtest_repeat=N`              | Runs tests repeatedly N times to catch intermittent failures. |
| `--gtest_shuffle`               | Randomizes test execution order for discovering order failures|
| GoogleMock `NiceMock<T>`        | Suppresses warnings on uninteresting calls.                   |
| GoogleMock `StrictMock<T>`      | Fails tests on uninteresting calls, helpful for strictness.  |
| `Mock::VerifyAndClearExpectations(&mock_obj)` | Force verification of outstanding expectations early.

---

## 7. Preventing Flakiness in CI Pipelines

- **Isolate Tests**: Use dedicated, isolated test environments.
- **Reduce External Dependencies**: Mock external systems.
- **Mark Known Flaky Tests**: Temporarily disable or quarantine flaky tests.
- **Run Tests in Parallel Safely**: Use process isolation or synchronize shared resources.
- **Ensure Proper Cleanup**: Use test fixtures for consistent setup and teardown.

---

## 8. Additional Resources

- [GoogleTest Primer](https://google.github.io/googletest/primer.html) — Basics of tests and fixtures.
- [Writing Parameterized Tests](https://google.github.io/googletest/advanced.html#value-parameterized-tests) — Official guide.
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Advanced mock usage and tips.
- [Troubleshooting Common Test Issues](https://google.github.io/googletest/guides/advanced#troubleshooting) — Deep dive.


---

For ongoing flaky test issues, consider setting up monitoring and logging in your CI to catch intermittent failures early and collaborate with your team to prioritize fixes efficiently.