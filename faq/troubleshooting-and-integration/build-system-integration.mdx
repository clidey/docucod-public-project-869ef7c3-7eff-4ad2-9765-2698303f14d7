---
title: "Integrating with my build system (CMake, Bazel, custom)?"
description: "Covers tips and guidance for integrating GoogleTest and GoogleMock into common build workflows: CMake configuration, pkg-config, Bazel targets, handling submodules, and resolving common integration errors."
---

# Integrating with my build system (CMake, Bazel, custom)?

This page provides practical tips and guidance for integrating GoogleTest and GoogleMock into common build workflows, focusing on CMake configuration, pkg-config usage, Bazel targets, handling git submodules, and resolving common integration errors. The goal is to help you smoothly embed GoogleTest and GoogleMock in your projects, streamline build configuration, and avoid typical pitfalls.

---

## 1. Integrating with CMake

GoogleTest and GoogleMock provide CMake scripts that allow you to build and link the libraries easily within your project.

### 1.1 Using GoogleTest and GoogleMock as Subdirectories

One of the most robust ways to integrate is to include the GoogleTest/GoogleMock source as part of your build tree and add them as subdirectories. This ensures compiler and linker settings remain consistent across your project and tests.

**Typical workflow:**

```cmake
# In your main CMakeLists.txt
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
# For Windows, this prevents runtime linkage conflicts
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(mytest mytest.cpp)
target_link_libraries(mytest gtest_main)
add_test(NAME mytest COMMAND mytest)
```

- This downloads GoogleTest (and GoogleMock included by default) if not already present.
- `gtest_main` provides a ready-made `main()` function; no need to write your own unless customization is needed.

### 1.2 Building GoogleMock and GoogleTest from Their Sources

If you clone GoogleMock or GoogleTest repositories directly, you can build them using the included `CMakeLists.txt` files.

The GoogleMock CMakeLists.txt adds GoogleTest automatically as a subdirectory:

- To build GoogleMock and GoogleTest libraries and install them, you can run:

```bash
mkdir build && cd build
cmake ..
make
sudo make install
```

- Disable building GoogleMock's internal tests by default (option `gmock_build_tests` is OFF).
- To build the tests, configure with `-Dgmock_build_tests=ON`.

### 1.3 Linking Your Tests with GoogleMock or GoogleTest

When linking, choose the appropriate targets:

- Link with `gmock_main` if you want GoogleMock plus its default `main()`.
- Link with `gmock` if you write your own `main()`.
- Similarly for GoogleTest, use `gtest_main` or `gtest` respectively.

Example:

```cmake
add_executable(my_mock_test mock_test.cpp)
target_link_libraries(my_mock_test gmock_main)
add_test(NAME my_mock_test COMMAND my_mock_test)
```

### 1.4 Include Directories

The CMake scripts automatically add include directories for both GoogleMock and GoogleTest. If using them as subdirectories, you don’t normally need to add include paths manually.

### 1.5 Shared vs Static Libraries

- GoogleTest and GoogleMock build as static libraries by default.
- Enable building shared libraries with `-DBUILD_SHARED_LIBS=ON`.
- If you build shared libraries, define `-DGTEST_LINKED_AS_SHARED_LIBRARY=1` when compiling your tests to ensure proper linkage.

---

## 2. Using pkg-config for Integration

GoogleTest and GoogleMock provide `.pc.in` templates to generate pkg-config files:

- `gtest_main.pc.in`, `gmock.pc.in`, `gmock_main.pc.in` templates exist.

These files help package managers and build systems discover the libraries and compiler flags.

### Common Fields in `.pc` Files:

- `Libs:` Specifies libraries and linkage flags.
- `Cflags:` Specifies include directories and macros (e.g., pthread macros).

**Example usage:**

```bash
pkg-config --cflags gmock_main
pkg-config --libs gmock_main
```

Using pkg-config, you can easily retrieve the correct compilation and linking flags in your build system.

---

## 3. Bazel Integration

GoogleTest and GoogleMock provide Bazel targets that support native builds within Bazel workspaces.

### 3.1 Using Workspace Rules

Add GoogleTest as a Bazel external repository with the following snippet in your `WORKSPACE` file:

```bazel
http_archive(
    name = "com_google_googletest",
    url = "https://github.com/google/googletest/archive/release-1.17.0.tar.gz",
    strip_prefix = "googletest-release-1.17.0",
    sha256 = "<sha256-hash>"
)
```

### 3.2 Linking Tests in Bazel

- In your `BUILD` files, declare dependencies on `@com_google_googletest//:gtest_main` or `@com_google_googletest//:gmock_main`.

Example:

```bazel
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

This automatically links the test with GoogleTest's main function.

### 3.3 Advantages of Bazel Integration

- Simplifies dependency management and caching.
- Supports consistent builds across platforms.

---

## 4. Handling GoogleTest and GoogleMock as Git Submodules

If you use git submodules:

- Add GoogleTest or GoogleMock as a submodule to your project.

```bash
git submodule add https://github.com/google/googletest.git third_party/googletest
```

- Then include the submodule directory in your CMake build using `add_subdirectory()`.

- Make sure to update submodules when pulling upstream changes using:

```bash
git submodule update --init --recursive
```

---

## 5. Common Integration Errors and How to Fix Them

### 5.1 Linking Errors (Undefined Symbols)

**Cause:**

- Forgetting to link the test binary with `gtest`, `gtest_main`, `gmock`, or `gmock_main`.
- Mixing static and shared library compilation.

**Solution:**

- Verify that your build links correctly with needed libraries.
- Use CMake targets or `pkg-config` outputs to ensure consistency.
- If using shared libraries, ensure `GTEST_LINKED_AS_SHARED_LIBRARY=1` is defined.

### 5.2 Missing `main()` Symbol

**Cause:**

- Linking only with `gmock` or `gtest` but not their corresponding `_main` targets which provide `main()`.

**Solution:**

- Link with `gmock_main` or `gtest_main` if you want to use the provided `main()`.
- Alternatively, write your own `main()` that calls `testing::InitGoogleTest()` or `testing::InitGoogleMock()` and `RUN_ALL_TESTS()`.

### 5.3 Compiler Flag Mismatches

**Cause:**

- GoogleTest and your project have conflicting compiler or runtime flags (e.g., static vs dynamic runtimes in MSVC).

**Solution:**

- Use `gtest_force_shared_crt` option in CMake to align runtime linkage.
- Ensure consistent C++ standard usage (minimum C++17).

### 5.4 Header Files Not Found

**Cause:**

- Missing include directory paths for GoogleTest or GoogleMock headers.

**Solution:**

- Use CMake `target_link_libraries()` with GoogleTest targets to include required paths automatically.
- If integrating manually, add include directories for both GoogleTest and GoogleMock sources.

---

## 6. Best Practices for Smooth Integration

- Use official CMake scripts and targets wherever possible to reduce manual configuration.
- Prefer to build GoogleTest and GoogleMock alongside your project for maximum compatibility.
- Always match runtime library choices and compiler flags between your code and GoogleTest builds.
- When using packages or system installs, prefer `find_package(GTest CONFIG REQUIRED)` and use targets like `GTest::gtest`.
- When using git submodules, commit submodule states explicitly to reflect GoogleTest version.
- Turn on GoogleMock’s internal tests selectively (`-Dgmock_build_tests=ON`) while actively developing or updating GoogleMock.

---

## 7. Additional Resources

- [GoogleTest Primer](primer.md) — Learn basics of writing and running tests.
- [Build System Integration Guide](guides/integration-scenarios/build-system-integration.md) — More examples of build integrations.
- [GoogleMock README](googlemock/README.md) — For mocking-specific setup.
- [Common Compilation & Linking Errors FAQ](faq/troubleshooting-and-integration/compilation-linking-errors.md) — Troubleshooting.
- [CMakeLists.txt in googlemock directory](googlemock/CMakeLists.txt) — Reference for community CMake support.

---

By following the workflows and guidance above, you can successfully embed GoogleTest and GoogleMock into your C++ projects using CMake, Bazel, or custom build systems, avoid common pitfalls, and leverage automated testing to its fullest.


---

*Last updated: v1.17.0*


---