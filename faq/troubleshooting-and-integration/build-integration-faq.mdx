---
title: "How do I integrate with my build system (CMake, Bazel, etc.)?"
description: "Guides users through the most common integration questions for CMake and Bazel, including resolving link errors and visibility problems, specifying test targets, and managing dependencies."
---

# Integrating GoogleTest with Your Build System (CMake, Bazel, etc.)

GoogleTest provides flexible integration options for popular C++ build systems like CMake and Bazel. This guide helps you smoothly incorporate GoogleTest into your project, avoid common linking and visibility problems, define test targets correctly, and manage dependencies efficiently.

---

## 1. Integrating GoogleTest with CMake

GoogleTest offers both standalone building and seamless incorporation into larger CMake projects. Understanding the options allows you to build tests effectively and avoid common pitfalls.

### 1.1 Building GoogleTest as a Standalone Project

You can clone and build GoogleTest independently before linking it in your project.

```bash
# Clone the GoogleTest repository
git clone https://github.com/google/googletest.git -b v1.17.0
dcd googletest
mkdir build && cd build
# Generate native build files with CMake
cmake ..
# Build GoogleTest and GoogleMock (default)
make
# Optionally, install to a system directory (requires admin rights)
sudo make install
```

If you want to build only GoogleTest (without GoogleMock), run:

```bash
cmake .. -DBUILD_GMOCK=OFF
```

Build output varies by platform:
- On Linux/BSD/macOS, a Makefile is generated.
- On Windows, Visual Studio solution (`gtest.sln`) and project files.
- On macOS, an Xcode project (`.xcodeproj`) is created.

### 1.2 Using GoogleTest within an Existing CMake Project

To avoid incompatibilities with different compiler settings or build types, it's advisable to build GoogleTest alongside your project.

#### 1.2.1 Find Installed GoogleTest

If GoogleTest is installed on your system (e.g., via `make install`), you can use:

```cmake
find_package(GTest CONFIG REQUIRED)
# Link your test executable to GoogleTest libraries
add_executable(my_tests test.cpp)
target_link_libraries(my_tests GTest::gtest GTest::gmock)
add_test(NAME MyTest COMMAND my_tests)
```

This approach is simple but depends on system-wide installation.

#### 1.2.2 Add GoogleTest as a Subdirectory

Add GoogleTest source code directly into your project:

- Place GoogleTest source in a known subdirectory (e.g., `third_party/googletest`).
- Then in your `CMakeLists.txt`:

```cmake
add_subdirectory(third_party/googletest)
add_executable(my_tests test.cpp)
target_link_libraries(my_tests gtest gtest_main)
add_test(NAME MyTest COMMAND my_tests)
```

This builds GoogleTest with your project's compiler settings, ensuring compatibility.

#### 1.2.3 FetchContent to Download GoogleTest Automatically

Use CMake's FetchContent to download and build GoogleTest during configuration:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)  # Windows dynamic runtime
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test.cpp)
target_link_libraries(my_tests gtest_main)
add_test(NAME MyTest COMMAND my_tests)
```

This requires CMake 3.14 or later.

### 1.3 Managing Compiler and Linker Settings

#### 1.3.1 Enforce C++17 Standard

GoogleTest requires a C++17-capable environment. Specify in your root `CMakeLists.txt`:

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

If your project uses a different standard or compiles C code, pass compatible flags explicitly.

#### 1.3.2 Visual Studio Runtime Compatibility

By default, Visual Studio projects link C runtimes dynamically (MD/MDd) but GoogleTest links statically (MT/MTd). This mismatch causes linker errors like:

```
gtest.lib(gtest-all.obj) : error LNK2038: mismatch detected for 'RuntimeLibrary'
```

Fix this by adding to your `CMakeLists.txt` before calling `FetchContent_MakeAvailable`:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

This tells GoogleTest to link with dynamic runtime to match your project.

#### 1.3.3 Building as Shared Library

To build GoogleTest as a shared library (DLL on Windows), pass:

```bash
-DGTEST_CREATE_SHARED_LIBRARY=1
```

to your compiler flags. Tests using that shared library must define:

```bash
-DGTEST_LINKED_AS_SHARED_LIBRARY=1
```

Note: Static linking is simpler and recommended unless you have a specific use case.

### 1.4 Avoiding Macro Name Conflicts

If GoogleTest macros clash with your code or other libraries, define macros to rename them:

```bash
-DGTEST_DONT_DEFINE_TEST=1
```

This forces you to use `GTEST_TEST` instead of `TEST` in your code to avoid collisions.

---

## 2. Integrating GoogleTest with Bazel

GoogleTest is supported and commonly used with Bazel. Integration often involves adding GoogleTest as a dependency and writing proper BUILD files.

### 2.1 Add GoogleTest to Your WORKSPACE

You can add GoogleTest from its github repository via `http_archive`:

```python
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/v1.17.0.zip"],
    strip_prefix = "googletest-1.17.0",
)
```

### 2.2 Reference GoogleTest in BUILD Files

In your BUILD files, depend on GoogleTest targets like `@com_google_googletest//:gtest`

Example:

```python
cc_test(
    name = "my_test",
    srcs = ["my_test.cpp"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

### 2.3 Common Pitfalls

- Make sure to depend on `gtest_main` if you want the default `main()` function.
- Ensure your tests are linked against the `gtest` or `gtest_main` Bazel targets.
- Use `cc_test` rule instead of `cc_binary` for tests to get integration with Bazel's test runner.

Refer to Bazel official and GoogleTest's bazel workspace docs for advanced settings.

---

## 3. Common Integration Issues and How to Fix Them

### 3.1 Linker Errors

**Symptoms:** Undefined references to GoogleTest symbols or multiple definition errors.

**Causes & Fixes:**
- Mixing static and dynamic runtimes (Windows): Use `gtest_force_shared_crt=ON` in CMake.
- Not linking with `gtest` or `gtest_main`: Ensure your test target includes these libraries.
- Duplicate linking of GoogleTest library: Avoid linking multiple times or mix of static/shared.

### 3.2 Header Visibility Problems

**Symptoms:** Compiler errors indicating header files not found.

**Fixes:**
- Ensure your build system includes the correct include directories.
- If using subdirectory or FetchContent, confirm target dependencies propagate includes properly.

### 3.3 Version Compatibility

GoogleTest requires a C++17-capable compiler and environment. Older build environments will fail.

Set `CMAKE_CXX_STANDARD` to at least 17, and verify your compiler version.

### 3.4 Multiple Main Definitions

If you include both `gtest_main` and define your own `main()`, you may get errors about multiple main definitions.

**Resolution:** Use either `gtest_main` (recommended) for default main, or create your own main function and link with only `gtest`.

### 3.5 Thread Safety

GoogleTest is thread-safe where pthread is available. If your environment does not detect it correctly, define:

```bash
-DGTEST_HAS_PTHREAD=1
```

in your build flags and link with pthread.

---

## 4. Tips for Smooth Integration

- Prefer adding GoogleTest as a subdirectory or FetchContent within your CMake build to ensure compiler flag consistency.
- Always call `testing::InitGoogleTest()` in your main before calling `RUN_ALL_TESTS()`.
- Use `gtest_main` library when possible to avoid writing your own main function.
- Check your platform's C++ and threading support.
- Handle Visual Studio runtime library settings explicitly.
- For Bazel, use `cc_test` rule and depend on official GoogleTest workspace targets.

---

## 5. Example CMakeLists.txt Snippet

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)

FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test.cpp)
target_link_libraries(my_tests gtest_main)
add_test(NAME MyTest COMMAND my_tests)
```

---

## 6. Additional Resources

- [Official GoogleTest CMake Build Instructions](https://github.com/google/googletest/blob/main/googletest/README.md)
- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [Build Integration FAQ](https://google.github.io/googletest/faq.html#build-integration-faq)
- Bazel Documentation: Using `http_archive` and `cc_test`

---

By following these structured approaches, your GoogleTest integration into CMake or Bazel projects will be robust, minimizing common configuration headaches and enabling you to write and run reliable C++ tests efficiently.
