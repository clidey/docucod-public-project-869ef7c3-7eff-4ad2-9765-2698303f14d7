---
title: "How do I create custom assertions or advanced mock behaviors?"
description: "Answers questions about extending GoogleTest and GoogleMock with user-defined assertions, actions, and matchers. Explains recommended extension points and references helpful utilities."
---

# How do I create custom assertions or advanced mock behaviors?

This page answers common user questions about extending GoogleTest and GoogleMock with user-defined assertions, actions, and matchers. It explains recommended extension points, demonstrates customization techniques, and provides references to useful utilities and best practices.

---

## 1. Introduction to Extensibility

GoogleTest and GoogleMock provide powerful built-in assertions, matchers, and actions that cover most testing needs. However, complex or domain-specific scenarios often require creating custom components to express test intent precisely or to orchestrate mock behaviors with greater flexibility.

This guide focuses on ways to write:

- Custom **assertions** to verify non-trivial conditions in tests.
- Custom **matchers** to specify flexible argument validation in mocks and assertions.
- Custom **actions** to implement sophisticated mock method behaviors.

Understanding these extension points empowers you to keep tests expressive, maintainable, and robust.

---

## 2. Custom Assertions

Assertions are the fundamental way for tests to verify correctness by checking conditions. GoogleTest's `EXPECT_` and `ASSERT_` macros cover most scenarios, but custom assertions offer:

- Rich error messages tailored to domain-specific criteria
- Simplified test code by encapsulating complex logic

### How to Write a Custom Assertion

The recommended approach is to write a helper function that returns a `testing::AssertionResult`. Here's a template:

```cpp
#include <gtest/gtest.h>

// Custom assertion function
static testing::AssertionResult IsValidFoo(const Foo& foo) {
  if (foo.IsValid()) {
    return testing::AssertionSuccess();
  } else {
    return testing::AssertionFailure() << "Foo is invalid: " << foo.ErrorMessage();
  }
}

// Usage in test:
EXPECT_TRUE(IsValidFoo(my_foo));
```

### Using `EXPECT_PRED_FORMAT` Macros

GoogleTest macros like `EXPECT_PRED_FORMAT1` or `EXPECT_PRED_FORMAT2` allow more expressive assertions where:

- The formatter function receives the textual expressions and evaluated values
- They generate clear, custom failure messages

Example:

```cpp
// Formatter function
testing::AssertionResult AssertFooEqual(const char* expr1, const char* expr2, const Foo& a, const Foo& b) {
  if (a == b) return testing::AssertionSuccess();
  return testing::AssertionFailure() << expr1 << " (" << a << ") and " << expr2 << " (" << b << ") are not equal.";
}

// Usage
EXPECT_PRED_FORMAT2(AssertFooEqual, foo1, foo2);
```

### Best Practices

- Keep assertions side-effect free.
- Stream useful diagnostic info to help debugging.
- Use existing GoogleTest macros within your custom assertions to simplify code.

---

## 3. Creating Custom Matchers

Matchers powerfully specify argument expectations in mocks and conditions in assertions. They let you express "the argument has property X" rather than exact equality.

### Two Main Approaches

1. **Using the `MATCHER` family of macros** (easiest and recommended for many cases)
2. **Implementing Matcher classes manually** (for advanced control)

### 3.1 Using `MATCHER` Macros

For simple or moderately complex match criteria, you can use:

- `MATCHER(name, description)` for zero-parameter matchers
- `MATCHER_P(name, param, description)` for single-parameter matchers
- `MATCHER_P2`... up to `MATCHER_P10` for multi-parameter matchers

Example - Basic matcher:

```cpp
MATCHER(IsEven, "is an even number") {
  return (arg % 2) == 0;
}

// Usage
EXPECT_CALL(mock, Foo(IsEven()));
```

Example - Parameterized matcher:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "is divisible by " + std::to_string(divisor)) {
  return (arg % divisor) == 0;
}

EXPECT_CALL(mock, Bar(IsDivisibleBy(3)));
```

This syntax automatically generates descriptive failure messages.

### 3.2 Writing Custom Matcher Classes

For full flexibility, implement a matcher class with these methods:

- `bool MatchAndExplain(arg_type value, std::ostream* os) const;` (for matching and optional diagnostic)
- `void DescribeTo(std::ostream* os) const;` (describes the expected condition)
- `void DescribeNegationTo(std::ostream* os) const;` (describes negation)

Example:

```cpp
#include <gmock/gmock.h>

class IsPositiveMatcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    if (n > 0) return true;
    if (os) *os << "which is " << n << ", not positive";
    return false;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is positive";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not positive";
  }
};

::testing::Matcher<int> IsPositive() {
  return ::testing::MakeMatcher(new IsPositiveMatcher());
}

// Usage:
EXPECT_THAT(value, IsPositive());
```

### 3.3 Polymorphic Matchers

Matchers can be polymorphic to match multiple argument types. When implementing manually, templated `MatchAndExplain()` methods help achieve polymorphism.

### Best Practices

- Prefer `MATCHER` macros for clarity and maintainability.
- Use descriptive failure messages.
- Combine matchers using `AllOf()`, `AnyOf()` etc., for composability.
- Keep matchers side-effect free to comply with gMock expectations.

---

## 4. Defining Custom Actions

Actions control what mocked methods do when invoked, including returning values, invoking callbacks, or triggering side effects.

While GoogleMock has many built-in actions (e.g., `Return`, `Invoke`, `SetArgPointee`), you can define custom actions for advanced scenarios.

### 4.1 Creating Lambda or Functor Actions

The simplest way is to provide a callable (lambda, functor, or function pointer) compatible with the mocked function signature:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int x) { return x * 10; });
```

### 4.2 Using `ACTION` and `ACTION_P` Macros

To define reusable named actions:

```cpp
ACTION(SetTo5) {
  *arg0 = 5;  // Set the 0-th argument
}

EXPECT_CALL(mock, Bar(_)).WillOnce(SetTo5());
```

Parameterized example:

```cpp
ACTION_P(AddValue, val) {
  return arg0 + val;
}

EXPECT_CALL(mock, Baz(_)).WillOnce(AddValue(10));
```

### 4.3 Implementing Action Classes Manually

For advanced customizations or polymorphic behavior, implement `ActionInterface<F>` where `F` is the function signature.

Example:

```cpp
class IncrementAction : public ::testing::ActionInterface<int(int*)> {
 public:
  int Perform(const std::tuple<int*>& args) override {
    int* p = std::get<0>(args);
    return ++(*p);
  }
};

::testing::Action<int(int*)> Increment() {
  return ::testing::MakeAction(new IncrementAction);
}

EXPECT_CALL(mock, Inc(_)).WillOnce(Increment());
```

### 4.4 Using Polymorphic Actions

If your action needs to work across multiple function types, consider `MakePolymorphicAction()` combined with a templated `Perform()` method.

### 4.5 Combining Actions

Use `DoAll()` to chain multiple side effects or actions, ensuring the last action returns the required value.

Example:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(::testing::DoAll(
        ::testing::SetArgPointee<0>(5),
        ::testing::Return(true)));
```

### Tips and Best Practices

- Use `Invoke()` to forward calls to real functions or member functions.
- Chain multiple actions carefully; the last action provides the return value.
- Use `IgnoreResult()` if you want to discard an actionâ€™s return for void functions.
- Avoid side effects that may cause flaky tests or difficult-to-track behavior.

---

## 5. Useful Utilities and Patterns

- **MockFunction**: Easily mock `std::function` types for callback testing.
- **Saving Arguments**: Use `SaveArg<N>` to capture arguments for later verification.
- **Delegating to Fakes or Reals**: Forward behavior to existing fake or production objects to avoid duplication.
- **Managing Mock Strictness**: Use `NiceMock`, `NaggyMock`, or `StrictMock` wrappers to control handling of uninteresting calls.

---

## 6. Troubleshooting and Debugging

- When custom assertions or matchers fail with unclear messages, increase verbosity with `--gmock_verbose=info`.
- Use `EXPECT_PRED_FORMAT` macros for better diagnostic detail in predicates.
- If complex actions cause compilation issues, check compatibility with move-only types.
- Follow expectations ordering carefully to avoid unexpected call errors.

---

## 7. References and Further Reading

- [Assertions Reference](reference/gtest-core-api/assertions-and-failures.md)
- [Matchers Reference](api-reference/gmock-api/matchers-and-argument-checks.md)
- [Actions Reference](concepts/extensibility-and-matching/mock-actions-and-customization.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)
- [Mocking Reference](docs/reference/mocking.md)
- [GoogleTest Architecture and Concepts](overview/architecture-and-concepts/core-concepts.md)

Use these resources to deepen your mastery of extending GoogleTest and GoogleMock in your projects.
