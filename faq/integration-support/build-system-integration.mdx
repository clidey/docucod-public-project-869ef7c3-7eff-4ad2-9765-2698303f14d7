---
title: "Build System Integration (CMake, Bazel, etc.)"
description: "Explains how to set up GoogleTest/GoogleMock with popular build systems like CMake and Bazel, including common configuration mistakes and how to address them. Offers advice for recognizing and resolving linking errors."
---

# Build System Integration (CMake, Bazel, etc.)

This guide provides a user-focused walkthrough to integrating GoogleTest and GoogleMock with popular build systems, focusing on CMake and Bazel. It covers practical setup steps, common configuration pitfalls, troubleshooting linking errors, and best practices to ensure a smooth and reliable testing build environment.

---

## Why Integrate GoogleTest and GoogleMock with Your Build System?

Proper integration ensures that your test binaries are correctly compiled, linked, and configured to run unit and mock tests seamlessly alongside your application code. Whether you use CMake, Bazel, or another build system, aligning your setup with GoogleTest/GoogleMock's requirements guarantees:

- Correct inclusion of headers and sources
- Appropriate compile-time flags (especially threading and C++ standard)
- Proper linking of GoogleTest/GoogleMock libraries and dependencies
- Availability of test executables that successfully run all tests

---

## Integration with CMake

CMake is the most commonly used build system for C++ projects and GoogleTest/GoogleMock provides built-in support for it.

### Getting Started

1. **Add GoogleTest/GoogleMock Source or Installed Libraries**

   - If using installed libraries, find GoogleTest with `find_package(GTest REQUIRED)` or `find_package(GMock REQUIRED)`.

   - Alternatively, include GoogleTest/GoogleMock source in your tree and use `add_subdirectory()` for tight integration and consistent compiler flags.

2. **Link Your Test Executable**

   Link your test binaries with GoogleTest or GoogleMock libraries, for example:

   ```cmake
   target_link_libraries(your_test_target PRIVATE GTest::gtest_main GMock::gmock)
   ```

3. **Set Compilation Features**

   GoogleTest requires C++17. Use:

   ```cmake
   set(CMAKE_CXX_STANDARD 17)
   set(CMAKE_CXX_STANDARD_REQUIRED ON)
   ```

4. **Handle Threading Support**

   When GoogleTest detects pthread availability (common on Unix-like systems), it sets appropriate threading compile and link flags automatically.

### Common Pitfalls and Solutions

#### Linking Errors

- **Undefined references to GoogleTest symbols:**

  - Make sure you link against `gtest` or `gmock` and their respective main libraries (`gtest_main` or `gmock_main`) if you rely on the provided `main()`.

- **Runtime errors or symbol conflicts:**

  - Verify that all parts of your project and tests use compatible compiler flags.

  - Consistently use either shared or static libraries—mismatches can cause crashes.

#### Runtime Library Conflicts on Windows with MSVC

- GoogleTest defaults to static runtimes (`/MT`), but new Visual Studio projects often use dynamic runtimes (`/MD`).

- To resolve:

  - Use the CMake option `gtest_force_shared_crt` by adding:

    ```cmake
    set(gtest_force_shared_crt ON CACHE BOOL "Force shared runtime" FORCE)
    ```

#### Incomplete Includes or Defines

- Use the `target_include_directories()` and `target_compile_definitions()` provided by GoogleTest/GoogleMock targets rather than manually adding includes and defines.

- If you manually add compile options, ensure `-DGTEST_HAS_PTHREAD=1` (or 0 depending on your platform) is set consistently.

---

## Integration with Bazel

Bazel users can incorporate GoogleTest/GoogleMock using pre-built `cc_test` and `cc_library` rules.

### Basic Setup

1. **Add GoogleTest and GoogleMock Repositories**

Include in your `WORKSPACE`:

```python
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.11.0.tar.gz"],
    strip_prefix = "googletest-release-1.11.0",
)
```

2. **Reference GoogleMock and GoogleTest in BUILD files**

```python
cc_test(
    name = "your_test",
    srcs = ["your_test.cc"],
    deps = ["@com_google_googletest//:gmock_main"],
)
```

3. **Run tests with Bazel:**

```bash
bazel test //path/to:your_test
```

### Common Issues

- **Symbol conflicts or unresolved references:** Ensure `gmock_main` (or `gtest_main` depending on your use) is included as a dependency.

- **Compile flags compatibility:** Bazel generally manages this internally, but custom flags may conflict with GoogleMock expectations.

- **Threading support:** Bazel builds typically include pthread support on relevant platforms automatically.

---

## Recognizing and Resolving Common Linking Errors

| Symptom                                  | Root Cause                                     | Solution                                         |
|------------------------------------------|-----------------------------------------------|--------------------------------------------------|
| Undefined reference to `RUN_ALL_TESTS`   | Missing `gtest_main` or `gmock_main` library  | Link test executable against `gtest_main` or `gmock_main`|
| Compiler error about `-fexceptions`      | Inconsistent compiler flags across targets     | Ensure all targets use consistent exception flags|
| Runtime crashes due to conflicting CRTs  | Mixing `/MT` and `/MD` on Windows MSVC          | Enable `gtest_force_shared_crt` or fix flag consistency|
| Missing pthread symbols on Linux         | Not linking pthread or missing flag            | Ensure `Threads::Threads` is linked, or flags include `-pthread`|

---

## Best Practices for Build System Integration

- **Use Official Targets:** Link your tests against `GTest::gtest`, `GTest::gtest_main`, `GMock::gmock`, or `GMock::gmock_main` targets, which encapsulate compile options and dependencies.

- **C++ Standard:** Make C++17 a minimum requirement.

- **Consistent Runtime Libraries:** On Windows with MSVC, synchronize project CRT linkage with GoogleTest/GoogleMock settings.

- **Avoid Manual Macro Definitions:** Prefer build system integration over manually defining GoogleTest macros, except for known customization cases.

- **Enable Tests in CI:** Integrate test execution commands as part of your CI pipelines using `ctest` (for CMake) or `bazel test`.

- **Address Test Discovery by Linking Main Correctly:** Using `gmock_main` or `gtest_main` helps avoid requiring your own `main()`.

---

## Example CMakeLists.txt Snippet

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add googletest (assumes source present or fetched)
add_subdirectory(external/googletest)

# Define your test executable
add_executable(my_tests test/my_tests.cc)

# Link with gmock_main to get main() implementation
target_link_libraries(my_tests PRIVATE gmock_main)

# Enable testing and register tests
enable_testing()
add_test(NAME MyUnitTests COMMAND my_tests)
```

---

## Troubleshooting Steps

### Step 1: Verify library linkage
- Confirm your test executable links to `gmock_main` or appropriate target.

### Step 2: Check compiler flags
- Align compiler and runtime flags across all targets, especially on Windows.

### Step 3: Confirm include directories
- Use GoogleTest/GoogleMock's properties rather than manual additions.

### Step 4: Validate threading support
- Ensure `-pthread` or equivalent threading flags are in the linker and compiler.

### Step 5: Build and run simple tests
- Try running a minimal test executable with `RUN_ALL_TESTS()` to verify the setup.

---

## Related Documentation

- [Installation Guide (CMake, Bazel, Manual)](/getting-started/setup-installation/installation-guide)
- [Set Up Your Project (Build System Configuration)](/guides/getting-started-core-workflows/setup-your-project)
- [Integrating with CI and Build Systems](/guides/advanced-mocking-integrations/integrating-with-ci-and-build-systems)
- [Troubleshooting Common Setup Issues](/getting-started/first-steps-validation/troubleshooting-common-issues)

---

<Tip>
For users building GoogleTest/GoogleMock themselves, remember that the GoogleMock CMakeLists.txt calls GoogleTest’s build internally. This ensures compatible compiler/linker flags and reduces integration issues.
</Tip>

<Note>
If you are integrating GoogleTest/GoogleMock into an existing build system, prefer using the installed libraries and pkg-config files to reduce maintenance overhead and ensure correct compilation environment.
</Note>

<Warning>
Misaligning runtime libraries (dynamic vs static) on Windows with MSVC is a frequent cause of difficult-to-debug linking and runtime errors. Use the provided CMake options and verify your project's runtime settings carefully.
</Warning>
