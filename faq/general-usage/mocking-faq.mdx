---
title: "Mocking and Expectations FAQ"
description: "Answers to frequent questions about creating mock classes, declaring mock methods, and writing expectations. Covers practical usage of key macros (`MOCK_METHOD`, `EXPECT_CALL`, `ON_CALL`), and addresses common confusion points for mock object behaviors."
---

# Mocking and Expectations FAQ

This FAQ addresses the most frequent questions and common confusion points about creating mock classes, declaring mock methods, setting expectations, and using GoogleMock's key macros: `MOCK_METHOD`, `EXPECT_CALL`, and `ON_CALL`. It provides clear, actionable answers and practical examples to ensure you can confidently apply mocking in your C++ tests.

---

## 1. How do I **create a mock class** with gMock?

To create a mock class that simulates an interface or a base class, you need to derive from it and use the `MOCK_METHOD` macro for each virtual method you want to mock. This macro generates the mock implementation automatically.

### Example:

```cpp
#include <gmock/gmock.h>  // Include gMock

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Tips:
- Place `MOCK_METHOD` declarations in the **public** section regardless of base access specifiers.
- Wrap complex argument types with parentheses or typedefs to avoid comma parsing issues.
- Always mark mock methods with `(override)` for clarity and safety.

---

## 2. What are the differences between `EXPECT_CALL` and `ON_CALL`?

- **`EXPECT_CALL`** sets an expectation that a mock method **will be called** with specified arguments, controlling both the behavior and the verification of calls.
- **`ON_CALL`** sets a **default behavior** when a matching mock method is called but does **not** set an expectation that the call must occur.

### When to Use?
- Use `ON_CALL` to specify typical or default mock behavior without enforcing call expectations.
- Use `EXPECT_CALL` to verify your code actually invokes certain methods with specified arguments and frequency.

### Example:

```cpp
using ::testing::Return;

MockTurtle turtle;

// Default behavior: GetX() returns 0, but no expectation on calling
ON_CALL(turtle, GetX()).WillByDefault(Return(0));

// Expectation: PenDown() must be called at least once
EXPECT_CALL(turtle, PenDown()).Times(::testing::AtLeast(1));

// Code under test calls turtle methods
```

---

## 3. How do I **set expectations** on mock methods?

Use the `EXPECT_CALL` macro before exercising your code. You can chain clauses to specify argument matchers, call counts, call order, and behavior.

### Basic syntax:

```cpp
EXPECT_CALL(mock_object, Method(arg_matchers...))
    .Times(cardinality)             // How many times
    .WillOnce(action)               // Action for 1st match
    .WillRepeatedly(action)         // Action after WillOnce
    .InSequence(seq)                // Calls in order
    .After(other_expectations)      // Call order dependencies
    .RetiresOnSaturation();         // Retires when call count met
```

### Example:

```cpp
using ::testing::_;           // Wildcard matcher accepting any arg
using ::testing::Return;
using ::testing::InSequence;

MockTurtle turtle;
{
  InSequence s;  // Expect calls in this order

  EXPECT_CALL(turtle, PenDown())
      .Times(1);
  EXPECT_CALL(turtle, Forward(100))
      .Times(1);
  EXPECT_CALL(turtle, PenUp())
      .Times(1);
}

// Will set actions if needed
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(10))
    .WillRepeatedly(Return(100));
```

### Important Notes:
- `EXPECT_CALL` must be called **before** the mock method is invoked.
- The order of calls is by default flexible; specify `InSequence` for strict order.
- `Times(0)` forbids calls to the method.
- Omitting `Times()` defaults to one call if `WillOnce()` is not used.

---

## 4. How do **argument matchers** work in expectations?

Argument matchers specify which arguments are expected. Key points:

- Basic: Write exact values to expect specific arguments.
- Wildcard: Use `_` to accept any argument (wildcard matcher).
- Built-in matchers: Use `Gt()`, `Le()`, `NotNull()`, `Contains()`, etc., to express conditions.
- Combine multiple matchers logically using `AllOf()`, `AnyOf()`, `Not()`.
- Use `.With()` to match arguments collectively in a tuple, e.g. for cross-parameter correlation.

### Example:

```cpp
EXPECT_CALL(turtle, Forward(100));             // Expect exactly 100
EXPECT_CALL(turtle, Forward(_));                // Any argument
EXPECT_CALL(turtle, GoTo(50, _));               // X == 50, Y any
EXPECT_CALL(turtle, Turn(::testing::Ge(90)));  // Turn by >= 90 degrees
```

---

## 5. How can I control the **call count** expectation?

Use `.Times()` clause with a cardinality specifier:

| Cardinality                | Meaning                            |
|----------------------------|----------------------------------|
| `Exactly(n)` or `n`        | Expect exact number of calls      |
| `AtLeast(n)`               | At least n calls expected         |
| `AtMost(n)`                | At most n calls allowed            |
| `Between(m, n)`            | Calls between m and n times       |
| `AnyNumber()`              | Any number of calls accepted      |

### Example:

```cpp
EXPECT_CALL(turtle, PenDown()).Times(1);        // Exactly once
EXPECT_CALL(turtle, Forward(_)).Times(AtLeast(1));
EXPECT_CALL(turtle, GoTo(_, _)).Times(AnyNumber());
EXPECT_CALL(turtle, PenUp()).Times(0);           // Disallowed
```

### Note:
- If `.WillOnce()`/`.WillRepeatedly()` are specified without `.Times()`, gMock infers the calls count automatically.
- `Times(0)` will cause an immediate failure if called.

---

## 6. How do I specify the **behavior** of a mock method when it is called?

Use `.WillOnce()` and `.WillRepeatedly()` clauses to define actions executed upon matching calls.

- `.WillOnce(action)` specifies the action for the _n_-th call.
- `.WillRepeatedly(action)` specifies the action for all calls after `.WillOnce()` actions are exhausted.

Commonly used actions:
- `Return(value)` - returns a value.
- `ReturnRef(variable)` - returns a reference.
- `Invoke(function)` - calls an external function or lambda.
- `SetArgPointee<N>(value)` - sets output parameter N.
- `DoAll(action1, action2, ...)` - performs multiple actions, returns last.

### Example:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillRepeatedly(Return(200));

EXPECT_CALL(turtle, PenDown())
    .WillOnce(Invoke([] { std::cout << "Pen down"; }));
```

---

## 7. What happens if the mock method is called **more or fewer times** than expected?

- If called fewer times, gMock will report an expectation violation at mock destruction or explicit verification.
- If called more times:
  - If the method has `WillRepeatedly()`, that action is executed.
  - Otherwise, gMock reports a failure immediately and returns the default value (or void).

### Tip:
- Use `.RetiresOnSaturation()` to retire an expectation once fulfilled, allowing other expectations to match subsequent calls.

---

## 8. How to **deal with overloaded methods** in mocks?

To mock overloaded methods, define a mock method for each overload.

### Example:

```cpp
class Foo {
 public:
  virtual int Describe(const char* name) = 0;
  virtual int Describe(int type) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Describe, (const char* name), (override));
  MOCK_METHOD(int, Describe, (int type), (override));
};
```

When setting expectations, help the compiler by using `Const(mock)` to disambiguate const overloads:

```cpp
EXPECT_CALL(mock, Describe("abc"));
EXPECT_CALL(Const(mock), Describe(42));
```

---

## 9. How do **NiceMock**, **NaggyMock**, and **StrictMock** differ?

These are wrappers that adjust how uninteresting (unexpected) calls are treated:

| Wrapper       | Behavior on Uninteresting Calls           |
|---------------|-------------------------------------------|
| `NiceMock<T>` | Ignores calls silently (no warnings/errors) |
| `NaggyMock<T>`| Prints warnings (default behavior)         |
| `StrictMock<T>` | Treats uninteresting calls as test failures |

### Usage example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
EXPECT_CALL(mock_foo, DoThis());
```

### Tips:
- Use `NiceMock` by default for less noisy tests.
- Use `StrictMock` when you want to catch unexpected calls strictly.

---

## 10. Why do I get warnings about **uninteresting calls**?

When a mock method is called without any matching `EXPECT_CALL`, gMock considers it an uninteresting call. By default, it warns (naggy behavior).

### How to fix?
- If you expect such calls and want no warnings, use `NiceMock` or add a catch-all expectation:

```cpp
EXPECT_CALL(mock, Foo(_)).Times(AnyNumber());
```

- If the call is an error, add an explicit `EXPECT_CALL` with `.Times(0)` to forbid it:

```cpp
EXPECT_CALL(mock, Bar(_)).Times(0);
```

---

## 11. What does **RetiresOnSaturation()** do?

An expectation normally stays active even after being fulfilled (saturated). This means further calls matching it cause errors.

Using `.RetiresOnSaturation()` causes the expectation to retire (become inactive) as soon as it is saturated, allowing other expectations to match subsequent calls.

### Use case:

```cpp
EXPECT_CALL(mock, Foo(42)).Times(2).RetiresOnSaturation();
EXPECT_CALL(mock, Foo(_)).Times(AnyNumber());
```

Here two calls with argument 42 match the first expectation; additional calls match the second.

---

## 12. How do I **verify mock expectations early**, before object destruction?

Use `Mock::VerifyAndClearExpectations(&mock_object)` to verify all expectations on a mock and clear them explicitly.

### Example:

```cpp
MockTurtle* turtle = new MockTurtle;
EXPECT_CALL(*turtle, PenDown());

// ... exercise code using turtle ...

ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(turtle));

// Now safe to delete or transfer ownership
```

**Note:** Do not set new expectations after verification and clearing, as behavior then is undefined.

---

## 13. Can I **mock non-virtual methods**?

Not directly. gMock mocks virtual methods to intercept calls.

### Workarounds:
- Use dependency injection with interfaces (virtual methods).
- Use template techniques and mock classes that are unrelated to the real class but provide the same methods.

See [Mocking Non-virtual Methods](https://google.github.io/googletest/gmock_cook_book.html#MockingNonVirtualMethods) for details.

---

## 14. Can I **mock free functions or static methods**?

Not directly. GoogleMock can't mock free functions or static methods.

### Recommended approach:
- Wrap free functions in interfaces or adaptor classes that can be mocked.
- Rewrite your code to depend on abstractions instead of direct free function calls.

---

## 15. What do I do about **warnings from MSVC about const parameters in mock methods?**

MSVC sometimes issues warnings when you declare mock methods with const parameters. This is due to an MSVC compiler bug.

### Recommended fix:
- Remove top-level `const` qualifiers on parameters in both base and mock classes.
- Leave pointer or reference constness intact.

Example:

```cpp
// Instead of
virtual void Bar(const int i) = 0;
// Use
virtual void Bar(int i) = 0;
```

---

## 16. How do I debug **expectation failures**?

- Run tests with `--gmock_verbose=info` to see detailed mock call traces.
- Check the exact arguments passed to mock methods and which expectation it matched.
- Verify all calls occur **after** required calls if `.After()` or `InSequence` is used.
- Confirm that the number of calls matches `.Times()`.

---

## 17. How do I mock methods returning **move-only types** like `std::unique_ptr`?

Use `MOCK_METHOD` as usual. When returning such types from expectations:

- Use `.WillOnce(Return(std::make_unique<T>(...)))` for single returns.
- Use lambdas with `.WillRepeatedly([](...) { return std::make_unique<T>(...); })` for repeated calls.

Avoid reusing moved-from return values.

---

## Reference Links

- [gMock For Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Mocking Reference](../api-reference/core-apis/mocking.md)
- [Matchers Reference](../api-reference/core-apis/matchers.md)
- [Actions Reference](../api-reference/core-apis/actions.md)
- [Troubleshooting Common Issues](../../getting-started/validation-troubleshooting/common-issues.mdx)
- [Mock Strictness and Behavior Control Guide](../../guides/test-design-and-best-practices/mock-strictness-and-behavior.mdx)

---

This FAQ complements the detailed guides on [Using Mock Objects Effectively](../../guides/writing-and-running-tests/using-mock-objects.mdx) and best practices for mocking. Explore those for deeper understanding and advanced use cases.