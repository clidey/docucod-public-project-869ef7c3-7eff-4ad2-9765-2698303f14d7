---
title: "How can I improve test performance and scalability?"
description: "Explains practical steps to make test suites run faster and handle larger codebases, such as sharding, parallelization, and best practices for test structure."
---

# How can I improve test performance and scalability?

Improving the performance and scalability of your test suites is essential as your codebase grows. This page explains practical techniques such as test sharding, parallelization, and structuring tests effectively to make them run faster and handle larger projects without sacrificing reliability or clarity.

---

## Frequently Asked Questions

### What is test sharding and how does it improve performance?

Test sharding divides your total set of tests into smaller groups (shards) that can be run independently on multiple machines or processes. By running shards in parallel, you reduce the overall test execution time significantly.

In GoogleTest, you enable sharding using two environment variables:

- `GTEST_TOTAL_SHARDS`: the total number of shards into which tests should be divided.
- `GTEST_SHARD_INDEX`: the zero-based index of the shard that the current test process runs.

GoogleTest automatically selects a subset of tests to run for each shard such that all tests are covered without overlap.


### How do I run tests in parallel on a single machine?

GoogleTest by itself does not provide built-in parallel test execution inside a single process, but you can achieve parallelism by:

- Using test sharding with multiple processes on the same machine.
- Running multiple instances of your test binary concurrently with different shard indices.

Alternatively, you can integrate with external test runners that support parallelization, such as [`gtest-parallel`](https://github.com/google/gtest-parallel).


### What are best practices for structuring tests to improve scalability?

- **Isolate tests:** Each test should be independent and not depend on the side effects or order of others.
- **Use test fixtures judiciously:** Share setup and teardown resources at the test suite level via `SetUpTestSuite` and `TearDownTestSuite` to minimize expensive repeated initialization.
- **Filter tests effectively:** Use filtering via `--gtest_filter` to run only relevant subsets during development.
- **Disable or skip slow or flaky tests temporarily:** Use the `DISABLED_` prefix or `GTEST_SKIP()` to avoid blocking your test pipeline.


### How does filtering help performance?

Filtering allows users to run only a subset of tests by matching against test suite or test names. This avoids running expensive tests when they are not needed, speeding up feedback loops.

For example:

```bash
./my_tests --gtest_filter=FastTests.*:MathTests.Addition
```

runs all tests in `FastTests` suite and the `Addition` test in `MathTests` only.


### Can test sharding cause tests to be skipped or run multiple times?

GoogleTest guarantees that with correct configuration, each test function is run exactly once across all shards and none are skipped. Proper coordination of `GTEST_TOTAL_SHARDS` and `GTEST_SHARD_INDEX` for all test processes is crucial.


### What if some tests are slow and block scalability?

Identify slow tests by monitoring test durations. Some options to improve this are:

- Break slow tests into smaller units if possible.
- Run slow tests only when needed (e.g., nightly runs).
- Share expensive setup across tests via test suite fixtures.
- Use sharding or parallel execution to distribute slow tests across processes.


### How do test suite fixtures help in reducing setup overhead?

`SetUpTestSuite()` and `TearDownTestSuite()` are static methods in your test fixture class where you initialize and clean up expensive shared resources once per test suite rather than per test. This reduces redundant cost and scales better as the number of tests grows.

Example:

```cpp
class FooTest : public testing::Test {
 protected:
  static void SetUpTestSuite() {
    // Expensive setup done once.
  }

  static void TearDownTestSuite() {
    // Cleanup.
  }
};
```


### Are there any flags or environment variables to help with performance tuning?

Yes, some useful ones include:

- `--gtest_repeat=N`: runs all selected tests N times; useful for detecting flakiness but may increase runtime.
- `--gtest_shuffle`: runs tests in a random order to uncover dependencies, can expose inter-test interference.
- `--gtest_break_on_failure`: helps debugging by stopping at first failure.

Use these with care to optimize your test cycles.


---

## Common Issues & Gotchas

### Tests not running when sharding is enabled

- Ensure `GTEST_TOTAL_SHARDS` and `GTEST_SHARD_INDEX` are correctly set and consistent across all runners.
- Check that `GTEST_SHARD_INDEX` is always within `[0, GTEST_TOTAL_SHARDS - 1]`.
- Remember GoogleTest disables tests in other shards automatically; don't rely on explicit selection in your tests.

### Overhead from expensive per-test setups

- Avoid doing expensive I/O or allocations in `SetUp()` and `TearDown()` per test.
- Prefer static resource initialization in `SetUpTestSuite()`.

### Dependency on test order causing flaky results

Shuffling tests helps identify order dependency bugs. Fix tests to be independent for reliable scalability.


---

## Practical Tips for Optimizing Test Performance

- Combine **sharding** and **filtering** to run only necessary tests in parallel chunks.
- Use **parallel test runners** where possible.
- Profile and monitor test durations to spot bottlenecks.
- Avoid global mutable state to prevent test interference.
- Use GoogleTest's **disabled** tests feature to temporarily disable flaky or slow tests without removing them.


---

## Step-by-Step Guide to Enabling Sharding

<Steps>
<Step title="Determine your number of shards">
Decide on the total number of parallel test runners you wish to use, e.g., number of cores or machines.
</Step>
<Step title="Set environment variables per shard">
For each test runner, set:

```bash
export GTEST_TOTAL_SHARDS=<total-shard-count>
export GTEST_SHARD_INDEX=<shard-index>
```

where `<shard-index>` is zero-based.
</Step>
<Step title="Run the same test binary in all shards">
Start the test binary with the above environment variables set on each runner. Each will run a disjoint subset of tests.
</Step>
<Step title="Collect and aggregate results">
After all shards complete, collect their result outputs to get full test coverage.
</Step>
</Steps>


---

## Troubleshooting Common Performance Issues

### Why are some shards running no tests?

- Check if your tests are evenly distributed.
- A very uneven test duration distribution may result in some shards finishing very early.
- Consider grouping slow tests separately or adjusting sharding logic externally.

### Why is parallel execution slower than expected?

- Setup or teardown may be serialized due to shared resources.
- Tests may have hidden dependencies or global state contaminants causing bottlenecks.
- The overhead of starting many processes may offset gains for very small tests.

### How to detect slow tests?

- Use XML or JSON reports (`--gtest_output=xml:<file>` or `--gtest_output=json:<file>`) to analyze test timings.
- Look for tests with high elapsed time.


---

## Related Topics

- [Running a Subset of Tests](../advanced.md#running-a-subset-of-the-tests) — Filtering tests
- [Global Set-Up and Tear-Down](../advanced.md#global-set-up-and-tear-down) — Sharing expensive setup
- [Parameterized & Typed Tests](reference/testing.md#TEST_P) — Running data-driven tests efficiently
- [Optimizing Test Performance and Parallelism Guide](guides/integration-and-best-practices/optimizing-test-performance) — Full guide on performance


---

## References

- GoogleTest Primer: https://google.github.io/googletest/primer.html
- Running tests with sharding: https://github.com/google/googletest/blob/main/docs/advanced.md#distributing-test-functions-to-multiple-machines
- gtest-parallel tools: https://github.com/google/gtest-parallel
- Assertions Reference: https://google.github.io/googletest/reference/assertions.html


---

<Tip>
Optimizing your test performance is a continuous process. Start by parallelizing using sharding and filtering, then refine your tests' design and structure to minimize overhead and improve scalability.
</Tip>
<Note>
Avoid assuming perfect distribution of test runtime across shards. Monitor shard execution and adjust your test organization for best results.
</Note>
<Warning>
Do not run tests that share or mutate global state in parallel without proper isolation to prevent flaky failures.
</Warning>
<Check>
Verify that your build environment supports C++17 as GoogleTest requires it for all recent versions.
</Check>

