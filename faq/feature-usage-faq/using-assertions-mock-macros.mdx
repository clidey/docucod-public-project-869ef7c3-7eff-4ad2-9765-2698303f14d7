---
title: "How do I use assertions, matchers, and mock macros?"
description: "Explains common patterns, when to use specific macros, and how to avoid mistakes with GoogleTest assertions and GoogleMock macros. Covers troubleshooting unexpected assertion or mock failures."
---

# Using Assertions, Matchers, and Mock Macros in GoogleTest and GoogleMock

This guide explains common usage patterns for GoogleTest assertions and GoogleMock macros. It covers when to use specific assertion macros, how to apply matchers effectively, best practices for mock macros, and troubleshooting unexpected assertion or mock failures. Mastering these tools will help you write clear, robust tests with expressive failure diagnostics.

---

## 1. Understanding Assertions in GoogleTest

Assertions are the fundamental unit to verify expected behavior in tests. GoogleTest provides diverse macros that let you check conditions, compare values, verify exceptions, and more.

### 1.1 Fatal vs Non-fatal Assertions

- `ASSERT_` macros generate **fatal failures**: test aborts immediately, skipping remaining code in the current function.
- `EXPECT_` macros generate **non-fatal failures**: the test records the failure but continues running, enabling multiple issues to be caught in one run.

**Choose `ASSERT_` when failure means continuing might cause crashes or invalid state; use `EXPECT_` for softer checks.**

### 1.2 Common Assertion Types

- **Boolean Assertions:** `EXPECT_TRUE(condition)`, `EXPECT_FALSE(condition)`

- **Equality/Inequality:** `EXPECT_EQ(val1, val2)`, `EXPECT_NE(val1, val2)`, `EXPECT_LT`, `EXPECT_LE`, `EXPECT_GT`, `EXPECT_GE` for relational checks.

- **String Comparisons:** `EXPECT_STREQ`, `EXPECT_STRNE` for C-strings, and case-insensitive variants.

- **Floating Point:** `EXPECT_FLOAT_EQ`, `EXPECT_DOUBLE_EQ`, and `EXPECT_NEAR` to perform approximate comparisons avoiding precision pitfalls.

- **Exception Assertions:** `EXPECT_THROW`, `EXPECT_NO_THROW`, `EXPECT_ANY_THROW` for verifying exception behavior.

- **Explicit Success/Failure:** `SUCCEED()`, `FAIL()` to document or force test outcomes.

- **Predicate Assertions:** Useful for complex conditions, e.g., `EXPECT_PRED2(func, val1, val2)` prints argument values on failure.

### 1.3 Using Matchers in Assertions

Matchers let you express conditions more flexibly and readably, especially for complex objects or containers.

- Use `EXPECT_THAT(value, matcher)` to assert value meets a matcher condition.
- Built-in matchers include `StartsWith()`, `ContainsRegex()`, `ElementsAre()`, `AllOf()`, etc.
- You can combine, negate, or parameterize matchers to cover nuanced assertions.

### Example:
```cpp
EXPECT_THAT(my_string, StartsWith("Hello"));
EXPECT_THAT(my_vector, ElementsAre(1, Gt(0), _, 5));
EXPECT_THAT(result, AllOf(Gt(0), Lt(100)));
```

---

## 2. GoogleMock Macros for Mock Classes

GoogleMock extends GoogleTest by enabling precise control and verification of interactions with mocked interfaces.

### 2.1 Defining Mock Methods with `MOCK_METHOD`

Use:
```cpp
MOCK_METHOD(ReturnType, MethodName, (ArgTypes...), (qualifiers));
```

- Place mock methods in the `public:` section regardless of original method access.
- For const or noexcept methods, add `(const)` or `(noexcept)` in qualifiers.
- Use qualifiers like `override` to indicate overriding virtual functions.

### Example:
```cpp
class MockTurtle : public Turtle {
public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### 2.2 Setting Expectations with `EXPECT_CALL`

This macro specifies calls your mock object is expected to receive, their arguments, frequency, order, and behavior.

General syntax:
```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

#### Key modifiers:
- `.Times(...)` controls how many times the call is expected.
- `.WillOnce(...)` specifies action to perform on one call.
- `.WillRepeatedly(...)` sets a fallback action for any additional calls.
- `.InSequence(...)` to specify expected order with other calls.
- `.After(...)` to create partial ordering dependencies.
- `.RetiresOnSaturation()` causes the expectation to be disabled after its calls are fulfilled.
- `.With(matcher)` to match all arguments as a tuple.

If `.Times()` is omitted, cardinality is inferred based on actions.

**Best Practice: Set all expectations *before* exercising mock methods to avoid undefined behavior.**

### 2.3 Configuring Default Mock Behavior with `ON_CALL`

`ON_CALL(mock, Method(matchers...)).WillByDefault(action);` assigns what to do when a call is made but does not set an expectation.

Use it to set default behavior shared across tests, keeping your tests focused on verifying expected calls.

### 2.4 Using Different Strictness Levels

- **NaggyMock (default):** warns on calls with no matching expectation.
- **NiceMock:** suppresses such warnings.
- **StrictMock:** treats uninteresting calls as errors.

Adjust mock strictness to balance between noise and strict verification.

### 2.5 Choosing Matchers for Method Arguments

- Use `_` to match any argument.
- Use built-in matchers like `Eq()`, `Gt()`, `NotNull()`, or custom matchers.
- Use `With()` to express conditions on the entire argument list.
- For pointers, use matchers like `Pointee()`.

### Example EXPECT_CALL:
```cpp
EXPECT_CALL(mock_turtle, GoTo(50, _))
    .Times(2)
    .WillRepeatedly(Return());
```

### 2.6 Actions for Mock Methods

In addition to `Return(value)`, GoogleMock provides actions like:

- `ReturnRef(variable)` for returning references,
- `ReturnPointee(ptr)` returning *pointed* values,
- `SetArgPointee<N>(value)` to modify output arguments,
- `DoAll(...)` to chain multiple actions,
- `Invoke(functor/lambda)` to use arbitrary callable behavior.

---

## 3. Practical Tips & Best Practices

### 3.1 When to Use `EXPECT_CALL` vs `ON_CALL`

- Use `EXPECT_CALL` when verifying that a method is called with particular arguments or count.
- Use `ON_CALL` for setting default behaviors without asserting calls.
- Avoid excessive `EXPECT_CALL`s that over-specify behavior, making tests brittle.

### 3.2 Handling Overloaded Methods

- Disambiguate overloads by specifying parameter types explicitly in `MOCK_METHOD`.
- When setting expectations, ensure that the correct overload is targeted.

### 3.3 Avoiding Sticky Expectation Pitfalls

Expectations by default remain active (sticky) after their call count is reached, causing unexpected upper-bound errors if multiple expectations overlap. Use `.RetiresOnSaturation()` to retire expectations on saturation.

### 3.4 Order of Expectations and Calls

- By default, calls can happen in any order matching expectations.
- Use `InSequence` or `.After()` to enforce call order.
- Put expectations with broader matchers before more specific ones.

### 3.5 Common Mistakes

- Setting expectations after calls: Causes undefined behavior.
- Forgetting to set actions for non-void mock methods (they default to returning default constructor or zero).
- Over-specifying matchers causing brittle tests.

### 3.6 Debugging Unexpected Assertion Failures

- Run tests with `--gmock_verbose=info` to see detailed matching and call info.
- Use `SCOPED_TRACE()` in complex test helper functions to add context.

### 3.7 Simplifying Mock Interfaces

For awkward APIs, consider wrapping or redispatching methods in your mock classes to provide simplified mock interfaces that ease writing expectations.

---

## 4. Troubleshooting Common Issues

### 4.1 Unexpected Mock Function Call Failure

Occurs when a mock method is called with arguments that do not match any `EXPECT_CALL`.

**Solution:**
- Add a broad `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` to allow calls with other arguments.
- Verify argument matchers and call order.

### 4.2 Actions Running Out

If the number of times the mock function is called exceeds the number of `WillOnce` actions specified without a `WillRepeatedly`, GoogleMock warns and uses the default action.

**Solution:**
- Add `.WillRepeatedly(...)` to handle calls beyond `WillOnce`s.
- Use `.Times()` to match the number of expected calls.

### 4.3 Matcher Type Mismatches

Mismatch between argument types and matcher types can cause compilation errors.

**Solution:**
- Use `SafeMatcherCast<T>(matcher)` to safely cast matchers.
- Review matchers to ensure they match argument types.

### 4.4 Issues with Move-Only Types

GoogleMock supports mocking methods with move-only arguments and return types, but some actions may not work seamlessly.

**Solution:**
- Use lambdas or callable objects with `WillOnce` or `WillRepeatedly` to produce or handle move-only types dynamically.

### 4.5 Compilation Errors with Commas in Mock Method Parameters

Parameters containing commas (e.g., `std::pair<int,int>`) need special handling.

**Solution:**
- Wrap such types in parentheses in `MOCK_METHOD`, or use a `using` alias.

---

## 5. Examples of Using Assertions and Mock Macros

### 5.1 Simple Assertion Example
```cpp
TEST(MyTestSuite, SimpleEqualityCheck) {
  int result = ComputeResult();
  EXPECT_EQ(result, 42) << "Result should be 42";
}
```

### 5.2 Using `EXPECT_THAT` with Matchers
```cpp
TEST(MyTestSuite, StringStartsCorrectly) {
  std::string name = GetName();
  EXPECT_THAT(name, StartsWith("Goog"));
}
```

### 5.3 Simple Mock Definition and Usage
```cpp
class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(int, GetRecordCount, (), (const, override));
};

TEST(DatabaseUserTest, ConnectsSuccessfully) {
  MockDatabase mock_db;

  EXPECT_CALL(mock_db, Connect("db://localhost"))
      .Times(1)
      .WillOnce(Return(true));

  bool success = UseDatabase(&mock_db);
  EXPECT_TRUE(success);
}
```

### 5.4 Using `ON_CALL` for Default Behavior
```cpp
ON_CALL(mock_db, GetRecordCount())
    .WillByDefault(Return(100));
```

---

## 6. Where to Go Next

- For a complete list of assertion macros see the [Assertions Reference](reference/assertions.md).
- To explore expressive matchers in depth, consult the [Matchers Reference](reference/matchers.md).
- For advanced mock interaction concepts and patterns, see the [Mocking Reference](reference/mocking.md) and [gMock Cookbook](gmock_cook_book.md).
- To improve test performance including effective use of assertions, consult the [Performance Optimization Guide](guides/advanced-best-practices/performance-optimization.md).

---

## Summary
This page helps users understand the effective use of GoogleTest assertion macros and GoogleMock mock macros. It covers the distinctions between assertion types, how to utilize matchers for expressive test verification, best practices when writing mock expectations and default behaviors, plus practical guidance on common pitfalls and troubleshooting. Clear examples illustrate typical usage scenarios to ensure users can write robust, precise unit tests and mock interactions.

---

<AccordionGroup title="Quick Tips and Common Pitfalls">
<Accordion title="Avoid Over-Specifying Expectations">
Overly strict EXPECT_CALLs limit test flexibility and increase maintenance. Specify only what behavior you truly want to verify; use ON_CALL for default actions.
</Accordion>
<Accordion title="Match Arguments Precisely but Simply">
Use matchers like `_` to allow any argument when details are unimportant; combine matchers for complex conditions.
</Accordion>
<Accordion title="Order Matters: Set Expectations First">
Always set your EXPECT_CALLs before exercising mock methods to avoid undefined behavior and ensure proper verification.
</Accordion>
<Accordion title="Retiring Expectations to Prevent Upper-Bound Errors">
Use `.RetiresOnSaturation()` for sequential call expectations that must not persist after being fulfilled.
</Accordion>
</AccordionGroup>

<Tip>
Consider using `--gmock_verbose=info` during test runs to get detailed logs of expectation matching, aiding in debugging test failures.
</Tip>

---

## References & Further Reading
- [GoogleTest Assertions Reference](reference/assertions.md)
- [GoogleMock Mocking Reference](reference/mocking.md)
- [GoogleMock Matchers Reference](reference/matchers.md)
- [GoogleMock Cookbook](gmock_cook_book.md)
- [Performance Optimization Guide](guides/advanced-best-practices/performance-optimization.md)
- [Getting Started with GoogleMock](guides/getting-started/first-mock.md)
- [Test Creation and Running Tests](api-reference/core-apis/test-creation.md)

---

For a broader understanding, explore related pages:

* Core Concepts: [Core Concepts and Terminology](overview/foundations-and-architecture/core-concepts-and-terminology.md)
* Test Authoring Basics: [Writing Your First Test](guides/getting-started/first-test.md)
* Advanced Mocking: [Advanced Mocking Patterns and Expectations](guides/core-scenarios/working-with-mocks.md)

---