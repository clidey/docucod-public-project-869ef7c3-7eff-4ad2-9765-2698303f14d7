---
title: "Why Are My Assertions or Expectations Failing?"
description: "Explains common mistakes that lead to assertion or expectation failures in both GoogleTest and GoogleMock, with advice on using matchers, proper test design, and analyzing output details."
---

# Why Are My Assertions or Expectations Failing?

This page addresses the common causes behind assertion or expectation failures when using GoogleTest and GoogleMock. By understanding typical mistakes and knowing how to analyze the output, you can confidently diagnose and fix failing assertions to make your tests reliable and meaningful.

---

## 1. Common Causes of Assertion Failures

Assertions in GoogleTest (e.g., `EXPECT_EQ`, `ASSERT_TRUE`) or expectations in GoogleMock (e.g., from `EXPECT_CALL`) can fail due to numerous factors. Here are the most frequent reasons:

- **Incorrect Use of Matchers or Values**: When using GoogleMock, providing literal values instead of appropriate matchers or misapplying matchers leads to unexpected failures.

- **Logic Errors in Tests**: Assertion conditions may contain logic mistakes or incorrect expectations, causing tests to fail legitimately.

- **Misunderstanding Assertion Semantics**: Confusing fatal and non-fatal failures can cause unexpected test termination or continuation.

- **Multiple Failures in Subroutines**: Failures inside helper functions or subroutines without proper propagation can obscure root causes.

- **Incorrect Usage of Assertions in Non-void Functions**: Fatal assertions (e.g., `ASSERT_*`) require void-returning contexts; misuse leads to compilation or runtime surprises.

- **Ignoring Test Scopes and Setup/Teardown Effects**: Failures that arise from incorrect fixture setup or environmental conditions.


## 2. Diagnosing Failures Effectively

GoogleTest and GoogleMock provide detailed output to help you understand why assertions fail.

### Reading Failure Messages

- GoogleTest prints the expression tested, expected values, and actual values. Example:

```none
Value of: foo
  Actual: 3
Expected: 5
```

- For string comparison failures, a diff highlighting mismatches may be shown.

- When using predicate assertions (`EXPECT_PRED*`) or predicate-formatter assertions (`EXPECT_PRED_FORMAT*`), failure messages include the evaluated argument values and expressive error messages.

- For complex matchers with `EXPECT_THAT`, the output describes which matcher failed.

### Using Stack Traces

- For fatal failures, stack traces showing the location of the failure and call sites can assist in pinpointing issues.

- Use `--gtest_stack_trace_depth` flag to control how many frames are shown.

### Checking Test Fixture State

- Use `SCOPED_TRACE` to add contextual information for assertions within loops or nested calls.

- Access the current test info using:

```cpp
const testing::TestInfo* test_info = testing::UnitTest::GetInstance()->current_test_info();
```

to log test-specific details.

---

## 3. Best Practices for Writing Assertions and Expectations

### Use the Correct Matchers in GoogleMock

- Always use GoogleMock matchers (such as `Eq()`, `Ge()`, `HasSubstr()`) when specifying expectations on mock method arguments.

- Avoid mixing literal values and matchers incorrectly. For example, use:

```cpp
EXPECT_CALL(mock, DoSomething(Eq(5)));  // Correct
EXPECT_CALL(mock, DoSomething(5));      // Also works but limits flexibility
```

- For string matching, prefer matchers like `StrEq()`, `HasSubstr()`, or regex matchers instead of simple value comparisons.

### Choose Between Fatal and Non-Fatal Assertions Appropriately

- Use `ASSERT_*` when failures should abort the current test function immediately to avoid cascading errors.

- Use `EXPECT_*` when the test can continue after a failure for broader failure reporting.

- Recognize that fatal assertions abort only the current function, not the whole test. Use techniques below to propagate fatal failures if needed.

### Propagating Fatal Failures from Subroutines

- If your helper function contains fatal assertions and you want to abort the whole test on failure, check for failures using `HasFatalFailure()` after invoking it:

```cpp
void Helper() {
  ASSERT_EQ(some_val, expected);
}

TEST(SomeTest, Example) {
  Helper();
  if (HasFatalFailure()) return;  // abort test early
  ...
}
```

- Alternatively, enable exceptions on failures using a test event listener (when exceptions are enabled):

```cpp
class ThrowListener : public testing::EmptyTestEventListener {
  void OnTestPartResult(const testing::TestPartResult& result) override {
    if (result.type() == testing::TestPartResult::kFatalFailure) {
      throw testing::AssertionException(result);
    }
  }
};
// Append the listener before RUN_ALL_TESTS()
```

- Use `ASSERT_NO_FATAL_FAILURE()` or `EXPECT_NO_FATAL_FAILURE()` macros to verify that blocks of code do not produce fatal failures.

### Use Predicate and Predicate-Formatter Assertions for Complex Conditions

- When you need to validate complex logical conditions, define predicate functions that return `AssertionResult` to produce clear error messages, then use `EXPECT_TRUE()` or the `EXPECT_PRED_FORMAT*` macros.

### Log Helpful Information

- Use `RecordProperty(key, value)` to attach extra information to tests or test suites.

- Stream rich failure messages by appending custom messages with `<<` to assertion macros.

### Avoid Common Pitfalls

- Do not use `ASSERT_*` inside constructors or destructors of test fixtures; use `SetUp()`/`TearDown()` instead.

- Avoid mixing `TEST` and `TEST_F` in the same test suite.

- Naming tests or test suites starting with `DISABLED_` skips their execution.

---

## 4. Using Special Macros to Catch Assertion Failures in Tests

GoogleTest provides macros to catch and verify that certain code produces failures:

- `EXPECT_FATAL_FAILURE(statement, substring)` verifies that `statement` produces exactly one fatal failure in the current thread.

- `EXPECT_NONFATAL_FAILURE(statement, substring)` does the same for non-fatal failures.

- Variants exist to check failures across all threads: `EXPECT_FATAL_FAILURE_ON_ALL_THREADS` and `EXPECT_NONFATAL_FAILURE_ON_ALL_THREADS`.

These macros are particularly useful when writing tests for test utilities or verifying behavior of tests that should fail under certain conditions.

---

## 5. Understanding Failure Output in Depth

- Failure messages include the file and line number where the assertion failed.

- GoogleTest may append additional context such as the expression evaluated, expected/actual values, and any user-provided message.

- Stack traces help differentiate between user test failures and internal framework issues.

- Differences in string contents and complex types come with clear diffs to identify mismatches.

Example failure snippet:

```none
/path/to/test_file.cc:42: Failure
Expected equality of these values:
  foo_val
    Which is: 5
  expected_val
    Which is: 10
Out:
  Some additional output text
```

---

## 6. Troubleshooting Tips

- Re-examine matchers and values for argument mismatches.

- Verify that expectations and actions in mocks align with test flow.

- Use `SCOPED_TRACE()` to add context to multiple related assertions.

- Check the order of test execution if dependent on setup or previous test results.

- Use the `--gtest_break_on_failure` flag to drop into a debugger on failure.

- Generate verbose logging by setting `--gmock_verbose=info` for more insights.

- Test failure messages and logs often provide immediate clues to resolve issues.

---

## 7. Summary

Failures in assertions or expectations usually stem from mismatched conditions, misuse of matchers, or test logic errors. GoogleTest's rich diagnostics including failure messages, diffs, and stack traces empower you to diagnose these problems swiftly. Leveraging `SCOPED_TRACE`, predicate assertions, and proper test design ensures robust, maintainable tests.

Keep assertions straightforward, propagate fatal failures properly, and utilize GoogleMock matchers to express expectations clearly.

---

## Related Documentation

- [Assertions Reference](../reference/assertions.md): Detailed information on all GoogleTest assertions.

- [Advanced GoogleTest Topics](../docs/advanced.md): Best practices and detailed assertion usage.

- [Using Matchers for Flexible Expectations](../guides/mocking-scenarios/using-matchers.md): How to correctly use matchers in GoogleMock.

- [Mock Strictness: Nice, Naggy, and Strict](../guides/mocking-scenarios/mock-strictness-best-practices.md): Guidelines for controlling mock call strictness.

- [Debugging Test Failures FAQ](../faq/troubleshooting-runtime/debugging-test-failures.md): Approaches for isolating and fixing flaky or failing tests.

---

## Practical Example: Propagation of Fatal Failures

```cpp
void Helper(int n) {
  ASSERT_EQ(n, 42) << "Value is not 42";
}

TEST(MyTestSuite, TestExample) {
  Helper(10);
  if (HasFatalFailure()) return;  // Prevent running further in invalid state.

  // The rest of the test executes only if Helper succeeded.
  EXPECT_TRUE(SomeCondition());
}
```

This pattern avoids crashes caused by continuing after a fatal failure in helpers.

---

## Tips

- When an assertion or mock expectation fails, examine the output carefully: the expressions, their evaluated values, and the message for clues.
- Add `SCOPED_TRACE` with descriptive messages in loops or helper functions to distinguish failures.
- For assertions in subroutines, use `ASSERT_NO_FATAL_FAILURE` or check `HasFatalFailure()`.
- Always prefer expressive matchers over manual checks for readability and informative failure messages.
- Use `EXPECT_FATAL_FAILURE` macros in meta-tests when verifying failure behavior.

---

By mastering these guidelines, users can reduce frustration, write clearer tests, and ensure their testing suite provides reliable feedback for their code base.