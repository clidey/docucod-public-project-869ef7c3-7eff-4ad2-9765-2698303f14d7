---
title: "How can I make my test suite faster and more reliable?"
description: "Shares best practices for optimizing test speed and stability, such as using the right matchers, minimizing side effects, and running tests in parallel. Addresses frequent performance bottlenecks and suggests test structuring techniques."
---

# How Can I Make My Test Suite Faster and More Reliable?

Optimizing your test suite's speed and stability is critical for efficient development and reliable delivery. This page shares best practices specifically targeting test performance and stability within the GoogleTest and GoogleMock ecosystems. It addresses common bottlenecks, test structuring techniques, and configuration tips that help you write tests that run quickly, remain stable, and are easy to maintain.

---

## 1. Understanding Test Speed Bottlenecks

Your tests can slow down or become unreliable due to various factors. Common reasons include:

- **Expensive Setup or Teardown:** Tests that repeatedly create or destroy complex objects or external resources.
- **Unnecessary Side Effects:** Tests that perform I/O, network calls, or interact with real databases instead of mocks or fakes.
- **Excessive or Redundant Expectations:** Overly constrained mocks or too many expectations that slow down verification.
- **Serial Execution:** Tests running sequentially when they could run in parallel.

Identifying these bottlenecks early will focus your optimization efforts effectively.

## 2. Using Appropriate Matchers to Improve Speed

Complex or custom matchers may slow down test execution if overused. To keep matching efficient:

- Prefer simple matchers like `_` (wildcard), `Eq()`, or numeric comparisons when possible.
- Avoid heavy computations or side effects in custom matchers; they must be pure and fast.
- Use parameterized or reusable matchers to avoid redundant logic.

### Example

Instead of:

```cpp
EXPECT_CALL(mock_obj, Process(IsDivisibleBy7()));  // Custom matcher with logic
```

Prefer:

```cpp
EXPECT_CALL(mock_obj, Process(AllOf(Ge(0), Lt(100))));  // Built-in simple matchers
```

## 3. Minimizing Side Effects in Mocks

Mocks should not perform expensive work or cause side effects that impact test speed or stability.

- Use `ON_CALL()` to define default lightweight behaviors for mocks to avoid overhead from missing expectations.
- Avoid complex computation or stateful modifications in `WillOnce()` or `WillRepeatedly()` actions unless necessary.
- Use `NiceMock<>` to suppress warnings on uninteresting calls without needing extensive `EXPECT_CALL`s.

## 4. Structuring Tests for Stability and Maintainability

Well-organized tests run faster and are less fragile.

- **Keep Tests Small and Focused:** Each test should verify one behavior to minimize setup and clarify failures.
- **Use Test Fixtures Wisely:** Share expensive setup across tests, but avoid overusing global state.
- **Avoid Overconstraining Mocks:** Don't expect calls unless you must verify them; use `ON_CALL` to specify normal behavior.
- **Use Sequences and Partial Ordering Carefully:** To avoid brittle tests, impose call orders only when essential.

## 5. Parallelizing Test Execution

GoogleTest supports running tests in parallel to cut down total test time.

- Split your tests into small, independent test cases to maximize parallelism.
- Avoid sharing mutable global state between tests.
- Use build system or test runners (e.g., bazel `--jobs` flag, `ctest`, or `gtest-parallel`) to run tests concurrently.

## 6. Test Reuse and Mock Setup Optimization

To speed up repeated test runs:

- Set common mock defaults once in test fixtures using `ON_CALL`.
- Use `EXPECT_CALL(...).Times(AnyNumber())` to avoid unexpected call failures without incurring excessive overhead.
- Reset mocks explicitly if needed between tests to avoid leaks and ensure clean state.

## 7. Best Practices for Expectation Configuration

- Put `MOCK_METHOD` declarations in the `public:` section of your mock classes to ensure correct mock method access.
- Use cardinalities such as `Times(AtLeast(n))` or `Times(AnyNumber())` wisely to avoid unnecessary verification overhead.
- Use `.RetiresOnSaturation()` to prevent sticky expectations from slowing down subsequent calls.
- Prefer chaining `WillOnce(...)` and `WillRepeatedly(...)` for concise, ordered mock actions.

## 8. Debugging Performance and Stability Issues

- Use `--gmock_verbose=info` to get detailed logs of mock expectations and invocations.
- Monitor warnings about uninteresting calls, saturated expectations, or leaked mocks.
- Use `Mock::VerifyAndClearExpectations(&mock_obj)` early to catch unsatisfied expectations promptly.
- Profile your tests to spot slow mocks or repeated heavy setup.

## 9. Summary Example: Optimized Mock Setup

```cpp
class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (), (override));
  MOCK_METHOD(std::string, Query, (const std::string&), (override));
};

class MyTestFixture : public ::testing::Test {
 protected:
  void SetUp() override {
    ON_CALL(db_, Connect()).WillByDefault(Return(true));
    ON_CALL(db_, Query(_)).WillByDefault(Return("default result"));
  }

  MockDatabase db_;
};

TEST_F(MyTestFixture, FastQueryTest) {
  EXPECT_CALL(db_, Query("SELECT * FROM users")).Times(1);
  // Exercise code that calls db_.Query("SELECT * FROM users")
}

TEST_F(MyTestFixture, OtherTest) {
  // No strict expectation, uses default ON_CALL behavior
  // Allows test to run without failures on uninteresting calls
}
```

## 10. Additional Tips

- Avoid chaining many expectations on the same method if the order doesn't matter.
- Use `NiceMock` to avoid noise from uninteresting calls during iterative development.
- When mocking move-only types, define expectations carefully and use lambdas for repeated returns.
- Use `SaveArg<>` and `With()` matchers sparingly to keep matchers simple and fast.
- Regularly verify that mocks are properly cleaned up to avoid leaks affecting performance.

---

## Related Topics

- [Mocking Basics: Using GoogleMock](guides/mocking-and-advanced-techniques/mocking-basics.md)
- [Configuring Actions & Expectations](guides/mocking-and-advanced-techniques/actions-and-expectations.md)
- [Advanced Mocking Patterns & Troubleshooting](guides/mocking-and-advanced-techniques/advanced-mocking-patterns.md)
- [Writing Clean, Maintainable Tests](guides/best-practices-and-tuning/writing-clean-tests.md)
- [Organizing and Running Tests](guides/everyday-workflows/organizing-test-structure.md)
- [GoogleMock Cheat Sheet](docs/gmock_cheat_sheet.md)

## Troubleshooting

<AccordionGroup title="Common Issues with Test Performance and Stability">
<Accordion title="Tests Run Slowly Due to Excessive Setup or Mocks">
Minimize heavy operations in setup or teardown. Use shared fixtures and lightweight mocks with default behaviors for uninteresting calls.
</Accordion>
<Accordion title="Receiving Warnings on Uninteresting Mock Calls">
Use `NiceMock<>` to suppress warnings or add `EXPECT_CALL(...).Times(AnyNumber())` for methods frequently called without precise expectations.
</Accordion>
<Accordion title="Tests Fail Due to Sticky Expectations Being Overused">
Use `.RetiresOnSaturation()` to retire expectations once fulfilled, avoiding unexpected failures on repeated calls.
</Accordion>
<Accordion title="Tests Are Flaky When Run in Parallel">
Ensure no shared mutable state between tests; isolate side effects. Use thread-safe mocks or guard shared resources.
</Accordion>
<Accordion title="Mock Leaks Detected at Program Exit">
Call `Mock::AllowLeak(&mock_obj)` if intentional. Otherwise, verify correct mock destruction and avoid persistent mock objects beyond test scope.
</Accordion>
</AccordionGroup>

<Tip>
For detailed debugging of mocks, run tests with `--gmock_verbose=info` to see all expectation and call traces, aiding in diagnosing slow or failing tests.
</Tip>

---

## Summary

This page guides you through optimizing the speed and reliability of GoogleTest and GoogleMock driven test suites. You will learn how to minimize matcher complexity, reduce side effects, organize expectations efficiently, and leverage parallel test execution. Practical examples and troubleshooting advice help you identify and fix common pitfalls that impact performance and stability.

---

## References

- [gMock Cookbook - Setting Default Actions](docs/gmock_cook_book.md#Setting the Default Actions for a Mock Method)
- [Mocking Basics](guides/mocking-and-advanced-techniques/mocking-basics.md)
- [Actions and Expectations](guides/mocking-and-advanced-techniques/actions-and-expectations.md)
- [Writing Clean, Maintainable Tests](guides/best-practices-and-tuning/writing-clean-tests.md)
- [Organizing and Running Tests](guides/everyday-workflows/organizing-test-structure.md)

---

## Next Steps

- Review detailed mocking guides to master expectation configuration.
- Explore test organization documents to improve suite architecture.
- Use profiling and verbose logging to target specific slow or flaky tests.

---

**Note:** This guide focuses closely on practices directly affecting test speed and stability to help you achieve fast, reliable, and maintainable automated testing workflows with GoogleTest and GoogleMock.
