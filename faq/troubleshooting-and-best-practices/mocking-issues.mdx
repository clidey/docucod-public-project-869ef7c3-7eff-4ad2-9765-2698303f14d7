---
title: "How do I resolve issues with mock behaviors and expectations?"
description: "Covers common problems when using GoogleMock—unmet expectations, incorrect matches, working with NiceMock/StrictMock, and troubleshooting ON_CALL/EXPECT_CALL usage. Offers actionable fixes and code references."
---

# Resolving Issues with Mock Behaviors and Expectations in GoogleMock

When working with GoogleMock (gMock) to create and manage mock objects in C++, it's common to encounter issues related to unmet expectations, incorrect argument matches, or unexpected mock behaviors. This guide covers common problems you might face when using mocking primitives like `EXPECT_CALL` and `ON_CALL`, explains how to interpret warnings and errors, and offers actionable solutions to fix these issues effectively.

---

## 1. Understanding the Difference Between `EXPECT_CALL` and `ON_CALL`

- **`EXPECT_CALL`** asserts that a mock method will be called with specific arguments and a certain frequency. It sets both a behavior and an explicit expectation that the call must happen.

- **`ON_CALL`** sets the default behavior for a mock method without imposing any expectation that the method will be called.

**Common Pitfall:** If you set default behavior using `ON_CALL` but do not define an `EXPECT_CALL` for that method in your test, gMock treats calls to those methods as *uninteresting* calls. By default, this triggers a warning but not a failure.

**Fix:** Add an explicit `EXPECT_CALL` with `.Times(AnyNumber())` to suppress warnings if you expect calls but don't want to verify them.

```cpp
using ::testing::_;  // Wildcard matcher
using ::testing::AnyNumber;

ON_CALL(mock_obj, SomeMethod(_)).WillByDefault(Return(42));
EXPECT_CALL(mock_obj, SomeMethod(_)).Times(AnyNumber());
```

---

## 2. Handling Unmet Expectations and Unexpected Calls

### Common Causes

- Forgetting to set `EXPECT_CALL` before exercising the code under test.
- Arguments passed to mock methods not matching any `EXPECT_CALL` matcher.
- Calls exceeding the number specified by `.Times()`.

### Symptoms

- Test failure messages indicating "Actual function call count doesn't match".
- "Unexpected mock function call" errors.
- Warnings about "Uninteresting function call encountered".

### Resolution Steps

1. **Review Argument Matchers:** Ensure your `EXPECT_CALL` uses appropriate matchers (`_`, `Eq()`, `Ge()`, etc.) to align with actual argument values.
2. **Check Call Order if Using Sequences:** If you use `InSequence` or `.After()`, verify calls occur in the correct order.
3. **Adjust Cardinality Properly:** Use `.Times()`, `.WillOnce()`, and `.WillRepeatedly()` clauses to match your expected call count and behavior.

### Example: Specifying Multiple Return Behaviors for Repeated Calls

```cpp
EXPECT_CALL(mock_obj, GetValue())
    .WillOnce(Return(10))     // First call returns 10
    .WillOnce(Return(20))     // Second call returns 20
    .WillRepeatedly(Return(30));  // Subsequent calls return 30
```

If the number of calls exceeds these and no `.WillRepeatedly()` is specified, gMock will report "Actions ran out" warnings or failures.

---

## 3. Using `RetiresOnSaturation()` to Manage Expectations' Lifecycle

Expectations in gMock are "sticky" by default, meaning they remain active even after the expected number of calls has been reached, potentially causing errors on extra calls.

- Use `.RetiresOnSaturation()` on an expectation to automatically deactivate it when its expected call count is met.

Example:

```cpp
EXPECT_CALL(mock_obj, DoWork(5))
    .Times(2)
    .RetiresOnSaturation();

EXPECT_CALL(mock_obj, DoWork(_))
    .Times(AnyNumber());

// First two calls to DoWork(5) match the first expectation.
// Additional calls match the catch-all expectation.
```

---

## 4. Working with NiceMock, NaggyMock, and StrictMock

### Behavior of Different Mock Types

| Mock Type   | Uninteresting Calls (No EXPECT_CALL)                   |
|-------------|---------------------------------------------------------|
| **NiceMock**  | Suppresses warnings (silent)                           |
| **NaggyMock** | Prints warnings (default behavior for mocks)           |
| **StrictMock**| Fails the test on uninteresting calls (treats as errors) |

Misunderstanding these modes often leads to confusion about missing expectations.

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock;
ON_CALL(mock, Method()).WillByDefault(Return(true));
// No warning on uninteresting calls to Method
```

---

## 5. Common Issues When Using `EXPECT_CALL` and How to Fix Them

### a) Newer Expectations Override Older Ones

By default, gMock searches expectations in reverse order, so more recently defined expectations take priority. This can cause the latest `EXPECT_CALL` to shadow earlier ones unintentionally.

**Fix:**

- Place more general expectations earlier and more specific ones later.
- Use sequences or explicit ordering to manage expectations.

### b) Over-specifying Expectations Leading to Brittle Tests

Overly strict expectations on arguments or call order cause flaky tests.

**Best Practice:**
- Use wildcards (`_`) or matchers like `AnyNumber()` when exact arguments or call counts are not needed.
- Set precise expectations only when verifying important interactions.

### c) Calls to Overloaded Methods Ambiguous

If a method is overloaded, omitting argument matchers leads to compilation errors.

**Fix:** Provide argument matchers to select the correct overload, or define a simpler mock interface.

---

## 6. Troubleshooting `ON_CALL` and `EXPECT_CALL` Usage

### `ON_CALL` vs. `EXPECT_CALL`

- `ON_CALL` sets default actions but does NOT enforce that the method is called.
- `EXPECT_CALL` asserts the method will be called with matching arguments.

### Typical Pitfall: Missing Default Action for Return Value

If a mock method returning a non-void type has no default action, and no `WillOnce` or `WillRepeatedly` is specified in the expectation, gMock will:

- Throw an error if no default value exists for the return type.
- Return the default value otherwise, which might not be intended.

**Fix:** Always specify a default action in `ON_CALL`, or specify actions in `EXPECT_CALL`.

Example:

```cpp
ON_CALL(mock, GetCount()).WillByDefault(Return(0));
EXPECT_CALL(mock, GetCount()).Times(AnyNumber());
```

---

## 7. Diagnosing Error Messages

When tests fail due to mock issues, carefully read the output messages. They commonly include:

- **Uninteresting call warnings:** A mock method was called without matching `EXPECT_CALL`. Consider adding `EXPECT_CALL` or suppressing with `NiceMock`.

- **Unexpected call error:** The arguments or call order did not match any expectation. Use `--gmock_verbose=info` flag to see detailed call traces for debugging.

- **Excessive call error:** A mock method was called more times than expected.

- **Unsatisfied prerequisites:** Calls made out of order with respect to sequences or `.After()` clauses.

---

## 8. Practical Tips and Best Practices

- **Define expectations *before* exercising code** to avoid undefined behaviors.
- Use wildcards (`_`) when argument values are not important to your test.
- Use `.Times(AnyNumber())` for methods called but not verified in detail.
- Leverage `RetiresOnSaturation()` for non-sticky expectations to avoid upper bound violations.
- Use `InSequence` or `.After()` to specify call ordering only when necessary.
- Use `NiceMock` to silence warnings on uninteresting calls during widespread testing.
- Run tests with `--gmock_verbose=info` to diagnose puzzling failures by seeing detailed call and matching history.
- Always specify default actions for methods returning non-void types.

---

## 9. Example: Handling Uninteresting Calls

```cpp
using ::testing::NiceMock;
using ::testing::_;

class MockPrinter {
 public:
  MOCK_METHOD(void, Print, (int count), (override));
};

// Test where Print may be called with various counts but only some are checked.
TEST(PrinterTest, PartialExpectations) {
  NiceMock<MockPrinter> mock_printer;

  ON_CALL(mock_printer, Print(_)).WillByDefault(Return()); // Default noop action

  // Expect exactly 3 calls with count 10.
  EXPECT_CALL(mock_printer, Print(10)).Times(3);

  // Calls with other counts will be silently ignored.
  mock_printer.Print(5);
  mock_printer.Print(10);
  mock_printer.Print(10);
  mock_printer.Print(10);
}
```

---

## 10. Further Diagnostics and Advanced Troubleshooting

If problems persist after verifying usage and expectations:

- Use debug flags such as `--gmock_verbose=info` for detailed logs.
- Check for stale mocks or mocks leaked without destruction, which prevent expectation verification.
- Use `Mock::VerifyAndClearExpectations(&mock_obj)` to force verification before object destruction.
- Be cautious with mocking inherited mock methods, as `NiceMock` or `StrictMock` may not affect them.
- Review the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) and [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced examples and usage.

---

## Related Documentation

- [GoogleMock Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — Detailed API and macro usage.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Patterns, recipes, and common scenarios.
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Beginner-friendly tutorial.
- [Expectations and Actions](https://google.github.io/googletest/reference/actions_and_expectations.html) — Clarifies mock behavior configuration.
- [Using NiceMock and StrictMock](https://google.github.io/googletest/gmock_cook_book.html#NiceStrictNaggy) — Handling uninteresting calls.

---

## Summary
Effectively resolving issues with mock behaviors and expectations in GoogleMock requires an understanding of the difference between `EXPECT_CALL` and `ON_CALL`, proper use of argument matchers and cardinalities, strategic use of sequences and call ordering, and awareness of special mock wrappers like NiceMock and StrictMock. When troubles arise, leveraging verbose logging and the built-in diagnostics will lead to faster troubleshooting and more robust tests.

<Tip>
Always set explicit expectations before code execution, and avoid over-specifying; balance your test granularity to catch real bugs without brittle test failures.
</Tip>

---