---
title: "Best Practices for Efficient Use of Mocks"
description: "Shares practical recommendations for writing maintainable, performant, and reliable mock-based tests. Guides users in choosing between strict and nice mocks and setting up expectations wisely."
---

# Best Practices for Efficient Use of Mocks

GoogleMock is a powerful tool for creating mock objects to test interactions and dependencies in C++ code. This page offers practical advice to write maintainable, performant, and reliable tests leveraging mocks effectively. It helps you choose the right mock strictness modes, set expectations thoughtfully, and avoid common pitfalls.

---

## Understanding Mock Strictness Modes

GoogleMock offers three primary modes to control how mocks handle calls with no explicit expectations: **NiceMock**, **NaggyMock**, and **StrictMock**. Knowing when and how to use each mode is crucial for writing clear tests and managing uninteresting calls.

| Mock Mode   | Behavior on Uninteresting Calls       | Use Case and Recommendation                                   |
|-------------|--------------------------------------|----------------------------------------------------------------|
| **NiceMock**  | Suppresses warnings                  | Use when you want to ignore unexpected calls, keeping test logs clean and focusing on important interactions. Ideal for large mocks with many irrelevant calls.
| **NaggyMock** | Prints warnings (default behavior)  | Good for development and debugging to detect unanticipated calls without failing tests.
| **StrictMock**| Treats uninteresting calls as errors | Use when you want to enforce *all* mock calls explicitly, catching any unexpected interactions. Useful for very precise interfaces and critical components.

Example of making a strict mock:

```cpp
using ::testing::StrictMock;
StrictMock<MockFoo> strict_foo;
EXPECT_CALL(strict_foo, DoThis());
strict_foo.DoThis();
// Fails on calls other than DoThis()
```

Similarly, to create a nice mock:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_foo;
EXPECT_CALL(nice_foo, DoThis());
nice_foo.DoThis();
// Ignores calls without expectations
```


### Tips on Choosing Mock Modes

- Prefer **NiceMock** for large, complex tests where you want to suppress noise from irrelevant calls.
- Use **StrictMock** only when you require exact verification of every call without exceptions.
- Start with **NaggyMock** during test development to discover unexpected calls.
- Avoid mixing strictness wrappers (e.g., `NiceMock<StrictMock<T>>`) as it is not supported.
- Ensure mock classes have virtual destructors for reliable behavior when using these wrappers.

---

## Writing Expectations Wisely

Expectations define how mocks should be called and what they should do. To write maintainable tests:

### 1. Use `EXPECT_CALL` Sparingly

Only specify expectations for calls whose behavior or occurrence you *really* want to verify. Overusing `EXPECT_CALL` leads to brittle tests that break on innocent refactors.

### 2. Use `ON_CALL` to Set Default Behavior

Use `ON_CALL` to define what a mock method should do when there is no specific expectation:

```cpp
ON_CALL(mock_obj, Method(_)).WillByDefault(Return(true));
```

This approach keeps tests focused on specific behaviors without enforcing call counts or argument patterns.

### 3. Consequences of Overusing `EXPECT_CALL`

- Excessive expectations slow down test runs.
- Refactorings may break many tests unnecessarily.
- Harder to isolate the real source of test failures.

### 4. Use Wildcards and Parameter Omission When Appropriate

If you only care about the method being called (not arguments), omit parameters or use the `_` wildcard matcher:

```cpp
EXPECT_CALL(mock_obj, Method).Times(2); // For methods without overloads
EXPECT_CALL(mock_obj, Method(_));       // Matches any argument
```

### 5. Keep Expectations Clear and Descriptive

- Use matchers to specify only relevant argument conditions.
- Use `.Times()` with meaningful cardinalities (`Exactly(n)`, `AtLeast(n)`, etc.).
- Use `InSequence` or `After` to express ordering when important.

---

## Managing Uninteresting Calls

Mock calls without explicit expectations are called uninteresting. By default, gMock warns about them (Naggy behavior). To manage these calls:

- Use **NiceMock** to silence uninteresting call warnings for a mock instance.
- Add a catch-all `EXPECT_CALL` with `.Times(AnyNumber())` to specify allowed but uninteresting calls.

Example:

```cpp
EXPECT_CALL(mock_obj, SomeMethod(_)).Times(AnyNumber());
EXPECT_CALL(mock_obj, SomeMethod(42)) // Specific expectation
    .WillOnce(Return(true));
```

This setup handles expected calls precisely while ignoring others without warnings.

<Tip>
Suppressing uninteresting call warnings by blindly adding expectations defeats the purpose of setting expectations and leads to fragile tests. Prefer using `NiceMock` or explicit `.Times(AnyNumber())`.
</Tip>

---

## Best Practices for Expectation Sequences & Ordering

Sometimes the order of calls matters. gMock provides tools for this:

- Use `InSequence` object to enforce a strict call order:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock_obj, FirstCall());
  EXPECT_CALL(mock_obj, SecondCall());
}
```

- Use multiple `Sequence` objects with `.InSequence(s1, s2)` for partial ordering.
- Use `.After()` clause to specify that an expectation should only occur after others.

Avoid over-constraining the order; partial ordering makes tests more resilient.

---

## Handling Mocked Methods with Complex Signatures

If your mocked methods have complicated arguments:

- Use helper matchers to focus on relevant parts of arguments.
- Consider delegating methods with long parameter lists to simpler mock methods.
- Use `With(...)` clause to apply predicates on the argument tuple as a whole.

Example with `With`:

```cpp
EXPECT_CALL(mock, Func(_, _))
    .With(Lt());  // The first argument is less than the second
```

---

## Avoiding Common Pitfalls

- **Expectations after calls**: Define `EXPECT_CALL` *before* exercising code that calls mocks.
- **Overlapping expectations**: Newer expectations override older ones; define more general expectations first.
- **Sticky expectations**: Expectations remain active after saturation unless `.RetiresOnSaturation()` is used.
- **Unhandled return types**: Provide default actions for methods returning non-default-constructible types.
- **Leak handling**: If a mock object is deliberately leaked, use `Mock::AllowLeak(&mock_obj);` to suppress leak warnings.

<Tip>
Use `Mock::VerifyAndClearExpectations(&mock_obj);` to force early verification of expectations if the mock’s lifetime is managed externally.
</Tip>

---

## Leveraging gMock Verbosity for Insights

When debugging mock call mismatches or unexpected calls, use the `--gmock_verbose=info` flag to get detailed logs, including:

- Full trace of each mock call
- Arguments and return values
- Stack traces for failures

This makes it easier to understand why a call matches or doesn't match expectations.

---

## Summary

Effective use of GoogleMock hinges on choosing the right mock strictness mode, writing clear expectations, and managing uninteresting calls wisely. Prefer **NiceMock** to reduce warning noise, and use **StrictMock** only when rigor is critical. Use `EXPECT_CALL` sparingly, reserving it for calls you want to verify precisely, and default behaviors with `ON_CALL` and catch-all expectations to improve test resilience. Ordering expectations explicitly only when necessary ensures maintainable tests.


---

## Further Reading and References

- [Mocking Reference](../reference/mocking.md) – Complete details on `EXPECT_CALL`, `ON_CALL`, cardinalities, sequences, and expectations.
- [gMock Cookbook](../gmock_cook_book.md) – Practical recipes and advanced usage scenarios.
- [gMock Behavior Modes (Nice, Naggy, Strict)](../mock_behaviors_and_strategies.md) – Detailed explanation of mock strictness.
- [Mocking for Dummies](../gmock_for_dummies.md) – Beginner-friendly introduction to mocking in GoogleMock.

---

## Quick Code Example

```cpp
#include <gmock/gmock.h>
using ::testing::NiceMock;
using ::testing::StrictMock;
using ::testing::Return;
using ::testing::_; 

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetValue(int x) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (int x), (override));
};

// Test with a NiceMock that suppresses uninteresting call warnings
TEST(NiceMockExample, Works) {
  NiceMock<MockFoo> mock_foo;
  ON_CALL(mock_foo, GetValue(_)).WillByDefault(Return(42));

  // Only expect GetValue(10) explicitly
  EXPECT_CALL(mock_foo, GetValue(10));

  EXPECT_EQ(mock_foo.GetValue(10), 42);  // Expected call

  int result = mock_foo.GetValue(99);   // Uninteresting call, no warning
  EXPECT_EQ(result, 42);
}

// Test with a StrictMock that fails on uninteresting calls
TEST(StrictMockExample, FailsOnUninterestingCall) {
  StrictMock<MockFoo> mock_foo;
  EXPECT_CALL(mock_foo, GetValue(10)).WillOnce(Return(5));

  EXPECT_EQ(mock_foo.GetValue(10), 5);  // Expected call

  // The following call has no expectation and will fail the test.
  mock_foo.GetValue(99);
}
```
