---
title: "How do I debug failing tests or flaky behavior?"
description: "Offers guidance for tracking down intermittent test failures, understanding error messages, and isolating causes (e.g., dependency issues, environment differences). Includes references to common assertion failures and debugging strategies."
---

# How Do I Debug Failing Tests or Flaky Behavior?

Understanding why tests fail intermittently or produce flaky results is crucial for maintaining a reliable testing suite. This guide empowers you to diagnose, isolate, and resolve such issues efficiently.

---

## 1. Interpreting Test Failures with Clear Diagnosis

When a test fails intermittently, it is important to understand the nature of the failure. GoogleTest and GoogleMock provide rich diagnostic output to help you pinpoint the cause.

### 1.1 Common Failure Types

- **Unexpected Mock Calls**: Indicate that a mock method was invoked in a way that does not match any `EXPECT_CALL`.
- **Unsatisfied Expectations**: Occur when expected mock calls are not made the required number of times.
- **Argument Mismatches**: Occur when a mock call’s arguments do not satisfy the specified matchers.
- **Excessive Calls**: More calls happen than expected.
- **Retired Expectations**: Calls occur on expectations that are no longer active.

GoogleMock prints detailed messages including the function signature, expected arguments, and actual arguments, along with a stack trace. This clarity helps you understand precisely what went wrong.

### 1.2 Using Verbose Mode for Deeper Insight

Enable verbose output with `--gmock_verbose=info` to print a trace of all mock function calls, the expectations they match, and stack traces. This can reveal subtle mismatches or ordering problems that cause flaky failures. For example:

```shell
$ my_test --gmock_verbose=info
```

This output shows which expectations are installed, which call matched which expectation, and what arguments were received, offering invaluable visibility.

## 2. Step-by-Step Debugging Workflow

Follow these steps systematically to debug flaky or failing tests involving mocks:

<Steps>
<Step title="Check for Setup or Environment Differences">
Tests often become flaky due to differences in environment or setup code. Verify that the environment is consistent between runs, including dependencies, configurations, and resource availability.
</Step>
<Step title="Examine Google Mock Failure Messages">
Examine the failure logs carefully. Look for messages like "Unexpected mock function call", "Actual call count doesn't match", or "Mock function called more times than expected". They pinpoint specific expectations that are violated.
</Step>
<Step title="Run with Verbose Flag">
Add `--gmock_verbose=info` to your test execution to get full call traces. Observe when and how mocks are called compared to expectations.
</Step>
<Step title="Review and Refine Expectations">
Check if your `EXPECT_CALL`s and `ON_CALL`s are set correctly before the calls occur. Make sure the matchers precisely capture the expected arguments.
</Step>
<Step title="Look for Order Dependencies and Sequences">
If your test requires calls to happen in specific orders, verify your usage of sequences with `InSequence` or `After`. Incorrect ordering often leads to flaky behavior.
</Step>
<Step title="Identify Leaked or Undestroyed Mocks">
GoogleMock detects leaked mocks that are not deleted before test completion. Such leaks skip verification and can cause false passes or intermittent failures. Make sure mock objects are properly deleted or use `Mock::AllowLeak` intentionally.
</Step>
<Step title="Use Scoped Trace to Isolate Failures">
Instrument your test code with `SCOPED_TRACE` to mark execution points. This helps localize failures to precise parts of your test or test helpers.
</Step>
<Step title="Iterate and Narrow Down the Problem">
Run your tests multiple times with `--gtest_repeat=1000` to reproduce flaky failures consistently, using `--gtest_break_on_failure` to halt on the first failure and attach a debugger.
</Step>
</Steps>

## 3. Common Pitfalls and How to Avoid Them

- **Uninitialized or Shared State**: Flaky tests often stem from tests sharing mutable state or using uninitialized objects. Use fresh fixtures and proper setup/teardown.

- **Incorrect Mock Expectations**: Overly strict or incorrect argument matchers cause unexpected call failures. Use wildcard matcher `_` or carefully crafted matchers.

- **Expectation Stickiness**: By default, expectations remain "sticky" even after saturation. Use `RetiresOnSaturation()` to retire expectations after matching to avoid conflicts.

- **Multiple Matching Expectations**: Remember that GoogleMock matches the last added matching expectation. Order your `EXPECT_CALL`s with more specific expectations last.

- **Multithreading Issues**: Tests involving threads can cause timing-dependent flaky failures. Synchronize properly and avoid setting expectations concurrently from multiple threads.

- **Forgotten Mock Destruction**: Leaking mocks cause expectations not to be verified at test end. Always ensure mocks are properly destroyed or explicitly allow leaks if intentional.

## 4. Understanding Google Mock Error Messages

Google Mock furnishes error messages that detail:

- The mock function called and its signature.
- The expected arguments versus actual arguments.
- Which expectations were tried and why they failed.
- Whether any pre-requisite expectations are unsatisfied.
- Whether expectations are retired or saturated.

Sample error snippet:

```none
Unexpected mock function call - returning default value.
    Function call: Bar2(1, 0)
          Returns: false
Google Mock tried the following 1 expectation, but it didn't match:

FILE:#: EXPECT_CALL(foo_, Bar2(0, _))...
  Expected arg #0: is equal to 0
           Actual: 1
         Expected: to be called once
           Actual: never called - unsatisfied and active
```

This message tells you the exact call that caused the failure and why it didn’t match the only expectation.

## 5. Practical Tips and Best Practices

- **Set Expectations Before Use**: Always set `EXPECT_CALL` before exercising the mock to avoid undefined behaviors.
- **Use `ON_CALL` for Default Behavior**: Use `ON_CALL` to specify default mock method behavior without enforcing call counts.
- **Control Verbosity by `--gmock_verbose`**: Use `error` for quiet runs, `warning` during normal debugging, and `info` to get detailed call traces.
- **Check for Leaked Mocks**: Use GoogleMock’s leak detection and ensure your mocks get destroyed at test completion.
- **Leverage `SCOPED_TRACE`**: Add trace context inside helper functions to enrich failure diagnostics.
- **Employ Sequences for Ordered Calls**: Use `Sequence` and `InSequence` to enforce call order when necessary.
- **Iterate with `--gtest_repeat` and `--gtest_break_on_failure`**: Run tests repeatedly and break on failure to catch flaky behavior reliably.
- **Avoid Over-Specification**: Use wildcards `_` and less strict matchers where detailed argument constraints aren’t essential.

## 6. Troubleshooting Common Scenarios

<AccordionGroup title="Common Debugging Scenarios">
<Accordion title="Mock Method Called Unexpectedly">
GoogleMock reports "Unexpected mock function call" when a call does not satisfy any existing expectation. Check argument matchers and ordering constraints. Running with `--gmock_verbose=info` helps identify which expectations were tried and why they failed.
</Accordion>
<Accordion title="Unsatisfied Expectations at Test End">
These indicate expected calls were not made. Ensure your tests actually trigger all expected calls, and that mocks are not leaked preventing verification.
</Accordion>
<Accordion title="Excessive Calls to Mocks">
Called more times than expected: Review `Times()` and `RetiresOnSaturation()` clauses. Consider relaxing constraints or using sequences if call ordering matters.
</Accordion>
<Accordion title="Flaky Tests Around Ordering Dependencies">
Ordering problems can cause intermittent failures. Explicitly encode call orders using sequences or `After()` clauses to stabilize tests.
</Accordion>
<Accordion title="Leaked Mocks Detected at Program Exit">
Mocks must be properly deleted before tests complete to perform expectation verification. If intentional leaks are necessary, use `Mock::AllowLeak(mock_object)` to suppress errors.
</Accordion>
</AccordionGroup>

## 7. Additional Debugging Techniques

- **Use Breakpoints on Failures**: Add `--gtest_break_on_failure` to halt on first failure, enabling real-time debugger inspection.

- **Add Custom Logging**: Use `RecordProperty()` to annotate test runs with extra diagnostic info.

- **Enable Stack Trace**: Customize the number of printed stack frames with `--gtest_stack_trace_depth`.

- **Verify Within Test Code**: Call `Mock::VerifyAndClearExpectations(mock_obj)` mid-test to enforce expectation checks early.

- **Control Mock Strictness**: Use `NiceMock` or `StrictMock` to adjust tolerance of uninteresting calls according to your test needs.

## 8. References & Further Reading

- [GoogleTest Assertions Reference](https://github.com/google/googletest/blob/main/docs/reference/assertions.md) — for making precise test checks
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) — detailed API and concepts for mocks
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) — practical recipes and best practices
- [Mocking Best Practices and Pitfalls](https://github.com/google/googletest/blob/main/guides/advanced-patterns/mocking-pitfalls-best-practices.md) — avoid brittle tests
- [Using Verbose Mode](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#using-verbose-mode-for-debugging) — detailed mock call tracing
- [Troubleshooting Common Setup Issues](https://github.com/google/googletest/blob/main/getting-started/first-test-run/troubleshooting-setup.md) — resolve environment-related failures

---

For more about writing robust tests and diagnosing problems, consult the [Getting Started](https://github.com/google/googletest/tree/main/getting-started) and [Core Concepts](https://github.com/google/googletest/tree/main/overview/architecture-and-concepts/core-concepts) documentation.


<Tip>
For best results with flaky tests, isolate test state, precisely set and retire expectations, and leverage `--gmock_verbose=info` to get full insight into mock behavior.
</Tip>

<Tip>
If a test’s failure only occurs sporadically, consider using `--gtest_repeat` and `--gtest_shuffle` to reproduce and analyze non-determinism.
</Tip>

<Check>
Always ensure your mock objects are destructed or explicitly marked with `Mock::AllowLeak` to avoid false negatives in expectation verification.
</Check>
