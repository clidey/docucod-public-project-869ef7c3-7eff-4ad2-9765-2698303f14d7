---
title: "How do I debug failing or flaky tests?"
description: "Gives practical debugging strategies for diagnosing test failures, unexpected behaviors, or intermittent issues. Includes tips on logging, advanced assertion usage, and leveraging testing flags."
---

# How do I debug failing or flaky tests?

GoogleTest and GoogleMock empower you to write robust C++ tests; however, encountering failing or flaky tests can still happen. This guide provides practical, actionable strategies to diagnose, debug, and resolve issues related to test failures, unexpected behaviors, or intermittent (flaky) test runs. It covers techniques including enhanced logging, advanced assertion usage, and leveraging built-in testing flags for deeper insight.

---

## Understanding Test Failures and Flakiness

- **Failing Tests** reliably produce errors when the tested code deviates from expected behavior.
- **Flaky Tests** fail intermittently, often due to nondeterministic conditions such as race conditions, resource contention, timing issues, or external environment variability.

Identifying whether a flaky test is caused by the test itself or the production code is crucial for effective debugging.

---

## Strategies for Debugging Failing or Flaky Tests

### 1. Use GoogleTest’s Verbose Flags for Diagnostic Output

Enhance your visibility into what happens during test execution by increasing verbosity:

```bash
--gmock_verbose=info
```

- This flag enables detailed tracing of mock object interactions.
- You will see which expectations are matched, which calls are unexpected or uninteresting, and the exact argument values.
- Combine it with `--gtest_stack_trace_depth=20` (or a larger number) to get comprehensive stack traces for failure points.

### 2. Examine Expectation and Call Matching Carefully

- Confirm that your `EXPECT_CALL` statements are set **before** exercising the mocks — expectations must be declared *prior* to mock method invocations.
- Check if your expectations might be **too strict** or **too loose**, causing test failures or allowing bugs to pass.
- Use `.Times()`, `.InSequence()`, and `.After()` judiciously to precisely order and count calls.

### 3. Review Warnings About Uninteresting Calls

GoogleMock emits warnings like:

```
GMOCK WARNING: Uninteresting mock function call - returning default value.
```

- These warnings indicate mocks are called without expectations set.
- Use `::testing::NiceMock` to suppress such warnings for mocks where calls are allowed but not verified.
- If you want to ensure calls are not made unexpectedly, use `StrictMock` instead.

### 4. Isolate Test Flakiness

- Run tests multiple times with:

```bash
--gtest_repeat=N
```

to reproduce flakiness.

- Use `--gtest_shuffle` to randomize test execution order and identify dependencies between tests.

### 5. Add Detailed Logging in Tests

- Incorporate logging inside the test or the production code to capture state and variable values.
- Use GoogleTest’s assertion helpers like `EXPECT_THAT` with expressive matchers to pinpoint why arguments or results don’t match expectations.

Example:

```cpp
EXPECT_THAT(actual_value, ::testing::Eq(expected_value));
EXPECT_THAT(container, ::testing::ElementsAre(1, 2, 3));
```

- Provide custom failure messages to clarify intent.

### 6. Use `Mock::VerifyAndClearExpectations` for Intermediate Verification

- If your mocks have complex lifecycles, manually verify expectations at critical checkpoints:

```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(&mock_object));
```

- This helps identify which phase fails before object destruction.

### 7. Employ `RetiresOnSaturation()` for Sequential Actions

- If you expect a mock method to be called multiple times with different behaviors consecutively, mark expectations as non-sticky to avoid premature failures.

```cpp
EXPECT_CALL(mock, Foo())
    .WillOnce(Return(1))
    .RetiresOnSaturation();
EXPECT_CALL(mock, Foo())
    .WillOnce(Return(2))
    .RetiresOnSaturation();
```

### 8. Handle Asynchronous or Multi-threaded Tests with Care

- Confirm that your test code synchronizes mock expectations and mock method calls correctly.
- Avoid setting expectations while other threads invoke mocks.
- Use conditions or notifications to sequence multi-threaded calls deterministically.

### 9. Use `ON_CALL` and Default Actions Appropriately

- For methods where you do not care whether they are called, set default actions using `ON_CALL` instead of `EXPECT_CALL`.
- This reduces noise from uninteresting call warnings.

### 10. Check for Correct Mock Ownership and Lifetime

- Make sure mocks with automatic verification are destroyed properly.
- If mocks are allocated on the heap and passed to production code, verify they are cleaned up, or force verification manually.

### 11. Debugging Using Emacs or IDE Integration

- When running tests in IDEs or Emacs with GoogleTest integration, leverage jumping to source on failure by clicking the file and line in error messages.

---

## Practical Example: Diagnosing a Flaky Mock Call

```cpp
TEST(PainterTest, DrawCircleCallsPenDown) {
  NiceMock<MockTurtle> turtle;  // Avoid spam warnings about uninteresting calls

  EXPECT_CALL(turtle, PenDown())
      .Times(AtLeast(1));

  Painter painter(&turtle);

  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

If this test fails intermittently:

- Run with `--gmock_verbose=info` to see if `PenDown()` is called but with unexpected arguments.
- Confirm `EXPECT_CALL` is set *before* `DrawCircle` is invoked.
- Ensure no concurrency issues affect `PenDown()` calls.

---

## Troubleshooting Summary

| Symptom                              | Recommended Debugging Step                          |
|------------------------------------|---------------------------------------------------|
| Unexpected mock function call       | Check if the arguments mismatch, use verbose flag to trace call matches.
| Uninteresting call warnings          | Consider if calls should be `ON_CALL` defaults or suppress with `NiceMock`.
| Tests fail due to too strict `EXPECT_CALL` | Relax matchers or cardinalities (`Times()`, `AnyNumber()`).
| Flaky test (intermittent failures) | Shuffle and repeat tests; add logging and synchronize threads.
| Default actions missing for mock   | Use `ON_CALL` to specify `WillByDefault()`, or set `DefaultValue<T>`.
| Memory leaks or missing verification  | Use `Mock::VerifyAndClearExpectations()` or ensure mock destruction.

---

## Additional Tips

- Avoid overly rigid expectations; test the contract, not implementation details.
- Use partial ordering (`InSequence`, `After`) for tests sensitive to order.
- Investigate if failures relate to environment dependencies (file access, network).
- Regularly run `--gtest_shuffle` to detect inter-test dependencies.

---

## Related Documentation

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html): Learn basic mock usage and understanding expectations.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Advanced recipes including debugging and custom matchers/actions.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html): Detailed API and macros for mock configuration.
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html): Guidance on using matchers to specify expected arguments.
- [Running Tests and Interpreting Results](../guides/getting-started/running-tests-and-interpreting-results.md): How to run and understand test outputs.

---

For complex failures, start with raising verbosity, inspect call traces, align your expectations carefully, and isolate flakiness through repetition and shuffling to identify the root causes efficiently.