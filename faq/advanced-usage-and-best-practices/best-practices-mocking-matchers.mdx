---
title: "What are best practices for using mocking and matchers?"
description: "Recommendations for designing maintainable and clear mocks, using matchers effectively, and leveraging advanced GoogleMock features for robust test behavior and verification."
---

# Best Practices for Using Mocking and Matchers

Effective use of mocking and matchers in GoogleMock unlocks powerful, reliable, and maintainable tests. This guide focuses specifically on practical recommendations for designing maintainable mocks, selecting and applying matchers appropriately, and leveraging advanced features of GoogleMock to write clear and robust tests that accurately verify interactions between components.

---

## 1. Design Mocks for Maintainability and Clarity

### Define Clear and Purposeful Interfaces

- Always mock interfaces or abstract base classes with well-defined contracts.
- Avoid mocking concrete classes unless necessary, as it creates tight coupling to implementation details.
- Favor coding to interfaces to simplify test double creation and maintenance.

### Keep Mock Classes Focused

- Define mocks with only methods relevant for testing.
- Avoid overloading mocks with unused or irrelevant methods to reduce noise.

### Put Mock Definitions Close to Owners When Possible

- If you own the interface, place mocks near interface definitions for easier updates.
- Don't scatter copies of mocks across test codebases to prevent duplication and version drift.
- If mocking external interfaces, place mocks in a common testing package shared by all users.

### Use Consistent Naming Conventions

- For mock classes, use the `Mock` prefix or suffix consistently, e.g., `MockFoo`.
- For mock methods, use the method names exactly as in the interface declaration.

### Use `MOCK_METHOD` Macros Correctly

- Always place `MOCK_METHOD` macros in the `public:` section, regardless of the base method access specifier.
- Include qualifiers (e.g. `(const, override)`) to mirror original method qualifiers for correctness.
- Protect argument lists containing commas by surrounding with parentheses or use typedef aliases.

---

## 2. Use Matchers Effectively: Express Intent, Avoid Fragile Tests

### Specify Only What Matters

- Avoid over-specification of argument matching to reduce brittleness.
- Use the wildcard matcher `_` for arguments whose values are irrelevant to the test.
- For arguments where you care, choose expressive matchers like `Eq()`, `Ge()`, `HasSubstr()`, etc.

### Combine Matchers for Complex Validation

- Use logical combinators like `AllOf()`, `AnyOf()`, `Not()` to create nuanced matcher expressions.
- Use `Field()` and `Property()` to validate specific members or method results of argument objects instead of full object equality.

### Match Containers Intelligently

- Use `ElementsAre()`, `UnorderedElementsAre()`, and their array forms to validate container contents in detail.
- For associative containers, validate using `Pair()` matchers.

### Use `With()` Clause for Multi-Argument Coordination

- To express constraints involving relationships among multiple arguments, use `.With()` and tuple matchers.

### Avoid Matchers with Side Effects

- Matchers must be purely functional and cannot invoke mock methods or have stateful side effects.

### Use `SafeMatcherCast<T>()` to Resolve Type Mismatches

- When needed, use `SafeMatcherCast` to safely cast matchers to compatible types, for example when matching integer promotion/conversions.

---

## 3. Set Expectations Wisely

### Use `EXPECT_CALL` Only When You Intend to Verify a Call

- Use `ON_CALL` to set default behavior without imposing call expectations.
- Avoid gratuitous `EXPECT_CALL`s as they add unnecessary constraints making tests brittle.
- Write minimal expectations targeting specific behaviors you want to assert.

### Cardinality Matters

- Specify `.Times(...)` to control expected call counts, or rely on defaults:
  - No `.Times()` + no `.WillOnce()` / `.WillRepeatedly()` means `.Times(1)`.
  - `.WillOnce()` sets cardinality equal to number of `WillOnce` clauses.
  - `.WillRepeatedly()` combined with `WillOnce()` infers `AtLeast(n)`.
- Use fuzzy cardinalities like `AtLeast()`, `AtMost()`, `AnyNumber()` to increase flexibility.

### Test Partial and Total Order of Calls

- Use `InSequence` or `.InSequence(...)` clauses to enforce strict order or partial orders using sequences.
- Use `.After()` clause to express complex ordering dependencies.

### Handle Multiple Expectations Carefully

- Order expectations from most general to most specific so that later expectations override earlier ones.
- Sticky expectations remain active even after saturation unless `.RetiresOnSaturation()` is specified.

### Use `.RetiresOnSaturation()` to Avoid Some Common Pitfalls

- This ensures expectations stop matching after reaching their call limit, enabling proper fallback to more general expectations.

---

## 4. Manage Mock Object Behavior and Verbosity

### Choose Right Kind of Mock (Nice, Naggy, Strict)

- Use `NiceMock` to suppress warnings on uninteresting calls.
- Use `NaggyMock` (default) for warnings about uninteresting calls.
- Use `StrictMock` to treat uninteresting calls as test failures.

### Set Default Actions Using `ON_CALL`

- Use `ON_CALL` to define default behaviors without imposing call expectations.
- Pair `ON_CALL` with `EXPECT_CALL` strategically to create robust and expressive tests.

### Controlling Output Verbosity

- Use `--gmock_verbose=info|warning|error` to tune message verbosity:
  - `info`: verbose logging, including stack traces and all calls
  - `warning`: warnings and errors only (default)
  - `error`: errors only

---

## 5. Advanced Techniques

### Delegate to a Fake or Real Object

- You can delegate default actions to an existing fake or real implementation using lambdas in `ON_CALL`.
- This facilitates partial mocking and behavior sharing.

### Mock Non-Virtual Methods Using Hi-Perf Dependency Injection

- Define unrelated mock classes that share the same method signatures as the concrete classes.
- Use templates to select the implementation at compile time.

### Mock Move-Only Types

- Directly mock methods taking or returning move-only types like `unique_ptr` with `MOCK_METHOD`.
- Return move-only types from actions using lambdas rather than `Return()` when multiple calls are expected.

### Control Complex Argument Matching and Responses

- Use `SaveArg`, `SetArgPointee`, `Invoke`, `WithArgs` to extract, manipulate, or forward specific arguments.

### Testing Asynchronous Behavior

- Use actions combined with synchronization primitives (like `absl::Notification`) to coordinate and verify calls across threads.

### Match Callbacks and Function Pointer Arguments

- Invoke callback arguments in actions using `InvokeArgument<N>(...)` for thorough interaction testing.

---

## 6. Common Pitfalls & Troubleshooting

### Failing to Mock Virtual Methods

- Ensure that mocked methods are virtual.
- Non-virtual methods cannot be mocked unless using hi-perf dependency injection.

### Over-Specified Expectations

- Avoid specifying too many details (argument values, call counts, order) causing fragile tests.
- Aim for “just right” expectations balancing verification and resilience.

### Default Actions and Unexpected Calls

- If a mock method is called unexpectedly, ensure you have set a default action via `ON_CALL` or an explicit expectation.
- Uninteresting calls with no expectations cause warnings (or failures with StrictMock).

### Using `.WillOnce(Return(object))` Incorrectly

- For move-only return types, return values must be recreated on each call (lambdas preferred).

### Using `.With()` Multiple Times

- Only one `.With()` clause can be used per expectation or `ON_CALL`.

### Forgetting to Set Expectations Before Using Mocks

- Call `EXPECT_CALL` or `ON_CALL` before exercising code that calls mocks to ensure defined behavior.

### Diagnosing Unexpected Behavior

- Run tests with `--gmock_verbose=info` to see detailed mock call and expectation matching logs.

---

## References and Further Reading

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Basic concepts and workflows.
- [Mocking Reference](reference/mocking.md) — Detailed macro and API usages.
- [gMock Cookbook](docs/gmock_cook_book.md) — Recipes and advanced usage patterns.
- [Matchers Reference](reference/matchers.md) — Built-in and custom matcher building.
- [Actions Reference](api-reference/mocking-apis/actions.md) — Complete action guides.
- [Mock Object Behaviors: Nice, Naggy, Strict](api-reference/mocking-apis/mock-behaviors.md) — Behavior modifiers for mocks.

---

## Practical Tips Summary

- Design your mocks thoughtfully, mocking only what you own or control.
- Specify expectations only to the level you need — be as flexible as possible.
- Use matchers to clearly express argument constraints and simplify tests.
- Control call order only when necessary.
- Use `ON_CALL` to set default mock behavior and `EXPECT_CALL` selectively.
- Prefer `NiceMock` in most tests to reduce noise; use strictness with care.
- Leverage advanced actions, delegations, and synchronization for complex needs.
- Run tests with verbose logging when diagnosing hard-to-find mismatches.

---

This concludes the best practices guide for mocking and matchers in GoogleMock, helping you write expressive, maintainable, and robust tests.
