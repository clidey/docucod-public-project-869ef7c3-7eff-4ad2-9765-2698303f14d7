---
title: "What are best practices for using mocks?"
description: "Strategies for writing clear, robust, and maintainable mock-based tests. Explores correct use of NiceMock/StrictMock, setting expectations, and dealing with legacy code. Empowers users to leverage mocking without introducing brittle tests."
---

# Best Practices for Using Mocks

This guide empowers you to leverage GoogleMock effectively, writing clear, robust, and maintainable mock-based tests. Mocking is a powerful technique to isolate dependencies, validate interactions, and control the behavior of components under test, but improper usage can lead to brittle or over-specified tests. The practices here ensure mocks add value to your testing without becoming a maintenance burden.

---

## 1. Understand When to Use Mocks

- **Unit Isolation:** Use mocks to isolate the code under test from external dependencies that are slow, unavailable, non-deterministic, or hard to set up.
- **Interaction Verification:** Use mocks when you need to verify *how* a code interacts with collaborators, not just the end state.
- **Avoid Overuse:** Mocks are not a remedy for all testing needs. Avoid mocking when state-based verification with real or fake objects suffices.

<Tip>
Not all dependencies need to be mocked. Distinguish between *fakes* (simplified implementations) and *mocks* (which verify calls). Prefer fakes when you only need to simulate behavior without verifying interactions.
</Tip>

## 2. Design Your Mock Classes Thoughtfully

- Mock interfaces you own or control; avoid mocking classes from third-party libraries or modules you don’t own.
- For external dependencies, consider writing adaptor interfaces you own, and mock the adaptor rather than the original class.
- When mocking, derive your mock class from the interface or base class to ensure substitution viability.
- **Define all relevant virtual methods** in mocks using `MOCK_METHOD`, including those that are protected or private in the base class, making them public in the mock.

```cpp
class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetValue() const = 0;
  virtual void Update(int x) = 0;
  
 protected:
  virtual void Reset();

 private:
  virtual void InternalHelper();
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, Update, (int x), (override));
  MOCK_METHOD(void, Reset, (), (override));  // moved from protected
  MOCK_METHOD(void, InternalHelper, (), (override));  // moved from private
};
```

## 3. Set Appropriate Expectations

### Use `ON_CALL` for Default Behavior

- `ON_CALL` specifies the default behavior but **does not set an expectation**.
- Use `ON_CALL` liberally in test fixtures to establish a baseline mock behavior.

### Use `EXPECT_CALL` to Specify What You Really Want to Verify

- Express precise expectations only when you want to verify the call occurs.
- Avoid over-specification; do not expect every single call unless necessary.
- Chain calls like `Times()`, `WillOnce()`, `WillRepeatedly()`, `InSequence()`, and `After()` properly.

### Use Matchers Judiciously

- Use specific matchers only as much as needed. Default to wildcard (`_`) when argument values are unimportant.
- Prefer matchers over hard-coded values only if the argument should match a property rather than equality.

```cpp
using ::testing::_;
using ::testing::Gt;

EXPECT_CALL(mock, Foo(_))          // Accept any argument
    .WillOnce(Return(true));
EXPECT_CALL(mock, Foo(Gt(5)))      // Only arguments greater than 5
    .WillOnce(Return(false));
```

<Tip>
Over-specifying argument matchers can break tests unnecessarily when implementation details change. Aim to express intent, not implementation.
</Tip>

## 4. Manage Call Cardinalities Thoughtfully

- Choose appropriate cardinality with `.Times()`:
  - `Exactly(n)` or `n` to specify exact number of calls.
  - `AtLeast(n)` or `AnyNumber()` to allow flexibility.
  - Use `.Times(0)` to assert the method should never be called.

- Avoid `.Times()` clauses that are too restrictive or too lenient:
  - Too restrictive can cause test failures on harmless internal changes.
  - Too lenient can let bugs slip through.

- Remember that `WillOnce()` clauses imply cardinality unless overridden by `.Times()`.

## 5. Use Sequences and Ordering Only When Needed

- Use `InSequence` or `.InSequence()` on expectations to enforce call order when order *matters*.
- For partial order dependencies, use `.After()` with individual expectations or expectation sets.
- Avoid ordering all calls unless your test logic demands it.

```cpp
using ::testing::InSequence;

{
  InSequence s;
  EXPECT_CALL(mock, Open());
  EXPECT_CALL(mock, Write(_));
  EXPECT_CALL(mock, Close());
}
```

## 6. Specify Return Values and Behaviors Clearly

- Specify return values using `WillOnce(Return(...))` or `WillRepeatedly(Return(...))`.
- For complex behaviors, use lambda or functor actions with `Invoke()`.
- When mocking functions returning references, use `ReturnRef()`.
- To return values that may change over time, use `ReturnPointee()` to refer to an external value.

```cpp
EXPECT_CALL(mock, GetCount())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));

int value = 10;
EXPECT_CALL(mock, GetValue())
    .WillRepeatedly(ReturnPointee(&value));

value = 20;  // Subsequent calls return 20
```

## 7. Handle Side Effects in Mocks Appropriately

- Use `SetArgPointee<N>(value)` or `SetArrayArgument<N>(first, last)` to set output arguments.
- Combine multiple actions with `DoAll()` when setting output arguments and returning values.

```cpp
EXPECT_CALL(mock, GetData(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

## 8. Use Strictness Levels Wisely

- By default, mocks are *naggy*: warnings for uninteresting calls but tests do not fail.
- Use `NiceMock` to suppress warnings on uninteresting calls.
- Use `StrictMock` to cause tests to fail on uninteresting calls.
- Prefer `NiceMock` in most cases for cleaner test output and lower maintenance.

```cpp
using ::testing::NiceMock;

NiceMock<MockFoo> nice_mock;
EXPECT_CALL(nice_mock, Method()).Times(1);
...
```

## 9. Avoid Common Pitfalls

- **Do not set expectations after passing mock to the code under test or after the mock is used.**
- **Ensure virtual destructors** for classes you mock to avoid undefined behaviors.
- Avoid mocking non-virtual methods unless using the advanced techniques gMock supports.
- Understand the difference between uninteresting calls (no expectations) and unexpected calls (arguments or order didn't match).
- Beware that `EXPECT_CALL` searches expectations in reverse order; define default expectations first, then more specific ones.

## 10. Verify Mocks Explicitly When Needed

- Mocks automatically verify expectations on destruction.
- In some cases, explicitly call `Mock::VerifyAndClearExpectations(&mock)` to force verification early (useful when mocks are heap allocated and their lifetime is managed by test targets).

```cpp
using ::testing::Mock;
...
Mock::VerifyAndClearExpectations(&mock_obj);
```

## 11. Design for Maintainability and Clarity

- Name mocks, expectations, and sequences for clarity.
- Group common expectations and default behaviors in test fixtures.
- Use the minimum necessary granularity in expectations to avoid brittle tests.
- Provide comments explaining the purpose and intent of expectations.

## 12. Utilize Delegation Patterns When Useful

- Delegate mock default behavior to a fake or real object using `ON_CALL` with a lambda or functor.
- This helps combine thorough interaction verification with reliable default behaviors.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, DoThis, (int n), (override));

  void DelegateToReal() {
    ON_CALL(*this, DoThis).WillByDefault([this](int n) {
      return real_.DoThis(n);
    });
  }

 private:
  Foo real_;
};
```

---

## Troubleshooting Common Mock Issues

### Expectations Not Met
- Run tests with `--gmock_verbose=info` to trace mock calls.
- Check that all `EXPECT_CALL` statements appear before the code exercising mocks.
- Confirm argument matchers fit actual call arguments.

### Unexpected Calls
- An unexpected call means some `EXPECT_CALL` was set, but arguments/order do not match.
- Add catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` if other calls are allowed.

### Uninteresting Call Warnings
- Use `NiceMock` to suppress warnings.
- Or add explicit `EXPECT_CALL` for those methods if calls are expected.

### Sticky Expectations Leading to Upper Bound Violations
- Use `.RetiresOnSaturation()` to disable stickiness and make expectation retire when saturated.
- Use sequences when call order matters.

### Mock Class and Method Definition Errors
- Ensure mock methods use `MOCK_METHOD` in public section.
- Use proper qualifiers (`const`, `override`, etc.) matching the base class.
- Use alias or parentheses when method arguments or return types contain commas.

---

## Additional Resources

- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — foundational understanding
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — detailed API explanation
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — practical recipes
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) — quick reference

---

This best practices guide fits within the broader GoogleMock documentation ecosystem, complementing core mocking APIs, tutorial content, and troubleshooting FAQs to provide you with a complete journey from novice understanding to expert mock usage.

---

## Quick Start Example

```cpp
#include <gmock/gmock.h>
using ::testing::AtLeast;
using ::testing::_;

// Interface we'll mock
class Turtle {
public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
};

// Mock class
class MockTurtle : public Turtle {
public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
};

// Test example
TEST(PainterTest, DrawsLine) {
  MockTurtle turtle;

  // Expect pen down at least once
  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));

  // Default allow forward with any distance
  ON_CALL(turtle, Forward(_));

  // Exercise code that uses turtle mock
  // ...
}
```

<Tip>
Remember to set expectations before running code that calls the mock methods!
</Tip>