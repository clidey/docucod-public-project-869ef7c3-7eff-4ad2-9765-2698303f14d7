---
title: "Mocking, Actions, and Expectations"
description: "Solutions for frequent issues when using mocks: incorrect expectation setup, unexpected calls, or action assignment errors. This page clarifies common pitfalls with GoogleMock macros, mocking behaviors, and tips for debugging mocking-related test failures."
---

# Mocking, Actions, and Expectations FAQ

This page addresses frequent issues and misunderstandings users encounter when working with mocks in GoogleMock, especially related to expectation setup, unexpected or uninteresting calls, and action assignment errors. It clarifies the correct usage of GoogleMock macros, mocking behaviors, and offers troubleshooting guidance to debug mocking-related test failures effectively.

---

## 1. Understanding Expectation Setup

### Why does my mock sometimes produce a warning about "Uninteresting mock function call"?

This warning happens when a mock method is called without an `EXPECT_CALL` specifying an expectation for that method. Such calls are called **uninteresting calls** because the test has not expressed any interest in those calls.

- By default, GoogleMock prints a warning for uninteresting calls to alert you that a method was called without explicit expectation.
- You can suppress this warning by either:
  - Using `NiceMock<T>` for your mock object, which silences uninteresting call warnings globally on that mock.
  - Adding an `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` for methods you want to allow freely.

**Tip:** Avoid suppressing warnings by adding empty `EXPECT_CALL`s unless you really intend to verify the call. Overusing expectations can make tests brittle and hard to maintain.

### What is the difference between `EXPECT_CALL` and `ON_CALL`?

- `EXPECT_CALL(mock, Method(args))` sets an *expectation* that the method **will be called** during the test, possibly multiple times, using argument matchers to specify allowed calls.
- `ON_CALL(mock, Method(args))` sets a *default behavior* for the method when it is called, but does **not** set an expectation that it will be called.

Use `ON_CALL` to specify stub behavior for methods your test doesn’t need to verify, and use `EXPECT_CALL` when you want to actually verify calls happen as expected.

### Why do I get failures about unexpected calls even though I set `ON_CALL` default behaviors?

`ON_CALL` only sets the behavior when the method is called; it does not prevent failure if calls happen outside expectations. If you have some expectations (`EXPECT_CALL`s) for the method, calls matching no expectation are **unexpected calls** and cause failures.

To allow calls other than those explicitly expected, add a "catch-all" expectation:

```cpp
EXPECT_CALL(mock, Method(_)).Times(AnyNumber());
```

Placed before or after specific expectations (newest expectations take precedence).

### How do I specify how many times a mock method should be called?

Use the `.Times()` modifier on `EXPECT_CALL` to specify call cardinality. For example:

- `.Times(1)` – method must be called exactly once.
- `.Times(AtLeast(n))` – called at least n times.
- `.Times(AnyNumber())` – can be called any number of times including zero.

If omitted, GoogleMock infers cardinality from the number of `WillOnce()` and `WillRepeatedly()` clauses:

- No actions => `.Times(1)`
- n `WillOnce()` clauses only => `.Times(n)`
- n `WillOnce()` clauses and one `WillRepeatedly()` => `.Times(AtLeast(n))`

### What is `.RetiresOnSaturation()` and when should I use it?

By default, expectations remain **sticky**: even after their call count is saturated, they're still active and can cause over-invocation errors if calls continue.

Adding `.RetiresOnSaturation()` makes the expectation "retire" (become inactive) immediately after the expected number of calls is reached, allowing other expectations to match subsequent calls without error.

Use this when you want to specify a series of ordered calls with different behaviors.

### How can I control the order of expected calls?

GoogleMock offers two main ways:

- **`InSequence` block:** puts all expectations declared within the block into a sequence that must happen in order.

```cpp
{ InSequence seq; EXPECT_CALL(mock, Foo(1)); EXPECT_CALL(mock, Foo(2)); }
```

- **`InSequence(s1, s2)` and `.After()` clauses:** allows specifying partial orders and complex DAGs of call ordering across one or more sequences.

Use these tools when call order matters to your test.

---

## 2. Handling Unexpected and Excessive Calls

### What happens if I call a mock method more times than expected?

GoogleMock treats that as an **excessive call** and will:

- Report a test failure immediately when the call occurs.
- Perform the method’s default action or the `.WillByDefault` default behavior.

### Why do I see differing behavior with `NiceMock`, `NaggyMock`, and `StrictMock`?

These wrappers control how uninteresting calls (those to methods without any `EXPECT_CALL`) are treated:

- **`NaggyMock` (default):** warns on uninteresting calls.
- **`NiceMock`:** suppresses uninteresting call warnings (quiet).
- **`StrictMock`:** treats uninteresting calls as failures.

Use `NiceMock` when you want your tests less noisy and not overly strict.
Use `StrictMock` for strict verification but be prepared to maintain exact mocks.

### If I want to verify no unexpected call happens, how?

Specify expectations on allowed calls carefully, and/or add a default expectation with `.Times(0)` to explicitly disallow certain calls:

```cpp
EXPECT_CALL(mock, Method(_)).Times(0);
```

This will cause a failure immediately if the method is called at all.

### How can I verify my mock's expectations early?

Call `::testing::Mock::VerifyAndClearExpectations(&mock_object);` in your test to verify all the expectations on your mock. It returns a bool indicating if verification succeeded.

Use this if your mock may outlive the test scope or if you need to verify partway through a test.

---

## 3. Setting Default and Custom Actions

### When does the default action get used?

- When no action is specified on the expectation or default behavior, GoogleMock returns:
  - `void` methods return immediately
  - numeric types return zero
  - pointers return `nullptr`
  - default-constructible types return a default-constructed object
- You can override default actions globally using `::testing::DefaultValue<T>::Set()` or locally on a mock object method using `ON_CALL(mock, Method(args)).WillByDefault(action);`

### What’s the difference between `WillOnce()` and `WillRepeatedly()`?

- `WillOnce(action)` specifies the action for one matching call.
- Multiple `WillOnce()` clauses can chain to specify different actions for calls in sequence.
- `WillRepeatedly(action)` specifies the action for all subsequent calls after all `WillOnce()` actions have been used up.

If you use `WillRepeatedly()`, cardinality is inferred as `.Times(AtLeast(n))` where *n* is the number of `WillOnce()` clauses.

### How to specify a sequence of return values for multiple calls?

Use multiple `WillOnce()` clauses chained, for example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

This returns 10 on first call, 20 on second call, and 30 for the rest.

### Can I specify actions as lambdas or other callables?

Yes. GoogleMock accepts lambdas, function pointers, or functors for `WillOnce()` and `WillRepeatedly()` as long as their signature matches or is compatible with the mock method's.

### How do I mock side effects like output arguments?

Use built-in actions like `SetArgPointee<N>(value)` to set output argument at position N, possibly combined with `DoAll()` to sequence multiple actions:

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

### What if I want to delegate calls to an existing fake or real object?

Use `ON_CALL(mock, Method(args)).WillByDefault([&real](args...) { return real.Method(args...); });` to forward calls to the real object inside your mock.

---

## 4. Common Pitfalls and Best Practices

### Mock methods with commas in types fail to compile. What should I do?

Wrap complex return or argument types in an extra pair of parentheses `(` and `)`, or define a type alias to avoid commas in macro arguments. Example:

```cpp
MOCK_METHOD((std::pair<int, int>), GetPair, ());
using PairType = std::pair<int, int>;
MOCK_METHOD(PairType, GetPair, ());
```

### Why don't `NiceMock` and `StrictMock` affect inherited mock methods?

They only affect mock methods defined directly in the mock class (`MOCK_METHOD` macro). Inherited mock methods in base classes may not have their strictness modified, based on compiler behavior.

### Why is it important to have a virtual destructor in a mock or interface?

Without a virtual destructor, deleting through the base pointer can cause undefined behavior or leaks. Always define virtual destructors in interfaces to be mocked.

### Why would a test report leaked mock objects?

It means some mocks were not deleted, often indicating a test bug. Use `Mock::AllowLeak(mock_object)` to suppress this if intentional.

### My mock fails verification unexpectedly. How to debug?

Run your tests with `--gmock_verbose=info` flag to see detailed traces of all calls and expectations, including their argument matching and actions.

### How to test calls involving move-only types (e.g., `std::unique_ptr`)?

Mocking methods with move-only parameters or return types works naturally with `MOCK_METHOD`. For actions, use lambdas or callables that create/move new unique pointers each call (do not use `Return(std::move(...))` repeatedly as this fails after the first call).

---

## 5. Troubleshooting Common Mocking Issues

<AccordionGroup title="Common Mocking Issues and Their Solutions">
<Accordion title="Uninteresting Call Warning Keeps Appearing">
When you see "Uninteresting mock function call" warnings:
- Use `NiceMock` to quiet all uninteresting calls on the mock object.
- Or, add explicit expectations with `.Times(AnyNumber())` to signal you allow calls like that.
- Avoid adding bare `EXPECT_CALL`s without intended verification to suppress warnings.
</Accordion>
<Accordion title="Unexpected Call Failures">
Unexpected calls occur when a method is called but no matching `EXPECT_CALL` exists:
- Verify that all expected calls are set before code exercises mocks.
- Add catch-all expectation like `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());` if some arguments should be allowed without failing.
- Use `--gmock_verbose=info` to see why your call does not match any expectation.
</Accordion>
<Accordion title="Failing When Call Count Does Not Match EXPECT_CALL">
- Check if `.Times()` is set correctly.
- Remember that chaining multiple `.WillOnce()` without `.RetiresOnSaturation()` by default keeps all expectations "sticky," leading to early failure on repeated calls.
- Use `.RetiresOnSaturation()` or put expectations inside an `InSequence` block to avoid sticky expectations causing failures.
</Accordion>
<Accordion title="Mock Methods Not Called as Expected">
- Ensure the argument matchers in `EXPECT_CALL` match the actual call arguments.
- Confirm overload resolution is correct using `Const()` wrapper or explicit casting when mocking overloaded methods.
- Use matchers like `_` for arguments where you do not care about exact value.
</Accordion>
<Accordion title="Mock Class Constructor Issues with NiceMock/StrictMock">
- `NiceMock` and `StrictMock` inherit constructors from the mock class, allowing forwarding constructor parameters.
- They only work on mock methods defined directly via `MOCK_METHOD` in the mock class, not inherited.
- Virtual destructor is recommended to ensure correct destruction behavior.
</Accordion>
</AccordionGroup>

---

## 6. Further Tips and Best Practices

- **Use `ON_CALL` for default behavior** to avoid overspecifying tests.
- **Set expectations (`EXPECT_CALL`) only when you truly verify calls.**
- Use `NiceMock` for less noisy tests; reserve `StrictMock` for highly strict verification.
- Organize expectations with sequences (`InSequence`, `After`) to manage call orders.
- Use `Times()` carefully and prefer `.RetiresOnSaturation()` in chains of expectations.
- Debug using `--gmock_verbose=info` to understand expectation matching and call dispatch.
- Leverage actions (`WillOnce`, `WillRepeatedly`) effectively, including lambdas for dynamic behaviors.

---

For more comprehensive guidance, see:
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html#expect-call)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [GoogleMock Strictness Controls](https://google.github.io/googletest/reference/mocking.html#NiceStrictNaggy)

---

<Check>
Always set your expectations *before* invoking the code under test to avoid undefined behavior.
</Check>

<Warning>
Avoid overusing expectations on methods unless you plan to verify their calls. Excessive expectations harm test maintainability.
</Warning>

<Tip>
When your test requires partial ordering of calls, use `InSequence` or `.After()` clauses instead of relying on expectation order alone.
</Tip>

---

## Code Example: Proper Use of `EXPECT_CALL` and `ON_CALL`

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::NiceMock;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), ());
  MOCK_METHOD(void, DoSomething, (int), ());
};

TEST(FooTest, BehaviorExample) {
  NiceMock<MockFoo> mock;  // Suppresses uninteresting call warnings

  // Default behavior: GetValue returns 5
  ON_CALL(mock, GetValue()).WillByDefault(Return(5));

  // Expect DoSomething(42) to be called exactly once
  EXPECT_CALL(mock, DoSomething(42)).Times(1);

  // Can optionally add a catch-all expectation to allow other calls
  EXPECT_CALL(mock, DoSomething(_)).Times(AnyNumber());

  // Exercise code which calls mock methods
  int val = mock.GetValue();  // returns 5
  mock.DoSomething(42);       // satisfies expectation
  mock.DoSomething(7);        // allowed by catch-all

  EXPECT_EQ(val, 5);
}
```

---

## Troubleshooting

- **Check mismatch messages:** GoogleMock error messages include detailed info of expected vs actual calls.
- **Verbose flag:** Run tests with `--gmock_verbose=info` to see calls, matched expectations, and stack traces.
- **Stack traces:** Examine stack traces in warnings for unexpected or uninteresting calls to detect code path causing the call.
- **Leaks:** If leaks reported, verify mock destruction is happening or use `Mock::AllowLeak()` for intentional leaks.

---

## Summary

Understanding the interplay between mocking macros, expectations, actions, and mock strictness types is crucial for writing stable, clear, and maintainable tests with GoogleMock. This page guides you through correcting typical mistakes in expectation setup, handling unexpected calls, managing default and custom behaviors, and debugging issues effectively.

---

**End of Mocking, Actions, and Expectations FAQ**
