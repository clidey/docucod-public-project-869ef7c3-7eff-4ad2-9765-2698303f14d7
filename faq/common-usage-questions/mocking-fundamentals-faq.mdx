---
title: "Mocking Fundamentals & Usage"
description: "Answers common questions about mocking C++ functions, using the core mock macros, and setting expectations with GoogleMock. Covers the essentials of ON_CALL, EXPECT_CALL, and how to define and use mock classes."
---

# Mocking Fundamentals & Usage

This page addresses common questions about mocking C++ functions using GoogleMock, focusing on the core mock macros, defining mock classes, and setting expectations. It explains how to use `MOCK_METHOD`, `EXPECT_CALL`, and `ON_CALL` to create flexible, powerful mocks, covering essential usage patterns, best practices, and troubleshooting.

---

## 1. Defining Mock Classes with MOCK_METHOD

To create a mock for an interface, derive a mock class from the original and declare mock methods using the `MOCK_METHOD` macro. This macro generates all the boilerplate needed for mocking.

### Syntax:
```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- **ReturnType**: The return type of the mocked method.
- **MethodName**: The name of the method to mock.
- **Args...**: The argument types and names in parentheses.
- **Qualifiers**: Optional method qualifiers like `const`, `override`, `noexcept`, or calling convention `Calltype(...)`.

### Key points:
- Place `MOCK_METHOD` declarations in the `public:` section of the mock class regardless of base method access.
- For methods with commas in return or argument types, wrap the problematic type in parentheses or use a type alias to avoid macro parsing errors.
- Add relevant qualifiers `(override)`, `(const, override)`, etc., to match the base method signature.

### Example:
```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

## 2. Using EXPECT_CALL to Set Expectations

`EXPECT_CALL` declares expectations that mock methods will be called with specified arguments and frequency.

### Basic form:
```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- Must precede code exercising the mock.
- `matchers...` define argument expectations. Use `_` to allow any argument.
- `Times` specifies how many times the call should happen (e.g., `AtLeast(1)`, `Exactly(2)`). If omitted, inferred from actions.
- `WillOnce` and `WillRepeatedly` specify behavior for calls.

### Advanced clauses:
- `.With(matcher)`: Match arguments as a tuple for complex validation.
- `.InSequence()`: Enforce calls occur in a sequence.
- `.After()`: Specify that a call happens after particular expectations.
- `.RetiresOnSaturation()`: Retire the expectation when saturated to allow other expectations to match later calls.

### Overview Example:
```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::AtLeast;

EXPECT_CALL(mock_turtle, Forward(100))
    .Times(AtLeast(1))
    .WillRepeatedly(Return());

// Calls to mock_turtle.Forward(100) must occur at least once.
```

### Important notes:
- Expectations are "sticky"; they remain active after saturation unless marked with `RetiresOnSaturation`.
- Later `EXPECT_CALL`s override earlier matching expectations.
- If a method is overloaded, you must specify argument matchers to disambiguate.

## 3. Using ON_CALL to Set Default Behavior

`ON_CALL` configures the default behavior of mock methods without setting call count expectations.

### Syntax:
```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .WillByDefault(action);
```

- This defines what happens when the method is called but doesn't require that it be called.
- Useful for setting common default behaviors, often in mock class constructors or test fixtures.

### Example:
```cpp
ON_CALL(mock_turtle, GetX())
    .WillByDefault(Return(42));
```

- Combined with `EXPECT_CALL`, `EXPECT_CALL` behaviors supersede `ON_CALL` behaviors when matching.

## 4. Mock Strictness: NiceMock, NaggyMock, and StrictMock

- **NaggyMock** (default): Warns on calls to mock methods without expectations (`uninteresting calls`).
- **NiceMock**: Suppresses warnings for uninteresting calls â€” keeps tests quieter and more maintainable.
- **StrictMock**: Treats uninteresting calls as errors, making tests strict and fail-fast.

Usage example:
```cpp
NiceMock<MockTurtle> nice_mock;
StrictMock<MockTurtle> strict_mock;
```

## 5. Common User Questions

### How to mock private or protected methods?
- Declare `MOCK_METHOD` in the `public:` section of the mock class even if base methods are protected or private.

### How to mock overloaded methods?
- Mock each overload separately using `MOCK_METHOD` with appropriate argument lists and qualifiers.
- Use `Const()` wrapper for const method overloads.

### How can I verify that a method is *never* called?
- Use `Times(0)` with `EXPECT_CALL`:
```cpp
EXPECT_CALL(mock_obj, Foo(_)).Times(0);
```

### What if I want different behavior depending on arguments?
- Define multiple `EXPECT_CALL`s with different matchers. The most recently defined matching expectation will be used.

### How to specify call order?
- Use `InSequence` object or `After()` clause to control order of mock method calls.

### How to delegate calls to real or fake implementations?
- Use `ON_CALL` with lambdas or functors that forward the calls.

## 6. Example Workflow

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
   virtual ~Foo() {}
   virtual int Bar(int x) = 0;
};

class MockFoo : public Foo {
 public:
   MOCK_METHOD(int, Bar, (int x), (override));
};

TEST(FooTest, ReturnsExpectedValues) {
  MockFoo mock;

  // Default action
  ON_CALL(mock, Bar(_))
      .WillByDefault(::testing::Return(0));

  // Expect Bar(3) will be called exactly twice and will return 5
  EXPECT_CALL(mock, Bar(3))
      .Times(2)
      .WillRepeatedly(::testing::Return(5));

  EXPECT_EQ(5, mock.Bar(3));
  EXPECT_EQ(5, mock.Bar(3));
  EXPECT_EQ(0, mock.Bar(10));  // Default action applies
}
```

## 7. Troubleshooting Tips

- Always set expectations *before* exercising mocks; unspecified calls may cause errors or warnings.
- Use `--gmock_verbose=info` to get detailed call traces when debugging unexpected behavior.
- Use `RetiresOnSaturation()` to avoid "sticky" expectations that cause unwanted errors.
- When mocking overloaded methods, specify argument matchers or use `Const()` to clarify intent.
- For move-only types, mocks support them but use lambdas in actions to create or handle such types.
- If mock verification failures occur, check call arguments and order as per expectation definitions.

## 8. Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html): Beginner-friendly introduction.
- [Mocking Reference](reference/mocking.md): Complete macro and class API.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Detailed recipes and patterns.
- [Matchers Reference](reference/matchers.md): How to write argument matchers.
- [Actions Reference](reference/actions.md): Behaviors you can set in mocks.
- [Strictness Modes & Behaviors](api-reference/gmock-mocking-framework/strictness-modes-and-behaviors.md): Deep dive into mock strictness.

---

Maintain your mocks by balancing expressiveness and maintaining test resilience. Use `ON_CALL` to specify default mock behavior and `EXPECT_CALL` to write precise tests verifying interactions. Gradually incorporate sequences and conditions for complex call ordering, and leverage NiceMock and StrictMock for noise control and stricter failure detection. Practice prevents common pitfalls and empowers your test suite with clarity and robustness.
