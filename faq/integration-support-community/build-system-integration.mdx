---
title: "Build System (CMake, Bazel) Integration Problems"
description: "Solutions to integration challenges with build systems like CMake or Bazel, such as linking errors, transitive dependencies, and best practices for maintaining manageable configurations. Includes pointers to official samples and configuration files."
---

# Build System (CMake, Bazel) Integration Problems

Integrating GoogleTest and GoogleMock into your C++ projects using popular build systems such as CMake or Bazel is straightforward when following best practices. However, users often encounter common challenges related to linking errors, transitive dependencies, and configuration management that can impede successful integration. This guide addresses these typical issues and provides practical solutions to ensure a smooth build experience.

---

## 1. Common Integration Challenges

### Linking Errors

- **Undefined symbols during linking:** Often caused by missing GoogleTest or GoogleMock libraries in the link command or linking against only `gtest` without `gtest_main` when using the default `main()`.
- **Runtime mismatches on Windows:** When using Visual Studio, runtime library mismatches (e.g., static vs. dynamic CRT linkage) can lead to linker errors like `LNK2038`.
- **Cross-dependencies:** GoogleMock depends on GoogleTest internally; failure to include both can cause unresolved symbols.

### Transitive Dependency Issues

- GoogleMock requires GoogleTest sources to be present due to tight coupling.
- When embedding GoogleTest/GoogleMock in larger projects, forgetting to propagate correct compile flags and link dependencies (such as pthreads when applicable) leads to build failures.

### Configuration Pitfalls

- Incorrect or missing compiler flags for C++17 compliance.
- Neglecting to set options like `gtest_force_shared_crt` on Windows can cause runtime mismatches.
- Overriding compiler/linker settings improperly or out-of-order causing unexpected flags or behavior.

---

## 2. Best Practices for Successful Integration

### Using CMake

1. **Add GoogleTest/GoogleMock using `add_subdirectory()`**

   Adding the source directly ensures consistent compiler and linker settings:

   ```cmake
   add_subdirectory(googletest)  # Path to GoogleTest sources
   # For GoogleMock
   add_subdirectory(googlemock)
   ```

2. **Link to the appropriate libraries:**

   - Use `GTest::gtest` or `GTest::gtest_main` in your `target_link_libraries()`.
   - For GoogleMock, link against `gmock` or `gmock_main` accordingly.

3. **Handle compiler flags and threading:**

   The included `cmake/internal_utils.cmake` configures compiler and linker options to suit GoogleTest’s requirements.

4. **Set `gtest_force_shared_crt` on Windows if using dynamic CRT:**

   ```cmake
   set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
   ```

5. **Enable testing and auto-discover tests:**

   ```cmake
   enable_testing()
   include(GoogleTest)
   gtest_discover_tests(your_test_target)
   ```

### Using Bazel

- Add GoogleTest as a Bazel dependency via the Bazel Central Registry in your `MODULE.bazel`:

  ```python
  bazel_dep(name = "googletest", version = "1.17.0")
  ```

- Declare tests using `cc_test` and depend on `@googletest//:gtest` and `@googletest//:gtest_main`:

  ```python
  cc_test(
      name = "my_test",
      srcs = ["my_test.cc"],
      deps = ["@googletest//:gtest", "@googletest//:gtest_main"]
  )
  ```

- Specify C++ standards explicitly, e.g., `--cxxopt=-std=c++17`.

---

## 3. Troubleshooting Common Issues

<AccordionGroup title="Troubleshooting Common Build Issues">
<Accordion title="Linker Errors related to Missing Symbols">

- Ensure you link both `gtest` and `gtest_main` (or `gmock` and `gmock_main` for GoogleMock).
- Add all relevant source files and dependencies to your targets.
- If using shared libraries, confirm correct `COMPILE_DEFINITIONS` such as `GTEST_LINKED_AS_SHARED_LIBRARY=1` are defined.

</Accordion>
<Accordion title="Runtime Library Mismatch on Windows">

- Enable the CMake option `gtest_force_shared_crt` to align GoogleTest's CRT linkage with your project:
  
  ```cmake
  set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
  ```

- Avoid mixing static and dynamic CRT runtimes to prevent LNK2038 errors.

</Accordion>
<Accordion title="Pthread and Threading Issues">

- GoogleTest detects pthread availability and links to `Threads::Threads` if enabled.
- On MinGW or Windows, pthread support is disabled by default; Windows threading primitives are used instead.
- If your environment incorrectly detects pthread availability, override with macro definitions:

  ```cmake
  add_compile_definitions(-DGTEST_HAS_PTHREAD=0)
  ```

</Accordion>
<Accordion title="Compilation Standards and Flags Not Applied">

- Make sure you specify at least C++17 standard support via:

  ```cmake
  set(CMAKE_CXX_STANDARD 17)
  set(CMAKE_CXX_STANDARD_REQUIRED ON)
  ```

- Avoid overriding compiler flags after including GoogleTest’s CMake or adding its subdirectory.

</Accordion>
<Accordion title="Conflicting Macro Definitions">

- To avoid macro name clashes with GoogleTest in mixed codebases, use macros like:

  ```cmake
  add_compile_definitions(-DGTEST_DONT_DEFINE_TEST=1)
  ```

- This changes macros such as `TEST()` to `GTEST_TEST()`, resolving name collisions.

</Accordion>
</AccordionGroup>

---

## 4. Examples: Build Configuration Snippets

### Minimal CMake Setup for GoogleTest

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add GoogleTest sources
add_subdirectory(path/to/googletest)

add_executable(my_test my_test.cc)
target_link_libraries(my_test PRIVATE GTest::gtest_main)

enable_testing()
include(GoogleTest)
gtest_discover_tests(my_test)
```

### CMake Setup Embedding GoogleMock with Shared CRT on Windows

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
add_subdirectory(path/to/googlemock)

add_executable(my_mock_test my_mock_test.cc)
# Link to gmock_main which links to gtest too.
target_link_libraries(my_mock_test PRIVATE gmock_main)

enable_testing()
include(GoogleTest)
gtest_discover_tests(my_mock_test)
```

### Bazel BUILD file example

```python
cc_test(
    name = "foo_test",
    srcs = ["foo_test.cc"],
    deps = ["@googletest//:gtest", "@googletest//:gtest_main"],
)
```

---

## 5. Additional Tips and Recommendations

- Regularly update your GoogleTest and GoogleMock versions to ensure the latest fixes and compatibility improvements.
- When embedding GoogleTest, keep it in a known directory for ease of maintenance and updating.
- Use `FetchContent` in CMake or Bazel’s module system for automated dependency retrieval and version pinning.
- Inspect GoogleTest’s `cmake/internal_utils.cmake` file for detailed compiler flag customizations.
- Monitor your build logs for implicit warnings about threading or runtime mismatches.
- For complex projects, consider creating wrapper targets for GoogleTest libraries to simplify dependency management.

---

## 6. Reference Links

- [GoogleTest README - Build Instructions](https://github.com/google/googletest/blob/main/googletest/README.md)
- [Integration with Build Systems](https://github.com/google/googletest/blob/main/docs/overview/use-cases-integration/integration-with-build-systems.md)
- [Quickstart: Building with CMake](https://github.com/google/googletest/blob/main/docs/quickstart-cmake.md)
- [Quickstart: Building with Bazel](https://github.com/google/googletest/blob/main/docs/quickstart-bazel.md)
- [CMake Internal Utilities Source](https://github.com/google/googletest/blob/main/googletest/cmake/internal_utils.cmake)

---

## 7. Getting Help

If you encounter integration problems that you cannot resolve:

- Review the [Installation and Setup Issues FAQ](https://docs.google.com/document/d/faq/getting-started-faq/installation-issues) for common pitfalls.
- Consult community forums or the GitHub Issues page for GoogleTest for existing solutions or to ask for help.
- Examine your build system configurations to ensure no conflicting flags override GoogleTest’s settings.

---

By following these guidelines and solutions, developers will be able to efficiently integrate GoogleTest and GoogleMock into their C++ projects while minimizing common build and linking problems.