---
title: "Performance and Scalability Tips"
description: "Answers questions on speeding up test execution, optimizing for large test suites, and reducing resource usage. Shares best practices for writing efficient tests and leveraging test runners or parallel execution tools supported by GoogleTest."
---

# Performance and Scalability Tips

This page provides practical guidance to speed up your GoogleTest test execution, optimize large test suites, and reduce resource usage. It covers best practices for writing efficient tests, and leveraging parallel execution and test runners supported by GoogleTest.

---

## 1. Understanding Test Execution Bottlenecks

Before optimizing, identify what slows down your test suite:

- **Excessive Test Runtime:** Many tests or expensive setups.
- **Sequential Execution:** Tests running one after another.
- **Heavy Resource Usage:** Excessive memory or CPU consumption.
- **Synchronous Dependencies:** Tests waiting on external resources.

Use profiling tools to measure which tests take the longest.

---

## 2. Writing Efficient Tests

### 2.1 Keep Tests Lightweight

- Design tests to execute quickly: prefer in-memory data, avoid file I/O when possible.
- Use test fixtures to share expensive setup across multiple tests.
- Only verify what you need to â€” avoid over-specifying expectations that add overhead.

### 2.2 Avoid Global or Shared State

- Tests should be independent and repeatable.
- Avoid introducing dependencies between tests that serialize execution.

### 2.3 Use On-demand Initialization

- Lazily initialize expensive resources only when absolutely necessary.
- Tear down resources promptly to free memory.

---

## 3. Leveraging Parallel Test Execution

GoogleTest supports parallel test execution strategies to reduce wall time:

### 3.1 Sharding Tests Across Processes

- Use test sharding to split tests into groups, running multiple test processes concurrently.
- Set environment variables `GTEST_TOTAL_SHARDS` and `GTEST_SHARD_INDEX`.
- Example:

  ```bash
  export GTEST_TOTAL_SHARDS=4
  export GTEST_SHARD_INDEX=0  # For first shard
  ./my_test_binary
  # Repeat with SHARD_INDEX=1, 2, 3 on other machines or processes
  ```

### 3.2 External Parallel Test Runners

- Tools like `gtest-parallel` run GoogleTest binaries in parallel with test filtering.
- They automatically manage distributing test cases and aggregating results.
- Ideal for large suites without native parallelism.

### 3.3 Thread Safety in GoogleTest

- GoogleTest is thread-safe on POSIX-compliant platforms.
- Avoid running GoogleTest assertions concurrently on multiple threads in unsupported environments.
- GoogleMock supports safe mock usage with concurrent calls (see [gmock_stress_test.cc](https://github.com/google/googletest/blob/main/googlemock/test/gmock_stress_test.cc)).

---

## 4. Optimizing Mock Usage for Performance

### 4.1 Minimize Mock Complexity

- Mock only methods necessary for the test.
- Use `ON_CALL` for default behaviors and reserve `EXPECT_CALL` for calls you want to verify.
- Use `NiceMock` wrapper to suppress unimportant call warnings.

### 4.2 Use Sequences and Cardinalities Wisely

- Avoid excessive use of `EXPECT_CALL` sequences unless order verification is required.
- Use `.Times(AnyNumber())` when call counts are irrelevant.

### 4.3 Thread-safe Mocks

- GoogleMock internally supports multiple threads invoking methods on mock objects concurrently.
- When testing multi-threaded code, ensure expectation setup and mock destruction happen on a single thread.

---

## 5. Reducing Resource Consumption

- Free resources explicitly in `TearDown()` to avoid memory bloat.
- Avoid large data structures in mocks or fixtures unless needed.
- Use `DefaultValue` to control default return values and prevent expensive initializations.

---

## 6. Best Practices Workflow

<Steps>
<Step title="Profile Your Test Suite">
Run your tests with timing measurements to find the slowest tests.
</Step>
<Step title="Refactor Slow Tests">
Simplify or break down heavy tests. Use fixtures to avoid repeated expensive setup.
</Step>
<Step title="Enable Parallel Execution">
Use sharding or parallel runners to utilize all CPU cores and reduce wall time.
</Step>
<Step title="Monitor and Tune Mock Expectations">
Review expectations and mock configurations to remove unnecessary complexity.
</Step>
<Step title="Continuous Profiling and Maintenance">
Periodically profile tests as code evolves to prevent regressions.
</Step>
</Steps>

---

## 7. Troubleshooting Common Performance Issues

<AccordionGroup title="Performance Troubleshooting">
<Accordion title="Tests Run Too Slowly">
Evaluate test setup costs and dependencies. Consider mocking external dependencies or breaking tests into smaller units.
</Accordion>
<Accordion title="Memory Usage Growing Unexpectedly">
Ensure proper resource cleanup. Fix leaks by reviewing mock object lifetimes and fixture TearDown.
</Accordion>
<Accordion title="Parallel Execution Causes Flaky Tests">
Verify tests are truly independent. Avoid shared global state or use synchronization primitives.
</Accordion>
<Accordion title="Mock Calls Cause Thread Safety Errors">
Ensure expectations are set before multi-threaded code runs. Avoid modifying mocks concurrently.
</Accordion>
</AccordionGroup>

---

## 8. Additional Tools and References

- **gmock_stress_test.cc** in the GoogleMock test suite demonstrates effective usage of mocks in multi-thread scenarios and serves as a model for writing thread-safe mock tests.
- Use the [`--gmock_verbose=LEVEL`](docs/reference/mocking.md#flags) flag (`info`, `warning`, `error`) to adjust output verbosity during tests and diagnose performance issues.
- Consult [GoogleTest Primer](https://google.github.io/googletest/primer.html) for foundational testing concepts.
- Explore [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced mocking techniques.
- Leverage [Performance and Parallelism Guide](https://google.github.io/googletest-guides/integration-and-troubleshooting/performance-and-parallelism.html) for comprehensive optimization strategies.

---

## 9. Example: Parallel Execution with Sharding

```bash
# Run 4 parallel shards of tests
export GTEST_TOTAL_SHARDS=4

# Shard 0
export GTEST_SHARD_INDEX=0
./test_binary &

# Shard 1
export GTEST_SHARD_INDEX=1
./test_binary &

# Shard 2
export GTEST_SHARD_INDEX=2
./test_binary &

# Shard 3
export GTEST_SHARD_INDEX=3
./test_binary &

wait
```

This reduces overall test wall time by running shards simultaneously.

---

## 10. Summary

Optimizing GoogleTest involves carefully structuring tests to be fast and independent, leveraging parallelism via sharding or external runners, and efficiently managing mocks to minimize overhead. Regular profiling, proper resource management, and adherence to thread-safety best practices ensure scalable, maintainable, and performant test suites.

---

### Related Documentation

- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Mocking Reference](https://google.github.io/googletest/docs/reference/mocking.html)
- [Performance and Parallelism Guide](https://google.github.io/googletest-guides/integration-and-troubleshooting/performance-and-parallelism.html)

### Support and Community

- For questions and discussions, visit the [GoogleTest GitHub Discussions](https://github.com/google/googletest/discussions)
- Report issues or request features via the [GoogleTest Issue Tracker](https://github.com/google/googletest/issues)

---