---
title: "Performance Optimization and Best Practices"
description: "Recommendations for reducing test runtime, avoiding resource leaks, and managing test complexity in large suites. Discusses strategies for parallel execution, selective test runs, and usage of advanced test features."
---

# Performance Optimization and Best Practices

GoogleTest provides a powerful and flexible framework for writing and running C++ tests. As your test suite grows, optimizing test performance and managing test complexity become critical to maintain fast feedback cycles and efficient resource usage. This document offers actionable recommendations and best practices to reduce test runtime, avoid resource leaks, and use test features effectively in large test suites.

---

## 1. Reducing Test Runtime

Long test execution times can impede development velocity and continuous integration efficiency. Optimize your tests with these strategies:

### Run Selective Tests
- Use the `--gtest_filter` flag or the `GTEST_FILTER` environment variable to run only a subset of tests relevant to your current change.
- Combine filters with inclusion and exclusion patterns to precisely target test execution.

### Test Sharding
- Use test sharding to distribute tests across multiple machines or processes.
- Set environment variables `GTEST_TOTAL_SHARDS` and `GTEST_SHARD_INDEX` to split workload.
- Ensure tests are independent and can run in any order to maximize sharding effectiveness.

### Parallel Execution
- Run tests in parallel on multi-core systems or in CI pipelines using test runners such as `gtest-parallel`.
- Ensure tests do not share mutable global state that would cause race conditions.

### Reuse Shared Resources
- Use test fixtures' per-suite set-up (`SetUpTestSuite`/`TearDownTestSuite`) to do expensive initialization once.
- Avoid repeating costly initialization for every test.

### Minimize Test Body Complexity
- Verify the minimal necessary behavior in each test to reduce the amount of executed code.
- Prefer multiple focused tests over fewer complex tests that do too much.

### Avoid Sleeping or Waiting
- Refrain from using arbitrary delays or sleeps in tests.
- Use notification objects or condition variables for synchronization in concurrent tests.

---

## 2. Avoiding Resource Leaks

Resource leaks slow down your tests and may cause flaky failures over time.

### Use RAII and Test Fixtures
- Allocate resources in constructors or `SetUp()`.
- Release or clean up in destructors or `TearDown()`.

### Beware of `ASSERT_*` in Constructors/Destructors
- Avoid fatal assertions in constructors and destructors as they don't abort tests properly.
- Use `SetUp()` and `TearDown()` for assertions that may abort.

### Manage Shared Resources Carefully
- Dispose shared resources properly in `TearDownTestSuite()` to prevent leaks.
- Guard `SetUpTestSuite()` to avoid repeated allocations causing leaks in derived classes.

### Check for Leaks in Death Tests
- Death tests run in subprocesses; resource releases there do not affect the parent process.
- Consider disabling heap checkers or properly handling leaks caused by death tests.

---

## 3. Managing Test Complexity

As test suites grow, good organization and naming conventions keep the suite maintainable.

### Organize Tests into Logical Suites
- Group tests into test suites (`TEST()` or `TEST_F()` with consistent suite names) that reflect code structure.
- Share setup and fixtures within suites as appropriate.

### Use Test Fixtures and Parameterized Tests
- Use test fixtures to remove duplication and initialize common state.
- Leverage value-parameterized and typed tests for efficient coverage across data sets or types.

### Name Tests Clearly
- Avoid underscores (`_`) in test suite and test names to prevent issues with internal naming and test discovery.
- Use descriptive, concise names following C++ style guidelines.

### Use Disabled Tests Judiciously
- Temporarily disable flaky or incomplete tests using the `DISABLED_` prefix.
- Avoid accumulating disabled tests; document and fix or remove them promptly.

### Set Expectations for Mock Objects (gMock)
- Use `ON_CALL()` to define default mock behaviors without strict expectations.
- Use `EXPECT_CALL()` to verify specific interactions.
- Consider wrappers like `NiceMock` or `StrictMock` to control warning levels and strictness.

---

## 4. Advanced Test Features to Control

### Use GTest Flags to Optimize Test Runs
- `--gtest_repeat=N` to repeat tests multiple times to catch flaky behavior.
- `--gtest_shuffle` randomizes test orders to surface order-dependency issues.
- `--gtest_fail_fast` stops tests at first failure for faster debugging.

### Control Test Output
- Use `--gtest_color` to toggle colored output.
- Use `--gtest_brief=1` to suppress successful test output.
- Generate XML/JSON reports for CI systems with `--gtest_output=xml:path`.

### Skip Tests When Appropriate
- Use `GTEST_SKIP()` to skip tests based on runtime preconditions.
- Helps avoid irrelevant failures in unsuitable environments.

---

## 5. Practical Tips and Common Pitfalls

- **Always check the return value of `RUN_ALL_TESTS()` in `main()`.** This is critical for test-runner integration.
- **Do not call `RUN_ALL_TESTS()` more than once.**
- **Use `SetUp()` and `TearDown()` for setup and teardown logic, especially when assertions are needed.**
- **Ensure tests are independent and stateless whenever possible.**
- **Carefully manage mock expectations to avoid brittle tests; over-restricting leads to maintenance burden.**
- **Avoid shoulder-surfing test output clutter by redirecting logs and suppressing non-essential output.**

---

## 6. Verifying and Monitoring Performance

- Profile tests to find slowest test cases and optimize them.
- Use `RecordProperty()` in tests to record custom performance metrics.
- Regularly monitor test suite times, especially as codebase grows.
- Invest time in refactoring or splitting overly complex tests.

---

# References and Further Reading
- [GoogleTest Primer](primer.md) — foundational overview and basic test writing guidance.
- [Advanced GoogleTest Topics](advanced.md) — deeper insights into complex test construction.
- [Mocking Reference](docs/reference/mocking.md) — detailed usage of mocks and expectations.
- [Guides: Organizing Test Suites](guides/core-workflows/organizing-test-suites.md) — best practices for scaling test organization.
- [CI Integration](faq/integration-and-optimization/ci-integration.md) — tips for efficient automated testing in CI pipelines.

---

Keep these practices in mind as you design your tests to build a robust, fast, and maintainable test suite that truly helps deliver high-quality C++ software.