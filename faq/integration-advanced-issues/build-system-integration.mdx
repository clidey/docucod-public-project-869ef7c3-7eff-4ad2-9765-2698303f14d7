---
title: "Integrating with External Build Systems"
description: "Explains how to use GoogleTest and GoogleMock with common build systems and addresses integration pain points such as transitive dependencies, custom flags, or linking issues. References examples for CMake, Bazel, and pkg-config."
---

# Integrating GoogleTest and GoogleMock with External Build Systems

GoogleTest and GoogleMock provide comprehensive C++ testing and mocking capabilities. To fully harness these benefits, it is essential to integrate them smoothly into your project's build system. This guide walks you through practical integration techniques with popular tools such as CMake and Bazel, addresses common challenges like transitive dependencies and linking issues, and offers examples to streamline your setup.

---

## Why Integration Matters

Integrating GoogleTest and GoogleMock correctly in your build system ensures:

- Reliable compilation and linking of test binaries.
- Access to the full suite of testing and mocking features.
- Smooth dependency management with minimal manual intervention.
- Flexibility to customize build flags and handle platform-specific needs.

Failing to properly integrate may cause issues such as unresolved symbols, incorrect linkage, build failures, or runtime test failures.

---

## Integrating with CMake

CMake is the most common build system used with GoogleTest and GoogleMock. This section covers how to include, build, and link GoogleTest and GoogleMock within your CMake project.

### Adding GoogleTest and GoogleMock as Subdirectories

When your project is set up to build GoogleTest and GoogleMock from source, the recommended practice is to add them via `add_subdirectory`:

```cmake
cmake_minimum_required(VERSION 3.13)
project(MyProject)

# Add GoogleTest and GoogleMock sources
add_subdirectory(path/to/googletest)  # This includes both GoogleTest and GoogleMock

# Define your test executable
add_executable(my_tests test_main.cpp test_suite1.cpp)

# Link with gtest_main or gmock_main for automatic main()
target_link_libraries(my_tests gmock_main)

# Include GoogleTest and GoogleMock headers
target_include_directories(my_tests PRIVATE ${gtest_SOURCE_DIR}/include ${gmock_SOURCE_DIR}/include)
```

**Tips:**
- Use `gmock_main` when you want GoogleMock's built-in `main()` for running tests to avoid writing your own.
- The `add_subdirectory` approach ensures consistent compiler and linker settings.

### Using find_package

If GoogleTest is installed system-wide or via package managers, you can locate and link it using `find_package`:

```cmake
find_package(GTest REQUIRED)

add_executable(my_tests test_main.cpp)
target_link_libraries(my_tests GTest::gmock_main)
```

Note that `GTest::gmock_main` usually includes `gtest_main` and `gmock`. Check your system's package details.

### Handling Build Options and Flags

You can configure build options such as building tests or shared libraries using variables:

```cmake
option(BUILD_GMOCK_TESTS "Build tests for GoogleMock" OFF)
option(BUILD_SHARED_LIBS "Build shared libraries" OFF)

# Pass options to GoogleTest subdirectory
add_subdirectory(path/to/googletest)
```

Set flags before adding the subdirectory to ensure they take effect.

### Managing Transitive Dependencies

GoogleMock depends on GoogleTest, and both require thread libraries (like pthread on Unix).

- The CMake scripts handle threading libraries automatically.
- If using your own build scripts, ensure your test target links with both `gmock` and `gtest`.

### Linking Best Practices

- Link your test executables with `gmock_main` or `gtest_main` to pull in test runners.
- Avoid linking `gmock` and `gtest` separately unless you provide a custom `main()`.

### Example: CMakeLists.txt Snippet

```cmake
cmake_minimum_required(VERSION 3.13)
project(MyProjectTests LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add GoogleTest and GoogleMock
add_subdirectory(third_party/googletest)

add_executable(tests
  my_test.cpp
  another_test.cpp
)

target_link_libraries(tests PRIVATE gmock_main)
target_include_directories(tests PRIVATE
  third_party/googletest/include
  third_party/googletest/googlemock/include
)
```

---

## Integrating with Bazel

Bazel is another popular build tool, particularly in larger-scale or monorepo projects.

### Using GoogleTest and GoogleMock in Bazel

- GoogleTest and GoogleMock are typically included as external dependencies or fetched via Bazel's `http_archive` rule.
- Use Bazel testing rules `cc_test` to define your test target.

### Sample `BUILD` File

```bazel
load("@rules_cc//cc:defs.bzl", "cc_test")

cc_test(
  name = "my_tests",
  srcs = ["my_test.cpp"],
  deps = ["@com_google_googletest//:gmock_main"],
)
```

### Handling Dependencies

- `gmock_main` depends transitively on `gmock` and `gtest`.
- Bazel handles these dependencies, so linking them explicitly is unnecessary.

### Tips for Bazel Integration

- Verify your Bazel workspace configuration points to the correct version of GoogleTest.
- Adjust compiler settings through Bazel's C++ toolchain configurations.
- For special flags or macros, use Bazel's `copts` and `linkopts`.

---

## Using pkg-config

For some projects, especially on Linux, `pkg-config` can help discover and link GoogleMock.

### Sample `gmock.pc` and `gmock_main.pc`

These files can be generated from the configuration templates in the source tree and provide necessary flags:

```pc
# gmock.pc
Name: gmock
Description: GoogleMock (without main() function)
Version: 1.10.0
Requires: gtest = 1.10.0
Libs: -L/usr/local/lib -lgmock -lpthread
Cflags: -I/usr/local/include
```

```pc
# gmock_main.pc
Name: gmock_main
Description: GoogleMock (with main() function)
Version: 1.10.0
Requires: gmock = 1.10.0
Libs: -L/usr/local/lib -lgmock_main -lpthread
Cflags: -I/usr/local/include
```

Use `pkg-config --cflags gmock_main` and `pkg-config --libs gmock_main` to get compiler and linker flags.

---

## Common Integration Challenges and Their Solutions

### 1. Linking Errors

**Symptoms:** Undefined references to `gmock` or `gtest` symbols.

**Causes & Fixes:**
- Not linking `gmock`, `gmock_main`, or `gtest` libraries.
- Missing linkage to pthread or other thread libraries.
- Conflicting runtime libraries on Windows (dynamic vs static CRT).

**Solution:**
- Ensure your test target links to `gmock_main` or `gmock` and `gtest`.
- Verify thread libraries are linked (CMake usually handles this).
- On Windows, match your runtime library settings between your project and GoogleTest.

### 2. Transitive Dependency Confusion

**Symptoms:** Header files or symbols for GoogleTest not found despite linking.

**Causes & Fixes:**
- Incorrect include directories.
- Using different versions/installations of GoogleTest and GoogleMock.

**Solution:**
- Add GoogleMock and GoogleTest include paths to your target's include directories.
- Use consistent versions for GoogleTest and GoogleMock.

### 3. Duplicate `main()` Conflicts

**Symptoms:** Multiple definition errors for `main()`.

**Causes & Fixes:**
- Linking both `gmock_main` and `gtest_main` separately.
- Defining your own `main()` and linking in libraries with a `main()`.

**Solution:**
- Link only one of `gmock_main` or `gtest_main`, not both.
- If you provide your own `main()`, link only `gmock` and `gtest` libraries.

### 4. Custom Flags Not Propagating

**Symptoms:** Macros or compiler options not applied to GoogleMock or GoogleTest sources.

**Causes & Fixes:**
- Flags set after adding GoogleTest/GMock subdirectories.

**Solution:**
- Set compile options and definitions **before** including GoogleTest/GMock in your build.

---

## Best Practices for Integrating GoogleTest and GoogleMock

- **Prefer `gmock_main` library:** Unless customization is necessary, use `gmock_main` for test linkage to leverage provided `main()` implementation.
- **Use consistent compiler flags:** Ensure GoogleTest/GMock and your test code use the same standards (e.g., C++17) and warning levels.
- **Separate production and test code:** Keep tests and mocks isolated to avoid polluting release builds.
- **Leverage official CMake scripts:** Use GoogleTest's CMakeLists.txt as guidance or include them to reduce maintenance.
- **Automate dependency fetching:** Use `FetchContent` or Git submodules for managing dependencies with version control.
- **Run tests with `ctest`:** Use CMake's integrated testing tool to automate test runs and capture output concisely.

---

## Additional Resources

- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [GoogleTest CMake Integration Guide](https://github.com/google/googletest/blob/main/googletest/README.md#build-with-cmake)
- [GoogleTest FAQ](https://github.com/google/googletest/blob/main/googletest/docs/faq.md)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

---

_Integration is foundational to unlocking the power of GoogleTest and GoogleMock. With proper setup in your build system, you ensure faster builds, reliable tests, and a maintainable development workflow._
