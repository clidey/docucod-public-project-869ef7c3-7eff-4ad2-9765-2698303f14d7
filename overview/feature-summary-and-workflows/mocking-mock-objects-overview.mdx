---
title: "Mocking: Mock Objects & Expectations"
description: "Understand GoogleMock’s approach for simulating complex behaviors with mock objects. Explore core workflows for defining, using, and specifying expectations with mock methods in your tests."
---

# Mocking: Mock Objects & Expectations

## Simulating Complex Behaviors with GoogleMock Mocks

GoogleMock provides a powerful and flexible approach for simulating complex behaviors in C++ tests using *mock objects*. This page guides you through the essential workflows of defining mock classes, creating mock objects, and specifying **expectations** on mock methods to verify interactions between your code and its dependencies.

Understanding how to declare, configure, and verify mocks enables you to write precise and maintainable interaction-based tests that can simulate and validate complex behaviors and sequences in your software.

---

## What Are Mock Objects & Expectations?

**Mock objects** are stand-ins for real classes or interfaces, allowing you to mimic their behavior during testing without relying on their actual implementations. They allow you to:

- Specify *how* methods on those objects should be called (e.g., which arguments, how many times).
- Define *what happens* when these methods are called (e.g., return values, side effects).

The **expectations** you set (using `EXPECT_CALL`) enforce constraints on these calls, ensuring that your code behaves correctly in terms of its interactions.

Unlike fakes, which provide simplified implementations, mocks explicitly verify that your code calls their methods as intended, facilitating interaction-based verification.

---

## Core Workflow: Defining and Using Mock Objects

### 1. Declare a Mock Class

Create a mock class by deriving from an interface or base class with `virtual` methods and use the `MOCK_METHOD` macro to declare mocked methods in the `public:` section, matching the signature of the methods to mock.

```cpp
#include <gmock/gmock.h>

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (int type), (override));
};
```

**Key points:**
- Methods must be `virtual` to be mocked.
- Place `MOCK_METHOD` declarations in `public:` even if the base declares the method differently.
- Use the optional fourth parameter for qualifiers like `(const, override)`.

### 2. Create Mock Objects

Simply instantiate the mock class as you would any other class.

```cpp
MockFoo foo;
```

You can also create "nice", "naggy" (default), or "strict" mocks to control uninteresting call behavior:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_foo;
```

### 3. Set Default Actions (Optional) with `ON_CALL`

Use `ON_CALL` to specify the behaviors of mock methods for calls without explicit expectations.

```cpp
ON_CALL(foo, GetSize())
    .WillByDefault(Return(10));
```

You must terminate `ON_CALL` statements with `.WillByDefault()`.

### 4. Define Expectations with `EXPECT_CALL`

Expectations restrict how your code should call mock methods.

```cpp
EXPECT_CALL(foo, Describe(5))
    .Times(3)
    .WillRepeatedly(Return("Category 5"));
```

The `EXPECT_CALL` macro supports a robust set of chaining clauses (must be used in this order):

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)?
    .Times(cardinality)?
    .InSequence(sequences...)*
    .After(expectations...)*
    .WillOnce(action)*
    .WillRepeatedly(action)?
    .RetiresOnSaturation()?;
```

- `With`: Applies an additional matcher over all arguments as a tuple.
- `Times`: Specifies how many times the function can be called (e.g., `Exactly(1)`, `AnyNumber()`).
- `InSequence`: Requires calls to occur in a particular order within specified sequences.
- `After`: Specifies the expectation can occur only after other expectations.
- `WillOnce` and `WillRepeatedly`: Define the actions the call performs on the first calls and on subsequent calls.
- `RetiresOnSaturation`: Retires the expectation when its call count is saturated.

### 5. Exercise and Verify

Invoke the code under test that uses your mock objects. GoogleMock will automatically:

- Check that all expectations are satisfied at mock object destruction.
- Report errors immediately if unexpected calls or unmet expectations are detected.

Optionally, you can explicitly verify expectations sooner:

```cpp
ASSERT_TRUE(Mock::VerifyAndClearExpectations(&foo));
```

---

## Specifying Expectations Effectively

### Argument Matching

- Use exact values (e.g., `5`) or matchers (e.g., `_`, `Ge(5)`, `NotNull()`).
- For overloaded functions, disambiguate using `Const()` or explicit matcher casts.
- `With()` allows multi-argument constraints on the full argument tuple.


### Controlling Call Counts with Cardinalities

Choose the right cardinality to reflect your test intent:

- `Exactly(n)`: Expect exactly `n` calls.
- `AtLeast(n)`, `AtMost(n)`: Fuzzy counts.
- `AnyNumber()`: Calls are unrestricted.

If omitted, GoogleMock infers:
- If no `WillOnce` or `WillRepeatedly`: `Times(1)`.
- If n `WillOnce`s: `Times(n)`.
- If n `WillOnce`s and a `WillRepeatedly`: `Times(AtLeast(n))`.

### Call Order and Sequences

- Use `InSequence` or the `InSequence` scope object to enforce ordering.
- Use `After` to set explicit partial-order dependencies.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(foo, Initialize()).InSequence(s1);
EXPECT_CALL(foo, Process()).InSequence(s1, s2);
EXPECT_CALL(foo, CleanUp()).InSequence(s2);
```

### Actions: Defining Call Behavior

Define what the mock method does when called:

- `Return(value)` to return a value.
- `ReturnRef(ref)` to return a reference.
- `Invoke(functor)` to call a function, lambda, or method.
- `DoAll(a1, a2, ..., an)` to perform a sequence of actions.
- `SetArgPointee<N>(value)` to modify output arguments.

Example:

```cpp
EXPECT_CALL(foo, Compute(_))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(7));
```

### Retiring Expectations Automatically

When an expectation has reached its call count limit, it normally stays "active" (sticky).

Use `.RetiresOnSaturation()` to deactivate it immediately after saturation, allowing other expectations to become active.

---

## Tips & Best Practices

- **Use `ON_CALL` to set default behaviors** for methods when you don't care about verifying call counts.
- **Use `EXPECT_CALL` sparingly** to verify only the necessary interactions.
- **Avoid brittle tests** by not over-specifying call orders or argument matchers.
- **Group expectations in sequences** only when the order is essential.
- **Disambiguate overloaded methods** using `Const()` or explicit matcher casts.
- **Remember that newer expectations override older ones** when matching calls (search is back-to-front).
- **Use `NiceMock` or `StrictMock` to control the behavior on uninteresting calls**.

---

## Common Pitfalls & Troubleshooting

### Unexpected Calls

Calls that don’t match any `EXPECT_CALL` are errors ("unexpected calls") and generate failure messages showing the unmatched arguments and the currently active expectations.

### Uninteresting Calls

Calls made to methods without any expectations are "uninteresting calls". By default, these emit warnings but continue. Use `NiceMock` to suppress warnings or `StrictMock` to turn them into failures.

### Actions Exhausted

If the number of calls exceeds the actions specified via `WillOnce()`, GoogleMock falls back to default values or `WillRepeatedly()` actions if provided; otherwise, warnings appear.

### Mock Method Signature Mismatches

Ensure mocked methods exactly match the virtual method signature (e.g., const-ness, noexcept) to avoid compile warnings/errors.

### Mocking Non-Virtual Methods

*Methods must be virtual to be mocked.* If you must mock non-virtual methods, consider alternative patterns such as interface abstractions or dependency injections.

---

## Illustrative Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;
using ::testing::_;
using ::testing::InSequence;

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetCount() const = 0;
  virtual void Process(int x) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetCount, (), (const, override));
  MOCK_METHOD(void, Process, (int x), (override));
};

TEST(FooTest, OrderedCalls) {
  MockFoo mock_foo;

  {
    InSequence seq;

    EXPECT_CALL(mock_foo, Process(1));
    EXPECT_CALL(mock_foo, Process(2));
    EXPECT_CALL(mock_foo, GetCount())
        .WillOnce(Return(42));
  }

  mock_foo.Process(1);
  mock_foo.Process(2);
  EXPECT_EQ(mock_foo.GetCount(), 42);
}
```

In this example, we assert the order of calls and specify return behavior.

---

## Additional Resources & Next Steps

- [What is GoogleTest?](../product-intro-and-value/what-is-google-test) — foundational overview of the framework
- [Creating and Using Mocks](../mocking-best-practices/creating-mocks) — deeper guide on creating mock classes
- [Writing Expectations and Actions](../mocking-best-practices/writing-expectations-actions) — practical usage of `EXPECT_CALL` and associated clauses
- [Managing Mock Strictness](../mocking-best-practices/mock-strictness) — how to control uninteresting call behaviors
- [Mocking Cookbook](../gmock_cook_book.md) — extensive recipes and tips
- [Mocking Reference](../reference/mocking.md) — detailed API documentation

For troubleshooting:
- [Mocking FAQ](../faq/common-issues-solutions/mocking-failures)
- [Troubleshooting & Common Setup Issues](../../getting-started/first-steps-usage/troubleshooting-setup)

---

Mastering mocks and expectations lets you simulate nuanced behaviors and ensure your code's interactions are spot-on and easy to validate. Begin experimenting with `MOCK_METHOD`, `ON_CALL`, and `EXPECT_CALL` today, and unlock the full power of behavior-driven C++ testing.
