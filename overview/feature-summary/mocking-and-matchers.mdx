---
title: "Mocking and Matcher Features"
description: "Understand how to leverage GoogleMock's matchers, actions, cardinalities, and mock method generation for expressive, controlled unit tests. Get a sense of the matcher and action ecosystem and learn where to dive deeper."
---

# Mocking and Matcher Features

Unlock the full expressive power of GoogleMock by mastering its core mocking constructs. On this page, you'll learn how to define mock methods, manipulate expectations, leverage matchers to specify call constraints, apply actions to control mock behaviors, and manage call cardinalities and execution order. Whether you're setting up your first mock or refining complex test interactions, this guide gives you the essential overview to harness GoogleMock's features for reliable, maintainable C++ unit tests.

---

## Introduction to Mocking Features

GoogleMock equips you with a rich, intuitive syntax to create mock methods in your classes and precisely specify how they should behave during tests. Its central component is the `MOCK_METHOD` macro, which declares mocked virtual methods effortlessly. Using `EXPECT_CALL` and `ON_CALL`, you establish expectations and default behaviors for these mocks, applying advanced constraints and actions to simulate any interaction scenario.

With GoogleMock’s matchers, you declaratively define argument patterns your mock methods should accept, enabling a flexible approach that balances strictness and generality. You also control how many times a method is expected to be called through cardinalities, and enforce sequences or dependencies with built-in constructs like `Sequence` and `After`.

By the end of this page, you will understand how to leverage these features to design expressive, robust tests that focus on what truly matters — the interaction between your code and its dependencies.

---

## Defining and Using Mock Methods

### The `MOCK_METHOD` Macro

At the heart of mocking is defining mock methods that replace real behavior with controllable test doubles. To declare such methods within your mock class, use:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (OptionalQualifiers));
```

**Key points:**
- Place all `MOCK_METHOD` declarations in the `public:` section, regardless of original method access level.
- To mock `const`, `noexcept`, or `override` methods, specify those qualifiers in the fourth parameter.
- When argument or return types contain commas (e.g., `std::pair<bool, int>`), wrap the type in parentheses or define type aliases to ensure correct parsing.

Example:

```cpp
class MockFoo {
 public:
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  MOCK_METHOD(void, Resume, (), (override));
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
};
```

---

### Handling Overloaded Methods

GoogleMock handles method overloads smoothly. Mock each overload explicitly:

```cpp
MOCK_METHOD(int, Add, (int x), (override));
MOCK_METHOD(int, Add, (int times, Element x), (override));
MOCK_METHOD(const Bar&, GetBar, (), (const, override));
```

If you skip some overloads, you risk hiding them, causing compiler warnings. To bring base versions back into scope:

```cpp
using Foo::Add;  // Brings base class Add methods into scope
```

---

### Mocking Non-Virtual Methods

Though `MOCK_METHOD` is primarily for virtual methods, you can mock non-virtual methods too by defining mock methods with matching signatures in unrelated mock classes. This enables compile-time selection via templates for high-performance dependency injection.

Example:

```cpp
class MockPacketStream {
 public:
  MOCK_METHOD(const Packet*, GetPacket, (size_t packet_number), (const));
  MOCK_METHOD(size_t, NumberOfPackets, (), (const));
};
```

---

## Setting Expectations and Behaviors

### `EXPECT_CALL` — Expecting Calls

Use `EXPECT_CALL(mock_obj, Method(matchers...))` to specify the calls you expect your mock method to receive:

- The matchers specify argument constraints.
- Chain modifier clauses to control matching behavior, call order, and actions.

Modifier clauses include (must appear in this order):

- `.With(matcher)` — multi-argument matcher that restricts arguments as a tuple.
- `.Times(cardinality)` — number of expected calls.
- `.InSequence(sequences...)` — expects calls to occur in the given sequences, imposing partial order.
- `.After(expectations...)` — call should occur after specified expectations.
- `.WillOnce(action)` — action to execute on the next matching call, can appear multiple times.
- `.WillRepeatedly(action)` — action to execute on all subsequent calls.
- `.RetiresOnSaturation()` — retire the expectation when saturated.

Example:

```cpp
EXPECT_CALL(my_mock, GetNumber())
    .Times(3)
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));
```

This says `GetNumber()` will be called exactly three times returning `1`, `2`, and `3` in sequence.

---

### `ON_CALL` — Default Behavior Without Expectation

Unlike `EXPECT_CALL`, `ON_CALL(mock_obj, Method(matchers...))` sets default behavior but does not expect the call:

- When the method is invoked and no expectation matches, this behavior is used.
- Requires `.WillByDefault(action)` to specify action.
- Supports a single `.With(matcher)` clause.

Example:

```cpp
ON_CALL(my_mock, Greet())
    .WillByDefault(Return("hello"));
```

---

## Matchers: Controlling Argument Verification

Matchers provide flexible pattern matching on mock method arguments. Instead of specifying exact argument values, use matchers to express constraints, e.g.: 

- `_` — wildcard that matches any argument.
- `Eq(value)` — matches exactly equal values.
- `Ge(value)`, `Lt(value)`, `Ne(value)` — relational matchers.
- `Pointee(matcher)` — matches pointer arguments whose pointee value matches `matcher`.
- Combine via `AllOf()`, `AnyOf()`, `Not()`.
- Match members or properties with `Field()` and `Property()`.
- Match tuples of arguments using `.With()`.

Example:

```cpp
EXPECT_CALL(foo, DoThis(Lt(5), Ne(0)));  // arg0 < 5 and arg1 != 0
EXPECT_CALL(bar, Process(_));  // matches any argument
EXPECT_CALL(baz, SetName(Field(&Person::first_name, StrEq("Alice"))));
```

---

## Cardinalities: Specifying Call Counts

You control how many times a mock method is expected to be called via cardinalities in `.Times()`:

- `Exactly(n)` (or just `n`) — exact count.
- `AtLeast(n)` — minimum count.
- `AtMost(n)` — maximum count.
- `Between(m, n)` — inclusive range.
- `AnyNumber()` — zero or more times.

If omitted, cardinality is inferred based on `WillOnce()` and `WillRepeatedly()` clauses.

Example:

```cpp
EXPECT_CALL(mock, Foo()).Times(2);  // Expect exactly 2 calls
EXPECT_CALL(mock, Bar(_)).Times(AnyNumber());  // Allow unlimited calls
```

---

## Execution Order: Controlling Call Sequencing

GoogleMock offers rich support for controlling **when** mock calls are expected:

- Use `InSequence` to enforce calls occur in the order of expectations within a scope.
- Use `Sequence` objects with `.InSequence(seq1, seq2)` to specify partial order graphs.
- Use `.After(expectation...)` to require one call happen after others.
- `.RetiresOnSaturation()` allows expectations to become inactive after their allowed calls.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Reset()).InSequence(s1, s2);
EXPECT_CALL(mock, Start()).InSequence(s1);
EXPECT_CALL(mock, Stop()).InSequence(s2);
```

This imposes that `Reset()` occurs before both `Start()` and `Stop()`, but `Start()` and `Stop()` can occur in any order.

---

## Actions: Defining Mock Method Behavior

Actions determine what a mock method does when called:

- `Return(value)` — returns a copy of the given value.
- `ReturnRef(variable)` — returns a reference to a variable.
- `ReturnPointee(pointer)` — returns the pointed-to value, evaluated at call time.
- `DoAll(action1, ..., action_n)` — performs multiple actions in order.
- `SetArgPointee<N>(value)` — sets the N-th pointer argument's pointee to a value.
- `Invoke(callable)` — calls a user function, method, functor, or lambda.
- `InvokeWithoutArgs()` — calls a function or callable, ignoring mock arguments.
- `IgnoreResult(action)` — discards action's return value to match `void` return mock methods.

Example:

```cpp
EXPECT_CALL(mock, Process(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

This will set argument 1 to 42 and then return true.

---

## Mock Object Types: Nice, Naggy, and Strict Mocks

Control how uninteresting calls to mocks are handled:

- **NaggyMock** (default): warns on uninteresting calls.
- **NiceMock**: suppresses warnings on uninteresting calls.
- **StrictMock**: failures occur on uninteresting calls.

Example usage:

```cpp
NiceMock<MockFoo> nice_mock;  // Quiet uninteresting calls
StrictMock<MockFoo> strict_mock;  // Errors on unexpected calls
```

---

## Practical Tips & Best Practices

- Use `ON_CALL` to define common behaviors shared across tests; reserve `EXPECT_CALL` for behavior you intend to *verify*.
- Order expectations with `Sequence` or `InSequence` to avoid brittle tests.
- Use `.RetiresOnSaturation()` in loops or repeated actions to prevent expectation overlap errors.
- Define custom matchers with `MATCHER` macros to express domain-specific logic clearly.
- Avoid over-specifying argument values; rely on matchers and focus on the contract.
- Use `WillOnce` and `WillRepeatedly` to define varying behaviors over multiple calls.

---

## Further Learning and References

For comprehensive exploration of GoogleMock features and idiomatic usage, please consult:

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — practical recipes for advanced mocking.
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — a beginner-friendly guide.
- [Core Matchers Reference](/api-reference/matcher-and-mocking-apis/core-matchers-reference) — detailed matcher descriptions.
- [Mock Classes and Actions](/api-reference/matcher-and-mocking-apis/mock-classes-and-actions) — API details on mocks and actions.
- Related Conceptual Pages:
  - [What is GoogleTest?](/overview/introduction-product-value/what-is-googletest)
  - [The Role of GoogleMock](/overview/introduction-product-value/googletest-and-googlemock)

Embark on enhancing your test suites with precise interaction validation and flexible mock configurations using GoogleMock’s powerful mocking and matcher features.
