---
title: "Mocking: Key Concepts"
description: "Understand critical mocking terminology: mock classes, expected calls, stubbing, matchers, actions, and cardinalities. Explore how GoogleMock structures these ideas and how they interrelate in test code."
---

# Mocking: Key Concepts

## Introduction to Mocking Terminology

In this section, you will understand the essential terminology used in GoogleMock to create, configure, and interpret mock objects. These concepts form the backbone of interaction-based testing in C++, allowing precise control and verification over how your code interacts with its dependencies.

## Mock Classes

A **mock class** is a C++ class that simulates the behavior of a real class by replacing its methods with *mock methods*. These mocked methods allow you to specify expectations (what calls you expect) and actions (what should happen when the method is called).

Mock classes are defined using the `MOCK_METHOD` macro, which declares a mock method with a specified signature inside a mock class. For example:

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, Compute, (int x, int y), (override));
};
```

This macro generates the necessary plumbing for setting expectations and actions on `Compute`.

**Key points:**

- Always put `MOCK_METHOD` declarations in the `public:` section, regardless of the original method visibility.
- You can mock overloaded methods by specifying their argument types explicitly.
- Mock classes simulate both virtual and, in some scenarios, non-virtual methods for dependency injection.

## Expected Calls (`EXPECT_CALL`)

`EXPECT_CALL` declares that a mock method **is expected** to be called with certain arguments, setting up expectations that will be verified during the test.

### Syntax and Clauses

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .Times(cardinality)
    .InSequence(sequences...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

- `.With()` restricts calls by matching all arguments as a tuple.
- `.Times()` defines how many calls are expected (e.g., `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`).
- `.InSequence()` specifies expectations in chronological order.
- `.After()` enforces that this expectation happens after other expectations.
- `.WillOnce()` specifies the action to perform on the first call(s).
- `.WillRepeatedly()` specifies the action for subsequent calls after all `.WillOnce()` actions are exhausted.
- `.RetiresOnSaturation()` indicates the expectation becomes inactive after its call limit is reached.

### Example

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::Exactly;

EXPECT_CALL(mockFoo, Compute(_,_))
    .Times(Exactly(3))
    .WillOnce(Return(10))
    .WillRepeatedly(Return(20));
```

This expects `Compute` to be called exactly 3 times, returning 10 on the first call, and 20 on subsequent calls.

## Default Behavior Specification (`ON_CALL`)

While `EXPECT_CALL` sets up expectations with verification, **`ON_CALL` only sets up default behavior** for method calls that match given arguments, without expecting the call to happen.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)
    .WillByDefault(action);
```

- `.With()` restricts which calls match this default behavior.
- `.WillByDefault()` supplies the behavior.

### Use Case

`ON_CALL` is typically used to configure default responses in mocks, allowing the test to continue without verifying every call, avoiding over-specification.

For example:

```cpp
ON_CALL(mockFoo, Compute(_, _))
    .WillByDefault(Return(42));
```

Calls to `Compute` will return `42` when no explicit expectation matches.

## Matchers

Matchers are predicates used to specify conditions on mock method arguments. They express what argument values should look like for expectations or default behaviors to apply.

- `_` matches any argument
- `Eq(value)` matches exactly equal values
- `Lt(value)`, `Ge(value)`, etc., are common relational matchers
- Matchers can also be combined using logical operators (`AllOf()`, `AnyOf()`, etc.)

## Actions

Actions specify what happens when a mock method is invoked and matched by an expectation or default behavior.

Examples include:

- `Return(value)` - returns a fixed value
- `ReturnRef(variable)` - returns a reference
- `Invoke(func)` - invokes a function or callable
- `SetArgPointee<N>(value)` - sets the value pointed to by the N-th argument
- `DoAll()` - performs multiple actions in sequence

## Cardinalities

Cardinalities specify how many times an expected call should occur in a test:

| Cardinality       | Meaning                                   |
|-------------------|-------------------------------------------|
| `AnyNumber()`     | Call any number of times                   |
| `AtLeast(n)`      | Call at least `n` times                    |
| `AtMost(n)`       | Call at most `n` times                     |
| `Between(m, n)`   | Call between `m` and `n` times (inclusive)|
| `Exactly(n)` or `n` | Call exactly `n` times                     |

If omitted, cardinality is inferred based on the presence of `WillOnce` and `WillRepeatedly` actions.

## Sequences and Partial Ordering

- **`Sequence`** objects are created to group ordered expectations.
- `InSequence` is used to assign expectations to one or more sequences, enforcing the order of calls.
- `After` clauses can impose explicit partial ordering, allowing flexible DAGs of call order.

### Example: Using Sequences

```cpp
Sequence s1, s2;
EXPECT_CALL(mockFoo, Foo())
    .InSequence(s1, s2);
EXPECT_CALL(mockBar, Bar())
    .InSequence(s1);
EXPECT_CALL(mockBar, Baz())
    .InSequence(s2);
```

Here, `Foo()` must be called before `Bar()` and `Baz()`. `Bar()` and `Baz()` may be called in any order.

## Strictness Levels of Mocks

GoogleMock supports three common mock behaviors regarding uninteresting calls (calls to mocked methods without expectations):

- **NiceMock** suppresses warnings for uninteresting calls.
- **NaggyMock** (default) warns on uninteresting calls.
- **StrictMock** treats uninteresting calls as errors.

They can be used by wrapping a mock class:

```cpp
NiceMock<MockFoo> niceMockFoo;
NaggyMock<MockFoo> naggyMockFoo;
StrictMock<MockFoo> strictMockFoo;
```

Use nice mocks to reduce noise, strict mocks to enforce tight control.

## Understanding Call Matching and Order of Expectations

- Expectations are matched in reverse order (the last suitable expectation wins).
- Calls that match no expectation but have an `ON_CALL` default action perform that action.
- Unmatched calls with no `ON_CALL` are uninteresting and raise warnings or errors based on mock strictness.

## Handling Unexpected and Excessive Calls

- **Unexpected calls:** Calls to mock methods that have expectations, but with arguments that do not match any existing expectation.
- **Excessive calls:** Calls that exceed the expected number of invocations for a given expectation.

Both result in test failures with detailed diagnostic messages indicating the mismatch.

## Practical Tips

- Use `ON_CALL` to specify default behaviors without enforcing call count constraints.
- Use `EXPECT_CALL` when you want to verify that a call happens with specific arguments and frequency.
- To allow arbitrary calls, write a catch-all expectation with `_` and `Times(AnyNumber())`.
- Use `RetiresOnSaturation()` to retire expectations when upper bound is reached.
- Use sequences to enforce strict order; use `After()` for partial ordering.
- Consider using strictness wrappers to tailor warnings and errors about uninteresting calls.

## Troubleshooting Common Issues

- Uninteresting call warnings: May indicate missing or incomplete expectations.
- Unexpected call errors: Argument matchers may not align with real call patterns.
- Saturated expectation errors: You might need `RetiresOnSaturation()` or more flexible cardinalities.
- Overlapping/multiple expectations on the same method: Order your expectations carefully; the last matching wins.

## Summary

Mastering these key mocking concepts empowers you to write tests that precisely specify and verify your system's interactions, producing clearer, more maintainable, and reliable tests.

---

For more details, see the [Mocking Reference](../reference/mocking.md) and the [gMock Cookbook](../gmock_cook_book.md).

---

### References and Further Reading

- **Mocking Reference:** https://google.github.io/googletest/reference/mocking.html
- **gMock Cookbook:** https://google.github.io/googletest/gmock_cook_book.html
- **Understanding Expectations and Call Orders** (Usage in sequences and `After` clause)
- **Mock Strictness:** NiceMock, NaggyMock, and StrictMock explained
- **Matchers Guide:** Learn how to match method arguments effectively

---

For a broader understanding of GoogleTest and GoogleMock's role, consult:

- [What is GoogleTest?](overview/product-intro-value/what-is-googletest)
- [Target Audience & Use Cases](overview/product-intro-value/who-is-this-for)
- [Mocking: Key Concepts](overview/core-concepts-terminology/concepts-mocking)
- [Mocking Reference](docs/reference/mocking.md)

---