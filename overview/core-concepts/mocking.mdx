---
title: "Mocking and GoogleMock"
description: "Learn about GoogleMock's capabilities for creating and using mock objects, specifying expectations, and verifying interactions. See how GoogleTest and GoogleMock combine to enable full isolation and granular validation in C++ code."
---

# Mocking and GoogleMock

Explore how GoogleMock extends GoogleTest by providing powerful facilities for creating mock objects, specifying expectations on method calls, controlling behavior, and verifying interactions in C++ tests. This documentation focuses on empowering developers to isolate units under test, simulate interactions with dependencies, and write precise, maintainable tests by leveraging GoogleMock’s mock framework embedded within GoogleTest.

---

## Introduction to GoogleMock

GoogleMock (gMock) is a comprehensive framework integrated with GoogleTest that enables the creation and management of mock objects in C++. It allows developers to declare mock classes easily, set fine-grained expectations on method calls, specify behaviors dynamically, and verify interactions automatically.

### Why Use GoogleMock?

- **Isolate Code Under Test:** Mocks replace real dependencies, allowing you to test your code independent of external complexity like databases, networks, or slow computations.
- **Verify Interactions:** Confirm how components interact, ensuring methods are called with correct arguments, correct sequencing, and correct frequencies.
- **Control Behavior:** Define how mock methods respond, including sequence of return values, exceptions, or callbacks.
- **Rapid Test Development:** Automated mock class generation and expressive syntax speed up writing of robust tests.

## Defining Mock Classes

Creating a mock class in GoogleMock is straightforward if you already have virtual interfaces:

1. Derive from the interface you want to mock.
2. For each virtual method, define a mock method using the `MOCK_METHOD` macro.

Example mocking an abstract `Turtle` interface for a graphics program:

```cpp
#include <gmock/gmock.h>  // Brings in GoogleMock macros and utilities.

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual void GoTo(int x, int y) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

**Tips:**

- Use parentheses around complex argument or return types containing commas.
- Mock methods must be placed in the `public:` section, even if the interface has protected or private methods.
- Mock virtual destructors to avoid undefined behavior.

## Setting Expectations with `EXPECT_CALL`

The heart of GoogleMock is the `EXPECT_CALL` macro, which specifies expectations on mock method calls. It answers:

- Which method is expected to be called?
- How many times?
- With which arguments?
- What behavior will it exhibit?
- In which order relative to other calls?

### Basic Usage

```cpp
EXPECT_CALL(mock_object, Method(matcher_for_args))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- The macro takes the mock object and method with argument matchers.
- `Times()` defines how many times the call is expected (e.g., Exactly(n), AtLeast(n), AnyNumber()).
- `WillOnce()` and `WillRepeatedly()` define the behavior for individual or repeated calls.

### Argument Matchers

Instead of specifying exact arguments, GoogleMock allows flexible matchers:

- `_`: wildcard matcher, matches any value.
- `Eq(value)`: matches if argument equals value.
- `Gt(value)`, `Lt(value)`: greater than, less than.
- Composite matchers, custom matchers, `Truly()` predicates.

### Ordering Calls

Default expectations can be met in any order. To enforce specific sequences:

- Use `InSequence` block:

  ```cpp
  {
    InSequence s;
    EXPECT_CALL(mock, Foo(1));
    EXPECT_CALL(mock, Bar(2));
  }
  ```

  This enforces `Foo(1)` before `Bar(2)`.

- Use `After()` clause to specify that an expectation must occur after others.

- Combine with `Sequence` objects for custom partial order graphs.

### Retiring Expectations

- Use `.RetiresOnSaturation()` to deactivate an expectation after it has been met, allowing other expectations to apply.

### Uninteresting vs Unexpected Calls

- **Uninteresting calls:** Method called on mock with no expectations set. These call the default action and cause a warning.
- **Unexpected calls:** Method called but does not match any expectation. This causes an error.

Mock types influence warnings:

- `NiceMock`: suppresses warnings for uninteresting calls.
- `NaggyMock` (default): warns on uninteresting calls.
- `StrictMock`: fails tests on uninteresting calls.

### Common Patterns

```cpp
using ::testing::_;
using ::testing::AnyNumber;

EXPECT_CALL(mock, Foo(_))
    .Times(AnyNumber())  // Any calls allowed
    .WillRepeatedly(Return(42));

EXPECT_CALL(mock, Bar(5))  // Specific expectation
    .Times(1)
    .WillOnce(Return(true));
```

## Defining Default Behavior with `ON_CALL`

`ON_CALL` specifies the default action of a mock method when no expectation matches. It does not set an expectation that the method will be called.

Example:

```cpp
ON_CALL(mock_object, Method(_))
    .WillByDefault(Return(default_value));
```

Key points:

- Use `ON_CALL` to set behavior shared across many tests.
- `ON_CALL` calls are overridden by matching `EXPECT_CALL`s.
- `.With()` and `.WillByDefault()` clauses configure its behavior.

## Working with Matchers and Actions

GoogleMock provides extensive matchers and actions:

- Comprehensive set of built-in [Matchers Reference](./matchers.md) including argument predicates, container matchers, tuple matchers, and user-defined custom matchers.
- Actions to control method return values, throw exceptions, invoke callbacks, set arguments, delete arguments, and chain actions.

Example of using actions:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(100))
    .WillRepeatedly(Return(42));
```

Or with a custom action:

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(Invoke([](const ArgType& arg) {
      // Custom behavior
      return DoWork(arg);
    }));
```

## Mock Classes: Nice, Naggy, and Strict

GoogleMock supports varying the strictness of mocks to control warnings/errors about uninteresting calls:

- **NiceMock<T>:** suppresses warnings on uninteresting calls.
- **NaggyMock<T>:** (default) warns on uninteresting calls.
- **StrictMock<T>:** fails test on uninteresting calls.

Use the strictness wrappers as needed to balance test robustness with noise control.

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock;
```

## Verifying Mocks and Handling Lifetimes

- Mocks automatically verify expectations upon destruction.
- For long-lived mocks, manually verify using:

```cpp
Mock::VerifyAndClearExpectations(&mock);  // Returns true if successful
```

- Suppress verification errors for leaked mocks deliberately with:

```cpp
Mock::AllowLeak(&mock);
```

## Best Practices

- **Define expectations before exercising mocks:** Setting expectations after calling the mock leads to undefined behavior.
- **Use `ON_CALL` for default behavior, `EXPECT_CALL` for strict expectations:** This results in cleaner tests with fewer brittle assertions.
- **Use sequences or `.After()` only where call order matters:** Over-specifying order can make tests fragile.
- **Prefer `NiceMock` for test stability:** While developing, use `NaggyMock` to catch unexpected calls.
- **Avoid mocking code you don't own:** If necessary, isolate with adaptors to keep tests maintainable.

## Troubleshooting Common Issues

- Unmatched calls cause immediate test failures with detailed diagnostics.
- Warnings on uninteresting calls indicate possible missing expectations or oversights.
- Use `--gmock_verbose=info` for verbose tracing of mock calls for debugging.
- Compiler errors regarding mock method macros usually arise from improper macro usage — check parentheses on types containing commas.

## Example Test Using GoogleMock

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
};

TEST(PaintingTest, DrawsCircle) {
  MockTurtle mock_turtle;

  // Set expectation: PenDown is called at least once.
  EXPECT_CALL(mock_turtle, PenDown()).Times(::testing::AtLeast(1));

  Painter painter(&mock_turtle);
  bool result = painter.DrawCircle(0, 0, 10);

  EXPECT_TRUE(result);
}
```

## Further Reading and References

- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) - Beginner-friendly tutorial.
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) - Concise reference for macros and usage.
- [Mocking Reference](../reference/mocking.md) - API reference with full macro and class listings.
- [Matchers Reference](../reference/matchers.md) - Exhaustive matcher documentation.
- [Actions Reference](../reference/actions.md) - List of built-in actions and how to customize behavior.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) - Recipes and best practices.

---

## Note on This Documentation Page

This page focuses exclusively on GoogleMock’s mocking facilities within the GoogleTest framework. To understand mocking’s place in the overall testing architecture, see the [Mocking and GoogleMock overview section](../core-concepts/mocking.md) and the higher-level [About GoogleTest](../../product-intro/about-googletest.md) introduction.

---

> *Harness the power of mock objects to write precise, maintainable, and fast C++ tests with GoogleMock.*
