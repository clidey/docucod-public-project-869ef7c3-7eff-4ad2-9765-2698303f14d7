---
title: "Breaking Changes and Migration Notes"
description: "Clearly documents any breaking changes in APIs, behavior, or platform support, along with practical instructions for adapting existing test suites. This ensures users can prepare for disruptive changes in new releases."
---

# Breaking Changes and Migration Notes

This document clearly outlines any breaking changes impacting GoogleTest and GoogleMock’s API, behavior, or supported platforms along with practical migration instructions. It is crafted to enable users to prepare their existing test suites for disruptive changes in new releases efficiently.

---

## 1. Changes to Mock Class and Method Declaration

### Modernized `MOCK_METHOD` Macro Usage

The previously used macros like `MOCK_METHODn`, `MOCK_CONST_METHODn`, and their `_WITH_CALLTYPE` variants have been superseded by a unified and more powerful `MOCK_METHOD` macro. This new macro simplifies declaring mocked methods, supports modern C++ features transparently, and provides fine control over qualifiers.

**Key migration points:**

- Replace old-style `MOCK_METHODn` macros with `MOCK_METHOD`:

  ```cpp
  // Old style
  MOCK_METHOD2(Foo, bool(int x, int y));

  // New style
  MOCK_METHOD(bool, Foo, (int x, int y));
  ```

- Include qualifiers explicitly as the optional fourth parameter:

  ```cpp
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, SetValue, (int), (noexcept, override));
  ```

- Wrap return types or argument types containing commas in additional parentheses:

  ```cpp
  MOCK_METHOD((std::pair<int, int>), GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
  ```

- Alternatively, use `using` aliases to clarify complex types.

- Always define mock methods in the `public:` section regardless of the access modifier in the base class to allow `EXPECT_CALL` and `ON_CALL` access.

### Reference:
  - [Mock Class and Method Declaration](../api-reference/mocking-apis/mock-classes.md)
  - [gMock Cookbook: Creating Mock Classes](../docs/gmock_cook_book.md#creating-mock-classes)

---

## 2. Expectation and Behavior Specification Changes

### Expectations (`EXPECT_CALL`) and Default Behaviors (`ON_CALL`)

- The semantics of `EXPECT_CALL` and `ON_CALL` remain consistent but emphasize specifying expectations *before* exercising mocks to ensure deterministic test behavior.

- The chaining order of clauses in `EXPECT_CALL` and `ON_CALL` must now strictly follow:

  - `.With()` (optional, must be first)
  - `.Times()` (optional, once per expectation)
  - `.InSequence()` (optional, any number)
  - `.After()` (optional, any number)
  - `.WillOnce()` (optional, multiple times)
  - `.WillRepeatedly()` (optional, at most once)
  - `.RetiresOnSaturation()` (optional, last clause)

Rearranging these clauses incorrectly will trigger compile-time or runtime errors.

### Cardinality Inference Rules

- If `Times()` is omitted, GoogleMock now infers the call count expectations based on the presence and count of `WillOnce` and `WillRepeatedly` clauses as follows:
  - No `WillOnce` or `WillRepeatedly` → `Times(1)`
  - `n` `WillOnce` clauses and no `WillRepeatedly` → `Times(n)`
  - `n` `WillOnce` clauses and one `WillRepeatedly` → `Times(AtLeast(n))`

This inference helps write concise expectations without explicitly specifying `Times()`.

### Sequencing and Ordering

- The concept of sequences remains, allowing partial and full ordering of expected calls.

- Use `Sequence` objects explicitly and associate expectations through `.InSequence()` or `.After()` to express call dependencies or partial order DAGs.

- The `InSequence` class remains valuable for grouping expectation declarations in strict order.

- The `.RetiresOnSaturation()` clause provides control over retiring expectations upon reaching call limits, preventing unexpected repeated matches.

### Uninteresting, Unexpected, and Excessive Calls

- By default, uninteresting calls to mock methods without expectations cause warnings but do not cause test failures.

- To suppress warnings on such calls, wrap mock objects in `NiceMock<T>`, which silences uninteresting call warnings.

- To treat uninteresting calls as errors, use `StrictMock<T>`.

- Unexpected calls (calls with unmatched arguments under existing expectations) always cause test failures.

- Beware of the matching order: expectations and default actions are matched in reverse order of declaration, allowing more specific later rules to override earlier ones.

### Reference:
  - [Defining Expectations and Call Sequences](../api-reference/mocking-apis/expectations-sequences.md)
  - [Actions, Return Values, and Invocation Control](../api-reference/mocking-apis/actions-invocations.md)
  - [Mocking with GoogleMock Guide](../guides/advanced-testing/mocking-with-googlemock.md)

---

## 3. Move-Only Types Support

### Supporting `std::unique_ptr` and Other Move-Only Types

- GoogleMock now supports methods that take or return move-only types directly via `MOCK_METHOD`, no longer requiring awkward legacy delegation workarounds.

- When returning move-only values, use lambdas or callables with `WillOnce()` or `WillRepeatedly()` that *create* the objects per invocation (rather than `Return(std::move(...))`) to avoid undefined behavior or runtime errors.

- For move-only parameters, use lambdas or functors accepting an rvalue reference or by value, and avoid built-in actions that copy arguments internally.

- Some legacy mock classes may require a temporary delegation layer.

### Reference:
  - [Mocking Methods That Use Move-Only Types](../docs/gmock_cook_book.md#mocking-methods-that-use-move-only-types)

---

## 4. Matcher and Action API Refinements

### Matchers

- The rich system of matchers remains the same with emphasis on:
  - Using polymorphic matchers appropriately to ensure type safety and expressiveness.
  - Using `SafeMatcherCast<T>(m)` when matching argument types differing slightly but safely.
  - Composing matchers with `AllOf`, `AnyOf`, `Not`, `Contains`, `ElementsAre`, and others.

- New guidelines encourage defining custom matchers using the `MATCHER` and `MATCHER_P` macros for maximum flexibility and clarity.

- Avoid matcher side-effects; all matchers must be pure functional predicates.

### Actions

- Actions continue to be specified via lambdas, function pointers, and existing action templates.

- New style polymorphic actions are encouraged via `MakePolymorphicAction()` allowing reusability across different mock methods.

- Legacy `ACTION` and `ACTION_P` macros are not recommended for new code but remain supported.

### Reference:
  - [Matchers Reference](../api-reference/matchers-assertions/core-matchers.md)
  - [Custom Matchers](../api-reference/matchers-assertions/custom-matchers.md)
  - [Actions Reference](../api-reference/mocking-apis/actions-invocations.md)

---

## 5. Verification and Clearing of Expectations

### Explicit Verification

- Although GoogleMock verifies expectations automatically when a mock object is destructed, users may now explicitly verify and clear expectations using:

  ```cpp
  testing::Mock::VerifyAndClearExpectations(&mock_obj);  // Verifies and clears expectations
  testing::Mock::VerifyAndClear(&mock_obj);               // Also clears default actions
  testing::Mock::AllowLeak(&mock_obj);                    // Declares mock leak is acceptable
  ```

- Setting new expectations after verification and clearing is prohibited and leads to undefined behavior.

- Explicit verification helps when mocks are owned or hidden by production code and may not be destructed reliably during tests.

### Reference:
  - [Verifying and Resetting a Mock](../docs/gmock_cook_book.md#forcing-a-verification)

---

## 6. Suggested Migration Steps

### Step-by-Step Migration

1. **Update `MOCK_METHOD` Usage:**
  - Refactor all old-style `MOCK_METHODn` usages to the modern `MOCK_METHOD` syntax.
  - Make sure to use parentheses around types involving commas.

2. **Refactor Expectation Clauses:**
  - Verify the correct order and multiplicity of clauses in `EXPECT_CALL` and `ON_CALL`.
  - If necessary, adjust to follow the prescribed clause order.

3. **Address Move-Only Types:**
  - Replace legacy delegation mock methods for move-only arguments and return types with direct use of `MOCK_METHOD`.
  - Use lambdas for returning new objects on each call when mocking move-only-returning methods.

4. **Adjust Strictness Policies:**
  - Decide whether to wrap mocks with `NiceMock` or `StrictMock` to control uninteresting call warnings or failures.
  - Prefer `NiceMock` during development and `StrictMock` only where strict validation is critical.

5. **Leverage Default Values and Behaviors:**
  - Move default behaviors out of expectations and into `ON_CALL` where possible.
  - Use `DefaultValue<T>::Set()` sparingly for global default return values.

6. **Use Explicit Verification When Needed:**
  - Add calls to `Mock::VerifyAndClearExpectations()` or `Mock::VerifyAndClear()` in tests where mock destruction timing is uncertain.

7. **Test Thoroughly and Run With Verbose Flags:**
  - Run tests with `--gmock_verbose=info` to trace mock function call matching and diagnose migration gaps.

---

## 7. Known Limitations and Warnings

- `NiceMock` and `StrictMock` only modify the behavior of uninteresting calls on mock methods defined directly using `MOCK_METHOD` in the mock class, not in base classes.

- Mock methods defined in base classes may not get correct strictness behavior due to C++ limitations.

- Destructors cannot be mocked directly; use the recommended pattern of defining a `Die()` mock method called from the destructor for verifying destruction order.

- Some built-in actions are not yet fully compatible with move-only types; favor lambdas or custom polymorphic actions in such cases.

- Expectation ordering and matching rules require careful attention to avoid brittle or failing tests.

---

## 8. Additional References

- [Mocking with GoogleMock Guide](../guides/advanced-testing/mocking-with-googlemock.md) — for detailed guidance on mocking and expectation rules.

- [Matchers Reference](../api-reference/matchers-assertions/core-matchers.md) — comprehensive list and usage of built-in matchers.

- [Actions Reference](../api-reference/mocking-apis/actions-invocations.md) — detailed explanation of available actions and custom definitions.

- [gMock Cookbook](../docs/gmock_cook_book.md) — practical recipes, examples, and patterns.

- [gMock for Dummies](../docs/gmock_for_dummies.md) — an introductory tutorial.

- [Legacy gMock FAQ](../docs/gmock_faq.md) — details of older issues and solutions.

- [Configuration Basics](../getting_started/essentials_setup/configuration_basics.md) — controlling mock strictness and defaults.

---

For comprehensive upgrade paths and best practices, consult the **Upgrade Paths and Best Practices** and **Deprecation and Removal Notices** pages in the Upgrade and Migration Guidance group.

---

_Last Updated: Version 1.13.0 and later releases_
