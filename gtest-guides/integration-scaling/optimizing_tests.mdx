---
title: "Optimizing Test Performance"
description: "Strategies to speed up test execution: parallelism, selective running, leak detection, and performance monitoring. Make the most of your testing cycles."
---

# Optimizing Test Performance

GoogleMock provides powerful features to optimize the performance of your test suites by managing how mock expectations and behaviors are declared and executed. This guide focuses specifically on strategies you can apply during your test development to speed up test execution by leveraging parallelism, selective test running, leak detection, and performance monitoring.

---

## 1. Understanding Performance Optimization in gMock

Testing speed can dramatically impact your development workflow and CI/CD pipeline efficiency. GoogleMock gives you tools not only for functional verification but also for controlling and monitoring how tests run internally.

### What You Will Learn Here

- How to use different mock strictness modes to balance verification and performance.
- Techniques to selectively run tests to save time.
- Detect and handle resource leaks efficiently.
- Utilize verbosity and monitoring flags to identify performance bottlenecks.

---

## 2. Prerequisites

Before you start optimizing test performance:

- Ensure you have your tests written using GoogleMock with expectations set via `EXPECT_CALL` and default behaviors via `ON_CALL`.
- Your mocks should be properly defined using `MOCK_METHOD` macros.
- Basic familiarity with running tests and reading GoogleTest outputs.

---

## 3. Strategies to Speed Up Test Execution

### 3.1. Mock Object Strictness Modes

GoogleMock offers three primary mock strictness modes which affect how uninteresting calls (calls without expectations) are handled:

| Mode        | Behavior Summary                                              | Use Case                                          |
|-------------|---------------------------------------------------------------|--------------------------------------------------|
| `NiceMock`  | Suppresses warnings for uninteresting calls.                  | Use when you want faster, less noisy tests and don't care if some calls are unverified.
| `NaggyMock` | Default: warns on uninteresting calls but allows them.        | Useful for identifying unexpected calls during development.
| `StrictMock`| Treats uninteresting calls as errors; enforces exact behavior.| Best for enforcing strict call contracts, but can slow down tests.

**How to Use:**

```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock;      // Ignores uninteresting calls
NaggyMock<MockFoo> naggy_mock;    // Warns on uninteresting calls
StrictMock<MockFoo> strict_mock;  // Fails on uninteresting calls
```

**Recommendation:** Use `NiceMock` for faster tests where you don’t need strict verification. Reserve `StrictMock` for critical tests where every call must be tracked.

<Note>
If your mock class has non-virtual destructors or inherited mocks, some strictness modes may not fully apply. Always verify behavior.
</Note>

---

### 3.2. Selective Test Running

GoogleTest provides facilities to run only a subset of tests, which significantly reduces test suite run time when working on focused change sets.

- **Filter Tests:** Use `--gtest_filter` to specify which tests to run.

  ```sh
  ./my_test_binary --gtest_filter=MyTestSuite.*
  ./my_test_binary --gtest_filter=-FlakyTest.* # Exclude flaky tests
  ```

- **Death Tests and Disabled Tests:** Skip expensive tests by disabling them or conditionally excluding with filters.

**Benefit:** You save resources by not running unrelated or expensive tests unnecessarily.

---

### 3.3. Leak Detection and Management

Memory and resource leaks can slow down testing by increasing memory and resource consumption, leading to system thrashing.

- GoogleMock integrates with GoogleTest’s heap checker which detects leaks from mocks.
- Use `Mock::AllowLeak()` when you deliberately want to leak a mock to prevent heap-check failures, for example when mocks are owned by production code.

```cpp
Mock::AllowLeak(&my_mock);
```

- Use test environment tools and proper mock object lifecycle management to ensure leaks do not persist across tests.

**Tip:** Use heap checkers to catch leaks early and avoid their impact on later tests.

---

### 3.4. Verbosity and Performance Monitoring

GoogleMock includes a verbosity flag (`--gmock_verbose`) controlling the logging level of mock calls. This is useful for performance profiling and troubleshooting.

| Level   | Description                                    | Use Case                         |
|---------|------------------------------------------------|---------------------------------|
| `info`  | Logs all informational messages, warnings, errors, and stack traces on mock calls. | Use during intense debugging, but will slow tests.
| `warning` | Logs warnings and errors (default).         | Balanced for normal developer feedback.
| `error` | Logs errors only, minimal output.               | Use for fastest test execution with minimal logging.

Enable or change verbosity at runtime:
```cpp
::testing::FLAGS_gmock_verbose = "error";
```

Be cautious of high verbosity in continuous runs – it can increase test time.

---

## 4. Best Practices for Test Performance

- **Minimize `EXPECT_CALL` Usage:** Only verify necessary calls to reduce overhead.
- **Use `ON_CALL` for Default Behavior:** Define default actions to avoid verbose expectations for unimportant calls.
- **Use `NiceMock` When Appropriate:** Save time by suppressing warnings on unimportant calls.
- **Run Tests in Parallel:** While GoogleTest supports parallel test running via build systems or test runners, GoogleMock itself is thread-safe. Design your tests and mocks to run in parallel safely.
- **Avoid Excessive Mocking of Complex Methods:** Mock only the interactions you need to verify; complex logic might be better tested with integration tests.

---

## 5. Troubleshooting Common Issues

<AccordionGroup title="Troubleshooting Test Performance">
<Accordion title="Unintentional Slowdowns Due to Strict Mocking">
If your tests are slow, check if you are using `StrictMock` unnecessarily or using too many `EXPECT_CALL`. Switch to `NiceMock` or reduce expectation counts.
</Accordion>
<Accordion title="Verbose Logging Slowing Tests">
The `--gmock_verbose=info` mode produces detailed logs that slow down execution. Switch to `warning` or `error` levels during regular runs.
</Accordion>
<Accordion title="Memory Leaks Affecting Performance">
Leaks may cause test slowdowns. Use `Mock::AllowLeak()` if appropriate, or fix leaks by proper ownership management.
</Accordion>
<Accordion title="Tests Not Running as Expected Due to Filters">
Ensure you are specifying correct `--gtest_filter`. Use `--gtest_help` for guidance.
</Accordion>
</AccordionGroup>

---

## 6. Next Steps

- Implement `NiceMock` or `StrictMock` as per your test's need to balance speed and verification rigor.
- Explore GoogleTest [`--gtest_filter`](https://github.com/google/googletest/blob/main/docs/reference/running-tests.md#gtest-flags) to run subsets of tests.
- Integrate test runs into CI/CD pipelines with parallel execution to distribute test load.
- Visit the [Effective Mocking Patterns](https://google.github.io/googletest/gtest-guides/intermediate-patterns/mocking_patterns.html) guide for advanced usage.
- Use GoogleTest's [debugging and profiling flags](https://github.com/google/googletest/blob/main/docs/reference/running-tests.md) to analyze test performance further.

---

## 7. References and Resources

- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Mock Object Strictness Modes](https://google.github.io/googletest/reference/mocking-apis/strictness-modes.html)
- [Using and Composing Matchers](https://google.github.io/googletest/reference/mocking-apis/using-matchers.html)
- [Actions and Side Effects](https://google.github.io/googletest/reference/mocking-apis/actions-and-side-effects.html)

---

## 8. Example: Using NiceMock for Faster Tests

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
  virtual ~Foo() = default;
  virtual void DoThis() = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(void, DoThis, (), (override));
};

TEST(FooTest, Example) {
  using ::testing::NiceMock;

  NiceMock<MockFoo> foo;

  // Only explicitly expect important calls, other calls ignored.
  EXPECT_CALL(foo, DoThis());

  foo.DoThis();  // No warning even if other methods called
}
```

This reduces overhead by eliminating warnings on unexpected calls.
