---
title: "Adding Mocks to Your Tests"
description: "Dive into the basics of GoogleMock: how and when to use mocks, setting up expectations, and simulating behaviors to isolate components. Includes real use cases and minimal runnable examples."
---

# Adding Mocks to Your Tests

## Overview

This guide introduces how to add mocks using GoogleMock (gMock) in your tests. It explains when and why to use mocks, how to define mock classes with mocked methods, set expectations, and simulate behavior of dependencies, helping you isolate components and test interactions effectively. Real-world examples and minimal code snippets are included to make you productive quickly.

---

## Prerequisites

- A working installation of GoogleTest and GoogleMock integrated into your build system.
- Basic familiarity with C++ unit testing concepts.
- Knowledge of virtual functions and interfaces in C++.


## What You Will Achieve

- Define mock classes using `MOCK_METHOD` macros.
- Use `EXPECT_CALL` and `ON_CALL` to set expectations and default behaviors.
- Control return values, argument matching, and call cardinality.
- Handle advanced scenarios like mocking overloaded and const methods.

## Estimated Time

30 minutes for a basic test with mocks; more time for complex mock setups.

## Difficulty Level

Beginner to Intermediate

---

## 1. Defining Your Mock Classes

Mocks simulate interfaces by overriding virtual methods with mock implementations.

### 1.1 Basic Mock Class Definition

To mock a class or an interface, inherit and mock its virtual methods using the macro:

```cpp
#include <gmock/gmock.h>

class MockInterface : public Interface {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
};
```

Example:

```cpp
class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};
```

### 1.2 Dealing with Commas in Types

If your return type or argument types contain commas (e.g., templates), surround them with parentheses or use a `using` alias:

```cpp
class MockExample {
 public:
  MOCK_METHOD((std::pair<int, int>), GetPair, ());
  using MapType = std::map<int, double>;
  MOCK_METHOD(bool, CheckMap, (MapType, bool));
};
```

### 1.3 Mocking Overloaded and Const Methods

For overloaded or const methods, mock each overload explicitly:

```cpp
MOCK_METHOD(int, GetValue, (), (const, override));
MOCK_METHOD(int, GetValue, (int type), (override));
```

Use `Const()` when setting expectations on const-qualified mock methods:

```cpp
EXPECT_CALL(Const(mock), GetValue());
```

### 1.4 Mocking Class Templates

Template classes can be mocked similarly:

```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

### 1.5 Access Permissions

Always place `MOCK_METHOD` declarations in the `public:` section of your mock class, even if the base methods are protected or private. This ensures testing macros can access the methods.

---

## 2. Using Mock Objects in Tests

### 2.1 Typical Workflow

1. Import the necessary gMock symbols, usually by adding `using ::testing::...`.
2. Create mock objects.
3. Optionally, set default behaviors with `ON_CALL`.
4. Set specific expectations with `EXPECT_CALL`.
5. Exercise the code under test that uses the mocks.
6. Verification happens automatically when mock objects are destructed.

Example:

```cpp
using ::testing::Return;
using ::testing::_;

TEST(FooTest, Example) {
  MockFoo foo;  // Step 2

  ON_CALL(foo, GetSize())            // Step 3: default action
      .WillByDefault(Return(3));

  EXPECT_CALL(foo, Describe("test"))  // Step 4: expectations
      .Times(1)
      .WillOnce(Return("Mocked Description"));

  // Step 5: exercise code
  EXPECT_EQ(foo.GetSize(), 3);
  EXPECT_EQ(foo.Describe("test"), "Mocked Description");
}
```

### 2.2 ON_CALL vs EXPECT_CALL

- **ON_CALL:** Sets default behavior for mock methods but does not require calls.
- **EXPECT_CALL:** Not only sets behavior but also asserts the method call occurs with matching arguments and call count.

Use `ON_CALL` for general default behavior shared across tests, and `EXPECT_CALL` to verify specific calls.

### 2.3 Argument Matching

Use matchers to specify expected method arguments:

- Exact values (e.g., `5`, `"abc"`)
- Wildcard matcher `_` for any argument
- Built-in matchers like `Gt(5)` for greater than 5

Example:

```cpp
EXPECT_CALL(mock, DoSomething(Gt(10), _));
```

### 2.4 Cardinalities (`Times`)

Specify how many times you expect a method call:

- `Exactly(n)` or `Times(n)` — exactly n calls
- `AtLeast(n)`, `AtMost(n)`, `Between(m, n)`, `AnyNumber()`

If omitted, gMock infers call counts based on actions specified.

### 2.5 Actions: Controlling Method Behavior

Define what happens when the mock method is called with `WillOnce()`, `WillRepeatedly()`, and the default action with `WillByDefault()`.

Common actions include:

- `Return(value)` — returns value
- `ReturnRef(reference)` — returns reference
- `Invoke(function)` — invoke a callable
- `DoAll(...)` — perform multiple actions in order

Example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

---

## 3. Advanced Patterns and Tips

### 3.1 Handling Overloaded Functions

Disambiguate overloads using signature casts or `Const()` wrapper:

```cpp
EXPECT_CALL(mock, Func(An<int>()));
EXPECT_CALL(Const(mock), Func(5));
```

### 3.2 Sequences and Order

Use `InSequence` or `Sequence` objects to enforce call order:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
```

Or use multiple sequences with `.InSequence(s1, s2)` to form partial orders.

### 3.3 Retiring Expectations

Use `.RetiresOnSaturation()` on an expectation to make it inactive after it reaches the call count. Useful to allow fallback expectations.

### 3.4 Nice, Naggy, and Strict Mocks

Choose the strictness level for mock objects handling uninteresting calls:

- `NiceMock<T>` — suppress warnings on uninteresting calls
- `NaggyMock<T>` — warns (default behavior)
- `StrictMock<T>` — treats uninteresting calls as failures

### 3.5 Delegating to Real or Fake Objects

You can delegate calls to a real implementation or a fake for default behavior:

```cpp
ON_CALL(mock, Method).WillByDefault([this](Args... args) {
  return real_.Method(args...);
});
```

### 3.6 Mocking Methods with Move-Only Types

Support for `std::unique_ptr` and other move-only types is available using regular `MOCK_METHOD`. Use lambdas for actions producing new objects:

```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](auto text) {
      return std::make_unique<Buzz>(...);
    });
```

### 3.7 Using Lambdas, Functors, or Functions as Actions

You can specify arbitrary callable objects for behaviors:

```cpp
EXPECT_CALL(mock, DoSomething(_))
    .WillOnce([](int arg) { return arg * 2; });
```

### 3.8 Using `InvokeArgument` and `InvokeWithoutArgs`

For invoking callbacks passed as arguments or ignoring arguments:

```cpp
EXPECT_CALL(mock, Start(_, _))
    .WillOnce(InvokeArgument<1>(42));  // Calls the 2nd argument as a function
```

### 3.9 Tips for Managing Complex Expectations

- Use `.With()` to match multiple arguments as a tuple.
- Use `SaveArg<N>` to capture argument values for later verification.
- Use `DoAll()` to perform multiple actions on a single call.

---

## 4. Common Pitfalls and Troubleshooting

### 4.1 Expectations Must Be Set Before Use

Set `EXPECT_CALL` before calling the methods on the mock. Setting expectations after using mocks leads to undefined behavior.

### 4.2 Uninteresting vs Unexpected Calls

- *Uninteresting*: no expectation set; allowed by default but warns.
- *Unexpected*: expectations set but call doesn't match; test failure.

Mitigate warnings on uninteresting calls via `NiceMock` or adding catch-all `EXPECT_CALL(...).Times(AnyNumber())`.

### 4.3 Over-saturation Errors

Calls exceeding the expected times cause immediate failures unless `.RetiresOnSaturation()` is used to deactivate expectations after use.

### 4.4 Debugging Mock Match Failures

Enable verbose flag `--gmock_verbose=info` to trace matching attempts and understand why calls don’t match.

### 4.5 Mock Object Lifetime

Mock objects verify expectations upon destruction. If leaked, verification won’t happen. Use `Mock::AllowLeak(mock)` to suppress leakage warnings if intentional.

---

## 5. Minimal Example Putting It All Together

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;
using ::testing::Return;
using ::testing::_;

// Interface to mock
class Service {
 public:
  virtual ~Service() = default;
  virtual int Compute(int x) = 0;
  virtual std::string Name() const = 0;
};

// Mock class
class MockService : public Service {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));
  MOCK_METHOD(std::string, Name, (), (const, override));
};

TEST(ServiceTest, Example) {
  MockService mock;

  ON_CALL(mock, Compute(_))
      .WillByDefault(Return(10));  // Default behavior

  EXPECT_CALL(mock, Name())
      .Times(1)
      .WillOnce(Return("MockService"));

  EXPECT_EQ(mock.Compute(5), 10);      // Uses default action
  EXPECT_EQ(mock.Name(), "MockService");  // Uses expectation
}
```

---

## 6. Further Reading and Next Steps

- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md): Advanced usage and recipes
- [Matchers Reference](https://github.com/google/googletest/blob/main/docs/reference/matchers.md): Deep dive into argument matching
- [Actions Reference](https://github.com/google/googletest/blob/main/docs/reference/actions.md): Built-in actions and how to write custom actions
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md): Detailed API of mocking facilities
- [Writing Your First Test](https://github.com/google/googletest/blob/main/gtest-guides/getting-started/write_first_test.mdx): Getting started with GoogleTest

---

<Tip>
Always set your expectations before exercising the mock to ensure correct verification and avoid undefined behavior.
</Tip>

<Note>
Consider using `NiceMock` to automatically suppress irrelevant warnings during early test development.
</Note>

<Warning>
Mock objects require all virtual functions to have a virtual destructor for proper cleanup and heap checking.
</Warning>

---

This page focuses strictly on adding mocks and working with mocked methods in tests using GoogleMock. For broader test structure and running tests, please refer to the related GoogleTest guides.
