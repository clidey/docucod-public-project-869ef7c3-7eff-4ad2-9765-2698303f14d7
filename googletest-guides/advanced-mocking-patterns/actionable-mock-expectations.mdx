---
title: "Working with Matchers, Actions, and Cardinalities"
description: "Hands-on guide to setting advanced expectations in GoogleMock: using matchers for argument matching, actions for simulating responses, and cardinalities for controlling the number of expected calls. Includes real-world scenarios and best practices."
---

# Working with Matchers, Actions, and Cardinalities

GoogleMock lets you precisely control and verify how mock methods behave and how they are expected to be called. This guide delivers a hands-on workflow for setting advanced expectations using **Matchers** to match arguments, **Actions** to define behaviors, and **Cardinalities** to specify the number of expected calls.

---

## 1. Understanding the Workflow

### What You'll Achieve
This guide teaches you how to **set powerful, flexible expectations** on mock methods by combining:
- **Matchers:** Specify argument patterns for function calls.
- **Actions:** Define what your mocks do when called (e.g., return values, side effects).
- **Cardinalities:** Control how many times a method is expected to be called.

By mastering these concepts, you gain full command over interaction verification in your tests.

### Prerequisites
- Basic familiarity with GoogleMock and C++ testing.
- A mock class with mocked methods declared using `MOCK_METHOD`.
- Include `<gmock/gmock.h>` in your test files.

### Expected Outcome
- Able to write `EXPECT_CALL` statements with sophisticated argument matching.
- Specify method behaviors with `WillOnce()`, `WillRepeatedly()`, and custom actions.
- Control call expectations with cardinalities like `Times(Exactly(n))`, `AtLeast(n)`, and more.
- Utilize sequences and orderings through `InSequence()` and `After()`.

### Estimated Time
10-20 minutes to digest and apply the examples.

### Difficulty Level
Intermediate - requires some basic GoogleMock knowledge.

---

## 2. Setting Argument Matchers

### Why Use Matchers?
You rarely want to verify exact argument values for every call. Matchers let you express flexible patterns, e.g., "any value", "greater than 10", "non-null pointers", or even custom predicates.

### Basic Examples
```cpp
using ::testing::_;        // Matches any value
using ::testing::Gt;       // Greater than
using ::testing::StrEq;    // String equality

EXPECT_CALL(mock_obj, Method(5));          // Exactly 5
EXPECT_CALL(mock_obj, Method(_));          // Any argument
EXPECT_CALL(mock_obj, Method(Gt(10)));     // Argument > 10
EXPECT_CALL(mock_obj, Method(StrEq("abc")));  // String "abc"
```

### Combining Matchers
Matchers can be combined logically:
```cpp
using ::testing::AllOf;
using ::testing::Not;

EXPECT_CALL(mock_obj, Method(AllOf(Gt(10), Not(15)))); // >10 and !=15
```

### Matching Multiple Arguments Together
If your mock method has multiple arguments and you want to check relations among arguments (e.g., first less than second), use `.With()` and multi-argument matchers:
```cpp
using ::testing::Lt;
EXPECT_CALL(mock_obj, SetPosition(_, _))
    .With(Lt());  // first arg < second arg
```

### Practical Tips
- Use `_` to indicate "any value" when arguments aren't important.
- Match only the arguments your test cares about.
- Define **custom matchers** if your logic is complex (see [MATCHER macro](https://google.github.io/googletest/gmock_cook_book.html#writing-new-matchers)).

---

## 3. Defining Actions for Mock Methods

### What Are Actions?
Actions specify what happens when your mock method gets called with matching arguments. For example, returning a value, modifying an output parameter, throwing exceptions, or invoking a callback.

### Common Built-in Actions
```cpp
using ::testing::Return;
using ::testing::ReturnRef;
using ::testing::SetArgPointee;
using ::testing::DoAll;

EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42));  // Returns 42 once

int flag = 0;
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));  // Sets arg1 to 5, returns true
```

### Action Variants
- `WillOnce(action)`: Defines behavior for the *next* matching call.
- `WillRepeatedly(action)`: Defines default behavior for calls after `WillOnce` actions.

Example:
```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

### Using Lambdas and Callables
If built-in actions don’t fit your needs, define custom behavior:
```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce([](int x) { return x * 2; });
```

### Invoking Callbacks or Arguments
You can invoke function or callback parameters:
```cpp
using ::testing::InvokeArgument;

EXPECT_CALL(mock, RegisterCallback(_))
    .WillOnce(InvokeArgument<0>(42));  // Invokes 0th argument with 42
```

### Tips & Best Practices
- Chain side-effect actions with `DoAll()`.
- Use `ReturnRef()` when returning references.
- Use `Invoke()` to call existing functions or methods.

---

## 4. Controlling Call Cardinalities

### What Is Cardinality?
Cardinality controls how many times you expect a mock method call to happen. This is expressed using the `.Times()` clause in `EXPECT_CALL` statements.

### Built-In Cardinalities
| Cardinality       | Meaning
| ----------------- | -------------------------------------------------
| `Exactly(n)` or `Times(n)` | Expect the call exactly `n` times.
| `AtLeast(n)`      | At least `n` calls.
| `AtMost(n)`       | At most `n` calls.
| `Between(m, n)`   | Between `m` and `n` calls (inclusive).
| `AnyNumber()`     | Any number of calls (0 or more).

### Examples
```cpp
EXPECT_CALL(mock, Foo()).Times(Exactly(3));
EXPECT_CALL(mock, Bar(_)).Times(AtLeast(1));
EXPECT_CALL(mock, Baz(5)).Times(AnyNumber());
```

### Cardinality Inference Rules
If you omit `.Times()`, GoogleMock infers the expected number of calls:
- No `WillOnce()` or `WillRepeatedly()`: expects single call.
- N `WillOnce()` and no `WillRepeatedly()`: expects exactly N calls.
- N `WillOnce()` and `WillRepeatedly()`: expects at least N calls.

### Disallowing Calls
To assert a method is **never** called:
```cpp
EXPECT_CALL(mock, ForbiddenMethod(_)).Times(0);
```

### Handling Call Overruns
Sometimes you want to retire expectations after saturation with `.RetiresOnSaturation()` to avoid sticky expectations that cause failures after exceeding call counts.

### Cardinality Best Practices
- Use precise cardinalities to catch unexpected call counts.
- Use `AnyNumber()` sparingly when you are sure calls don't matter.
- Combine with sequences and order constraints for complex control.

---

## 5. Managing Call Order and Sequences

GoogleMock offers powerful ways to express strict or partial ordering of expected calls.

### `InSequence`
Wrap your expectations in an `InSequence` object to enforce that the calls occur strictly in the order specified:
```cpp
{
  InSequence s;

  EXPECT_CALL(mock, Init());
  EXPECT_CALL(mock, Run());
  EXPECT_CALL(mock, Cleanup());
}
```

### `Sequence` Objects and `.InSequence()` Clause
When managing complex orderings, use `Sequence` objects and attach expectations to them:
```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Init()).InSequence(s1);
EXPECT_CALL(mock, Run()).InSequence(s1, s2);
EXPECT_CALL(mock, Cleanup()).InSequence(s2);
```
This expresses that `Init` happens before `Run` and `Run` happens before `Cleanup`, but `Init` and `Cleanup` may run in any relative order with respect to calls outside these sequences.

### `.After()` Clause
Use `.After()` to specify that a call happens after other expectation(s):
```cpp
Expectation init = EXPECT_CALL(mock, Initialize());
EXPECT_CALL(mock, Execute()).After(init);
```

### Best Practices
- Use sequences to enforce strict order when implementation contract requires it.
- Use `.After()` for partial ordering dependencies.
- Avoid over-constraining call order to keep tests maintainable.

---

## 6. Putting It All Together: A Real-World Scenario

Imagine you are testing a `MockDatabase` interface:

```cpp
class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (const std::string&));
  MOCK_METHOD(int, Query, (const std::string&));
  MOCK_METHOD(void, Disconnect, ());
};
```

### Expectation Example
```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::Exactly;
using ::testing::InSequence;

TEST(DatabaseTest, QuerySequence) {
  MockDatabase mock_db;
  {
    InSequence seq;

    EXPECT_CALL(mock_db, Connect("localhost"))
        .Times(Exactly(1))
        .WillOnce(Return(true));

    EXPECT_CALL(mock_db, Query(_))
        .Times(AtLeast(1))
        .WillRepeatedly(Return(42));

    EXPECT_CALL(mock_db, Disconnect())
        .Times(Exactly(1));
  }

  // Code under test that calls Connect, Query, Disconnect in order
  MyDatabaseUser user(&mock_db);
  user.RunQueries();
}
```

This example:
- Matches exact arguments on `Connect`.
- Accepts any query string on `Query`, returning `42` every time.
- Enforces call order using `InSequence`.
- Controls call counts with cardinalities.

### Action Chaining & Side-Effects Example
```cpp
EXPECT_CALL(mock_db, Query(_))
    .WillOnce(DoAll(
         SetArgPointee<0>(100),   // Assume output param index 0
         Return(1)));            // Return 1
```

---

## 7. Troubleshooting & Best Practices

### Common Issues
- **Uninteresting calls warning:** If mock method calls occur without `EXPECT_CALL`, gMock warns unless a `NiceMock` is used.
- **Too few or too many calls:** Make sure `.Times()` matches expected usage.
- **Mismatch in argument matching:** Use verbose mode `--gmock_verbose=info` to debug which expectations are matched.
- **Order violations:** Use `InSequence` or `After` to fix ordering problems.

### Tips
- Prefer `ON_CALL` for setting default behavior without imposing expectations.
- Use `EXPECT_CALL` only when you want to verify calls.
- Retire saturated expectations with `.RetiresOnSaturation()` to avoid sticky failures.

### Performance
- Limit number of expectations and sequences for faster test execution.
- Group related expectations logically.

### Alternatives & Extensions
- Define **custom matchers** and **custom actions** for tailored checking and mocking.
- Use **NiceMock**, **StrictMock**, or **NaggyMock** wrappers to control how uninteresting calls are handled.

---

## 8. Next Steps & Related Content

- Explore the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) for detailed API.
- Read the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for recipes on mocking patterns.
- Study [Using Death Tests](https://google.github.io/googletest/gmock_death_tests.html) to test error handling.
- Learn about [Nice, Strict, and Naggy Mocks](https://google.github.io/googletest/gmock_cook_book.html#the-nice-the-strict-and-the-naggy) for managing call expectations.
- Deepen understanding of [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) and [Actions Reference](https://google.github.io/googletest/reference/actions.html).

---

## 9. Reference Links

- GoogleMock official docs: https://google.github.io/googletest/gmock.html
- Matchers Reference: https://google.github.io/googletest/reference/matchers.html
- Actions Reference: https://google.github.io/googletest/reference/actions.html
- Cardinalities and Expectations: https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL.Times

---

## 10. Summary

By skillfully combining **Matchers**, **Actions**, and **Cardinalities**, you can write robust, maintainable, and expressive tests that clearly define how your mocks should behave and interact with the code under test. Use ordering constraints and default behaviors for more complex or real-world scenarios, and lean on GoogleMock’s rich library and extensibility features to cover all your testing needs.


---

<Callout title="Tip">
Always set your `EXPECT_CALL` expectations before exercising the code under test to ensure proper verification.
</Callout>

<Callout title="Warning">
Avoid over-specifying expectations, which can lead to brittle tests that break on harmless internal changes.
</Callout>

---