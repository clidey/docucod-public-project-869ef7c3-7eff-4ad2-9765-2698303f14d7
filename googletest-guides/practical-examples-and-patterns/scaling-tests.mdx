---
title: "Scaling Your Test Suite and Optimizing Performance"
description: "Patterns and techniques for organizing, filtering, and running large test suites efficiently. Learn about running tests in parallel, test sharding, and strategies for keeping test cycles fast as your codebase grows."
---

# Scaling Your Test Suite and Optimizing Performance

## Overview

As your codebase grows and your test suite expands to hundreds or thousands of tests, managing test execution efficiently becomes increasingly critical. This guide provides practical patterns and techniques to organize, filter, and run large test suites without compromising test cycle speed. You'll learn how to leverage parallel test execution, test sharding, and filtering strategies to keep your test infrastructure scalable and performant.

---

## 1. Workflow Overview

### What This Guide Helps You Achieve

This guide helps you:
- Structure large test suites for efficient execution.
- Run tests in parallel to reduce overall test run time.
- Use test sharding to distribute test execution across machines.
- Apply filtering techniques to run only relevant subsets of tests.

### Prerequisites

- You have a GoogleTest test suite with multiple tests defined.
- Basic familiarity with running tests using `RUN_ALL_TESTS()`.
- Access to environment variables or CI infrastructure for configuring test runs.

### Expected Outcome

After following this guide, you will be able to:
- Dramatically reduce test turnaround times.
- Confidently execute subsets of tests tailored to your development workflow.
- Scale test runs across multiple machines or processors.

### Time Estimate

Depending on your environment:
- Simple filtering configurations: 5-10 minutes.
- Parallel execution setup: 30-60 minutes (may vary by infrastructure).
- Test sharding across CI machines: hours to days, depending on complexity.

### Difficulty Level

Intermediate: Requires some knowledge of environment configuration and test execution commands.

---

## 2. Strategies for Scaling and Optimizing Test Suites

### 2.1 Organizing Large Test Suites

GoogleTest encourages grouping related tests in **test suites** to organize tests logically. However, when test suites become large, it’s important to: 

- Keep tests independent for parallel execution.
- Use **test fixtures** with shared, immutable data where possible to reduce setup overhead.
- Avoid extremely large individual test files that define thousands of tests (see stack footprint considerations).

Refer to [Basic Configuration](../getting-started/initial-configuration-validation/basic-configuration.md) for initial setup best practices.

### 2.2 Filtering Tests: Running Subsets Efficiently

GoogleTest supports powerful filtering via the `--gtest_filter` flag or `GTEST_FILTER` environment variable, allowing you to run only the tests you need:

```bash
./your_test_executable --gtest_filter=TestSuiteName.TestName
```

Filters accept wildcards and negative patterns, enabling complex selections:

- `FooTest.*` runs all tests in `FooTest`.
- `*Critical*` runs all tests with 'Critical' in their full name.
- `*-Flaky*` excludes all tests with 'Flaky'.

**Tips:**
- Use filtering during development to expedite iterations.
- Combine with repeated runs using `--gtest_repeat` to catch flaky tests.

See [Running a Subset of the Tests](../advanced.md#running-a-subset-of-the-tests) for full filtering syntax.

### 2.3 Running Tests in Parallel

**Parallel test execution** reduces test run time by leveraging multiple CPU cores or machines. Although GoogleTest by itself does not provide built-in parallelism, it supports running tests on subsets selected via filters or sharding environment variables to enable parallelism at the infrastructure layer.

Common approaches include:

- Splitting tests into groups manually or by test suite.
- Using scripts or CI runners that execute subsets in parallel.

**Best Practices:**

- Ensure tests are independent and do not share mutable global state.
- Isolate side effects to avoid race conditions.

### 2.4 Test Sharding

GoogleTest explicitly supports **test sharding** to distribute tests across multiple machines or processes.

**How to shard tests:**

1. Determine the total number of shards (`GTEST_TOTAL_SHARDS`).
2. Assign each shard an index (`GTEST_SHARD_INDEX`), zero-based.
3. Run the same test executable on each shard machine, setting these environment variables accordingly.

GoogleTest automatically selects a unique subset of tests for each shard so that all tests run exactly once across shards.

Example:

```bash
export GTEST_TOTAL_SHARDS=3
export GTEST_SHARD_INDEX=0
./your_test_executable
```

Repeat for other indices `1`, `2` on different machines or jobs.

> Note: You must run the exact same binary with the shard environment variables configured correctly.

### 2.5 Keeping Test Cycles Fast as Code Grows

- Use **test fixtures' `SetUpTestSuite()`** and **`TearDownTestSuite()`** for expensive setup done once per suite, not per test.
- Avoid unnecessary global state, and keep tests isolated.
- Keep tests small and focused to minimize run time and improve parallelism.
- Use **disabled** or **skipped** tests (`DISABLED_` prefix or `GTEST_SKIP()`) to exclude flaky or incomplete tests while working on them.

---

## 3. Step-by-Step Instructions

### Running a Subset of Tests Using Filtering

<Steps>
<Step title="Launch with a filter">
Run your test binary specifying `--gtest_filter` with the desired pattern.
```bash
./my_tests --gtest_filter=FooTest.*
```

<Check>Only tests in `FooTest` run.</Check>
</Step>
<Step title="Use multiple filters">
Use colon `:` separated patterns to include multiple suites or tests.
```bash
./my_tests --gtest_filter=FooTest.*:BarTest.Baz
```

<Check>Test suite `FooTest` entirely plus `BarTest.Baz` test run.</Check>
</Step>
<Step title="Exclude tests">
Add `-` followed by patterns to exclude tests.
```bash
./my_tests --gtest_filter=FooTest.*-FooTest.FlakyTest
```

<Check>Runs all `FooTest` except `FlakyTest`.</Check>
</Step>
</Steps>

### Setting Up Test Sharding

<Steps>
<Step title="Identify total shards">
Determine how many shards (machines/processes) you want to split your tests into.

<Info>Sharding works best with tens or more tests for balanced distribution.</Info>
</Step>
<Step title="Export sharding environment variables">
For each shard, set:

```bash
export GTEST_TOTAL_SHARDS=N
export GTEST_SHARD_INDEX=I
```

where `N` is total shards and `I` is shard index (0 ≤ I < N).

Example for the first shard:

```bash
export GTEST_TOTAL_SHARDS=4
export GTEST_SHARD_INDEX=0
```

</Step>
<Step title="Run the test executable on each shard">
On each machine or job, run the exact same GoogleTest binary with these environment variables set.

<Check>Each shard will run its assigned subset of tests.</Check>
</Step>
<Step title="Aggregate results after shards complete">
Collect logs or test XML reports from all shards.

Use your CI system or scripts to combine or analyze the full test results.
</Step>
</Steps>

### Using Test Fixtures for Shared Setup

<Steps>
<Step title="Declare static shared resources in your test fixture">
Inside your test fixture class derived from `testing::Test`, declare static variables for shared expensive resources.

```cpp
class MyTest : public testing::Test {
 protected:
  static Resource* shared_resource_;
  static void SetUpTestSuite() {
    shared_resource_ = new Resource(...);
  }
  static void TearDownTestSuite() {
    delete shared_resource_;
    shared_resource_ = nullptr;
  }
};
```

</Step>
<Step title="Access shared resources in tests">
Within your `TEST_F` tests, access the static shared resource.

```cpp
TEST_F(MyTest, Example) {
  ASSERT_NE(shared_resource_, nullptr);
  EXPECT_TRUE(shared_resource_->IsReady());
}
```
</Step>
</Steps>

---

## 4. Examples

### Example: Running Tests with Filtering

Run only tests in `FactorialTest`:

```bash
./my_test_binary --gtest_filter=FactorialTest.*
```

Exclude flaky tests from running:

```bash
./my_test_binary --gtest_filter=* -FLakyTest.*
```

### Example: Sharding Test Runs Across 2 Machines

Machine 1:

```bash
export GTEST_TOTAL_SHARDS=2
export GTEST_SHARD_INDEX=0
./my_test_binary
```

Machine 2:

```bash
export GTEST_TOTAL_SHARDS=2
export GTEST_SHARD_INDEX=1
./my_test_binary
```

Each runs half the tests and together covers all tests exactly once.


---

## 5. Troubleshooting & Tips

### Common Issues

- **Tests Not Running as Expected:** Ensure filtering patterns are correct and that no conflicting environment variable settings exist.
- **Uneven Test Distribution in Shards:** Some tests may take much longer than others causing imbalance. To address this, group tests by expected run time.
- **Parallel Execution Failures:** Ensure that tests do not share mutable global state or resources without proper synchronization.
- **Sharding Variables Not Respected:** Double-check environment variables are exported correctly before running the test binary.

### Best Practices

- Use `DISABLED_` prefix to temporarily disable flaky or unstable tests.
- Annotate tests with recorded properties using `RecordProperty()` to aid in reporting.
- Use `SetUpTestSuite()` and `TearDownTestSuite()` for high-cost shared resource initialization.
- Prefer filtering and sharding combined with parallel infrastructure (e.g., CI runners) for maximum speed.

### Performance Considerations

- Running tests concurrently requires thread-safe and isolated tests. GoogleTest itself is thread-safe and supports concurrent assertions.
- Be cautious with fixtures that maintain state between tests as they can limit parallelism.

---

## 6. Next Steps & Related Resources

- **Writing and Running Your First Test**: [Guide](../../getting-started/initial-configuration-validation/writing-first-test.md)
- **Filtering & Running Subsets of Tests**: [Advanced Guide](../../advanced.md#running-a-subset-of-the-tests)
- **Test Fixtures and Shared Setup**: [Primer](../../primer.md#same-data-multiple-tests)
- **Test Sharding and Parallel Execution**: See [Advanced GoogleTest Topics](../../advanced.md#running-tests-in-parallel-and-sharding)
- **Integrating with CI Systems**: [CI Integration Guide](../practical-examples-and-patterns/ci-integration.md)

For deeper exploration of test design and organization, see the [Basic Configuration](../../getting-started/initial-configuration-validation/basic-configuration.md) and [Advanced GoogleTest Topics](../../advanced.md) documentation.

---