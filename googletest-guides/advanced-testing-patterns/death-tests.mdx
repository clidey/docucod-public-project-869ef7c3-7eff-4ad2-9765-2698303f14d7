---
title: "Death Tests and Exception Assertions"
description: "Guides users through testing for program death, crashes, and exception-throwing code with GoogleTest and GoogleMock. Includes step-by-step examples and strategies for reliable testing of error-handling and boundary conditions."
---

# Death Tests and Exception Assertions

This guide helps you effectively write and manage *death tests* and *exception assertions* using GoogleTest and GoogleMock. These tests verify that certain code paths cause program termination (crashes or exits) or throw exceptions as expected, enabling reliable testing of error-handling and boundary conditions in your C++ code.

---

## 1. Understanding Death Tests and Exception Assertions

### What This Guide Helps You Accomplish
- Verify that code terminates in a controlled manner under specific error conditions.
- Test code that throws or does not throw exceptions explicitly.
- Use GoogleTest macros for writing death tests and exception assertions with clear expectations.

### Prerequisites
- A working GoogleTest and GoogleMock installation.
- Basic familiarity with writing tests using `TEST` or `TEST_F` macros.
- C++ environment with exception support enabled for exception assertions.

### Expected Outcome
By following this guide, you'll be comfortable writing death tests and exception assertions, understand how GoogleTest executes them, handle common pitfalls, and leverage advanced features like death test styles and scoped traces.

### Estimated Time
Approximately 20-30 minutes to read through and practice writing your first death and exception tests.

### Difficulty Level
Intermediate â€” assumes knowledge of GoogleTest basics.

---

## 2. Writing Death Tests

Death tests verify that some code path causes your program to terminate, typically due to fatal errors, such as assertion violations or aborts.

### Key Assertions for Death Tests

- `ASSERT_DEATH(statement, matcher)`
- `EXPECT_DEATH(statement, matcher)`
- `ASSERT_DEATH_IF_SUPPORTED(statement, matcher)`
- `EXPECT_DEATH_IF_SUPPORTED(statement, matcher)`
- `ASSERT_DEBUG_DEATH(statement, matcher)`
- `EXPECT_DEBUG_DEATH(statement, matcher)`
- `ASSERT_EXIT(statement, predicate, matcher)`
- `EXPECT_EXIT(statement, predicate, matcher)`

> **Note:**
> - Death tests run the `statement` in a subprocess.
> - `matcher` checks if the subprocess stderr output matches a pattern (usually a regex).
> - `predicate` checks exit status in `ASSERT_EXIT` / `EXPECT_EXIT`.

### Writing a Simple Death Test

```cpp
TEST(MyDeathTest, TerminatesOnInvalidInput) {
  ASSERT_DEATH({
    // This code should terminate (e.g., via abort).
    AbortIfInvalid(-1);
  }, "Invalid argument");  // Matches stderr regex
}
```

### Using Compound Statements

Death test statements can be compound blocks:

```cpp
EXPECT_DEATH({
  int val = -5;
  ProcessValue(val);
}, "must be positive");
```

### Using `ASSERT_EXIT`/`EXPECT_EXIT`

When you also want to verify the exit code:

```cpp
EXPECT_EXIT(NormalExitFunction(), testing::ExitedWithCode(0), "Success");
EXPECT_EXIT(FatalSignalFunction(), testing::KilledBySignal(SIGABRT), "Abort");
```

### Death Test Styles

Death tests can be run in either:

- **Fast style:** The death test logic runs immediately after forking.
- **Threadsafe style:** The test binary is re-executed to isolate the death test.

You can control the style globally via:

```cpp
GTEST_FLAG_SET(death_test_style, "threadsafe");
```

or on the command line with `--gtest_death_test_style=threadsafe`.

> Use `"threadsafe"` if your tests start multiple threads or fork-unsafety is a concern.

### Best Practices for Death Tests

- Name test suites containing death tests with the suffix `DeathTest` (e.g., `FooDeathTest`).
- Death tests should not include `ASSERT_` macros inside `statement` that cause early returns.
- Avoid heap deallocations inside death tests or allow leaks for mocks if necessary.
- Use `SCOPED_TRACE` to add context where death test assertions fail deep in helper functions.

---

## 3. Writing Exception Assertions

GoogleTest provides assertions for verifying exception throwing behavior. Exception support must be enabled in your build.

### Key Macros for Exception Assertions

- `EXPECT_THROW(statement, exception_type)`
- `ASSERT_THROW(statement, exception_type)`
- `EXPECT_NO_THROW(statement)`
- `ASSERT_NO_THROW(statement)`
- `EXPECT_ANY_THROW(statement)`
- `ASSERT_ANY_THROW(statement)`

### Usage Examples

Verify a function throws a specific exception:

```cpp
EXPECT_THROW(FunctionThatFails(), std::runtime_error);
```

Verify a function throws any exception:

```cpp
ASSERT_ANY_THROW(FunctionThatFails());
```

Verify a function does not throw any exception:

```cpp
ASSERT_NO_THROW(FunctionThatSucceeds());
```

### Tips for Exception Assertions

- The statement can be compound (multiple lines enclosed in `{}`).
- Exception assertions catch exceptions and report failures; if an exception escapes, the test framework flags an error.
- Check exception messages inside caught exceptions separately if needed.

---

## 4. Propagating Fatal Failures and Adding Context

### Handling Fatal Failures in Subroutines

Fatal failures (`ASSERT_*`, `FAIL()`) abort the current function only. To propagate failures or abort the whole test if a subroutine fails:

#### Option 1: Check `HasFatalFailure()` and return early

```cpp
void Subroutine() {
  ASSERT_EQ(1, Compute());
}

TEST(MyTest, UsesSubroutine) {
  Subroutine();
  if (HasFatalFailure()) return;  // Abort if fatal failure detected
  // Continue only if no fatal failure
}
```

#### Option 2: Use `ASSERT_NO_FATAL_FAILURE()` or `EXPECT_NO_FATAL_FAILURE()` to verify the subroutine doesn't fail

```cpp
EXPECT_NO_FATAL_FAILURE(Subroutine());
```

#### Option 3: Throw and catch exceptions with a special listener (advanced)

---

### Adding Trace Information for Failures

Use `SCOPED_TRACE()` to add custom context to failure messages from deep within helper functions or loops:

```cpp
SCOPED_TRACE("Iteration " << i);
EXPECT_EQ(expected, actual);
```

This adds trace messages to help identify which iteration or call caused failure.

---

## 5. Troubleshooting Common Death Test and Exception Assertion Issues

### Death Test Fails to Detect Termination
- Ensure the `statement` actually causes process death (abort, exit) or signal termination.
- Confirm `matcher` correctly matches the expected error output.
- If using `ASSERT_DEATH`, ensure no code after it assumes normal continuation.

### Death Test Run with Multiple Threads Warning
- Death tests use `fork()` which is unsafe with multiple active threads.
- Use `death_test_style=threadsafe` to re-execute the binary in the child.
- Alternatively, structure your tests to avoid multiple threads before the death test.

### Exceptions Escaping Death Tests
- When exceptions escape death tests, GoogleTest reports this as a failure.
- Catch exceptions within death tests if required or disable exception catching with `--gtest_catch_exceptions=0`.

### Non-Void Functions and Fatal Assertions
- Fatal assertions (`ASSERT_*`) can only be used in functions returning `void`.
- For functions with a return type, prefer non-fatal assertions (`EXPECT_*`) or refactor.

### Multiple Death Tests on Same Line
- Place each death test on its own source line to avoid macro expansion issues.

---

## 6. Examples and Real-World Scenarios

### Death Test with a Global Function

```cpp
void CauseCrash() {
  abort();
}

TEST(CrashTest, AbortsAsExpected) {
  EXPECT_DEATH(CauseCrash(), "");
}
```

### Death Test Using Member Function

```cpp
class Foo {
 public:
  void MustDie() { abort(); }
};

TEST(FooDeathTest, MemberFunctionDies) {
  Foo foo;
  ASSERT_DEATH(foo.MustDie(), "");
}
```

### Exception Assertion with Compound Statement

```cpp
TEST(ExceptionTest, ThrowsRuntimeError) {
  EXPECT_THROW({
    throw std::runtime_error("fail");
  }, std::runtime_error);
}
```

### Using `EXPECT_EXIT` to Check Exit Code

```cpp
void ExitWithSuccess() { exit(0); }

TEST(ExitTest, ExitsSuccessfully) {
  EXPECT_EXIT(ExitWithSuccess(), ::testing::ExitedWithCode(0), "");
}
```

---

## 7. Next Steps & Further Resources

- Explore the [Writing and Using Assertions](../googletest-guides/core-workflows/writing-assertions.md) guide for more on assertions.
- Review [Mocking Basics](../googletest-guides/core-workflows/mocking-basics.md) to complement error handling tests.
- Consult [Troubleshooting Common Setup Errors](../getting-started/troubleshooting-common-issues/troubleshooting-setup-errors.md) if you encounter environment issues.
- For complex error message matching, see the [Matchers Reference](docs/reference/assertions.md#EXPECT_THAT).
- Use community resources and the [Getting Help & Community](../getting-started/troubleshooting-common-issues/getting-help-community.md) page for collaborative support.

---

If you need practice with complete examples, check out the sample tests in the GoogleTest repository under the `googletest/test` folder, especially `googletest-death-test_test.cc`.

---

<Tip>
Remember: Death tests spin up subprocesses and may increase test run time significantly. Use them selectively and with well-crafted matchers to avoid false positives or flaky tests.
</Tip>

<Tip>
Use `SCOPED_TRACE` generously inside helper functions called from death tests to get informative context in failure reports.
</Tip>

<Tip>
Set `--gtest_catch_exceptions=0` when debugging tests to let exceptions propagate to your debugger.
</Tip>

---

