---
title: "Introduction to Mocking with GoogleMock"
description: "A guided tour of mocking with GoogleMock, covering how to create mock classes, set expectations, and verify interactions in your tests. Lays the foundation for behavior-driven testing by introducing core mocking concepts and practical test cases."
---

# Introduction to Mocking with GoogleMock

## Workflow Overview

### Task Description
This guide walks you through the essential concepts and practical steps of mocking using GoogleMock. It focuses on creating mock classes, setting up expectations on mock methods, defining default behaviors, and verifying interactions to enable behavior-driven testing. This foundation will help you design robust, interaction-focused unit tests that validate how your code interacts with its dependencies.

### Prerequisites
- Familiarity with C++ and its class inheritance, especially virtual functions.
- GoogleMock included in your project (`#include <gmock/gmock.h>`).
- Basic understanding of unit testing concepts.

### Expected Outcome
By the end of this guide, you will be able to:
- Define mock classes for your interfaces or classes.
- Write and arrange expectations for mock method calls.
- Specify default behaviors and custom actions.
- Utilize sequences and ordering for call verification.
- Handle nuanced scenarios such as overloaded methods and move-only types.

### Time Estimate
Approximately 20-30 minutes to digest the concepts and try examples.

### Difficulty Level
Beginner to Intermediate

---

## Step-by-Step Instructions

### 1. Creating a Mock Class

- Derive a mock class from the interface or base class you want to mock.
- Use the `MOCK_METHOD` macro inside the `public:` section to define mock methods.
- If the base method is `const`, `noexcept`, or has special qualifiers, add them in the 4th parameter of `MOCK_METHOD` as a comma-separated list inside parentheses.

```cpp
#include <gmock/gmock.h>

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

- **Tip:** Wrap complex return types or argument types with parentheses if they contain commas.

### 2. Setting Expectations on Mock Methods

- Use `EXPECT_CALL(mock_object, Method(matchers))` before exercising the code under test.
- Matchers specify expected argument patterns; use `_` to match anything.
- Typical cardinalities include `Times(1)`, `AtLeast(n)`, `AnyNumber()`, etc.
- Chain actions like `WillOnce(Return(value))` and `WillRepeatedly(Return(value))` to define mock behavior.

```cpp
using ::testing::Return;
using ::testing::_;

MockTurtle turtle;
EXPECT_CALL(turtle, Forward(100))
    .Times(1);
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(10))
    .WillRepeatedly(Return(0));

// Code under test uses turtle...
```

- **Note:** Always set expectations before the mock method is called.

### 3. Defining Default Behavior with ON_CALL

- Use `ON_CALL(mock_object, Method(matchers))` to specify default actions used when no explicit `EXPECT_CALL` matches.
- `ON_CALL` does *not* impose call count expectations.

```cpp
ON_CALL(turtle, GetX())
    .WillByDefault(Return(5));
```

- The last matching `ON_CALL` takes precedence.

### 4. Controlling Expectation Order and Sequences

- By default, expectations can be satisfied in any order.
- Use the `InSequence` scope or `.InSequence(sequences...)` clause to require specific call ordering.

```cpp
using ::testing::InSequence;

{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

- For partial orders, define `Sequence` objects and assign expectations to them.

### 5. Advanced Clauses for EXPECT_CALL

- `.With(multi_argument_matcher)` to match all arguments together.
- `.After(expectations...)` to specify that an expectation occurs after others.
- `.RetiresOnSaturation()` to deactivate an expectation once saturated.

### 6. Verifying and Resetting Mocks

- Mocks automatically verify expectations upon destruction.
- To verify manually, use `::testing::Mock::VerifyAndClearExpectations(&mock_obj);`
- Avoid adding expectations after verification or calling mock methods after a mock is destroyed.

### 7. Handling Special Cases

- **Mocking Overloads:** Mock each overload explicitly; use `Const()` wrapper for const overloads.
- **Move-only Types:** Use `MOCK_METHOD` normally; specify return actions with lambdas for move-only return values.
- **Delegating to Fakes or Real Objects:** Use `ON_CALL` with lambdas to forward calls.
- **Mocking Non-virtual Methods:** Mock classes can mock non-virtual methods but require compile-time polymorphism.

---

## Examples & Code Samples

### Basic Mock Class and Test

```cpp
class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};

TEST(FooTest, BasicExpectations) {
  MockFoo foo;

  ON_CALL(foo, GetSize()).WillByDefault(Return(10));
  EXPECT_CALL(foo, Describe("test")).Times(1).WillOnce(Return("desc"));

  EXPECT_EQ(10, foo.GetSize());
  EXPECT_EQ("desc", foo.Describe("test"));
}
```

### Using Sequences

```cpp
using ::testing::Sequence;

Sequence s1, s2;
EXPECT_CALL(foo, Reset()).InSequence(s1, s2);
EXPECT_CALL(foo, GetSize()).InSequence(s1);
EXPECT_CALL(foo, Describe()).InSequence(s2);
```

### Handling Complex Return Types

```cpp
using BoolIntPair = std::pair<bool, int>;
class MockComplex {
 public:
  MOCK_METHOD((BoolIntPair), GetPair, (), (override));
};
```

### Move-only Type Mocking

```cpp
class Buzz {};
class MockBuzzer {
 public:
  MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (std::string), (override));
};

TEST(BuzzerTest, ReturnUniquePtr) {
  MockBuzzer mock;
  EXPECT_CALL(mock, MakeBuzz("hello"))
      .WillOnce([](std::string) {
        return std::make_unique<Buzz>();
      });

  auto result = mock.MakeBuzz("hello");
  ASSERT_NE(result, nullptr);
}
```

### Delegating Calls to a Fake Underlying Object

```cpp
class FakeFoo : public Foo {
 public:
  int GetSize() const override { return 42; }
  std::string Describe(const char* name) override { return "fake"; }
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));

  void DelegateToFake() {
    ON_CALL(*this, GetSize()).WillByDefault([this]() { return fake_.GetSize(); });
    ON_CALL(*this, Describe(::testing::_))
        .WillByDefault([this](const char* n) { return fake_.Describe(n); });
  }

 private:
  FakeFoo fake_;
};
```

---

## Troubleshooting & Tips

### Common Issues

- **Expectation Omission:** Setting expectations after mock method calls leads to undefined behavior. Always set before use.
- **Uninteresting vs Unexpected Calls:** Uninteresting calls (no expectation set) cause warnings; unexpected calls (no matching expectation among set ones) cause errors.
- **Over-saturating Calls:** Calling a method more times than specified leads to failures or warnings.
- **Mocking Non-virtual Methods:** Not supported directly; consider dependency injection or `MockFunction` alternatives.
- **Compiler Errors on Const Parameters:** Remove top-level `const` in parameter declarations if MSVC warns.

### Best Practices

- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Use `StrictMock<T>` to make uninteresting calls fail, useful for very strict tests.
- Use `RetiresOnSaturation()` with multiple `WillOnce()` clauses to have expectations retire once fulfilled.
- Avoid over-specifying argument matchers; use `_` for arguments not relevant to the test.
- Use sequences for controlling complex call ordering.
- Use proper default actions with `ON_CALL` to avoid uninteresting call warnings.

### Performance Considerations

- Define mock classes in headers and implement constructors/destructors in `.cc` files to improve build times.
- Avoid excessive and redundant mock method definitions that slow compilation.

### Alternative Approaches

- Use `MockFunction<F>` to mock standalone function types or callbacks.
- Implement custom actions or matchers for advanced behavior verification.

---

## Next Steps & Related Content

- Proceed to **Writing and Using Assertions** to verify values returned or side-effects in tests.
- Explore **Mastering GoogleMock: Patterns and Pitfalls** for advanced mocking techniques.
- Review **Mock Method Macros** and **EXPECT_CALL and ON_CALL** pages for in-depth API reference.
- Consult **gMock Cookbook** for practical recipes and examples.
- For integrations, see **Integrating with Build Systems** and **Supported Platforms**.
- If you encounter setup issues, consult the **Troubleshooting Common Setup Errors** guide.

---

For complete API details and examples, visit the [GoogleMock Reference](https://google.github.io/googletest/gmock_ref.html), [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html), and the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html).

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "docs/gmock_cheat_sheet.md", "range": "1-"}, {"path": "docs/gmock_for_dummies.md", "range": "1-"}, {"path": "docs/reference/mocking.md", "range": "1-"}, {"path": "docs/gmock_cook_book.md", "range": "1-"}]} />
