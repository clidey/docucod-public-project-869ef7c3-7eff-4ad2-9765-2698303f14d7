---
title: "Expectations, Actions, Cardinalities, and Matchers"
description: "Guides users through setting expectations on mock calls, specifying actions for mocks, constraining call frequencies, and composing rich matchers for arguments and behaviors."
---

# Expectations, Actions, Cardinalities, and Matchers

This guide walks you through the essentials of specifying expectations on mock method calls, defining actions for mocks, constraining how often calls occur, and composing powerful matchers to verify arguments and behaviors in GoogleMock.

---

## 1. Overview

### What You'll Achieve
This page empowers you to precisely control and verify the interactions between your code and mock objects. You will learn how to:

- Set **expectations** using `EXPECT_CALL` to define which mock methods should be called, with what arguments, and how frequently.
- Specify **default behaviors** using `ON_CALL` for calls that do not have explicit expectations.
- Use **matchers** to describe argument constraints flexibly.
- Constrain the **cardinality**, i.e., how many times a function should be called.
- Combine matchers and actions for rich test scenarios.

### Prerequisites
- Familiarity with writing mock classes using `MOCK_METHOD` (see [Mocking Basics](../advanced-mocking/mocking-basics))
- Basic knowledge of GoogleTest and unit testing concepts

### Expected Outcome
You will be able to craft clear, maintainable, and effective mock expectations and behaviors, catching interaction bugs and designing robust tests with GoogleMock.

### Time Estimate
15–30 minutes to read and practice examples.

### Difficulty Level
Intermediate: Comfortable with C++ and unit testing, now focusing on interaction verification.

---

## 2. Setting Expectations on Mock Calls

An *expectation* declares that a particular mock method should be called with arguments matching certain criteria.

### Syntax and Structure
Use the `EXPECT_CALL()` macro:

```cpp
EXPECT_CALL(mock_object, Method(arg_matchers...))
    .With(multi_argument_matcher)  // Optional
    .Times(cardinality)            // Optional
    .InSequence(sequences...)      // Optional
    .After(expectations...)        // Optional
    .WillOnce(action)              // Optional, can be repeated
    .WillRepeatedly(action)        // Optional, once
    .RetiresOnSaturation();        // Optional, once
```

- `EXPECT_CALL` declares an expectation on a method call.
- `arg_matchers...` specify constraints on each argument.
- The chained clauses refine the expectation.

### Example: Expecting Calls With Specific Arguments

```cpp
using ::testing::Return;
using ::testing::_;

EXPECT_CALL(turtle, Forward(100))  // Expects Forward called with 100.
    .Times(1)                      // Exactly once.
    .WillOnce(Return());           // Perform default action (void).

EXPECT_CALL(turtle, GoTo(50, _))  // First argument must be 50, second any.
    .Times(AnyNumber());           // Any number of times.
```

> The last matching `EXPECT_CALL` takes precedence, allowing you to define catch-all expectations.

### Best Practice
- Set expectations **before** exercising your test code.
- Use `_` matcher when argument value doesn't matter.

---

## 3. Defining Default Behaviors with ON_CALL

While expectations verify that calls happen, `ON_CALL()` lets you specify what should happen when a mock method is invoked without requiring that it is called.

```cpp
ON_CALL(mock_object, Method(arg_matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);
```

- Use `ON_CALL` for common default actions, e.g., returning default values or simulating simple behaviors.
- `ON_CALL` specifications apply when no matching `EXPECT_CALL` exists.

### Example

```cpp
ON_CALL(turtle, GetX())
    .WillByDefault(Return(0));  // By default, GetX returns 0.

EXPECT_CALL(turtle, GetX())
    .Times(3)
    .WillOnce(Return(10))
    .WillRepeatedly(Return(20));
```

The mock's `GetX()` will return 10 for the first call, then 20 on subsequent calls, overriding the `ON_CALL`.

### Tip
- Use `ON_CALL` for setup in test fixtures for shared default behaviors.

---

## 4. Using Matchers to Specify Argument Constraints

Matchers define the rules for what argument values are accepted by expectations or default actions.

### Common Matchers
- `_` — Matches any argument.
- `Eq(value)` — Matches equal to `value`.
- `Ge(value)` — Matches greater or equal.
- `Lt(value)` — Matches less than.

### Example

```cpp
EXPECT_CALL(foo, Bar(Ge(5), _));  // First argument greater or equal 5, second any.
```

### Complex Matchers
- Combine with `AllOf()`, `AnyOf()`, `Not()`, etc.
- Use custom predicates using `Truly()`.
- Match tuples of arguments via `.With(multi_arg_matcher)`

### Matching Multiple Arguments as a Whole

Use `.With()` to match all arguments as one tuple. For example, requiring the first argument to be less than the second:

```cpp
EXPECT_CALL(my_mock, SetPosition(_, _))
    .With(Lt());  // 'Lt()' matches tuple where first < second.
```

Refer to the [Matchers Reference](../reference/core-assertions-macros/gmock-matchers) for exhaustive matcher capabilities.

---

## 5. Controlling Call Frequencies with Cardinalities

Cardinalities specify how many times a mock method is expected to be called.

### Available Cardinalities

| Cardinality    | Meaning                                                        |
| -------------- | -------------------------------------------------------------- |
| `AnyNumber()`  | Called any number of times                                      |
| `AtLeast(n)`   | Called at least `n` times                                       |
| `AtMost(n)`    | Called at most `n` times                                        |
| `Between(m,n)` | Called between `m` and `n` times (inclusive)                    |
| `Exactly(n)`   | Called exactly `n` times (if `n` is 0, then never called)      |

### Example

```cpp
EXPECT_CALL(mock, Func(_))
    .Times(AtLeast(2)); // Expect at least two calls
```

### Default Cardinality Inference

If `.Times()` is omitted, GoogleMock infers it:
- No `.WillOnce()` or `.WillRepeatedly()`: `Times(1)`
- N `.WillOnce()` clauses and no `.WillRepeatedly()`: `Times(n)`
- N `.WillOnce()` clauses and one `.WillRepeatedly()`: `Times(AtLeast(n))`

### Handling Cardinality Violations
- Calling more times than allowed leads to failure.
- Calling fewer times than the lower bound leads to failure when mock is verified (usually at destruction).

### Tips
- Use a combination of `Times()` and `WillOnce()/WillRepeatedly()` for detailed control.
- To forbid calls, use `Times(0)`.

---

## 6. Specifying Actions: What Should the Mock Do?

Actions define the behavior of a mock when a method is called.

### Common Actions
- `Return(value)` — Returns the given value.
- `ReturnRef(variable)` — Returns a reference to the given variable.
- `ReturnPointee(pointer)` — Returns value pointed to by pointer.
- `Invoke(function)` — Calls a function/lambda.
- `SetArgPointee<N>(value)` — Sets the N-th argument's pointee to `value`.
- `DoAll(action1, action2, ..., actionN)` — Performs multiple actions sequentially.

### Specifying Actions in Expectations

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(Return(10))
    .WillRepeatedly(Return(5));
```

- `WillOnce()`: Actions for single calls (can chain multiple, executed in order).
- `WillRepeatedly()`: Action for all subsequent calls after `WillOnce()` actions exhausted.

### Specifying Actions in ON_CALL

```cpp
ON_CALL(mock, Foo(_))
    .WillByDefault(Return(0));
```

This action is used if no matching `EXPECT_CALL` is found.

### Tips
- Avoid side effects inside actions that are evaluated at expectation setup time.
- Use lambdas or functors for complex behaviors.

---

## 7. Sequencing and Ordering Calls

By default, expectations can be matched in any order. To specify order:

### Using `InSequence` Class

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

Ensures that `FirstCall` occurs before `SecondCall`.

### Using `.InSequence()` Clause

You can assign an expectation to one or more sequences:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Foo())    .InSequence(s1);
EXPECT_CALL(mock, Bar())    .InSequence(s1, s2);
EXPECT_CALL(mock, Baz())    .InSequence(s2);
```

### Using `.After()` Clause

Expresses that an expectation happens after specified expectations:

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, DoStuff()).After(e1);
```

---

## 8. Using Rich Matchers for Arguments

Matchers provide expressive constraints on arguments and can be composed extensively:

- Match member variables: `Field(&Class::member, matcher)`
- Match properties (getter methods): `Property(&Class::method, matcher)`
- Pointee matcher to validate pointed-to values: `Pointee(matcher)`
- Combine matchers: `AllOf()`, `AnyOf()`, `Not()`
- Use predicates with `Truly()` to specify arbitrary conditions

Example:

```cpp
EXPECT_CALL(mock, Process(Data(Truly([](const Data& d) { return d.IsValid(); }))));
```

---

## 9. Controlling Expectation Retirement

Expectations normally remain active even if saturated, leading to "sticky" expectations.

- Use `.RetiresOnSaturation()` to deactivate (retire) an expectation once it is saturated.
- Expectations in sequences retire automatically once later expectations are satisfied.

Example:

```cpp
EXPECT_CALL(mock, Foo()).Times(3).RetiresOnSaturation();
```

Allows exactly 3 calls to `Foo()`, after which this expectation stops matching calls.

---

## 10. Verifying and Resetting Mocks

- Expectations are verified automatically when mock objects are destructed.
- You can force verification earlier with:

```cpp
Mock::VerifyAndClearExpectations(mock_ptr);
```

- To clear both default actions set by `ON_CALL` and expectations:

```cpp
Mock::VerifyAndClear(mock_ptr);
```

- Use `Mock::AllowLeak(mock_ptr);` if you intend to deliberately leak a mock and skip verification.

**Warning:** Do not add new expectations after verification of a mock has occurred.

---

## 11. Troubleshooting Common Issues

- Calling a mock method more times than specified will produce a failure reporting exceeded cardinality.
- Missing expected calls cause test failures during verification.
- Incorrect argument matching leads to unexpected call errors — check your matchers.
- Overly strict expectations make tests brittle; consider relaxing constraints or using `.RetiresOnSaturation()`.
- For uninteresting calls, consider using `NiceMock` if warnings are noisy.

---

## 12. Examples

### Example: Expecting Ordered Calls With Return Values

```cpp
using ::testing::Return;
using ::testing::InSequence;

MockTurtle turtle;

{
  InSequence s;
  EXPECT_CALL(turtle, PenDown())
      .Times(1);
  EXPECT_CALL(turtle, Forward(100))
      .Times(1)
      .WillOnce(Return());
  EXPECT_CALL(turtle, PenUp())
      .Times(1);
}

// will fail if calls happen out of order.

// Exercise code that triggers calls...
```

### Example: Using Matchers with Cardinality and Actions

```cpp
using ::testing::AtLeast;
using ::testing::_;
using ::testing::Return;

EXPECT_CALL(foo, GetValue(Ge(10)))
    .Times(AtLeast(2))
    .WillRepeatedly(Return(42));

EXPECT_CALL(foo, GetValue(lt(10)))
    .Times(AnyNumber())
    .WillRepeatedly(Return(0));
```

---

## 13. Related Content & Next Steps

- **Mocking Basics: Creating and Using Mocks**: Learn how to create and use mock classes.
- **Matchers in GoogleTest and GoogleMock**: Detailed explanations and variety of matchers.
- **Actions and Expectations Reference**: Comprehensive details on actions and expectation syntax.
- **Mocking Policies and Behaviors: Nice, Strict, and Naggy**: How different mocks handle uninteresting calls.

For detailed syntax and more examples, see the GoogleMock [Expectations](../reference/mocking.md) API reference.

---

## References
- [GoogleMock Cheat Sheet](docs/gmock_cheat_sheet.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [Mocking Reference](docs/reference/mocking.md)
- [Matchers Reference](docs/reference/core-assertions-macros/gmock-matchers.md)

---