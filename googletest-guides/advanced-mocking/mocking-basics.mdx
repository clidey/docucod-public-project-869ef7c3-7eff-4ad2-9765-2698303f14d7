---
title: "Mocking Basics: Creating and Using Mocks"
description: "Explains how to define, implement, and use mocks in test code using GoogleMock. Provides real-world patterns for mocking interfaces and controlling dependencies in modular systems."
---

# Mocking Basics: Creating and Using Mocks

## Overview

This guide explains how to define, implement, and use mock classes effectively in your test code using GoogleMock (gMock). It focuses specifically on creating mock classes, setting expectations and behaviors, and achieving better control over your unit tests by mocking dependencies through interfaces or classes.

By following these principles and examples, you will be able to isolate components, simulate interactions, and validate code under test without relying on concrete implementations.

---

## Prerequisites
- Have your C++ environment set up with gMock included (usually by including `<gmock/gmock.h>`).
- Understand basic C++ virtual functions and inheritance.
- Familiarity with test frameworks like GoogleTest will help.

---

## Expected Outcome
After completing this guide, you will:
- Know how to create mock classes from interfaces or abstract base classes.
- Understand how to mock methods, including overloaded and template methods.
- Learn to set default behaviors and specific expectations in tests.
- Be aware of best practices and how to avoid common pitfalls when working with mocks.

## Time Estimate
Approximately 20-30 minutes to read, understand, and create your first mock classes with examples.

## Difficulty Level
Beginner to Intermediate


---

## Creating Mock Classes

In gMock, creating a mock class involves deriving from your interface or abstract base class and declaring mock methods for each virtual method you intend to mock.

### Step 1: Define Your Interface
Your interface class should have virtual methods (usually abstract) and a **virtual destructor** to ensure proper cleanup.

```cpp
class Foo {
 public:
  virtual ~Foo();  // Must be virtual
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
  virtual bool Process(int elem, int count) = 0;
};
```

> **Important:** The virtual destructor is essential. Without it, deleting derived mock objects through a base pointer can cause undefined behavior.

### Step 2: Define the Mock Class Using MOCK_METHOD
Derive a class from your interface and use the `MOCK_METHOD` macro to define mock methods.

The macro syntax is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Params...), (Qualifiers));
```

Example:

```cpp
#include <gmock/gmock.h>

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(bool, Process, (int elem, int count), (override));
};
```

- Specify qualifiers like `const`, `override`, and others as needed.
- Put all `MOCK_METHOD` declarations in the `public:` section, even if the original methods were protected or private.

### Step 3: Handle Overloaded and Template Methods
For overloaded methods, mock each overload separately.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(std::string, Describe, (int type), (override));
};
```

For template classes:

```cpp
template <typename T>
class StackInterface {
 public:
  virtual ~StackInterface();
  virtual int GetSize() const = 0;
  virtual void Push(const T& x) = 0;
};

template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

### Step 4: Optional - Specify Calling Conventions
If your methods require a non-default calling convention (common on Windows), specify it in the `MOCK_METHOD` fourth parameter like so:

```cpp
MOCK_METHOD(bool, Foo, (int n), (Calltype(STDMETHODCALLTYPE)));
```

---

## Using Mock Objects in Tests

Once you have your mock class, you create mock objects in your tests and specify how they are expected to be used.

### Typical Workflow

1. **Import gMock symbols:**

```cpp
using ::testing::Return;
using ::testing::_;
```

2. **Create mock instances:**

```cpp
MockFoo foo;
```

3. **Set default behaviors (optional):**

Use `ON_CALL` to set default actions for all calls matching. This does not impose expectations.

```cpp
ON_CALL(foo, GetSize()).WillByDefault(Return(1));
```

4. **Set expectations:**

`EXPECT_CALL` specifies that a method must be called with matching arguments, a certain number of times, and may specify what it returns or does.

```cpp
EXPECT_CALL(foo, Describe(5))
    .Times(3)
    .WillRepeatedly(Return("Category 5"));
```

5. **Run code under test using mocks:**

```cpp
EXPECT_EQ(MyProductionFunction(&foo), "good");
```

6. **Automatic verification:**

When the mock object is destroyed, gMock automatically verifies that all expectations were met.

### Example Test

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(int type) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (int type), (override));
};

TEST(FooTest, Example) {
  MockFoo foo;

  ON_CALL(foo, GetSize()).WillByDefault(Return(1));

  EXPECT_CALL(foo, Describe(5))
      .Times(3)
      .WillRepeatedly(Return("Category 5"));

  // Call production code using foo
  auto result = foo.Describe(5);
  EXPECT_EQ(result, "Category 5");

  foo.Describe(5);
  foo.Describe(5);
}
```

---

## Customizing Mock Behavior

### Setting Default Actions

By default, mock methods return zero, false, or default-constructed values if no specific behavior is set. If you want to customize this, use `ON_CALL`.

```cpp
ON_CALL(mock_object, Method(args...)).WillByDefault(Return(value));
```

This is useful to provide common actions without setting strict call count expectations.

### Setting Expectations

Use `EXPECT_CALL` to specify that a call is expected and optionally to define the behavior.

```cpp
EXPECT_CALL(mock_object, Method(args...)).Times(n).WillOnce(...).WillRepeatedly(...);
```

- `Times(n)` specifies how many times the call should occur.
- You can chain multiple `WillOnce` calls for consecutive call behaviors.
- Use `WillRepeatedly` to define default behavior for calls after `WillOnce` calls are exhausted.

### Handling Uninteresting Calls with Nice, Naggy, and Strict Mocks

Mock objects by default are NaggyMocks, which warn when uninteresting calls (calls with no `EXPECT_CALL`) happen. You can adjust this behavior:

- `NiceMock`: Suppresses warnings on uninteresting calls.
- `NaggyMock`: Warns on uninteresting calls (default).
- `StrictMock`: Treats uninteresting calls as errors.

Usage:

```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_foo;
NaggyMock<MockFoo> naggy_foo;
StrictMock<MockFoo> strict_foo;
```

---

## Best Practices and Tips

- Always mock methods declared as `virtual` and ensure their destructors are virtual.
- Put all `MOCK_METHOD` declarations in `public:` to allow usage of `ON_CALL` and `EXPECT_CALL` outside the class.
- Use `ON_CALL` to set default behaviors where calls are expected but not strict.
- Use `EXPECT_CALL` to enforce precise interaction constraints.
- Remember the order of `EXPECT_CALL`s matters; newer expectations override older ones.
- Use sequences and partial orders (via `InSequence` and `After`) when call order matters.
- For overloaded methods, mock all relevant overloads to avoid unexpected calls or hiding base class methods.
- Be careful with `Times(0)` to explicitly disallow calls.
- Use `ReturnRef` for methods returning references and `ReturnPointee` for returning the value pointed to by a pointer.
- Delegate calls to fakes or real objects where appropriate, especially for complex behavior (delegation pattern).

---

## Troubleshooting Common Issues

### Mocked Method Calls Real Methods
- Make sure the method is declared `virtual` in the base class.

### Warning on Uninteresting Calls
- Either add `EXPECT_CALL` with `Times(AnyNumber())` for those calls you want to allow.
- Switch to `NiceMock` to suppress warnings.

### Expected Calls Not Being Satisfied
- Run with `--gmock_verbose=info` to trace calls and expectations.
- Check argument matchers carefully.

### Memory or Destructor Issues
- Ensure base class destructors are virtual.
- Do not delete mocks prematurely or leak without `Mock::AllowLeak`.

### Overloaded Mock Method Ambiguity
- Use `Const()` to disambiguate const overloads.
- Specify argument types or use expectations on specific overloads.

### Mock Class Compilation Slow
- Move constructor and destructor implementations to `.cc` files.

---

## Next Steps & Related Content

- [Expectations, Actions, Cardinalities, and Matchers](googletest-guides/advanced-mocking/expectations-actions-cardinalities-matchers)
- [Mocking Policies and Behaviors: Nice, Strict, and Naggy](googletest-guides/advanced-mocking/mocking-policies-and-behaviors)
- [GoogleMock Cookbook](docs/gmock_cook_book.md): Practical recipes and common patterns.
- [Matchers Reference](docs/reference/matchers.md): For matching arguments in expectations.
- [Actions Reference](docs/reference/mocking.md#QuickNewActions): For specifying mock behaviors.
- [Troubleshooting Common Issues](getting-started/first-test-execution/troubleshooting-common-issues): Resolving frequent problems.

---

You now have a solid foundation to create mock classes and use them confidently in your tests using GoogleMock.

---

## References

- gMock Cheat Sheet: https://google.github.io/googletest/gmock_cheat_sheet.html
- gMock for Dummies: https://google.github.io/googletest/gmock_for_dummies.html
- Mocking Reference: docs/reference/mocking.md
- gMock Cookbook: docs/gmock_cook_book.md
- GoogleTest Primer: googletest-guides/getting-started/primer
