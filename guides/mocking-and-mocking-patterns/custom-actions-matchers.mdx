---
title: "Custom Actions and Matchers"
description: "Tutorials on writing custom matchers and actions to support more complex verification logic in tests. Shows practical examples where built-in matchers are insufficient and customization adds clarity."
---

# Custom Actions and Matchers

This guide teaches you how to extend GoogleMock by writing custom matchers and custom actions. These custom components allow you to handle complex verification logic and behaviors in tests that go beyond the built-in capabilities. Through practical examples, you will learn to craft expressive, clear, and maintainable test conditions when standard matchers or actions are insufficient.

---

## 1. Understanding Custom Matchers

### What Are Custom Matchers?

Matchers in GoogleMock define the conditions under which a mock method's arguments are accepted. While GoogleMock offers a rich set of built-in matchers (e.g., `_`, `Eq()`, `Ge()`), sometimes you need to verify a property or relationship about arguments that is specific to your domain or test logic. Writing custom matchers lets you encapsulate these criteria into reusable, readable components.

### When to Write a Custom Matcher

- When argument validation depends on multiple properties or a non-trivial predicate.
- When built-in matchers are too generic or verbose to express your intent clearly.
- When you want failure messages that describe custom conditions precisely.

### Approaches for Custom Matchers

GoogleMock supports multiple approaches to creating custom matchers, ranging from quick macros to fully custom classes:

- Use `MATCHER()` or `MATCHER_P()` macros for concise, parameterized matchers.
- Implement your own matcher class for fine-grained control over matching and descriptive messages.


### Quick Custom Matcher with `MATCHER`

The simplest way to write a matcher is to use the `MATCHER` macro:

```cpp
MATCHER(IsDivisibleBy7, "Checks if a number is divisible by 7.") {
  return (arg % 7) == 0;
}

// Usage:
EXPECT_CALL(mock, Method(IsDivisibleBy7()));
```

The macro provides an `arg` variable representing the argument value. Return `true` for a match, `false` otherwise. You can provide custom failure descriptions by streaming additional output.

### Parameterized Matchers with `MATCHER_P`

For matchers that take parameters, use `MATCHER_P`:

```cpp
MATCHER_P(WithinRange, range, "Checks if a value is within ±range of 0") {
  return arg >= -range && arg <= range;
}

// Usage:
EXPECT_CALL(mock, Method(WithinRange(10)));
```

You can create multi-parameter matchers with `MATCHER_P2`, `MATCHER_P3`, etc.

### Writing a Matcher Class

For advanced matchers, define a matcher class that implements:

- `bool MatchAndExplain(const T& value, std::ostream* listener) const` — performs matching and optionally streams explanation.
- `void DescribeTo(std::ostream* os) const` — describes what the matcher checks.
- `void DescribeNegationTo(std::ostream* os) const` — describes the negated matcher.

Example:

```cpp
class BarPlusBazEqMatcher {
 public:
  using is_gtest_matcher = void;

  explicit BarPlusBazEqMatcher(int expected_sum) : expected_sum_(expected_sum) {}

  bool MatchAndExplain(const Foo& foo, std::ostream* /* listener */) const {
    return (foo.bar() + foo.baz()) == expected_sum_;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "bar() + baz() equals " << expected_sum_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "bar() + baz() does not equal " << expected_sum_;
  }
 private:
  const int expected_sum_;
};

::testing::Matcher<const Foo&> BarPlusBazEq(int expected_sum) {
  return ::testing::MakeMatcher(new BarPlusBazEqMatcher(expected_sum));
}

// Usage:
EXPECT_THAT(foo_object, BarPlusBazEq(5));
```

---

## 2. Creating Custom Actions

### What Are Actions?

Actions define what a mock method does when called. The built-in actions cover returning values, throwing exceptions, invoking callbacks, manipulating arguments, and combinations thereof.

Custom actions allow you to define arbitrary behaviors for mocked methods, such as complex side effects or dynamic return values.

### When to Write a Custom Action

- When built-in actions like `Return()`, `Invoke()`, or `SetArgPointee()` do not suffice.
- When you want to combine multiple side effects and a return value uniquely.
- When you need stateful behavior or side effects driven by test logic.

### Simple Custom Actions via Lambdas or Functors

You can often write custom actions inline with lambdas:

```cpp
EXPECT_CALL(mock, Method(_))
    .WillOnce([](int x) {
      // Custom complex behavior
      return x * 2;
    });
```

Or create an action object with a callable operator:

```cpp
struct MultiplyBy {
  int factor;
  template <typename T>
  T operator()(T arg) { return arg * factor; }
};

EXPECT_CALL(mock, Method(_)).WillOnce(MultiplyBy{7});
```

### Defining ACTION Macros

For reusable custom actions, define them with the `ACTION` macros:

```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}

// Use with
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg1());
```

You can define parameterized custom actions using `ACTION_P`, `ACTION_P2`, etc.

---

## 3. Best Practices for Custom Matchers and Actions

- **Readability:** Name your matchers and actions clearly to convey intent.
- **Feedback:** Provide descriptive failure messages in matchers to ease debugging.
- **Side-Effects:** Matchers should be pure functions without side effects.
- **Reuse:** Encapsulate common behavioral patterns inside custom matchers or actions for DRY code.
- **Performance:** Avoid costly computations in matchers or actions unless necessary.

---

## 4. Examples of Custom Matchers and Actions

### Example: Custom Matcher for Container Size

```cpp
MATCHER_P(HasSize, expected_size, "Checks container size") {
  return static_cast<int>(arg.size()) == expected_size;
}

EXPECT_CALL(mock, Method(HasSize(4)));  // Verify argument container has size 4
```

### Example: Custom Action Setting Multiple Output Args

```cpp
ACTION_P(SetOutputs, values) {
  for (size_t i = 0; i < values.size(); ++i) {
    *std::get<i>(args) = values[i];
  }
}

EXPECT_CALL(mock, Method(_, _))
    .WillOnce(SetOutputs(std::vector<int>{1, 2}));
```

### Example: Custom Matcher Class with Explanation

```cpp
class StartsWithMatcher {
 public:
  explicit StartsWithMatcher(const std::string& prefix) : prefix_(prefix) {}

  bool MatchAndExplain(const std::string& s, std::ostream* os) const {
    bool matches = s.compare(0, prefix_.size(), prefix_) == 0;
    if (!matches && os) {
      *os << "which doesn't start with " << prefix_;
    }
    return matches;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "starts with " << prefix_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "does not start with " << prefix_;
  }

 private:
  const std::string prefix_;
};

::testing::Matcher<std::string> StartsWith(const std::string& prefix) {
  return ::testing::MakeMatcher(new StartsWithMatcher(prefix));
}

// Usage:
EXPECT_THAT("hello world", StartsWith("hell"));
```

---

## 5. Troubleshooting Custom Matchers and Actions

- **Matcher Not Matching Correctly:** Verify that `MatchAndExplain` logic correctly implements your matching criteria.
- **Confusing Failure Messages:** Implement `DescribeTo` and `DescribeNegationTo` to give precise descriptions.
- **Side Effects Causing Issues:** Ensure matchers do not alter any state; they are expected to be side-effect free.
- **Action Not Executing:** Check that your custom action's signature matches the mock method signature.
- **Compilation Errors with Templates:** Confirm correct use of C++11 features and macro parameters.

---

## 6. Next Steps

- Explore the [gMock Cookbook](../docs/gmock_cook_book.md) for advanced mocking recipes.
- Learn how to write first mocks and tests in the [Getting Started with Mocking](../getting-started/first-test/mocking-first-steps.mdx) guide.
- Deepen understanding of assertions and expectations in [Using Assertions Effectively](../guides/writing-tests/advanced-assertions) and [Expectations API](../api-reference/mocking-and-matcher-api/expectation-api).

---

## References

- [gMock Cookbook](../docs/gmock_cook_book.md)
- [Mocking Reference](../docs/reference/mocking.md)
- [Actions Reference](../docs/reference/actions.md)

---

This completes your primer on writing custom actions and matchers to unlock the full power of GoogleMock in complex test scenarios.
