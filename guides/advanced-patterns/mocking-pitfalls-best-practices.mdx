---
title: "Mocking Best Practices and Common Pitfalls"
description: "Guidance for effective mock usage, including strictness levels, ordering, cardinalities, and cleaner mock maintenance. Avoid common mocking mistakes and adopt cleaner, more reliable testing strategies in your teamâ€™s workflow."
---

# Mocking Best Practices and Common Pitfalls

This guide provides practical guidance to help you use GoogleMock effectively and maintain cleaner, more reliable mocks in your tests. It focuses on key best practices, common mistakes to avoid, and how to leverage strictness levels, call ordering, cardinalities, and mock maintenance strategies.

---

## 1. Understanding Mock Strictness Levels

GoogleMock provides three levels of strictness for mock objects, each influencing how uninteresting calls (calls to methods with no expectations) are handled:

| Strictness     | Behavior on Uninteresting Calls                        | Typical Use Case                                           |
|---------------|--------------------------------------------------------|------------------------------------------------------------|
| **NiceMock**   | Silences warnings, allows calls without expectations  | Most tests, when you want cleaner test output              |
| **NaggyMock**  | Default: warns about uninteresting calls               | Default mock behavior, useful during mock development       |
| **StrictMock** | Fails tests on uninteresting calls                       | Enforces strict interaction, used as last-resort or safeguards |

Using these wisely ensures that your tests are neither too noisy nor too brittle.

### How to Use Strictness Wrappers

You wrap your mock class with the appropriate template:

```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock;     // Suppresses warnings
NaggyMock<MockFoo> naggy_mock;   // Default with warnings
StrictMock<MockFoo> strict_mock; // Fails on uninteresting calls
```

**Tip:** Prefer `NiceMock` for routine tests for clarity and maintainability. Use `StrictMock` sparingly to catch unexpected interactions.

---

## 2. Setting Expectations and Default Behaviors

### When to Use `EXPECT_CALL` vs `ON_CALL`

- **`EXPECT_CALL`** declares an expectation that a method will be called, allowing verification of call count and arguments.
- **`ON_CALL`** defines default behavior for a method without imposing any call expectations.

**Best practice:** Use `ON_CALL` to specify default/mock method behaviors in test setup or fixtures. Use `EXPECT_CALL` only where you want to verify interaction.

```cpp
ON_CALL(mock_foo, DoSomething()).WillByDefault(Return(true));
EXPECT_CALL(mock_foo, DoSomething()).Times(2);
```

### Avoid Over-Specification

Only verify what matters. Too many expectations make tests brittle and make refactoring difficult. Be minimal and explicit.

### Catch-All Expectations

When some calls are allowed but not of particular interest, specify catch-all expectations:

```cpp
EXPECT_CALL(mock_foo, Method(_)).Times(AnyNumber()); // Accepts any arguments
```

Place more specific expectations *after* such catch-alls to ensure proper matching.

---

## 3. Managing Expectation Cardinalities

Expectation cardinalities specify how many times you expect a call. Use `Times()` clause with these cardinalities:

| Cardinality        | Meaning                                    |
|--------------------|--------------------------------------------|
| `Exactly(n)` or `n`| Exactly *n* times (0 means should not be called) |
| `AtLeast(n)`       | At least *n* times                         |
| `AtMost(n)`        | At most *n* times                          |
| `Between(m, n)`    | Between *m* and *n* times inclusive       |
| `AnyNumber()`      | Any number of times                        |

**Important:** If omitted, GoogleMock infers cardinalities based on actions like `WillOnce` or `WillRepeatedly`.

### Using `.RetiresOnSaturation()`

To avoid expectation stickiness (where saturated expectations can cause upper-bound failures), use `.RetiresOnSaturation()` to have an expectation retire immediately when saturated:

```cpp
EXPECT_CALL(mock_foo, Compute(5))
    .Times(2)
    .RetiresOnSaturation();
```

This makes test behavior more predictable and easier to read.

---

## 4. Ordering Calls with Sequences

### Unordered Calls (Default)

By default, expectations may match calls in any order. Sometimes this is fine.

### Enforcing Order with `InSequence`

To require calls to happen in the order expectations appear, use the `InSequence` object:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Init());
  EXPECT_CALL(mock, Run());
  EXPECT_CALL(mock, Cleanup());
}
```

### Partial Ordering and Dependencies

For more complex relative orderings, use `Sequence` objects with `InSequence` or the `.After()` clause to specify prerequisites:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Step1()).InSequence(s1);
EXPECT_CALL(mock, Step2()).InSequence(s1, s2);
EXPECT_CALL(mock, Step3()).InSequence(s2);
```

This constructs a partial order allowing fine-grained control without being overly restrictive.

---

## 5. Avoiding Common Mocking Pitfalls

### 5.1. Expectation Setup After Calls

Never set expectations after a mock method has been called. Set all `EXPECT_CALL`s before exercising the mock.

### 5.2. Overlapping Expectations

Multiple expectations on the same method should be arranged from more general to more specific, as matching is done in reverse order.

Incorrect order can shadow specific expectations:

```cpp
EXPECT_CALL(mock, Foo(_));       // Catches all calls
EXPECT_CALL(mock, Foo(42));      // Shadowed, never matched
```

Swap the order or add catch-all after specific expectations.

### 5.3. Excessive or Missing `WillOnce` Actions

Ensure the number of `WillOnce` actions matches call expectations; otherwise, warnings or runtime errors occur.

Use `WillRepeatedly` to specify default behavior beyond `WillOnce` calls.

### 5.4. Beware of Mutable State in Actions

Actions like `Return(n++)` evaluate `n++` once at expectation setup, not at each call. Use lambdas to capture state dynamically instead.

### 5.5. Using `NiceMock` vs `NaggyMock` vs `StrictMock`

Pay attention to which strictness level your mock uses to avoid surprises from uninteresting calls.

---

## 6. Cleaner Mock Maintenance and Best Practices

### Centralize Mock Class Definitions

Define mock classes close to the interface or module owner to reduce duplication and facilitate updates.

### Use Aliases and Parent Adapters for Complex Interfaces

Helps keep mock signatures manageable and maintainable.

### Implement Default Behaviors Thoroughly

Set `ON_CALL` for expected frequent default behaviors to reduce noise and ambiguity.

### Use Clear and Minimal Matchers

Avoid overspecifying argument matchers; use `_` wildcard when argument values don't matter.

### Leverage `Mock::AllowLeak` in Exceptional Cases

To suppress errors due to deliberate leakage of mock objects, use:

```cpp
Mock::AllowLeak(mock_obj_ptr);
```

### Force Verified Expectations Early When Needed

Use `Mock::VerifyAndClearExpectations(&mock_obj);` to check expectations explicitly before destructor.

### Utilize Callbacks, Lambdas, and Custom Actions for Realistic Behavior

Design mock behaviors to more closely mirror real object responses to catch logic errors early.

---

## 7. Troubleshooting Common Issues

### Tests Fail Due to Unexpected Calls

- Verify all required `EXPECT_CALL` are set before exercising mock.
- Check argument matchers carefully; mismatches cause unexpected call failures.

### Excessive Calls Fail

- Confirm that expected call counts (`Times`) allow the number of calls made.
- Use `.RetiresOnSaturation()` to retire expectations when saturated.

### Warnings About Uninteresting Calls

- Use `NiceMock` to silence warnings if uninteresting calls are legitimate.
- Otherwise, consider adding `EXPECT_CALL(...).Times(AnyNumber())` for ignored methods.

### Default Actions Not Being Applied

- Make sure `ON_CALL` is properly set for methods with default behavior.

### Compilation Errors Mocking Overloaded or Const Methods

- Use `(const)` or `(const, override)` qualifiers in `MOCK_METHOD`.
- Use `Const()` wrapper to disambiguate `EXPECT_CALL` and `ON_CALL` on const overloads.

### Complex Method Signatures and Commas in Types

- Wrap return or argument types containing commas with parentheses.
- Alternatively, use `using` type aliases.

---

## References and Further Reading

To deepen your understanding and mastery of mocking with GoogleMock, consult:

- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md)
- [gMock for Dummies](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md)
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)
- [GoogleTest Architecture and Concepts](../overview/architecture-and-concepts/core-concepts)

For practical application, also explore guides on [Writing Your First Test](../guides/core-workflows/first-test), and [Mocking Basics](../guides/core-workflows/mocking-basics).

---

## Summary

This page concentrates on best practices for mocking with GoogleMock, covering strictness levels (`NiceMock`, `NaggyMock`, `StrictMock`), managing expectations precisely with `EXPECT_CALL` and `ON_CALL`, controlling call ordering, setting cardinalities and retirement behavior, and cleaning up mocks for maintainable tests. It addresses frequent pitfalls such as over- or under-specifying expectations, call ordering mistakes, and uninteresting call warnings.

Following these guidelines will ensure your test suite is robust, clear, and flexible to change, empowering your team to adopt interaction-based testing methodologies effectively.

---