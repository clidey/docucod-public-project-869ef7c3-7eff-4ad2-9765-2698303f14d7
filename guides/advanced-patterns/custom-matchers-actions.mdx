---
title: "Building Custom Matchers and Actions"
description: "Extend GoogleTest by authoring your own matchers and actions to validate unique object behaviors, replace dependencies, or exercise unusual code paths."
---

# Building Custom Matchers and Actions

Extend GoogleTest's mocking capabilities by authoring your own matchers and actions to verify unique object behaviors, substitute dependencies, or test code paths that built-in features do not cover.

---

## Introduction

GoogleMock provides a rich set of built-in matchers and actions to facilitate unit testing. However, certain scenarios require custom logic to express complex conditions or actions uniquely relevant to your domain. This guide walks you through creating new matchers and actions, helping you create expressive, maintainable test expectations beyond the standard offerings.

---

## Why Write Custom Matchers and Actions?

- **Validate unique invariants or property combinations** on complex objects.
- **Simplify test intent** by encapsulating repetitive validation logic into reusable components.
- **Exercise unusual or corner-case code paths** that do not fit built-in matchers.
- **Integrate domain-specific semantics** directly in mock expectations and actions.

Writing custom matchers and actions ensures your tests are clear, maintainable, and precise.

---

## Writing New Matchers

### The Matcher Concept

A matcher is a predicate used in expectations to verify that arguments passed to mock methods satisfy specific conditions.

In GoogleMock, a matcher:

- Must **test whether a value matches** the condition.
- Can **describe what it matches** to generate useful failure messages.
- Can optionally **explain why** a value did or did not match.

### Defining a Matcher Using `MATCHER` Macros

GoogleMock offers a suite of macros to define new matchers quickly and with minimal boilerplate.

#### Basic Matcher Example

```cpp
MATCHER(IsDivisibleBy7, "") {
  // ‘arg’ is the value being matched
  return (arg % 7) == 0;
}
```

Usage:

```cpp
EXPECT_CALL(mock_object, Method(IsDivisibleBy7()));
EXPECT_THAT(value, IsDivisibleBy7());
```

#### Adding Custom Failure Messages

For richer diagnostic messages, stream additional information to the hidden `result_listener`:

```cpp
MATCHER(IsDivisibleBy7, "") {
  int remainder = arg % 7;
  if (remainder == 0) {
    return true;
  }
  *result_listener << "the remainder is " << remainder;
  return false;
}
```

Failure message example:

```
Value of: x
Expected: is divisible by 7
  Actual: 27 (the remainder is 6)
```

#### Using `EXPECT_` Statements Inside Matchers

You can simplify matchers by using assertions inside:

```cpp
MATCHER(IsDivisibleBy7, "") {
  int remainder = arg % 7;
  EXPECT_EQ(remainder, 0);
  return true;
}
```

This prints detailed assertions when failures happen.

### Parameterized Matchers

For matchers that take parameters, use the `MATCHER_P`, `MATCHER_P2`, ..., up to `MATCHER_P10` macros.

Example:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}
```

Usage:

```cpp
EXPECT_THAT(number, HasAbsoluteValue(10));
```

### Creating Monomorphic and Polymorphic Matchers

- **Monomorphic matchers** match a single type (e.g., `Matcher<int>`).
- **Polymorphic matchers** can match multiple types by template instantiation as context requires.

For advanced use, you can define matcher classes implementing `MatchAndExplain()` and description methods, then provide a factory function returning a `testing::Matcher<T>`.

Example polymorphic matcher snippet:

```cpp
class NotNullMatcher {
 public:
  using is_gtest_matcher = void;

  template <typename T>
  bool MatchAndExplain(T* p, std::ostream*) const {
    return p != nullptr;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "isn't NULL";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is NULL";
  }
};

inline testing::PolymorphicMatcher<NotNullMatcher> NotNull() {
  return testing::MakePolymorphicMatcher(NotNullMatcher());
}
```

### Composite Matchers

Matchers can accept other matchers as parameters and combine their behavior.

Example: Defining a matcher to test distance with another matcher:

```cpp
template <typename V, typename T, typename Distance, typename GetDistance>
class DistanceFromMatcherImpl : public testing::MatcherInterface<V> {
  // ...
};
```

This can be used to create custom matching logic built upon existing matchers.

---

## Writing New Actions

### The Action Concept

Actions specify the behavior of mock methods when invoked — what they return, what side effects they perform, and how they respond based on inputs.

### Simple Action Definition

You can define a new action by providing a callable (function, functor, or lambda) compatible with the mocked method signature.

Example using a lambda:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 7; });
```

### Action Macros

Legacy macros like `ACTION()` and `ACTION_P()` provide syntactic sugar for defining actions with access to mock function arguments.

Example:

```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}
// Use with
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg1());
```

Inside an `ACTION` body, `argN` refers to the N-th argument of the mock function.

### Parameterized Actions

Use `ACTION_P()`, `ACTION_P2()`, etc. to define actions with parameters.

Example:

```cpp
ACTION_P(Add, n) {
  return arg0 + n;
}
EXPECT_CALL(mock, Foo(_)).WillOnce(Add(5)); // returns arg0 + 5
```

### Defining Template Actions

Use `ACTION_TEMPLATE()` to define actions with explicit template parameters when needed.

### Implementing Monomorphic and Polymorphic Actions

For advanced use, implement `testing::ActionInterface<F>` directly or use `MakePolymorphicAction()` to produce actions usable with various function signatures.

Sample skeleton:

```cpp
class MyAction {
 public:
  template <typename Result, typename ArgumentTuple>
  Result Perform(const ArgumentTuple& args) const {
    // Implement action logic...
  }
};

inline testing::PolymorphicAction<MyAction> MyActionFunction() {
  return testing::MakePolymorphicAction(MyAction());
}
```

### Chaining Actions

Use `DoAll()` to combine multiple actions, executing side effects and returning appropriate values.

Example:

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

### Built-in Action Helpers

GoogleMock includes many ready-to-use actions such as:

- `Return(value)`, `ReturnRef(variable)`, `ReturnPointee(pointer)`
- `SetArgPointee<N>(value)`, `SetArrayArgument<N>(first, last)`
- `Invoke(function_or_functor)`
- `InvokeArgument<N>(args...)`
- `DeleteArg<N>()`
- `IgnoreResult(action)`

Leverage these to simplify tests before writing custom actions.

---

## Tips and Best Practices

- Always ensure matcher and action code is **pure** and **side effect free** for matchers.
- Use `EXPECT_CALL` to specify expectations **before** exercising mocks.
- Prefer `ON_CALL` for defining default behaviors without enforcing call expectations.
- Chain `.RetiresOnSaturation()` with `EXPECT_CALL` where call counts should deactivate expectations after their limits.
- Suppress uninteresting call warnings using `NiceMock` if such calls are expected but not verified.
- Use sequences (`InSequence` or `Sequence` objects) to enforce strict or partial call order.
- Use lambda actions for complex or stateful behavior.

---

## Troubleshooting

- If custom matchers produce unexpected false failures, verify they are functionally pure and correctly handle all inputs.
- Excessive calls beyond `Times()` or missing required calls cause failures; review expectation counts.
- Use the `--gmock_verbose=info` flag to see detailed call and matching info.
- When defining actions that modify arguments or perform side effects, ensure the proper use of `SetArgPointee` and `DoAll` to avoid undefined behavior.

---

## Next Steps & Related Content

- **Using Matchers for Flexible Verification** for deeper understanding of built-in and custom matchers.
- **Mocking API Reference** describing EXPECT_CALL and ON_CALL in detail.
- **gMock Cookbook** for practical recipes and advanced mocking patterns.
- **gMock for Dummies** for a beginner-friendly approach to mocking.

Explore these materials to enhance your mastery of custom mocking primitives.

---

## References

- [gMock Cookbook](gmock_cook_book.md)
- [Matchers Reference](reference/matchers.md)
- [Specifying Actions](reference/matchers-actions-api/actions.md)
- [gMock for Dummies](gmock_for_dummies.md)
- [Mocking Reference](reference/mocking.md)

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "docs/gmock_cook_book.md", "range": "#Writing New Matchers Quickly - #Writing New Actions"}]} />
