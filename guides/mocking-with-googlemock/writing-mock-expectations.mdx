---
title: "Writing Mock Expectations and Actions"
description: "Best practices for setting up mock behaviors and expectations, including common patterns for ON_CALL, EXPECT_CALL, and custom actions. Illustrated with practical scenarios and sample code."
---

# Writing Mock Expectations and Actions

Harness the power of GoogleMock to precisely define *how* your mock objects behave and *what* interactions you expect from them. This guide focuses on writing effective mock expectations and actions using the core macros `EXPECT_CALL` and `ON_CALL`, striking the perfect balance between specifying behavior and verifying interactions.

---

## Overview

This page helps you master the best practices for setting up mock behaviors and expectations in GoogleMock. Here, you will learn how to:

- Define expectations that specify the *calls* you expect on your mocks.
- Declare default behaviors for mock methods when no explicit expectation exists.
- Leverage matchers and cardinalities to fine-tune argument expectations and call counts.
- Use actions to control return values, side effects, and call sequences.

You will be guided through practical scenarios, supported by comprehensive examples and actionable tips.

---

## Prerequisites

- Basic familiarity with C++ unit testing.
- A mock class defined using GoogleMock’s `MOCK_METHOD` macro.
- GoogleMock integrated into your test environment.
- (Recommended) Prior reading of the [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) guide.

---

## Expected Outcome

By following this guide, you will be able to:

- Write clear and concise `EXPECT_CALL` statements to verify that mock methods are called as intended.
- Configure default mock behavior using `ON_CALL` to create less brittle and more maintainable tests.
- Combine matchers, call count cardinalities, and actions to express complex interaction specifications.
- Avoid common pitfalls such as over-specifying expectations or missing call verifications.

---

## Time Estimate

Approximately 20 to 30 minutes to absorb and practice the concepts.

---

## Difficulty Level

Intermediate — This guide assumes you understand basic mocking concepts and C++ syntax but aims to elevate your expertise in writing robust mock expectations and actions.

---

# Step-by-Step Guide to Writing Mock Expectations and Actions

### 1. Understand the Difference: `EXPECT_CALL` vs `ON_CALL`

- `EXPECT_CALL` sets an **expectation**: you assert that a mock method *will be called* with specific arguments, often a precise number of times, and optionally in a particular order.
- `ON_CALL` sets a **default behavior**: you specify what a mock method *does* when called with matching arguments, but without asserting that it must be called.

**Best Practice:** Use `ON_CALL` for setting up common default behavior, and reserve `EXPECT_CALL` for calls you explicitly want to verify.


### 2. Crafting an `EXPECT_CALL`

The basic syntax:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)   // Optional
    .Times(cardinality)        // Optional; defaults inferred
    .InSequence(seq1, seq2...) // Optional
    .After(expectation_or_set) // Optional
    .WillOnce(action)          // Optional
    .WillRepeatedly(action)    // Optional
    .RetiresOnSaturation();   // Optional
```

- Use argument *matchers* (`_`, `Eq()`, `Ge()`, custom matchers) to specify expected arguments.
- `Times` controls how many times the method is expected to be called.
- Use `InSequence` and `After` to enforce call order constraints.
- `WillOnce` and `WillRepeatedly` define actions the mock performs when called.
- `RetiresOnSaturation` makes expectations inactive after their call quota is filled.

**Example:**

```cpp
using ::testing::AtLeast;
using ::testing::_;
using ::testing::Return;

EXPECT_CALL(turtle, Forward(100))
    .Times(AtLeast(1))
    .WillRepeatedly(Return());
```

This expects that `Forward(100)` is called at least once, performing no action (returns void).


### 3. Setting Default Behavior with `ON_CALL`

Use `ON_CALL` to specify what a mock method *does* when invoked, without asserting that it *must be called*:

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)       // Optional
    .WillByDefault(action);        // Mandatory
```

Actions are ignored by default when an `EXPECT_CALL` matches.

**Example:**

```cpp
ON_CALL(turtle, GetX())
    .WillByDefault(Return(0));
```

Without any `EXPECT_CALL` for `GetX()`, calls will return 0.


### 4. Using Matchers to Specify Argument Expectations

- Use `_` as a wildcard matcher to accept any argument.
- Employ parametric matchers like `Eq(val)`, `Ge(val)`, `NotNull()`.
- Use compound matchers with `AllOf()`, `AnyOf()`, `Not()` to express complex conditions.
- Use `With()` clause to apply a matcher on the full argument tuple for cross-argument constraints.

**Example:**

```cpp
EXPECT_CALL(turtle, GoTo(50, _))  // First arg exactly 50, second any value
    .Times(1);

EXPECT_CALL(turtle, GoTo(_, _))
    .With(Lt())  // Ensure first arg less than second
    .Times(AnyNumber());
```


### 5. Specifying Cardinalities with `Times()`

Cardinalities control expected call counts.

| Cardinality           | Meaning                               |
|----------------------|-------------------------------------|
| `Exactly(n)` or `n`  | Called exactly *n* times.            |
| `AtLeast(n)`          | Called *at least* *n* times.         |
| `AtMost(n)`           | Called *at most* *n* times.          |
| `Between(m, n)`       | Called between *m* and *n* times.    |
| `AnyNumber()`         | Called any number of times.           |

If omitted, GoogleMock infers based on presence of `WillOnce`/`WillRepeatedly` clauses.

**Example:**

```cpp
EXPECT_CALL(turtle, PenDown())
    .Times(0);  // Expect never called
```


### 6. Defining the Behavior with Actions

Actions define what happens when a mock method is called and matchers+cardinalities are satisfied.

- `Return(value)`: returns a copy of `value`.
- `ReturnRef(variable)`: returns a reference to a variable.
- `ReturnPointee(pointer)`: returns the value pointed to by `pointer` at call time.
- `DoAll(action1, action2, ..., actionN)`: performs actions in sequence; return value is from last.
- `Invoke(function_or_callable)`: calls your function/functor/lambda with the mock arguments.
- `SetArgPointee<N>(value)`: sets the N-th argument pointed-to value.
- `InvokeArgument<N>(args...)`: calls the N-th argument as a callable.

**Example:**

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(7));
```

Returns `42` on the first call, `7` for all subsequent calls.


### 7. Managing Multiple Expectations on the Same Method

GoogleMock will evaluate expectations in **reverse order**, picking the last matching active expectation. For example:

```cpp
EXPECT_CALL(mock, Forward(_));  // #1 - less specific
EXPECT_CALL(mock, Forward(10))  // #2 - more specific
    .Times(2);
```

Calling `Forward(10)` twice matches #2, further calls match #1 or cause failure.


### 8. Controlling Call Order

Use `InSequence` or `After` to enforce call order constraints:

#### Using `InSequence`

```cpp
{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```
Calls must occur in this exact order.

#### Using `After`

```cpp
Expectation e1 = EXPECT_CALL(turtle, PenDown());
EXPECT_CALL(turtle, Forward(_)).After(e1);
```
`Forward` expects to be called only after `PenDown`.


### 9. Handling Expectation Saturation

By default, expectations remain active after their call count is met ("sticky"). To make an expectation *retire* once saturated (stop matching calls), use:

```cpp
EXPECT_CALL(mock, Method(args))
    .Times(n)
    .RetiresOnSaturation();
```

This is particularly useful when overlapping expectations may shadow one another.


### 10. Verifying or Clearing Expectations Early

You can verify that all expectations on a mock object are satisfied before destruction:

```cpp
ASSERT_TRUE(Mock::VerifyAndClearExpectations(&mock));
```

Or verify and clear both expectations and default actions:

```cpp
ASSERT_TRUE(Mock::VerifyAndClear(&mock));
```


---

# Practical Examples

### Example 1: Basic Use of `EXPECT_CALL` with Return Values

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class MockTurtle {
 public:
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(void, Forward, (int distance), ());
  MOCK_METHOD(int, GetX, (), (const));
};

TEST(PainterTest, DrawsLine) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown())
      .Times(1);
  EXPECT_CALL(turtle, Forward(100))
      .Times(1);
  EXPECT_CALL(turtle, GetX())
      .WillOnce(::testing::Return(10));

  turtle.PenDown();
  turtle.Forward(100);
  EXPECT_EQ(10, turtle.GetX());
}
```


### Example 2: Using `ON_CALL` for Defaults and `EXPECT_CALL` for Verification

```cpp
MockTurtle mock;

ON_CALL(mock, GetX())
    .WillByDefault(::testing::Return(0));

EXPECT_CALL(mock, PenDown())
    .Times(AtLeast(1));

// The GetX() calls will return 0 unless overridden by a specific EXPECT_CALL.
mock.PenDown();
EXPECT_EQ(0, mock.GetX());
```


### Example 3: Specifying Call Order with `InSequence`

```cpp
{
  ::testing::InSequence s;

  EXPECT_CALL(mock, PenDown());
  EXPECT_CALL(mock, Forward(50));
  EXPECT_CALL(mock, PenUp());
}

// Calling Forward before PenDown or PenUp before Forward will fail the test.
```

### Example 4: Return Different Values in Sequence

```cpp
EXPECT_CALL(mock, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));

EXPECT_EQ(100, mock.GetX());  // 1st call
EXPECT_EQ(150, mock.GetX());  // 2nd call
EXPECT_EQ(200, mock.GetX());  // 3rd and subsequent calls
```

### Example 5: Using Matchers and Wildcards

```cpp
using ::testing::_;
EXPECT_CALL(mock, GoTo(50, _));  // First argument must be 50, second can be anything
EXPECT_CALL(mock, Forward(Ge(100)));  // Forward called with argument >= 100
```


---

# Tips & Best Practices

- Set expectations **before** invoking methods on your mocks. Setting expectations after calls can lead to undefined behavior.
- Use `ON_CALL` in test setup or constructor for common default behavior.
- Avoid over-specifying expectations to keep tests maintainable.
- Use `RetiresOnSaturation()` to prevent stale expectations from blocking others.
- When mocking overloaded methods, specify argument types or matchers explicitly to help the compiler.
- Use `NiceMock` or `StrictMock` wrappers to control how uninteresting calls are treated.
- For methods returning references, use `ReturnRef()` action to avoid dangling references.
- Avoid side effects inside matchers and actions; matchers must be pure.
- Verify mock expectations explicitly if your object’s lifetime is unclear.


---

# Troubleshooting & Common Pitfalls

### Mock function called more times than expected

Ensure your `Times()` clause matches actual call counts. Consider using `AtLeast()` or `AnyNumber()` if uncertain.

### Unexpected mock function call

Likely caused by missing or incorrect `EXPECT_CALL`. Use `--gmock_verbose=info` to trace matching.

### Uninteresting call warnings

Means a mock method was called without an `EXPECT_CALL`. If expected, consider suppressing with a catch-all `EXPECT_CALL(...).Times(AnyNumber())` or `NiceMock` usage.

### Inconsistent ordering failures

Verify `InSequence` or `After` clauses match the real call order in your code.

### Return values for move-only types

Use lambdas or functors to generate return values dynamically instead of `Return(std::move(...))` which can cause runtime errors.

### Mock methods with no virtual destructor

Always ensure base classes have virtual destructors to avoid memory leaks and test failures.


---

# Next Steps & Related Content

- Dive deeper into mocking techniques with [Advanced Mocking: Matchers, Sequences, and Strictness](https://google.github.io/googletest/guides/mocking-with-googlemock/advanced-mocking-techniques.html)
- Understand mock object lifecycles and strategies at [Test and Mock Object Lifecycle](https://google.github.io/googletest/concepts/core-architecture/test-and-mock-lifecycle.html)
- Explore [Using Assertions Effectively](https://google.github.io/googletest/guides/testing-techniques/advanced-assertions.html) alongside mocks to write robust tests
- Troubleshoot setup issues via [Troubleshooting Common Setup Issues](https://google.github.io/googletest/getting-started/troubleshooting-and-resources/common-setup-issues.html)


# References

- [GoogleMock Specification Builders Header](https://github.com/google/googletest/blob/main/googlemock/include/gmock/gmock-spec-builders.h)
- [gMock For Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)

---

<Note>
Remember: perfect mocking means precise intent. Over-constraining your mocks risks brittle tests. Use `ON_CALL` generously for defaults, and reserve `EXPECT_CALL` for critical verifications.
</Note>

