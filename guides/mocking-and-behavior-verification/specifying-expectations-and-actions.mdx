---
title: "Specifying Expectations and Actions"
description: "Shows how to set up expectations for mock interactions, specify call counts, and use actions to define mock responses. Includes best practices for clear, maintainable tests."
---

# Specifying Expectations and Actions

This guide details how to set up precise expectations on mock methods, specify calling frequencies, and define actions that mock functions perform when invoked. It empowers you to write clear, maintainable, and expressive tests by controlling interaction verification and mock behavior in GoogleMock.

---

## Overview

When testing with mocks, your primary goals are to:

- Define which calls to expect on mock objects.
- Specify how many times these calls should occur.
- Configure the behavior of mock methods when they are called.

GoogleMock provides the macros and APIs to set these expectations and actions in a fluent and readable manner.

---

## Prerequisites

- A mock class with methods declared using the `MOCK_METHOD` macro.
- Familiarity with basic GoogleMock concepts like matchers and mocks.
- A test environment with `#include <gmock/gmock.h>` active.

---

## What You'll Achieve

By following this guide, you will be able to:

- Use `EXPECT_CALL` to specify expectations on mock method calls, including argument matching.
- Set cardinalities to control how many times methods are expected to be called.
- Use actions such as `Return()`, `Invoke()`, and `DoAll()` to define what mocked methods do.
- Use `ON_CALL` to set default mock behaviors without expectations.
- Leverage sequencing and ordering with `InSequence` and `After` to order calls.

---

## Time Estimate

This guide can be studied and applied within 15-30 minutes, depending on familiarity with GoogleMock.

---

## Difficulty Level

Intermediate

---

# Step-by-Step Instructions

<Steps>
<Step title="Defining an Expectation with EXPECT_CALL">
Use the `EXPECT_CALL` macro to set expectations on when and how mock methods will be called.

```cpp
using ::testing::Return;
...
EXPECT_CALL(mock_turtle, Forward(100));
```

This expects one call to `Forward` with argument `100`. If the method is called with a different argument or not called, the test will fail.

If the method is not overloaded, argument matchers can be omitted to allow any arguments.

**Tip:** Use `_` as a wildcard matcher to allow any value for an argument.

```cpp
EXPECT_CALL(mock_turtle, GoTo(50, _));  // expects calls to GoTo with x=50 and any y
```

</Step>
<Step title="Specifying How Many Times a Call Is Expected (Cardinalities)">
Add a `.Times()` clause to an expectation to control call counts:

| Cardinality           | Meaning                         |
|-----------------------|--------------------------------|
| `Times(AnyNumber())`   | Called any number of times      |
| `Times(AtLeast(n))`    | At least `n` times              |
| `Times(AtMost(n))`     | At most `n` times               |
| `Times(Between(m, n))` | Between `m` and `n` times       |
| `Times(Exactly(n))`    | Exactly `n` times               |

Example:

```cpp
EXPECT_CALL(mock_turtle, PenDown()).Times(AtLeast(1));
```

**Note**: If `.Times()` is omitted, GoogleMock infers it based on `WillOnce` and `WillRepeatedly` clauses:

- No `WillOnce()` or `WillRepeatedly()` → `.Times(1)`
- `n` `WillOnce()` without `WillRepeatedly()` → `.Times(n)`
- `n` `WillOnce()` with `WillRepeatedly()` → `.Times(AtLeast(n))`

</Step>
<Step title="Setting Behavior with Actions">
Define what happens when a mock method is called by attaching actions using `.WillOnce()` and `.WillRepeatedly()`.

Common actions:

- `Return(value)` — return a copy of `value`.
- `ReturnRef(variable)` — return a reference to `variable`.
- `Invoke(function)` — call a function or functor.
- `DoAll(action1, action2, ...)` — perform multiple actions sequentially.

Example:

```cpp
EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(200))
    .WillRepeatedly(Return(300));
```

This sets up the first call to return 100, second 200, and all subsequent calls 300.

**Tip:** Don’t write side-effect expressions inside `Return()`, as they are evaluated only once when the expectation is set.

If more complex behavior is needed, use lambdas:

```cpp
EXPECT_CALL(mock_foo, Compute(_))
    .WillRepeatedly([](int x) { return x * 2; });
```

</Step>
<Step title="Setting Default Actions with ON_CALL">
Use `ON_CALL` to specify default behavior for mock methods without setting expectations.

```cpp
ON_CALL(mock_foo, GetValue())
    .WillByDefault(Return(42));
```

`ON_CALL` behavior applies to all matching calls, except those explicitly matched by `EXPECT_CALL`.

**Note:** `WillByDefault()` must be used exactly once with each `ON_CALL`.

Use `ON_CALL` to reduce verbosity when you want to specify behavior but do not require strict call count checking.

</Step>
<Step title="Ordering Calls with InSequence and After">
Control the order of calls using:

- `InSequence` scope — all `EXPECT_CALL`s within the scope are expected in order.
- `.InSequence(seq1, seq2, ...)` — assign an expectation to specific sequences.
- `.After(expectation_or_set)` — specify that an expectation is valid only after other expectations have been satisfied.

Example with `InSequence`:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Open());
  EXPECT_CALL(mock, Read());
  EXPECT_CALL(mock, Close());
}
```

This makes calls to `Open()`, `Read()`, and `Close()` occur in order.

Example with `.After()`:

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Run()).After(e1);
```

`Run()` is expected only after `Init()` has been called.

</Step>
<Step title="Handling Expectations that Retire on Saturation">
Use `.RetiresOnSaturation()` on an expectation to automatically retire it once its call count upper bound is reached.

Example:

```cpp
EXPECT_CALL(mock, SetValue(7)).Times(2).RetiresOnSaturation();
EXPECT_CALL(mock, SetValue(_)).Times(AnyNumber());
```

Here, the first two calls to `SetValue(7)` match the first expectation. Subsequent calls to `SetValue(7)` match the second "catch-all" expectation.

This helps in writing flexible tests where expectations should cease after fulfillment.

</Step>
<Step title="Working with Overloaded and Const Methods">
Mocking overloaded or const-qualified methods requires specifying matchers carefully.

- For overloaded methods, always specify argument matchers to avoid ambiguity.
- Use the `Const()` wrapper to set expectations on const-qualified methods.

Example:

```cpp
EXPECT_CALL(mock, GetBar());           // non-const version
EXPECT_CALL(Const(mock), GetBar());    // const version
```

When resolving overloads in `EXPECT_CALL`, specify the exact matchers or use helper functions if needed.

</Step>
<Step title="Using Matchers to Control Argument Expectations">
In `EXPECT_CALL` and `ON_CALL`, you can specify argument matchers to restrict which calls match your expectation.

Use built-in matchers like `_`, `Eq()`, `Ge()`, `Lt()`, or compose matchers using `AllOf()`, `AnyOf()`, `Not()`.

Example:

```cpp
using ::testing::_;
using ::testing::Ge;
EXPECT_CALL(mock, DoSomething(Ge(5), _));
```

Match the whole argument tuple using `.With()`:

```cpp
EXPECT_CALL(mock, DoSomething(_, _)).With(Lt());  // first arg < second arg
```

Matchers can be combined for expressive expectation criteria.

</Step>

</Steps>

---

## Practical Examples

### Basic Expectation with Return

```cpp
using ::testing::Return;

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

// In your test:
MockTurtle mock_turtle;
EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(100))
    .WillRepeatedly(Return(200));

int x1 = mock_turtle.GetX();  // Returns 100
int x2 = mock_turtle.GetX();  // Returns 200
int x3 = mock_turtle.GetX();  // Returns 200
```

---

### Ignoring Uninteresting Calls (Default Behavior)

```cpp
class MockFoo {
 public:
  MOCK_METHOD(void, DoSomething, (), (override));
};

MockFoo mock;
// No expectations set; calling DoSomething is allowed but issues warnings.
mock.DoSomething();
```

Use `NiceMock<MockFoo>` to suppress warnings on uninteresting calls.

---

### Expecting No Calls

```cpp
EXPECT_CALL(mock_foo, Bar(_)).Times(0);  // Bar() should never be called.
```

---

### Sequencing Multiple Calls

```cpp
using ::testing::InSequence;

{
  InSequence s;
  EXPECT_CALL(mock_foo, Init());
  EXPECT_CALL(mock_foo, Start());
  EXPECT_CALL(mock_foo, Shutdown());
}
```

Ensures calls occur in this order.

---

### Using ON_CALL for Default Actions

```cpp
ON_CALL(mock_foo, Calculate(_)).WillByDefault(Return(42));
```

Allows calls to `Calculate` with any argument to return 42 unless an expectation overrides this.

---

## Troubleshooting & Tips

### 1. Expectation Ordering and Precedence

GoogleMock matches calls against expectations in reverse order. Always put the most specific expectations last to have them take precedence.

Example:

```cpp
EXPECT_CALL(foo, Bar(_))          // #1: Catch-all
EXPECT_CALL(foo, Bar(42))         // #2: More specific
```

Calls with `42` match #2.

---

### 2. Over-specification Pitfall

Avoid setting expectations that are too strict on arguments or ordering unless necessary. Over-specification leads to brittle tests.

Use wildcards (`_`) or omit `.Times()` when you don't care about exact call counts.

---

### 3. Using `.RetiresOnSaturation()` to Prevent Sticky Expectations

Expectations by default remain active after saturation, possibly causing unexpected failures on excess calls. Use `.RetiresOnSaturation()` when the expectation should be removed once fulfilled.

---

### 4. Debugging Unexpected Calls

Run tests with `--gmock_verbose=info` to get detailed traces of mock function calls, matching expectations, and stack traces. This helps understand why expectations fail.

---

### 5. Actions Running Out Warning

If you specify fewer `WillOnce()` actions than calls, GoogleMock warns and uses the default action afterward. Add a `WillRepeatedly()` or increase `WillOnce()` to fix.

---

### 6. Remember to Set Expectations Before Exercising Mocks

`EXPECT_CALL` must precede any code using mocks. Setting expectations afterwards leads to undefined behavior and may silently cause failures.

---

## Next Steps & Related Content

- Explore [Introduction to Mocking](../mocking-and-behavior-verification/introduction-to-mocking.md) for the fundamentals of mocks.
- Deep dive into [Advanced Mocking Patterns](../mocking-and-behavior-verification/advanced-mocking-patterns.md) for complex scenarios.
- Consult the [gMock Cookbook](docs/gmock_cook_book.md) for practical recipes on matchers and actions.
- Learn about [Writing and Structuring Tests](../core-testing-workflows/writing-and-structuring-tests.md) to organize test code effectively.

---

## References

- [EXPECT_CALL](reference/mocking.md#EXPECT_CALL)
- [ON_CALL](reference/mocking.md#ON_CALL)
- [DefaultValue](reference/mocking.md#DefaultValue)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](reference/actions.md)
- [Cardinality List](reference/mocking.md#EXPECT_CALL.Times)

---