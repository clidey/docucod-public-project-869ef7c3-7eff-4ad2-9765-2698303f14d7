---
title: "Integrating into CMake and Bazel Builds"
description: "Master the process of incorporating GoogleTest and GoogleMock into projects that use CMake or Bazel. This guide details setup steps, typical pitfalls, and cross-platform tips for reliable CI integration."
---

# Integrating into CMake and Bazel Builds

Master the process of incorporating GoogleTest and GoogleMock into projects that use CMake or Bazel. This guide takes you through the essential setup steps, practical examples, and key configuration points needed to embed GoogleTest into your build system reliably. You’ll gain insight into typical pitfalls, cross-platform considerations, and options to ensure smooth Continuous Integration (CI) workflows.

---

## 1. Overview of Integration

### What this guide helps you accomplish
This guide enables you to successfully add GoogleTest and GoogleMock to your CMake or Bazel-based C++ projects, so you can write, build, and run unit tests seamlessly as part of your development workflow.

### Prerequisites
- Basic familiarity with your build system (CMake or Bazel)
- C++17 compatible compiler
- CMake version 3.14 or later (for FetchContent-based integration)
- For Bazel: Bazel 7.0 or newer

### Expected outcome
By following this guide, your projects will:

- Have GoogleTest and GoogleMock linked properly
- Build test binaries that run and report test results
- Be configured for easy integration with CI pipelines

### Time estimate
15-30 minutes depending on prior experience with your build system

---

## 2. Integrating GoogleTest with CMake

### 2.1 Standalone Build Process

To build GoogleTest as a standalone project with CMake:

1. Clone GoogleTest repository:

   ```bash
   git clone https://github.com/google/googletest.git -b v1.17.0
   cd googletest
   mkdir build && cd build
   ```

2. Generate build files. To include GoogleMock (default):

   ```bash
   cmake ..
   ```

   To build only GoogleTest, disable GoogleMock explicitly:

   ```bash
   cmake .. -DBUILD_GMOCK=OFF
   ```

3. Build and install (on Unix-like systems):

   ```bash
   make
   sudo make install
   ```

> On Windows, generate Visual Studio solutions (`.sln`) or on macOS, create Xcode projects using the same `cmake ..` command.

### 2.2 Incorporating GoogleTest into Your Existing CMake Project

The most reliable way to integrate GoogleTest within your project is to build it as part of your project build. This avoids ABI and runtime mismatch issues especially on Windows.

**Two main approaches:**

- Use [FetchContent](https://cmake.org/cmake/help/latest/module/FetchContent.html) to download GoogleTest during the configure step
- Add GoogleTest source as a subdirectory (git submodule or manual copy)

#### Using FetchContent in your `CMakeLists.txt`:

```cmake
cmake_minimum_required(VERSION 3.14)
project(my_project)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)

# For Windows projects to avoid runtime conflicts
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test.cpp)
target_link_libraries(my_tests gtest_main)

enable_testing()
include(GoogleTest)
gtest_discover_tests(my_tests)
```

**Key Points:**
- `gtest_force_shared_crt ON` matches Visual Studio runtime linking with GoogleTest
- `enable_testing()` and `gtest_discover_tests()` allow CTest to find and run your tests

#### Tips:
- If your project is primarily C, explicitly set `gtest_force_shared_crt` to match your runtime usage.
- Keep your GoogleTest commit hashes updated to incorporate latest fixes and features.

### 2.3 Setting the C++ Standard

GoogleTest requires C++17. Ensure your project sets:

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

You can put these in your top-level `CMakeLists.txt` or pass `-DCMAKE_CXX_STANDARD=17` in your `cmake` command line.

### 2.4 Handling Multi-threaded Tests

GoogleTest uses pthreads on platforms that support it. This is automatically handled by the provided CMake scripts. If you manually configure flags, ensure you link pthread appropriately.

### 2.5 Building as a Shared Library (DLL)

While the default static linking is recommended, if your environment requires shared libraries:

- Add the option `-DGTEST_CREATE_SHARED_LIBRARY=1` to your compiler flags when building GoogleTest
- Pass `-DGTEST_LINKED_AS_SHARED_LIBRARY=1` when compiling your tests

### 2.6 Handling Visual Studio Runtime Conflicts

A common error during linking on Windows arises from conflicts between static and dynamic CRT linkage.

Resolve by adding:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

This tells GoogleTest to also link against the dynamic runtime libraries, matching your project’s settings.

---

## 3. Integrating GoogleTest with Bazel

### 3.1 Setting up your Bazel Workspace

Create your workspace directory and place or generate a `MODULE.bazel` file that references GoogleTest:

```starlark
bazel_dep(name = "googletest", version = "1.17.0")
```

This uses the Bazel Central Registry to pull in the specified GoogleTest version.

### 3.2 Writing Your Test Source and BUILD File

Create your test source file, e.g., `hello_test.cc`:

```cpp
#include <gtest/gtest.h>

TEST(HelloTest, BasicAssertions) {
  EXPECT_STRNE("hello", "world");
  EXPECT_EQ(7 * 6, 42);
}
```

Create a `BUILD` file in the same directory:

```starlark
cc_test(
    name = "hello_test",
    size = "small",
    srcs = ["hello_test.cc"],
    deps = [
        "@googletest//:gtest",
        "@googletest//:gtest_main",
    ],
)
```

### 3.3 Building and Running Your Test

Invoke Bazel with compiler options to specify C++17 support, and run the test:

```bash
bazel test --cxxopt=-std=c++17 --test_output=all //:hello_test
```

> For MSVC, replace `--cxxopt=-std=c++17` with `--cxxopt=/std:c++17`.

### 3.4 Notes and Best Practices

- Always specify the C++ standard flag to ensure consistent compilation
- Use `@googletest//:gtest_main` to get the test main() entry point
- Bazel handles dependencies and linking for GoogleTest internally

---

## 4. Practical Tips & Common Pitfalls

<AccordionGroup title="Key Tips for Smooth Integration">
<Accordion title="Matching Compiler and Linker Settings">
Ensure GoogleTest builds with the same runtime flags, compiler standard, and exception settings as your project to avoid linker errors or runtime crashes.
</Accordion>
<Accordion title="Use FetchContent for Flexibility in CMake">
FetchContent helps you avoid manually managing submodules or copies, simplifies CI builds, and keeps GoogleTest up to date.
</Accordion>
<Accordion title="Windows Dynamic vs Static Runtime Conflict">
Set `gtest_force_shared_crt ON` in your CMake configuration to align runtimes on Windows.
</Accordion>
<Accordion title="Cross-Platform Consistency">
Always specify `CMAKE_CXX_STANDARD 17` and enable pthreads support where relevant to avoid undefined behaviors.
</Accordion>
<Accordion title="Avoid Mixing Shared and Static Libraries Unless Necessary">
Prefer static linking of GoogleTest by default; shared libraries are rarely needed and add complexity.
</Accordion>
</AccordionGroup>

<Warning>
Attempting to build GoogleTest with an older compiler or toolchain that does not support C++17 will result in build failures. Make sure your development environment meets minimum version requirements.
</Warning>

---

## 5. Example: Minimal CMakeLists.txt for GoogleTest Integration

```cmake
cmake_minimum_required(VERSION 3.14)
project(my_project)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)

set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test.cpp)
target_link_libraries(my_tests gtest_main)

enable_testing()
include(GoogleTest)
gtest_discover_tests(my_tests)
```

## 6. Example: Minimal Bazel `BUILD` and `MODULE.bazel`

### MODULE.bazel

```starlark
bazel_dep(name = "googletest", version = "1.17.0")
```

### BUILD

```starlark
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = ["@googletest//:gtest", "@googletest//:gtest_main"],
)
```

## 7. Troubleshooting & Best Practices

### Common Issues

- **Linking errors on Windows**: Usually caused by inconsistent runtime linkage; fix by setting `gtest_force_shared_crt ON` in your CMakeLists.
- **Missing pthread linkage on Linux**: Use provided CMake scripts or manually link `pthread`.
- **Wrong C++ standard version**: Ensure `CMAKE_CXX_STANDARD 17` is set correctly.

### Best Practices

- Regularly update GoogleTest commit hashes or dependency versions.
- Build tests with the same flags and options as your production code.
- Use `gtest_discover_tests()` in CMake for automatic test discovery.
- Use Bazel Central Registry to manage GoogleTest dependency cleanly.

---

## 8. Next Steps & Related Content

- [Installation (Linux, macOS, Windows)](/getting-started/setup-requirements-installation/installation-multiplatform) for system prereqs
- [Writing Your First Test](/getting-started/first-test-usage/write-first-test) to get started writing tests
- [Building and Running Your First Test](/getting-started/first-test-usage/build-and-run-first-test) to understand test execution
- [Troubleshooting & Common Pitfalls](/getting-started/first-test-usage/troubleshooting-setup) for solving setup issues
- [Mocking Dependencies with GoogleMock](/guides/mocking-and-advanced-usage/mocking-with-gmock) for advanced mocking
- [GoogleTest Primer](primer.md) for comprehensive beginner guidance

---