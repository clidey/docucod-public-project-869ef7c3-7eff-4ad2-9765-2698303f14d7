---
title: "Writing Custom Matchers and Actions"
description: "Step-by-step tutorial for designing your own matchers and mock actions. Shows how to optimize verification logic for domain-specific needs and increase test expressiveness."
---

# Writing Custom Matchers and Actions

GoogleMock empowers you to extend its capability by creating **custom matchers** and **mock actions** tailored to your domain-specific testing needs. This guide provides a step-by-step tutorial on designing your own matchers and actions, showing how to optimize verification logic for complex scenarios and increase the expressiveness and maintainability of your tests.

---

## 1. Why Create Custom Matchers and Actions?

In many tests, built-in matchers and actions cover most needs. However, when your domain logic requires specialized validation or side effects, custom matchers and actions allow you to:

- Encapsulate complex argument validations into reusable components.
- Write more readable and intention-revealing test code.
- Reduce duplication and improve maintainability.
- Extend GoogleMock to fit unique and advanced test scenarios.

---

## 2. Understanding Custom Matchers

Matchers allow you to specify the criteria an argument must fulfill when a mock method is called. GoogleMock offers multiple ways to create custom matchers ranging from quick macros to fully typed classes.

### 2.1 Types of Custom Matchers

- **Simple Matchers with `MATCHER` Macros:**
  Rapidly define matchers with minimal boilerplate. Best for straightforward matching logic.

- **Parameterized Matchers with `MATCHER_P` Macros:**
  Define matchers with parameters for flexible, reusable components.

- **Custom Matcher Classes:**
  Create matchers as fully typed classes implementing the matcher interface, ideal for complex logic or extensively reused matchers.

### 2.2 Defining a Simple Custom Matcher

Example: Matcher to check if a number is divisible by 7.

```cpp
MATCHER(IsDivisibleBy7, "Checks if a number is divisible by 7") {
  return (arg % 7) == 0;
}
```

Use it in your test:

```cpp
EXPECT_CALL(mock_obj, DoSomething(IsDivisibleBy7()));
```

### 2.3 Defining a Parameterized Matcher

Example: Matcher checking the absolute value.

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}
```

Use it:

```cpp
EXPECT_THAT(some_value, HasAbsoluteValue(10));
```

### 2.4 Writing a Full Matcher Class

For scenarios where you need detailed control and explanation, implement the matcher interface:

```cpp
#include <gmock/gmock.h>

class BarPlusBazEqMatcher {
 public:
  using is_gtest_matcher = void;

  explicit BarPlusBazEqMatcher(int sum) : expected_sum_(sum) {}

  bool MatchAndExplain(const Foo& foo, std::ostream* listener) const {
    return (foo.bar() + foo.baz()) == expected_sum_;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "bar() + baz() equals " << expected_sum_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "bar() + baz() does not equal " << expected_sum_;
  }

 private:
  int expected_sum_;
};

::testing::Matcher<const Foo&> BarPlusBazEq(int sum) {
  return ::testing::MakeMatcher(new BarPlusBazEqMatcher(sum));
}
```

Use this matcher as:

```cpp
EXPECT_THAT(foo_obj, BarPlusBazEq(5));
```

This matcher clearly communicates why a test failed and how the argument properties are evaluated.

---

## 3. Creating Custom Actions

While matchers focus on verifying arguments, actions define what a mock method does when called.

### 3.1 Why Custom Actions?

Built-in actions cover many use cases (`Return()`, `SetArgPointee()`, `Invoke()`), but custom actions let you:

- Perform complex side effects.
- Compose multiple behaviors.
- Delegate calls dynamically or record detailed information.

### 3.2 Creating a Custom Action Using Lambdas or Functors

Simplest form: provide a callable whose signature is compatible with the mocked method.

```cpp
EXPECT_CALL(mock_obj, Compute(_))
    .WillOnce([](int value) { return value * 42; });
```

This action multiplies the input by 42 and returns it.

### 3.3 Defining a Struct With a Call Operator

For more reusable or stateful actions:

```cpp
struct MultiplyBy {
  int factor;

  int operator()(int value) { return value * factor; }
};

EXPECT_CALL(mock_obj, Compute(_)).WillOnce(MultiplyBy{7});
```

### 3.4 Combining Multiple Actions with `DoAll`

If your mock method must perform multiple side effects and return a value:

```cpp
EXPECT_CALL(mock_obj, Modify(_, _))
  .WillOnce(::testing::DoAll(
      ::testing::SetArgPointee<1>(100),
      ::testing::Return(true)));
```

This example sets the second argument to 100 and returns `true`.

### 3.5 Creating Actions with Parameters using `ACTION_P` Macros

You can create parameterized actions for reusability.

Example:

```cpp
ACTION_P(SetTo, value) {
  *arg0 = value;
}

EXPECT_CALL(mock_obj, Update(_)).WillOnce(SetTo(10));
```

This sets the pointed-to value of the first argument to 10.

---

## 4. Best Practices for Custom Matchers and Actions

- **Keep Matchers Pure:** Avoid side effects in matchers; they may be invoked multiple times.
- **Descriptive Messages:** Provide clear descriptions in matchers for easier debugging.
- **Reuse Parameterized Matchers:** Use parameters to make matchers flexible and avoid code duplication.
- **Prefer Lambdas for Simple Actions:** Lambdas provide concise syntax and are easy to write inline.
- **Use `DoAll` to Combine Actions:** Chain side effects neatly within one expectation.

---

## 5. Common Pitfalls and Troubleshooting

<AccordionGroup title="Common Issues and Fixes">
<Accordion title="Matcher Does Not Compile or Matches Incorrectly">
Ensure the matcher is properly typed and const-correct. Use `MATCHER` macros or implement the required interface correctly. Use `SafeMatcherCast<T>()` when matching types that need safe conversions.
</Accordion>
<Accordion title="Action Does Not Execute or Has Unexpected Behavior">
Verify that the callable's signature matches the mocked function's signature exactly. If it captures state, ensure the lifetime is stable during test execution.
</Accordion>
<Accordion title="Unintended Multiple Matcher Invocations Leads to Side Effects">
Avoid side effects inside matchers as GoogleMock may call them multiple times. Use actions or external state to intentionally cause side effects instead.
</Accordion>
<Accordion title="Mock Method Fails to Match Custom Matcher">
Check argument types and overloads; use explicit type casts or wrappers like `MatcherCast<T>()` to resolve conflicts and clarify overloaded method references.
</Accordion>
</AccordionGroup>

---

## 6. Step-by-Step Example: Implementing a Custom Matcher and Action

Let's walk through creating a custom matcher and action.

### 6.1 Scenario
You have a class `Widget` with a method `ProcessData(const Data&)`. You want to test `ProcessData` but only when `Data` satisfies a domain-specific property, e.g., sum of two fields equals a target, and you want the mock action to log the processed data.

### 6.2 Define the Custom Matcher

```cpp
#include <gmock/gmock.h>

class Data {
 public:
  int x() const;
  int y() const;
};

MATCHER_P(SumEquals, target, "Checks if sum of x and y equals target") {
  return arg.x() + arg.y() == target;
}
```

### 6.3 Use the Matcher in Expectation

```cpp
EXPECT_CALL(mock_widget, ProcessData(SumEquals(42)))
    .Times(1);
```

### 6.4 Define a Custom Action

```cpp
struct LogProcess {
  bool operator()(const Data& data) {
    std::cout << "Processing data with sum: " << (data.x() + data.y()) << std::endl;
    return true;
  }
};
```

### 6.5 Use the Custom Action

```cpp
EXPECT_CALL(mock_widget, ProcessData(_))
    .WillOnce(LogProcess());
```

This test verifies that `ProcessData` is called with `Data` where `x + y == 42`, and when it is called, it logs the sum.

---

## 7. Next Steps & Related Topics

- **Effective Mocking with GoogleMock:** Deepen your understanding of mock classes and expectations.
- **Matchers and Actions API Reference:** Dive into all the built-in matchers and actions for more advanced use.
- **Writing Your First C++ Test:** Learn test writing techniques that combine with custom matchers.
- **Parameterized and Typed Tests:** Learn to reuse tests with different data, enhanced by custom matchers.


---

<Info>
Creating custom matchers and actions enables precise, domain-focused test validations and behaviors, increasing the power and clarity of your tests. Start simple; iterate to create expressive, maintainable, and robust test code.
</Info>

<Source url="https://github.com/google/googletest" paths={[{"path": "docs/gmock_cook_book.md", "range": "1-349"},{"path": "docs/reference/mocking.md", "range": "1-185"}]}/>
