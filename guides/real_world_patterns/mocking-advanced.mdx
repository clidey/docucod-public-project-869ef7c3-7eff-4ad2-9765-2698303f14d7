---
title: "Advanced Mocking Patterns and Behaviors"
description: "Explore real-world strategies to mock more sophisticated interactions including chained calls, custom actions, strict vs. nice mocks, and failure diagnostics. Ideal for complex projects with intricate dependencies."
---

# Advanced Mocking Patterns and Behaviors

Explore real-world strategies to mock more sophisticated interactions including chained calls, custom actions, strict vs. nice mocks, and failure diagnostics. This page is tailored for complex projects with intricate dependencies aiming to master advanced mocking techniques with GoogleMock.

---

## 1. Overview

### What You Will Learn
This guide empowers you to go beyond basic mocking by mastering:

- Chained and conditional mock calls
- Delegating calls to fakes, real objects, or parent classes
- Controlling mock strictness: Nice, Naggy, and Strict mocks
- Diagnostics and troubleshooting advanced mocking scenarios

### Prerequisites

Before proceeding, ensure:

- You have defined mock classes using `MOCK_METHOD` macros.
- Basic familiarity with `EXPECT_CALL` and `ON_CALL` behaviors.
- Comfortable with GoogleMock’s core mocking and matchers (see the [Core Mocking Basics guide](../core_workflows/mocking-basics.md)).

### Expected Outcome

By following this guide, you'll be able to:

- Create flexible mocks that accurately mimic complex behavior
- Control how your mocks respond to uninteresting calls and enable or prevent warnings
- Use delegation techniques to combine mocks with real or fake objects
- Write maintainable tests that remain robust over time

### Time Estimate: 30–45 minutes

Difficulty: Intermediate to Advanced

---

## 2. Advanced Mocking Patterns

### 2.1 Chained Calls and Expectations

GoogleMock supports setting multiple behaviors for sequential calls with `WillOnce()` and then a default `WillRepeatedly()`.

```cpp
EXPECT_CALL(mock_obj, Method())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(0));
```

**What happens:** The first call returns 1, the second 2, all later calls return 0.

**Use case:** You want to simulate state changes or responses evolving over time.

---

### 2.2 Delegating Calls

#### 2.2.1 Delegating to a Fake Implementation

Sometimes you want to combine the validation power of mocks with a real or fake implementation that contains business logic. The mock delegates calls not explicitly mocked.

```cpp
class Fake : public Interface {
 public:
  int DoWork(int x) override { return x * 2; }
};

class MockWithFake : public Interface {
 public:
  MOCK_METHOD(int, DoWork, (int x), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoWork).WillByDefault(
        [this](int x) { return fake_.DoWork(x); });
  }

 private:
  Fake fake_;
};

// Usage
MockWithFake mock;
mock.DelegateToFake();
EXPECT_CALL(mock, DoWork(5));
int result = mock.DoWork(5); // Calls Fake::DoWork(5)
```

---

#### 2.2.2 Delegating to a Real Object

Like fakes, mock behavior can be forwarded to a real instance, allowing behavioral verification without altering logic.

```cpp
class RealClass {
 public:
  int Compute(int x) { return x + 42; }
};

class MockReal : public RealClass {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));

  MockReal() {
    ON_CALL(*this, Compute).WillByDefault(
        [this](int x) { return real_.Compute(x); });
  }

 private:
  RealClass real_;
};
```

---

#### 2.2.3 Delegating to Parent Class Methods

If the base class has a concrete method you want to call (instead of mocking), do this explicitly inside the action:

```cpp
EXPECT_CALL(mock_obj, ConcreteMethod(_))
    .WillOnce([&mock_obj](int x) { return mock_obj.Interface::ConcreteMethod(x); });
```

_Note:_ Calling `mock_obj.ConcreteMethod(x)` directly causes infinite recursion.

---

### 2.3 Custom Actions for Complex Behavior

Define your own actions with lambdas or functors, enabling complex side effects, chained changes, logging, or callback invocation.

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce([](int x) {
  Log("Foo called with", x);
  return x * 10;
});
```

Combine actions with `DoAll`:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

Here, the output argument (second) is set to 42, and function returns `true`.

---

### 2.4 Chaining and Ordering Expectations

Control the sequence of calls with `InSequence` or `After` clauses:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}

// or
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Run()).After(e1);
```

These enforce call ordering, preventing flaky test behaviors.

---

## 3. Strictness Control: Nice, Naggy, and Strict Mocks

### 3.1 Understanding Strictness Modes

By default, mock objects warn on uninteresting calls (methods called without an `EXPECT_CALL`). GoogleMock provides three wrappers:

| Wrapper               | Behavior on Uninteresting Calls                          | Usage Example                              |
| --------------------- | ------------------------------------------------------- | ----------------------------------------- |
| `NiceMock<T>`         | Suppresses warnings; calls proceed silently             | `NiceMock<MockFoo> mock;`                  |
| `NaggyMock<T>` (default) | Prints warnings but allows calls                        | `NaggyMock<MockFoo> mock;` (default)      |
| `StrictMock<T>`       | Treats uninteresting calls as test failures             | `StrictMock<MockFoo> mock;`                 |

### 3.2 When to Use Which

- Use **NiceMock** for tests where uninteresting calls are expected or not important.
- Use **NaggyMock** during test development to notice unexpected calls.
- Use **StrictMock** to enforce strict call patterns for critical code paths.

### 3.3 How to Use

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockClass> nice_mock;
StrictMock<MockClass> strict_mock;
```

Both behave like their base class but modify behavior on uninteresting call warnings.

### 3.4 Caveats

- Only works on mock methods directly defined via `MOCK_METHOD` in the mock class.
- Might have incomplete effect with mock methods in base classes.
- Your mock class's destructor should be virtual for best results.

---

## 4. Failure Diagnostics and Troubleshooting

### 4.1 Understanding Uninteresting vs. Unexpected Calls

- **Uninteresting call**: Calls to methods without `EXPECT_CALL`. By default, these trigger warnings.
- **Unexpected call**: Calls that do not match any active `EXPECT_CALL`. Always cause test failures.

### 4.2 Debugging Techniques

- Run tests with `--gmock_verbose=info` to get detailed logs of expectations and matching calls.
- Check call order when using sequences or `After` clauses to verify correctness.
- Use `RetiresOnSaturation()` to avoid «sticky» expectations causing unintended failures.

### 4.3 Common Pitfalls

- Setting expectations after the mock method is already called leads to undefined behavior.
- Overly strict expectations make tests brittle.
- Using too many `EXPECT_CALL`s without `ON_CALL` for defaults can cause verbosity and complexity.

### 4.4 Best Practices

- Use `ON_CALL` to set default/mock behaviors, and use `EXPECT_CALL` sparingly for actual verification.
- Group related expectations into sequences when order matters.
- Use `NiceMock` to silence warnings unless strict failure is required.

---

## 5. Examples

### 5.1 Delegating to a Fake

```cpp
class Interface {
 public:
  virtual int Compute(int x) = 0;
};

class Fake : public Interface {
 public:
  int Compute(int x) override { return x * 2; }
};

class Mock : public Interface {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));

  void DelegateToFake() {
    ON_CALL(*this, Compute).WillByDefault(
        [this](int x) { return fake_.Compute(x); });
  }

 private:
  Fake fake_;
};

TEST(MyTest, Delegation) {
  Mock mock;
  mock.DelegateToFake();
  EXPECT_CALL(mock, Compute(5));
  EXPECT_EQ(mock.Compute(5), 10);
}
```

### 5.2 Using StrictMock

```cpp
using ::testing::StrictMock;

StrictMock<MockFoo> mock;
EXPECT_CALL(mock, DoSomething());

// Calls to methods without EXPECT_CALL will fail.
mock.UnexpectedMethod();  // Fails here.
```

### 5.3 Chained Call Responses

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(0));

EXPECT_EQ(mock.GetValue(), 1);
EXPECT_EQ(mock.GetValue(), 2);
EXPECT_EQ(mock.GetValue(), 0);
EXPECT_EQ(mock.GetValue(), 0);
```

---

## 6. Next Steps

- Explore the [Mocking Basics guide](../core_workflows/mocking-basics.md) for foundational knowledge.
- Learn about [Matchers and Actions](../core_architecture/matchers-actions.md) for crafting precise expectations.
- Dive into the [NiceMock, NaggyMock, and StrictMock Explained](../behavior-strictness/mock-strictness-levels.md) concept page for deeper understanding.
- For troubleshooting, see [Troubleshooting Common Setup Issues](../../getting-started/configuration-validation/troubleshooting-common-issues.md).

---

## 7. Additional Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) - comprehensive recipes and examples
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) - quick syntax reference
- [Core Concepts and Terminology](../../overview/architecture-and-concepts/core-concepts-terminology.md) - to review essential terms

---

<Tip>
Use `NiceMock` for wide tolerance in early or exploratory tests, and apply `StrictMock` selectively to enforce strict interaction contracts.
</Tip>

<Warning>
Avoid setting expectations after the mocked methods have been called; this leads to undefined behavior and unreliable tests.
</Warning>

<Note>
Delegation to fakes or real objects adds test robustness by preserving business logic behavior while enabling call verification.
</Note>

---