---
title: "Advanced Mocking Strategies and Patterns"
description: "Move beyond basic mocking with custom actions, expected call patterns, and fine-grained behavior control. Examples include using NiceMock/StrictMock, chaining actions, and parameter-based call restrictions."
---

# Advanced Mocking Strategies and Patterns

GoogleTest’s GoogleMock enables far more than basic mocking. This guide helps you master advanced mocking techniques that give you precise control over mock behavior, call verification patterns, and complex interaction scenarios. You will learn how to use mock strictness types such as `NiceMock` and `StrictMock`, chain multiple actions, and apply parameter-based call restrictions to build robust, maintainable tests.

---

## Workflow Overview

### What This Guide Helps You Accomplish
- Move beyond basic EXPECT_CALL and ON_CALL usage.
- Use advanced mock wrappers like `NiceMock` and `StrictMock` to control uninteresting call behavior.
- Chain multiple actions to customize mock method behavior flexibly.
- Define fine-grained expectations with parameter-based call restrictions and invocation order control.

### Prerequisites
- Basic familiarity with GoogleMock's mock class creation, `EXPECT_CALL`, and `ON_CALL`.
- Understanding of argument matchers, actions, and cardinalities.
- A working GoogleTest and GoogleMock environment.

### Expected Outcome
By following this guide, you will be able to:
- Create mocks with customized strictness levels.
- Define sequences and partial orders of mock method calls.
- Compose complex behaviors using multiple chained actions.
- Write expectations that depend on argument values and call ordering.

### Time Estimate
Estimated 30-45 minutes to read and experiment with the provided examples.

### Difficulty Level
Intermediate to Advanced

---

## Step-by-Step Instructions

### 1. Using Mock Strictness Wrappers: NiceMock, NaggyMock, and StrictMock

GoogleMock provides three wrappers that alter warnings and failures for uninteresting calls:

- `NiceMock<T>`: suppresses warnings for calls without expectations, making your test less noisy.
- `NaggyMock<T>`: (default behavior) prints warnings for uninteresting calls.
- `StrictMock<T>`: treats all uninteresting calls as test failures.

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

class MockFoo {
 public:
   MOCK_METHOD(void, DoSomething, (), (override));
};

// Nice mock instance ignores uninteresting calls
NiceMock<MockFoo> nice_mock;
EXPECT_CALL(nice_mock, DoSomething());
nice_mock.DoSomething();  // OK
nice_mock.UnexpectedMethod(); // No warning

// Strict mock instance treats unexpected calls as errors
StrictMock<MockFoo> strict_mock;
EXPECT_CALL(strict_mock, DoSomething());
strict_mock.DoSomething();  // OK
strict_mock.UnexpectedMethod(); // Test failure
```

<Note>
`NiceMock` and `StrictMock` only handle methods declared directly in the mock class, and require the mock class to have a virtual destructor to work correctly.
</Note>

### 2. Chaining Actions in EXPECT_CALL

You can specify what a mock method does on each call by chaining multiple `.WillOnce()` clauses followed by an optional `.WillRepeatedly()` clause.

```cpp
using ::testing::Return;

EXPECT_CALL(mock_obj, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));

// Calls to GetValue() return 10, then 20, then 30 repeatedly.
```

If you want to perform multiple side effects or actions in one mock invocation, use `DoAll()` to chain them:

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;

EXPECT_CALL(mock_obj, ProcessData(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));

// Sets the second argument to 5 and returns true.
```

### 3. Controlling Call Counts and Order

GoogleMock lets you specify exactly how many times a method should be called and enforce call order when necessary.

- Use `.Times()` with cardinalities like `Exactly(n)`, `AtLeast(n)`, or `AnyNumber()`.

- To enforce call order for multiple calls, use `InSequence` or `Sequence` objects.

**Example: Enforcing strict call order**

```cpp
using ::testing::InSequence;
{
  InSequence seq;

  EXPECT_CALL(mock_obj, Initialize());
  EXPECT_CALL(mock_obj, Process());
  EXPECT_CALL(mock_obj, Cleanup());
}

// Calls to Initialize(), Process(), Cleanup() must happen in that order.
```

**Example: Partial ordering with Sequence**

```cpp
using ::testing::Sequence;

Sequence s1, s2;
EXPECT_CALL(mock_obj, First())
    .InSequence(s1, s2);
EXPECT_CALL(mock_obj, Second())
    .InSequence(s1);
EXPECT_CALL(mock_obj, Third())
    .InSequence(s2);

// 'First' must occur before 'Second' and 'Third', but 'Second' and 'Third' ordering doesn't matter.
```

### 4. Parameter-Based Call Restrictions

You can limit matching calls to those whose arguments satisfy complex conditions using matchers and `.With()` clauses.

```cpp
using ::testing::Lt;
using ::testing::_;

EXPECT_CALL(mock_obj, SetPosition(_, _))
    .With(Lt())  // All arguments tuple is compared: first < second
    .Times(1);

mock_obj.SetPosition(3, 5);  // Matches
mock_obj.SetPosition(5, 3);  // Does NOT match
```

The `.With()` clause accepts a matcher on a tuple of all arguments and must be used before `.Times()`.

### 5. Using ON_CALL for Default Behaviors

Use `ON_CALL` to specify default behaviors for method calls without setting expectations.

```cpp
using ::testing::Return;

ON_CALL(mock_obj, GetName())
    .WillByDefault(Return("default"));

// Calls to GetName() with no expectation return "default" without causing warnings.
```

Combine with `EXPECT_CALL` for calls you want to verify.

### 6. Retiring Expectations on Saturation

By default, expectations stay active even after being satisfied ("sticky"). This can cause errors if exceeded. Use `.RetiresOnSaturation()` to deactivate an expectation after it is matched the specified number of times.

```cpp
EXPECT_CALL(mock_obj, Add(7))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock_obj, Add(_))
    .Times(::testing::AnyNumber());

// Two calls to Add(7) match first expectation, which retires after 2 calls.
// Subsequent calls to Add(7) match catch-all expectation.
```

---

## Examples

### Example 1: Using `NiceMock` to Suppress Uninteresting Call Warnings

```cpp
#include <gmock/gmock.h>
using ::testing::NiceMock;
using ::testing::_;

class Interface {
 public:
  virtual ~Interface() {}
  virtual int Compute(int a) = 0;
};

class MockInterface : public Interface {
 public:
  MOCK_METHOD(int, Compute, (int a), (override));
};

TEST(MyTest, NiceMockExample) {
  NiceMock<MockInterface> mock;

  EXPECT_CALL(mock, Compute(5))
      .WillOnce(::testing::Return(10));

  // Call with expected arg
  EXPECT_EQ(mock.Compute(5), 10);

  // Call with unexpected arg, no warning due to NiceMock
  mock.Compute(42);
}
```

### Example 2: Chaining Actions with `DoAll` and `WillOnce`

```cpp
using ::testing::DoAll;
using ::testing::Return;
using ::testing::SetArgPointee;

EXPECT_CALL(mock_obj, UpdateValue(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));

int output; 
EXPECT_TRUE(mock_obj.UpdateValue(10, &output));
EXPECT_EQ(output, 42);
```

### Example 3: Enforcing Partial Order of Calls

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Setup())
    .InSequence(s1, s2);
EXPECT_CALL(mock, Initialize())
    .InSequence(s1);
EXPECT_CALL(mock, Finalize())
    .InSequence(s2);

// Setup must be called before Initialize and Finalize;
// Initialize and Finalize can occur in any order relative to each other.
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting Call Warnings:** If your test outputs warnings about uninteresting calls, consider using `NiceMock` to suppress them or explicitly set permissive expectations with `.Times(AnyNumber())`.

- **Unexpected Calls Failures:** Unexpected calls occur when a call matches no active expectation. Check that your expectations cover all intended calls or use catch-all expectations as needed.

- **Sticky Expectations Causing Upper-Bound Violations:** Use `.RetiresOnSaturation()` to prevent expectations from blocking calls after their limit is reached.

- **Order-Related Failures:** Use `InSequence` or `Sequence` to control expectations’ call order. Remember that sequences impose strict, partial ordering.

### Best Practices

- Use `ON_CALL` to set default behaviors shared across tests without asserting call counts.
- Reserve `EXPECT_CALL` for verifying actual interactions.
- Prefer `NiceMock` in tests to reduce noise but switch to `StrictMock` when unintentional calls must be prevented.
- Chain multiple `.WillOnce()` calls for predictable per-call behaviors.
- Use `.With()` to create expectations that depend on complex relationships among arguments.
- Use sequences for specifying call order only when order truly matters to avoid brittle tests.

---

## Next Steps & Related Content

- See [Mocking Functions and Classes: The Basics](/guides/getting_started/mocking_basics) to get familiar with mock creation.
- Explore [Mocking Cookbook](/gmock_cook_book) for advanced mocking recipes and patterns.
- Consult [Actions and Expectations](/api-reference/mocking-apis/actions-and-expectations) for a detailed reference on modifying mock behaviors.
- Learn about [Matchers](/api-reference/mocking-apis/argument-matchers) to fine-tune argument validations.
- For test maintenance, read [Test Maintenance and Refactoring Patterns](/guides/practical_tips_and_patterns/test_maintenance_best_practices).

---

This page fits within the practical tips and patterns for writing robust GoogleMock tests, providing users with techniques to enhance control, maintainability, and expressiveness of their mocks.

---