---
title: "Writing Your First Mock and Using Expectations"
description: "Guide users through crafting a simple mock using GoogleMock, introducing the core concepts of method mocking, expectations, and verifying behavior. Illustrates common patterns and the basics of ON_CALL and EXPECT_CALL macros."
---

# Writing Your First Mock and Using Expectations

Welcome to the foundational guide on mocking using GoogleMock. This document walks you through creating a simple mock class, setting expectations on mock methods, and verifying the interactions with those mocks. We focus on the core concepts behind GoogleMock’s powerful `MOCK_METHOD`, `EXPECT_CALL`, and `ON_CALL` macros, enabling you to write clear, maintainable, and reliable mock-based tests.

---

## 1. Objective and Scope

This page helps you:

- Define a mock class with mocked methods using `MOCK_METHOD`.
- Set behavioral specifications on mocks with `ON_CALL`.
- Set and verify call expectations with `EXPECT_CALL`.
- Understand cardinalities specifying how many times a mock method is expected to be called.
- Learn how to use basic clauses and modifiers in `EXPECT_CALL` and `ON_CALL`.

By the end of this guide, you'll be equipped to write your first mock and use expectations to verify behaviors in your tests.

---

## 2. Prerequisites

Before starting, ensure:

- You have included `<gmock/gmock.h>` in your test files.
- Basic familiarity with C++ virtual functions and unit testing.
- An existing interface or abstract class with virtual methods to mock.

---

## 3. Creating a Mock Class with `MOCK_METHOD`

To mock a class, inherit from its interface or base class and declare mock methods in the `public` section using the `MOCK_METHOD` macro.

### Syntax

```cpp
class MockClass {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Specifiers));
};
```

- `ReturnType`: The return type of the mocked method.
- `MethodName`: The name of the method to mock.
- `(Args...)`: The argument list in parentheses.
- `(Specifiers)`: Optional qualifiers like `const`, `override`, and calling convention annotations.

### Key notes

- All mock methods must be placed under `public:` regardless of base class access specifiers.
- Overloaded methods can be mocked as usual by specifying their exact signatures.
- To mock const methods, add `(const, override)` as specifiers.

### Dealing with complex types or commas in arguments

Wrap return or argument types containing commas in parentheses or use type aliases.

```cpp
class MockFoo {
 public:
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  // or use an alias
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
};
```

### Example

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

---

## 4. Specifying Mock Behavior with `ON_CALL`

`ON_CALL` defines the default behavior when a mock method is invoked without setting an expectation that it must be called.

### Syntax

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);        // Mandatory
```

- Does not enforce that the method must be called.
- Defines the fallback/normal behavior for matching calls not covered by expectations.

### Typical usage

```cpp
ON_CALL(mock_turtle, GetX())
    .WillByDefault(Return(0));
```

If you omit `ON_CALL`, GoogleMock provides a built-in default action: returning zero, `false`, or default constructed objects.

### `.With` clause

Used to match composite argument conditions when the arguments as a whole must satisfy a predicate.

---

## 5. Setting Expectations with `EXPECT_CALL`

The core of mock verification lies in setting expectations about how, when, and how many times mock methods are called.

### Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher) // Optional
    .Times(cardinality)           // Optional but affects verification
    .InSequence(sequences...)     // Optional
    .After(expectations...)       // Optional
    .WillOnce(action)             // Zero or more
    .WillRepeatedly(action)       // Optional
    .RetiresOnSaturation();       // Optional
```

### Behavioral summary

- **Call Matching:** Mock will check for calls matching the provided argument matchers.
- **Cardinality:** Specifies how many times the method is expected to be called. If omitted, defaults to `Times(1)` or inferred based on actions.
- **Sequencing:** Enforces call order with `InSequence` and `After`.
- **Actions:** Define what happens when matched calls occur.

### Example

```cpp
using ::testing::Return;
using ::testing::AtLeast;

EXPECT_CALL(mock_turtle, Forward(100))
    .Times(AtLeast(1))
    .WillRepeatedly(Return());
```
This expects `Forward(100)` to be called one or more times.

### Important `Times` cardinalities

| Cardinality      | Meaning                                  |
| ---------------- | ---------------------------------------- |
| `Exactly(n)`     | Called exactly `n` times.                 |
| `AtLeast(n)`     | Called at least `n` times.                |
| `AtMost(n)`      | Called at most `n` times.                 |
| `Between(m, n)`  | Called between `m` and `n` times, inclusive. |
| `AnyNumber()`    | Called any number of times (including zero). |

You can also specify `Times(0)` to explicitly disallow particular calls.

### Using `.WillOnce` and `.WillRepeatedly`

- Chain multiple `.WillOnce()` to specify behaviors on successive calls.
- Use `.WillRepeatedly()` to specify behavior on all calls after `.WillOnce()` clauses are exhausted.

### Enforcing call order

Wrap `EXPECT_CALL`s in an `InSequence` block or chain `.After()` clauses to specify call order.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock_turtle, PenDown());
  EXPECT_CALL(mock_turtle, Forward(100));
}
```

---

## 6. Verifying Mock Calls

- GoogleMock verifies all expectations are met when a mock object is destroyed.
- You may explicitly verify expectations earlier with `Mock::VerifyAndClearExpectations(&mock_object);`.

---

## 7. Practical Example: Write and Use a Simple Mock

### Step 1 - Define the mock class

```cpp
#include <gmock/gmock.h>

class MyInterface {
 public:
  virtual ~MyInterface() = default;
  virtual int Compute(int x) = 0;
};

class MockMyInterface : public MyInterface {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));
};
```

### Step 2 - Setup test with expectations

```cpp
#include <gtest/gtest.h>

using ::testing::Return;

TEST(MockExample, VerifyComputeCall) {
  MockMyInterface mock;

  // Set default behavior (optional)
  ON_CALL(mock, Compute).WillByDefault(Return(42));

  // Expect Compute(5) to be called twice, returning 10 and then 20
  EXPECT_CALL(mock, Compute(5))
      .Times(2)
      .WillOnce(Return(10))
      .WillOnce(Return(20));

  // Exercise the mock
  EXPECT_EQ(mock.Compute(5), 10);
  EXPECT_EQ(mock.Compute(5), 20);
}
```

### Step 3 - Build and run tests

- Follow your build system steps.
- The test will fail if any calls outstanding or unexpected.

---

## 8. Best Practices & Tips

- Use `ON_CALL()` to specify default behavior without requiring calls.
- Use `EXPECT_CALL()` to explicitly verify call counts and arguments.
- Avoid over-specifying expectations to keep tests robust.
- Use `InSequence` for strict call ordering.
- Use `_` matcher to ignore unimportant arguments.
- To suppress warnings on uninteresting calls, consider wrapping mocks with `NiceMock`.
- Use `.RetiresOnSaturation()` for expectations that should deactivate when fully satisfied.

<Tip>
Always specify expectations before the code under test invokes the mock methods to ensure proper verification and error reporting.
</Tip>

<Tip>
If you see annoying "Uninteresting call" warnings, prefer using `NiceMock` or adding a catch-all expectation using `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());`
</Tip>

---

## 9. Troubleshooting Common Issues

- **Unexpected calls:** Occur when a method is called without matching any `EXPECT_CALL`. Check argument matchers and add missing expectations.
- **Excessive calls:** Occur when calls exceed the specified cardinality. Adjust `.Times()` or use sequences to model the expected usage.
- **Uninteresting calls warnings:** If expected, suppress with `NiceMock` or explicit catch-all; if unexpected, verify code correctness.
- **Compilation errors with `MOCK_METHOD`:** Ensure proper parentheses for return or argument types with commas.

Refer to [Troubleshooting Common Issues](/getting-started/first-test-troubleshooting/troubleshooting-common-issues) for more.

---

## 10. Additional Resources & Next Steps

- [Mocking Reference](../reference/mocking.md) — for deeper API understanding.
- [gMock Cookbook](../gmock_cook_book.md) — practical recipes and advanced usage.
- [Essential Assertions and Matchers](../getting-started/basic-assertions.md) — to strengthen test validations.
- [Structuring Tests with Fixtures and Suites](../common-workflows/test-fixtures.md) — to organize tests effectively.
- [Setting Up and Running Your First Test](../getting-started/setup-quickstart.md) — for initial environment setup.

---

By mastering `MOCK_METHOD`, `ON_CALL`, and `EXPECT_CALL`, you establish a solid foundation for interaction testing with GoogleMock — empowering you to write precise and maintainable tests that catch issues early and make your codebase more robust.
