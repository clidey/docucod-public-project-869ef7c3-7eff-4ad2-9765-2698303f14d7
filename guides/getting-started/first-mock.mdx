---
title: "Mocking with GoogleMock: The Basics"
description: "A beginner-friendly guide to mocking dependencies in C++ tests. Covers creating mock classes, setting expectations, and verifying interactions using GoogleMock's core features."
---

# Mocking with GoogleMock: The Basics

## Overview

This guide introduces you to the essential concepts and techniques for mocking dependencies in C++ tests using GoogleMock. It covers how to create mock classes, set expectations on mocked methods, define their behavior, and verify interactions—all with practical examples and clear guidance.

Whether you are writing your first mock or looking to solidify your foundation, this step-by-step guide walks you through the core workflow of using GoogleMock's core features.

---

## Prerequisites

Before starting, ensure that:

- You have GoogleMock (gMock) installed and properly integrated into your build environment.
- Your project is set up to compile and link against gMock and GoogleTest.
- You understand basic C++ and are familiar with virtual methods and inheritance.

If not, refer to the [System Requirements](https://google.github.io/googletest/getting-started/prerequisites-installation/system-requirements) and [Installing with CMake](https://google.github.io/googletest/getting-started/prerequisites-installation/installation-cmake).

---

## Expected Outcome

By following this guide, you will be able to:

- Define mock classes for interfaces or abstract classes using the `MOCK_METHOD` macro.
- Create mock objects in tests and specify expectations on their methods.
- Configure how mocked methods respond to calls using actions like `Return()`.
- Understand argument matchers to control which calls satisfy your expectations.
- Use cardinalities to specify how many times methods are expected to be called.
- Verify that your code interacts correctly with dependencies, catching expectation violations early.

---

## Time Estimate

Completing the entire workflow, including writing and running a test with mocked dependencies, should take approximately 30 to 45 minutes for beginners.

---

## Difficulty Level

Beginner

---

# Step-by-Step Instructions

### 1. Define a Mock Class

Your first step in mocking with GoogleMock is to define a mock class that implements the interface of the dependency you want to mock.

#### How to Define a Mock Class

- Derive a new class from the target interface or abstract base class.
- For every virtual method you want to mock, declare a mock method in the public section of your mock class using the `MOCK_METHOD` macro.

The syntax for `MOCK_METHOD` is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
```

- `ReturnType` is the return type of the mocked method.
- `MethodName` is the name of the method.
- The third parameter is a parenthesized list of argument types.
- The optional fourth parameter may include qualifiers like `const` and `override`.

#### Example

Imagine you have a simple interface representing a turtle for graphics:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}

  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};
```

You can define a mock class like this:

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

This macro expansion creates the necessary mock implementations, so you don't write them manually.

---

### 2. Create Mock Objects and Specify Expectations in Tests

Once you have a mock class, you can use it in your test functions to verify that your system interacts with its dependencies correctly.

#### General Workflow

1. Include the mock class header and GoogleMock headers (`<gmock/gmock.h>`).
2. Write test cases using GoogleTest (`TEST` or `TEST_F`) macros.
3. Instantiate mock objects.
4. Use `EXPECT_CALL` to specify expectations on the mock methods, describing:
   - Which methods should be called
   - How many times (cardinality)
   - With what argument matchers
   - What the method should do (actions)
5. Execute the code under test.
6. GoogleMock will automatically verify that all expectations were met when mock objects are destructed (or earlier if you call verification functions explicitly).

#### Setting Expectations Syntax

The basic syntax of `EXPECT_CALL` is:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `mock_object` is the mock instance.
- `Method` is the method name.
- `matchers...` specify what arguments you expect (e.g., exact values or wildcard `_`).
- `.Times()` indicates how many times the call is expected.
- `.WillOnce()` and `.WillRepeatedly()` specify the method’s behavior.

#### Example

Suppose you want to verify that the turtle's `PenDown` method is called at least once:

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));

  Painter painter(&turtle);
  painter.DrawCircle(0, 0, 10);
}
```

Here, `Painter` is your production code depending on `Turtle`. The test fails immediately if `PenDown()` is not called at least once during `DrawCircle`.

---

### 3. Use Argument Matchers to Control Expected Arguments

You don’t have to specify exact argument values every time. Use matchers to express general expectations.

- `_` matches any value (wildcard).
- `Eq(value)` matches equal to `value`.
- `Ge(n)` matches values greater or equal to `n`.
- Custom or combined matchers can be created.

Example: Expect any call where the turtle moves `Forward` by at least 100 units:

```cpp
EXPECT_CALL(turtle, Forward(Ge(100)));
```

If you don’t care about arguments, omit the parameter list for non-overloaded methods:

```cpp
EXPECT_CALL(turtle, PenUp);
```

---

### 4. Set How Many Times a Method Should Be Called (Cardinality)

Control the number of allowed calls with the `.Times()` clause:

| Cardinality   | Description                          |
|---------------|------------------------------------|
| `Times(0)`    | The method must **not** be called. |
| `Times(1)`    | Exactly once (default if omitted). |
| `AtLeast(n)`  | At least *n* times.                 |
| `AtMost(n)`   | At most *n* times.                  |
| `Between(m,n)`| Between *m* and *n* times.          |
| `AnyNumber()` | Any number of times.                |

Examples:

```cpp
EXPECT_CALL(turtle, GoTo(0, 0)).Times(2);  // Expected exactly twice.
EXPECT_CALL(turtle, GoTo(_, _)).Times(AnyNumber());  // Allow any number of calls with any args.
```

If `.Times()` is omitted, GoogleMock infers cardinality based on the presence of `.WillOnce()` and `.WillRepeatedly()` clauses.

---

### 5. Define What the Mock Method Does (Actions)

By default, mock methods return default values.

You can customize the behavior with `WillOnce()` and `WillRepeatedly()`:

- `Return(value)`: returns a specified value.
- `ReturnRef(variable)`: returns a reference.
- `Invoke(function)`: invokes an actual function or functor.
- `SetArgPointee<N>(value)`: sets the pointed-to value of the Nth argument.
- `DoAll(action1, action2, ...)`: performs multiple actions in sequence.

Example:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillRepeatedly(Return(200));
```

This means first call returns 100, subsequent calls 200.

---

### 6. Enforce Call Order with Sequences

By default, calls may happen in any order.

To require calls to occur in a specific order, use `InSequence`:

```cpp
{
  InSequence s;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

This block ensures those mock calls happen exactly in that order.

---

### 7. Run and Verify Your Tests

Run your tests as usual. GoogleMock automatically verifies all expectations on destruction of mock objects.

If any expectation is violated (e.g., method called too few or too many times, called with unexpected arguments, or out of order), GoogleMock reports a failure with detailed diagnostics.

---

## Practical Tips & Common Pitfalls

- **Set expectations *before* exercising mock methods.**  gMock expects `EXPECT_CALL`s to be established prior to method invocations.
- **Qualifier correctness:** Ensure that mocked methods match base class qualifiers (`const`, `override`).
- **Mock only virtual methods:** Non-virtual methods can’t be mocked directly (except with advanced techniques).
- **Use `_` for arguments you don't care about:** Avoid over-specifying expectations.
- **Be mindful of call counts:** Set `.Times()` carefully to match your intent.
- **Avoid side-effects inside matchers and `EXPECT_CALL` macros:** The macro arguments are evaluated only once.
- **Leaked mocks won’t verify expectations:** Make sure mock objects are destroyed at test end or verify explicitly.
- **Use `NiceMock` to suppress warnings about unexpected uninteresting calls, `StrictMock` to turn them into failures.**

---

## Example Walkthrough

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

// Interface
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

// Mock class
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

// Code under test
class Painter {
 public:
  explicit Painter(Turtle* turtle) : turtle_(turtle) {}

  void Draw() {
    turtle_->PenDown();
    turtle_->Forward(100);
  }

 private:
  Turtle* turtle_;
};

// Test
using ::testing::AtLeast;
using ::testing::_;
using ::testing::Return;

TEST(PainterTest, DrawCallsTurtleCorrectly) {
  MockTurtle mock_turtle;

  // Expect PenDown at least once
  EXPECT_CALL(mock_turtle, PenDown()).Times(AtLeast(1));

  // Expect Forward called with any int
  EXPECT_CALL(mock_turtle, Forward(_)).Times(1);

  // Provide default for GetX(), not critical here
  ON_CALL(mock_turtle, GetX()).WillByDefault(Return(0));

  Painter painter(&mock_turtle);
  painter.Draw();
}
```

This test verifies that the `Painter` calls `PenDown` at least once and `Forward` exactly once with any integer argument.

---

## Troubleshooting & Tips

<AccordionGroup title="Common Issues and Solutions">
<Accordion title="Expectations Not Met">
When a test fails because a method call expectation is not met:

- Verify that you have called `EXPECT_CALL` before the code under test exercises the mock.
- Check that the method arguments used to set expectations match those used in your code under test.
- Ensure the mock object is properly destroyed or explicitly verify expectations:

```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(&mock_obj));
```
</Accordion>
<Accordion title="Matching Overloaded Methods">
If you have overloaded methods, you may get ambiguous calls in `EXPECT_CALL`.

Use `Const()` or the argument list in `EXPECT_CALL()` to disambiguate:

```cpp
EXPECT_CALL(mock, Overloaded(5));        // Non-const
EXPECT_CALL(Const(mock), Overloaded(5));  // Const overload
```
</Accordion>
<Accordion title="Uninteresting Calls Warning">
By default, calling mock methods without expectations triggers warnings.

To suppress, wrap the mock in `NiceMock<>`:

```cpp
NiceMock<MockTurtle> mock;
```

Or specify catch-all expectations with `.Times(AnyNumber())`.
</Accordion>
<Accordion title="Cannot Mock Non-Virtual Methods">
Mocking requires virtual methods.

For non-virtual methods, consider refactoring your code to use interfaces or using the high-perf dependency injection technique covered in the cookbook.
</Accordion>
</AccordionGroup>

---

## Next Steps & Related Content

- Explore [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) for a conceptual introduction and illustrative examples.
- Refer to the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced techniques, custom actions, and detailed recipes.
- Understand [Matchers and Actions](https://google.github.io/googletest/gmock_cheat_sheet.html) to expand how you define expectations.
- Learn to [define mock classes](https://google.github.io/googletest/api/reference/mocking.html) comprehensively with qualifiers and dealing with special cases.
- Look into [strictness modes](https://google.github.io/googletest/api/reference/mocking.html#StrictMock) (`NiceMock`, `StrictMock`, `NaggyMock`) for controlling test sensitivity.

For build integration and setting up your environment, see [Configuring Includes and Linking](https://google.github.io/googletest/getting-started/configuration-validation/include-and-link).

---

## Summary

This guide has covered the fundamental workflow for mocking dependencies in C++ tests using GoogleMock. Starting from defining mock classes, specifying expectations and behaviors, to running and verifying tests, you now have a practical foundation to isolate and test code interactions effectively.

For more detailed examples and advanced usage, the linked guides and references provide thorough coverage.


