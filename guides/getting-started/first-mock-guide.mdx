---
title: "Creating and Using Mocks"
description: "A beginner-friendly walkthrough on how to define and use mock objects with GoogleMock. Covers the fundamentals of mock class creation, setting expectations, stubbing return values, and verifying interactions to accurately simulate complex dependencies."
---

# Creating and Using Mocks

A beginner-friendly walkthrough on how to define and use mock objects with GoogleMock. This page focuses on the fundamentals of mock class creation, setting expectations, stubbing return values, and verifying interactions to accurately simulate complex dependencies.

---

## 1. Introduction

When testing C++ code, dependencies on complex or slow components can make tests unreliable and difficult to maintain. GoogleMock simplifies this by allowing you to create **mock objects** — stand-ins that mimic real objects but let you verify how they're used.

This guide walks you through:

- Defining mock classes easily
- Setting expectations on method calls
- Stubbing and returning custom values
- Verifying interaction correctness

By mastering these skills, you'll confidently isolate units of code from their dependencies, improving test robustness and speed.

---

## 2. Defining a Mock Class

### What Is a Mock Class?

A mock class implements the same interface as the real component, with methods replaced by gMock macros that generate mocking code. This mock can then be programmed to expect calls and control behavior.

### Steps to Define a Mock Class

1. Identify the interface or abstract base class of the dependency to mock.
2. Derive a mock class from that interface.
3. Use the `MOCK_METHOD` macro for each virtual method you want to mock.

### Example: Mocking a `Turtle` Interface
```cpp
#include <gmock/gmock.h>  // Include GoogleMock.

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual void GoTo(int x, int y) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

**Tips:**
- Put mock methods in `public:` section regardless of the original access level.
- For types with commas (e.g., templates), wrap the type with extra parentheses or define a type alias.
- Include `override` and `const` qualifiers as needed.

---

## 3. Using Mocks in Tests

### Workflow

1. Import gMock symbols from `testing` namespace.
2. Create mock object instances.
3. Optionally set default behavior with `ON_CALL`.
4. Set specific expectations using `EXPECT_CALL`.
5. Run code under test that uses the mocks.
6. Upon destruction, mocks verify all expectations automatically.

### Example Test
```cpp
#include "mock_turtle.h"
#include <gtest/gtest.h>
#include <gmock/gmock.h>

using ::testing::AtLeast;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;  // #2 create mock object

  EXPECT_CALL(turtle, PenDown())  // #3 expect PenDown called
      .Times(AtLeast(1));

  Painter painter(&turtle);

  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));  // #5 exercise
}
```

If `PenDown` is not called at least once during `DrawCircle`, the test will produce a failure immediately.

### Important: Set Expectations *before* Exercising Code

Never call mock methods before setting expectations, as behavior is undefined otherwise.

---

## 4. Setting Expectations

The heart of mocking is telling the mock object what to expect.

### Syntax

```cpp
EXPECT_CALL(mock, Method(arguments))
    .Times(cardinality)           // Optional call count specification
    .WillOnce(action)             // Optional single-call behavior
    .WillRepeatedly(action);     // Optional repeated-call behavior
```

- `EXPECT_CALL` declares an expectation on a particular method and argument pattern.
- `Times()` controls how many calls are accepted.
- `WillOnce()` defines the mock's behavior on the 1st call, 2nd call, etc.
- `WillRepeatedly()` defines behavior for all subsequent calls after `WillOnce`s.

### Matchers - Specifying Arguments

You can precisely specify expected arguments or use wildcards:

- Use exact values: `EXPECT_CALL(turtle, Forward(100));`
- Use matcher `_` for any value: `EXPECT_CALL(turtle, GoTo(50, _));`
- Combine and use built-in matchers like `Ge()`, `Ne()`, `NotNull()`, etc.

### Cardinalities - Controlling Call Counts

| Cardinality    | Meaning                                    |
|----------------|--------------------------------------------|
| `Times(0)`     | The call must *never* happen.
| `Times(1)`     | Exactly one call expected.
| `AtLeast(n)`   | At least `n` calls.
| `AtMost(n)`    | At most `n` calls.
| `Between(m,n)` | Between `m` and `n` calls inclusive.
| `AnyNumber()`  | Any number of calls allowed.

If you omit `Times()`, gMock infers the count from the number of `WillOnce` and `WillRepeatedly` clauses.

### Actions - Specifying Return Values and Side Effects

By default, gMock uses sensible default return values: `0` for numbers, `false` for booleans, `nullptr` for pointers, or a default-constructed value (C++11+).

You can customize behavior with actions:

- `Return(value)` - return a value
- `ReturnRef(variable)` - return a reference
- `ReturnPointee(pointer)` - return the dereferenced pointer value
- `Invoke(func)` - call a user function/lambda
- `SetArgPointee<N>(value)` - set the N-th out parameter
- `DoAll(action1, action2, ...)` - perform multiple actions sequentially

### Example
```cpp
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This means:
- Call 1 returns 100
- Call 2 returns 150
- Calls 3, 4, 5 return 200

### Ordering Expectations

By default, calls can occur in any order.
Use `InSequence` to enforce strict call order. For example:

```cpp
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

---

## 5. Additional Mocking Techniques

### Multiple Expectations for the Same Method

Newer expectations override older ones. Order your `EXPECT_CALL`s from general to specific.

Example:
```cpp
EXPECT_CALL(turtle, Forward(_));
EXPECT_CALL(turtle, Forward(10)).Times(2);
```

Calls to `Forward(10)` match the second expectation until its limit is reached, then fall back to the first.

### Using `RetiresOnSaturation()`

By default, expectations remain active after they are met and cause failures if called too many times. 

Use `.RetiresOnSaturation()` to make an expectation inactive once its call limit is reached.

### Ignoring Uninteresting Methods

You don't have to specify expectations on every method. Methods without expectations are "uninteresting"; calls to them result in default behavior and a warning.

Use `NiceMock<T>` to suppress warnings on uninteresting calls:
```cpp
NiceMock<MockTurtle> turtle;
```

Use `StrictMock<T>` to treat uninteresting calls as errors.

### When to Use `ON_CALL`

`ON_CALL` defines default behavior without imposing that the call must happen.

It is recommended to use `ON_CALL` for common, non-verification behavior and use `EXPECT_CALL` only when verifying calls.

### Delegating to a Fake or a Real Object

You can combine mocks with fake or real implementations by forwarding calls as default behavior:

```cpp
ON_CALL(*this, DoThis).WillByDefault([this](int n) {
  return real_.DoThis(n);
});
```

---

## 6. Common Pitfalls and Tips

- **Expectations must be set before code execution** to avoid undefined behavior.
- **Be conservative with `.Times()`** — too strict makes tests brittle; too loose allows bugs to slip through.
- **Use matchers wisely** to avoid overly rigid tests.
- **Always implement mock destructors as virtual** in interfaces to avoid severe memory bugs.
- **Beware of side effects in actions** — action parameter expressions are evaluated once.
- **Control verbosity** with `--gmock_verbose=info|warning|error` to get helpful or concise output.
- **Use sequences to verify order**, but favor partial orders (`After`, multiple sequences) when full order is unnecessary.

---

## 7. Troubleshooting

### Mock Method Invokes Real Implementation?

Ensure the method is declared `virtual` in the interface being mocked.

### Expectations Not Being Satisfied

Run tests with `--gmock_verbose=info` to get detailed call trace.

### "Uninteresting Call" Warnings

Use `NiceMock` if you expect these calls but don't want to be warned.
If the call should not happen, add explicit expectations with `.Times(0)`.

### Return Values for Non-default-constructible Types

You must specify explicit return actions (`Return(...)`) for mocks returning such types.

### Mock Compiling Slowly

Consider moving mock class constructor and destructor definitions to `.cc` files.

### Deleting Mocks Early

Be cautious deleting mocks owned by production code; use `Mock::VerifyAndClearExpectations()` to trigger verification in such cases.

---

## 8. Next Steps

- Explore [Matchers](https://google.github.io/googletest/reference/matchers.html) to write flexible argument conditions.
- Deep dive into [Actions](https://google.github.io/googletest/reference/actions.html) for advanced behavior.
- Learn [Best Practices for Test Assertions](../writing-effective-tests/advanced-assertions-practices) and [Using Mocks Effectively](../writing-effective-tests/using-mocks-effectively).
- See examples in the [gMock Cookbook](gmock_cook_book.md) for specific recipes.

---

## 9. Additional Resources

- [gMock for Dummies](gmock_for_dummies.md) — for foundational concepts and examples
- [Mocking Reference](reference/mocking.md) — complete API documentation
- [Mocking FAQ](gmock_faq.md) — for common questions and troubleshooting
- [gMock Cheat Sheet](gmock_cheat_sheet.md) — quick syntax reference

---

For a complete onboarding experience, visit the [Getting Started guides](../getting-started/setup-quickstart.md).

---