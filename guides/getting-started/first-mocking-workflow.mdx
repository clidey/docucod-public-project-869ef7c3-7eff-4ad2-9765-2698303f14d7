---
title: "Creating and Using Test Doubles with GoogleMock"
description: "Guides users through creating mock classes and writing expectations using GoogleMock, showcasing real-world examples for simulating dependencies and isolating unit tests. Emphasizes best practices to help users reason about behavior-based testing."
---

# Creating and Using Test Doubles with GoogleMock

GoogleMock is a powerful framework designed to help you create mock classes and specify expectations for unit testing in C++. This guide focuses on how to create mock classes using `MOCK_METHOD` macros and write expectations with `EXPECT_CALL`. Leveraging GoogleMock lets you simulate dependencies, isolate parts of your code under test, and reason effectively about behavior-based testing.

---

## 1. Understanding the Role of This Page

This guide zeroes in on how to **create mock classes** and **write expectations** that validate interactions between your code and those mocks.

It covers:

- Defining mock methods with the `MOCK_METHOD` macro.
- Setting up call expectations and behaviors using `EXPECT_CALL`.
- Using modifiers to control call counts, sequences, and returns.

By following this guide, you will gain hands-on techniques for constructing test doubles that empower fine-grained control and verification in your unit tests.

---

## 2. Prerequisites

Before you start:

- Ensure the `gmock/gmock.h` header is included in your source file.
- Your classes to be mocked should have virtual methods (or use advanced non-virtual mocking techniques if necessary).
- Have a working familiarity with C++ and unit testing basics.

---

## 3. What You Will Achieve

By the end of this guide, you will be able to:

- Define mock classes with mocked methods that override virtual functions.
- Specify expectations on mock objects about how they should be called.
- Customize behaviors of mock methods when called.
- Manage call counts, argument matching, and sequences to enforce interaction constraints.

---

## 4. Step-by-Step Guide

### Step 1: Create Your Mock Class Using `MOCK_METHOD`

- Define a subclass of the interface or base class you want to mock.
- In the **public section**, declare each virtual method you want to mock using the `MOCK_METHOD` macro.
- The macro syntax is:

  ```cpp
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Specifiers...));
  ```

  Where:
  - `ReturnType`: the method's return type.
  - `MethodName`: the method's name.
  - `(Args...)`: argument types inside parentheses.
  - `(Specifiers...)`: optional qualifiers like `override`, `const`, `noexcept`, or calling conventions.

- If your return type or argument types contain commas, surround them in extra parentheses or use type aliases to avoid parsing errors.

**Example:**
```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

- Place all mock methods in the public section, even if the base class methods are private or protected. This grants external access needed by GoogleMock.

### Step 2: Write Expectations in Your Tests Using `EXPECT_CALL`

After creating your mock object, specify how you expect it to be used in your tests:

```cpp
EXPECT_CALL(mock_object, MethodName(arg_matchers))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- **Argument Matchers** allow matching argument values partially or fully.
- **Times()** controls how many times the call is expected.
- **WillOnce()** and **WillRepeatedly()** specify what the mock method returns or does.

**Example:**
```cpp
using ::testing::Return;
using ::testing::_;

EXPECT_CALL(mock_turtle, Forward(_))  // Match any argument
    .Times(2)                        // Expect exactly 2 calls
    .WillOnce(Return())             // First call: just return
    .WillOnce(Return());            // Second call: just return
```

This enforces that `Forward()` is called twice with any argument.

### Step 3: Use Modifiers to Fine-tune Behavior

- **With Clause:**
  `.With(multi_argument_matcher)` filters calls based on tuple matchers over all arguments.

- **Times Cardinalities:**
  - `AnyNumber()`: any number of calls allowed.
  - `AtLeast(n)`, `AtMost(n)`, `Between(m, n)`, `Exactly(n)`.

- **Ordering:**
  - `.InSequence(sequence1, sequence2, ...)` enforce ordered calls.
  - `.After(expectation, ...)` specify this call occurs only after others.

- **Actions:**
  - `.WillOnce(action)` for specific behavior on call.
  - `.WillRepeatedly(action)` once the initial `WillOnce` behaviors are exhausted.

- **Retirement:**
  `.RetiresOnSaturation()` disables an expectation once it reached its max calls.

### Step 4: Run Your Test and Observe Interaction Checks

GoogleMock will:

- Automatically verify whether all expectations are met when the mock object is destroyed.
- Report errors when unexpected calls occur or expected calls are missing.

---

## 5. Real-World Examples

### Basic Mock Class
```cpp
#include <gmock/gmock.h>

class MockDatabase : public Database {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(std::string, Query, (const std::string& sql), (const, override));
};
```

### Simple Expectation
```cpp
MockDatabase db;
EXPECT_CALL(db, Connect("mydb://localhost"))
    .Times(1)
    .WillOnce(Return(true));

EXPECT_CALL(db, Query(_))  // Match any SQL string
    .WillRepeatedly(Return("OK"));
```

### Expectation with Ordering
```cpp
using ::testing::InSequence;

{
  InSequence s;
  EXPECT_CALL(db, Connect("mydb://localhost"));
  EXPECT_CALL(db, Query("SELECT * FROM users"));
}
```

---

## 6. Best Practices & Tips

- Always mock **only** virtual functions.
- Place all `MOCK_METHOD` declarations in the public section.
- Use argument matchers to keep expectations flexible but precise.
- Use `ON_CALL` to set default behavior when the call count is not important.
- Use `NiceMock` or `StrictMock` to adjust the handling of uninteresting calls.
- Use `.RetiresOnSaturation()` when chaining multiple `EXPECT_CALL`s on the same method.
- Avoid over-specifying expectations; test the contract, not implementation details.

---

## 7. Common Troubleshooting

### Problem: `MOCK_METHOD` fails to compile due to commas in argument types
Solution: Use extra parentheses around types with commas or define type aliases.

### Problem: Mock method calls produce 'Uninteresting mock function call' warnings
Solution: Use `NiceMock` to suppress warnings on uninteresting calls or add an `EXPECT_CALL` with `Times(AnyNumber())` for catch-alls.

### Problem: Overly strict expectations cause test brittleness
Solution: Focus on the behavior/contract your code depends on; avoid rigid argument matching when unnecessary.

### Problem: Order of calls does not fail test as expected
Solution: Use `InSequence` or `After` clauses to enforce call ordering explicitly.

### Problem: `MOCK_METHOD` macro usage for const or noexcept methods
Solution: Add `(const)` or `(noexcept)` qualifiers in the fourth parameter to properly override the methods.

---

## 8. Next Steps & Related Guides

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced mocking scenarios.
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) for beginner-friendly introduction.
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) to understand argument matching strategies.
- [Actions Reference](https://google.github.io/googletest/reference/actions.html) to customize mock method behavior.
- [Managing Mocks: Nice, Strict, and Naggy](https://google.github.io/googletest/guides/core-usage-patterns/managing-mocks-nice-strict.html) to control unwanted warnings or failures.

---

## 9. Summary

This page focused on how to create mock classes with `MOCK_METHOD` macros and set expectations using `EXPECT_CALL`. Through concrete examples and best practices, you can create test doubles that allow simulating dependencies, verifying interactions, and isolating units under test effectively.

Remember: mocks are your tools to specify the behavior and interaction contracts between your modules in tests. Use the rich GoogleMock API to tune expectations and actions precisely and maintainably.
