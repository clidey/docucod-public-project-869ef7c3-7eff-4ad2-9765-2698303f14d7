---
title: "Introducing GoogleMock"
description: "A practical introduction to creating and using mock objects with GoogleMock, showing how to write, configure, and verify mock behaviors in unit tests."
---

# Introducing GoogleMock

A practical introduction to creating and using mock objects with GoogleMock, showing how to write, configure, and verify mock behaviors in unit tests.

---

## 1. Understanding Mock Objects

Mock objects simulate the behavior of real objects in controlled ways during testing. They allow you to specify which methods should be called, with what arguments, how often, and what they should return—without relying on actual implementations.

This page guides you through effectively **creating mock classes**, **setting expectations**, and **verifying interactions** using the GoogleMock framework.

---

## 2. Prerequisites

Before you start:

- Have a working GoogleTest and GoogleMock environment set up.
- Understand the class or interface you want to mock, especially its virtual methods.
- Include the GoogleMock header:

  ```cpp
  #include <gmock/gmock.h>
  ```

- Be comfortable with basic C++ and GoogleTest concepts.

---

## 3. Creating Mock Classes

Mock classes are normal C++ classes derived from your interface or base class with virtual methods. Use the `MOCK_METHOD` macro to define mocked methods easily.

### How to define mock methods

```cpp
class MockClassName : public InterfaceClassName {
 public:
  MOCK_METHOD(ReturnType, MethodName, (ArgTypes...), (Specifiers));
};
```

- **ReturnType**: The return type of the method.
- **MethodName**: The name of the method.
- **ArgTypes**: The argument types in parentheses. Use additional parentheses if arguments contain commas.
- **Specifiers**: Optional qualifiers like `const`, `override`, `noexcept` (in parentheses).

### Example

For an interface:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};
```

You can mock it as:

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Handling overloads and qualifiers

- Mock all overloads to avoid hidden base-class overloads.
- Use the `const` and `override` specifiers as needed.
- If arguments or return types include commas (e.g., `std::pair<int, int>`), wrap the type in additional parentheses or use a type alias.

### Tips

- Always place `MOCK_METHOD` macros in the `public:` section of the mock class, even if the base class methods are protected or private.

---

## 4. Setting Expectations on Mock Methods

After you have your mock objects, specify how you expect them to be used in tests using `EXPECT_CALL` and `ON_CALL`.

### ON_CALL: Define default behavior

Use `ON_CALL` to set the default action for a mock method without expressing an expectation that it must be called. This is ideal for setting up common behavior.

```cpp
ON_CALL(mock_object, MethodName(Matchers...))
    .WillByDefault(Action);
```

Example:

```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(10));
```

### EXPECT_CALL: Define expectations and behavior

Use `EXPECT_CALL` to specify:

- The expected method call, with argument matchers
- How many times the call is expected (`Times`) 
- What the method should do via actions

```cpp
EXPECT_CALL(mock_object, MethodName(Matchers...))
    .Times(Cardinality)
    .WillOnce(Action)
    .WillRepeatedly(Action)
    .RetiresOnSaturation();
```

- If `Times` is omitted, GoogleMock infers it based on the `WillOnce` and `WillRepeatedly` clauses.
- Actions specify how the mock method responds (e.g., `Return(value)`).

### Matchers

- Use `_` to match any argument.
- Use other matchers (`Eq`, `Ge`, `NotNull`, etc.) to specify argument constraints.
- You can combine complex matchers or define custom ones.

### Cardinalities (Times)

Specify how often the method should be called:

| Cardinality       | Meaning                       |
|-------------------|-------------------------------|
| `AnyNumber()`     | Zero or more times allowed     |
| `AtLeast(n)`      | Called at least n times        |
| `AtMost(n)`       | Called at most n times         |
| `Between(m, n)`   | Between m and n times          |
| `Exactly(n)` or `n` | Exactly n times, `0` disallows call |

### Actions

- **Return values:** `Return(value)`
- **Return by reference:** `ReturnRef(variable)`
- **Return values from arguments:** `ReturnArg<N>()`
- **Invoke functions:** `Invoke(function)`
- **Combine actions:** `DoAll(action1, action2, ...)`
- **Set output arguments:** `SetArgPointee<N>(value)`

### Ordering Expectations

- Use `InSequence` to enforce expectations occur in strict order:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, MethodA());
  EXPECT_CALL(mock, MethodB());
}
```

- Use `After` to specify that an expectation only applies after other expectations.

### Retiring Expectations

By default, expectations remain *sticky* after being saturated. Use `.RetiresOnSaturation()` to make an expectation inactive once its call count has been met.

---

## 5. Verifying Mock Objects

GoogleMock automatically verifies expectations when a mock object is destructed.

If you want to verify earlier, use:

```cpp
bool result = testing::Mock::VerifyAndClearExpectations(&mock_object);
```

To also clear default actions:

```cpp
bool result = testing::Mock::VerifyAndClear(&mock_object);
```

- Returns `true` if all expectations are met, else `false` (test failure).
- Do not set expectations after verification; doing so leads to undefined behavior.

---

## 6. Best Practices and Tips

- **Use `ON_CALL` for common default behavior**, and reserve `EXPECT_CALL` for calls you want to verify.
- **Avoid over-specifying expectations:** limit constraints to only what your test cares about.
- **Suppress warnings about uninteresting calls** with `NiceMock<T>` if needed.
- When mocking interfaces with many overloads, consider providing a simpler mock interface to avoid ambiguity.
- Be mindful that expectations must be set before exercising the mock object.
- For debugging, run tests with `--gmock_verbose=info` to see detailed traces of mock calls and expectation matches.

---

## 7. Troubleshooting Common Issues

### Methods Not Being Mocked

- Ensure mocked methods are **virtual**.
- If methods are not virtual, GoogleMock cannot intercept calls unless special techniques are used.

### Unexpected or Uninteresting Calls

- Unexpected calls: Mock method called but do not match any `EXPECT_CALL`. This is an error.
- Uninteresting calls: Mock method has no `EXPECT_CALL`.
  
  - Warning is printed by default.
  - Use `NiceMock<T>` to silence warnings.
  - Use `EXPECT_CALL(...).Times(AnyNumber())` for expected but unconstrained calls.

### Compiler Warnings

- MSVC may warn when `const` exists on parameter types—it's safe to remove top-level `const` from mock signatures.

### Mock Destruction and Leak Checking

- Make sure mock objects are destroyed to verify expectations.
- Use `testing::Mock::AllowLeak()` if intentional.

---

## 8. Practical Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

// Interface
class Database {
 public:
  virtual ~Database() {}
  virtual bool Connect(const std::string& url) = 0;
  virtual std::string Query(const std::string& sql) = 0;
};

// Mock class
class MockDatabase : public Database {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(std::string, Query, (const std::string& sql), (override));
};

TEST(DatabaseTest, ConnectAndQuery) {
  MockDatabase mock_db;

  // Set default behavior
  ON_CALL(mock_db, Connect).WillByDefault(testing::Return(true));

  // Expect Connect to be called once with "db://localhost"
  EXPECT_CALL(mock_db, Connect("db://localhost")).Times(1);

  // Expect Query to be called any number of times with any string
  EXPECT_CALL(mock_db, Query(testing::_))
      .WillRepeatedly(testing::Return("result"));

  // Exercise
  EXPECT_TRUE(mock_db.Connect("db://localhost"));
  EXPECT_EQ(mock_db.Query("SELECT * FROM table"), "result");
}
```

- This example defines `MockDatabase` with mocked methods.
- The test sets default and expected behaviors.
- The test exercises the mock and verifies expectations automatically.

---

## 9. Where to Go Next

- Explore the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for deeper examples and expert tips.
- Learn about matchers, actions, and cardinalities in detail from the official [Mocking Reference](https://google.github.io/googletest/reference/mocking.html).
- Get familiar with writing custom matchers and actions for complex scenarios.
- Understand strictness modes and how to handle uninteresting/unexpected calls using `NiceMock`, `NaggyMock`, and `StrictMock`.

---

## Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking FAQ](https://google.github.io/googletest/gmock_faq.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [GoogleTest Primer](https://google.github.io/googletest/primer.html)

---