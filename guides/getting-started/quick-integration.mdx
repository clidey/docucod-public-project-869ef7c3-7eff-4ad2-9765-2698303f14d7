---
title: "Quick Integration with Build Systems"
description: "Step-by-step instructions to integrate GoogleTest and GoogleMock into CMake or Bazel projects. Covers adding dependencies, writing simple tests, and running them from the command line."
---

# Quick Integration with Build Systems

Integrating GoogleTest and GoogleMock into your C++ projects using popular build systems like CMake and Bazel can be done quickly by following these precise steps. This guide walks you through adding dependencies, writing simple tests, and running them from the command line, helping you get your testing infrastructure up and running without delay.

---

## Prerequisites

Before beginning integration, ensure:

- Your project uses C++17 compatible compiler and environment.
- GoogleTest and GoogleMock source or prebuilt binaries are accessible.
- Familiarity with basic CMake or Bazel syntax and project structure.

---

## 1. Integrating GoogleTest and GoogleMock with CMake

### Step 1: Add GoogleTest and GoogleMock as dependencies

You can either add GoogleTest/GMock as a subdirectory if you have the source or point to the installed locations.

```cmake
# Add GoogleTest source code
add_subdirectory(path/to/googletest)

# Your test target
add_executable(my_test test_file.cpp)

# Link your test target against GTest and GMock libraries
target_link_libraries(my_test gmock gtest pthread)
```

> **Note:** On Windows, ensure your CRT linkage matches the rest of your project to avoid linker errors.

### Step 2: Include proper headers

In your test source files, include GoogleTest and GoogleMock headers:

```cpp
#include <gtest/gtest.h>
#include <gmock/gmock.h>
```

GoogleMock header includes GoogleTest, so including `<gmock/gmock.h>` alone is sufficient for mocks.

### Step 3: Write a simple test with mocks

```cpp
using ::testing::Return;
using ::testing::_;

// Define a mock class
class MockFoo {
 public:
  MOCK_METHOD(int, Bar, (int), ());
};

TEST(FooTest, BasicTest) {
  MockFoo mock;
  EXPECT_CALL(mock, Bar(_)).WillOnce(Return(42));
  EXPECT_EQ(mock.Bar(5), 42);
}
```

### Step 4: Build and run tests

From your build directory:

```bash
cmake --build .
./my_test
```

You should see GoogleTest running your test and reporting results.

---

## 2. Integrating GoogleTest and GoogleMock with Bazel

### Step 1: Add `@com_google_googletest` dependency

In your `WORKSPACE` file, add:

```starlark
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.12.1.zip"],
    strip_prefix = "googletest-release-1.12.1",
    sha256 = "1c44c99107ed11a79d4e1c4b6954c66a4ae2e78979163b97a54c11a117ec2b74",
)

load("@com_google_googletest//bazel:googletest.bzl", "gtest_main")
```

### Step 2: Define your test target

In your `BUILD` file:

```starlark
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = [
        "@com_google_googletest//:gmock",
        "@com_google_googletest//:gtest_main",
    ],
)
```

### Step 3: Write test code

Same as for CMake, include the headers and use mocks as normal in `my_test.cc`.

### Step 4: Run your tests

Using Bazel:

```bash
bazel test :my_test
```

Your GoogleTest tests will run and results will be displayed.

---

## Understanding EXPECT_CALL and ON_CALL

- `EXPECT_CALL` sets an expectation that a mock method will be called with specific arguments and optionally defines behavior.
- `ON_CALL` defines default behavior for method calls but does not set expectations that they must be called.

Example:

```cpp
ON_CALL(mock_obj, Method(_))
    .WillByDefault(Return(true));
EXPECT_CALL(mock_obj, Method(5))
    .WillOnce(Return(false));
```

The call with argument `5` is expected once to return `false`. Other calls return `true` by default.

---

## Best Practices

- Use `EXPECT_CALL` only when you want to verify that a method is called.
- Use `ON_CALL` to specify default behavior without strict expectations.
- Chain clauses in the specified order: `.With()`, `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, `.RetiresOnSaturation()`.
- If method overloads exist, specify matchers accordingly to avoid ambiguity.
- Use **NiceMock**, **NaggyMock**, or **StrictMock** wrappers to control reporting of uninteresting calls:
  - `NiceMock`: suppress warnings on uninteresting calls.
  - `NaggyMock`: warns on uninteresting calls (default behavior).
  - `StrictMock`: fails test on any uninteresting calls.

---

## Troubleshooting Common Issues

- **Linking errors or missing pthread:** Ensure `pthread` is linked explicitly on Linux/macOS.
- **Ambiguous overloads:** Use matchers or `Const()` wrapper to disambiguate.
- **Uninteresting call warnings:** Use `NiceMock` to suppress or add explicit `EXPECT_CALL(...).Times(AnyNumber())`.
- **Matching failures:** Run tests with `--gmock_verbose=info` for detailed call tracing.

---

## Summary Diagram

```mermaid
flowchart TD
  A[Start Integration] --> B[Select Build System]
  B --> C[CMake]
  B --> D[Bazel]

  C --> E[Add googletest with add_subdirectory()]
  E --> F[Link gmock and gtest to test target]
  F --> G[Write test with MOCK_METHOD, EXPECT_CALL]
  G --> H[Build and run tests]

  D --> I[Add googletest to WORKSPACE]
  I --> J[Define cc_test with deps on gmock and gtest_main]
  J --> G

  H --> K[Verify test passes]
  K --> L[Integration Complete]

  classDef steps fill:#f9f,stroke:#333,stroke-width:1px;
  class A,B,C,D,E,F,G,H,I,J,K,L steps;
```

---

## Additional Resources

- [GoogleTest Primer and Getting Started Guides](https://github.com/google/googletest)
- [Mocking Reference](docs/reference/mocking.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [Troubleshooting Common Setup Issues](getting-started/troubleshooting-help/common-issues.mdx)


---

This guide helps you quickly integrate GoogleTest and GoogleMock into your build system, enabling robust unit testing with mock support. Follow the precise, stepwise instructions to add dependencies, create mock classes, set expectations, and run your tests effectively.

---

<Tip>
Start with simple mock classes using `MOCK_METHOD` and verify test execution before adding complex matchers or actions.
</Tip>

<Note>
For multi-threaded tests, ensure expectation setup and test exercise occur without data races to avoid undefined behavior.
</Note>

<Warning>
Do not set expectations after mock methods are already called or passed on to the code under test, as it causes undefined behavior.
</Warning>
