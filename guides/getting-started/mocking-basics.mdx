---
title: "Basic Mocking: Using GoogleMock"
description: "Hands-on guide for introducing mocks into your tests, using GoogleMock's key features. Learn to create mock classes, set expectations, and verify interactions using core macros."
---

# Basic Mocking: Using GoogleMock

Hands-on guide for introducing mocks into your tests, using GoogleMock's key features. Learn to create mock classes, set expectations, and verify interactions using core macros.

---

## 1. Introduction to Basic Mocking

Mocking is a powerful technique for testing interactions between components by simulating parts of your system. This guide walks you through the essentials of creating mock classes, setting expectations on mock methods, and validating behavior with GoogleMock.

You will learn how to:

- Define mock classes from your interfaces
- Use `EXPECT_CALL` to specify expected calls and behaviors
- Utilize `ON_CALL` for default mock behaviors
- Leverage matchers and actions to control mock method invocation

## 2. Prerequisites

Before you start:

- Have GoogleMock integrated in your project (`#include <gmock/gmock.h>`).
- Understand the interface you want to mock, which must have `virtual` methods.
- Be familiar with basic C++ and test writing using GoogleTest.

## 3. Expected Results

After completing this guide, you will be able to:

- Define mock classes using `MOCK_METHOD` macros.
- Set expectations that define how and when mock methods should be called.
- Control mock method return values and side effects.
- Understand and correctly use GoogleMock core macros for effective test design.

Estimated time: 15-30 minutes
Difficulty: Beginner to Intermediate

---

## 4. Step-by-Step Guide

### Step 1: Define Your Mock Class

Start with your original interface. For example:

```cpp
class Foo {
 public:
  virtual ~Foo();
  virtual int GetSize() const = 0;
  virtual string Describe(const char* name) = 0;
  virtual string Describe(int type) = 0;
  virtual bool Process(Bar elem, int count) = 0;
};
```

Create a mock class inheriting from your interface. Use the `MOCK_METHOD` macro to define mocks of virtual functions. The macro format is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

Example mock class:

```cpp
#include <gmock/gmock.h>

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(string, Describe, (const char* name), (override));
  MOCK_METHOD(string, Describe, (int type), (override));
  MOCK_METHOD(bool, Process, (Bar elem, int count), (override));
};
```

**Tips:**
- Always put `MOCK_METHOD` in a `public` section.
- Use `(const, override)` for const methods.
- Wrapping complex return or argument types in parentheses or using type aliases can avoid macro parsing issues.

---

### Step 2: Create and Use Mock Objects

In your test, create mock object instances and set behaviors/assertions.

Basic workflow:

1. Import necessary GoogleMock symbols:
   ```cpp
   using ::testing::Return;
   ```
2. Construct mock object:
   ```cpp
   MockFoo mock_foo;
   ```
3. Optionally set default actions (with `ON_CALL`):
   ```cpp
   ON_CALL(mock_foo, GetSize()).WillByDefault(Return(1));
   ```
4. Set expectations with `EXPECT_CALL`:
   ```cpp
   EXPECT_CALL(mock_foo, Describe(5))
       .Times(3)
       .WillRepeatedly(Return("Category 5"));
   ```
5. Exercise code that calls mocks:
   ```cpp
   EXPECT_EQ(MyProductionFunction(&mock_foo), "good");
   ```
6. GoogleMock validates expectations automatically on destruction.

---

### Step 3: Configure Expectations

Control when and how often mock methods are called:

- **`EXPECT_CALL`** - sets expectations for **calls you want to verify**.
- **`ON_CALL`** - sets **default behavior** without imposing call expectations.

Example:

```cpp
EXPECT_CALL(mock_foo, FooMethod(_)).Times(2).WillOnce(Return(true));
ON_CALL(mock_foo, FooMethod(_)).WillByDefault(Return(false));
```

The above means you expect exactly 2 calls that return `true`, all others fall back to returning `false`.

Note:
- The later (newer) `EXPECT_CALL` statements override earlier ones.
- If you omit `.Times()`, inferred cardinality depends on `WillOnce` and `WillRepeatedly` clauses.

---

### Step 4: Using Matchers for Argument Control

When specifying expectations, you can refine arguments using matchers:

- `_` matches any argument.
- Specific matchers like `Eq(value)`, `Ge(value)`, `NotNull()` specify predicates.

Example:

```cpp
EXPECT_CALL(mock_foo, Process(_, 5));  // Second argument must be 5.
EXPECT_CALL(mock_foo, Describe(_));   // Any argument.
EXPECT_CALL(mock_foo, Describe(HasSubstr("test")));  // Argument contains substring.
```

Combining matchers helps write readable, flexible mocks:

```cpp
EXPECT_CALL(mock_foo, Process(Ge(0), _));  // First arg >= 0, second any.
```

---

### Step 5: Handling Call Order

By default, expectations can occur in any order. Use sequences to enforce order:

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(mock_foo, FirstCall());
  EXPECT_CALL(mock_foo, SecondCall());
}
```

This expects `FirstCall()` to happen before `SecondCall()`.

For more complex partial orders, use `Sequence` objects and `.InSequence()` clauses.

---

### Step 6: Mock Object Strictness

GoogleMock provides wrappers for controlling the default behavior on uninteresting calls (calls without expectations):

- **`NiceMock`**: ignores uninteresting calls warnings
- **`NaggyMock`** (default behavior): warnings on uninteresting calls
- **`StrictMock`**: treats uninteresting calls as errors

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock;
EXPECT_CALL(mock, DoThis());
// Calls to other methods will not warn.
```

Use these to tune the strictness and verbosity of your tests.

---

### Step 7: Verifying and Resetting

Mock objects automatically verify expectations on destruction. You can manually verify earlier:

```cpp
#include <gmock/gmock.h>
using ::testing::Mock;

Mock::VerifyAndClearExpectations(&mock_foo);
```

This returns `true` if all expectations are satisfied. Avoid setting new expectations after verification.

---

## 5. Common Pitfalls & Tips

- **Always mock virtual methods**: Non-virtual methods cannot be mocked through inheritance.
- **Set expectations before exercising the mock**: `EXPECT_CALL` must be called prior to invoking the mock method.
- **Beware of uninteresting calls**: Use `NiceMock` or explicit catch-all expectations to avoid noisy warnings.
- **Overlapping expectations**: The last matching expectation takes precedence.
- **Avoid mocking classes you donâ€™t own**: Instead, create interfaces or adaptors.

---

## 6. Example: Basic Mocking Using `MockTurtle`

Imagine a simplified interface:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

Use in test:

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;
using ::testing::Return;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, GetX()).WillRepeatedly(Return(0));

  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

In this test:
- The `PenDown()` method is expected to be called at least once.
- The turtle is expected to move forward 100 units.
- The `GetX()` method is stubbed to return 0 when called.

---

## 7. Troubleshooting

### Problem: Mock Method Calls Real Method
- **Cause:** Method is not virtual.
- **Solution:** Ensure the method is declared `virtual` in the interface.

### Problem: Unexpected Call Failure
- **Cause:** Mock method called more times than expected or with wrong arguments.
- **Solution:** Adjust `EXPECT_CALL` or add appropriate catch-all expectations.

### Problem: Uninteresting Call Warnings
- **Cause:** Mock method called without matching `EXPECT_CALL`.
- **Solution:** Use `NiceMock` or add an `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())`.

### Problem: Overloaded Method Ambiguity
- **Cause:** Overloaded methods confuse the compiler.
- **Solution:** Use disambiguation techniques such as specifying matchers for argument types or the `Const()` wrapper.

### Problem: Mock with Non-Default Constructor
- **Note:** Use appropriate wrapper classes (`NiceMock`, `StrictMock`) with constructor arguments.

---

## 8. Advanced Tips

- For methods returning references, use `ReturnRef()` instead of `Return()`.
- Use `.RetiresOnSaturation()` on expectations that should become inactive after being satisfied.
- To test complex call ordering, use `Sequence` and the `.InSequence()` clause.
- Use `SaveArg<N>(&variable)` in actions to capture arguments for later verification.
- For move-only types (e.g., `std::unique_ptr`), use lambdas or functors in actions.

---

## 9. Additional Resources

- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html): Quick reference for macros and common patterns.
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html): Beginner-friendly explanation with practical examples.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Recipes for more complex use cases.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html): In-depth explanation of core mock API.

---

## 10. Summary

This guide introduced you to the basics of mocking with GoogleMock:

- Defining mock classes
- Creating and using mock objects in tests
- Setting expectations with `EXPECT_CALL`
- Using matchers to control argument matching
- Controlling mock strictness and handling uninteresting calls
- Troubleshooting common problems

Implement these principles to write effective, maintainable tests verifying object interactions.

---