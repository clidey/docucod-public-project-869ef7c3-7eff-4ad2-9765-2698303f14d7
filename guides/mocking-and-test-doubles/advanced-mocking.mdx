---
title: "Advanced Mocking: Actions, Matchers, and Expectations"
description: "Dig deeper into GoogleMock for fine-grained control over method stubbing, argument matching, call sequencing, and custom actions. This guide is packed with real-world usage tips and patterns to enhance your test effectiveness."
---

# Advanced Mocking: Actions, Matchers, and Expectations

Dive deeper into GoogleMock to gain fine-grained control over mocking behaviors — from customizing method stubbing to mastering argument matching, call sequencing, and defining custom actions. This guide provides practical patterns and real-world tips that enhance your tests' expressiveness and robustness.

---

## Workflow Overview

**What this guide helps you accomplish:**
- Master the advanced features of GoogleMock related to Actions, Matchers, and Expectations.
- Create precise, expressive mock behaviors and verifications that match real-world unit testing needs.

**Prerequisites:**
- Basic understanding of GoogleMock and how to define mock methods (see "Creating and Using Basic Mocks").
- Familiarity with `EXPECT_CALL` and `ON_CALL` macros.
- GoogleMock integrated into your C++ project.

**Expected Outcome:**
- Ability to craft detailed expectations controlling call counts, argument matching, invocation order, and actions performed by mocks.
- Use of composite matchers, reusable actions, and sequences for powerful test verification.

**Time Estimate:**
- Intermediate users: 20-40 minutes to read and digest examples.
- Beginners: Additional time recommended to review basic mocking guides first.

**Difficulty Level:** Intermediate to Advanced

---

## Step-by-Step Instructions

### 1. Defining Mock Behavior with Actions

- Use `WillOnce(action)` and `WillRepeatedly(action)` to specify what your mock methods do when called.
- Actions can be built-in (e.g., `Return()`, `Invoke()`, `SetArgPointee()`, `DoAll()`), lambdas, or custom-defined.
- Actions assigned with `WillOnce()` are executed sequentially on matching calls; after they exhaust, `WillRepeatedly()` applies to subsequent calls.

**Example:**
```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```
- On first call, returns 10;
- second call returns 20;
- third and subsequent calls return 30.


### 2. Using Matchers for Argument Verification

- Matchers validate mock method call arguments in `EXPECT_CALL` and `ON_CALL`.
- Use simple matchers like `_` (wildcard), `Eq()`, `Gt()`, or compose complex ones with `AllOf()`, `AnyOf()`, `Not()`.
- Use tuple matchers with `.With()` to constrain all arguments as a group.

**Example:**
```cpp
using ::testing::_;
using ::testing::Lt;
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // first arg less than second
```

### 3. Specifying Call Cardinalities with `.Times()`

- Control how many times an expectation is expected to match:
  - `Times(AnyNumber())` allows any calls.
  - `Times(Exactly(n))` or `Times(n)` expects exact `n` calls.
  - `Times(AtLeast(n))`, `Times(AtMost(n))` for ranges.
  - `Times(Between(m, n))` for interval.

- If `.Times()` is omitted, GoogleMock infers cardinality from `WillOnce()` and `WillRepeatedly()` usage.

**Example:**
```cpp
EXPECT_CALL(mock, Process(_)).Times(AtLeast(1));
```

### 4. Controlling Call Order with Sequences and Ordering Clauses

- Use the `InSequence` helper class to require expectations to occur in strict order.
- Use `.InSequence(seq1, seq2...)` to assign one or more `Sequence` objects to expectations — enforcing partial orders.
- Use `.After(expectation1, expectationSet2, ...)` to specify that an expectation must occur only after others.
- Expectations in a sequence automatically retire when their subsequent sequenced expectations become active.

**Example:**
```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Init())
    .InSequence(s1, s2);
EXPECT_CALL(mock, Start())
    .InSequence(s1);
EXPECT_CALL(mock, Finish())
    .InSequence(s2);
```

The calls must obey ordering: `Init()` before `Start()`, and `Init()` before `Finish()`.

### 5. Using Modifier Clauses in `EXPECT_CALL` and `ON_CALL`

| Modifier             | Usage Restrictions             | Purpose                                     |
|----------------------|-------------------------------|---------------------------------------------|
| `.With(matcher)`     | At most once, first in chain   | Multi-argument matchers                      |
| `.Times(cardinality)`| At most once                   | Call count control                           |
| `.InSequence(...)`   | Any number, before `.After()`, `.WillOnce()` | Call ordering via sequences                   |
| `.After(...)`        | Any number, before `.WillOnce()` | Call ordering after other expectations       |
| `.WillOnce(action)`  | Any number                    | Define behavior for one matching call        |
| `.WillRepeatedly()`  | At most once                  | Define behavior for all remaining calls      |
| `.RetiresOnSaturation()` | At most once, last            | Deactivate expectation when saturated        |

**Note:** Clauses must appear in the specified order in the chain.

### 6. Defining Default Behavior with `ON_CALL`

- Use `ON_CALL(mock, Method(matchers)).WillByDefault(action)` to specify default mock method behavior without setting call count expectations.
- `WillByDefault()` must be specified exactly once per `ON_CALL`.
- When both `EXPECT_CALL` and `ON_CALL` match a call, the `EXPECT_CALL` action takes precedence.


### 7. Handling Uninteresting, Unexpected, and Excessive Calls

- **Uninteresting call:** No matching `EXPECT_CALL`.
  - By default warns and runs default action.
  - Use `NiceMock` to suppress warnings.
  - Use `StrictMock` to fail these calls.
- **Unexpected call:** Matches expectations but arguments do not; always treated as error.
- **Excessive call:** Call count exceeds `.Times()`; generates failure and returns default or default action.

### 8. Verifying and Clearing Expectations

- Normally, expectations are verified automatically at mock destruction.
- You can manually verify earlier with:
  - `Mock::VerifyAndClearExpectations(&mock_obj)` to verify and clear expectations.
  - `Mock::VerifyAndClear(&mock_obj)` to verify and clear expectations and default actions.
- Do not set new expectations after verification.

### Best Practices and Tips

- **Use `ON_CALL` to define default behaviors; use `EXPECT_CALL` to specify and verify calls you care about.**
- **Avoid over-specifying expectations; be as precise as necessary but no more.**
- **Use sequences and ordering clauses to enforce call order only where applicable.**
- **Provide `.RetiresOnSaturation()` especially when defining sequences or consecutive `WillOnce` actions, to avoid sticky expectations causing failures.**
- **For complex side effects (e.g., modifying arguments), chain actions with `DoAll()`.**
- **Use `Invoke()` and lambdas for custom behaviors.**
- **Use `ReturnRef()` for returning references instead of `Return()`.**
- **Avoid writing expectations after the mock is exercised to prevent undefined behavior.**

---

## Examples & Code Patterns

### Defining Multiple Return Values with WillOnce and WillRepeatedly

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

### Restricting Argument Values with Matchers

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // First argument is less than the second
EXPECT_CALL(mock, Write(_))
    .Times(AtLeast(1));
```

### Using Sequence to Enforce Call Order

```cpp
Sequence s;
EXPECT_CALL(mock, Init()).InSequence(s);
EXPECT_CALL(mock, Process(42)).InSequence(s);
EXPECT_CALL(mock, Cleanup()).InSequence(s);
```

### Chaining Actions including Side Effects

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

### Using Custom Actions with Lambdas

```cpp
EXPECT_CALL(mock, Callback(_))
    .WillOnce(Invoke([](int arg) { return arg * 2; }));
```

### Delegating Calls to a Real or Fake Object

```cpp
ON_CALL(mock, DoWork(_))
    .WillByDefault([&real](ArgType arg) {
      return real.DoWork(arg);
    });
```

### Setting Catch-All Expectations

```cpp
EXPECT_CALL(mock, GetValue(_))
    .Times(AnyNumber());  // Allow any calls
EXPECT_CALL(mock, GetValue(10))
    .WillRepeatedly(Return(42));
```

---

## Troubleshooting & Tips

### Common Pitfalls

- **Forgetting `MOCK_METHOD` methods must be declared `public:`** You cannot mock private or protected methods directly.
- **Argument matchers mismatch** causing unexpected call errors — verify your matchers correspond to method signatures.
- **Over-specifying expectations causes brittleness**; use `ON_CALL` for default behavior.
- **Breaking order constraints unexpectedly** — sequences and `.After()` can cause calls to fail if order is violated.
- **Actions with move-only types** may require lambdas instead of `Return()`.
- **Using `Return()` with move-only values causes runtime errors if reused; prefer lambdas to produce fresh objects each time.**

### Performance and Maintenance Tips

- Move mock constructors and destructors to `.cc` files to reduce compile time.
- Use `NiceMock` or `StrictMock` wrappers to control verbosity of uninteresting call warnings.
- Use `Mock::AllowLeak()` if you intentionally do not want to verify mock destruction.
- Run tests with `--gmock_verbose=info` to get detailed mock call tracing.

### Recovery Options

- Use `Mock::VerifyAndClear(&mock)` to reset expectations and default actions if tests fail due to lingering expectations.
- Use the reverse order of expectations if more specific rules don’t seem to override general ones.

---

## Next Steps & Related Content

- Read the [Mocking Best Practices and Anti-Patterns](../mocking-best-practices.md) guide to refine usage.
- Explore [Parameterized and Typed Tests](../parameterized-tests.md) for more powerful test configurations.
- Review [Actions Reference](../../api-reference/mocking-apis/actions.md) for exhaustive built-in actions.
- Visit [Matchers Reference](../../api-reference/core-apis/matchers.md) to deepen understanding on argument matchers.
- Study [Mock Classes: Nice, Naggy, and Strict](../../api-reference/mocking-apis/nice-naggy-strict-mocks.md) for controlling uninteresting call behavior.
- Consult [gMock Cookbook](../gmock_cook_book.md) for practical recipes.
- Use the [Legacy gMock FAQ](../../faq/gmock_faq.md) for troubleshooting common issues.

---

## References

- [EXPECT_CALL Reference](../reference/mocking.md#EXPECT_CALL)
- [ON_CALL Reference](../reference/mocking.md#ON_CALL)
- [Actions Overview](../reference/actions.md)
- [Matchers Overview](../reference/matchers.md)
- [Sequences and Expectation Ordering](../reference/mocking.md#EXPECT_CALL.InSequence)
- [Using GoogleMock: gMock for Dummies](../gmock_for_dummies.md)

---

This guide empowers you to take full advantage of GoogleMock’s expressive DSL for mocking, enabling you to write tests that are both precise and maintainable.

---

<Check>
Pro Tip: Begin your tests with broad `ON_CALL` default behaviors, then specialize with `EXPECT_CALL` for calls that matter. Control call order with sequences only as needed to prevent brittleness.
</Check>


