---
title: "Integrating with Build and CI Systems"
description: "Instructions and tips for integrating GoogleTest/GoogleMock into popular build systems (CMake, Bazel) and continuous integration pipelines. Includes advice on automation, test runners, and maintaining cross-platform compatibility."
---

# Integrating with Build and CI Systems

## Overview

Integrating GoogleTest and GoogleMock into your build process and continuous integration (CI) pipelines is crucial for automated, reliable testing of your C++ codebase. This guide provides practical, step-by-step instructions and best practices for incorporating GoogleTest with popular build systems like CMake and Bazel, as well as advice for configuring CI pipelines to run tests efficiently and consistently across platforms.

---

## 1. Workflow Overview

### Task Description
This guide helps you integrate GoogleTest and GoogleMock into your existing build and CI systems for automated test compilation, execution, and reporting.

### Prerequisites
- A working build system setup (CMake or Bazel) for your C++ project.
- GoogleTest and GoogleMock source or installed packages included in your project.
- Access to your CI pipeline or automation tooling capable of running shell commands.

### Expected Outcome
By following this guide, you will:
- Be able to compile and run GoogleTest-based tests as part of your build.
- Automate test execution in CI with test runners and reporting.
- Maintain cross-platform compatibility and reliability.

### Time Estimate
15-30 minutes for initial integration; additional tuning time for CI pipeline configurations.

### Difficulty Level
Intermediate - requires familiarity with build systems and CI tools.

---

## 2. Integrating with CMake

GoogleTest comes with first-class support for CMake, making it straightforward to add tests to your CMake projects.

### Step 1: Add GoogleTest Source or Find Package

- If GoogleTest is installed on your system:

```cmake
find_package(GTest REQUIRED)
include_directories(${GTEST_INCLUDE_DIRS})
```

- Alternatively, include GoogleTest as a subdirectory (preferred for consistent builds):

```cmake
add_subdirectory(path/to/googletest)
include_directories(${gtest_SOURCE_DIR}/include ${gmock_SOURCE_DIR}/include)
```

### Step 2: Add Test Executable

Add your test source files and link to GoogleTest and optionally GoogleMock:

```cmake
add_executable(my_tests test_main.cpp test_foo.cpp test_bar.cpp)
target_link_libraries(my_tests GTest::gtest GTest::gtest_main GTest::gmock GTest::gmock_main pthread)
```

> **Note:** Link against `pthread` on Linux and POSIX platforms as required.

### Step 3: Enable Testing and Add Test Target

```cmake
enable_testing()
add_test(NAME my_tests COMMAND my_tests)
```

### Step 4: Build and Run Tests

```bash
mkdir build
cd build
cmake ..
make
ctest
```

The `ctest` command runs the tests with test case discovery.

### Cross-Platform Considerations
- On Windows, CMake generates suitable Visual Studio projects.
- Use `gtest_force_shared_crt` CMake option if dynamic CRT mismatch occurs (see [Generic Build Instructions](https://github.com/google/googletest/blob/main/googletest/README.md#generic-build-instructions)).

---

## 3. Integrating with Bazel

Bazel users can leverage the built-in support for GoogleTest in their BUILD files.

### Step 1: Add GoogleTest Dependency

Declare GoogleTest as an external dependency or use the Bazel workspace rule to fetch it.

### Step 2: Define Test Target in BUILD File

```bazel
cc_test(
    name = "my_tests",
    srcs = ["test_main.cpp", "test_foo.cpp", "test_bar.cpp"],
    deps = ["@com_google_googletest//googletest:main", "@com_google_googletest//googlemock:main"],
)
```

### Step 3: Build and Run Tests

```bash
bazel build //path/to:my_tests
bazel test //path/to:my_tests
```

Bazel will build the test target and run it, reporting results.

### Best Practices
- Organize tests in the source tree mirroring code structure for clarity.
- Use Bazel tags and attributes to adjust test execution environments.

---

## 4. Automating Test Execution in CI Pipelines

Automating testing in CI environments ensures consistent verification before changes are merged.

### Step 1: Set Up Build Environment

- Install required dependencies including compiler, CMake/Bazel, and GoogleTest if not bundled.
- For CMake, use:
  ```bash
  mkdir build && cd build
  cmake ..
  make
  ```

- For Bazel, use:
  ```bash
  bazel build //tests:all
  ```

### Step 2: Run Tests with Output Reporting

- For CTest:

```bash
ctest --output-on-failure
```

- For Bazel:

```bash
bazel test //tests:all --test_output=errors
```

### Step 3: Configure Test Report Parsing

Most CI systems (Jenkins, GitHub Actions, GitLab CI) can parse XML test reports.

- Generate XML reports with:

```bash
ctest --output-on-failure --test-output-format=JUnit
```

or use GoogleTest’s built-in XML output:

```bash
./my_tests --gtest_output=xml:report.xml
```

- Configure your pipeline to collect and display these reports.

### Step 4: Cross-Platform Consistency

- Ensure all build agents use compatible environments.
- Test scripts should handle platform differences gracefully.

---

## 5. Best Practices

- **Use Explicit Test Targets:** Keep test sources and related mocks organized in dedicated directories.
- **Set Default Actions with ON_CALL:** Reduce test flakiness by configuring default mock behaviors.
- **Limit EXPECT_CALL to Important Interactions:** Avoid brittle tests by only verifying critical interactions.
- **Use `InSequence` or `After` for Order Sensitivity:** Control call order when necessary.
- **Leverage CI Verbosity Settings:** Adjust GoogleMock verbosity (e.g., `--gmock_verbose=warning`) to reduce noise.
- **Avoid Over-specifying Matchers:** Use wildcard `_` when argument specifics aren’t important.
- **Clean Mock State After Tests:** Use `Mock::VerifyAndClear` if mocks live beyond test scope.

---

## 6. Common Pitfalls & Troubleshooting

### Test Discovery Fails
- Ensure test executables are linked properly to gtest_main or have a `main()` defined.
- Confirm build system registers the tests (e.g., via `enable_testing()` and `add_test()` in CMake).

### Unexpected or Uninteresting Mock Calls
- Use `ON_CALL` to set defaults.
- Switch to `NiceMock` if warnings are noisy.
- Add explicit `EXPECT_CALL` when you want to enforce call behavior.

### Build Errors Linking GoogleTest
- Verify linking against `pthread` on Linux.
- Match runtime libraries (static vs dynamic CRT) on Windows; use CMake `gtest_force_shared_crt` if needed.

### Flaky or Slow Tests in CI
- Isolate tests that share state.
- Use `--gtest_shuffle` and `--gtest_repeat` flags for stability assessment.

### CI Test Reports Not Showing Results
- Confirm XML report generation flags passed.
- Configure CI to collect artifacts correctly.

---

## 7. Additional Resources & Next Steps

- [Getting Started with GoogleTest](../getting-started/introduction-and-requirements/about-googletest)
- [Installing with CMake](../getting-started/installation-and-configuration/installing-googletest-cmake)
- [Installing with Bazel](../getting-started/installation-and-configuration/installing-googletest-bazel)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Ecosystem Integration Overview](../overview/integration-and-ecosystem/ecosystem-integration) for CI tool tips
- [Troubleshooting Common Issues](../getting-started/first-test-and-validation/troubleshooting)

---

## Example: Minimal CMake Test Integration

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject CXX)

include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/release-1.17.0.zip
)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test_main.cpp)

target_link_libraries(my_tests PRIVATE gtest_main gmock)

enable_testing()
add_test(NAME MyTests COMMAND my_tests)
```

Build and run:

```bash
cmake -S . -B build
cmake --build build
ctest --test-dir build --output-on-failure
```

---

## Example: Simple Bazel Test Target

BUILD file excerpt:

```bazel
load("@rules_cc//cc:defs.bzl", "cc_test")

cc_test(
    name = "my_tests",
    srcs = ["test_main.cpp", "test_example.cpp"],
    deps = ["@com_google_googletest//googletest:main"],
)
```

Run tests:

```bash
bazel test //:my_tests
```

---

## Troubleshooting Checklist

- ✅ Verify your environment meets system requirements (C++17, build tools).
- ✅ Confirm your build system includes GoogleTest and links test executables correctly.
- ✅ Ensure expectations are set before mock method calls.
- ✅ Set default behaviors for mocks with `ON_CALL` to avoid uninteresting call warnings.
- ✅ Use `Mock::VerifyAndClear` appropriately when reusing mocks.
- ✅ In CI, configure XML report output and artifact collection for test results.

---

## Summary

Integrating GoogleTest with your build and CI systems automates robust C++ test execution, providing early defect detection and reliable development workflows. Follow the recommended steps and best practices to streamline test integration, maintain cross-platform compatibility, and enhance your testing efficacy with GoogleTest and GoogleMock.


---