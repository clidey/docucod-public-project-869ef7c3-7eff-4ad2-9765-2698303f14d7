---
title: "Leveraging Advanced Testing Features"
description: "Covers death tests, custom assertions, and user-defined matchers/actions. Guides users on when and how to use these features for special-purpose and edge-case testing."
---

# Leveraging Advanced Testing Features

This guide covers advanced testing capabilities in GoogleTest and GoogleMock, focusing on death tests, custom assertions, and user-defined matchers and actions. These features enable you to write tests for special-purpose scenarios and edge cases, providing precise control over test behavior and verification.

---

## 1. Death Tests: Testing for Program Termination

### What Are Death Tests?
Death tests verify that your code terminates (crashes or exits) under specified error conditions. They ensure your program correctly handles fatal errors, invalid input, or other critical failures.

### When to Use Death Tests
- Testing input validation that calls `abort()` or `exit()`.
- Verifying error conditions in low-level code.
- Ensuring that dangerous operations fail as expected and don't silently continue.

### How to Write a Death Test
Use `EXPECT_DEATH` or `ASSERT_DEATH` macros to run the tested code and check for termination.

```cpp
TEST(FooDeathTest, DiesOnInvalidInput) {
  EXPECT_DEATH({ Foo(-1); }, "Invalid input");
}
```

- The first argument is the code block that should cause death.
- The second argument is a regular expression matched against the standard error output.

### Variations
- **EXPECT_DEATH_IF_SUPPORTED**: Use this when death tests may not be supported on all platforms.
- **EXPECT_DEBUG_DEATH**: Runs death test only in debug builds.
- **EXPECT_EXIT**: Verify termination status and output separately.

### Time Estimate
Setting up and running death tests typically adds minimal overhead but requires careful crafting of terminating code.

<Note>
Ensure that the code inside the death test block terminates promptly to avoid slowing your test suite.
</Note>

---

## 2. Custom Assertions: Extending Verification Capabilities

### Why Custom Assertions?
Standard assertions such as `EXPECT_EQ` and `ASSERT_TRUE` may not always express your test conditions clearly or check complex states.

Custom assertions allow:
- Clear, reusable verification logic.
- Richer diagnostics and error messages.
- Improved test readability and maintenance.

### How to Write Custom Assertions
Implement a function that returns `::testing::AssertionResult`.

```cpp
::testing::AssertionResult IsEven(int n) {
  if (n % 2 == 0)
    return ::testing::AssertionSuccess();
  return ::testing::AssertionFailure() << n << " is not even";
}

TEST(MathTest, CheckEven) {
  int x = 4;
  EXPECT_TRUE(IsEven(x));
}
```

### Using Custom Assertions
- Return `AssertionSuccess()` for passing conditions.
- Return `AssertionFailure()` with descriptive output on failure.

### Advantages
- Integrate seamlessly with GoogleTest's reporting.
- Support complex conditions and detailed explanations.

### Tips
- Provide detailed failure messages for easier debugging.
- Use expressive function names for readability.

---

## 3. User-Defined Matchers and Actions: Tailoring Mock Behavior

GoogleMock supports creating custom matchers and actions to precisely control and verify the interactions with mock objects.

### 3.1 Custom Matchers

#### What are Matchers?
Matchers evaluate function arguments in mock method calls to verify they meet your criteria.

#### When to Define Custom Matchers?
- Standard matchers don’t cover your specific validation needs.
- You want to simplify complex argument checks into reusable components.

#### How to Define a Matcher Easily
Use the `MATCHER` or `MATCHER_P` macros.

```cpp
MATCHER(IsOdd, "checks if a number is odd") {
  return (arg % 2) == 1;
}

MATCHER_P(IsBetween, range, "checks if number is in the range") {
  return arg >= range.first && arg <= range.second;
}
```

Then use them:

```cpp
EXPECT_CALL(mock, Foo(IsOdd()));
EXPECT_CALL(mock, Foo(IsBetween(std::make_pair(10, 20))));
```

#### Advanced Matcher Implementation
For more control, implement a matcher class with `MatchAndExplain()`, `DescribeTo()`, and `DescribeNegationTo()`.

#### Best Practices
- Keep matchers pure (no side effects).
- Provide clear, meaningful descriptions.
- Use parameterized matchers for flexibility.

---

### 3.2 Custom Actions

#### What are Actions?
Actions define what a mock method does when called, e.g., returning a value, modifying arguments, throwing exceptions.

#### When to Create Custom Actions?
- Built-in actions don’t express the logic you need.
- You want to emulate complex side effects or behaviors.

#### Defining Actions Using Lambdas or Functors

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int arg) { return arg * 2; });
```

Or define a struct:

```cpp
struct MultiplyBy {
  int factor;
  int operator()(int n) const { return n * factor; }
};
EXPECT_CALL(mock, Foo(_)).WillOnce(MultiplyBy{10});
```

#### Legacy Macro-Based Definition
Use `ACTION(MyAction)` and `ACTION_P(MyParameterizedAction, param)` macros for pre-C++11 style.

#### Combining Multiple Actions
Use `DoAll()` to perform multiple actions in one call:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

#### Usage Tips
- Make sure the final sub-action returns a compatible value.
- Avoid capturing heavy state in lambdas unless necessary.
- Share reusable stateless actions.

---

## 4. Practical Examples

### Death Test Example

```cpp
TEST(MyDeathTest, AbortOnInvalidPointer) {
  EXPECT_DEATH({ ProcessData(nullptr); }, "null pointer");
}
```

### Custom Assertion Example

```cpp
::testing::AssertionResult IsPositive(int n) {
  if (n > 0) return ::testing::AssertionSuccess();
  return ::testing::AssertionFailure() << n << " is not positive";
}

TEST(NumberTest, PositiveCheck) {
  int value = -1;
  EXPECT_FALSE(IsPositive(value));
}
```

### Custom Matcher Example

```cpp
MATCHER_P(InRange, range, "checks if number in range") {
  return arg >= range.first && arg <= range.second;
}

EXPECT_CALL(mock, SetValue(InRange(std::make_pair(1, 10))));
```

### Custom Action Example

```cpp
ACTION_P(SetFlagAndReturn, flag_ptr) {
  *flag_ptr = true;
  return true;
}

bool flag = false;
EXPECT_CALL(mock, DoWork())
    .WillOnce(SetFlagAndReturn(&flag));
```

---

## 5. Troubleshooting & Tips

### Death Tests
- If the death test never ends, ensure the tested code truly causes termination.
- Run death tests separately if they interfere with other tests.

### Custom Assertions
- Always provide descriptive failure messages.
- Don't perform side effects inside assertions.

### User-Defined Matchers
- Avoid matchers with side effects.
- Use `MATCHER_P` for reusable, parameterized matchers.
- If failing to match, double-check argument types and const-correctness.

### User-Defined Actions
- Use lambdas for quick, simple actions.
- Ensure actions return the correct type.
- Beware of move-only arguments when writing actions.

---

## 6. Next Steps & Related Content

- Master mock objects and expectations with the [Basics of Mocking](https://google.github.io/googletest/gmock_for_dummies.html) and [Mocking Best Practices](https://google.github.io/googletest/guides/mocking-best-practices/basics-of-mocking.html).
- Explore advanced matchers and actions in the [Matchers Reference](../../api-reference/gtest-core/matchers-reference) and [Actions Reference](../../api-reference/gmock-api/actions-and-cardinalities).
- Learn about call sequencing and strictness modes with [Specification Patterns](https://google.github.io/googletest/guides/mocking-best-practices/actions-matchers-sequences.html).
- Read the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for comprehensive recipes.

---

## References

- [GoogleTest Assertions Reference](../api-reference/gtest-core/assertions-reference.md)
- [GoogleMock Mocking Reference](../api-reference/gmock-api/mock-methods.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md)
- [gMock FAQ](docs/gmock_faq.md)

---

This guide empowers you to incorporate rigorous and expressive tests for edge cases and failure modes, enhancing your testing discipline with GoogleTest and GoogleMock.