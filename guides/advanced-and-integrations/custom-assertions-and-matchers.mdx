---
title: "Building Custom Assertions and Matchers"
description: "Demonstrates how to extend GoogleTest with user-defined assertions and matchers. Walks through practical examples for domain-specific checks and illustrates pitfalls to avoid for maintainable custom code."
---

# Building Custom Assertions and Matchers

GoogleTest and GoogleMock empower you to extend their verification capabilities with user-defined assertions and matchers. This guide focuses specifically on creating **custom assertions and matchers** that can check domain-specific conditions, improving expressiveness and clarity in your tests. You'll learn practical examples, understand common pitfalls, and gain best practices to keep your custom code maintainable.

---

## 1. Workflow Overview

### What This Guide Helps You Accomplish

- Learn to write custom assertion predicates that report rich diagnostics.
- Define simple and parameterized matchers tailored to your domain types.
- Integrate your custom assertions and matchers seamlessly with GoogleTest and GoogleMock assertions.
- Understand how to add meaningful failure messages and leverage the gMock matcher framework.

### Prerequisites

- Familiarity with GoogleTest assertions basics and general mocking concepts.
- Basic familiarity with C++ template programming.
- GoogleTest and GoogleMock installed and set up in your environment.

### Expected Outcome

You will be able to create custom `MATCHER` macros for simple predicates, `MATCHER_P` for parameterized matchers, and provide predicate functions returning detailed `AssertionResult`. With these tools, you write clearer, more maintainable tests that properly express your domain requirements.

### Time Estimate

This guide can be read and applied in under 30 minutes, with some additional time for experimentation.

### Difficulty Level

Intermediate: requires knowledge of C++ assertions and test writing.

---

## 2. Building Custom Assertions and Matchers

### 2.1 Writing Simple Custom Matchers Using `MATCHER`

GoogleMock provides the `MATCHER` macro to define custom matchers concisely at namespace scope.

```cpp
MATCHER(IsEven, "Checks if a number is even") {
  return (arg % 2) == 0;
}
```

- Inside the macro body, `arg` is the value being matched.
- Your logic returns `true` if the assertion passes, otherwise `false`.
- The second argument is a description string for failure messages.

#### Usage Example

```cpp
EXPECT_CALL(mock_obj, Method(IsEven()));
EXPECT_THAT(value, IsEven());
```

If the matcher fails, GoogleTest output will include the description:

```
Value of: value
Expected: Checks if a number is even
  Actual: 5
```

### 2.2 Writing Parameterized Matchers Using `MATCHER_P` and Variants

When your assertion needs configurable parameters, use `MATCHER_P` (or `MATCHER_P2`, etc) to define a matcher template with parameters:

```cpp
MATCHER_P(HasAbsoluteValue, abs_val, "") {
  return std::abs(arg) == abs_val;
}
```

Usage:

```cpp
EXPECT_THAT(num, HasAbsoluteValue(10));
```

Failure message example:

```
Value of: num
Expected: has absolute value 10
  Actual: -9
```

You can define up to 10 parameters with `MATCHER_P2`, ..., `MATCHER_P10`.

### 2.3 Adding Detailed Failure Messages

Your custom matcher can stream extra diagnostic information to `result_listener`:

```cpp
MATCHER_P(IsDivisibleBy7, "") {
  if ((arg % 7) == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

This enriches failure output with why the match failed:

```
Value of: val
Expected: is divisible by 7
  Actual: 23 (the remainder is 2)
```

### 2.4 Writing Predicate Functions Returning `AssertionResult`

You can also write custom Boolean functions returning `::testing::AssertionResult` to use in predicate assertions `EXPECT_PRED_FORMAT*` or `EXPECT_TRUE`:

```cpp
::testing::AssertionResult IsEven(int n) {
  if ((n % 2) == 0) return ::testing::AssertionSuccess();
  return ::testing::AssertionFailure() << n << " is odd";
}
```

Use it like:

```cpp
EXPECT_TRUE(IsEven(value));
```

Failures report expressive messages without you manually writing failure macros.

### 2.5 Defining Custom Matcher Classes for More Control

For complex use cases or reusable matchers, implement a matcher class with:

- A typedef `using is_gtest_matcher = void;` to identify as a matcher.
- A `bool MatchAndExplain(const T& value, std::ostream* listener)` (or `MatchResultListener*`) method.
- `void DescribeTo(std::ostream* os)` and `void DescribeNegationTo(std::ostream* os)` methods to provide readable descriptions.

Example:

```cpp
class DivisibleBy7Matcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    const int remainder = n % 7;
    if (remainder == 0) return true;
    if (os) *os << "the remainder is " << remainder;
    return false;
  }

  void DescribeTo(std::ostream* os) const { *os << "is divisible by 7"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is not divisible by 7"; }
};

::testing::Matcher<int> DivisibleBy7() {
  return DivisibleBy7Matcher();
}
```

---

## 3. Practical Examples

### 3.1 Simple Custom Matcher Example

```cpp
MATCHER(IsPositive, "") {
  return arg > 0;
}

TEST(MyTest, PositiveCheck) {
  EXPECT_THAT(5, IsPositive());  // Passes
  EXPECT_THAT(-1, IsPositive()); // Fails with "Expected: is positive"
}
```

### 3.2 Parameterized Matcher Example

```cpp
MATCHER_P(LessThan, threshold, "") {
  return arg < threshold;
}

TEST(MyTest, LessThanCheck) {
  EXPECT_THAT(3, LessThan(5));  // Passes
  EXPECT_THAT(7, LessThan(5));  // Fails with "Expected: less than 5"
}
```

### 3.3 Detailed Match Failure Message

```cpp
MATCHER_P(IsMultipleOf, factor, "") {
  if (arg % factor == 0) return true;
  *result_listener << "which leaves a remainder " << (arg % factor);
  return false;
}

TEST(MyTest, MultipleOfCheck) {
  EXPECT_THAT(10, IsMultipleOf(3));
}
// Failure output includes "which leaves a remainder 1"
```

### 3.4 Using Predicate Functions in Assertions

```cpp
testing::AssertionResult IsEven(int n) {
  if (n % 2 == 0) return testing::AssertionSuccess();
  return testing::AssertionFailure() << n << " is odd";
}

TEST(PredicateTest, EvenCheck) {
  EXPECT_TRUE(IsEven(4));  // Passes
  EXPECT_FALSE(IsEven(5)); // Fails with message "5 is odd"
}
```

---

## 4. Best Practices & Common Pitfalls

- **Avoid Side Effects in Matchers:** Custom matchers must be pure functions without side effects as gMock may call them multiple times.
- **Readable Descriptions:** Provide clear, meaningful description strings or stream diagnostics to `result_listener` for informative failure messages.
- **Parameterize for Reuse:** Use parameterized matchers to avoid code duplication and improve maintainability.
- **Use Predicate-Format Assertions When Needed:** For complex predicates where arguments don't support streaming, or custom message formats are desired.
- **Prefer Matchers Over Manual Boolean Assertions:** Use `EXPECT_THAT` with matchers rather than raw boolean logic for clearer intent and better diagnostics.
- **Remember to put `MOCK_METHOD` Declarations in `public:` Section:** This enables the mocking framework to work correctly even if the base methods are protected or private.

---

## 5. Troubleshooting & Tips

### Common Issues

- **Matcher Functions Not Called:** Check that your matcher returns a `bool` or `AssertionResult`. Returning nothing or non-boolean leads to compile or runtime errors.
- **No Failure Message on Custom Predicate:** Ensure you use `AssertionResult` and stream helpful messages when returning failure.
- **Too Verbose Failure Messages:** Use concise description strings and only add additional info in `result_listener` when it can assist the user.
- **Overly Complex Matchers:** If your matcher logic becomes complicated, consider breaking it down or using a matcher class.

### Tips

- Use `SCOPED_TRACE` to add contextual messages to failures inside predicates or deeply nested matchers.
- When matching containers, use container matchers like `ElementsAre` combined with your custom matchers.
- To match nested fields, use `Field()` and `Property()` with your custom predicate matchers as parameters.

---

## 6. Next Steps & Related Content

- Explore the [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) for advanced mocking techniques.
- Read about [Writing Effective Assertions and Using Matchers](https://docs.example.com/guides/core-usage-patterns/assertions-and-matchers-best-practices) to improve test clarity.
- Learn about [Using Actions](https://docs.example.com/guides/core-usage-patterns/actions-and-behaviors) to combine custom matchers with behaviors.
- Consider the [Matchers Reference](https://github.com/google/googletest/blob/main/googlemock/include/gmock/gmock-matchers.h) for built-in matcher APIs.
- Consult [Predicate Assertions](https://docs.example.com/reference/assertions.md#predicates) for detailed information on `EXPECT_PRED*` macros.

---

For complete mastery, combine your custom assertions and matchers with proper mock usage patterns, and keep test code maintainable, reliable, and expressive.

---

<Info>
This page focuses specifically on extending GoogleTest with custom assertions and matchers. For related topics, see the [Mocking Reference](reference/mocking.md) for how to use `EXPECT_CALL` and `ON_CALL`, and the [Assertions Reference](reference/assertions.md) for assertion macros.
</Info>

---

[Full MATCHER macro documentation](https://github.com/google/googletest/blob/main/googlemock/include/gmock/gmock-matchers.h#L100)

[Custom Predicate Assertion Documentation](https://docs.example.com/guides/advanced-and-integrations/custom-assertions-and-matchers)

[GoogleTest Assertions Guide](reference/assertions.md)

[GoogleMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)

---
