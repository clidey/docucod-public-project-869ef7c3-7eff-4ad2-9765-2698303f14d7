---
title: "Testing Error Handling and Crashes with Death Tests"
description: "Introduces death tests as a technique for validating error-handling paths that involve program termination. Offers examples and strategies to implement and debug death tests reliably across platforms."
---

# Testing Error Handling and Crashes with Death Tests

## Overview

Death tests in GoogleTest allow you to verify that a piece of code causes the program to terminate as expected, typically due to failing critical assertions or fatal error conditions. This technique is indispensable when validating error-handling paths in your application that lead to abnormal termination, ensuring your code behaves safely and predictably in catastrophic scenarios.

This guide walks you through the purpose, usage, styles, and best practices of death tests, helping you implement and debug them effectively across different platforms.

---

## Prerequisites

- Familiarity with writing basic GoogleTest unit tests.
- Basic understanding of test assertions (e.g., `EXPECT_*` and `ASSERT_*`).
- A test suite or code segment that needs crash or termination validation.
- GoogleTest built with death test support enabled (`GTEST_HAS_DEATH_TEST` defined).

---

## What You Will Learn

- How death tests function and when to use them.
- The key macros to implement death tests: `EXPECT_DEATH`, `ASSERT_DEATH`, `EXPECT_EXIT`, and `ASSERT_EXIT`.
- Death test styles and how they impact safety and performance.
- How to write robust death tests using matchers for expected error output.
- Handling common pitfalls and debugging death tests.

---

## Expected Outcome

By the end of this guide, you will be able to write death tests that reliably capture program crashes, process exits, or abnormal terminations. Your tests will assert that the process ends with expected exit codes or signals, and that the error messages output to stderr match your validation criteria.

You will also understand how to configure and troubleshoot death tests to work smoothly even on multithreaded systems or platforms with different process semantics.

---

## Time Commitment

Estimated time: 20-30 minutes to grasp the concepts and write your first death tests.

Difficulty Level: Intermediate


# Using Death Tests in GoogleTest

## What Are Death Tests?

Death tests ensure that code terminates the process in an expected way, for example due to a failed assertion or a call to `exit()`. Unlike normal tests, death tests involve running the test code in a separate process to isolate the crash and keep the main test program alive.


## When to Use Death Tests

- To validate assertion failures that should abort program execution.
- To verify that fatal errors cause process termination.
- To test error-handling code paths that involve calls to `abort()`, `_Exit()`, or signals.


## Key Macros for Death Tests

GoogleTest offers an API that involves four primary macros:

- `EXPECT_DEATH(statement, matcher)` / `ASSERT_DEATH(statement, matcher)`
  - Assert that executing `statement` causes a non-zero exit and error output matching `matcher`.
  - `EXPECT_DEATH` continues test execution on failure; `ASSERT_DEATH` aborts.

- `EXPECT_EXIT(statement, predicate, matcher)` / `ASSERT_EXIT(statement, predicate, matcher)`
  - Assert that `statement` terminates with an exit status satisfying `predicate` and stderr matching `matcher`.
  - `predicate` is typically a matcher like `ExitedWithCode` or `KilledBySignal`.

- `EXPECT_DEATH_IF_SUPPORTED(statement, matcher)` / `ASSERT_DEATH_IF_SUPPORTED(statement, matcher)`
  - Like above, but on platforms without death test support, these macros will do nothing (generate a warning instead).

- `EXPECT_DEBUG_DEATH` / `ASSERT_DEBUG_DEATH`
  - In debug builds, they behave like `EXPECT_DEATH`; in release, they only execute `statement` (without asserting death).


## How To Write a Basic Death Test

Death tests require two components:

1. **Statement Under Death Test**: A statement or compound statement that, when executed, causes process termination.
2. **Matcher for Stderr**: A regular expression or matcher object which matches the expected error output.

Example:

```cpp
TEST(MyDeathTest, CrashOnInvalidInput) {
  ASSERT_DEATH(
    DoSomethingInvalid(),
    "Error: Invalid input detected"
  );
}

TEST(MyDeathTest, ExitsWithCodeZero) {
  EXPECT_EXIT(
    ExitNormally(),
    ::testing::ExitedWithCode(0),
    "Success"
  );
}
```


## Matching Error Messages

Severity or debugging messages printed to `stderr` by the statement are matched against the supplied regex or matcher. A bare string is treated as a regular expression (using `ContainsRegex`).

### Supported Regex Syntax

GoogleTest supports a limited subset of regular expressions across platforms: literal characters, `\d`, `\w`, `\s`, and quantifiers like `?`, `*`, `+`. Advanced features like grouping and alternation are unsupported.


## Understanding Death Test Styles

Due to potential threading and process forking issues, GoogleTest supports two death test styles controllable via the `--gtest_death_test_style` flag or programmatic API:

1. **Fast Style (`fast`)**
   - The test forks the process and immediately runs the death test in the child.
   - Faster but less safe for tests running in multithreaded contexts.

2. **Threadsafe Style (`threadsafe`)**
   - The child process re-executes the entire test binary with flags causing only the death test to run.
   - Safer when threads have been created before death tests run but significantly slower.

The default style is configurable globally or per-test via `GTEST_FLAG_SET(death_test_style, "threadsafe")`.


## Best Practices and Practical Tips

- Name test suites containing death tests with the suffix `DeathTest` to ensure they run before others.
- Avoid non-void statements that return or throw exceptions inside death test macros; such cases are treated as failure.
- Put complex side-effect-inducing code outside death tests or be aware that such changes will not affect the parent process.
- You can use streaming (`<<`) for additional error context messages inside death test macros.
- Use `EXPECT_DEATH_IF_SUPPORTED` to maintain portability across platforms.
- Avoid multiple death tests on the same source code line to prevent macro expansion conflicts.
- In debug mode, consider using `EXPECT_DEBUG_DEATH` for testing conditional death (e.g., checks enabled only in debug).


## Advanced Usage

### Handling Multithreaded Code and Warnings

If multiple threads are running when a death test starts, GoogleTest emits a warning because `fork()` can cause issues with threads. Using the `threadsafe` style can mitigate some threading problems, although it's slower.

### Testing Functions that Take Parameters

Death tests can be used with parameterized functions or methods, including:

```cpp
EXPECT_DEATH(DieIf(true), "DieIf\(\)");
EXPECT_DEATH(DieIfLessThan(2, 3), "DieIfLessThan");
```

### Writing Death Tests in Loops

Death tests can be iterated safely within loops. Each iteration independently triggers a death test:

```cpp
for (int i = 0; i < 5; i++) {
  EXPECT_DEATH(DieIfLessThan(-1, i), "DieIfLessThan") << "where i == " << i;
}
```

### Compound Statements

The death test statement can be a block of code enclosed in braces:

```cpp
ASSERT_DEATH({
  const int x = 2;
  const int y = x + 1;
  DieIfLessThan(x, y);
}, "DieIfLessThan");
```

### Debugging Failure Causes

- Use the last death test message `DeathTest::LastMessage()` to find why a death test failed.
- Common failure reasons include:
  - The statement did not cause death (`LIVED` outcome).
  - The process exited with an unexpected code.
  - The error message did not match.
  - The statement returned instead of dying.
  - The statement threw an exception.


## Example Walkthrough

```cpp
class ExampleDeathTest : public testing::Test {
 public:
  static void WillDie() {
    fprintf(stderr, "Fatal error\n");
    _Exit(1);  // direct exit without cleanup
  }
};

TEST_F(ExampleDeathTest, AssertionThatDies) {
  ASSERT_DEATH(WillDie(), "Fatal error");
}
```

This test verifies that `WillDie()` terminates the process and its `stderr` output contains "Fatal error".


## Troubleshooting Common Failures

<AccordionGroup title="Troubleshooting Death Tests">
<Accordion title="Death test fails because the statement did not cause death">
Usually means that the tested function didn't terminate or exit the process. Verify that the code under test calls `abort()`, `_Exit()`, or equivalent.
</Accordion>
<Accordion title="Regex doesn't match output">
Make sure the regex pattern covers the exact text generated on stderr. Use supported syntax only. Use tools like `grep` or simple partial matches to narrow the pattern.
</Accordion>
<Accordion title="Death tests timed out or hang">
May be due to threading conflicts or deadlocks. Try switching to the `threadsafe` style by setting `GTEST_FLAG_SET(death_test_style, "threadsafe")`.
</Accordion>
<Accordion title="Multiple threads warning">
Forking with multiple threads is unsafe. Minimize threads before death tests or use `threadsafe` style. Avoid spawning threads outside death tests where possible.
</Accordion>
<Accordion title="Death test macros cause compilation errors or unreachable code warnings">
Ensure death tests are on their own line and not mixed with other statements on the same line. Compound statements should be wrapped in braces.
</Accordion>
</AccordionGroup>


## Next Steps and Further Reading

- Explore the [Assertions Reference](../reference/assertions.md#death) for detailed macro usage.
- Learn about [Handling Failures](../guides/core-usage-patterns/assertions-and-matchers-best-practices.md) to write robust tests.
- Read about [Death Tests and Threads](../advanced.md#death-tests) to understand threading considerations.
- Check out the [GoogleTest Primer](../overview/introduction-value/product-purpose.md) for getting started and basic testing concepts.
- Use `EXPECT_DEATH_IF_SUPPORTED` macros to gracefully handle platforms without death test support.


---

## Summary

This guide has introduced death tests as a critical method for verifying error handling and crash scenarios in your code with GoogleTest. You have learned how to write death tests, match expected error outputs, use tests for exit codes and signals, choose between death test styles, and troubleshoot common pitfalls.

Implementing death tests improves the reliability of your error checks and ensures your program fails predictably under fatal conditions.


---

## Additional Resources

- [GoogleTest Assertions Reference - Death Tests](../reference/assertions.md#death)
- [GoogleTest Advanced Guide - Death Tests](../advanced.md#death-tests)
- [Writing Effective Assertions and Using Matchers](../guides/core-usage-patterns/assertions-and-matchers-best-practices.md)
- [Threadsafe Death Test Style Explanation](../advanced.md#death-tests)

