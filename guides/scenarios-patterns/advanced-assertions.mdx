---
title: "Assertions and Matchers in Depth"
description: "Dive deeper into GoogleTest's rich assertion macros and GoogleMock's flexible matchers. This guide illustrates practical matcher usage, custom matcher creation, and assertion strategies for expressive tests."
---

# Assertions and Matchers in Depth

## Overview

This guide takes you deep into GoogleTest's assertion macros and GoogleMock's matchers, showing you how to write expressive, precise tests. You will learn how to use built-in assertions for various data types and conditions, create custom matcher predicates for nuanced validations, and combine matchers to form expressive expectations. The guide also includes strategies for crafting detailed failure messages and working with assertions to manage test flow and output.

---

## 1. GoogleTest Assertions Beyond Basics

### 1.1 Assertion Types: Nonfatal vs Fatal

- **EXPECT_*** assertions generate *nonfatal* failures, allowing the test function to continue after failure. Use these when you want to report multiple failures in a test.
- **ASSERT_*** assertions produce *fatal* failures, aborting the current test function immediately. Use when continuing after failure does not make sense.

Both kinds support custom failure messages appended via the streaming operator `<<`.

### 1.2 Explicit Success and Failure

- **SUCCEED()**: Explicitly marks a successful assertion; mostly used as documentation.
- **FAIL()**: Generates a fatal failure unconditionally and aborts the current function.
- **ADD_FAILURE()**: Generates a nonfatal failure but allows continuation.
- **ADD_FAILURE_AT(file, line)**: Similar to `ADD_FAILURE()`, but attributes the failure to a specific source code location.

### 1.3 Boolean Condition Assertions

- `EXPECT_TRUE(condition)` and `ASSERT_TRUE(condition)` verify that *condition* is true.
- `EXPECT_FALSE(condition)` and `ASSERT_FALSE(condition)` verify that *condition* is false.

When such assertions fail, GoogleTest shows the expression and the actual value, helping you locate the problem faster.

### 1.4 Binary Comparison Assertions

Compare two values with relational operators:

- `EXPECT_EQ(val1, val2)`, `ASSERT_EQ(val1, val2)` for equality
- `EXPECT_NE(val1, val2)`, `ASSERT_NE(val1, val2)` for inequality
- `EXPECT_LT(val1, val2)`, `ASSERT_LT(val1, val2)` for less-than
- `EXPECT_LE(val1, val2)`, `ASSERT_LE(val1, val2)` for less-than or equal
- `EXPECT_GT(val1, val2)`, `ASSERT_GT(val1, val2)` for greater-than
- `EXPECT_GE(val1, val2)`, `ASSERT_GE(val1, val2)` for greater-than or equal

**Important:** For C strings, use `EXPECT_STREQ` and friends for content comparison instead of pointer equality.

### 1.5 String Assertions

- `EXPECT_STREQ(str1, str2)` and `ASSERT_STREQ(str1, str2)` verify C strings have the same content.
- `EXPECT_STRNE(str1, str2)` and `ASSERT_STRNE(str1, str2)` verify C strings differ.
- `EXPECT_STRCASEEQ(str1, str2)` and `ASSERT_STRCASEEQ(str1, str2)` ignore case when comparing.
- `EXPECT_STRCASENE(str1, str2)` and `ASSERT_STRCASENE(str1, str2)` verify inequality ignoring case.

Wide strings (`wchar_t*`) are fully supported and printed as UTF-8 when failures occur.

### 1.6 Floating-Point Assertions

Floating-point comparisons must consider rounding errors. These macros use a tolerance based on Units in the Last Place (ULPs):

- `EXPECT_FLOAT_EQ(val1, val2)`, `ASSERT_FLOAT_EQ(val1, val2)`: For `float` values approximately equal within 4 ULPs.
- `EXPECT_DOUBLE_EQ(val1, val2)`, `ASSERT_DOUBLE_EQ(val1, val2)`: Same for `double`.
- `EXPECT_NEAR(val1, val2, abs_error)`, `ASSERT_NEAR(val1, val2, abs_error)`: Check that the absolute difference is within `abs_error`. Treats infinities and NaN appropriately.

Additionally, predicate-format functions `FloatLE` and `DoubleLE` allow more precise floating-point comparisons with `EXPECT_PRED_FORMAT2`.

### 1.7 Exception Assertions

Require exceptions support to be enabled.

- `EXPECT_THROW(statement, exception_type)`, `ASSERT_THROW(...)`: Checks if `statement` throws specified exception.
- `EXPECT_ANY_THROW(statement)`, `ASSERT_ANY_THROW(...)`: Checks if any exception thrown.
- `EXPECT_NO_THROW(statement)`, `ASSERT_NO_THROW(...)`: Checks `statement` does not throw.

Example:

```cpp
EXPECT_THROW(FunctionUnderTest(), std::runtime_error);
```


## 2. Predicate Assertions for Enhanced Expressiveness

GoogleTest supports predicate-based assertions to make failure messages more informative.

### 2.1 Simple Predicates with `EXPECT_PRED*` and `ASSERT_PRED*`

Use these when you have a Boolean function/functor and want arguments printed when the assertion fails.

Example (checking mutual primality):

```cpp
bool MutuallyPrime(int m, int n);  // returns true if m and n are coprime

EXPECT_PRED2(MutuallyPrime, 3, 4);  // Success
EXPECT_PRED2(MutuallyPrime, 4, 6);  // Failure, message prints argument values
```

Note: If your predicate is overloaded or templated, you may need to specify its type explicitly.

### 2.2 Better Messages with Predicate-Format Assertions

If you want to control failure messages precisely or your arguments are not easily printable, use predicate-format assertions:

- `EXPECT_PRED_FORMATn(predicate_formatter, val1, ..., valn)`
- `ASSERT_PRED_FORMATn(predicate_formatter, val1, ..., valn)`

A predicate-formatter function returns `AssertionResult` and has the signature:

```cpp
testing::AssertionResult PredicateFormatter(const char* expr1, const char* expr2, ..., T1 val1, T2 val2, ...);
```

Example:

```cpp
testing::AssertionResult AssertMutuallyPrime(const char* m_expr, const char* n_expr, int m, int n) {
  if (MutuallyPrime(m, n)) return testing::AssertionSuccess();
  return testing::AssertionFailure() << m_expr << " and " << n_expr << " (" << m << " and " << n << ") are not mutually prime";
}

EXPECT_PRED_FORMAT2(AssertMutuallyPrime, 3, 4);  // Pass
EXPECT_PRED_FORMAT2(AssertMutuallyPrime, 4, 6);  // Fails with message that prints arguments
```

This approach allows detailed failure messages tailored to your predicate logic.


## 3. Asserting Using GoogleMock Matchers

While GoogleTest assertions verify single values or expressions, GoogleMock extends this by allowing expectations about function parameters using *matchers* — expressive predicates about values.

### 3.1 Using `EXPECT_THAT` With Matchers

The macro:

```cpp
EXPECT_THAT(value, matcher);
ASSERT_THAT(value, matcher);
```

verifies that `value` satisfies the conditions set by `matcher`. Matchers add English-like expressiveness to tests and improve failure messages.

Example:

```cpp
using ::testing::StartsWith;
using ::testing::MatchesRegex;
using ::testing::AllOf;
using ::testing::Gt;
using ::testing::Lt;

EXPECT_THAT(string_value, StartsWith("Hello"));
EXPECT_THAT(another_string, MatchesRegex("Line \\d+"));
ASSERT_THAT(number, AllOf(Gt(5), Lt(10)));
```

If these fail, the message clearly states which matcher failed, helping diagnose issues.

### 3.2 Built-in Matchers and Custom Matchers

GoogleMock provides a rich library of built-in matchers, including:

- Wildcards like `_` (any value)
- Equality and comparison matchers (`Eq()`, `Ne()`, `Ge()`, etc.)
- Container matchers (`ElementsAre()`, `Contains()`, `IsEmpty()`, etc.)
- String matchers (`StartsWith()`, `EndsWith()`, `HasSubstr()`, `MatchesRegex()`, etc.)

You can also write your own custom matchers and integrate them seamlessly to articulate your testing needs.


## 4. Writing Custom Matchers

Sometimes, you need to write matchers for special types or complex criteria.

### 4.1 Basic Custom Matcher Using Lambda (C++11+)

You can use `Invoke` or custom lambdas in expectations.

Example:

```cpp
EXPECT_THAT(value, [](int x) { return x % 2 == 0; });  // checks evenness
```

However, this provides no expressive failure report.

### 4.2 Custom Matchers with `MATCHER` Macro

GoogleMock provides the `MATCHER` macro to help create custom matchers with informative messages.

Example to check even numbers:

```cpp
MATCHER(IsEven, "is an even number") {
  return (arg % 2) == 0;
}

EXPECT_THAT(4, IsEven());  // Passes
EXPECT_THAT(5, IsEven());  // Fails with message "Expected: is an even number"
```

More sophisticated matchers can be written to print reasons for failure.

### 4.3 Writing Matchers as Classes

You can create classes implementing the Matcher concepts. For example:

```cpp
class IsMultipleOfMatcher : public MatcherInterface<int> {
 public:
  explicit IsMultipleOfMatcher(int divisor) : divisor_(divisor) {}

  bool MatchAndExplain(int x, MatchResultListener* listener) const {
    if (x % divisor_ == 0) return true;
    *listener << x << " is not a multiple of " << divisor_;
    return false;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is a multiple of " << divisor_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not a multiple of " << divisor_;
  }

 private:
  const int divisor_;
};

inline Matcher<int> IsMultipleOf(int divisor) {
  return MakeMatcher(new IsMultipleOfMatcher(divisor));
}

EXPECT_THAT(6, IsMultipleOf(3));  // Succeeds
EXPECT_THAT(7, IsMultipleOf(3));  // Fails
```


## 5. Advanced Assertion Strategies

### 5.1 Managing Assertions with `EXPECT_NO_FATAL_FAILURE` and `ASSERT_NO_FATAL_FAILURE`

Sometimes you want to assert that a *block* of code produces *no* fatal errors.

Usage:

```cpp
ASSERT_NO_FATAL_FAILURE({ SomeTestHelper(); });
EXPECT_NO_FATAL_FAILURE(SomeOtherTestHelper());
```

They verify that no fatal failures were generated during the execution of the supplied statement.

### 5.2 Using `HasFatalFailure()`, `HasNonfatalFailure()`, and `HasFailure()`

These functions check if the current test has any failures.

Usage:

```cpp
if (HasFatalFailure()) {
  return;  // Abort further testing on fatal error.
}
```

### 5.3 Skipping Tests at Runtime

You can skip tests dynamically with `GTEST_SKIP();` in test bodies or `SetUp` methods.

Example:

```cpp
TEST(MyTest, ConditionallySkip) {
  if (!IsFeatureAvailable()) {
    GTEST_SKIP() << "Feature not available";
  }
  ... test code ...
}
```

Skip messages appear in test output and reports.


## 6. Customizing Assertion Output

### 6.1 Appending Messages to Assertions

All assertion macros support appending messages with `<<` operator for more context:

```cpp
EXPECT_EQ(x, y) << "Details about x and y";
```

Messages appear after the failure description.

### 6.2 Streaming Custom Types

GoogleTest will print well-known types, STL containers, and types with `operator<<` defined. For your own types, specialize printing by:

- Implementing a `PrintTo(const T&, std::ostream*)` function in the same namespace.
- Alternatively, define `AbslStringify()` if you use Abseil.

Example:

```cpp
namespace foo {
class Point {
  friend void PrintTo(const Point& p, std::ostream* os) {
    *os << "(" << p.x << ", " << p.y << ")";
  }
  int x, y;
};
}
```

### 6.3 Handling NUL Characters in Strings

GoogleTest replaces NUL characters(`\0`) with `"\\0"` in printed strings to avoid truncated outputs.


## 7. Common Pitfalls & Best Practices

### 7.1 Use `ASSERT_*` Where Continuing After Failure Doesn’t Make Sense

### 7.2 Avoid Fatal Assertions in Constructors or Destructors

Instead, use `SetUp()`/`TearDown()` methods, as fatal assertions in constructors/destructors won't abort the test as expected and may cause undefined behavior.

### 7.3 Use Predicate Assertions Over Manual `EXPECT_TRUE`

Avoid crafting detailed failure messages manually inside `EXPECT_TRUE`, as predicate/assertion formaters generate more informative messages and handle argument evaluation safely.

### 7.4 Remember That Assertion Arguments Are Always Evaluated Exactly Once

This avoids duplicated side effects or unexpected behavior.

### 7.5 Be Mindful When Using Assertions in Subroutines

Use `SCOPED_TRACE` to add contextual trace information to failure messages within helper functions.

Example:

```cpp
SCOPED_TRACE("processing item " + std::to_string(i));
DoWork(i);
```

### 7.6 When Using Death Tests, Name the Test Suites Ending With `DeathTest`

This ensures death tests run first and mitigates threading issues.


## 8. Resources and Further Reading

- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [Assertions Reference](reference/assertions.md)
- [Matchers Reference](reference/matchers.md)
- [Mocking Reference](reference/mocking.md)
- [Advanced GoogleTest Topics](advanced.md)

---

## Appendix: Sample Code Snippets

### Basic Assertion Example

```cpp
TEST(FactorialTest, HandlesZeroInput) {
  EXPECT_EQ(Factorial(0), 1) << "Factorial of zero should be one";
}
```

### Predicate Assertion Example

```cpp
bool MutuallyPrime(int m, int n);

EXPECT_PRED2(MutuallyPrime, 3, 4);  // Passes
EXPECT_PRED2(MutuallyPrime, 6, 9);  // Fails, failure prints args.
```

### Predicate-Formatter Example

```cpp
testing::AssertionResult AssertEven(const char* expr, int n) {
  if (n % 2 == 0) return testing::AssertionSuccess();
  return testing::AssertionFailure() << expr << " is not even, but " << n;
}

EXPECT_PRED_FORMAT1(AssertEven, 3);  // Fails with custom message.
```

### GoogleMock Matcher Example

```cpp
using ::testing::StartsWith;
EXPECT_THAT("Hello world", StartsWith("Hello"));
```


## Troubleshooting & Tips

- For unexpected assertion failures, inspect the detailed failure message including streamed context.
- Use `SCOPED_TRACE` to add helpful trace context if failure messages lack clarity.
- Avoid mixing `ASSERT_*` and `EXPECT_*` improperly; use fatal assertions where necessary to stop further operations.
- When comparing C strings, prefer `EXPECT_STREQ` over `EXPECT_EQ` to avoid pointer comparisons.
- Use predicate-format assertions for complex validations needing explanatory failures.

<Accordion title="Common Mistakes with Assertions">

**Mistake:** Using `EXPECT_EQ` to compare C strings.

**Fix:** Use `EXPECT_STREQ` for content comparison.

**Mistake:** Using fatal assertions (`ASSERT_*`) in constructors.

**Fix:** Put fatal assertions in `SetUp()` instead.

</Accordion>


## Next Steps & Related Guides

- Writing Your First Tests — a beginner-friendly introduction.
- Creating and Using Mocks — for using GoogleMock's powerful matcher and expectation API.
- Advanced GoogleTest Topics — for deep dives into parameterized tests, typed tests, and event listeners.

---

*This guide empowers you to harness the full expressiveness of GoogleTest assertions and GoogleMock matchers, enabling robust, clear, and maintainable tests.*