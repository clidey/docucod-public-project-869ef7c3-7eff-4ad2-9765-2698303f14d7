---
title: "Mocking Best Practices"
description: "Practical advice for using mocks effectively, including maintaining test readability, balancing strictness versus leniency, testing legacy code, and avoiding common pitfalls in large projects."
---

# Mocking Best Practices

Practical advice for using mocks effectively, focusing on maintaining test readability, balancing strictness and leniency, handling legacy code, and avoiding common pitfalls in large projects.

---

## Workflow Overview

### Objective
This guide helps you leverage mocking techniques in GoogleTest to write reliable, maintainable, and effective tests. It focuses on best practices that optimize the use of mocks, helping you balance between verifying interactions properly and keeping your tests readable and maintainable.

### Prerequisites
- A working understanding of GoogleTest and GoogleMock basics.
- Familiarity with creating mocks using `MOCK_METHOD`.
- Access to your codebase with mock classes implemented.

### Expected Outcome
By following this guide, you will be able to:
- Write mocks that support readable and maintainable tests.
- Choose appropriate mock strictness (Nice, Naggy, Strict) for different scenarios.
- Handle legacy codebases effectively by adapting mock practices.
- Avoid common pitfalls, especially in larger projects.

### Time Estimate
Approximately 20-40 minutes depending on familiarity and complexity of your test suite.

### Difficulty Level
Intermediate â€“ assumes basic mocking knowledge and C++ proficiency.

---

## Best Practices for Using Mocks Effectively

### 1. Maintain Test Readability

- **Keep Expectations Clear and Minimal**: Only specify expectations on methods that are essential for the test. Avoid overspecifying calls that don't impact the verification goal.

- **Use Wildcards (`_`) and Parameter Matchers Prudently**: Match only the needed arguments, using wildcards or flexible matchers (`_`, `AnyNumber()`, `Ge()`, etc.) to avoid brittle tests.

- **Use `ON_CALL` for Default Behavior, `EXPECT_CALL` for Verification**: Define mocked methods' default behaviors with `ON_CALL()` but only use `EXPECT_CALL()` when you need to verify calls.

- **Organize Expectations Logically**: Group related expectations together and use sequencing (`InSequence`) when order matters.


### 2. Balance Strictness vs. Leniency

GoogleMock provides three mock strictness levels:

- **`NiceMock<T>`:** Suppresses warnings about uninteresting calls (calls to mocked methods without explicit expectations).
- **`NaggyMock<T>` (default current behavior):** Prints warnings for uninteresting calls but does not fail tests.
- **`StrictMock<T>`:** Treats uninteresting calls as test failures.

#### Choosing Strictness
- Use **`NiceMock`** when you want focused tests that ignore interactions not relevant to your current verification, leading to less noisy output and fewer spurious test failures.
- Use **`NaggyMock`** (default) during active development to be notified about unintentional calls to mocked methods.
- Use **`StrictMock`** only when it is critical to verify that **no unexpected calls occur**, such as in very tightly controlled test scenarios.

<Tip>
The general recommendation is to prefer **`NiceMock`** for more maintainable tests, use **`NaggyMock`** when debugging mocks or during initial development, and reserve **`StrictMock`** for strict enforcement scenarios only.
</Tip>

### 3. Testing Legacy Code with Mocks

Legacy systems often have less modular or less test-friendly designs. When introducing mocks:

- **Wrap Legacy Interfaces:** If the legacy class is concrete and not interface-based, create thin interfaces or adaptor classes to mock against.

- **Delegate Calls:** Use delegation patterns where mocks forward some calls to real or fake implementations to avoid duplicating complex logic.

- **Use Nice Mocks for Stability:** Legacy tests are often more fragile; using `NiceMock` reduces noise from irrelevant uninteresting calls.

- **Mock Non-Virtual/Concrete Classes Carefully:** Avoid mocking non-virtual functions directly unless using template-based mocks or wrapping them.

### 4. Avoid Common Pitfalls in Larger Projects

- **Avoid Excessive Expectations:** Over-documentation of interactions leads to brittle tests.
- **Retire Saturated Expectations:** When setting multiple similar expectations, use `.RetiresOnSaturation()` to avoid upper bound call failures.
- **Control Mock Ownership:** Manage lifetime carefully to prevent leaks or premature destruction.
- **Avoid Nesting Strictness Modifiers:** Nesting `NiceMock<StrictMock<T>>` or similar is unsupported and can cause unexpected behavior.
- **Virtual Destructors Are Essential:** Mock base classes should have virtual destructors for proper destruction and leak checking.

<Warning>
Beware of setting expectations after the code under test has exercised the mock; this leads to undefined behavior and unpredictable test failures.
</Warning>

---

## Step-by-Step Guidelines

<Steps>
<Step title="Define Your Mock Class">
Use `MOCK_METHOD` macros in an interface or abstract class. Remember to put mock methods in the public section, even if the original methods are protected/private.
</Step>
<Step title="Choose Appropriate Mock Strictness">
Decide between `NiceMock<T>`, `NaggyMock<T>`, or `StrictMock<T>` based on your test goals. For general use, prefer `NiceMock<T>` to reduce noise.
</Step>
<Step title="Set Default Behaviors Using ON_CALL">
Specify default behavior for mocked methods using `ON_CALL(mock, Method(args)).WillByDefault(action);`. This avoids brittle tests and supports smoother mock interactions.
</Step>
<Step title="Define Expectations with EXPECT_CALL">
Set explicit expectations only for behaviors critical to the test logic. Use matchers to focus on important arguments, and avoid overly precise matches.
</Step>
<Step title="Sequence and Partial Order Control">
Use `InSequence` and `Sequence` objects to enforce call order only when necessary. Avoid unnecessary ordering constraints to keep tests flexible.
</Step>
<Step title="Retire Saturated Expectations">
If you expect repeated calls to the same method with specific arguments, use `.RetiresOnSaturation()` to retire expectations after their invocation limits.
</Step>
<Step title="Verify and Clean Up">
Let mock destructors verify expectations automatically or invoke `Mock::VerifyAndClearExpectations(&mock);` manually if early verification is desired.
</Step>
<Step title="Handle Legacy or Mock Ownership">
In legacy code or heap-allocated mocks, ensure proper ownership and call `Mock::AllowLeak(&mock);` if the mock intentionally outlives the test.
</Step>
</Steps>

### Verification of Strictness Behavior

- Verify if your mock is nice, naggy, or strict by checking `Mock::IsNice(&mock)`, `Mock::IsNaggy(&mock)`, or `Mock::IsStrict(&mock)`.

- Be aware that only mock methods defined directly in the mock class are affected by strictness modifiers.

### Managing Verbosity for Debugging

Adjust verbosity of gMock messages via the `--gmock_verbose=` flag:
- `info`: Prints all info, warnings, and errors plus stack traces.
- `warning`: Prints warnings and errors only (default).
- `error`: Prints errors only, minimizes output noise.

Use higher verbosity to diagnose failing tests or unexpected mock interactions.

---

## Examples

### Using `NiceMock` to Suppress Warnings on Uninteresting Calls

```cpp
#include <gmock/gmock.h>
using ::testing::NiceMock;

class MockFoo {
public:
  MOCK_METHOD0(DoThis, void());
};

TEST(FooTest, NiceMockExample) {
  NiceMock<MockFoo> mock_foo;

  EXPECT_CALL(mock_foo, DoThis());

  mock_foo.DoThis(); // Succeeds without warnings
  mock_foo.DoThis(); // Fails if repeated, but no warning for other calls
}
```

### Retiring Expectations on Saturation

```cpp
EXPECT_CALL(mock, Process(42))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, Process(_))
    .Times(AnyNumber());

// The first two calls with 42 match first expectation.
// Subsequent calls with 42 match second expectation.
```

### Sequencing Calls Using `InSequence`

```cpp
using ::testing::InSequence;

InSequence seq;
EXPECT_CALL(mock, First());
EXPECT_CALL(mock, Second());

mock.First();  // OK
mock.Second(); // OK
```

### Delegate Default Behavior to a Fake Implementation

```cpp
class FakeFoo : public Foo {
public:
  char DoThis(int n) override {
    return (n > 0) ? '+' : '-';
  }
};

class MockFoo : public Foo {
public:
  MOCK_METHOD(char, DoThis, (int n), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault(
      [this](int n) { return fake_.DoThis(n); });
  }

private:
  FakeFoo fake_;
};
```

Use `DelegateToFake()` to forward calls to the fake when no specific action is set.

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting Call Warnings:** Use `NiceMock` or add an `EXPECT_CALL(...).Times(AnyNumber())` to suppress.
- **Unexpected Calls Fail Tests:** Ensure every call is matched by some `EXPECT_CALL` or use a catch-all `EXPECT_CALL` with suitable matchers.
- **Mock Methods Not Overriding Properly:** Check that mocked methods are virtual and that qualifiers (`const`, `override`) are correctly applied.
- **Destructor Issues:** Confirm mocked interfaces have virtual destructors to avoid leaks or suppressed verification.
- **Compilation Slowness:** Move mock class constructor and destructor implementations to `.cc` files if compilation is slow.

### Best Practices

- Organize mock-related code close to tests or in shared testing libraries.
- Prefer interface-based design for easier mocking.
- Use `ON_CALL` to set reusable default actions and `EXPECT_CALL` sparsely.
- Use sequences and ordering only where test correctness depends on call order.
- Avoid setting expectations after exercising the mock.

### Performance Considerations

- Use `NiceMock` to reduce extraneous warnings and test flakiness.
- Use `.RetiresOnSaturation()` to optimize expectation lifecycle.
- Minimize the number of mocked methods per mock class to reduce compile time.

## Next Steps & Related Documentation

- **Getting Started:** [Creating and Using Mocks](/guides/getting-started-workflows/basic-mocking)
- **Advanced Mocking Features:** [Matchers and Actions](/api_reference/mocking_and_matchers/matchers.md), [Strict, Naggy, and Nice Mocks](/api_reference/mocking_and_matchers/strictness_and_nice_mocks.md)
- **Test Organization:** [Organizing and Structuring Tests](/guides/scenarios-patterns/test-organization)
- **Debugging:** [Troubleshooting Assertion Failures](/faq/troubleshooting-and-performance/assertion-failures-debug)

---

For deep references and detailed recipes, see:
- [Mocking Reference](../reference/mocking.md)
- [gMock Cookbook](../gmock_cook_book.md)
- [gMock for Dummies](../gmock_for_dummies.md)
- [Legacy gMock FAQ](../gmock_faq.md)

---

This page fits in the Guides section under Common Scenarios & Best Practices, complementing the introductory mocking guides and advanced mocking concepts.

---