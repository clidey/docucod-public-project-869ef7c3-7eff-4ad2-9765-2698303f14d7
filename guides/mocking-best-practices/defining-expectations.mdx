---
title: "Defining and Verifying Expectations"
description: "Practical guide to using EXPECT_CALL and ON_CALL for controlling mocked behavior and validating interactions. Illustrates common pitfalls and recommended practices."
---

# Defining and Verifying Expectations

This guide helps you master setting up expectations using GoogleMock's core facilities, `EXPECT_CALL` and `ON_CALL`, enabling you to control mocked behavior precisely and verify interactions accurately.

---

## 1. Understanding Expectations

Mock objects in gMock are powerful tools for interaction verification in C++ unit tests. Expectations specify how mocks should behave and how they are expected to be called.

- **`EXPECT_CALL`**: Sets an expectation that a mock method will be called with certain arguments, how many times, with what behavior, and possibly in what order.
- **`ON_CALL`**: Defines a default behavior for a mock method without enforcing that a call must occur.

Setting appropriate expectations is key to effective testing: strict enough to catch bugs, but flexible enough to avoid brittle tests.

---

## 2. Workflow Overview

| Aspect           | Details                                                            |
|------------------|--------------------------------------------------------------------|
| **Goal**         | Control mock method behavior and verify method calls in tests      |
| **Prerequisites** | Have a mock class created with `MOCK_METHOD`; include `<gmock/gmock.h>` |
| **Outcome**      | Expectation correctly enforces call counts, argument matching, behavior, and call order |
| **Time**         | 10-20 minutes to define and verify expectations effectively         |
| **Skill Level**  | Intermediate: assumes familiarity with mocks and C++ testing basics |

---

## 3. Setting Basic Expectations with `EXPECT_CALL`

The backbone of controlling mock behavior:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

### How to Use:

1. **Select your mock method** and specify the argument matchers that define the calls of interest.
2. **Optionally specify `.Times()`** to control how many calls are expected:
   - `Exactly(n)`, `AtLeast(n)`, `AtMost(n)`, `AnyNumber()`, `Between(m, n)`
   - If `.Times()` is omitted, gMock infers it from `.WillOnce()`/`.WillRepeatedly()`. Defaults to `Times(1)`.
3. **Specify behavior using `.WillOnce()` and `.WillRepeatedly()`**:
   - `.WillOnce()` defines behavior for each matching call.
   - `.WillRepeatedly()` defines fallback behavior after all `.WillOnce()` are used.

### Example: Expect method `GetX()` to be called 3 times, returning different values:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

*The first call returns 100, the second 150, and every subsequent call 200.*

---

## 4. Defining Default Behaviors with `ON_CALL`

Use when you want to specify a baseline behavior for a method call but do not want to enforce an expectation that it must be called.

```cpp
ON_CALL(mock_object, Method(matchers...))
    .WillByDefault(action);
```

If a call matches neither explicit `EXPECT_CALL` nor `ON_CALL`, gMock uses a built-in default action (e.g., returns zero/null or default-constructed values).

### Example:

```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(0));
```

This sets the default return value for all calls to `GetX()` when no other expectation matches.

---

## 5. Specifying Argument Matchers

Match arguments precisely or loosely.

- Use exact values when you want to match specific calls.
- Use wildcard matcher `_` to match any argument when the value is not important.
- Combine matchers for complex criteria such as `Ge(5)`, `NotNull()`, or `ElementsAre()`.

Examples:

```cpp
EXPECT_CALL(turtle, GoTo(50, _));         // First arg must be 50, second can be any value
EXPECT_CALL(turtle, Forward(Ge(100)));    // Argument must be >= 100
EXPECT_CALL(turtle, Process(_));           // Method called with any argument
```

---

## 6. Ordering Expectations

### Enforcing order using `InSequence`:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, FirstMethod());
  EXPECT_CALL(mock, SecondMethod());
}
```

The two calls must occur in this order. Calls out of order cause test failures.

### Partial ordering using `After()` and `Sequence` objects:

```cpp
Sequence seq1, seq2;
EXPECT_CALL(mock1, MethodA()).InSequence(seq1);
EXPECT_CALL(mock2, MethodB()).InSequence(seq2);
EXPECT_CALL(mock3, MethodC()).InSequence(seq1, seq2).After(expect_call1);
```

This defines a DAG of expectations, enabling flexible partial order verification.

---

## 7. Handling Multiple Expectations on the Same Method

gMock matches expectations in reverse order of declaration, meaning more specific expectations should appear **after** more general catch-all ones.

### Common pattern to catch all calls and specialize:

```cpp
EXPECT_CALL(mock, Foo).Times(AnyNumber());            // General catch-all
EXPECT_CALL(mock, Foo(SpecificArg())).Times(2);        // Special-case
```

This ensures the special-case expectation takes priority when arguments match.

---

## 8. Best Practices and Common Pitfalls

### Best Practices

- Use `ON_CALL` to set common default behavior shared across multiple tests.
- Use `EXPECT_CALL` only when you intend to *verify* that a method is called.
- Keep expectations as minimal and focused as possible to avoid brittle tests.
- Use `InSequence` or `After` to enforce strict or partial call order only when required.
- Use `RetiresOnSaturation()` for expectations which must retire after being used up to avoid sticky matching.

### Common Pitfalls

- **Not specifying `.Times()` leading to unexpected call count behavior:** Understand gMock's inference rules.
- **Matching multiple `EXPECT_CALL`s with overlapping matchers:** Order matters; put general expectations before specific ones.
- **Over-specifying argument matchers:** Avoid brittle tests by matching only what you actually care about.
- **Setting expectations after calls to the mock:** This leads to undefined behavior; always set before use.

---

## 9. Advanced Usage

### Using `.With()` Clause

Use `.With()` to match the tuple of all arguments with a single matcher, facilitating predicates involving multiple arguments.

```cpp
EXPECT_CALL(foo, Bar(_, _)).With(Lt());  // First less than second argument
```

### Retiring Expectations

Use `.RetiresOnSaturation()` to automatically deactivate an expectation once its call count upper bound is reached, preventing it from matching further calls.

### Delegate Default Behavior

Use `ON_CALL` combined with lambdas or other actions to delegate behavior to existing fake or real implementations.

---

## 10. Troubleshooting

### Uninteresting Calls

Warning appears if a mock method is called without any matching `EXPECT_CALL`. To address:
- Use `ON_CALL` to define default actions.
- Use `NiceMock` to suppress warnings for uninteresting calls.

### Unexpected Calls

Error occurs if call does not match any expectation. Check:
- Argument matchers for correctness.
- Call order, if `InSequence` or `After` clauses are used.

### Excessive Calls

Error occurs if a method is called more times than specified in `.Times()`. Fix:
- Increase `.Times()` or
- Use `.RetiresOnSaturation()` or `.WillRepeatedly()`.

### Inferring `.Times()` incorrectly

Pin the expected number of calls explicitly with `.Times()` if default inference causes errors.

### Verbose Tracing for Debugging

Run tests with `--gmock_verbose=info` to see detailed tracing of mock calls and matching expectations.

---

## 11. Next Steps

- Explore the [Matchers Reference](https://google.github.io/googletest/reference/matchers) for powerful argument matching techniques.
- Use the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced scenarios like actions and custom matchers.
- Learn about [Strict, Naggy, and Nice Mocks](https://google.github.io/googletest/gmock_cook_book.md#NiceStrictNaggy) to configure mock strictness.
- Read [Creating and Using Mock Objects](https://google.github.io/googletest/guides/mocking-best-practices/creating-mocks) for comprehensive mock creation.

---

For detailed syntax and API specifics, see the [Mocking Reference](https://google.github.io/googletest/reference/mocking) page.

---

<AccordionGroup title="Key Clauses of EXPECT_CALL">
<Accordion title="With Clause">
Use `.With(multi_argument_matcher)` immediately after the method call matcher to constrain the call by matching all arguments as a tuple.

Example:
```cpp
EXPECT_CALL(mock, Method(_, _)).With(Lt());  // first arg < second arg
```
</Accordion>
<Accordion title="Times Clause">
Defines how many times the call is expected. Accepts:
- `AnyNumber()`, `AtLeast(n)`, `AtMost(n)`
- `Between(m, n)`, `Exactly(n)` (or `n`)

Defaults are inferred if omitted (see Infers Card.)
</Accordion>
<Accordion title="InSequence Clause">
Use to specify that this expectation must occur in the order within one or more sequences.

Example:
```cpp
Sequence s;
EXPECT_CALL(mock, Foo()).InSequence(s);
EXPECT_CALL(mock, Bar()).InSequence(s);
```
</Accordion>
<Accordion title="After Clause">
Use to enforce that this expectation can only be matched after preceding expectations have been satisfied.

Example:
```cpp
Expectation e1 = EXPECT_CALL(mock, Foo());
EXPECT_CALL(mock, Bar()).After(e1);
```
</Accordion>
<Accordion title="WillOnce and WillRepeatedly Clauses">
-WillOnce sets action for each matching call, for calls consuming WillOnce clauses; can specify multiple times.

-WillRepeatedly sets fallback action for all subsequent calls after WillOnce actions are consumed.

If `WillRepeatedly` is omitted, the default action is used after WillOnce clauses are depleted.
</Accordion>
<Accordion title="RetiresOnSaturation Clause">
Retires the expectation when the call count reaches the cardinality upper bound, so it won't match any more calls.

Useful when multiple overlapping expectations exist.
</Accordion>
</AccordionGroup>

---

## Sample Code Snippet

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;
using ::testing::InSequence;

class MockTurtle {
 public:
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(int, GetX, (), (const));
};

TEST(DrawingTest, DrawsLine) {
  MockTurtle turtle;

  {
    InSequence seq;

    EXPECT_CALL(turtle, PenDown());
    EXPECT_CALL(turtle, GetX())
        .WillOnce(Return(100))
        .WillOnce(Return(150))
        .WillRepeatedly(Return(200));
  }

  // Code under test invoking turtle.
}
```

---

## Troubleshooting Tips

- Ensure `EXPECT_CALL` statements are in place *before* mock method calls.
- Use `--gmock_verbose=info` to get detailed logging on expectation matching.
- If unexpected calls occur, validate argument matchers and order constraints.
- Suppress warnings on uninteresting calls with `NiceMock<T>` or add catch-all expectations with `Times(AnyNumber())`.
- Use `.RetiresOnSaturation()` to handle expectations that should deactivate after being satisfied.

---

## References and Further Reading

- [Official `EXPECT_CALL`](https://google.github.io/googletest/reference/mocking#EXPECT_CALL)
- [Official `ON_CALL`](https://google.github.io/googletest/reference/mocking#ON_CALL)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers)
- [Mock Strictness Modes](https://google.github.io/googletest/gmock_cook_book.md#NiceStrictNaggy)



---

This page is a focused guide for defining and verifying expectations in GoogleMock, helping you gain reliable, expressive, and maintainable mocking behavior in your C++ tests.

---

<Check>
Make sure your mock methods are `virtual` and your mock classes are properly set up with `MOCK_METHOD`. Always define expectations prior to exercising mocks. Use sequences or `.After()` clauses to enforce call ordering where critical.
</Check>