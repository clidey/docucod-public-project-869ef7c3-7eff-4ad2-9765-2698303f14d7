---
title: "Basics of Mocking Functions and Classes"
description: "A practical guide to creating and using mocks, setting up expectations, and controlling return values and side effects. Perfect for users new to mocking or transitioning from manual stubbing."
---

# Basics of Mocking Functions and Classes

A practical guide to creating and using mocks, setting up expectations, and controlling return values and side effects. This documentation is designed for users new to mocking or transitioning from manual stubbing, helping you get started with GoogleMock smoothly.

---

## Introduction to Mocking

Mock objects simulate the behavior of real objects in a controlled way. They allow you to:

- Verify interactions between your code and its dependencies.
- Specify expected calls, their arguments, and behaviors.
- Control how mock methods respond, including return values and side effects.

GoogleMock simplifies mocking in C++ by generating mock classes and offering intuitive syntax for setting behavior and verifying expectations.

---

## Defining Mock Classes Using `MOCK_METHOD`

### What is `MOCK_METHOD`?

`MOCK_METHOD` is a macro that defines mock methods inside a mock class. It replaces the need to implement mock methods manually.

```cpp
class MyMock {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...));
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers...)); // Optional qualifiers
};
```

### Step-by-Step Definition

1. Derive your mock class from the interface or base class:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(bool, Process, (Bar elem, int count), (override));
};
```

2. Place all `MOCK_METHOD` declarations under the `public:` section to ensure `ON_CALL` and `EXPECT_CALL` can access them, regardless of the original method's access level.

3. For methods with commas in the argument or return types, wrap the type in parentheses or use type aliases:

```cpp
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD(BoolAndInt, GetPair, ());

MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
```

### Supporting Qualifiers

- Use `(const)` if mocking a const method.
- Use `(override)` to indicate overriding virtual methods.
- Use `(noexcept)`, `Calltype(...)`, `ref(...)` for special cases.

### Mocking Class Templates

Class templates can be mocked like regular classes:

```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

---

## Creating and Using Mock Objects

### Workflow

1. Include the gMock namespace or use `using` declarations:

```cpp
using ::testing::Return;
using ::testing::_;  // wildcard matcher
```

2. Create mock objects:

```cpp
MockFoo mock;
```

3. Optionally, set default behaviors using `ON_CALL`:

```cpp
ON_CALL(mock, GetSize()).WillByDefault(Return(5));
```

4. Set expectations using `EXPECT_CALL` before exercising the mock:

```cpp
EXPECT_CALL(mock, Describe(5)).Times(3).WillRepeatedly(Return("Category 5"));
```

5. Exercise your code that interacts with the mock:

```cpp
EXPECT_EQ(YourFunction(&mock), "expected result");
```

6. When mock objects are destroyed, GoogleMock automatically verifies all expectations.

### Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int steps), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;
  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
  // Additional expectations...
  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 5));
}
```

---

## Specifying Expectations with `EXPECT_CALL`

Expectations define the calls you expect on mock methods, including arguments, number of calls, call order, and behaviors.

```cpp
EXPECT_CALL(mock_object, Method(argument_matchers))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action)
    .InSequence(sequence_objects...)
    .After(other_expectations...)
    .RetiresOnSaturation();
```

- **Argument Matchers**: Specify what arguments you expect using matchers like `_` (any), exact values, or complex conditions.
- **Times / Cardinality**: How many times you expect the call:
  - `Exactly(n)`, `AtLeast(n)`, `AtMost(n)`, `AnyNumber()`
- **Call Order**:
  - Use `InSequence` or `After` to enforce ordering between calls.
- **Actions**:
  - `WillOnce(Return(value))`, `WillRepeatedly(Return(value))`, or custom actions.
- **RetiresOnSaturation()**:
  - The expectation becomes inactive after the expected calls are made.

If you omit `Times()`, GoogleMock infers the count based on the actions set.

### Example

```cpp
EXPECT_CALL(mock, GetNumber())
    .Times(3)
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));

EXPECT_CALL(mock, GetName())
    .WillRepeatedly(Return("John Doe"));
```

---

## Setting Default Behaviors with `ON_CALL`

`ON_CALL` specifies what happens when a mock method is called but does *not* enforce that it must be called.

Syntax:

```cpp
ON_CALL(mock_object, Method(argument_matchers))
    .WillByDefault(action);
```

**Usage**:

- Set common or generic behaviors in test fixture setup or mock constructor.
- Actions set by `EXPECT_CALL` override `ON_CALL` behaviors.

Example:

```cpp
ON_CALL(mock, GetSize()).WillByDefault(Return(5));
```

---

## Handling Common Mocking Scenarios

### Uninteresting Calls

- Calls to mock methods without expectations are "uninteresting"; by default, gMock warns you but does not fail the test.
- Use `NiceMock<YourMock>` to suppress these warnings.
- Use `StrictMock<YourMock>` to treat them as failures.

### Overloaded Methods

- Mock all overloads you want to use.
- Use argument lists or helper functions like `Const()` to disambiguate.

### Delegating to Fake or Real Objects

- You can delegate default behavior to a fake or real object inside your mock class:

```cpp
ON_CALL(*this, SomeMethod).WillByDefault([this](Args... args) {
  return fake_.SomeMethod(args...);
});
```

### Mocking Methods with Move-Only Types

- `MOCK_METHOD` supports move-only arguments and return types.
- For return values, prefer lambdas with `WillOnce` or `WillRepeatedly` instead of `Return(std::move(...))`.

### Mocking Private or Protected Methods

- Still define all `MOCK_METHOD` in the `public:` section of your mock class.

### Mocking Non-Virtual Methods

- Use the non-virtual mocking pattern with unrelated mock classes and templated code.

---

## Best Practices and Tips

- Set expectations *before* exercising the code.
- Use `ON_CALL` by default for general behavior; reserve `EXPECT_CALL` to enforce call occurrence and arguments.
- Avoid overly strict matchers that cause brittle tests.
- Use sequences or `.After()` to control call order when needed.
- Use catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` carefully to avoid masking errors.
- Call `Mock::VerifyAndClearExpectations(&mock)` to force verification early if needed, especially if mocks might leak.

---

## Troubleshooting Common Issues

- If unexpected calls occur, check that arguments match expectations.
- If methods seem not mocked (real implementation called), verify the methods are virtual.
- For ambiguous overloads, provide explicit argument matchers or use `Const()`.
- If default actions donâ€™t behave as expected, use `ON_CALL` to explicitly set them.
- Beware of side effects in `WillOnce(Return(variable++))`; the expression is evaluated once when setting, not each call.
- Turn on verbose output with `--gmock_verbose=info` to trace mock calls.

---

## Next Steps & Related Content

- Explore **Parameterized and Typed Testing Patterns** for advanced mocking.
- Learn **Specifying Behavior: Actions, Matchers, and Sequences** to control mocks finely.
- Review **Mocking Best Practices and Common Pitfalls** to improve test quality.
- Visit the **gMock Cookbook** and **gMock Cheat Sheet** for practical recipes.
- Understand **Expectation Setting and Verification** and **Actions Reference** for deeper control.

---

## References

- [GoogleMock Official Documentation](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cheat Sheet](reference/gmock_cheat_sheet.md)
- [gMock Cookbook](reference/gmock_cook_book.md)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](reference/actions.md)

---

This guide equips you with a solid foundation to define mock classes, create mock objects, and use `EXPECT_CALL` and `ON_CALL` effectively in your C++ unit tests with GoogleMock.