---
title: "Writing Expectations and Actions"
description: "Delves into specifying behavior and expectations on mocks, including ON_CALL, EXPECT_CALL, and combining matchers. Shows how to control return values and side effects in tests."
---

# Writing Expectations and Actions

This guide provides a thorough walkthrough on how to specify behavior and expectations on mock objects using GoogleMock. You'll learn how to define default behaviors with `ON_CALL()`, set explicit expectations with `EXPECT_CALL()`, combine argument matchers, and control return values and side effects through actions. This empowers you to write precise, readable, and maintainable tests with mock objects.

---

## 1. Understanding Expectations and Default Behaviors

### 1.1 Overview of `ON_CALL` and `EXPECT_CALL`

- **`ON_CALL`** specifies the *default behavior* of a mock method without enforcing that it must be called. It is typically used to define common fallback behaviors for your mocks.
- **`EXPECT_CALL`** sets an *explicit expectation* that a method *will be called* with arguments matching specified matchers, controlling how many times and what actions happen when it is called.

Both macros take a mock object and a method call with matchers. You specify clauses to configure cardinality, expected argument matchers, call sequences, and actions.

### 1.2 Why Use `ON_CALL` vs `EXPECT_CALL`?

Use `ON_CALL` to avoid over-constraining your tests. It ensures your mocks behave sensibly without forcing tests to verify every interaction.

Use `EXPECT_CALL` when you want to validate specific calls, their arguments, call counts, order, or side effects.

> **Tip:** Start with broad `ON_CALL`s for default behaviors and add targeted `EXPECT_CALL`s only where verification is necessary.

---

## 2. Specifying Default Behavior Using `ON_CALL`

The syntax of an `ON_CALL` statement is:

```cpp
ON_CALL(mock_object, Method(argument_matchers))
    .With(multi_argument_matcher) // optional
    .WillByDefault(action);       // required
```

- `.With()` restricts matching on all arguments as a tuple (used for composite argument checks).
- `.WillByDefault()` sets the action that occurs when the method is called and the expectation doesn't demand otherwise.

### 2.1 Example - Setting a Default Return Value

```cpp
using ::testing::Return;

ON_CALL(mock, GetValue())
    .WillByDefault(Return(42));
```

When no expectations match, mock's `GetValue()` returns 42.

### 2.2 Using `.With()` Clause

To enforce a condition on the entire argument tuple:

```cpp
using ::testing::Lt;  // Less than

ON_CALL(mock, SetRange(_, _))
    .With(Lt()) // first argument < second argument
    .WillByDefault(Return(true));
```

This means default action occurs only when the arguments satisfy `first < second`.

### 2.3 Important Notes

- `.WillByDefault()` must appear *once* per `ON_CALL`.
- `.With()` can appear at most once.
- The last matching `ON_CALL` clause takes precedence in case of multiple matches.

---

## 3. Defining Explicit Expectations Using `EXPECT_CALL`

The general syntax is:

```cpp
EXPECT_CALL(mock_object, Method(argument_matchers))
    .With(multi_argument_matcher)   // optional, once
    .Times(cardinality)             // optional, once
    .InSequence(sequences...)       // optional, any number
    .After(expectations...)         // optional, any number
    .WillOnce(action)               // optional, any number
    .WillRepeatedly(action)         // optional, once
    .RetiresOnSaturation();         // optional, once
```

### 3.1 Matchers: Selecting Which Calls Match

Each argument can be specified as a matcher (e.g., a concrete value like `5` or a wildcard `_`).

You may use:

- Specific values (e.g., `42`)
- `_` to match any value
- Built-in or custom matchers like `Lt()`, `Ge()`, `HasSubstr()`, etc.

> **Example:**
> ```cpp
> EXPECT_CALL(mock, SetName(StartsWith("Mr."), _));
> ```

The `.With()` clause lets you specify a matcher on the entire tuple of arguments.

### 3.2 Cardinality with `.Times()`

Control how many times the call is expected:

| Cardinality      | Meaning                                        |
| ---------------- | ---------------------------------------------- |
| `AnyNumber()`    | Expected any number of calls                    |
| `AtLeast(n)`     | At least n calls                               |
| `AtMost(n)`      | At most n calls                                |
| `Between(m, n)`  | Between m and n calls inclusive                 |
| `Exactly(n)` or `n` | Exactly n calls; if 0 means call is forbidden |

If omitted, cardinality is inferred from `.WillOnce()` and `.WillRepeatedly()` clauses.

### 3.3 Ordering Expectations

- Use `.InSequence()` with `Sequence` objects to enforce calls occur in sequence.

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Foo1()).InSequence(s1, s2);
EXPECT_CALL(mock, Foo2()).InSequence(s1);
EXPECT_CALL(mock, Foo3()).InSequence(s2);
```

- Use `.After()` to enforce a partial ordering between expectations.

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Start()).After(e1);
```

### 3.4 Specifying Actions

- `.WillOnce()` sets an action to perform for the *next* matching call. Can be chained multiple times.
- `.WillRepeatedly()` sets a fallback action for calls after `.WillOnce()` actions are exhausted.

Supported actions include:

- `Return(value)`: returns a value
- `ReturnRef(variable)`: return reference to a variable
- `Invoke(callable)`: invokes a function/lambda
- `DoAll(a1, a2, ...)`: performs multiple actions sequentially
- `SetArgPointee<N>(value)`: sets value pointed by Nth argument
- `InvokeArgument<N>(args...)`: invokes callable argument N with args

Example:
```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### 3.5 Controlling Expectation Lifetime

- Use `.RetiresOnSaturation()` on an expectation to make it inactive once fully matched.

Without it, an expectation remains "sticky" and can cause failures if called more than intended.

### 3.6 Example: Multiple Expectations on Same Method

```cpp
EXPECT_CALL(mock, UpdateValue(_));  // Default catch-all expectation
EXPECT_CALL(mock, UpdateValue(7))
    .Times(2)
    .RetiresOnSaturation();
```

The expectations allow any calls to `UpdateValue` generally, but exactly two calls with argument `7` are expected first.

---

## 4. Combining Matchers

You can form complex matchers by combining existing ones:

- `AllOf(m1, m2)`: matches if all match
- `AnyOf(m1, m2)`: matches if any matches
- `Not(m)`: negation

Additionally, you can perform checks across all arguments using `.With()` with tuple matchers or utilities like `Args<>()`, `AllArgs()`, and `AllOf()`.

---

## 5. Controlling Return Values and Side Effects

GoogleMock actions specify what a mock function should do when invoked.

### 5.1 Returning Values

- `Return(value)`: Return a copy of `value`. Evaluated when expectation is set.
- `ReturnRef(variable)`: Returns a reference to a variable (useful for non-primitive types).
- `ReturnPointee(pointer)`: Return value pointed by pointer at call time (reflects current value).

Example:
```cpp
int n = 5;
EXPECT_CALL(mock, Get())
    .WillRepeatedly(ReturnPointee(&n));
n = 7;
EXPECT_EQ(mock.Get(), 7);
```

### 5.2 Performing Side Effects

Use actions to modify output arguments or perform multiple effects:

- `SetArgPointee<N>(value)`: Set pointer argument `N` to `value`.
- `SetArrayArgument<N>(first, last)`: Copy a range to array argument `N`.
- `DoAll(a1, a2, ...)`: Perform multiple actions sequentially.

Example:
```cpp
EXPECT_CALL(mock, FillBuffer(_))
    .WillOnce(DoAll(SetArrayArgument<0>(data, data + size), Return()));
```

### 5.3 Using Functions and Lambdas as Actions

- Use `Invoke(f)` or pass lambdas directly to `WillOnce` or `WillRepeatedly` to run arbitrary code.

---

## 6. Best Practices and Tips

### 6.1 Order Of Expectations Matters

Later `EXPECT_CALL`s override earlier ones for matching.

### 6.2 Use `.RetiresOnSaturation()` When Expectation Should Become Inactive

Without it, exceeding the call count causes a failure even when logically done.

### 6.3 Prefer `ON_CALL` To `EXPECT_CALL` for Default Behavior

Only set `EXPECT_CALL` when you want to enforce a call or behavior.

### 6.4 Use Sequences for Ordered Calls

Wrap relevant `EXPECT_CALL`s within `InSequence` blocks or `.InSequence()` clauses.

### 6.5 Be Careful With `Return()` and Move-only Types

`Return()` copies or moves the value at setup time. Use lambdas or `ReturnNew` to provide fresh objects per call.

---

## 7. Troubleshooting Common Issues

- **No `.WillByDefault()` after `ON_CALL`:** `ON_CALL` requires exactly one `.WillByDefault()` to specify the default action.

- **Multiple `.With()` clauses:** Both `ON_CALL` and `EXPECT_CALL` allow only one `.With()` clause.

- **Too many or too few `.WillOnce()` actions:** GoogleMock will warn if the number of `.WillOnce()` clauses doesn't align with the expectation's cardinality.

- **Unmatched Calls:** Calls to mocked methods not matching any `EXPECT_CALL` are reported as errors.

- **Sticky Expectations:** Without `.RetiresOnSaturation()`, expectations remain active even after saturation, possibly causing failures on additional calls.

- **Mock Methods Called More Times Than Expected:** This indicates logic errors or missing `.RetiresOnSaturation()`.

- **Unexpected Calls with `ON_CALL` but no `EXPECT_CALL`:** Warnings may appear; suppress with `NiceMock` or define catch-all `EXPECT_CALL` with `AnyNumber()` cardinality.

---

## 8. Example Walkthrough

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class MockTurtle {
 public:
  MOCK_METHOD(void, PenUp, (), ());
  MOCK_METHOD(int, GetX, (), ());
};

TEST(TurtleTest, DefaultBehavior) {
  MockTurtle turtle;

  // Default value for GetX is 0 unless overridden
  ON_CALL(turtle, GetX()).WillByDefault(::testing::Return(10));

  EXPECT_EQ(turtle.GetX(), 10);
}

TEST(TurtleTest, ExpectationsAndActions) {
  MockTurtle turtle;

  // Expect PenUp to be called exactly once
  EXPECT_CALL(turtle, PenUp()).Times(1);

  // Expect GetX() to be called twice: first returns 5, then 7, then any further calls return 9
  EXPECT_CALL(turtle, GetX())
      .WillOnce(::testing::Return(5))
      .WillOnce(::testing::Return(7))
      .WillRepeatedly(::testing::Return(9));

  EXPECT_EQ(turtle.GetX(), 5);
  EXPECT_EQ(turtle.GetX(), 7);
  EXPECT_EQ(turtle.GetX(), 9);
  EXPECT_EQ(turtle.GetX(), 9);

  turtle.PenUp();
}
```

---

## 9. Resources

- [GoogleMock For Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Actions Reference](../api-reference/matchers-actions-cardinalities/actions-api.md)
- [Matchers Reference](../api-reference/matchers-actions-cardinalities/argument-matchers.md)
- [Mocking Reference](../api-reference/core-testing-apis/mock-class-api.md)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

---

## 10. Next Steps

- Explore the [Creating and Using Mocks](../guides/mocking-best-practices/creating-mocks.md) guide for defining mocks.
- Learn how to manage [Mock Strictness](../guides/mocking-best-practices/mock-strictness.md) for controlling uninteresting call warnings.
- Dive into [Custom Actions and Matchers](../guides/advanced-testing-scenarios/custom-actions-matchers.md) to create tailored test behaviors.

---