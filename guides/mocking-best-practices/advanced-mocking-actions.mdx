---
title: "Advanced Mocking: Actions, Matchers, and Customizations"
description: "Guides users through advanced topics like creating custom actions, leveraging advanced matchers, and handling edge-case behaviors. Explore power-user techniques for expressing complex test logic or simulating intricate scenarios."
---

# Advanced Mocking: Actions, Matchers, and Customizations

## Workflow Overview

This guide helps you master advanced mocking techniques in GoogleTest's GoogleMock framework, focusing on creating and customizing **actions**, using **advanced matchers**, and handling **edge-case behaviors**. It guides you beyond basic mock setup to express sophisticated test interactions and simulate complex scenarios.

### Prerequisites

- Familiarity with basic GoogleMock concepts: mock classes, `EXPECT_CALL`, `ON_CALL`.
- Experience writing basic actions (e.g., `Return()`, `Invoke()`).
- Understanding of fundamental matchers and expectations.

### Expected Outcome

By following this guide, you will be able to:

- Define custom actions using macros and functors to control mock behavior finely.
- Use composite and parameterized actions to perform multiple side effects or calculations.
- Leverage advanced matchers including user-defined and polymorphic matchers to express complex argument validation.
- Handle uncommon testing scenarios with specialized techniques like argument saving, reference returning, and action adapters.

### Time Estimate

~30-60 minutes to read, experiment with examples, and integrate custom actions/matchers into your tests.

### Difficulty Level

Intermediate to Advanced

---

## Step-by-Step Guide to Advanced Actions and Matchers

### 1. Creating Custom Actions

GoogleMock provides the following ways to define new mock actions.

#### 1.1 Using ACTION Macros

- Use `ACTION(name) { ... }` to define a simple custom action.
- Access mock function arguments inside the body via `arg0`, `arg1`, etc.
- For parameterized actions, use `ACTION_P(name, param) { ... }` and similarly `ACTION_P2`, ... `ACTION_P10` for multiple parameters.

Example:

```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);  // increments second argument by dereferencing
}

// Usage in test:
EXPECT_CALL(mock, Foo(_))
    .WillOnce(IncrementArg1());
```

#### 1.2 Writing Action Functors / Callables

Define a struct or class with an `operator()` compatible with the mock method signature. Example:

```cpp
struct MultiplyBy {
  int factor;
  int operator()(int arg) const { return arg * factor; }
};

EXPECT_CALL(mock, Foo(_))
    .WillOnce(MultiplyBy{7});
```

#### 1.3 Using Polymorphic Actions

If you want your action to work with multiple mock function signatures, define a class with a templated `Perform` method and use `MakePolymorphicAction()` to create the action.

---

### 2. Using Built-in and Composite Actions

GoogleMock comes with many built-in actions documented [here](../docs/reference/actions.md). Some key usage tips:

- **Compound Actions:** Use `DoAll(a1, a2, ..., an)` to run multiple side effects in sequence during a mock call; the last action's return value is used.

- **Return Specializations:** 
  - `Return(value)` returns a pre-defined value (stored at expectation set time).
  - `ReturnRef(variable)` returns a live reference.
  - `ReturnPointee(ptr)` returns the value pointed to by `ptr` at action invocation.

- **Argument Manipulation:**
  - `SaveArg<N>(pointer)` saves Nth argument.
  - `SetArgReferee<N>(value)` assigns to reference argument.
  - `DeleteArg<N>()` deletes the Nth pointer argument.

- **Invoke Variants:**
  - `Invoke(f)` invokes function/functor with mock args.
  - `InvokeWithoutArgs(f)` invokes with no args.
  - `InvokeArgument<N>(args...)` invokes the Nth argument (a callable) with specified args.

Example chaining side effects:

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

---

### 3. Advanced Use of Matchers

Matchers allow validation of mock call arguments in flexible ways.

#### 3.1 Combining and Nesting Matchers

Use combinators like `AllOf()`, `AnyOf()`, and logical negation `Not()` to build complex matchers.

Example:
```cpp
EXPECT_CALL(mock, Foo(AllOf(Gt(10), Lt(20))));
```

#### 3.2 Custom Matchers

- Quickly define using `MATCHER(name, description) { ... }` macros for simple conditions.
- Parameterize with `MATCHER_P`, `MATCHER_P2`, ... for matchers with parameters.

Example:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") { return (arg % divisor) == 0; }
EXPECT_CALL(mock, Func(IsDivisibleBy(7)));
```

#### 3.3 Matching Container Contents

- Use `ElementsAre()`, `UnorderedElementsAre()`, and their array variants to match STL containers' contents.
- Use `Pointee(matcher)` to match the value pointed to by a pointer argument.

Example:
```cpp
EXPECT_CALL(mock, Bar(ElementsAre(1, _, Gt(5))));
EXPECT_CALL(mock, Baz(Pointee(Ge(3))));
```

---

### 4. Handling Edge Cases and Common Patterns

#### 4.1 Returning References Safely

- `ReturnRef(var)` returns a reference.
- `ReturnRefOfCopy(val)` returns reference to a copy that lives as long as action.

#### 4.2 Redirecting or Delegating Calls

- To delegate mock calls to a real object or fake class, `ON_CALL()` with `Invoke()` is useful.

#### 4.3 Ignoring Uninteresting Arguments

- Use the `Unused` type for mock function parameters you want to ignore in your custom actions or invoked functions.

```cpp
double Distance(Unused, double x, double y) { return sqrt(x*x + y*y); }
EXPECT_CALL(mock, Foo(_, _, _)).WillOnce(Invoke(Distance));
```

#### 4.4 Controlling Match & Call Ordering

- Use `InSequence` to enforce order on multiple expectations.
- Use `RetiresOnSaturation()` to stop an expectation from matching after saturation.

---

## Examples & Code Samples

```cpp
// Defining a parameterized action that adds a constant to the first arg
ACTION_P(Plus, n) {
  return arg0 + n;
}

// Using it in a test
EXPECT_CALL(mock, Foo(5))
    .WillOnce(Plus(10));  // returns 15

// Using composite actions
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(7), Return(true)));

// Custom matcher
MATCHER(IsEven, "") { return (arg % 2) == 0; }
EXPECT_CALL(mock, Bar(IsEven()))
    .Times(3);

// Delegating calls to a real object
class RealFoo {
 public:
  int Compute(int x) { return x * 2; }
};
class MockFoo {
 public:
  MOCK_METHOD(int, Compute, (int), (override));
};

RealFoo real_foo;
MockFoo mock_foo;

ON_CALL(mock_foo, Compute(::testing::_))
    .WillByDefault(Invoke(&real_foo, &RealFoo::Compute));

EXPECT_EQ(mock_foo.Compute(4), 8);
```

---

## Troubleshooting & Tips

- **Uninteresting Calls Warning:** Use `NiceMock` to suppress warnings if some mock methods are called unexpectedly but are not critical.
- **Make Expectations Not Sticky:** Use `.RetiresOnSaturation()` to make expectations retire when their call count is met.
- **Avoid Over-Specification:** Use `ON_CALL()` for default behaviors and only `EXPECT_CALL()` where call verification is critical.
- **Order of Expectations Matters:** The last matching expectation that is still active gets chosen. Put general expectations first, more specific later.
- **Debugging:** Run tests with `--gmock_verbose=info` to see detailed call matching.

## Next Steps & Related Content

- Start with [Mocking Workflow with GoogleMock](../../guides/mocking-best-practices/mocking-workflow) to learn basic mocking.
- Explore [Matchers Reference](../api-reference/core-apis/matchers) for comprehensive matcher usage.
- See [Actions Reference](../docs/reference/actions.md) for full built-in action catalog.
- For equal focus on mocking patterns, consult [Best Practices and Patterns for Mocking](../../guides/mocking-best-practices/mocking-patterns).

---

## Additional Resources

- gMock Cheat Sheet: [Quick reference for mocking facilities](../docs/gmock_cheat_sheet.md)
- gMock Cookbook: [Recipes with examples for advanced mocking](../docs/gmock_cook_book.md)
- Mocking Reference: [APIs and detailed macros](../docs/reference/mocking.md)

---

This guide focuses specifically on advanced mocking features available through actions, matchers, and their customization in GoogleMock. For onboarding and basic use, refer to [Writing and Running Your First Test](../../guides/getting-started/first-test).
