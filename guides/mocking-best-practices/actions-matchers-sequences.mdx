---
title: "Specifying Behavior: Actions, Matchers, and Sequences"
description: "Demonstrates how to use matchers for flexible argument matching, configure complex actions, and enforce call order or frequency (cardinalities) in tests. Provides actionable tips for robust specification."
---

# Specifying Behavior: Actions, Matchers, and Sequences

This guide demonstrates how to leverage gMock's powerful facilities to specify the behavior of your mocks through flexible argument matching, configuring complex actions, and enforcing precise call order or frequency (cardinalities) in your tests. Learn how to write robust expectations that reflect your real testing intent.

---

## 1. Introduction

When crafting mock-based tests, you want your mocks to behave realistically but remain flexible enough to tolerate allowable variations. This page walks you through:

- Using **matchers** to specify flexible argument expectations — beyond exact values.
- Specifying **actions** that control what a mock method does when called.
- Enforcing **call sequences** and **cardinalities** to specify how many times and in which order calls should occur.

By mastering these, you'll write tests that are both expressive and maintainable, catching actual bugs rather than test fragility.

---

## 2. Flexible Argument Matching with Matchers

### Why Use Matchers?

In `EXPECT_CALL`, instead of specifying exact argument values, you can use matchers to express conditions, such as "any value", "greater than 10", "not null", or even complex predicates. Matchers increase test resilience and readability.

### Basic Syntax

```cpp
using ::testing::_;  // Matches any value
EXPECT_CALL(mock_object, MethodName(100, _));
```

Here, the first argument must be exactly 100, and the second can be anything.

### Common Useful Matchers

- `_` — wildcard matcher (matches any value)
- `Eq(val)` — matches equality
- `Ge(val)`, `Gt(val)`, `Le(val)`, `Lt(val)` — comparison
- `NotNull()`, `IsNull()` — pointer checks
- `Pointee(matcher)` — matches the value pointed to by a pointer

For a comprehensive list, see the [Matchers Reference](reference/matchers.md).

### Matching Multiple Arguments as a Whole with `.With()`

Sometimes you want to match the entire argument tuple collectively rather than each argument independently. Use `.With()` to supply a multi-argument matcher.

Example:

```cpp
using ::testing::_;
using ::testing::Lt;
...
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // first arg less than second arg
```

This expects `SetPosition` to be called with two arguments where the first is less than the second.

### Tips & Best Practices

- Use `_` for uninteresting arguments to avoid brittle tests.
- For overloaded methods, specify argument types or use `Const()` to disambiguate.
- Combine matchers with `AllOf()`, `AnyOf()`, or user-defined predicates via `Truly()`.

---

## 3. Configuring Mock Method Actions

gMock lets you specify what a mocked method should do when called.

### ON_CALL vs EXPECT_CALL

- `ON_CALL` sets a **default action** without requiring the method to be called.
- `EXPECT_CALL` defines an **expectation** and optionally specifies actions.

### Basic Action Syntax

```cpp
using ::testing::Return;
...
ON_CALL(mock, GetValue()).WillByDefault(Return(42));
EXPECT_CALL(mock, GetValue()).Times(2).WillOnce(Return(1)).WillRepeatedly(Return(2));
```

The first states the default `GetValue()` returns 42 unless expectation overrides. The second expects exactly 2 calls: returning `1` on the first and `2` on the second.

### Built-in Actions

| Action                     | Description                                           |
|----------------------------|-------------------------------------------------------|
| `Return(value)`            | Returns the given value                                |
| `ReturnRef(variable)`      | Returns a reference to the variable                   |
| `ReturnPointee(ptr)`       | Returns the value pointed to by `ptr`                 |
| `Invoke(function)`         | Calls the provided function/functor with the call args|
| `DoAll(a1, a2, ..., an)`   | Performs actions sequentially, returning last one's value|
| `SetArgPointee<N>(value)` | Sets the pointed value of Nth argument                 |
| `Throw(exception)`         | Throws an exception                                    |

For a full list, see the [Actions Reference](reference/actions.md).

### Complex Actions and Lambdas

You can use lambdas or functors as actions:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * x; });
```

This allows complex behavior inline.

### Using `WillOnce` and `WillRepeatedly`

- Use `WillOnce` to specify behavior for a single invocation.
- Use `WillRepeatedly` for all subsequent calls after `WillOnce`s are exhausted.

Example:

```cpp
EXPECT_CALL(mock, Foo())
    .WillOnce(Return(1))
    .WillRepeatedly(Return(2));
```

Here, the first call returns 1, others return 2.

### Using `DoAll` for Sequencing Side Effects

You can combine side effects and return values:

```cpp
EXPECT_CALL(mock, SaveValue(_))
  .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

The call sets an output argument to 42 and returns true.

---

## 4. Enforcing Call Order and Frequency (Sequences and Cardinalities)

Defining when and how many times mock methods should be called ensures your code uses its collaborators correctly.

### Specifying Call Cardinality with `.Times()`

You can specify expected call frequency:

| Cardinality        | Description                            |
|--------------------|--------------------------------------|
| `Exactly(n)` or `n` | Must be called exactly *n* times      |
| `AtLeast(n)`       | At least *n* times                    |
| `AtMost(n)`        | At most *n* times                     |
| `Between(m, n)`    | Between *m* and *n* times inclusive  |
| `AnyNumber()`      | Any number of calls allowed           |

Omitting `.Times()` defaults to `Times(1)` or an inferred value depending on other clauses.

Example:

```cpp
EXPECT_CALL(mock, Foo())
    .Times(AtLeast(1));
```

### Enforcing Call Order with `Sequence` and `.InSequence()`

Sometimes the order of calls matters. Use `Sequence` objects to enforce call order:

```cpp
using ::testing::Sequence;
Sequence s;
EXPECT_CALL(mock, FirstCall()).InSequence(s);
EXPECT_CALL(mock, SecondCall()).InSequence(s);
```

The calls must occur in the declared order.

### Using `InSequence` Helper Object

A simpler way is to create an `InSequence` block:

```cpp
{
  InSequence seq;

  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

This automatically enforces order within the scope.

### Partial Orders with Multiple Sequences and `.After()`

For complex dependencies, you can specify partial order with multiple sequences or `.After()`:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, CallA()).InSequence(s1, s2);
EXPECT_CALL(mock, CallB()).InSequence(s1);
EXPECT_CALL(mock, CallC()).InSequence(s2);
```

Or equivalently with `.After()`:

```cpp
Expectation eA = EXPECT_CALL(mock, CallA());
EXPECT_CALL(mock, CallB()).After(eA);
EXPECT_CALL(mock, CallC()).After(eA);
```

This sets that `CallA` must happen before `CallB` and `CallC`.

### Retiring Expectations Early

By default, expectations remain "sticky" after saturation, causing call matching to fail on subsequent calls. Using `.RetiresOnSaturation()` marks an expectation to *retire* as soon as it saturates, freeing later calls to match other expectations.

Example:

```cpp
EXPECT_CALL(mock, Foo()).Times(2).RetiresOnSaturation();
```

### Combining Options

All clauses on `EXPECT_CALL()` can be chained in this order:

```cpp
EXPECT_CALL(mock, Method(matchers...))
    .With(multi_matcher)
    .Times(cardinality)
    .InSequence(sequences...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

If you break the order or misuse clauses, GoogleMock will complain.

---

## 5. Practical Examples

### Example 1: Matching Arguments with a Custom Matcher

```cpp
using ::testing::_;
using ::testing::Lt;
using ::testing::Return;

class MockTurtle {
 public:
  MOCK_METHOD(void, SetPosition, (int x, int y), ());
};

TEST(TurtleTest, SetPositionArgs) {
  MockTurtle turtle;
  EXPECT_CALL(turtle, SetPosition(_, _))
      .With(Lt())  // first arg less than second
      .WillOnce(Return());

  turtle.SetPosition(1, 2);  // Passes
  // turtle.SetPosition(2, 1); // Would fail
}
```

---

### Example 2: Sequencing Calls

```cpp
using ::testing::Sequence;
using ::testing::Return;

class MockFoo {
 public:
  MOCK_METHOD(void, Reset, ());
  MOCK_METHOD(int, GetValue, ());
};

TEST(FooTest, SequenceCalls) {
  MockFoo foo;
  Sequence s;

  EXPECT_CALL(foo, Reset()).InSequence(s);
  EXPECT_CALL(foo, GetValue()).InSequence(s).WillOnce(Return(42));

  foo.Reset();
  int val = foo.GetValue();
  EXPECT_EQ(val, 42);
}
```

---

### Example 3: Return Different Values over Multiple Calls

```cpp
using ::testing::Return;

class MockCounter {
 public:
  MOCK_METHOD(int, GetCount, (), ());
};

TEST(CounterTest, ReturnsMultipleValues) {
  MockCounter counter;
  EXPECT_CALL(counter, GetCount())
      .WillOnce(Return(1))
      .WillOnce(Return(2))
      .WillRepeatedly(Return(3));

  EXPECT_EQ(counter.GetCount(), 1);
  EXPECT_EQ(counter.GetCount(), 2);
  EXPECT_EQ(counter.GetCount(), 3);
  EXPECT_EQ(counter.GetCount(), 3);
}
```

---

## 6. Troubleshooting & Tips

### Expectation Not Met

- Make sure your `EXPECT_CALL` is set before the mock method is invoked.
- Check argument matchers carefully; an unexpected argument causes failure.
- Use `--gmock_verbose=info` to see detailed call matching traces.

### Too Many or Too Few Actions

- `WillOnce` actions should align with `.Times()` cardinality.
- Use `WillRepeatedly` wisely for calls beyond `WillOnce`s.
- If actions run out, GoogleMock warns or errors.

### Handling Overloaded Methods

- Use explicit argument lists or `Const()` to disambiguate.
- Prefer simpler mock interfaces when overloading gets complex.

### Avoid Over-specification

- Match only relevant arguments.
- Use `_` as wildcards for unimportant parameters.
- Limit `.Times()` to meaningful numbers.

<Warning>
Setting expectations out-of-order or after mock method calls is undefined and will break your tests. Always define all `EXPECT_CALL` before exercising your mocks.
</Warning>

---

## 7. Next Steps & Related Content

### What's Next?

- Review the [Basics of Mocking Functions and Classes](guides/mocking-best-practices/basics-of-mocking) for foundational knowledge.
- Explore the [Matchers Reference](reference/matchers.md) to master argument matching.
- Dive into the [Actions Reference](reference/actions.md) for advanced action usage.

### Related Guides

- [Mocking Best Practices and Common Pitfalls](guides/mocking-best-practices/mocking-best-practices) — for writing stable tests.
- [gMock Cookbook](docs/gmock_cook_book.md) — practical recipes for everyday use.

### Resources

- [GoogleTest GitHub Repository](https://github.com/google/googletest)
- Official [GoogleMock Documentation Website](https://google.github.io/googletest/gmock.html)

---

By mastering matchers, actions, and sequences, you can specify mock behaviors with precision and flexibility, bringing your tests closer to the real world of application logic while keeping them maintainable and expressive.
