---
title: "Death Tests and Failure Handling"
description: "Focused instructions for testing code expected to fail in controlled ways. Learn to use death test macros, handle fatal versus non-fatal assertions, and verify robust error handling in your codebase."
---

# Death Tests and Failure Handling

Master controlled testing of expected failures, crashes, and abnormal program termination by using GoogleTest's death test macros and failure handling utilities. This guide walks you through writing tests that verify your code handles fatal conditions robustly without affecting your test suite stability.

---

## Overview

Death tests ensure that your program terminates (dies) correctly when hitting unrecoverable errors, failed assertions, or other fatal states. They verify safety-critical code paths and guard against undefined or risky program states.

This page covers:

- How to write death tests using `EXPECT_DEATH`, `ASSERT_DEATH`, and related macros
- Distinguishing between fatal and non-fatal assertions
- Handling exceptions and verifying expected error output
- Best practices and common pitfalls when writing death tests

### Prerequisites

- Familiarity with basic GoogleTest test writing
- GoogleTest configured and integrated into your C++ build
- Exception handling enabled if you want to test exception-related deaths

### Outcome

By following this guide, you will be able to write robust death tests that verify your code’s behavior in failure scenarios and understand how to interpret and handle test failures related to process termination.

### Time Estimate

15-30 minutes (depends on familiarity)

### Difficulty Level

Intermediate

---

## Writing Death Tests: Step-by-Step

### 1. Use Death Test Macros

The primary macros for death tests are:

- `ASSERT_DEATH(statement, regex_or_matcher)`
- `EXPECT_DEATH(statement, regex_or_matcher)`
- `ASSERT_EXIT(statement, predicate, regex_or_matcher)`
- `EXPECT_EXIT(statement, predicate, regex_or_matcher)`
- `EXPECT_DEBUG_DEATH(statement, regex_or_matcher)` (only asserts in debug builds)

#### How They Work

- Death tests run the `statement` in a child process.
- The child process is expected to terminate (exit or abort).
- The parent process verifies the child’s exit status and output (stderr) matches expectations.

The second argument (or third for `EXIT` macros) verifies the error output via regular expressions or matcher objects.

For example:
```cpp
TEST(FooDeathTest, InvalidInput) {
  ASSERT_DEATH(Foo(-1), "Invalid input detected");
}

TEST(FooDeathTest, GracefulExit) {
  EXPECT_EXIT(ExitNow(), ::testing::ExitedWithCode(0), "Success");
}
```

### 2. Understand Fatal vs Non-Fatal Assertions

- `ASSERT_*` macros generate fatal failures that immediately abort the current test function.
- `EXPECT_*` macros generate non-fatal failures that continue the test function execution.
- Death tests are special: if the `statement` in a death test returns or throws, the death test **fails**.

### 3. Testing Exceptions in Death Tests

- Exceptions escaping a death test are considered failures.
- GoogleTest can catch and report these exceptions as failures without letting them escape.
- For example:
  ```cpp
  EXPECT_NONFATAL_FAILURE(EXPECT_DEATH(throw std::exception(), ""), "threw an exception");
  ```
- Use `EXPECT_THROW` family macros to test exceptions separately.

### 4. Naming Convention and Thread Safety

- Name your test suites containing death tests with the suffix `DeathTest`.
- Death tests run before other tests in the suite to reduce interference.
- Be cautious when using death tests with multithreaded code; configure the death test style as needed.

### 5. Setting Death Test Style

Death tests can run in two styles:

- **Fast**: The child process runs the death test immediately after fork.
- **Threadsafe**: The child re-executes the entire test binary and only runs the designated death test.

Control via `--gtest_death_test_style=[fast|threadsafe]` or programmatically:
```cpp
GTEST_FLAG_SET(death_test_style, "threadsafe");
```

Threadsafe style is safer with threads but slower.

### 6. Using `EXPECT_DEATH_IF_SUPPORTED`

On platforms without death test support, these macros gracefully skip tests instead of failing:
```cpp
EXPECT_DEATH_IF_SUPPORTED(stmt, matcher);
ASSERT_DEATH_IF_SUPPORTED(stmt, matcher);
```

Useful when cross-compiling or running on unsupported platforms.

---

## Practical Examples

### Simple Death Test
```cpp
TEST(MyDeathTest, TerminatesOnBadInput) {
  EXPECT_DEATH(MyFunction(-1), "Error: invalid input");
}
```
Verifies `MyFunction(-1)` terminates and prints an error matching the regex.

### Exit Code Verification with `EXPECT_EXIT`
```cpp
TEST(MyDeathTest, GracefulExit) {
  EXPECT_EXIT(CleanupAndExit(), testing::ExitedWithCode(0), "Shutdown complete");
}
```
Checks the process exits with code 0 and outputs "Shutdown complete".

### Death Test with Compound Statement
```cpp
TEST(MyDeathTest, DiesWithinBlock) {
  EXPECT_DEATH({
    int* p = nullptr;
    *p = 5;  // Causes segfault
  }, "segmentation fault");
}
```
Death test enclosing multiple instructions.

### Testing Exceptions Escaping Death Tests
```cpp
TEST(ExceptionDeathTest, ThrowingIsFailure) {
  EXPECT_NONFATAL_FAILURE(EXPECT_DEATH(throw std::runtime_error("fail"), ""), "threw an exception");
}
```
Confirms throwing an exception during a death test fails properly.

---

## Troubleshooting & Tips

### Common Issues

- **Death test fails to detect expected termination**: Check that your code actually terminates and does not catch exceptions internally.
- **Regex matching failure**: Ensure your regex matches the exact stderr content produced. Use `std::string` or `ContainsRegex` matchers for complex output.
- **Multiple death test assertions on the same line**: Compiling will fail. Place death tests on separate lines.
- **Death tests with multithreaded code timing out or hanging**: Try using the "fast" death test style or isolate death tests to single-threaded setups.

### Best Practices

- Use descriptive but concise regex to match error output.
- Group death test cases into a dedicated `*DeathTest` suite.
- Avoid side-effects in the death test statement since it runs in a child process.
- Remember memory freed in death test child processes will not affect the parent.
- Use `SCOPED_TRACE` to add context when checking multiple death tests in loops or helpers.

### Performance Considerations

- Death tests spawn new processes, so they are slower than regular tests.
- Minimize the number of death tests if test suite speed is a concern.
- Prefer the "fast" style if you're sure your code is single-threaded during the death test.

---

## Next Steps & Related Documentation

- Explore [Writing and Running Your First Tests](../core-workflows/writing-first-tests.md) to solidify basic tests.
- Dive into [Assertions Reference](../../reference/assertions.md#death) to understand death assertion macros.
- Learn about [Exception Assertions](../../reference/assertions.md#exceptions) for handling exceptions testing.
- Check out [Death Tests: Design and Use Cases](../../concepts/integration-patterns-advanced/death-tests-architecture.md) for architectural insights.
- Consult [Troubleshooting Common Setup Issues](../../getting-started/validation-troubleshooting/common-issues.md) if integration problems arise.

---

## Summary

Death Tests and Failure Handling equips you to rigorously verify program termination behaviors using GoogleTest’s death test macros. It guides you through writing controlled death tests, handling fatal and non-fatal failures, and catching exceptions to ensure your application handles error states correctly.

Master death test styles, debug common pitfalls, and integrate these tests seamlessly into your test suite to boost software safety and confidence.

---

## Reference Links

- [GoogleTest Assertions Reference](../reference/assertions.md#death)
- [Advanced GoogleTest Topics](../../docs/advanced.md#death-tests)
- [GoogleTest Death Test API](../api-reference/specialized-testing-apis/death-tests.md)
- [Exception Assertions](../reference/assertions.md#exceptions)
- [Regular Expression Syntax for Death Tests](../../docs/advanced.md#regular-expression-syntax)
- [GoogleTest Primer](../overview/product-intro-core-concepts/what-is-gtest.md)

---