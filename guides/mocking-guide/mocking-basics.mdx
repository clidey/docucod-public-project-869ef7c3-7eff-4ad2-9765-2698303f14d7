---
title: "Creating and Using Mock Objects"
description: "Start mocking C++ classes quickly: define mock classes, use basic ON_CALL and EXPECT_CALL syntax, and check invocation counts. This guide is perfect for first-time users introducing mocks into their test suites."
---

# Creating and Using Mock Objects

This guide helps you start mocking C++ classes quickly by defining mock classes, using basic `ON_CALL` and `EXPECT_CALL` syntax, and checking invocation counts. It is designed for first-time users introducing mocks into their test suites.

---

## What This Page Covers

- How to define mock classes and mock methods using `MOCK_METHOD`
- Setting up behavior and expectations with `ON_CALL` and `EXPECT_CALL`
- Using argument matchers for flexible call validation
- Controlling how many times a mock method is expected to be called
- Writing tests that verify interactions with mock objects

## Prerequisites

- A C++ project with GoogleTest and GoogleMock installed and configured
- Basic understanding of C++ classes and virtual methods
- Familiarity with writing simple unit tests

## Expected Outcome

By following this guide, you will be able to create your own mock classes in C++, specify default behaviors and expectations for the mocked methods, and write test cases that verify how your code interacts with these mocks.

---

## 1. Defining Mock Classes

Start by defining a mock class that inherits from the interface or base class you want to mock. Use the `MOCK_METHOD` macro to declare mocked methods.

### Syntax:
```cpp
class MockClassName : public BaseClass {
 public:
  MOCK_METHOD(ReturnType, MethodName, (ArgTypes...), (Specifiers));
};
```

- `ReturnType`: The return type of the method.
- `MethodName`: The method name to mock.
- `(ArgTypes...)`: Parenthesized list of argument types.
- `(Specifiers)`: Qualifiers like `const`, `override`, `noexcept`, etc. (optional but recommended when overriding virtual methods)

### Example:
```cpp
#include <gmock/gmock.h>

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

<Note>
`MOCK_METHOD` must be placed in the `public:` section even if the original method is `protected` or `private`. This allows gMock macros like `ON_CALL` and `EXPECT_CALL` to access the mocks.
</Note>

<Warning>
Be mindful of commas in argument types (e.g., template types). If your argument or return type contains commas, wrap the type in extra parentheses or use type aliases to prevent macro parsing issues.
</Warning>

---

## 2. Specifying Default Behavior with ON_CALL

Use `ON_CALL` to define the behavior of mocked methods without setting expectations (i.e., without specifying that the method must be called).

### Syntax:
```cpp
ON_CALL(mock_object, MethodName(matchers...))
    [.With(multi_argument_matcher)]
    .WillByDefault(action);
```

- `mock_object`: Your mock instance.
- `MethodName`: The mocked method.
- `matchers...`: Zero or more argument matchers. Omitting arguments means match any.
- `With()`: Optional multi-argument matcher applying to all arguments as a tuple.
- `WillByDefault()`: Specifies the action to take when the method is called.

### Example:
```cpp
MockTurtle turtle;
using ::testing::_;
using ::testing::Return;

// By default, the turtle's GetX method returns 10
ON_CALL(turtle, GetX()).WillByDefault(Return(10));
```

### Notes:
- Multiple `ON_CALL`s can be defined for different argument patterns; the most recent matching one is used.
- `ON_CALL` only sets *default* behavior and does not verify call counts.

---

## 3. Setting Expectations with EXPECT_CALL

`EXPECT_CALL` defines an expectation that a method will be called with specific arguments, how many times, and what it will do.

### Syntax:
```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    [.With(multi_argument_matcher)]
    [.Times(cardinality)]
    [.InSequence(sequences...)]
    [.After(expectations...)]
    [.WillOnce(action)]
    [.WillRepeatedly(action)]
    [.RetiresOnSaturation()];
```

### Key Clauses Explained:
- **With**: Does a tuple-based argument match (useful for complex constraints over multiple params).
- **Times**: Specifies how many times the method must be called. Common cardinalities include `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`, `Between(m, n)`.
- **InSequence**: Restricts call ordering by placing the expectation in one or multiple `Sequence` objects.
- **After**: Specifies that this expectation happens after other expectations.
- **WillOnce**: Defines an action to perform on one call (can chain multiple for successive calls).
- **WillRepeatedly**: Defines an action to perform on all subsequent calls after `WillOnce` actions are exhausted.
- **RetiresOnSaturation**: Marks the expectation as inactive once its call number limit is reached, allowing other expectations to match subsequent calls.

<Info>
If you omit `Times()`, GoogleMock tries to infer it from the presence of `WillOnce()` and `WillRepeatedly()` actions.
</Info>

### Example:
```cpp
using ::testing::AtLeast;
using ::testing::_;
using ::testing::Return;

EXPECT_CALL(turtle, Forward(100))
    .Times(AtLeast(1));  // Expects Forward(100) to be called at least once

EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));  // Returns 10, then 20, then 30 thereafter
```

---

## 4. Using Argument Matchers

Matchers allow you to specify flexible argument constraints rather than exact values.

- `_` matches any value.
- `Eq(value)` matches arguments equal to `value`.
- `Ge(n)`, `Gt(n)`, `Le(n)`, `Lt(n)` match based on numeric comparisons.
- `NotNull()` checks for non-null pointers.
- `ElementsAre(...)` matches containers with specified elements.
- `Pointee(m)` matches pointer arguments by pointed-to value.

### Example:
```cpp
EXPECT_CALL(turtle, Forward(Ge(50)));  // forward by at least 50
EXPECT_CALL(turtle, GoTo(_, 0));       // y coordinate is 0, x can be anything
```

<Note>
You can combine matchers inside `.With()` to express relationships between arguments, like ensuring the first argument is less than the second.
</Note>

---

## 5. Using Sequences and Partial Ordering

Sometimes the order of calls matters. Use `Sequence` and `InSequence` to enforce strict ordering.

### Example:
```cpp
using ::testing::Sequence;
Sequence seq1, seq2;

EXPECT_CALL(turtle, PenDown()).InSequence(seq1);
EXPECT_CALL(turtle, Forward(10)).InSequence(seq1, seq2);
EXPECT_CALL(turtle, PenUp()).InSequence(seq2);
```

This means `PenDown()` should be called before `Forward(10)`, and `Forward(10)` before `PenUp()`. Calls outside these sequences can happen in any order.

You can also use the RAII helper:
```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Call1());
  EXPECT_CALL(mock, Call2());
}
```

which places expectations inside an anonymous sequence in order.

---

## 6. Verifying Call Counts and Expectations

GoogleMock automatically verifies that expectations are satisfied when mock objects go out of scope.

You can also manually verify at any point by:

```cpp
EXPECT_TRUE(Mock::VerifyAndClearExpectations(&mock_object));
```

If expectations are not met, GoogleMock will report failures indicating which expectations were unsatisfied.

---

## 7. Common User Workflows

### Typical Mock Test Flow:
<Steps>
<Step title="Define the mock class">
Inherit from your interface, declare methods with `MOCK_METHOD`.
</Step>
<Step title="Set default behaviors">
Use `ON_CALL` in test setup or constructor to define default mock behaviors.
</Step>
<Step title="Set expectations">
Use `EXPECT_CALL` before exercising the code under test, specifying call count, argument matchers, and actions.
</Step>
<Step title="Exercise your code">
Call the code that uses your mock; GoogleMock verifies expectations during calls.
</Step>
<Step title="Automatic or manual verification">
Verify that all expectations are satisfied automatically at the end of the test or manually as needed.
</Step>
</Steps>

---

## 8. Practical Tips & Best Practices

- **Use `ON_CALL` for default behavior, `EXPECT_CALL` only when you want to verify calls.** Overuse of `EXPECT_CALL` can lead to brittle tests.
- **Suppressing uninteresting call warnings:** Use `NiceMock<T>` to silence warnings for calls with no expectations.
- **Order of expectations matters:** Newer expectations override older ones. More specific `EXPECT_CALL`s should come after general ones.
- **For overloaded methods:** Use `MOCK_METHOD` with correct qualifiers; consider `Const()` wrapper for const overloads.
- **Avoid setting expectations after code starts calling mocks.** Doing so leads to undefined behavior.
- **Use action clauses like `WillOnce()` and `WillRepeatedly()` to specify what the mock should do.**
- **Use `.RetiresOnSaturation()` on expectations to allow other expectations to match calls after saturation.**

---

## 9. Troubleshooting Common Issues

### Mock Method Not Called or Failing
- Ensure that `EXPECT_CALL` is set before code under test calls the mock method.
- Check argument matchers carefully; defaults match any, but specific matchers must align.
- Run tests with `--gmock_verbose=info` to see detailed tracing of mock calls and matching.

### Compiler Errors with `MOCK_METHOD`
- Wrap return and argument types with commas in parentheses or use type aliases.
- Ensure qualifiers provided (e.g., `const`, `override`) match exactly with base class methods.

### Uninteresting Call Warnings
- Use `NiceMock` if you want to suppress warnings about calls without `EXPECT_CALL`.
- Alternatively, add a catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());`

### Overloaded Method Ambiguities
- Use `Const(mock)` wrapper for const methods.
- Provide explicit matchers for arguments to disambiguate overloads.

---

## 10. Additional Examples

### Simple mock method expectation
```cpp
MockTurtle turtle;
EXPECT_CALL(turtle, Forward(100))
    .Times(2)
    .WillRepeatedly(Return());

turtle.Forward(100);
turtle.Forward(100);
```

### Using sequences to enforce call order
```cpp
Sequence s;
EXPECT_CALL(turtle, PenDown()).InSequence(s);
EXPECT_CALL(turtle, Forward(50)).InSequence(s);

// Calls must happen in this order to satisfy expectations
```

### Setting default behavior for a mock method
```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(42));
```

---

## Next Steps

- Explore [Advanced Mocking Patterns and Best Practices](../advanced-mocking.md) to deepen your skills
- Learn about [Matchers Reference](../matchers.md) for powerful argument validation
- Review [Writing and Organizing Tests](../writing-tests.md) for test structure
- Check [Using Assertions for Effective Validation](../using-assertions.md) to assert behavior


---

## References & Links

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) - Beginner-friendly tutorial
- [Mocking Reference](../reference/mocking.md) - Complete API details
- [gMock Cookbook](../gmock_cook_book.md) - Recipes and recipes for common mocking tasks
- [Mocking Cheat Sheet](../gmock_cheat_sheet.md) - Quick reference for gMock features

---

Happy mocking! Your tests will be stronger, clearer, and more maintainable using these techniques.
