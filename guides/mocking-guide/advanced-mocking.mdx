---
title: "Advanced Mocking Patterns and Best Practices"
description: "Explore cardinalities, sequences, matchers, side-effects, and different mock strictness levels. Develop robust, maintainable test doubles through advanced techniques and learn which strategies best suit various scenarios."
---

# Advanced Mocking Patterns and Best Practices

Explore cardinalities, sequences, matchers, side-effects, and different mock strictness levels. Develop robust, maintainable test doubles through advanced techniques and learn which strategies best suit various scenarios.

---

## 1. Understanding Advanced Mocking Patterns

Mocking is more than just faking methods; it’s about precisely controlling and validating the interaction of your code with its dependencies. This page empowers you to master advanced patterns including cardinalities, call sequences, argument matchers, side-effects, and mock strictness for professional-grade tests.

### Why Advanced Mocking Patterns Matter

When building complex tests, simple mock expectations become inadequate or unwieldy. Advanced patterns let you:

- Specify how many times a method should be called (cardinalities)
- Enforce order or partial order of calls (sequences)
- Match arguments with complex predicates (matchers)
- Inject side effects or composite behaviors (actions)
- Manage mock strictness to control warnings and failures on unexpected calls

These tools ensure your tests are robust, maintainable, and accurately reflect your intended design.

---

## 2. Cardinalities: Controlling Call Counts

### What Are Cardinalities?
Cardinalities specify how many times you expect a mock method to be called. This allows you to express constraints like "at least twice" or "never called" precisely.

### Built-in Cardinalities
Use these in the `.Times()` clause of `EXPECT_CALL`:

| Cardinality         | Meaning                                       |
|---------------------|-----------------------------------------------|
| `AnyNumber()`       | Call can occur any number of times            |
| `AtLeast(n)`        | Call at least *n* times                        |
| `AtMost(n)`         | Call at most *n* times                         |
| `Between(m, n)`     | Call between *m* and *n* times inclusive      |
| `Exactly(n)` or `n` | Call exactly *n* times                         |

### Default Cardinality Inference
If you omit `.Times()`, gMock infers it by:

- No `WillOnce` or `WillRepeatedly`: `Times(1)`
- `n` `WillOnce` and no `WillRepeatedly`: `Times(n)`
- `n` `WillOnce` and one `WillRepeatedly`: `Times(AtLeast(n))`

### Best Practices

- Use `.Times(0)` to explicitly disallow calls.
- Combine cardinalities with `.WillOnce()` and `.WillRepeatedly()` for fine-grained control.
- Avoid ambiguous cardinalities by specifying explicit `.Times()` when needed.

---

## 3. Sequences and Partial Orders: Controlling Call Order

Often, the order of mock calls matters. GoogleMock allows you to specify full or partial orders.

### Full Sequence with `InSequence`
Wrap your expectations in a scope with `InSequence` to enforce strict call order:

```cpp
{  
  ::testing::InSequence seq;  
  EXPECT_CALL(mock, Foo());
  EXPECT_CALL(mock, Bar());
}
```

Here, `Foo()` must be called before `Bar()`.

### Complex Partial Orders with `Sequence` Objects
For partial order where some calls precede others but some may occur in any order, use `Sequence` objects:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, A()).InSequence(s1, s2);
EXPECT_CALL(mock, B()).InSequence(s1);
EXPECT_CALL(mock, C()).InSequence(s2);
```

This models a DAG where `A` occurs before `B` and `C`, but `B` and `C` can happen in any order.

### Specifying Post-Call Constraints with `.After()`
Create named expectations and chain `.After()` to specify that a call happens after others:

```cpp
auto e1 = EXPECT_CALL(mock, InitFoo());
auto e2 = EXPECT_CALL(mock, InitBar());
EXPECT_CALL(mock, UseFooBar()).After(e1, e2);
```

### Retiring Expectations: `.RetiresOnSaturation()`
By default, expectations remain active after they are satisfied. Use `.RetiresOnSaturation()` to deactivate an expectation when its call quota is met, permitting fallback to other expectations.

---

## 4. Advanced Matchers: Precise Argument Validation

Matchers let you express complex criteria for arguments beyond simple equality.

### Built-in Matchers
You can match any argument using built-in matchers like `_` (wildcard), `Eq(value)`, `Ge(n)`, `HasSubstr()`, `Pointee()`, and many more.

Example:

```cpp
EXPECT_CALL(foo, Bar(Ge(5), Pointee(Eq(10))));
```

### Combining Matchers
You can combine matchers with `AllOf()`, `AnyOf()`, and negate them with `Not()`:

```cpp
EXPECT_CALL(foo, Baz(AllOf(Ge(10), Ne(15))));
```

### Matching Multiple Arguments Together
Use `.With()` with a multi-argument matcher to impose constraints on all arguments as a tuple.

Example: Assert first argument less than second:

```cpp
EXPECT_CALL(foo, Func(_, _)).With(Lt());
```

### Custom Matchers
Define your own matchers with `MATCHER()` and `MATCHER_P()` macros for reusable, expressive checks. They are especially useful when built-in matchers don’t cover your domain logic.

---

## 5. Mock Side-Effects and Actions: Controlling Behavior

Specifying what a mock method should do when called is crucial.

### Built-in Actions
Examples include:
- `Return(value)` — Return a fixed value.
- `ReturnRef(variable)` — Return a reference.
- `SetArgPointee<N>(value)` — Modify output argument.
- `DoAll(a1, a2, ..., an)` — Perform multiple actions sequentially.

### Combining Side-Effects
Use `DoAll()` to combine side-effects and return values:

```cpp
EXPECT_CALL(mock, Mutate(_))
  .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

This sets the output parameter and returns `true` simultaneously.

### Using Callables as Actions
You can use functions, lambdas, functors directly with `Invoke()`:

```cpp
EXPECT_CALL(mock, Compute(_))
  .WillOnce(Invoke([](int x) { return x * 2; }));
```

### Invoking Function Arguments
For mock methods that accept callbacks, use `InvokeArgument<N>(args...)` to call the `N`th argument:

```cpp
EXPECT_CALL(mock, DoAsync(_))
  .WillOnce(InvokeArgument<0>(42));  // Calls the callback with 42
```

### Ignoring Results
Use `IgnoreResult(action)` to discard the return value when the mock method is `void` or when chaining actions.

---

## 6. Mock Strictness Levels: Managing Uninteresting Calls

Unexpected or uninteresting calls are handled differently based on strictness.

| Strictness   | Behavior on Uninteresting Calls           |
|--------------|-------------------------------------------|
| **NaggyMock** (default) | Warns but allows the call                            |
| **NiceMock**   | Silences warnings on uninteresting calls   |
| **StrictMock** | Fails the test on uninteresting calls      |

### When to Use What

- Use `NiceMock` to keep your test output clean when you do not care about some mocks’ methods.
- Use `NaggyMock` when you want warnings helping detect missing expectations while developing tests.
- Use `StrictMock` to ensure no unexpected calls happen for maximal verification.

### How to Use

Wrap your mock class with a strictness wrapper:

```cpp
NiceMock<MyMock> nice_mock;
StrictMock<MyMock> strict_mock;
NaggyMock<MyMock> naggy_mock;
```

They accept the same constructor parameters as your base mock.

### Caveats
- Only affects mock methods defined by `MOCK_METHOD` directly on the mocked class.
- Does not affect expected calls—only uninteresting calls.

---

## 7. Putting It All Together: Sample Use Cases

### Enforcing Call Sequence with Specific Return Values

```cpp
Sequence s;
EXPECT_CALL(foo, DoThis(1))
    .InSequence(s)
    .WillOnce(Return(true));
EXPECT_CALL(foo, DoThis(2))
    .InSequence(s)
    .WillOnce(Return(false));

// foo.DoThis(2) called before foo.DoThis(1) --> error
```

### Using Matchers to Refine Expectations

```cpp
EXPECT_CALL(bar, Compute(Ge(10), Pointee(Eq(5))));
```

### Combining Side-Effects and Return Values

```cpp
EXPECT_CALL(baz, Modify(_))
    .WillOnce(DoAll(SetArgPointee<0>(100), Return(true)));
```

### Suppressing Uninteresting Call Warnings

```cpp
NiceMock<MockService> service;
EXPECT_CALL(service, ExpectedMethod());  // No warning for unconfigured methods
```

---

## 8. Troubleshooting Common Issues

### Too Many or Too Few Actions

- gMock warns if you specify more `WillOnce()` actions than allowed by `Times()` or if too few.
- Ensure actions correspond to expected call count.

### Unexpected Call Errors

- Check that your matchers correctly cover all expected arguments.
- Use `--gmock_verbose=info` for call trace insights.

### Uninteresting Call Warnings

- Add `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());` to mark calls as expected but flexible.
- Use `NiceMock<>` for cleaner output when uninteresting calls aren't critical.

### Mock Methods Not Overriding Virtuals

- Verify your mocked methods have the right `const`, `override`, and `noexcept` qualifiers matching the base method.
- Check mock methods are declared `virtual` in the base interface.

### Handling Move-Only Types

- Use lambdas and `Invoke` when `Return()` cannot handle move-only return values correctly.

---

## 9. Next Steps & Further Reading

- Review [Mock Class Definition and Method Mocking](/api-reference/mocking-apis/mock-class-definition) to master `MOCK_METHOD`.
- Explore [Matchers and Matchers API](/guides/advanced-testing-features/matchers-and-matchers-api) for deeper matcher techniques.
- Learn how to [Set Default Actions and Expectations](docs/gmock_cook_book.md#SettingDefaultActions) well.
- Follow the [Getting Started with GoogleTest](/guides/gtest-core-guides/getting-started) guide to build comprehensive test suites.

---

## References

- [gMock Cookbook](docs/gmock_cook_book.md)
- [Mocking Reference](docs/reference/mocking.md)
- [Actions Reference](docs/reference/actions.md)
- [Legacy gMock FAQ](docs/gmock_faq.md)
- [Advanced Mocking Patterns and Best Practices (This Page)](/guides/mocking-guide/advanced-mocking)
- [gMock for Dummies](docs/gmock_for_dummies.md)

---