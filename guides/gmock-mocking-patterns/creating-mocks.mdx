---
title: "Creating and Using Mock Classes"
description: "Step-by-step instructions for defining mock classes using the MOCK_METHOD macro, setting up method expectations, and using mocks effectively within test cases. Includes common workflows and troubleshooting advice."
---

# Creating and Using Mock Classes

This guide walks you through the process of defining mock classes using GoogleMock's `MOCK_METHOD` macro, setting up expectations on those mock methods, and effectively using your mocks within test cases. You will find practical examples, common workflows, and troubleshooting advice to ensure your mocks serve your testing goals efficiently.

---

## 1. Workflow Overview

### Task Description
Define mock classes that simulate the behavior of real classes or interfaces using GoogleMock, allowing you to specify method behaviors and verify interactions in your tests.

### Prerequisites
- Have GoogleMock and GoogleTest installed and correctly integrated into your project.
- Basic understanding of C++ classes and virtual methods.
- Familiarity with C++11 features such as lambdas and smart pointers is helpful but not mandatory.

### Expected Outcome
By following this guide, you will:
- Construct mock classes with mocked methods.
- Use `EXPECT_CALL` and `ON_CALL` to control mock behavior.
- Understand how to set expectations, default actions, and handle method qualifiers.
- Avoid common pitfalls and effectively verify mock interactions in your tests.

### Time Estimate
This workflow is expected to take approximately 15-30 minutes for users new to GoogleMock.

### Difficulty Level
Beginner to Intermediate

---

## 2. Defining Mock Classes

### Creating Basic Mock Methods
To create a mock class, inherit from the interface or base class you want to mock. Use `MOCK_METHOD` within the `public:` section of your mock class to define mocked methods.

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
  virtual ~Foo();
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};
```

### Important Notes on MOCK_METHOD
- The macro takes three mandatory parameters: return type, method name, and argument list.
- An optional fourth parameter lets you specify qualifiers such as `const`, `override`, `noexcept`, calling conventions like `Calltype(STDMETHODCALLTYPE)`, or reference qualifiers like `ref(&)`.
- Commas in argument types (e.g., templated types like `std::pair<int, int>`) must be properly wrapped in parentheses or use type aliases to prevent macro parsing errors.

### Example Handling Commas
```cpp
class MockFoo {
 public:
  // Won't compile:
  // MOCK_METHOD(std::pair<int, int>, GetPair, ());

  // Correct approaches:
  MOCK_METHOD((std::pair<int, int>), GetPair, ());

  using IntPair = std::pair<int, int>;
  MOCK_METHOD(IntPair, GetPair, ());
};
```

### Mocking Private and Protected Methods
Place all `MOCK_METHOD` declarations in the public section to allow `EXPECT_CALL` and `ON_CALL` to access those methods regardless of their original access in the base class.

---

## 3. Setting Expectations and Default Behaviors

### Using EXPECT_CALL
`EXPECT_CALL` narrates what methods you expect will be called, with which arguments, how many times, and what the method should do when invoked.

Basic syntax:
```cpp
EXPECT_CALL(mock_object, Method(arg_matchers...))
    .Times(cardinality)              // How many times the call is expected
    .WillOnce(action)                // What to do once
    .WillRepeatedly(action)          // What to do when call repeated
    .InSequence(sequence...)          // Optional order control
    .After(expectations...)           // Optional partial order
    .RetiresOnSaturation();           // Retire expectation when saturated
```

### Using ON_CALL
To specify a mock method's default behavior without asserting that it must be called, use `ON_CALL`:

```cpp
ON_CALL(mock_object, Method(matchers...)).WillByDefault(action);
```

Use `ON_CALL` to set default behaviors, reducing over-specification in tests.

### Practical Example
```cpp
using ::testing::Return;
using ::testing::_;

MockFoo mock;

ON_CALL(mock, GetSize()).WillByDefault(Return(10));
EXPECT_CALL(mock, Describe(_)).Times(1).WillOnce(Return("mocked"));

std::string desc = mock.Describe("test");  // Returns "mocked"
int size = mock.GetSize();                   // Returns 10 due to ON_CALL
```

### Cardinalities
- `Times(AnyNumber())`: method can be called any times.
- `Times(Exactly(n))`: method called exactly n times.
- `Times(AtLeast(n))`, `Times(AtMost(n))`, and `Times(Between(m, n))` allows flexible call frequency.
- If omitted, cardinality is inferred based on `.WillOnce` and `.WillRepeatedly` usage.

---

## 4. Mocking Special Cases

### Mocking Overloaded Methods
Mock each overload separately with the exact signature including qualifiers.

```cpp
class Foo {
public:
  virtual int Add(int x);
  virtual int Add(int x, int y);
  virtual const std::string& GetName() const;
  virtual std::string& GetName();
};

class MockFoo : public Foo {
public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (int x, int y), (override));
  MOCK_METHOD(const std::string&, GetName, (), (const, override));
  MOCK_METHOD(std::string&, GetName, (), (override));
};
```

### Mocking Move-only Types
Mocking methods with `std::unique_ptr` or other move-only types is supported:

```cpp
class Buzzer {
 public:
  virtual std::unique_ptr<Buzz> MakeBuzz(std::string text) = 0;
};

class MockBuzzer : public Buzzer {
 public:
  MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (std::string text), (override));
};
```

Set expectations using lambdas to return new unique pointers each time.

### Mocking Non-virtual Methods
Mock non-virtual methods by creating unrelated mock classes with methods of the same signature (no `override` specifier).

---

## 5. Using Mocks in Tests

### Typical Workflow
1. Create mock object(s).
2. Use `ON_CALL` to set default behaviors.
3. Use `EXPECT_CALL` to set expectations and behaviors.
4. Exercise code that uses mocks.
5. Verification happens automatically at mock destruction.

Example:
```cpp
using ::testing::AtLeast;

TEST(PainterTest, DrawsShape) {
  MockTurtle turtle;
  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));

  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

### Forcing Verification Early
If your mock's lifetime is managed externally and may leak, force verification:

```cpp
using ::testing::Mock;

MockFoo* foo = new MockFoo;
EXPECT_CALL(*foo, Bar());

// ... code that uses foo ...

Mock::VerifyAndClearExpectations(foo);
// Avoid setting expectations after this!
```

---

## 6. Best Practices and Common Pitfalls

### Use ON_CALL to Avoid Over-specification
Define general mock behavior with `ON_CALL` in test setup to avoid brittle tests.

### Beware Sticky Expectations
Expectations remain active even after their `Times()` limit is reached unless you use `.RetiresOnSaturation()`. Use this to avoid upper bound violations.

### Newer EXPECT_CALL Rules Take Precedence
Put the more general expectations before more specific ones to ensure correct matching.

### Use Sequences for Ordered Calls
Group expectations with `InSequence` or `Sequence` to require call order.

### Mock Methods Must Be Virtual
Ensure methods you mock are declared virtual in the base class, else `MOCK_METHOD` will not mock them correctly.

### Use Public Section for MOCK_METHOD
Always declare mock methods inside `public:` even if the base class methods are protected or private.

---

## 7. Troubleshooting Common Issues

### Warning: Uninteresting Function Call
If you see warnings about uninteresting calls, either add expectations or use `NiceMock` to suppress.

### Method For Real Object Is Called Instead of Mock
Ensure methods to mock are virtual; otherwise, mocking silently fails.

### Compiler Issues With Commas in Signatures
Wrap types containing commas in parentheses or use type aliases.

### Over-expectations (Too Many Calls)
Use `.RetiresOnSaturation()` or review your test's expectations to align with actual call counts.

### Mock Destructor Not Called Properly
Ensure base class destructors are virtual to allow proper cleanup and verification.

---

## 8. Next Steps & Related Documentation

- **Using Matchers and Actions**: Learn how to specify argument matchers and actions for flexible mock behavior
- **Strict, Nice, and Naggy Mocks**: Control the behavior of uninteresting calls and warnings
- **Mocking Best Practices and Common Patterns**: Explore effective mocking patterns and anti-patterns
- **GoogleMock FAQ**: Common questions and detailed troubleshooting

Refer to the official GoogleMock documentation [Creating and Using Mocks](https://google.github.io/googletest/gmock_cook_book.html#creating-mock-classes) and [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) for comprehensive details.

<Tip>
Remember that the best mock tests are those that verify essential interactions only, avoiding over-constraining your tests and keeping them resilient to implementation changes.
</Tip>

---