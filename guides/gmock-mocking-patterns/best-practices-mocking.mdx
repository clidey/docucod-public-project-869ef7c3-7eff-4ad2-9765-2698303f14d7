---
title: "Mocking Best Practices and Common Patterns"
description: "Summarizes industry best practices for using mocks, including test readability, minimizing brittleness, and effective arrangement of setups and verifications. Shares patterns for isolating dependencies and mistakes to avoid."
---

# Mocking Best Practices and Common Patterns

GoogleMock is a powerful framework for creating and using mocks in C++ tests. To maximize the effectiveness and maintainability of your tests, this guide summarizes industry-proven best practices for using mocks, including improving readability, minimizing brittleness, and organizing your test setup and verification efficiently. It also shares common patterns for isolating dependencies and warns against frequent mistakes.

---

## 1. Writing Readable and Maintainable Tests with Mocks

Mock tests ideally should communicate their intent clearly and be resilient to implementation changes. Follow these practical steps:

### Use `ON_CALL` for Default Behavior
- Use `ON_CALL()` to specify how mocks behave by default without enforcing call expectations.
- Reserve `EXPECT_CALL()` only for interactions you wish to verify.

```cpp
ON_CALL(mock_foo, DoThis()).WillByDefault(Return(42));
EXPECT_CALL(mock_foo, ImportantMethod(5)).Times(1);
```

### Avoid Over-Specification
- Don't set expectations on every method call unless necessary.
- Overly strict expectations make tests brittle and prone to breaking on unrelated changes.

### Use `NiceMock` to Ignore Uninteresting Calls
- When many calls are irrelevant, wrap your mock with `NiceMock<T>` to suppress warnings on uninteresting calls.

```cpp
NiceMock<MockFoo> mock;
EXPECT_CALL(mock, DoThis()); // verifies only this
...
```

### Prefer Descriptive Test Names
- Name tests clearly to express the scenario and expected behavior.
- Helps when diagnosing failures.

### Organize Setup, Exercise, and Verification
- Clearly separate EXPECT_CALL (setup), code under test invocation, and result assertions.

<Tip>
Good tests have *one logical assertion* per test and set only the necessary expectations.
</Tip>

---

## 2. Minimizing Mock Brittleness

Brittle tests require constant maintenance after small code changes. Avoid this with the following patterns:

### Avoid Mocking Concrete Classes
- Prefer mocking interfaces or abstract base classes.
- Introducing mocks on concrete classes creates tight coupling and fragile tests.

### Code to Interfaces
- Design your production code to depend on interfaces.
- Implement adapters to existing concrete classes.
- Mock the interfaces instead of concrete implementations.

### Delegate Logic to Fakes When Appropriate
- Use fakes with working implementations for complex interactions.
- Delegate mock default actions to fakes if you want to retain behavior but verify calls.

```cpp
class MockFoo : public Foo {
  ...
  void DelegateToFake() {
    ON_CALL(*this, Method()).WillByDefault([this]() { return fake_.Method(); });
  }
private:
  FakeFoo fake_;
};
```

### Use Sequences and Partial Ordering Carefully
- Use `InSequence` or `Sequence` to specify call order only when order matters.
- Don't over-constrain.

### Use `RetiresOnSaturation()` to Avoid Sticky Expectations
- Use `.RetiresOnSaturation()` on expectations that must be exhausted and then retired to avoid unexpected failures.

### Set Catch-All Expectations with `Times(AnyNumber())`
- When some calls are expected but others are allowed, add a catch-all `EXPECT_CALL` with `_` matcher.

```cpp
EXPECT_CALL(mock, SomeMethod(_)).Times(AnyNumber());
EXPECT_CALL(mock, SomeMethod(SpecificArg)).Times(1);
```

---

## 3. Structuring Setup and Verification

### Arrange-Act-Assert Pattern
- Clearly organize your test code steps.

```cpp
// Arrange
MockFoo mock;
ON_CALL(mock, Method()).WillByDefault(Return(5));
EXPECT_CALL(mock, CheckedMethod(10));

// Act
auto result = SystemUnderTest(mock).CallCheck();

// Assert
EXPECT_EQ(result, expected);
```

### Use Separate Functions or Fixtures for Common Setup
- Share common `ON_CALL` definitions in test fixtures or helper methods.

### Verify and Clear Expectations Manually Only When Needed
- By default, mocks verify expectations on destruction.
- Use `Mock::VerifyAndClearExpectations(&mock)` if destructors may not run timely.

### Avoid Setting New Expectations After Exercising Mocks
- Setting expectations after the code under test runs leads to undefined behavior.

---

## 4. Effective Patterns to Isolate Dependencies

### Use Class Adapters for Legacy or Concrete Classes
- Wrap legacy classes in pure abstract interfaces to mock dependencies cleanly.

### Mock Only What You Depends On
- Define interfaces minimalistically for your code, exposing only required methods.

### Compose Mocks for Complex Collaborators
- Use mock objects that encapsulate multiple dependencies.

### Use `MockFunction<>` for std::function and Callbacks
- Mock callbacks easily using `MockFunction` template.

---

## 5. Common Mistakes to Avoid

### Not Marking Destructor Virtual
- Interfaces and mock classes must have a virtual destructor to avoid undefined behavior.

### Overusing StrictMock or NaggyMock
- Default to `NiceMock` to reduce test noise and fragility.
- Use `StrictMock` only when verifying strict ordering and exact calls is critical.

### Setting Too Many `EXPECT_CALL`s
- Leads to brittle and hard-to-maintain tests.
- Rely on `ON_CALL` and catch-alls instead.

### Ignoring `Uninteresting Call` Warnings Without Understanding
- Do not suppress warnings blindly.
- Investigate unexpected mock calls to catch hidden bugs.

### Using `EXPECT_CALL` After Exercising Mocks
- Violates gMock contract and produces undefined results.

### Mocking Non-Virtual Methods Without Templates
- Non-virtual methods cannot be mocked unless doing advanced template-based injection.

---

## 6. Troubleshooting Mock Failures

- Use `--gmock_verbose=info` flag to see detailed matching logs.
- Check for shadowed expectations owing to order of `EXPECT_CALL`s.
- Use `NiceMock` temporarily to silence uninteresting call warnings while debugging.
- Confirm that your mocked methods signatures match exactly.

---

## 7. Summary

Good mocking practices improve test clarity, maintainability, and robustness. Follow these principles to create mocks that help you confidently test your C++ code:

- Use `ON_CALL` for common behavior and `EXPECT_CALL` for explicit verification.
- Prefer mocking interfaces rather than concrete classes.
- Use nice mocks to reduce noise and strict mocks judiciously.
- Isolate dependencies via clean interfaces, adapters, and fakes.
- Avoid over-specifying expectations and brittle ordering.
- Leverage sequences and expectation retirement carefully.
- Organize tests with clear Arrange-Act-Assert flows.

By adhering to these best practices, you will harness the full power of GoogleMock for effective interaction testing.

---

## Related Documentation

- [Creating and Using Mock Classes](https://google.github.io/googletest/guides/gmock/mock_classes.html) - practical steps for defining mocks.
- [Using Matchers and Actions](https://google.github.io/googletest/guides/gmock/matchers.html) - how to specify arguments and mock behavior.
- [Controlling Mock Behavior (Nice, Strict, Naggy)](https://google.github.io/googletest/guides/gmock/control_behavior.html) - managing uninteresting calls.
- [Mocking Cookbook](https://google.github.io/googletest/gmock_cook_book.html) - recipes for common mock patterns.
- [Mocking Reference](reference/mocking.md) - detailed API usage.

---

## Practical Tips

<Tip>
When you encounter test failures related to mocks, first enable verbose logging with `--gmock_verbose=info` to understand call matching.
</Tip>

<Tip>
Wrap mocks with `NiceMock` to ignore unimportant calls and reduce log clutter.
</Tip>

<Tip>
Avoid mixing mock setup and execution in the same test block; this prevents hard-to-debug failures.
</Tip>

<Tip>
If your mock class grows large, consider splitting interfaces and reusing mocks to reduce compilation time.
</Tip>