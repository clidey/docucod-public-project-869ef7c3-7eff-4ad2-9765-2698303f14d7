---
title: "Using Assertions and Matchers Effectively"
description: "Demonstrates how to select and apply essential assertion macros and flexible matchers to verify values, exceptions, and custom behaviors in tests. Covers advanced matcher techniques and building custom matchers for specialized types."
---

# Using Assertions and Matchers Effectively

## Overview
This guide demonstrates how to select and apply essential assertion macros and flexible matchers in GoogleTest and GoogleMock to verify values, exceptions, and custom behaviors in your tests. It covers advanced matcher techniques including combining matchers, matching container contents, validating complex properties, and building custom matchers for specialized types.

---

## 1. Understanding Assertions and Matchers

### 1.1 What Are Assertions and Matchers?
- **Assertions** verify the correctness of your code by checking conditions during a test.
- **Matchers** provide expressive and flexible ways to specify expected properties of values, used primarily with predicates and mock expectations.

GoogleTest offers a rich set of assertion macros (e.g., `EXPECT_EQ`, `ASSERT_TRUE`) and a powerful matcher framework (used especially with GoogleMock), enabling readable, maintainable, and informative tests.

### 1.2 Assertion Macros: Basic Usage
- Most macros come in pairs: `EXPECT_` (nonfatal failures, test continues) and `ASSERT_` (fatal failures, aborts current function).
- You can stream additional messages to assertions for clearer failure outputs.

Example:
```cpp
EXPECT_TRUE(is_valid) << "Validation failed for input: " << input_value;
ASSERT_EQ(42, answer) << "Unexpected result";
```

### 1.3 Using `EXPECT_THAT` with Matchers
`EXPECT_THAT(value, matcher)` and `ASSERT_THAT(value, matcher)` enable flexible assertions by verifying that a *value* satisfies a rich *matcher* predicate. Matchers can be combined, parameterized, or custom-built.

Example:
```cpp
EXPECT_THAT(str, StartsWith("Hello"));
EXPECT_THAT(numbers, ElementsAre(1, Gt(0), _, 5));
ASSERT_THAT(value, AllOf(Gt(10), Lt(20)));
```

---

## 2. Essential Assertion Macros

### 2.1 Boolean Assertions
- `EXPECT_TRUE(condition)` / `ASSERT_TRUE(condition)`
- `EXPECT_FALSE(condition)` / `ASSERT_FALSE(condition)`

Use these to confirm Boolean conditions directly.

### 2.2 Binary Comparisons
- `EXPECT_EQ(val1, val2)` / `ASSERT_EQ(val1, val2)` — checks `val1 == val2`
- `EXPECT_NE(val1, val2)` / `ASSERT_NE(val1, val2)` — checks `val1 != val2`
- Also available: `EXPECT_LT`, `EXPECT_LE`, `EXPECT_GT`, `EXPECT_GE`

**Tip:** To compare C strings, use `EXPECT_STREQ` or `EXPECT_STRNE`, not `EXPECT_EQ`.

### 2.3 Floating-Point Comparisons
- Use `EXPECT_FLOAT_EQ` and `EXPECT_DOUBLE_EQ` for approximate equality using ULPs.
- Use `EXPECT_NEAR(val1, val2, abs_error)` for absolute tolerance.

### 2.4 Exception Assertions
- `EXPECT_THROW(statement, exception_type)`
- `EXPECT_ANY_THROW(statement)`
- `EXPECT_NO_THROW(statement)`

Verify that code throws (or doesn't throw) exceptions as expected.

### 2.5 Predicate Assertions
Use when you need to verify complex conditions for clearer failure diagnostics.
- `EXPECT_PREDn(predicate, val1, val2, ...)`
- `EXPECT_PRED_FORMATn(pred_formatter, val1, val2, ...)`

Useful for custom predicates that produce detailed error messages.

### 2.6 Explicit Success and Failure
- Use `SUCCEED()` to document success.
- Use `FAIL()` to explicitly fail a test.

---

## 3. Matcher Fundamentals and Usage

### 3.1 Built-in Matchers
GoogleMock provides many built-in matchers to assert properties of values:
- **Generic:** `_` (wildcard), `Eq(value)`, `Ne(value)`, `Lt(value)`, etc.
- **String:** `HasSubstr()`, `StartsWith()`, `EndsWith()`, `MatchesRegex()`, `StrCaseEq()`, etc.
- **Containers:** `ElementsAre()`, `UnorderedElementsAre()`, `Contains()`, `Each()`, `SizeIs()`, `Key()`, `Pair()`, etc.
- **Pointers:** `IsNull()`, `NotNull()`, `Pointee()`

Example:
```cpp
EXPECT_CALL(mock, Foo(Ge(5), NotNull()));
EXPECT_THAT(container, Contains(HasSubstr("needle")));
```

### 3.2 Combining Matchers
- `AllOf(m1, m2, ...)` — all matchers must match
- `AnyOf(m1, m2, ...)` — at least one matcher matches
- `Not(m)` — negates matcher

Example:
```cpp
EXPECT_THAT(value, AllOf(Gt(5), Ne(10)));
EXPECT_THAT(str, Not(HasSubstr("fail")));
```

### 3.3 Matching Multiple Arguments at Once
Use `.With()` clause in `EXPECT_CALL` or argument tuple matchers.
- Use `With(multi_argument_matcher)` to match multiple arguments as a tuple.
- Use `Args<k1, k2>(matcher)` to select specific arguments.

Example:
```cpp
EXPECT_CALL(mock, Func(_, _)).With(Lt());  // first arg < second arg
EXPECT_CALL(mock, Func(_, _, _)).With(AllOf(Args<0,2>(Gt(0))));
```

### 3.4 Validating Members and Properties
- `Field(&Class::field, matcher)` — matches member variable
- `Property(&Class::method, matcher)` — matches return value of getter

You can also specify the field or property name for clearer error messages.

Example:
```cpp
EXPECT_THAT(obj, Field(&Foo::bar, Ge(3)));
EXPECT_THAT(obj, Property(&Foo::name, StartsWith("John")));
```

### 3.5 Matching Values Pointed to by Pointers
- `Pointee(matcher)` asserts that a pointer points to a value matching the matcher.
- Supports raw and smart pointers.

Example:
```cpp
EXPECT_CALL(mock, Foo(Pointee(Ge(5))));
```

### 3.6 Matching Containers & Collections
- `ElementsAre(...)` — matches container elements in order
- `UnorderedElementsAre(...)` — matches container elements ignoring order
- `ElementsAreArray()` and `UnorderedElementsAreArray()` accept arrays or vectors.
- `Contains(matcher)` — container has an element matching matcher
- `SizeIs(matcher)` — assert container size
- Use `Key()` and `Pair()` for associative containers (e.g., maps)

Example:
```cpp
EXPECT_THAT(vec, ElementsAre(1, Gt(0), _, 5));
EXPECT_THAT(map, UnorderedElementsAre(Pair("key", 10)));
```

### 3.7 Defining Custom Matchers
You can easily define custom matchers for specialized logic using `MATCHER` macros.

Basic example:
```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}
EXPECT_THAT(x, IsDivisibleBy7());
```

To provide informative failure messages, you can stream to `result_listener`:
```cpp
MATCHER(IsDivisibleBy7, "") {
  if (arg % 7 == 0) return true;
  *result_listener << "remainder " << (arg % 7);
  return false;
}
```

---

## 4. Advanced Matcher Techniques

### 4.1 Parameterized Matchers
Define matchers that accept parameters easily via `MATCHER_P`, `MATCHER_P2`, ...

Example:
```cpp
MATCHER_P(InRange, bound, "") { return arg < bound; }
EXPECT_THAT(value, InRange(10));
```

### 4.2 Composite Matchers
Use matchers as parameters to build complex matchers.

Example:
```cpp
EXPECT_THAT(x, AllOf(Gt(5), Lt(10)));
```

### 4.3 Matcher Casting
When types are compatible but not exact, use `SafeMatcherCast<T>(matcher)` to safely cast matchers.

Example:
```cpp
Matcher<int64> m = ...;
EXPECT_CALL(mock, Func(SafeMatcherCast<int>(m)));
```

### 4.4 Using Matchers as Predicates
Wrap matchers with `Matches(matcher)` to use them as standard unary predicates (e.g., with STL algorithms).

Example:
```cpp
std::count_if(vec.begin(), vec.end(), Matches(Ge(10)));
```

### 4.5 Explaining Match Results
Implement `MatchAndExplain()` in custom matchers to stream detailed success or failure messages, aiding debugging.

### 4.6 Writing New Polymorphic Matchers
Implement a class with a template `MatchAndExplain()` method and use `MakePolymorphicMatcher()` to define matchers usable with multiple types.

---

## 5. Best Practices and Tips

- **Use `ON_CALL` to set default behaviors** without enforcing call count or order constraints.
- **Use `EXPECT_CALL` to define expectations** about how and when mock methods will be called.
- For complex argument validations, prefer matchers over `EXPECT_TRUE` for clearer diagnostics.
- Avoid over-specifying expectations to keep tests maintainable and avoid brittleness.
- Use `InSequence` and `After` clauses to specify call order when needed.
- Combine `MATCHER*` macros and custom matchers to keep your test code expressive and reusable.
- Share matchers and actions by assigning them to variables to avoid repeated constructions.

---

## 6. Common Pitfalls and Troubleshooting

| Issue                                      | Solution                                                                                 |
|--------------------------------------------|------------------------------------------------------------------------------------------|
| No matcher supplied in overloaded method    | Use explicit matcher casts or `Const()` wrapper to disambiguate overloads.               |
| Unexpected method call                      | Verify if expectation missing; add catch-all matcher with `Times(AnyNumber())` if need be. |
| Too many or too few `WillOnce()` actions    | Match the number of `WillOnce()` with `Times()` or use `RetiresOnSaturation()` to retire expectations. |
| Null pointer passed to `Pointee()` matcher | Causes match failure; consider `AllOf(NotNull(), Pointee(...))` if null should be accepted. |
| Matcher side effects                        | Matchers must be pure functions without side effects.                                    |

---

## 7. Examples

### 7.1 Asserting Simple Conditions
```cpp
EXPECT_TRUE(IsValid(input)) << "Input should be valid";
EXPECT_EQ(expected, actual) << "Mismatch in calculation result";
EXPECT_THAT(str, StartsWith("Hello"));
```

### 7.2 Using Matchers with Mocks
```cpp
EXPECT_CALL(mock, ProcessData(Ge(0), NotNull()));
ON_CALL(mock, GetName()).WillByDefault(Return("default"));
EXPECT_CALL(mock, GetName()).WillOnce(Return("special"));
```

### 7.3 Validating Container Contents
```cpp
EXPECT_THAT(vec, ElementsAre(1, Gt(0), _, 5));
EXPECT_THAT(map, UnorderedElementsAre(Pair("key", 10), Pair("foo", 20)));
EXPECT_THAT(container, Contains(HasSubstr("needle")));
```

### 7.4 Writing a Custom Matcher
```cpp
MATCHER_P(InRange, bound, "") {
  return arg >= 0 && arg <= bound;
}
EXPECT_THAT(value, InRange(10));
```

### 7.5 Combining Matchers
```cpp
EXPECT_THAT(x, AllOf(Gt(5), Le(10)));
EXPECT_THAT(s, Not(HasSubstr("fail")));
```

---

## 8. Next Steps & Related Content

- Dive deeper into [Matchers Reference](/api-reference/advanced-testing/matchers) to explore all built-in matchers.
- Explore [Writing New Matchers Quickly](docs/gmock_cook_book.md#NewMatchers) for custom matcher guidance.
- Learn advanced assertions in [Assertions Reference](/api-reference/core-apis/assertions).
- Understand mock behaviors and expectations in [Mocking Reference](/api-reference/mocking/mock-expectations-actions).
- Combine matchers with `EXPECT_THAT` in practical test scenarios via [Guides](/guides/core-scenarios/assertions-matchers).

---

## References
- [GoogleTest Assertions Reference](reference/assertions.md)
- [GoogleMock Cookbook](docs/gmock_cook_book.md)
- [Matchers Reference](reference/matchers.md)
- [Mocking Reference](reference/mocking.md)

---