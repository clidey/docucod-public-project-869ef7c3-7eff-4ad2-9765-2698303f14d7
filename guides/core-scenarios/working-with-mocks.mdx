---
title: "Advanced Mocking Patterns and Expectations"
description: "Explores key patterns for using GoogleMock in sophisticated scenarios, such as controlling expectations, handling call sequences, configuring default behaviors, and leveraging NiceMock/StrictMock for robust mock management."
---

# Advanced Mocking Patterns and Expectations

## Overview

This guide explores advanced patterns for using GoogleMock to write sophisticated tests that precisely control mock behavior and expectations. You will learn how to manage call sequences, customize default behavior, use NiceMock and StrictMock wrappers, and implement robust mock management in complex scenarios.

---

## Prerequisites

- Familiarity with basic GoogleMock concepts such as defining mocks with `MOCK_METHOD`, setting expectations with `EXPECT_CALL`, and default actions using `ON_CALL`.
- A mock class defined with virtual methods to be mocked.
- Basic knowledge of matchers and actions.

---

## What You Will Achieve

By following this guide, you will:

- Control the order and frequency of expected calls using sequences and partial orders.
- Properly configure default behaviors versus expectations to reduce test brittleness.
- Suppress or enforce warnings for uninteresting calls by using `NiceMock` or `StrictMock` wrappers.
- Understand how to retire expectations for flexible matching.
- Use advanced clauses like `After()`, `RetiresOnSaturation()`, and more.

---

## Estimated Time

Approximately 15-25 minutes for practical implementation and testing.

---

## Difficulty Level

Intermediate to Advanced GoogleMock users.

---

# Step-by-Step Instructions

### 1. Controlling Call Ordering with `InSequence` and `Sequence`

GoogleMock allows you to specify that certain calls must occur in a specific order.

- To enforce strict sequential ordering, wrap your expectations within an `InSequence` block:

```cpp
using ::testing::InSequence;

{
  InSequence seq;  // All EXPECT_CALLs here form a sequence

  EXPECT_CALL(mock, Start());
  EXPECT_CALL(mock, Process());
  EXPECT_CALL(mock, Finish());
}
```

- Alternatively, create named `Sequence` objects and assign expectations to them:

```cpp
using ::testing::Sequence;
Sequence seq1, seq2;

EXPECT_CALL(mock, Initialize()).InSequence(seq1);
EXPECT_CALL(mock, Execute()).InSequence(seq1, seq2);
EXPECT_CALL(mock, Finalize()).InSequence(seq2);
```

This creates a partial order where `Initialize` must happen before `Execute`, which in turn must happen before `Finalize`.

#### Verification

If calls occur out-of-order, your test will fail with an informative message indicating which expectation failed.

---

### 2. Setting Default Behaviors with `ON_CALL`

Use `ON_CALL` to define default mock behaviors when you are not interested in strictly verifying call counts or arguments.

```cpp
using ::testing::Return;

ON_CALL(mock, Compute(_, _))
    .WillByDefault(Return(42));
```

- `ON_CALL` defines how mocks behave when called but does not imply an expectation that the call will occur.
- This helps keep tests resilient, avoiding brittleness caused by over-specification.

Tip: Avoid creating redundant `EXPECT_CALL`s for uninteresting calls to prevent noisy warnings.

---

### 3. Setting Explicit Expectations with `EXPECT_CALL`

Unlike `ON_CALL`, `EXPECT_CALL` sets both behavior and an expectation that a call occurs.

```cpp
using ::testing::Return;
using ::testing::_;

EXPECT_CALL(mock, SendData(_, _))
    .Times(3)
    .WillRepeatedly(Return(true));
```

Best Practices:

- Use `EXPECT_CALL` only when you want to verify the call.
- Use `Times(AnyNumber())` to accept multiple calls without strict limits.
- Use matchers like `_` to allow any argument when argument values are not crucial to the test.

---

### 4. Controlling Uninteresting Calls: `NiceMock`, `NaggyMock`, and `StrictMock`

GoogleMock allows you to tailor the handling of calls to mock methods without explicit expectations.

- **NaggyMock** (default behavior): Prints warnings for uninteresting calls.
  ```cpp
  NaggyMock<MockFoo> mock_foo;
  EXPECT_CALL(mock_foo, DoThis());
  // Warning on other un-expected calls
  ```

- **NiceMock**: Suppresses warnings for uninteresting calls.
  ```cpp
  NiceMock<MockFoo> mock_foo;
  EXPECT_CALL(mock_foo, DoThis());  // No warnings on other calls
  ```

- **StrictMock**: Treats uninteresting calls as errors (fails test).
  ```cpp
  StrictMock<MockFoo> mock_foo;
  EXPECT_CALL(mock_foo, DoThis());  // Fails if other calls occur
  ```

---

### 5. Using `RetiresOnSaturation()` to Manage Sticky Expectations

By default, expectations in GoogleMock remain active ("sticky") even after the expected number of calls have been met, causing new calls that match to fail.

To avoid this,

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .RetiresOnSaturation();

EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(3))
    .RetiresOnSaturation();
```

- Each expectation retires (becomes inactive) once saturated, allowing the next expectation to handle calls.
- This is especially useful when defining sequences or multiple actions for the same method.

---

### 6. Combining `After()` with Expectations for Partial Ordering

You can specify that an expectation should only occur after other expectations have been satisfied.

```cpp
using ::testing::Expectation;

Expectation init = EXPECT_CALL(mock, Initialize());
EXPECT_CALL(mock, Run()).After(init);
```

You can chain multiple prerequisites or use `ExpectationSet` to specify multiple dependencies:

```cpp
ExpectationSet all_inits;
all_inits += EXPECT_CALL(mock, InitA());
all_inits += EXPECT_CALL(mock, InitB());
EXPECT_CALL(mock, Run()).After(all_inits);
```

---

### 7. Tips and Common Pitfalls

- **Avoid overusing `EXPECT_CALL`**: Use `ON_CALL` to set default behavior and only expect calls you explicitly want to verify.
- **Order matters**: Later `EXPECT_CALL`s override earlier ones; use sequences or `RetiresOnSaturation` to clarify expectations.
- **Avoid nesting `NiceMock`, `StrictMock`, or `NaggyMock` within each other**, as it’s not supported.
- **Suppress warnings with `NiceMock` only when sure uninteresting calls are acceptable**.
- **If expecting calls with complex or variable arguments, consider using matchers like `_` or custom matchers for flexibility.**

---

### 8. Verifying and Forcing Verification

- GoogleMock automatically verifies expectations upon destruction of the mock object.
- To force verification earlier (e.g., when mock object lifetime is complex), call:

```cpp
using ::testing::Mock;

Mock::VerifyAndClearExpectations(&mock_object);
```

Be cautious not to set new expectations after verification.

---

# Examples

### Example: Using `NiceMock` to suppress uninteresting call warnings

```cpp
#include <gmock/gmock.h>
using ::testing::NiceMock;

class MockDatabase {
 public:
  MOCK_METHOD(void, Connect, (), ());
  MOCK_METHOD(void, Disconnect, (), ());
  MOCK_METHOD(int, Query, (const std::string& sql), ());
};

TEST(DatabaseTest, QueryReturnsExpectedValue) {
  NiceMock<MockDatabase> mock_db;

  ON_CALL(mock_db, Query).WillByDefault(testing::Return(42));

  EXPECT_CALL(mock_db, Connect());

  mock_db.Connect();  // Expected call
  mock_db.Query("SELECT *");  // Uninteresting call but no warning
}
```

### Example: Sequencing and Retiring Expectations

```cpp
using ::testing::InSequence;
using ::testing::Return;

class MockService {
 public:
  MOCK_METHOD(void, Start, (), ());
  MOCK_METHOD(int, Process, (), ());
  MOCK_METHOD(void, Stop, (), ());
};

TEST(ServiceTest, ProcessesInSequence) {
  MockService mock_service;

  {
    InSequence seq;

    EXPECT_CALL(mock_service, Start()).Times(1);
    EXPECT_CALL(mock_service, Process()).WillOnce(Return(1)).RetiresOnSaturation();
    EXPECT_CALL(mock_service, Process()).WillOnce(Return(2)).RetiresOnSaturation();
    EXPECT_CALL(mock_service, Stop()).Times(1);
  }

  mock_service.Start();
  EXPECT_EQ(1, mock_service.Process());
  EXPECT_EQ(2, mock_service.Process());
  mock_service.Stop();
}
```

---

# Troubleshooting & Tips

### Unwanted Warnings About Uninteresting Calls

- Use `NiceMock` to silence uninteresting call warnings in tests that use mocks extensively without tracking every method.

- Alternatively, add a catch-all expectation:

```cpp
EXPECT_CALL(mock, SomeMethod(_)).Times(testing::AnyNumber());
```

### Test Fails Due to Excessive Calls

- Ensure the `Times()` cardinality matches actual calls.
- Use `.RetiresOnSaturation()` to release sticky expectations.

### Unexpected Call Errors

- Verify that all calls that happen have matching `EXPECT_CALL` statements.
- Use `ON_CALL` to specify default behavior where verification is not necessary.

---

# Next Steps & Related Content

- Learn to write custom matchers for complex argument validation ([Matchers Reference](reference/matchers.md)).
- Explore advanced actions to perform side effects or compute return values ([Actions Reference](actions.md)).
- Study parameterized tests to run tests with multiple datasets ([Parameterized Tests Guide](guides/core-scenarios/parameterized-tests)).
- Refer to the [Mocking Reference](docs/reference/mocking.md) for comprehensive API details.
- Review [gMock Cookbook](docs/gmock_cook_book.md) for practical recipes.

---

# Additional Resources

- [gMock for Dummies](docs/gmock_for_dummies.md) — beginner-friendly introduction.
- [Nice, Naggy, and Strict Mocks](docs/gmock_cook_book.md#NiceStrictNaggy) — detailed explanations and recommended use.
- [Controlling Expectation Order](docs/gmock_cook_book.md#OrderedCalls) — managing sequences and partial orders.
- [Troubleshooting Common Mock Failures](getting-started/first-steps-validation/troubleshooting.mdx)

---

# Summary
This guide empowers you to leverage GoogleMock's powerful mocking features to create resilient, clear, and maintainable tests. You will master advanced expectation controls, call sequencing, behavior defaults, and mock strictness levels, ensuring your tests precisely express your intent while avoiding common pitfalls.

---

# References

- [GoogleMock MOCK_METHOD Macro](docs/reference/mocking.md#MOCK_METHOD)
- [GoogleMock EXPECT_CALL Syntax](docs/reference/mocking.md#EXPECT_CALL)
- [GoogleMock ON_CALL for Default Behavior](docs/reference/mocking.md#ON_CALL)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md)
- [Nice, Strict, and Naggy Mocks](docs/gmock_cook_book.md#NiceStrictNaggy)

---