---
title: "Mocking with GoogleMock: Basics and Patterns"
description: "Walks users through the basics of mocking, setting expectations, and defining behaviors with GoogleMock. Introduces patterns for isolating units, using ON_CALL/EXPECT_CALL, common matcher utilities, and handling uninteresting calls."
---

# Mocking with GoogleMock: Basics and Patterns

## Overview

This guide walks you through the basics of using GoogleMock to create mock objects, set expectations, and define behaviors for unit testing in C++. You'll learn key patterns to isolate units of code, use `ON_CALL` and `EXPECT_CALL` to configure mock behavior, apply matchers for argument validation, and handle uninteresting and unexpected calls. This page focuses specifically on mocking concepts and practical workflows rather than the entire GoogleTest framework.

---

## What You Will Learn

- How to define mock classes using the `MOCK_METHOD` macro
- Setting default behaviors with `ON_CALL`
- Setting precise expectations with `EXPECT_CALL`
- Using sequences and ordering constraints to control call order
- Common matcher utilities to specify argument conditions
- Handling uninteresting and unexpected calls gracefully
- Using Nice, Naggy, and Strict mocks to control warning and error behaviors

---

## Prerequisites

- Familiarity with C++ virtual functions and interfaces
- Basic knowledge of unit testing concepts
- GoogleTest and GoogleMock libraries properly installed and integrated

---

## Time Estimate

30-45 minutes

---

## Difficulty Level

Intermediate - Basic knowledge of C++ and unit testing is assumed

---

# Getting Started with Mocking

### 1. Define Your Mock Class

To use GoogleMock, create a mock class that inherits from the interface or base class you want to mock. Use the `MOCK_METHOD` macro inside the public section of your mock class to define mock methods that override virtual methods.

Example:

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int Compute(int x) = 0;
  virtual void Reset() = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));
  MOCK_METHOD(void, Reset, (), (override));
};
```

**Important:**

- `MOCK_METHOD` must be in the `public:` section regardless of the base method's access level.
- For const, noexcept, or reference-qualified methods, add the appropriate specifiers (e.g., `(const, override)`).
- For methods with argument types containing commas (e.g., templates), wrap the type in parentheses or use type aliases.

---

### 2. Create Mock Objects

Instantiate your mock class objects as needed in your test code.

```cpp
MockFoo foo;
```

Alternatively, use wrapper classes to control mock strictness:

- `NiceMock<MockFoo>`: suppress warnings about uninteresting calls.
- `NaggyMock<MockFoo>`: (default) prints warnings on uninteresting calls.
- `StrictMock<MockFoo>`: treats uninteresting calls as test failures.

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_foo;
```

---

### 3. Set Default Behaviors with ON_CALL

`ON_CALL` specifies what a mock method should do by default when called without a matching `EXPECT_CALL`. It does **not** set an expectation that the method will be called.

```cpp
ON_CALL(foo, Compute(_))
    .WillByDefault(::testing::Return(42));  // Return 42 for any Compute call.
```

Use `ON_CALL` to provide safe defaults so your code under test can operate without failing on unexpected calls.

---

### 4. Set Expectations with EXPECT_CALL

`EXPECT_CALL` defines how you expect your mocks to be called during the test execution and optionally what they should return or do.

#### Basic form:

```cpp
EXPECT_CALL(foo, Compute(::testing::Gt(0)))
    .Times(2)                          // Expect exactly 2 calls with arg > 0
    .WillOnce(::testing::Return(10))  // Return 10 on first call
    .WillOnce(::testing::Return(20)); // Return 20 on second call
```

#### Important Modifiers (in this order):

- `.With(matcher)`: match argument tuples as a whole
- `.Times(cardinality)`: specify how many times the method should be called
- `.InSequence(seq1, seq2, ...)`: constrain call order relative to sequences
- `.After(expectation1, expectationSet2, ...)`: ensure call happens after these expectations
- `.WillOnce(action)`: define an action for matching calls (called in order)
- `.WillRepeatedly(action)`: define action for calls after `WillOnce`s are consumed
- `.RetiresOnSaturation()`: retire the expectation once its call count is satisfied

#### Note on Usage Order:

Clauses must be chained in the specified order; misuse will cause errors.

---

### 5. Matcher Utilities

Argument matchers allow flexible specification of expected call arguments.

- `_` matches any value
- `Eq(val)` matches equality
- `Ge(val)`, `Gt(val)`, `Le(val)`, `Lt(val)` match comparison
- `Not(matcher)`, `AllOf(m1, m2)`, `AnyOf(m1, m2)` for logical combinations
- `Pointee(matcher)`: match the value pointed to by a pointer
- `Field(&Class::member, matcher)`: match member variable
- `Property(&Class::property, matcher)`: match method result (const, no args)

Example:

```cpp
EXPECT_CALL(foo, Compute(::testing::AllOf(::testing::Gt(5), ::testing::Le(10))));
```

You can also define custom matchers for domain-specific needs.

---

### 6. Controlling Call Order

By default, calls may occur in any order. To constrain ordering:

**a) `InSequence` object**

Wrap expectations in a `{ InSequence s; ... }` block to require sequential order.

```cpp
{
  ::testing::InSequence s;
  EXPECT_CALL(foo, Compute(1));
  EXPECT_CALL(foo, Compute(2));
}
```

**b) Partial order with `Sequence` and `.InSequence(...)`**

Declare `Sequence` objects and assign expectations to multiple sequences to define partial orders.

**c) `.After(...)` clause**

Specify that one expectation must occur after one or more others.

---

### 7. Handling Uninteresting and Unexpected Calls

- An **uninteresting call** is a call to a method without any `EXPECT_CALL` expectations.
  - By default, GoogleMock will perform the default action and print a warning.

- An **unexpected call** is a call that does not match any existing active expectation.
  - This results in a test failure.

Use `NiceMock` to suppress uninteresting call warnings, or `StrictMock` to treat them as failures.

**To avoid unexpected call failures:**

- Add catch-all expectations with `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` if you want to allow calls with any arguments.

---

### 8. Retiring Expectations

Use `.RetiresOnSaturation()` to make an expectation stop matching calls once its allowed number of calls is reached.

This is useful when you want to define fallback expectations that take over afterward.

---

### 9. Examples

#### Defining a Mock Class

```cpp
class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(int, Query, (const std::string& query), (override));
  MOCK_METHOD(void, Disconnect, (), (override));
};
```

#### Setting Default Behavior

```cpp
MockDatabase db;
ON_CALL(db, Connect(::testing::_))
    .WillByDefault(::testing::Return(true));
```

#### Expecting a Specific Call

```cpp
EXPECT_CALL(db, Query(::testing::HasSubstr("SELECT * FROM users")))
    .Times(1)
    .WillOnce(::testing::Return(42));
```

#### Using a Sequence to Order Calls

```cpp
using ::testing::InSequence;
{
  InSequence s;

  EXPECT_CALL(db, Connect(::testing::_));
  EXPECT_CALL(db, Query(::testing::_));
  EXPECT_CALL(db, Disconnect());
}
```

#### Allowing Other Calls Without Warnings

```cpp
EXPECT_CALL(db, Query(::testing::_)).Times(::testing::AnyNumber());
```

#### Using NiceMock to Suppress Warnings

```cpp
using ::testing::NiceMock;
NiceMock<MockDatabase> nice_db;
EXPECT_CALL(nice_db, Connect(::testing::_));
// Uninteresting calls to other methods will not warn.
```

---

## Tips & Best Practices

- Use `ON_CALL` for default behavior; reserve `EXPECT_CALL` for calls you want to verify.
- Prefer to order expectations explicitly only when call order matters; otherwise keep tests flexible.
- Keep most expectations non-strict (`NiceMock`) to reduce brittleness.
- Add catch-all expectations with `Times(AnyNumber())` for methods called in many places with different arguments.
- Use matchers to specify only the arguments you care about; use `_` to ignore.
- Use `.RetiresOnSaturation()` to avoid expectations being sticky when ordering multiple expectations on the same call.
- Always mock virtual methods, never non-virtual unless using advanced dependency injection patterns.
- Use `Mock::AllowLeak()` cautiously to avoid false negatives on expectation verification caused by leaked mocks.

---

## Troubleshooting Common Issues

### Unexpected Calls

If your test fails due to unexpected mock function calls:

- Verify you have `EXPECT_CALL` for those calls.
- Add catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` if calls with other args are expected.

### Uninteresting Calls

- Warnings during tests may indicate missing `EXPECT_CALL` or unnecessarily strict mocks. Try using `NiceMock`.

### Saturated Expectations

- If too many calls happen to the same expectation, either increase `.Times()` or add `.RetiresOnSaturation()` and define fallback expectations.

### Mock Method Not Called

- Ensure your code under test actually calls the mock methods, and that expectations are set before exercising the code.

### Ordering Failures

- Use `InSequence` or `After()` carefully to define proper order requirements.

---

## Next Steps & Related Content

- Explore the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced usage patterns.
- Consult the [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) to deepen understanding of argument matching.
- Learn more about mock expectations in the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html).
- Move to [Effective Use of Matchers & Actions](https://google.github.io/googletest/guides/advanced-and-real-world/effective-use-matchers-actions.html) for advanced behavior customization.

---

## References

- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [gMock CookBook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)

---

## Example: Full Mock & Test Snippet

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int Bar(int a) = 0;
  virtual void Baz() = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Bar, (int a), (override));
  MOCK_METHOD(void, Baz, (), (override));
};

TEST(FooTest, BasicTest) {
  MockFoo mock;

  // Setup default behavior
  ON_CALL(mock, Bar(::testing::_))
      .WillByDefault(::testing::Return(0));

  // Expect Bar(5) to be called once and return 10.
  EXPECT_CALL(mock, Bar(5))
      .Times(1)
      .WillOnce(::testing::Return(10));

  // Allow any Baz() calls, ignoring warnings
  EXPECT_CALL(mock, Baz()).Times(::testing::AnyNumber());

  EXPECT_EQ(mock.Bar(5), 10);  // Matches expectation
  EXPECT_EQ(mock.Bar(1), 0);   // Takes default action
}
```
