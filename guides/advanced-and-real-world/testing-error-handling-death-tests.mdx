---
title: "Testing Error Handling with Death Tests"
description: "Learn how to leverage death tests for verifying program termination on fatal errors. Understand best practices, platform limitations, and scenarios that benefit from death test coverage."
---

# Testing Error Handling with Death Tests

## Workflow Overview

### What This Guide Helps You Achieve
This guide teaches you how to use GoogleTest's **death tests** feature to verify that your code terminates properly under fatal error conditions. By following it, you will gain the ability to write tests that ensure your program aborts or exits as expected when encountering critical failures, such as invalid inputs, assertion failures, or fatal runtime errors.

### Prerequisites
- A working GoogleTest environment with death test support enabled (typically on Unix-like systems and Windows).
- Basic knowledge of writing GoogleTest test cases.
- Understanding of process termination concepts (exit codes, signals).

### Expected Outcome
Clients following this guide will be able to:
- Write and run death tests using `ASSERT_DEATH`, `EXPECT_DEATH`, `ASSERT_EXIT`, and `EXPECT_EXIT` macros.
- Understand the impact of death test styles (`fast` vs `threadsafe`) and how to configure them.
- Recognize platform limitations and best practices when writing death tests.
- Debug common pitfalls like multiple threads or unexpected failures within death tests.

### Estimated Time
About 15-20 minutes to read through the guide and write a few death tests.

### Difficulty Level
Intermediate. Writing death tests involves understanding test subprocesses and careful error message matching.

---

## Writing Death Tests: Step-by-Step

GoogleTest provides specialized macros to test program termination behavior. These tests run the code you want to evaluate in a child process, observing whether it crashes or exits as expected.

### 1. Choose the Right Macro

| Macro            | Usage Summary                                                |
|------------------|--------------------------------------------------------------|
| `ASSERT_DEATH`   | Requires the statement to cause death with matching stderr output; aborts current test on failure.
|
| `EXPECT_DEATH`   | Same as `ASSERT_DEATH` but continues running subsequent tests on failure.
|
| `ASSERT_EXIT`    | Tests exit with exit status matching a predicate and stderr output matching a regex; aborts on failure.
|
| `EXPECT_EXIT`    | Same as `ASSERT_EXIT` but continues after failure.
|
| `EXPECT_DEATH_IF_SUPPORTED` / `ASSERT_DEATH_IF_SUPPORTED` | Only runs death test if supported on the platform; otherwise, warns and does nothing.
|
| `EXPECT_DEBUG_DEATH` / `ASSERT_DEBUG_DEATH` | Runs death tests only in debug builds.

### 2. Write the Death Test Statement

- The statement can be any block or expression causing process termination.
- Example of verifying an assertion aborting:

```cpp
ASSERT_DEATH({ func_that_should_die(); }, "Expected error message regex");
```

- For exit code testing, use `ASSERT_EXIT` with a predicate like:

```cpp
EXPECT_EXIT({ exit(42); }, testing::ExitedWithCode(42), "exiting");
```

### 3. Provide an Error Matcher

- Specify a regex or matcher that should match the standard error output generated when the process dies.
- On POSIX, POSIX extended regex syntax is supported; on Windows, a simplified regex subset is supported.
- Use a string literal for a regex, or GoogleMock matchers for advanced assertions:

```cpp
ASSERT_DEATH(func(), testing::ContainsRegex("error code 123"));
```

### 4. Configure Death Test Style (Optional)

- The default style is either `fast` or `threadsafe` (often `fast` by default).
- Set via flag or programmatically:

```cpp
GTEST_FLAG_SET(death_test_style, "threadsafe");
```

- **Fast Style**: Quickly forks and runs test code.
- **Threadsafe Style**: Re-executes the entire binary in a subprocess to isolate death tests, safer in multithreaded programs but slower.

### 5. Run and Evaluate Tests

- Each death test runs in a subprocess. GoogleTest waits for the subprocess to terminate, compares exit codes and stderr output.
- Tests pass if the subprocess dies as expected.
- Tests fail if the subprocess returns normally, returns an unexpected exit code, or if stderr output doesnâ€™t match.

### 6. Best Practices

- Name test suites containing death tests with the suffix `DeathTest` to ensure they run early.
- Avoid using multiple threads at death test time; GoogleTest will warn if multiple threads are running when forking.
- Do not perform side-effects in death tests expecting to observe them after test termination.
- For tests with mocks, explicitly allow mock leaks with `Mock::AllowLeak` because the child process terminates abruptly.
- Avoid putting multiple death tests on the same source line.
- Avoid `return` or exceptions in death test blocks; GoogleTest treats these as failures.

---

## Practical Examples

### Example 1: Basic ASSERT_DEATH

```cpp
TEST(MyDeathTest, FailsOnInvalidInput) {
  ASSERT_DEATH({ ValidateInput(-1); }, "Invalid input detected");
}
```

### Example 2: Checking Exit Code with EXPECT_EXIT

```cpp
TEST(MyDeathTest, ExitsWithZeroOnSuccess) {
  EXPECT_EXIT({ RunAndExit(); }, testing::ExitedWithCode(0), "Completed successfully");
}
```

### Example 3: Using a Custom Matcher

```cpp
using ::testing::MatchesRegex;

TEST(MyDeathTest, ReportsSpecificError) {
  EXPECT_DEATH({ TriggerError(); }, MatchesRegex("fatal error #123"));
}
```

### Example 4: EXPECT_DEATH in a Loop with Traces

```cpp
for (int i = 0; i < 10; ++i) {
  SCOPED_TRACE(testing::Message() << "iteration " << i);
  EXPECT_DEATH(ProcessRequest(i), "Invalid request");
}
```

---

## Troubleshooting & Tips

### Common Issues

**Death Test Fails Because Process Does Not Die:**
- Check the code inside the death test statement actually terminates the process.
- Remember side effects won't be visible since death test runs in a subprocess.

**Error Message Mismatch:**
- Confirm the stderr output matches the exact regex or matcher.
- Use broader regex patterns if necessary.

**Multiple Threads Warning:**
- Death tests fork in single-threaded context; running in multithreaded code risks deadlocks.
- Use the `threadsafe` style if threads cannot be avoided.

**Multiple Death Tests On One Line:**
- Break them into separate lines to avoid compilation errors.

**Death Test Style Unknown or Invalid:**
- Make sure `--gtest_death_test_style` is set to either `fast` or `threadsafe`.

### Tips for Success

- Use `EXPECT_DEATH_IF_SUPPORTED` when writing platform-portable death tests.
- Utilize `SCOPED_TRACE` to aid debugging failures in loops or subroutines.
- Use `ASSERT_DEATH` when failure should abort the current test immediately.
- Use `EXPECT_DEATH` when you want the test run to continue after failure.

---

## Next Steps & Related Content

- Explore the [Death Tests API Reference](/api-reference/core-testing-apis/death-tests) for detailed macro documentation.
- Review [Effective Use of Assertions and Matchers](/guides/core-testing-workflows/using-assertions-matchers) for improving test expressiveness.
- Learn about [Advanced Test Structures](/guides/core-testing-workflows/advanced-test-structures) to extend testing capabilities.
- Understand [Death Tests and Threads](../overview/product-intro-value/what-is-googletest.md#death-tests-and-threads) to effectively manage threading concerns.

---

For detailed syntax and usage, see the [GoogleTest Death Tests Header](https://github.com/google/googletest/blob/main/googletest/include/gtest/gtest-death-test.h) and the [implementation source](https://github.com/google/googletest/blob/main/googletest/src/gtest-death-test.cc).

