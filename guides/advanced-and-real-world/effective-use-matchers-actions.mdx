---
title: "Effective Use of Matchers & Actions"
description: "Presents practical approaches to leveraging GoogleTest and GoogleMock's matcher and action infrastructure for robust, expressive testing. Focuses on advanced usage, composing matchers, and writing custom matchers for complex scenarios."
---

# Effective Use of Matchers & Actions

This guide focuses exclusively on advanced usage patterns for **GoogleMock**'s matcher and action infrastructure. It is designed to empower C++ developers to write more expressive, robust, and maintainable tests by mastering the composition of matchers and creation of custom actions for complex testing scenarios.

---

## 1. Workflow Overview

### Task Description
Learn how to leverage GoogleMock's matchers and actions beyond the basics by combining matchers, defining custom matchers, and crafting sophisticated actions. This allows you to validate intricate argument properties and control mock method behaviors precisely.

### Prerequisites
- Basic understanding of writing mocks with GoogleMock.
- Familiarity with `EXPECT_CALL` and simple matchers (`_`, `Eq`, etc.).
- GoogleMock included in your project (`#include <gmock/gmock.h>`) and operational.

### Expected Outcome
- Confident use of built-in complex matchers and matchers composition.
- Ability to define custom matchers suited for domain-specific logic.
- Mastery of the rich set of built-in actions and how to define new, custom actions.
- Improved test reliability and expressiveness.

### Time Estimate
Approximately 30–45 minutes to read, understand examples, and try out techniques in your test code.

### Difficulty Level
Intermediate to Advanced.

---

## 2. Composing Matchers

Matchers in GoogleMock are predicates on mock function arguments used to assert expected values. Beyond simple matchers, you can compose complex validation logic.

### 2.1 Basic Composition
GoogleMock offers combinators like `AllOf()`, `AnyOf()`, and `Not()` to logically combine matchers:

```cpp
EXPECT_CALL(mock, Foo(AllOf(Gt(5), Lt(10)))); // Argument > 5 and < 10
EXPECT_CALL(mock, Bar(AnyOf(Eq("foo"), Eq("bar")))); // "foo" or "bar"
EXPECT_CALL(mock, Baz(Not(Eq(0)))); // Not equal to zero
```

### 2.2 Member Validation with `Field` and `Property`
Validate object properties or member fields directly:

```cpp
EXPECT_CALL(mock, Process(Field(&MyType::status, Eq(kOk))));
EXPECT_CALL(mock, Process(Property(&MyType::GetResult, Gt(0))));
```

Use these for deeper inspection of complex argument types without exposing internals explicitly.

### 2.3 Pointer Indirection with `Pointee`
Verify properties of data pointed to by raw or smart pointers:

```cpp
EXPECT_CALL(mock, Handle(Pointee(Ge(5))));
```

This ensures the pointed-to value meets the predicate, safely handling null pointers by failing the match.

### 2.4 Safe Type-Casting for Matchers
Sometimes your matcher type doesn't exactly match the argument type. Use `SafeMatcherCast<T>()` to safely coerce the matcher without breaking type correctness:

```cpp
MATCHER_P(MyMatcher, value, "") { return arg > value; }
EXPECT_CALL(mock, Func(SafeMatcherCast<int>(MyMatcher(5))));
```

---

## 3. Writing Custom Matchers

When built-in matchers are insufficient, define your own matcher to encode domain-specific logic.

### 3.1 Using `MATCHER` and `MATCHER_P` Macros
Write custom matchers quickly:

```cpp
MATCHER(IsEven, "checks if the number is even") {
  return (arg % 2) == 0;
}

MATCHER_P(IsSum, expected_sum, "checks if sum of bar() and baz() equals expected") {
  return arg.bar() + arg.baz() == expected_sum;
}

EXPECT_CALL(mock, Foo(IsEven()));
EXPECT_CALL(mock, Foo(IsSum(10)));
```

### 3.2 Implementing Matcher Classes
For more control and polymorphism, implement matcher classes with `MatchAndExplain()`, `DescribeTo()`, and `DescribeNegationTo()` methods:

```cpp
class DivisibleByThreeMatcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    if (n % 3 == 0)
      return true;
    if (os != nullptr) *os << "which has remainder " << (n % 3);
    return false;
  }

  void DescribeTo(std::ostream* os) const { *os << "is divisible by 3"; }

  void DescribeNegationTo(std::ostream* os) const { *os << "is not divisible by 3"; }
};

::testing::Matcher<int> DivisibleByThree() {
  return ::testing::MakeMatcher(new DivisibleByThreeMatcher);
}

EXPECT_CALL(mock, Func(DivisibleByThree()));
```

---

## 4. Using Actions to Control Mock Behavior

Actions specify what occurs when a mock function is called: return values, side effects, or invocation of other functions.

### 4.1 Built-in Actions
Refer to [Actions Reference](reference/actions.md) for complete details, but commonly used include:

- `Return(value)`: Returns a copy of `value` (converted at *expectation* time).
- `ReturnRef(variable)`: Returns a reference to `variable`.
- `ReturnPointee(pointer)`: Returns value pointed to by `pointer` *at invocation time*.
- `SetArgPointee<N>(value)`: Sets the `N`th argument's pointee to `value`.
- `DoAll(action1, action2, ...)`: Performs `action1`, then `action2`, ... returns last.
- `Invoke(function)`: Calls a free function, lambda or functor with mock arguments.
- `InvokeWithoutArgs(function)`: Calls a nullary function regardless of mock args.
- `IgnoreResult(action)`: Calls `action`, ignoring its return value.
- `InvokeArgument<N>(args...)`: Invokes the `N`th argument of the mock function with supplied arguments.

Example:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));

EXPECT_CALL(mock, Bar())
    .WillOnce(InvokeWithoutArgs(DoSomeWork));
```

### 4.2 Using `DoAll` to Chain Multiple Actions
When you want to perform side effects (like setting output parameters) alongside returning a value:

```cpp
EXPECT_CALL(mock, FillBuffer(_))
    .WillOnce(DoAll(SetArrayArgument<0>(begin_data, end_data), Return(true)));
```

Note: The last action determines the return value. Earlier ones must return `void`.

### 4.3 Returning Move-Only Types
GoogleMock fully supports methods that return or accept move-only types like `std::unique_ptr<T>`:

```cpp
EXPECT_CALL(mock, MakeResource())
    .WillOnce(Return(std::make_unique<Resource>()));
```

For returning move-only objects repeatedly, use a lambda instead:

```cpp
EXPECT_CALL(mock, MakeResource())
    .WillRepeatedly([]() {
      return std::make_unique<Resource>();
    });
```

### 4.4 Defining Custom Actions
Beyond built-in actions and lambdas, define actions by implementing `ActionInterface<F>` for a given function type:

```cpp
template <typename F>
class MyAction : public ::testing::ActionInterface<F> {
 public:
  typename ::testing::internal::Function<F>::Result
      Perform(const typename ::testing::internal::Function<F>::ArgumentTuple& args) override {
    // Implement your action here, using std::get to get args...
  }
};
```

Use `MakeAction(new MyAction<F>())` to create an `Action<F>`.

Alternatively, use `MakePolymorphicAction` for polymorphic actions callable with different signatures.

### 4.5 Selecting Arguments for Actions
When your action accepts fewer arguments than the mock method, use:

- `WithArg<N>(action)`: Passes the `N`th argument only.
- `WithArgs<N1, N2, ...>(action)`: Passes selected arguments.
- `WithoutArgs(action)`: Calls action with no arguments.

Example:

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(WithArg<1>(Invoke(MyFunc)));
```

### 4.6 Returning From Reference or Value
- Use `ReturnRef(var)` to return a reference to `var`.
- Use `ReturnRefOfCopy(val)` to return a reference to a stored copy.
- Use `ReturnRoundRobin({a,b,c})` to cycle through return values.

### 4.7 Setting Errno and Returning
Use `SetErrnoAndReturn(error, value)` to mimic system call behaviors.

### 4.8 Common Pitfalls
- Avoid using `Return(std::move(...))` with `WillRepeatedly`, as it moves only once.
- `DoDefault()` can’t be used inside composite actions.
- When using `SetArgPointee`, remember it copies the supplied value.

---

## 5. Practical Tips & Troubleshooting

- **Default Actions and Behavior**: When no action is defined via `EXPECT_CALL`, the mock will use default behavior (zero, false, default-constructed value).
- **Order of Actions in `EXPECT_CALL`**: Later `WillOnce()` clauses override earlier. Be mindful of `.Times()` and `.RetiresOnSaturation()` to avoid unexpected failures.
- **Suppressing Uninteresting Call Warnings**: Use `NiceMock<T>` for ignoring uninteresting calls, or add `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())`.
- **Verifying and Clearing Expectations**: Use `Mock::VerifyAndClearExpectations(&mock)` to explicitly verify and reset mocks.
- **Thread Safety**: Ensure expectations are set before mock function is called; gMock internally handles synchronization during calls.

### Troubleshooting Common Scenarios
- **Unexpected Call Failures**: Verify that all expected calls are set before invoking mock methods.
- **Too Many or Too Few Actions**: Check the match between number of `WillOnce` calls and `Times` cardinality.
- **Compilation Errors with Complex Matchers**: Use `SafeMatcherCast<T>()` or simplify matcher expressions.
- **Move-only Argument Issues**: Avoid built-in actions that copy arguments (like `DoAll`); prefer lambdas.

---

## 6. Examples

### Example 1: Complex Matcher Composition
```cpp
EXPECT_CALL(mock, Process(
    AllOf(
      Field(&Data::id, Eq(42)),
      Field(&Data::name, StartsWith("Test")),
      Pointee(Ge(10)))))
    .WillOnce(Return(true));
```

### Example 2: Custom Matcher with Additional Explanation
```cpp
MATCHER_P(IsPrime, /* unused */, "checks if number is prime") {
  if (arg < 2) return false;
  for (int i = 2; i * i <= arg; i++) {
    if (arg % i == 0) {
      *result_listener << "divisible by " << i;
      return false;
    }
  }
  return true;
}
```

### Example 3: Returning Different Values per Call
```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### Example 4: Defining a Custom Action
```cpp
class MultiplyByAction : public ::testing::ActionInterface<int(int)> {
 public:
  explicit MultiplyByAction(int factor) : factor_(factor) {}

  int Perform(const std::tuple<int>& args) override {
    return std::get<0>(args) * factor_;
  }

 private:
  int factor_;
};

::testing::Action<int(int)> MultiplyBy(int factor) {
  return ::testing::MakeAction(new MultiplyByAction(factor));
}

EXPECT_CALL(mock, Compute(_)).WillOnce(MultiplyBy(5));
```

### Example 5: Using `InvokeArgument` to Call a Callback Argument
```cpp
EXPECT_CALL(mock, RegisterCallback(_))
    .WillOnce(InvokeArgument<0>(42)); // Calls the first argument (a callable) with 42.
```

---

## 7. Next Steps & Related Documentation

- **GoogleTest Primer**: For foundational setup and basic test writing.
- **Matchers Reference**: [Matchers API docs](reference/matcher-apis.md) for comprehensive matcher details.
- **Actions Reference**: [Actions API docs](reference/actions.md) for full action list.
- **Guides on Mocking Basics & Patterns**: To reinforce mock class designs and expectations.
- **Parameterized and Typed Tests**: For advanced test data coverage.

Explore these to deepen mastery over GoogleTest and GoogleMock testing infrastructure.

---

## Additional Tips

<Tip>
Always balance between matcher expressiveness and test clarity. Overly complex matchers may obfuscate test intent.
</Tip>

<Tip>
Reuse matchers and actions by assigning them to variables to avoid duplication and simplify maintenance.
</Tip>

<Tip>
Use `--gmock_verbose=info` while debugging to get detailed diagnostic info about matcher fitting and expectations.
</Tip>

---

## References and Resources

- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](reference/actions.md)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Mocking Reference](docs/reference/mocking.md)
- [gMock FAQ](docs/gmock_faq.md)

---

**Note:** Use the `MOCK_METHOD` macro in your mock classes to define methods that will utilize the advanced matcher and action features outlined above.

---

This guide will equip you with the tools to write highly readable and maintainable interaction-based tests with GoogleMock, utilizing matchers and actions to their fullest potential.