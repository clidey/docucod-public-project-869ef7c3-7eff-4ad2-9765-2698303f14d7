---
title: "Creating and Using Mocks"
description: "Introduction to GoogleMock's core mocking capabilities, including defining mock classes, using EXPECT_CALL/ON_CALL, and verifying interactions. Includes a simple example to reinforce fundamental mocking concepts."
---

# Creating and Using Mocks

## Introduction

This guide introduces you to the core mocking capabilities provided by GoogleMock. You will learn how to define mock classes, specify method behaviors and expectations using the `EXPECT_CALL` and `ON_CALL` macros, and verify interactions in tests. A simple step-by-step example will reinforce fundamental mocking concepts.

---

## 1. Understanding the Mocking Workflow

### What This Guide Helps You Accomplish
Learn how to create and use mock objects in your C++ tests with GoogleMock, allowing you to:

- Define mock classes with mocked methods.
- Set expectations on method calls using `EXPECT_CALL`.
- Specify default behaviors using `ON_CALL`.
- Verify that your tested code interacts correctly with mocks.

### Prerequisites
- A working GoogleTest and GoogleMock environment.
- Basic knowledge of C++ and test writing.
- Familiarity with interfaces or classes with virtual methods.

### Expected Outcome
By following this guide, you will:
- Know how to define mock classes using the `MOCK_METHOD` macro.
- Understand how to set method call expectations and default behaviors.
- Be able to verify interactions and handle common test scenarios.

### Time Estimate
Approximately 15-20 minutes.

### Difficulty Level
Beginner to Intermediate.

---

## 2. Defining a Mock Class

Mock classes imitate interfaces or base classes to enable behavior verification without requiring the original implementation.

### Step 1: Derive Your Mock Class
Create a subclass of the interface or base class you want to mock.

### Step 2: Use `MOCK_METHOD` for Each Method
Inside the `public:` section of your mock class, declare each virtual method you want to mock using the macro:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs));
```

- `ReturnType`: The return type of the method.
- `MethodName`: The method's name.
- `(Args...)`: Argument list enclosed in parentheses.
- `(Specs)`: Optional qualifiers like `(const, override)`.

### Example
Given this interface:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};
```

Mock class definition:

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Important Notes
- Always place `MOCK_METHOD` declarations in the `public:` section.
- If the method is `const`, include `(const, override)` in specs.
- Use parentheses to wrap argument types containing commas.

---

## 3. Setting Default Behaviors with `ON_CALL`

If you want your mock methods to return specific values or perform actions when called, without enforcing any call expectation, use `ON_CALL`.

### Syntax

```cpp
ON_CALL(mock_object, Method(matchers))
    .With(multi_argument_matcher)  // Optional
    .WillByDefault(action);
```

- Unlike `EXPECT_CALL`, `ON_CALL` does not assert the method will be called.
- `.With()` applies a matcher on the whole argument tuple.
- `.WillByDefault()` specifies what the mocked method does.

### Example

```cpp
using ::testing::_;  // Matches any argument
using ::testing::Return;

MockTurtle turtle;
ON_CALL(turtle, GetX()).WillByDefault(Return(42));
// GetX() will return 42 whenever called, unless overridden by EXPECT_CALL.
```

---

## 4. Setting Expectations with `EXPECT_CALL`

Use `EXPECT_CALL` to declare that your test expects a certain method to be called with specific arguments, how many times, and what it should do.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers))
    .With(multi_argument_matcher)  // Optional
    .Times(cardinality)            // Optional
    .InSequence(sequences...)      // Optional
    .After(expectations...)        // Optional
    .WillOnce(action)              // Optional, can appear multiple times
    .WillRepeatedly(action)        // Optional
    .RetiresOnSaturation();        // Optional
```

### Core Clauses Explained
- **`.Times()`**: Specifies expected call count (e.g. `Exactly(n)`, `AnyNumber()`). Defaults inferred from `WillOnce`/`WillRepeatedly`.
- **`.InSequence()`**: Expect calls in a particular order, using `Sequence` objects.
- **`.After()`**: Enforce partial order dependencies on expectations.
- **`.WillOnce()`**: Actions for specific calls.
- **`.WillRepeatedly()`**: Action for all calls after `WillOnce()`.
- **`.RetiresOnSaturation()`**: Disable expectation once matched as often as specified.

### Example

```cpp
using ::testing::Return;
using ::testing::Exactly;

MockTurtle turtle;
EXPECT_CALL(turtle, Forward(100))
    .Times(Exactly(2))
    .WillRepeatedly(Return());

// The test will verify that turtle->Forward(100) is called twice.
```

### Matching Arguments
- Use concrete values (e.g., `100`) for exact matches.
- Use `_` to match any argument.
- Use matchers like `Lt(100)`, `Ge(42)` to specify constraints.

### Best Practice
Set default actions with `ON_CALL` for general behavior, add `EXPECT_CALL` only when you want to verify interactions explicitly.

---

## 5. Verifying Mock Interactions

GoogleMock automatically verifies that all `EXPECT_CALL` expectations are met when mock objects are destructed.

### Forcing Verification Manually
Sometimes you may want to verify expectations before destruction:

```cpp
#include <gmock/gmock.h>

Mock::VerifyAndClearExpectations(&mock_object);
```

### Allowing Leaks
If you deliberately want to leak a mock object (for example in a long-lived test fixture), suppress leaks warnings using:

```cpp
Mock::AllowLeak(&mock_object);
```

### Notes
- Do not set new expectations after verifying and clearing.
- Verification failure produces test failures with detailed messages.

---

## 6. Simple End-to-End Example

### Interface

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};
```

### Mock Class

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Test with Expectations

```cpp
#include <gtest/gtest.h>

using ::testing::Return;
using ::testing::_;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  ON_CALL(turtle, GetX()).WillByDefault(Return(0));
  EXPECT_CALL(turtle, PenDown()).Times(1);
  EXPECT_CALL(turtle, Forward(_)).Times(AtLeast(1));

  // Production code to test, injecting turtle.
  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 5));  // Hypothetical API call
}
```

### Explanation
- Default behavior for `GetX()` so it returns 0 if called indirectly.
- Expect `PenDown` exactly once.
- Expect `Forward` called at least once with any argument.
- Verifies interactions automatically.

---

## 7. Troubleshooting & Tips

### Common Issues
- **Unmatched Calls:** GoogleMock will report unexpected mock calls if they donâ€™t match any expectation.
- **Too Few Calls:** If a call is expected but missing, the test fails.
- **Order Violations:** When using sequences, calls out of order cause failure.
- **Too Many Calls:** Exceeding specified `Times()` cardinality produces errors.
- **Unprotected Commas:** Wrap comma-containing types in parentheses in `MOCK_METHOD`.

### Tips for Success
- Use `ON_CALL` to specify default behavior; reserve `EXPECT_CALL` for verifications.
- Use `_` matcher to keep tests flexible and less brittle.
- Group ordered expectations inside an `InSequence` block for predictable call order.
- Use `RetiresOnSaturation()` to disable expectations once fully matched.

### Best Practices
- Avoid over-specifying expectations; verify only what matters.
- Always set expectations before exercising code under test.
- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Use `StrictMock<T>` to treat uninteresting calls as failures when strictness is required.

---

## 8. Next Steps & Related Content

- Explore [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced usage patterns.
- Learn about [Matchers](https://google.github.io/googletest/reference/matchers.html) to improve argument matching.
- Understand [Actions](https://google.github.io/googletest/reference/actions.html) to control mocked method behavior.
- Read about [Mocking Best Practices](https://google.github.io/googletest/guides/mock#mocking-best-practices) to write maintainable tests.

---

## References
- [GoogleMock Official Documentation](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.md)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)

---

<Info>
This page focuses solely on the essential mocking workflow: defining mocks, setting default behaviors, specifying expectations, and verification. It does not cover matchers or actions in depth, which are handled on dedicated pages.
</Info>

---