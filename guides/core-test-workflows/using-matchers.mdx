---
title: "Using Matchers for Flexible Testing"
description: "Learn how to harness the power of matchers for more flexible and readable verifications in your tests. This guide covers built-in and custom matchers, with real-world examples showing how matchers enhance both assertions and mocks."
---

# Using Matchers for Flexible Testing

Discover how to leverage the power of **matchers** in GoogleTest and GoogleMock to create more expressive, flexible, and readable verifications. This guide covers the use of built-in and custom matchers, demonstrates how matchers enhance your assertion and mocking capabilities, and provides practical examples to solidify your understanding.

---

## Why Use Matchers?

Matchers allow you to describe how function arguments or values should be compared beyond exact equality. Instead of rigidly checking for exact values, matchers enable **predicate-based matching**—checking if values satisfy certain conditions like being within a range, matching a pattern, or containing substrings.

This makes your tests:

- More **expressive** and easier to read
- More **robust** by permitting controlled flexibility
- More **informative** by generating meaningful failure messages

---

## Built-in Matchers: A Quick Tour

### Basic Argument Matchers

- `_` — Matches any value (wildcard matcher)
- `Eq(value)` — Checks if argument equals `value`
- `Ne(value)` — Checks if argument does *not* equal `value`
- `Lt(value)`, `Le(value)`, `Gt(value)`, `Ge(value)` — Less than, less or equal, greater than, greater or equal

### String Matchers

- `HasSubstr(substring)` — Checks if string contains `substring`
- `StartsWith(prefix)` — Checks if string starts with `prefix`
- `EndsWith(suffix)` — Checks if string ends with `suffix`
- `StrEq(string)` and `StrCaseEq(string)` — Check for exact match (case-sensitive or case-insensitive)

### Container Matchers

- `ElementsAre(...)` — Matches the contents and order of a container's elements
- `UnorderedElementsAre(...)` — Matches container elements ignoring order
- `Contains(element_matcher)` — Checks if container contains an element matching `element_matcher`
- `SizeIs(matcher)` — Checks container size matches the matcher

### Pointer and Object Matchers

- `IsNull()` and `NotNull()` — Check for null and non-null pointers
- `Pointee(matcher)` — Check that the value pointed by a pointer satisfies `matcher`
- `Field(&Class::member, matcher)` — Match a member variable of a complex object
- `Property(&Class::getter, matcher)` — Match the return value of a getter method

---

## Writing Custom Matchers Quickly

GoogleTest provides macros to write custom matchers concisely to suit your unique testing needs.

### Defining a Simple Matcher with `MATCHER`

```cpp
MATCHER(IsEven, "") { return (arg % 2) == 0; }
```

Usage:

```cpp
EXPECT_CALL(mock, Bar(IsEven()));
EXPECT_THAT(some_value, IsEven());
```

When the test fails, GoogleTest prints:
```
Value of: some_value
Expected: is even
  Actual: 7
```

### Parameterized Matchers with `MATCHER_P`

Define matchers with parameters to enable reusability and descriptive error messages.

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}
```

Usage:

```cpp
EXPECT_THAT(x, HasAbsoluteValue(10));
```

Failure message example:

```
Value of: x
Expected: has absolute value 10
  Actual: -9
```

### Custom Failure Messages and Additional Explanation

You can customize descriptions referencing `negation` and parameters, or stream additional details to `result_listener` inside the matcher body to clarify failures.

Example with additional explanation:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  if (arg % divisor == 0) return true;
  *result_listener << "remainder is " << (arg % divisor);
  return false;
}
```

If test fails:
```
Value of: some_value
Expected: is divisible by 7
  Actual: 23 (remainder is 2)
```

---

## Applying Matchers in Mock Expectations

Matchers are your key to specifying precise argument expectations in mocks.

### Basic Matcher Usage in `EXPECT_CALL`

```cpp
EXPECT_CALL(mock_object, MethodName(Gt(5), Ne(10), _));
```

This means the method should be called with first arg > 5, second arg != 10, and any third argument.

### Matching Arguments as a Tuple Using `.With()`

Sometimes you want to impose complex constraints involving multiple arguments jointly.

```cpp
EXPECT_CALL(mock_obj, SetRange(_, _))
    .With(Lt())  // Assert first argument < second argument
    .WillOnce(Return(true));
```

- The `.With()` clause matches *all* arguments as a tuple.
- It can only be specified once and must be the first clause.

### Matcher Combinations

Use logical combinators:

- `AllOf(...)` — all matchers must match
- `AnyOf(...)` — any one matcher must match
- `Not(matcher)` — negation of a matcher

Example:

```cpp
EXPECT_CALL(mock_obj, Foo(AllOf(Gt(0), Ne(50))));  // Arg > 0 and != 50
EXPECT_CALL(mock_obj, Bar(Not(HasSubstr("error")))); // String arg without "error"
```

---

## Tips for Using Matchers Effectively

- **Specify only what matters:** Use `_` for arguments you don't care about.
- **Order specific expectations last:** Later `EXPECT_CALL`s take precedence in matching.
- **Use `.Times()` to express call counts:** If omitted, gMock infers cardinality based on actions.
- **If matching multiple calls with different arguments, use multiple `EXPECT_CALL`s:**

```cpp
EXPECT_CALL(mock, Func(1)).WillOnce(Return(10));
EXPECT_CALL(mock, Func(2)).WillOnce(Return(20));
```

- **Prefer `ON_CALL()` for default behaviors when call counts are not verified:**

```cpp
ON_CALL(mock, Func(_)).WillByDefault(Return(0));
```

- **For multiple matchers on complex arguments like structs, use `Field()` and `Property()`:**

```cpp
EXPECT_CALL(mock, Process(Field(&Foo::bar, Ge(3))));
```

- **When testing containers, use `ElementsAre` or `UnorderedElementsAre` for precise validation:**

```cpp
EXPECT_CALL(mock, HandleVector(ElementsAre(1, 2, 3)));
```

---

## Scenarios and Examples

### Verifying an Argument is Even Using a Custom Matcher

```cpp
MATCHER(IsEven, "") { return (arg % 2) == 0; }

EXPECT_CALL(mock_obj, SetNumber(IsEven()));
```

If failure occurs:

```
Value of: number
Expected: is even
  Actual: 7
```

### Matching Multiple Arguments Together

Check that a call to `SetBounds(min, max)` has min < max.

```cpp
EXPECT_CALL(mock_obj, SetBounds(_, _))
    .With(Lt());  // 2-tuple matcher: first arg < second arg
```

### Matching a Pointer Argument's Pointee

Expect a method to be called with pointer pointing to an int greater than 5:

```cpp
EXPECT_CALL(mock_obj, UpdateValue(Pointee(Gt(5))));
```

### Matching Container Contents

```cpp
EXPECT_CALL(mock_obj, ProcessVector(ElementsAre(10, 20, 30)));
EXPECT_CALL(mock_obj, ProcessVector(UnorderedElementsAre(30, 10, 20)));
```

### Using Tuples for Complex Argument Checks

```cpp
EXPECT_CALL(mock_obj, ProcessPair(_))
    .With(Property(&std::tuple<int, int>::first, Gt(0)))
    .WillOnce(Return());
```

### Combining Matchers

```cpp
EXPECT_CALL(mock_obj, Foo(AllOf(Gt(5), Ne(10))));
```

---

## Summary

Matchers are fundamental building blocks for writing robust and expressive GoogleTest and GoogleMock tests. They allow you to specify **what** conditions your arguments or values must satisfy instead of rigid equality, making your tests clearer and more flexible.

By combining built-in matchers and writing your own with the **MATCHER** macros, you can easily express complex conditions that capture your test intent with great precision and helpful feedback when failures happen.

---

## Additional Resources

- [GoogleTest Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html#Matchers)
- [Writing New Matchers Quickly](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers)
- [EXPECT_CALL Reference](https://google.github.io/googletest/reference/mocking.html#EXPECT_CALL)
- [Using Actions with Mocked Functions](https://google.github.io/googletest/gmock_cook_book.html#Actions)

---

## Navigation

- Guides > Core Test Workflows > [Assertions and Test Patterns](../guides/core-test-workflows/assertions-best-practices)
- Guides > Core Test Workflows > [Mocking in Practice: Isolating Dependencies](../guides/core-test-workflows/mocking-intro)
- Reference > Mocking and Behavior Specification > [Mocking Methods and Classes](../api-reference/mocking-api/mock-methods)

---