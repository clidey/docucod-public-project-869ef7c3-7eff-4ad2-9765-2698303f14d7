---
title: "Mocking in Practice: Isolating Dependencies"
description: "An approachable introduction to GoogleMock, demonstrating how to define mock classes, set up expectations, and control behavior in unit tests. Includes common use cases such as verifying interactions and simulating failures."
---

# Mocking in Practice: Isolating Dependencies

This guide introduces you to the practical use of GoogleMock (gMock) for isolating dependencies in unit tests. You will learn how to define mock classes, set up expectations, specify behaviors, and verify interactions to ensure your components are tested effectively without relying on real dependencies.

---

## 1. Understanding the Role of Mocking in Unit Tests

At the heart of robust unit testing lies the ability to isolate the unit of code under test from its dependencies. gMock excels at this by providing tools to create mock objects that mimic the interface of real components, allowing you to:

- Specify which methods should be called, with what arguments.
- Control what the mocked methods return or perform.
- Verify that the expected interactions actually happened.

Mocking lets you write tests that are more deterministic, faster, and easier to maintain compared to relying on full real implementations or complex fakes.

---

## 2. Defining Mock Classes

To mock an interface or abstract class in gMock:

1. **Inherit** from the interface or class you want to mock.
2. **Use the `MOCK_METHOD` macro** to declare mock methods matching the virtual methods you want to mock.

### Example

Suppose you have a simple abstract interface:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};
```

A corresponding mock would look like:

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

> **Tip:** Always declare your mock methods in the `public:` section, even if the original method is protected or private.

---

## 3. Creating and Using Mock Objects in Tests

Once you have your mock class, the typical workflow is:

### Steps

- Create a mock object instance.
- Set expectations on it using `EXPECT_CALL`.
- Optionally set default behavior using `ON_CALL`.
- Exercise the code under test that uses the mock.
- gMock will automatically verify expectations at mock destruction.

### Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;
using ::testing::_;
using ::testing::Return;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  // Expect PenDown to be called at least once.
  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));

  // Set default behavior for GetX and GetY.
  ON_CALL(turtle, GetX()).WillByDefault(Return(0));
  ON_CALL(turtle, GetY()).WillByDefault(Return(0));

  Painter painter(&turtle);
  bool success = painter.DrawCircle(0, 0, 10);

  EXPECT_TRUE(success);
}
```

---

## 4. Setting Expectations

### Basic `EXPECT_CALL` Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers))
  .Times(cardinality)
  .WillOnce(action)
  .WillRepeatedly(action);
```

- You can specify argument expectations using matchers like `_` (match anything), `Eq(value)`, `Ge(value)`, etc.
- `Times()` defines how many times the call is expected; omitting it means once or inferred from the actions.
- Use `WillOnce()` and `WillRepeatedly()` to define what the mock does when called.

### Examples

```cpp
EXPECT_CALL(turtle, Forward(100));  // Expect exactly one call with arg 100.
EXPECT_CALL(turtle, Forward(_)).Times(AnyNumber()); // Allow any number of calls with any value.
```

### Advanced Clauses

- `.InSequence()` or `InSequence` object to enforce call order.
- `.After()` to specify call dependencies.
- `.RetiresOnSaturation()` to disable expectation once saturated.

---

## 5. Controlling Mock Behavior with Actions

When a mock method is called, gMock can perform actions, such as:

- `Return(value)` - Returns a specific value.
- `ReturnRef(variable)` - Returns by reference.
- `Invoke(function_or_lambda)` - Calls a function or lambda.
- `DoAll()` - Performs multiple actions in sequence.
- `SetArgPointee<N>(value)` - Sets the value pointed to by argument `N` (useful for output parameters).

### Example - Return Different Values on Consecutive Calls

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

---

## 6. Verifying and Clearing Mock Expectations Explicitly

Sometimes you want to verify mock expectations before destruction:

```cpp
// Verifies and clears expectations on mock_obj; returns true if success.
bool ok = ::testing::Mock::VerifyAndClearExpectations(&mock_obj);
ASSERT_TRUE(ok);
```

You can also clear both expectations and default actions:

```cpp
bool ok = ::testing::Mock::VerifyAndClear(&mock_obj);
```

> **Warning:** Do not set new expectations after calling verify-and-clear on the same mock object.

---

## 7. Controlling Uninteresting Calls

An *uninteresting call* is a call to a mock method with no expectation on it. By default:

- gMock prints a warning.
- The default action is performed (such as returning 0 for integers).

You can adjust this behavior on a per-mock basis via wrappers:

- `NiceMock<T>` suppresses uninteresting call warnings.
- `StrictMock<T>` treats uninteresting calls as errors.
- `NaggyMock<T>` is the default and issues warnings.

---

## 8. Common Use Cases

### Verifying Interactions:

Ensure that dependent objects receive expected method calls:

```cpp
EXPECT_CALL(mock_turtle, PenDown()).Times(1);
EXPECT_CALL(mock_turtle, Forward(90)).Times(1);
```

### Simulating Failures:

Force the mock to behave as if an error occurred:

```cpp
EXPECT_CALL(mock_database, Connect(_))
    .WillOnce(Return(false));  // Simulate connection failure
```

### Controlling Call Orders:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Initialize());
  EXPECT_CALL(mock, Start());
  EXPECT_CALL(mock, Stop());
}
```

---

## 9. Best Practices & Tips

- Use `ON_CALL` to specify default behaviors; reserve `EXPECT_CALL` for actual verifications.
- Use `NiceMock` to reduce noise in tests when the exact number of calls is not crucial.
- Write clear and specific matchers to avoid brittle tests.
- Prefer `RetiresOnSaturation()` for expectations that you want to retire after usage.
- Use sequences when call order matters.
- Carefully handle move-only types using lambdas or `Return()` with `std::move`.

---

## 10. Troubleshooting Common Issues

### Problem: Tests fail with message about unexpected calls
**Cause:** The mock method was called with arguments not matched by any `EXPECT_CALL`.

**Solution:**
- Add a catch-all expectation with `.Times(AnyNumber())` if appropriate.
- Check that expectations are set before exercising the mock.

### Problem: Return values are always the first value specified
**Cause:** You used `Return(n++)` which evaluates `n++` once at expectation setup.

**Solution:**
- Use a lambda or custom action to generate values on each call.

### Problem: Uninteresting call warnings cluttering output
**Solution:**
- Use `NiceMock<T>`.
- Add `EXPECT_CALL(foo, Method(_)).Times(AnyNumber())` for methods you allow but do not verify.

### Problem: Mocking methods with move-only parameters
**Solution:**
- Use lambdas in `WillOnce` or `WillRepeatedly`.
- Avoid `Return(std::move(...))` in repeated calls.

---

## 11. Next Steps

- Explore [Matchers](../reference/matchers.md) to write powerful argument checks.
- Learn about [Actions](../reference/actions.md) to define custom mock behaviors.
- Read [gMock for Dummies](../gmock_for_dummies.md) for a beginner-friendly overview.
- Dive into the [gMock Cookbook](../gmock_cook_book.md) for practical recipes.

---

## References

- [Mocking Reference](../reference/mocking.md) — Detailed API info on `EXPECT_CALL`, `ON_CALL`
- [Actions Reference](../reference/actions.md) — Complete list of built-in actions
- [gMock Cheat Sheet](../gmock_cheat_sheet.md) — Quick syntax and usage reminders


---