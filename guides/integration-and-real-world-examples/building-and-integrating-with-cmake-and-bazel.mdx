---
title: "Building and Integrating with CMake and Bazel"
description: "Comprehensive walkthroughs for integrating GoogleTest and GoogleMock into CMake and Bazel build systems, addressing setup, configuration, and troubleshooting common integration issues."
---

# Building and Integrating with CMake and Bazel

## Overview
This guide provides comprehensive walkthroughs for integrating GoogleTest and GoogleMock into your C++ projects using the CMake and Bazel build systems. It covers setup, configuration details, linking strategies, and practical troubleshooting tips to help you seamlessly build and run tests within these common environments.

---

## Prerequisites
Before proceeding, ensure you have the following configured:
- A supported operating system (Linux, macOS, Windows) with a compatible C++ compiler supporting at least C++17.
- CMake version 3.14 or above (recommended 3.16+) for CMake builds.
- Bazel (latest stable) installed for Bazel builds.
- Network access if you plan to fetch GoogleTest sources on-the-fly.

---

## Expected Outcomes
By following this guide, you will:
- Successfully build GoogleTest and GoogleMock libraries with CMake and Bazel.
- Integrate GoogleTest/GoogleMock into your existing CMake or Bazel projects.
- Understand best practices for compiling, linking, and configuring build options.
- Troubleshoot common integration issues related to build configuration and linking.

## Time Estimate
Allow approximately 30-60 minutes to complete integration, depending on familiarity with your chosen build system.

## Difficulty Level
Intermediate — basic familiarity with CMake or Bazel is expected.

---

# Building and Integrating with CMake

## 1. Building GoogleTest and GoogleMock Standalone with CMake

### Step 1: Clone the Repository
Start by cloning the GitHub repository containing GoogleTest and GoogleMock:

```sh
git clone https://github.com/google/googletest.git -b main
cd googletest
```

### Step 2: Create a Build Directory
Create and navigate into a dedicated build directory inside the cloned repo:

```sh
mkdir build && cd build
```

### Step 3: Generate Build Files
Invoke CMake to generate native build files. By default, both GoogleTest and GoogleMock are built:

```sh
cmake ..
```

- To build only GoogleTest without GoogleMock, append `-DBUILD_GMOCK=OFF`:

```sh
cmake .. -DBUILD_GMOCK=OFF
```

### Step 4: Build the Libraries
Build the targets using your system’s build tool (e.g., `make`, `ninja`):

```sh
make
```

- On Windows, open the generated solution file (`gtest.sln`) in Visual Studio and build.
- On macOS, an Xcode project file will be generated.

### Step 5: (Optional) Install Libraries
If you have permissions and wish to install GoogleTest/GoogleMock for system-wide use:

```sh
sudo make install
```

By default, this installs headers and libraries in `/usr/local/`.

---

## 2. Integrating GoogleTest and GoogleMock into Your CMake Projects

### Method A: Using Installed Libraries via `find_package`

If GoogleTest/GoogleMock is already installed system-wide or in a known path:

```cmake
find_package(GTest CONFIG REQUIRED)

add_executable(my_test test_my_code.cpp)
target_link_libraries(my_test GTest::gtest_main)

include(GoogleTest)
gtest_discover_tests(my_test)
```

- Use `GTest::gtest_main` to link with GoogleTest's main() provided test runner.
- Link against `GMock::gmock_main` if using GoogleMock features.

### Method B: Embedding GoogleTest Source via `add_subdirectory`

For consistent compiler and linker settings, integrate GoogleTest/GoogleMock directly into your project tree:

```cmake
add_subdirectory(path/to/googletest)

add_executable(my_test test_my_code.cpp)
target_link_libraries(my_test gtest_main)

include(GoogleTest)
gtest_discover_tests(my_test)
```

This ensures tight integration and avoids runtime mismatches — highly recommended on Windows.

### Method C: FetchContent Module in CMake

To automatically download and integrate GoogleTest in your project’s configure phase:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/heads/main.zip
)

set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)  # To align Visual Studio CRT linkage
FetchContent_MakeAvailable(googletest)

add_executable(my_test test_my_code.cpp)
target_link_libraries(my_test gtest_main)

include(GoogleTest)
gtest_discover_tests(my_test)
```


This approach requires CMake 3.14+.

---

## 3. Important CMake Build Configuration Details

### C++ Standard
GoogleTest requires C++17 or newer. Set this explicitly:

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

### Visual Studio CRT Runtime Linking
On Windows with Visual Studio, GoogleTest defaults to static CRT linkage which may conflict with your project’s dynamic CRT:

- To force dynamic linkage, set `gtest_force_shared_crt` to `ON`:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

### Building Shared vs Static Libraries

- By default, GoogleTest builds static libraries.
- To build shared libraries, enable CMake’s built-in `BUILD_SHARED_LIBS` option:

```cmake
cmake .. -DBUILD_SHARED_LIBS=ON
```

- If building shared libraries, define the following manually when not using the CMake script:

  - `-DGTEST_CREATE_SHARED_LIBRARY=1` to compile GoogleTest as a shared library.
  - `-DGTEST_LINKED_AS_SHARED_LIBRARY=1` when compiling tests that link against the shared library.

---

## 4. Using pkg-config with CMake (Advanced)

When installed, GoogleMock and GoogleTest provide pkg-config files `gtest.pc`, `gtest_main.pc`, `gmock.pc`, and `gmock_main.pc` to assist dependency management.

- You may use CMake’s `pkg_check_modules` to find and link these libraries if pkg-config is supported in your environment.

---

## 5. Building and Integrating with Bazel

### Overview
GoogleTest/GoogleMock come with Bazel BUILD files to enable straightforward Bazel-based builds and test execution.

### Step 1: Use Bazel Targets
To utilize GoogleTest in your Bazel project, add dependencies on provided library targets:

- Use the `//:gtest` target for GoogleTest libraries.
- Use `//:gtest_main` for GoogleTest with the main() function.
- Use `//:gmock` and `//:gmock_main` if you need GoogleMock.

Example `BUILD` snippet for a test:

```python
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = ["//:gtest_main"],
)
```

### Step 2: Build and Run Tests
Use Bazel commands:

```sh
bazel build //:my_test
bazel test //:my_test
```

### Step 3: Platform-Specific Considerations

- Bazel’s configuration includes platform-specific flags (e.g., linking `-pthread` on Unix-like systems).
- Bazel handles multi-threading, dependency resolution, and cross-platform builds under the hood.

---

## 6. Troubleshooting Common Integration Issues

<AccordionGroup title="Build and Linking Issues">
<Accordion title="Missing Headers or Sources">
Ensure your `include_directories()` or target include paths include GoogleTest and GoogleMock header directories. When embedding sources, use `add_subdirectory()` properly.
</Accordion>
<Accordion title="Runtime Linker Errors on Windows">
Set `gtest_force_shared_crt` to `ON` in your CMake project to align C runtime linkage between your tests and GoogleTest.
</Accordion>
<Accordion title="Macro Name Conflicts">
If GoogleTest macros clash with other macros, use compiler defines like `-DGTEST_DONT_DEFINE_TEST=1` to rename them and avoid collisions.
</Accordion>
<Accordion title="pthread Link Errors on Unix/Linux">
Confirm that CMake detects pthread support properly, and link with `Threads::Threads` in your CMakeLists.txt. In custom builds, manually add `-pthread`.
</Accordion>
<Accordion title="Bazel Build Failures">
Check that your Bazel workspace dependencies and BUILD file correctly list GoogleTest targets and that your environment is set for C++17 compilation.
</Accordion>
</AccordionGroup>

<Tip>
When embedding GoogleTest sources via `add_subdirectory()`, always ensure the GoogleTest source directory path is correct relative to your project root to avoid build configuration drift.
</Tip>

---

## 7. Best Practices for Build Integration

- Prefer embedding GoogleTest and GoogleMock source code into your project via `add_subdirectory()` for maximum compatibility.
- Use the `FetchContent` module in CMake for automatically managing GoogleTest as an external dependency.
- Maintain C++17 standard compliance across your entire project to avoid ABI and linker conflicts.
- When using Visual Studio, consistently align runtime library linkage settings with GoogleTest.
- Build shared libraries only if necessary; static libraries are simpler and often more portable.

---

## Next Steps
- Explore the [Writing Your First Test](../core-testing-workflows/writing-your-first-test) guide to start writing effective unit tests.
- For advanced mocking integration, visit the [Introduction to Mocking](../mocking-and-advanced-patterns/introduction-to-mocking) guide.
- Consult the [Troubleshooting Common Issues](../best-practices-and-troubleshooting/troubleshooting-common-issues) guide if you encounter build or runtime problems.

---

## Resources and References
- [GoogleTest GitHub Repository](https://github.com/google/googletest)
- [CMake Official Website](https://cmake.org/)
- [GoogleTest Quickstart with CMake](docs/quickstart-cmake.md)
- [BUILD.bazel File in Source](BUILD.bazel)
- [GoogleMock CMakeLists.txt](googlemock/CMakeLists.txt)
- [googlemock/cmake/gmock.pc.in](googlemock/cmake/gmock.pc.in)
- [googletest/README.md - Build Instructions](googletest/README.md)


---