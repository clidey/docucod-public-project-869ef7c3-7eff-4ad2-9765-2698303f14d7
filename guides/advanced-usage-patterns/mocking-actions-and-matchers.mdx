---
title: "Advanced Mocking: Actions and Matchers"
description: "Explores complex use cases for GoogleMock, such as custom actions, custom matchers, and behavioral specifications with NiceMock, StrictMock, and error strategies. Illustrates how to extend mocks for sophisticated test constraints."
---

# Advanced Mocking: Actions and Matchers

## Overview

This guide delves into more sophisticated use cases of GoogleMock, focusing on custom actions, matchers, behavioral specifications like NiceMock and StrictMock, and error handling strategies. You will learn how to extend GoogleMock's mock capabilities to accommodate complex test scenarios and refine mock interactions to meet precise requirements.

---

## 1. Understanding Custom Actions

### Why Use Custom Actions?

Default mock behaviors or basic return values often fall short when:

- You need the mock to exhibit side effects.
- You want to simulate state changes or dynamic responses.
- You must invoke real functions, lambdas, or callbacks during testing.

GoogleMock provides flexible ways to define such behaviors through custom actions.

### Using Built-in Actions

GoogleMock supplies common actions including:

- `Return(value)`: Returns a fixed value.
- `ReturnRef(variable)`: Returns a reference to a variable.
- `Invoke(function)`: Invokes an existing function, method, or callable.
- `SetArgPointee<N>(value)`: Sets the value pointed to by the N<sup>th</sup> argument.
- `DoAll(action1, action2, ..., actionN)`: Performs multiple actions sequentially.

### Creating Custom Actions

Create custom actions by:

- Defining a functor or lambda with a call operator matching the mock method signature.
- Using the functor or lambda directly in `WillOnce()` or `WillRepeatedly()` clauses.

#### Example: Custom increment action

```cpp
struct IncrementAction {
  int operator()(int* value) {
    (*value)++;
    return *value;
  }
};

EXPECT_CALL(mock_obj, Increment(_))
    .WillOnce(IncrementAction());
```

### Invoking Callbacks and Function Arguments

If the mock method receives a callable (function pointer or functor) as an argument, you can invoke it easily:

```cpp
using ::testing::InvokeArgument;
EXPECT_CALL(mock_obj, RegisterCallback(_))
    .WillOnce(InvokeArgument<0>());  // Calls the first argument as a callback
```

Remember to wrap arguments in `std::ref` if the callback takes reference parameters to avoid copies.

### Handling Move-only Types

GoogleMock supports mocking methods with move-only arguments or return types (e.g., `std::unique_ptr`). Use lambdas or custom actions to properly handle dynamic move semantics:

```cpp
EXPECT_CALL(mock_obj, CreateUniquePtr())
    .WillRepeatedly([]() { return std::make_unique<MyClass>(); });
```

---

## 2. Mastering Matchers

### What Are Matchers?

Matchers specify the arguments that mock methods expect. They help precisely capture the contract of your mocked interfaces by validating inputs.

### Built-in Matchers

Commonly used built-in matchers include:

- `_`: Matches any argument.
- `Eq(value)`: Matches exactly equal values.
- `Ge(value)`: Matches greater than or equal to the value.
- `NotNull()`: Matches non-null pointers.
- `Pointee(matcher)`: Matches the dereferenced value pointed to by a pointer or smart pointer.
- Container matchers like `ElementsAre`, `UnorderedElementsAre`.

```cpp
EXPECT_CALL(mock_obj, Foo(Eq(5), NotNull()));
```

### Combining and Customizing Matchers

Use combiners such as `AllOf()`, `AnyOf()`, and `Not()` to elaborate predicates.

### Defining Custom Matchers

#### Using `MATCHER` macros

Define new matchers with:

```cpp
MATCHER(IsPositive, "checks if arg is positive") {
  return arg > 0;
}
EXPECT_CALL(mock_obj, Foo(IsPositive()));
```

#### Parameterized Matchers

Use parameterized macros for matchers that accept arguments:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "checks divisibility") {
  return (arg % divisor) == 0;
}
EXPECT_CALL(mock_obj, Foo(IsDivisibleBy(5)));
```

#### Custom Matcher Classes

For advanced scenarios, implement matcher classes with methods:

- `bool MatchAndExplain(const T& value, std::ostream* os) const`
- `void DescribeTo(std::ostream* os) const`
- `void DescribeNegationTo(std::ostream* os) const`

Return a `Matcher<T>` wrapping your class.

### Matching Members and Properties

Matchers can test specific object members or properties using:

- `Field(&Class::member, matcher)`
- `Property(&Class::method, matcher)`

This enables expressive validations like:

```cpp
EXPECT_CALL(mock_obj, SetData(Field(&DataStruct::id, Eq(42))));
```

### Matching Containers

Matchers also exist for containers, like:

- `ElementsAre(...)`
- `UnorderedElementsAre(...)`
- `ElementsAreArray()`

Use them to assert that sequences or collections meet particular criteria.

---

## 3. Managing Mock Behavior & Verification

### NiceMock, NaggyMock, StrictMock

- **NaggyMock (default):** Prints warnings on unexpected and uninteresting calls.
- **NiceMock:** Suppresses warnings on uninteresting calls.
- **StrictMock:** Treats uninteresting calls as test failures.

Use these wrappers to control how tolerant your test is to unexpected mock calls:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_mock;
```

### Handling Uninteresting and Unexpected Calls

- An **uninteresting call** is a call to a mock method without any expectations set.
- An **unexpected call** is a call that does not match any active expectation.

To suppress warnings on uninteresting calls without expectation, use `NiceMock` or add a catch-all expectation:

```cpp
EXPECT_CALL(mock_obj, Method(_)).Times(AnyNumber());
```

### Ordering Calls

Specify call ordering using:

- `InSequence` scope to enforce strict order.
- `.InSequence(seq1, seq2, ...)` clauses to define partial orders.
- `.After(expectation_or_expectationSet)` to define dependencies between expectations.

### Retiring Expectations

Use `.RetiresOnSaturation()` to make expectations inactive once their call count limit is reached. This is critical when overlapping expectations exist.

### Forcing Verification

Verify the mock object at any time using:

```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(&mock_obj));
```

This is especially helpful if the mock lifetime extends beyond the scope or is managed by test code under control.

---

## 4. Practical Examples

### Custom Action Example: Delegating Calls to a Fake

```cpp
class FakeFoo : public Foo {
 public:
  int Compute(int x) { return x * 2; }
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));
  void DelegateToFake() {
    ON_CALL(*this, Compute)
        .WillByDefault([this](int x) { return fake_.Compute(x); });
  }

 private:
  FakeFoo fake_;
};

// Usage in test
MockFoo mock;
mock.DelegateToFake();
EXPECT_CALL(mock, Compute(5));
EXPECT_EQ(10, mock.Compute(5));
```

### Custom Matcher Example: Checking Summation Invariant

```cpp
MATCHER_P(SumEquals, expected_sum, "Checks if bar() + baz() equals expected") {
  return (arg.bar() + arg.baz()) == expected_sum;
}

// Usage
Foo foo;
EXPECT_CALL(mock, ProcessFoo(SumEquals(10)));
```

### Using NiceMock and StrictMock

```cpp
using ::testing::StrictMock;

StrictMock<MockClass> strict_mock;
EXPECT_CALL(strict_mock, ImportantMethod());
...
// This fails if any unexpected or uninteresting methods are called.
```

### Sequencing Expectations

```cpp
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(mock, Init());
  EXPECT_CALL(mock, Start());
  EXPECT_CALL(mock, Stop());
}
// Calls to mock must happen in Init -> Start -> Stop order.
```

---

## 5. Troubleshooting Tips

- **Uninteresting call warnings:** Indicate your test does not set expectations on some called mock methods. Use `NiceMock` or explicit catch-all `EXPECT_CALL` to suppress.
- **Saturation errors:** Check call counts against `.Times()` to avoid calling more times than expected; consider `.RetiresOnSaturation()` if overlapping expectations.
- **Order problems:** Use `InSequence` or `.After()` to enforce call ordering.
- **Unexpected calls:** Review matchers and arguments to ensure expectations match actual calls.
- **Virtual destructors:** Always ensure interfaces have virtual destructors to prevent undefined behavior.

---

## 6. Next Steps and Related Documentation

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) - Introductory guide to mocking fundamentals.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) - Comprehensive API reference.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) - Recipes for advanced mocking.
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) - Quick syntax reference.
- [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html) - Troubleshooting common issues.

Consider exploring behavioral customization through NiceMock, StrictMock, and controlled verification to make your tests robust and maintainable.