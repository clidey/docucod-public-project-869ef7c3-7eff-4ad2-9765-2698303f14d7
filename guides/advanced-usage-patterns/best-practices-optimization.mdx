---
title: "Best Practices and Test Performance Optimization"
description: "Learn expert tips and actionable strategies to write maintainable tests and optimize execution speed. Topics include fixture reuse, organizing test code, controlling test order, and leveraging parallelism where appropriate."
---

# Best Practices and Test Performance Optimization

Unlock the full potential of your GoogleMock tests by applying expert techniques to write maintainable mocks and enhance test execution speed. In this guide, you will learn actionable strategies for fixture reuse, test organization, controlling call order, and effectively leveraging parallelism to optimize your tests for both reliability and performance.

---

## 1. Workflow Overview

### What This Guide Helps You Accomplish
Learn how to write maintainable, efficient mocks with GoogleMock and optimize your test suite for faster, more reliable execution. You will discover techniques to reuse fixtures smartly, manage expectations and calls cleanly, and leverage concurrency safely.

### Prerequisites
- Familiarity with GoogleMock basics—defining mock classes with `MOCK_METHOD`, setting expectations with `EXPECT_CALL`, and applying actions.
- A working GoogleMock setup for your C++ project.

### Expected Outcomes
After following this guide, you will be able to:
- Design and organize mocks and tests for better maintainability.
- Optimize mock behavior to reduce unnecessary overhead.
- Control the order and frequency of mock method calls precisely.
- Utilize test parallelism correctly without risking flaky tests.

### Time Estimate
15-30 minutes to learn and apply core best practices; additional time as needed to refactor existing tests.

### Difficulty Level
Intermediate; a good understanding of GoogleMock’s API and test design principles is assumed.

---

## 2. Best Practices for Writing Maintainable Tests

Effective mocks are as much about test clarity and maintainability as they are about correctness.

### 2.1 Define Clear Mock Classes
- Always declare mock methods (`MOCK_METHOD`) in the `public:` section, regardless of base method access. This ensures expectations (`EXPECT_CALL`) and behavior (`ON_CALL`) can be set externally.
- Use explicit qualifiers for mocked methods, including `(override)` and `(const)` when appropriate, to catch interface mismatches at compile time.

### 2.2 Use Matchers Thoughtfully
- Use `::testing::_` (wildcard matcher) to avoid over-specifying arguments.
- Apply specific matchers like `Ge()`, `Eq()`, or custom matchers only when relevant to the test goal.
- Avoid brittle argument checks that tie tests too closely to implementation details.

### 2.3 Manage Expectations with Care
- Use `EXPECT_CALL` sparingly: only when you need to verify that a call actually happens.
- For default behavior that does not need verification, use `ON_CALL` to set `WillByDefault` actions. This reduces verbosity and test brittleness.
- Define cardinalities (`Times()`) to clarify the expected call frequency. Omitting `Times()` defaults to exactly once or inferred cardinality based on actions.
- Use `.RetiresOnSaturation()` when you want expectations to become inactive once saturated, avoiding over-saturation errors.

### 2.4 Control Call Order and Dependencies
- Use `InSequence` and `Sequence` objects to specify strict or partial order among calls.
- Use `.After()` clauses to express prerequisite call order dependencies clearly.
- Prefer sequences to organize related behaviors logically.
- Avoid over-constraining call order unless it is part of the contract or critical to correctness.

### 2.5 Avoid Overly Strict Mocks
- The default mock object behavior (NaggyMock) warns about uninteresting calls; use `NiceMock` to suppress these warnings when you want quieter tests.
- Use `StrictMock` only when you want uninteresting calls treated as errors, as this can make tests more brittle.
- Avoid mixing mock types on the same mock class or nesting nice/strict mock wrappers.

### 2.6 Reuse Test Fixtures and Mock Objects
- Use test fixtures (`TEST_F`) to share common mock setup across tests.
- Set common `ON_CALL` default behaviors in fixtures, and place `EXPECT_CALL`s in individual tests to express expectations unique to each.

### 2.7 Delegate Calls to Fakes or Real Implementations if Appropriate
- When complex behavior is needed, delegate mock methods by default to a fake implementation to prevent duplicate logic.
- Delegate to the real implementation to ensure production parity with mock behavior, combining verification with realistic results.

---

## 3. Test Organization for Clarity and Maintainability

### 3.1 Group Related Expectations Logically
- Place logically related expectations in the same test or fixture.
- Use meaningful names for tests and fixtures to describe behavior being tested.

### 3.2 Avoid Expectation Duplication
- Avoid having overlapping or contradictory `EXPECT_CALL` declarations.
- Place more general expectations before more specific ones, as the last matching expectation wins.

### 3.3 Use Sequences to Represent Partial Orders
- For tests requiring partial ordering of calls, define sequences per logical branch and assign expectations accordingly.
- Document call order intent for future maintainers.

### 3.4 Leverage `RetiresOnSaturation` for Transitional States
- When testing state changes or call phases, retire expectations once saturated to allow subsequent behaviors.

---

## 4. Optimizing Test Execution Speed

Faster tests improve developer productivity and enable larger test suites.

### 4.1 Reuse Fixtures and Set Up once
- Initialize shared mocks and default behaviors in test fixture `SetUp()` instead of repeating in every test.

### 4.2 Reduce Unnecessary Overhead in Mock Methods
- Avoid overly verbose logging unless debugging (adjust `--gmock_verbose` flag).
- Simplify actions to return fixed values when possible instead of executing complex logic.

### 4.3 Control Call Order Only When Necessary
- Avoid strict ordering if the behavior under test does not depend on it to prevent test slowdowns due to locks or complex verification overhead.

### 4.4 Run Tests in Parallel Where Safe
- Use your build system’s parallel test running capability.
- Ensure tests do not share mutable global states or resources.
- GoogleMock supports thread-safe mocks, but setting/clearing expectations must happen in one thread.

### 4.5 Manage Mock Lifetimes and Leaks
- Delete heap-allocated mocks to allow proper verification and prevent leak errors.
- Use `Mock::AllowLeak()` when intentional leaks are acceptable.

### 4.6 Use Lightweight Actions
- Favor built-in actions like `Return()`, `ReturnRef()`, or simple lambdas over complex custom actions when performance matters.

---

## 5. Step-by-Step Instructions to Apply Best Practices

<Steps>
<Step title="Define Your Mock Classes Clearly">
Use `MOCK_METHOD` macros in the public section, matching the base class signatures.
If needed, add constructors/destructors externally to speed up compile times.
</Step>
<Step title="Set Default Behaviors">
Use `ON_CALL(mock_object, Method(args))` with `.WillByDefault(action)` in your test fixture’s setup.
This sets default behavior without enforcing call count.
</Step>
<Step title="Define Precise Expectations Only When Necessary">
Add `EXPECT_CALL` in tests for calls whose occurrence or parameters you want to verify.
Specify appropriate matchers and call count with `.Times()`.
</Step>
<Step title="Manage Call Ordering">
Avoid ordering constraints unless required.
Use `InSequence` or `Sequence` objects only to express necessary order.
Use `.After()` to specify call dependencies explicitly.
</Step>
<Step title="Optimize for Performance">
Keep default actions simple.
Reuse fixtures.
Run tests in parallel when possible.
Suppress verbose logging with `--gmock_verbose=warning` or `error`.
</Step>
</Steps>

---

## 6. Practical Examples

### Example 1: Simple Mock with Default and Expected Calls

```cpp
class MockFoo {
 public:
  MOCK_METHOD(bool, Bar, (int x, int y), (override));
};

class FooTest : public ::testing::Test {
 protected:
  MockFoo mock_foo;

  void SetUp() override {
    ON_CALL(mock_foo, Bar(::testing::_, ::testing::_))
        .WillByDefault(::testing::Return(true));
  }
};

TEST_F(FooTest, CallsBarWithZero) {
  EXPECT_CALL(mock_foo, Bar(0, ::testing::_));

  // call code that should invoke Bar(0, ...)
}
```

**Outcome:** The mock returns true by default, but verifies that `Bar` is called with first argument 0.

---

### Example 2: Sequencing Calls with `InSequence`

```cpp
using ::testing::InSequence;

TEST_F(FooTest, CallsInOrder) {
  InSequence seq;

  EXPECT_CALL(mock_foo, Bar(1, 1));
  EXPECT_CALL(mock_foo, Bar(2, 2));

  // Calls must happen in this order
}
```

---

### Example 3: Using `RetiresOnSaturation` to Allow Call Transition

```cpp
EXPECT_CALL(mock_foo, Bar(0, 0))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock_foo, Bar(1, 1)).Times(::testing::AnyNumber());

// After two calls to Bar(0,0), calls to Bar(1,1) are allowed.
```

---

## 7. Troubleshooting & Tips

<AccordionGroup title="Common Challenges and Solutions">
<Accordion title="Test Fails Because of Unexpected Calls">
Check if there are any calls without matching `EXPECT_CALL`. Use a catch-all expectation with `Times(AnyNumber())` if some calls are allowed but not interesting.
</Accordion>
<Accordion title="Compilation Slow Due to Large Mock Classes">
Move constructor and destructor definitions of mock classes into `.cc` files instead of header inline to reduce compile times.
</Accordion>
<Accordion title="Uninteresting Call Warnings Cluttering Output">
Switch from default NaggyMock to `NiceMock` to suppress uninteresting call warnings.
Adjust the verbosity flag `--gmock_verbose=warning` or `error`.
</Accordion>
<Accordion title="Order-Dependent Failures When Not Using Sequences">
Add `InSequence` or `Sequence` orders explicitly to enforce call order and reduce brittle failures.
</Accordion>
</AccordionGroup>

<Tip>
Always prefer setting default mock behaviors (`ON_CALL`) in fixture setup and use `EXPECT_CALL` only to verify calls essential to the test to avoid over-constraining and brittleness.
</Tip>

---

## 8. Next Steps & Related Content

- Review the [Mocking Reference](../reference/mocking.md) for comprehensive API details on setting up mocks.
- Dive deeper into the [gMock Cookbook](../gmock_cook_book.md) for extended recipes on advanced mocking techniques.
- Explore the [gMock for Dummies](../gmock_for_dummies.md) guide if you want a gentler introduction.
- Leverage parallel test execution as described in your build system documentation to speed up overall test time.
- Monitor output verbosity with `--gmock_verbose` to balance information and noise during development.

---

**Resources:**
- [GoogleMock Overview & Architecture](https://github.com/google/googletest/blob/main/googlemock/README.md)
- [GoogleTest Primer](../primer.md)
- [Mocking Reference](../reference/mocking.md)
- [gMock Cookbook](../gmock_cook_book.md)

---