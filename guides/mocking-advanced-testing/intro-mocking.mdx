---
title: "Introduction to Mocking with GoogleMock"
description: "A walkthrough on creating and using mock classes. This guide demonstrates how to substitute dependencies with mocks, define expected interactions, and run tests that validate correct system behavior in isolation."
---

# Introduction to Mocking with GoogleMock

## Workflow Overview

### Task Description
This guide leads you through creating and using mock classes in GoogleMock. You will learn how to substitute real dependencies with mocks, define expectations on mock methods, and verify system behaviors in isolated unit tests.

### Prerequisites
- Familiarity with C++ and virtual functions
- GoogleTest and GoogleMock installed and configured
- Understanding of basic testing concepts (refer to "What is GoogleTest?" page)

### Expected Outcome
By completing this guide, you will be able to:
- Define mock classes for interfaces
- Specify expected method calls, arguments, and return values using `EXPECT_CALL`
- Set default behaviors using `ON_CALL`
- Write tests that verify interactions between tested code and its dependencies

### Time Estimate
15-30 minutes depending on familiarity with C++ unit testing and mocking

### Difficulty Level
Beginner to Intermediate

---

## Creating Mock Classes

### Step 1: Define Your Interface
Create or identify the interface (abstract class) you want to mock. It must have **virtual** methods and a **virtual destructor**. For example:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};
```

### Step 2: Derive Your Mock Class
Create a class deriving from your interface and use the `MOCK_METHOD` macro to mock each virtual method you want to simulate. Follow these rules:

- Put all `MOCK_METHOD`s in the `public:` section.
- Use method signatures exactly as in the base class.
- For `const` methods, add `(const)` as a fourth parameter to `MOCK_METHOD`, e.g. `(const, override)`.
- Add `(override)` to mock overrides to indicate overriding virtual methods. This helps catch signature mismatches.

Example:

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

**Important:** You do not implement the methods yourself. The macro takes care of generating the mock behavior.

### Step 3: Handle Return or Argument Types with Commas
If return types or arguments contain commas (e.g., templates like `std::pair`), wrap them in extra parentheses or use type aliases:

```cpp
using BoolAndInt = std::pair<bool, int>;
MOCK_METHOD((BoolAndInt), GetPair, ());
```

### Best Practices
- Define mock classes in test utilities or dedicated mock headers, not directly in test files when possible.
- Avoid mocking classes you do not own unless necessary. Prefer coding to interfaces.

---

## Using Mocks in Tests

### Typical Workflow
1. Import the `testing` namespace symbols to avoid verbose syntax, e.g., `using ::testing::_;`
2. Instantiate your mock object.
3. Set expectations on mock methods using `EXPECT_CALL` before the mock methods are invoked.
4. Exercise your code that uses the mock.
5. GoogleMock automatically verifies expectations on mock object destruction.

Example:

```cpp
#include <gtest/gtest.h>
#include <gmock/gmock.h>

using ::testing::_;
using ::testing::AtLeast;

TEST(PainterTest, DrawCallsPenDown) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown())
      .Times(AtLeast(1));

  Painter painter(&turtle);
  painter.DrawCircle(0, 0, 10);
}
```

### Notes on Expectations
- Set expectations **before** any code calls the mock methods to ensure defined behavior.
- `EXPECT_CALL` defines how many times a method should be called and optionally what it returns or does.
- If an expected call is missing, GoogleMock reports failure immediately when the test ends.

### Matchers
- Use matchers in `EXPECT_CALL` to specify argument expectations.
- Use `_` to match any argument value if the exact value does not matter.

Example:

```cpp
EXPECT_CALL(turtle, Forward(100));        // Expect Forward called with 100
EXPECT_CALL(turtle, GoTo(50, _));          // First argument 50, second any value
EXPECT_CALL(turtle, Turn);                  // Method called with any arguments
```

### Default Actions with `ON_CALL`
You can set default behavior for mock methods that do not have strict expectations using `ON_CALL`. This defines what happens when a mock is called with arguments matching the matchers, without requiring a call count.

Example:

```cpp
ON_CALL(turtle, GetX())
    .WillByDefault(Return(0));
```

Use `ON_CALL` to setup default behaviors that all tests will share.

---

## Controlling Mock Behavior

### Specifying Call Counts
Use the `.Times()` clause with `EXPECT_CALL` to specify how many times a method should be called:

| Cardinality        | Meaning                                      |
|--------------------|----------------------------------------------|
| `Exactly(n)`       | Expect exactly `n` calls                      |
| `AtLeast(n)`       | Expect at least `n` calls                      |
| `AtMost(n)`        | Expect at most `n` calls                       |
| `AnyNumber()`      | Allow any number of calls                      |

If `.Times()` is omitted, gMock assumes `Times(1)` or infers it from `.WillOnce()` clauses.

### Ordering Calls
Use sequences and partial ordering to enforce call order:

- Use an `InSequence` object to require expectations to match calls in order.

```cpp
{
  testing::InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

- For more complex orders, use `.After()` and `Sequence` objects to specify partial ordering.

### Retiring Expectations
By default, expectations remain active after matching call counts. Use `.RetiresOnSaturation()` to retire an expectation once it has been fulfilled to prevent unwanted matches.

Example:

```cpp
EXPECT_CALL(foo, Bar(_))
    .Times(2)
    .RetiresOnSaturation();
```

---

## Advanced Mocking Techniques

### Creating Nice, Naggy, or Strict Mocks
- **NaggyMock** (default behavior): warns on uninteresting calls.
- **NiceMock**: suppresses warnings on uninteresting calls.
- **StrictMock**: treats uninteresting calls as test failures.

Example:

```cpp
NiceMock<MockFoo> nice_foo;
StrictMock<MockFoo> strict_foo;
```

Use these wrappers to adjust how strict GoogleMock is about unexpected mock calls.

### Delegating Calls
- **To a Fake:** Use `ON_CALL` and lambdas to redirect mock method calls to a fake implementation.
- **To a Real Object:** Similar to fake delegation but using a real instance.
- **To a Parent Class:** Invoke base class implementations inside mock actions to reuse behavior.

### Working With Move-Only Types
Mocking methods that accept or return move-only types (e.g., `std::unique_ptr`) is fully supported using `MOCK_METHOD`. Use lambdas or `WillOnce` with `Return(std::move(...))` properly and avoid returning moved-from objects multiple times.

### Verifying and Resetting Mocks Manually
Use

```cpp
Mock::VerifyAndClearExpectations(&mock_object);
```

to force verification before destruction or to check mocks explicitly.

---

## Example Walkthrough

### Defining a Mock Class

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Using the Mock in a Test

```cpp
#include <gtest/gtest.h>
#include <gmock/gmock.h>

using ::testing::_;

TEST(PainterTest, CallsPenDown) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown())
      .Times(1);

  Painter painter(&turtle);

  painter.DrawCircle(0, 0, 10);
}
```

Here the test requires the `PenDown()` method to be called once. The test fails if this expectation is not met.

---

## Troubleshooting & Tips

### Common Issues
- **Mock Methods Must be Virtual:** If calls go to real methods, verify the mocked methods are virtual.
- **Destructor Must be Virtual:** Prevent leaks or undefined behavior by having virtual destructors.
- **Expectations Must Be Set Before Use:** Setting expectations after calling mock methods results in undefined behavior.
- **Ambiguous Overloaded Methods:** Fully specify mock method signatures or disambiguate using `Const()`.

### Best Practices
- Always override virtual destructors in interfaces being mocked.
- Use `NiceMock` to reduce spam from uninteresting calls in tests.
- Use `.RetiresOnSaturation()` to avoid sticky expectation issues.
- Prefer `ON_CALL` for default behavior and reserve `EXPECT_CALL` to verify calls.
- Use sequences or `.After()` to control call ordering where necessary.
- Use safe matchers (`SafeMatcherCast`) if you need to match similar but not identical types.

---

## Next Steps & Related Content
- Explore **Configuring Expectations and Actions** for detailed expectation clauses and actions.
- Learn to use **Matchers and Custom Parameters** to refine argument matching.
- Understand **Managing Mock Strictness** with `NiceMock`, `NaggyMock`, and `StrictMock`.
- Review the **Mocking Reference** for all macros, classes, and detailed usage.
- For setup and build instructions, see [Installation Instructions](/getting-started/setup-basics/installation).

---

## References
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

---

---
### Response Structure
- **Complete coverage** of defining mock classes and using them
- **Clear, actionable examples and steps** for user tasks
- **Best practices, common pitfalls, and tips** to succeed
- **Links to related sections and next steps** for progressive learning

---
