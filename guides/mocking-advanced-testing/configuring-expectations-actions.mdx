---
title: "Configuring Expectations and Actions"
description: "Learn to use core macros like EXPECT_CALL and ON_CALL to set expectations on mock methods, define sequencing, return values, and control test flow. Gain insight into the lifecycle of expectations, cardinality, and action patterns for powerful test design."
---

# Configuring Expectations and Actions

## Overview

This guide equips you with practical knowledge to use GoogleMock's core macros—`EXPECT_CALL` and `ON_CALL`—for configuring your mock objects' behavior and expectations. You'll learn to specify how mocked methods should respond, set call count constraints, define call sequences, and manage the lifecycle of expectations. With concrete examples and structured advice, this will empower you to design precise and maintainable tests that verify interactions as intended.

---

## Prerequisites

- Familiarity with C++ and virtual methods.
- Basic understanding of mocking concepts and GoogleMock fundamentals (consider reading [gMock for Dummies](gmock_for_dummies.md)).
- A mock class with mocked methods defined using `MOCK_METHOD`.

---

## Expected Outcome

By following this guide, you will be able to:

- Set default and explicit expectations on mock methods.
- Configure how many times a mock method should be called.
- Define the order and dependencies among method calls.
- Assign actions to mocked calls, including return values and side effects.
- Use cardinalities, sequences, and advanced patterns to precisely manage test flow.

---

## Time Estimate

15 to 30 minutes, depending on prior experience with mocking.

---

## Difficulty Level

Intermediate

---

# Step-by-Step Instructions

### 1. Setting Default Behaviors with `ON_CALL`

Use `ON_CALL` to specify the default behavior of a mock method without setting any expectation on call count or order. This is useful for fallback behavior when you don't want to enforce strict verification.

```cpp
using ::testing::Return;

ON_CALL(mock_object, MethodName(matchers))
    .WillByDefault(Return(value));
```

- **Example:** Set default return for any call to `GetSize` to be `1`.

```cpp
ON_CALL(mock_foo, GetSize())
    .WillByDefault(Return(1));
```

> You can mix `ON_CALL` with `EXPECT_CALL`. The `EXPECT_CALL` actions take precedence during matching.

### 2. Setting Explicit Expectations with `EXPECT_CALL`

Use `EXPECT_CALL` to specify that a method is expected to be called with certain arguments, a specific number of times, in a certain order, and with defined actions.

Basic syntax:

```cpp
EXPECT_CALL(mock_object, MethodName(arg_matchers...))
    .Times(cardinality)
    .InSequence(sequences...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

#### Arguments matching

- Matchers specify constraint on argument values.
- Use special matchers like `_` to ignore arguments.

```cpp
EXPECT_CALL(turtle, Forward(100));         // Exactly 100
EXPECT_CALL(turtle, GoTo(50, _));          // First arg: 50, any second arg
EXPECT_CALL(turtle, GoTo);                  // Any arguments (non-overloaded only)
```

#### Times / Cardinalities

Control how many times the expectation should be matched.

| Cardinality        | Description                         |
| ------------------ | --------------------------------- |
| `.Times(Exactly(n))` or `.Times(n)` | Expect exactly n calls (0 means never called) |
| `.Times(AtLeast(n))` | At least n calls expected        |
| `.Times(AtMost(n))`  | At most n calls allowed          |
| `.Times(AnyNumber())`| Any number of calls allowed      |

**Note:** If you omit `.Times()`, gMock infers it based on actions specified:

- No actions → `.Times(1)`
- N `WillOnce()` clauses, no `WillRepeatedly()` → `.Times(N)`
- N `WillOnce()` + `WillRepeatedly()` → `.Times(AtLeast(N))`

Example:

```cpp
EXPECT_CALL(mock_turtle, PenDown())
    .Times(AtLeast(1));
```

#### Setting Actions

Actions specify what happens when the expectation matches a call.

- `.WillOnce(action)` - defines behavior for one call; can be used multiple times to specify different behaviors for consecutive calls.
- `.WillRepeatedly(action)` - defines behavior for all calls after all `.WillOnce()` actions are consumed.

Actions come from the [`::testing` namespace](actions.md), examples:

- `Return(value)` - returns the specified value.
- `Invoke(func)` - invokes a callable.
- `DoAll(action1, action2, ...)` - performs a sequence of actions.

Example:

```cpp
EXPECT_CALL(mock_foo, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(200))
    .WillRepeatedly(Return(300));
```

#### Ordering Calls

By default, calls may occur in any order. Use `InSequence` or `After` to arrange strict or partial call ordering.

- **`InSequence` block:** Encloses expectations that must fire in order.

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

- **`After` clause:** Specifies an expectation must occur after one or more other expectations.

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Use()).After(e1);
```

#### Retirement of Expectations

Use `.RetiresOnSaturation()` to make an expectation retire (become inactive) once it has been saturated (called the allowed number of times).

This is useful to allow a fallback expectation to be matched afterward.

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, SetNumber(_))
    .Times(AnyNumber());
```

### 3. Using `With` to Fine-Tune Argument Matching

Both `EXPECT_CALL` and `ON_CALL` accept an optional `.With(matcher)` clause. This allows you to specify a matcher against a tuple of all arguments for complex multi-argument conditions.

Example:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // First argument less than second
```

### 4. Managing Interaction with Multiple Expectations

GoogleMock searches expectations **backwards**, so the last matching expectation is used first. This facilitates defining generic behaviors before specialized ones.

Example:

```cpp
EXPECT_CALL(mock, Bar(_)); // generic catch-all
EXPECT_CALL(mock, Bar(10)).Times(2); // specific expectation
```

### 5. Suppressing Warnings on Uninteresting Calls

When a mock method is called without an matching `EXPECT_CALL`, gMock warns by default.

You can suppress this by using `NiceMock<MockClass>` or by explicitly specifying:

```cpp
EXPECT_CALL(mock, Method(_)).Times(AnyNumber()).WillRepeatedly(Return(...));
```

For strict enforcement use `StrictMock` which treats uninteresting calls as errors.

---

# Examples

### Setting Up Simple Expectations with Return Values

```cpp
using ::testing::Return;

class MockFoo {
 public:
  MOCK_METHOD(int, GetNumber, (), (const));
};

MockFoo mock;
ON_CALL(mock, GetNumber()).WillByDefault(Return(0));
EXPECT_CALL(mock, GetNumber())
    .Times(3)
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillOnce(Return(3));

EXPECT_EQ(1, mock.GetNumber());  // first call
EXPECT_EQ(2, mock.GetNumber());  // second call
EXPECT_EQ(3, mock.GetNumber());  // third call
```

### Sequencing Calls with `InSequence`

```cpp
using ::testing::InSequence;
using ::testing::_;

{
  InSequence seq;

  EXPECT_CALL(mock, Connect());
  EXPECT_CALL(mock, Authenticate(_));
  EXPECT_CALL(mock, Disconnect());
}

// This enforces that Connect is called before Authenticate, which
// must happen before Disconnect.
```

### Using `.After()` Clause

```cpp
using ::testing::Expectation;

Expectation init = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Start()).After(init);

// Start is expected only after Init() has been called.
```

### Ignoring Calls You Don’t Care About

```cpp
// Accept any call to the method, with any argument(s).
EXPECT_CALL(mock, Process(_)).Times(::testing::AnyNumber());
```

### Setting Default Actions with `ON_CALL`

```cpp
ON_CALL(mock, GetValue()).WillByDefault(Return(42));
```

---

# Troubleshooting & Tips

### Common Issues

- **Methods Not Mocked:** Ensure the method to be mocked is virtual, else GoogleMock calls the real method.
- **Ambiguous Overloads:** Specify argument types/matchers to resolve overloaded method ambiguity.
- **Uninteresting Call Warnings:** If unexpected warnings occur, check if you forgot an `EXPECT_CALL` or consider using `NiceMock`.
- **Sticky Expectations:** By default, expectations remain active until explicitly retired or the test ends; use `.RetiresOnSaturation()` when needed.

### Best Practices

- Use `ON_CALL` to set sensible defaults shared by all tests.
- Use `EXPECT_CALL` sparingly, only to verify necessary interactions.
- Order your expectations from general to specialized, placing the more specific ones later.
- Make use of `InSequence` and `After` to clearly express call order requirements.
- Avoid over-specification — do not constrain arguments or call counts more than needed.
- Retire saturated expectations to avoid unintended match failures in complex test flows.

### Performance Considerations

- Group related expectations in `InSequence` blocks to simplify ordering.
- Use `.Times(AnyNumber())` to tolerate extra calls that do not affect test validation.

### Alternative Approaches

If your tests find it cumbersome to handle intricate call order or behaviors with separate expectations, consider:

- Defining multiple actions in a single expectation using multiple `WillOnce()` calls followed by a `WillRepeatedly()` action.
- Delegating default behaviors to real instance methods or existing fake implementations for wide reuse.

---

# Next Steps & Related Resources

- **Working with Matchers:** Learn to use built-in and custom matchers to express argument constraints precisely.
- **Managing Mock Strictness:** Understand `NiceMock`, `NaggyMock`, and `StrictMock` to control warning and failure behaviors.
- **Mocking Complex Types:** Review advanced recipes in the [gMock Cookbook](gmock_cook_book.md).
- **GoogleMock Reference:** See the [Mocking Reference](docs/reference/mocking.md) for a formal overview.
- **Actions API:** Deep dive into [available actions](docs/reference/actions.md) provided by GoogleMock.

---

Explore the following key documents for complimentary knowledge:

- [gMock Cookbook](gmock_cook_book.md): Recipes for crafting mocks, advanced expectations, and actions.
- [gMock Cheat Sheet](gmock_cheat_sheet.md): Quick syntax and utility reference.
- [Mocking Reference](docs/reference/mocking.md): Detailed API descriptions.

---