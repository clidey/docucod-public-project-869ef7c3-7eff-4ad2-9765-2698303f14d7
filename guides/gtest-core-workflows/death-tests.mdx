---
title: "Death Tests: Testing for Expected Failures"
description: "Guides users through writing and using death tests to verify code exits in a controlled manner under error conditions. It addresses appropriate usage scenarios, syntax, and best practices to avoid common pitfalls."
---

# Death Tests: Testing for Expected Failures

## Overview

Death tests are a powerful feature in GoogleTest that let you verify whether certain code causes your program to terminate in a controlled and expected way. These tests are essential for validating assertion failures, invariant checks, or other kinds of fatal errors that should bring down your program.

This guide walks you through writing, running, and interpreting death tests with GoogleTest, focusing specifically on how to write them, when to use them, and the best practices for doing so effectively.

---

## What Are Death Tests?

Death tests verify that a particular piece of code causes the process to exit or crash, typically due to assertion failures or other fatal conditions.

Key points about death tests:

- They run the tested code in a separate child process to isolate the crash.
- They check:
  - That the code terminates as expected (does not return normally).
  - That the exit status or signal matches certain conditions.
  - That the output to `stderr` matches an expected pattern (usually a regex).
- They help ensure your program fails fast and cleanly in error conditions.

### When To Use Death Tests

Use death tests when you want to verify:

- Your code asserts a critical condition and terminates when violated.
- Your program exits with a specific error code under certain failure conditions.
- Your code triggers fatal errors that terminate the process.

### When Not To Use Death Tests

Avoid using death tests:

- For general exception testing, use exception assertions instead.
- When you want to observe or test side-effects after the death causing statement, since side-effects are not visible outside the child process.
- Within multi-threaded contexts without precautions, as forking multi-threaded processes can be unsafe (see Death Test Styles below).

---

## Writing a Death Test

GoogleTest provides macros tailored for death testing that run code expected to terminate:

- **`ASSERT_DEATH(statement, regex)`** - Aborts current test on failure.
- **`EXPECT_DEATH(statement, regex)`** - Continues after failure.
- **`ASSERT_EXIT(statement, predicate, regex)`** - Assert program exits with specific exit code satisfying predicate.
- **`EXPECT_EXIT(statement, predicate, regex)`** - Like ASSERT_EXIT but non-fatal.
- **`EXPECT_DEBUG_DEATH` and `ASSERT_DEBUG_DEATH`** - Like death tests, but only active in debug builds.

The `regex` parameter is matched against the child process's standard error output to confirm expected error messages.

### Example: Basic Death Test

```cpp
TEST(MyDeathTest, DiesOnInvalidInput) {
  ASSERT_DEATH({ Process(-1); }, "Invalid input detected");
}
```

This test confirms that calling `Process` with `-1` terminates the process and outputs a message matching "Invalid input detected".

### Example: Using Exit Predicates

```cpp
TEST(MyDeathTest, ExitsWithCodeZero) {
  EXPECT_EXIT(CleanExit(), ::testing::ExitedWithCode(0), "Cleanup successful");
}

bool KilledBySIGTERM(int exit_code) {
  return WIFSIGNALED(exit_code) && WTERMSIG(exit_code) == SIGTERM;
}

TEST(MyDeathTest, KilledBySIGTERM) {
  EXPECT_EXIT(Terminate(), KilledBySIGTERM, "Terminating by signal");
}
```

These examples demonstrate how to provide custom exit status predicates, checking for clean exit or termination by a specific signal.

---

## Death Test Syntax and Behavior

- The `statement` argument can be any valid C++ statement, including compound blocks.
- The test passes only if the statement terminates the child process.
- For `ASSERT_EXIT` and `EXPECT_EXIT`, the exit status must satisfy the predicate.
- The message output to standard error must match the `regex` or matcher.
- If the statement returns or throws an exception instead of dying, the death test fails.

### Important Notes

- Avoid using GoogleTest assertion macros that return from the current function inside the death test statement (`ASSERT_*`), as this causes the death test to fail.
- Multiple death test assertions cannot appear on the same line to avoid compilation issues.
- Side effects inside the death test statement are not visible outside since it runs in a separate process.
- When mocks are used in death tests expecting specific exit codes, leaks must be allowed to avoid false fails.

---

## Death Test Styles

GoogleTest supports two styles of running death tests:

1. **Fast Style (default on POSIX)**
   - Child process is forked and runs the death test statement immediately.
   - Faster but less thread-safe.

2. **Threadsafe Style**
   - Child process re-executes the test binary, running only the single death test.
   - Safer in multi-threaded environments but slower.

You can choose the style by setting the `--gtest_death_test_style` flag programmatically or on the command line:

```cpp
GTEST_FLAG_SET(death_test_style, "threadsafe");
```

Issues caused by multiple threads at death test invocation time will emit warnings. For complex applications with threads, prefer the thread-safe style.

---

## Step-by-Step: Creating a Death Test

<Steps>
<Step title="Write Your Death Test">
Write a test function using one of the death test macros. Pass the code that should cause death as a statement, and a regex or matcher for the expected output.

Example:

```cpp
TEST(MyTestSuite, DeathOnBadInput) {
  ASSERT_DEATH(MyFunction(-1), ".*fatal error.*");
}
```
</Step>
<Step title="Compile with GoogleTest">
Ensure your test binary is compiled and linked with GoogleTest and its dependencies.
</Step>
<Step title="Run Your Tests">
Run your test binary as usual. The death test will automatically fork a child process to execute the death-causing code.

On failure, you will see detailed output indicating whether the process actually died, if the exit code matched, and if the stderr output matched.
</Step>
<Step title="Examine Failure Messages">
If your death test fails, GoogleTest will print a detailed failure message indicating the exit result, expected output, actual output, or improper returns/exceptions.
Use this output to debug and fix the test or your implementation.
</Step>
</Steps>

---

## Best Practices and Tips

- **Name Test Suites with `DeathTest` suffix** to ensure they run early and avoid interference.
- **Use `ASSERT_DEATH` when you want to abort the test on failure**, use `EXPECT_DEATH` if you want test to continue.
- **Use regular expressions carefully in error matchers**, reusing simple substrings to avoid complexity.
- **Avoid side effects inside death test statements** as they are not seen by the parent process.
- **Run your death tests in a single-thread context** or use thread-safe style to avoid hangs or false failures.
- When using mocks in death tests, explicitly allow mock leaks with `Mock::AllowLeak` to avoid false positives.
- When testing exit codes in `ASSERT_EXIT` or `EXPECT_EXIT`, use the provided predicates `ExitedWithCode(int)` or define `KilledBySignal(int)` predicates as needed.
- Avoid placing multiple death tests on the same source line.

---

## Common Pitfalls and Troubleshooting

### Death Test Does Not Die

- Check if the statement really triggers an exit or fatal failure.
- Make sure your death test expression does not return or throw exceptions unintentionally.

### Output Does Not Match

- Regular expressions must conform to GoogleTestâ€™s supported syntax.
- Adjust your regex to match the exact stderr output, considering multi-line and special characters.

### Hanging Death Tests

- Likely caused by multi-threaded environment and using quick "fast" style death tests.
- Switch to the "threadsafe" death test style using `GTEST_FLAG_SET(death_test_style, "threadsafe");`

### Multiple Threads Warning

- GoogleTest warns if there are multiple active threads at death test invocation.
- Refactor your test environment or switch to threadsafe style.

### Death Test with Mocks Leaks Detected

- If mocks are leaked due to child process exit, mark affected mocks with `Mock::AllowLeak`.

### Invalid Death Test Style

- The flag `--gtest_death_test_style` must be either "fast" or "threadsafe".
- Typo or unsupported value causes test failure.

---

## Advanced Usage

### Using Predicates for Exit Status

- Use `::testing::ExitedWithCode(code)` predicate to check for normal exit codes.
- Use `::testing::KilledBySignal(signal_number)` predicate to check for termination by signals (POSIX only).

### DEBUG Death Tests

- Use `EXPECT_DEBUG_DEATH` or `ASSERT_DEBUG_DEATH` to enable death tests only in debug builds.
- In release mode, the statement is executed but not checked for death, preserving side effects.

### Nested or Complex Statements

- Death test statements can be compound statements enclosed in `{}`.
- Ensure no early returns or exceptions are thrown in the code under test.

---

## Troubleshooting Example

### Problem: Death Test Reports "Failed to Die"

```none
Death test: MyFunction(-1)
    Result: failed to die.
 Error msg:
[  DEATH   ] <stderr output>
```

**Cause:** The code did not cause the process to terminate.

**Solution:** Confirm the tested code triggers exit or abort as intended. Adjust test or code.

### Problem: Regex Does Not Match Error Output

```none
Death test: MyFunction(-1)
    Result: died but not with expected error.
  Expected: contains regular expression "expected error"
Actual msg:
[  DEATH   ] actual error message
```

**Cause:** Regex is too restrictive or incorrect.

**Solution:** Relax or correct the regex to fit the actual error output.

---

## Summary

Death tests are essential for verifying that your program terminates properly under error conditions. By running code in isolated processes and matching exit status and output, GoogleTest helps ensure robust failure handling.

Use `ASSERT_DEATH` and `EXPECT_DEATH` macros with clear regex matchers, choose the right death test style, and heed thread safety concerns for reliable and maintainable tests.

---

## References and Related Content

- [GoogleTest Primer](primer.md) â€” Basic understanding of writing test cases
- [Assertions Reference](reference/assertions.md#death) â€” Complete details on death test macros
- [Advanced Topics: Death Tests](advanced.md#death-tests) â€” For deeper understanding and edge cases
- [GoogleTest Source: googletest/include/gtest/gtest-death-test.h](https://github.com/google/googletest/blob/main/googletest/include/gtest/gtest-death-test.h) â€” Public API for death tests
- [GoogleTest Source: googletest/src/gtest-death-test.cc](https://github.com/google/googletest/blob/main/googletest/src/gtest-death-test.cc) â€” Internal implementation details (advanced users)

For full practical examples, refer to the [googletest-death-test-test.cc](https://github.com/google/googletest/blob/main/googletest/test/googletest-death-test-test.cc) which contains tests verifying death test behaviors.

---