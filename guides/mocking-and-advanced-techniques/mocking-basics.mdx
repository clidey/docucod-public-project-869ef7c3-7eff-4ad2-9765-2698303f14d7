---
title: "Mocking Basics: Using GoogleMock"
description: "A practical guide to writing and using mock classes and functions in C++. Learn to apply the MOCK_METHOD macro, set expectations, and organize mock-based tests for clarity and maintenance."
---

# Mocking Basics: Using GoogleMock

GoogleMock, commonly referred to as gMock, is a powerful C++ mocking framework that simplifies the process of creating mock classes and functions for unit testing. This guide will help you write and use mock classes effectively by explaining how to define mock methods, set up expectations with `EXPECT_CALL`, and organize mock-based tests for clarity and maintainability.

---

## 1. Introduction to Mock Classes

When testing components that depend on other classes or interfaces, mock classes stand in for those dependencies, allowing you to:

- Control how dependent methods respond.
- Verify how and when those methods are called.
- Keep tests clean, fast, and focused on interactions.

### Defining a Mock Class

A mock class is a normal C++ class where you replace relevant virtual methods with mock methods defined by the `MOCK_METHOD` macro:

```cpp
#include <gmock/gmock.h>

class MockFoo : public Foo {
 public:
  MOCK_METHOD(ReturnType, MethodName, (ArgTypes...), (qualifiers));
};
```

**Key points:**

- `MOCK_METHOD` takes 3 or 4 parameters:
  - Return type
  - Method name
  - Argument types (in parentheses)
  - Optional qualifiers (in parentheses), such as `const`, `override`, `noexcept`, calling convention, or reference qualifiers.
- Always define mock methods in the `public:` section, even if the base methods are `protected` or `private`. This enables gMock to access and manipulate them.

### Handling Commas in Types

If your return type or argument type includes commas (e.g., template types like `std::pair` or `std::map`), wrap the type in additional parentheses or use type aliases to avoid parsing issues:

```cpp
class MyMock {
 public:
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));

  // Alternative using type aliases
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
  using MapIntDouble = std::map<int, double>;
  MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
};
```

### Mocking Overloaded Methods

You can mock overloaded methods normally but must mock *all* versions you want to use. To avoid hiding base class overloads, use `using` declarations to bring in other overloads you *don’t* mock:

```cpp
class MockFoo : public Foo {
 public:
  using Foo::Add;  // bring in other overloads
  MOCK_METHOD(int, Add, (Element x), (override));
  // ... other mock methods ...
};
```


### Mocking Const Methods and Method Qualifiers

Add `(const)` for const methods, `(override)` to indicate overriding, or combine:

```cpp
MOCK_METHOD(int, GetSize, (), (const, override));
```  

### Mocking Class Templates

Mock class templates just like regular classes:

```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

---

## 2. Setting Expectations with EXPECT_CALL

After you have a mock class, `EXPECT_CALL` is how you set expectations about how the mock’s methods should be used during a test.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, Method(arg_matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- The first argument is the mock object.
- The second argument specifies the method and the expected arguments.
- The `.Times()` clause defines how many times the method is expected to be called.
- `.WillOnce()` specifies the behavior for a single call (can be repeated multiple times).
- `.WillRepeatedly()` specifies behavior for all calls after `.WillOnce()`s are exhausted.

### Argument Matchers

- Matchers define what argument values you expect, e.g., `5`, `_` (wildcard), `Ge(10)`, `NotNull()`, or custom matchers.
- If you omit the parameter list (only for non-overloaded methods), expectation applies to any arguments.

Example:

```cpp
EXPECT_CALL(foo, DoThis(5));         // expects argument 5
EXPECT_CALL(foo, DoThis(_));         // expects any argument
EXPECT_CALL(foo, DoSomething(Ge(10))); // expects an argument >= 10
```

### Cardinalities

Define how many times the expectation should be fulfilled:

- `Times(1)`: exactly once (default if no other clauses are present).
- `Times(AnyNumber())`: zero or more times.
- `Times(AtLeast(n))`: at least n times.
- `Times(AtMost(n))`: at most n times.
- `Times(Between(m, n))`: between m and n times (inclusive).
- `Times(0)`: never called.

Example:

```cpp
EXPECT_CALL(foo, DoThis(5)).Times(2);  // must be called exactly twice
EXPECT_CALL(foo, DoThis(6)).Times(AnyNumber());  // unlimited calls allowed
```

### Actions

Actions define what the mock method does when called:

- `Return(value)`: returns a fixed value.
- `ReturnRef(ref)`: returns a reference to an object.
- `Invoke(functor/lambda)`: calls a function, lambda, or functor.
- `DoAll(...)`: performs multiple actions in sequence.
- `SetArgPointee<N>(value)`: sets the pointee of argument N.

Example:

```cpp
EXPECT_CALL(mock, GetNumber())
  .WillOnce(Return(42))
  .WillRepeatedly(Return(7));

EXPECT_CALL(mock, Mutate(_, _))
  .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

### Setting Partial or Complex Behavior

Multiple `WillOnce` calls can specify sequential behaviors, e.g.,

```cpp
EXPECT_CALL(mock, Foo())
  .WillOnce(Return(1))
  .WillOnce(Return(2))
  .WillRepeatedly(Return(3));
```

This returns 1 on first call, 2 on second, and 3 thereafter.

### Organizing Expectations

- Later expectations override earlier matching ones.
- Use `InSequence` and `After` to enforce call order.

Example with sequence:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
```

---

## 3. Using ON_CALL to Set Default Behavior

While `EXPECT_CALL` sets an expectation that the method *must* be called, `ON_CALL` sets the default behavior but doesn’t impose a call expectation.

Example:

```cpp
ON_CALL(mock, GetSize()).WillByDefault(Return(10));
```

If no EXPECT_CALL matches the method call, the action set by `ON_CALL` is executed.

**Best practice:**

- Use `ON_CALL` in test setup or constructors to define general default behavior.
- Use `EXPECT_CALL` in each test to specify exactly what calls you expect.

---

## 4. Controlling Mock Object Behavior With NiceMock, StrictMock, and NaggyMock

GoogleMock provides helper templates to control the handling of *uninteresting calls* (calls to methods without expectations):

| Mock Type  | Behavior on Calls Without EXPECT_CALL                     |
|------------|----------------------------------------------------------|
| `NiceMock` | Suppresses warnings (quiet)                              |
| `NaggyMock`| Emits warnings (default behavior)                         |
| `StrictMock`| Fails tests if called unexpectedly (errors)             |

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_mock;
```

Use these as wrappers around your mock classes to control noise and strictness.

---

## 5. Organizing Tests with Mock Classes

Here is the typical workflow:

1. Define your mock class with `MOCK_METHOD` macros for relevant methods.
2. In your test, create a mock object.
3. Use `ON_CALL` in test setup to define default behaviors.
4. Use `EXPECT_CALL` in your test to specify what calls you expect.
5. Exercise the system under test that uses the mock.
6. When the mock is destroyed, gMock automatically verifies all expectations.

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  ON_CALL(turtle, GetX()).WillByDefault(Return(0));
  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
  EXPECT_CALL(turtle, Forward(100));

  Painter p(&turtle);
  EXPECT_TRUE(p.DrawCircle(0, 0, 100));
}
```

---

## 6. Best Practices and Tips

- **Set expectations before exercising the mock.** Setting expectations afterward leads to undefined behavior.
- **Avoid over-specification.** Only specify what matters to your test.
- **Use sequences and `.After()` for strict or partial call ordering.**
- **Use `RetiresOnSaturation()` to retire expectations after saturation when appropriate.**
- **Wrap mocks in `NiceMock` or `StrictMock` depending on desired verbosity and strictness.**
- **For mocking move-only types, use lambdas or callable objects for actions.**
- **Use `ON_CALL` to provide common default behavior shared among tests.**

---

## 7. Troubleshooting Common Issues

- *Unexpected calls:* Check if an `EXPECT_CALL` covers the method and arguments called.
- *Uninteresting call warnings:* Switch to `NiceMock` or add catch-all expectations.
- *Overly strict expectations:* Use fuzzy cardinalities like `AtLeast` or `AnyNumber`.
- *Compilation errors with commas:* Use parentheses or type aliases to wrap argument or return types.
- *Testing move-only types:* Use `WillOnce` with lambdas to generate new instances for each call.

For detailed troubleshooting, consult the [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html).

---

## 8. Additional Resources

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) — Beginner-friendly tutorial
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Practical examples and recipes
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) — API reference
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) — Argument validation
- [Actions Reference](https://google.github.io/googletest/reference/actions.html) — Actions to define mock behavior

---

## 9. Summary

GoogleMock lets you create mock classes by defining methods with `MOCK_METHOD`, set expectations on interactions with `EXPECT_CALL`, and specify default mock actions with `ON_CALL`. Use provided helper classes like `NiceMock` or `StrictMock` to control warning verbosity. Following the guidance here will allow you to write clear, maintainable, and robust tests that effectively verify interactions between components.

---

<AccordionGroup title="Code Examples">
<Accordion title="Defining a Mock Class">
```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```
</Accordion>
<Accordion title="Setting Expectations with EXPECT_CALL">
```cpp
using ::testing::Return;

MockTurtle mock_turtle;

EXPECT_CALL(mock_turtle, Forward(100))
    .Times(AtLeast(1));
EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```
</Accordion>
<Accordion title="Setting Default Behavior with ON_CALL">
```cpp
ON_CALL(mock_turtle, GetX()).WillByDefault(Return(10));
```
</Accordion>
<Accordion title="Expectations with Sequences">
```cpp
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(mock_turtle, PenDown());
  EXPECT_CALL(mock_turtle, Forward(100));
  EXPECT_CALL(mock_turtle, PenUp());
}
```
</Accordion>
<Accordion title="Handling Move-Only Types">
```cpp
class MockBuzzer : public Buzzer {
 public:
  MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
};

EXPECT_CALL(mock_buzzer, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
        return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```
</Accordion>
</AccordionGroup>

<Tip>
Always define `MOCK_METHOD`s in the public section of your mock class regardless of base function’s visibility to ensure `EXPECT_CALL` and `ON_CALL` can access them.
</Tip>

<Warning>
Do not set new expectations on a mock after it has been used to exercise code; doing so leads to undefined behavior and unreliable tests.
</Warning>

<Note>
Use `EXPECT_CALL` to verify interactions and `ON_CALL` to set default behaviors without matching expectations, helping you balance test strictness and maintainability.
</Note>

---

## 10. Navigational Context

This guide fits within the broader documentation ecosystem as an introductory guide to GoogleMock mocking techniques. Users looking for more foundational knowledge should consult [Writing Your First Test](guides/getting-started/writing-your-first-test.md) and [Core Concepts & Test Anatomy](guides/getting-started/core-concepts-and-anatomy.md). After mastering basics here, users should explore advanced usage in [Actions and Expectations](guides/mocking-and-advanced-techniques/actions-and-expectations.md) and [Advanced Mocking Patterns](guides/mocking-and-advanced-techniques/advanced-mocking-patterns.md).

---

## 11. Troubleshooting

<AccordionGroup title="Common Issues and Solutions">
<Accordion title="Mock Method Parsing Errors from Commas">
Wrap complex types containing commas in extra parentheses or use type aliases to avoid `MOCK_METHOD` parsing errors.
</Accordion>
<Accordion title="Unexpected Calls Despite ON_CALL">
Make sure to add an `EXPECT_CALL` if you want gMock to expect a call. `ON_CALL` only sets default behavior, not expectations.
</Accordion>
<Accordion title="Uninteresting Call Warnings">
Use `NiceMock` wrapper around your mock class to suppress warnings about uninteresting calls.
</Accordion>
<Accordion title="Return Values for Move-Only Types Don't Work as Expected">
Use lambdas or callable objects in `WillOnce`/`WillRepeatedly` to create new instances for each call, avoiding issues with move-only types.
</Accordion>
<Accordion title="Why Are My Expectations Not Met?">
Run tests with `--gmock_verbose=info` flag to see detailed evaluation of calls and matchers to diagnose expectation mismatches.
</Accordion>
</AccordionGroup>

---
