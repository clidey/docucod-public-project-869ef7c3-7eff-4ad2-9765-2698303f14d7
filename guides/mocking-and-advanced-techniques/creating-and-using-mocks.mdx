---
title: "Creating and Using Mocks"
description: "Step-by-step instructions for defining mock classes, using EXPECT_CALL and ON_CALL for behavior specification, and controlling mock object strictness. Perfect for users needing to isolate and validate C++ components."
---

# Creating and Using Mocks

This guide will empower you to define mock classes, set up expectations with `EXPECT_CALL`, specify default behaviors with `ON_CALL`, and control how strictly your mocks enforce their contracts. Ideal for C++ developers seeking to isolate components and validate interactions within their code.

---

## 1. Understanding Mock Classes

Mock classes simulate the behavior of real objects by implementing the same interface but allowing detailed control over interactions and returned values. GoogleMock uses the `MOCK_METHOD` macro to declare mock methods inside your mock class.

### Defining a Mock Class

- Inherit from the interface or base class you want to mock.
- Declare each virtual method to be mocked using `MOCK_METHOD` in the `public:` section.
- Include any qualifying specifiers (like `const`, `override`, or `noexcept`) in the macro.

Example:

```cpp
#include <gmock/gmock.h>

class Interface {
 public:
  virtual ~Interface() = default;
  virtual int GetValue() const = 0;
  virtual void SetValue(int value) = 0;
};

class MockInterface : public Interface {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, SetValue, (int value), (override));
};
```

<Tip>
Always place `MOCK_METHOD` declarations in the `public:` section, even if the original method is not public. This ensures that GoogleMock can access them for expectation and behavior specification.
</Tip>

### Dealing with Complex Types

If your method's return or argument types contain commas (e.g., `std::pair<int, int>`), wrap those types with extra parentheses or use a `using` alias to avoid macro parsing issues.

```cpp
using PairInt = std::pair<int, int>;
MOCK_METHOD(PairInt, GetPair, ());
```

---

## 2. Setting Expectations with EXPECT_CALL

Use `EXPECT_CALL` to specify how your mock method is expected to be called during a test.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- **mock_object**: The mock instance.
- **MethodName**: The mock method name.
- **matchers**: Argument matchers that define what arguments are expected (use `_` for "any").
- **Times()**: How many times the method may be called (e.g., `Times(1)`, `Times(AnyNumber())`).
- **WillOnce() and WillRepeatedly()**: Actions the mock performs when called.

### Example

```cpp
using ::testing::_;
using ::testing::Return;

MockInterface mock;

EXPECT_CALL(mock, GetValue())
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));

// Usage will return 10, then 20, and 30 thereafter
```

### Important Clauses

- `.With()`: Apply a matcher to all arguments as a tuple.
- `.InSequence()`: Enforce call order.
- `.After()`: Define prerequisite calls.
- `.RetiresOnSaturation()`: Deactivate expectation after it is fulfilled.

<Tip>
If you omit `.Times()`, GoogleMock infers the expected call count based on your `WillOnce` and `WillRepeatedly` clauses. For example, if you specify two `WillOnce` actions, `.Times(2)` is inferred.
</Tip>

### Notes on Ordering

- Expectations are evaluated in reverse order, so the last matching `EXPECT_CALL` takes precedence.
- To require calls to occur in specific order, use `InSequence` or the `After` clause.

---

## 3. Specifying Default Behavior with ON_CALL

`ON_CALL` sets what should happen when the mock method is called but does *not* set an expectation that it must be called.

### Basic Syntax

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .With(multi_argument_matcher) // optional
    .WillByDefault(action);       // required
```

- `WillByDefault()` defines the default behavior when no matching `EXPECT_CALL` is found.

### Example

```cpp
using ::testing::_;
using ::testing::Return;

MockInterface mock;

ON_CALL(mock, GetValue())
    .WillByDefault(Return(42));

// Now, if you call mock.GetValue() without any expectation,
// it returns 42.
```

<Tip>
Use `ON_CALL` mainly in test fixture setup to define general default mock behavior. Use `EXPECT_CALL` to verify specific call behaviors and counts.
</Tip>

---

## 4. Controlling Mock Object Strictness

GoogleMock provides three wrappers to control how strictly uninteresting calls (calls without matching expectations) are treated.

| Mock Wrapper          | Behavior on uninteresting calls                      |
|----------------------|----------------------------------------------------|
| `NiceMock<T>`        | Suppresses warnings for uninteresting calls.       |
| `NaggyMock<T>`       | Prints warnings (default behavior).                 |
| `StrictMock<T>`      | Treats uninteresting calls as failures.             |

### Usage Example

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockInterface> nice_mock;    // Will ignore unexpected calls
StrictMock<MockInterface> strict_mock; // Will fail on unexpected calls
```

<Tip>
Choose the mock strictness based on your testing needs. While `StrictMock` helps catch unintended calls, it can make tests brittle. `NiceMock` reduces noise but should be used thoughtfully.
</Tip>

---

## 5. Practical Workflow for Using Mocks

<Steps>
<Step title="Define your mock class">
Derive a class from your interface and use `MOCK_METHOD` to declare mock methods.
</Step>
<Step title="Create mock objects in your tests">
Instantiate your mock class (or use strict/nice wrappers as needed).
</Step>
<Step title="Set default behaviors with ON_CALL">
Set common mock method behaviors, typically in your test fixture or setup function.
</Step>
<Step title="Set expectations with EXPECT_CALL">
Specify how your tests expect the mock methods to be called, including argument matchers, cardinalities, and actions.
</Step>
<Step title="Exercise your code">
Run code that uses the mock object.
</Step>
<Step title="Verify and clean up">
GoogleMock automatically verifies expectations on mock destruction. You can also manually verify and clear expectations.
</Step>
</Steps>

---

## 6. Examples

### Simple Mock Class and Usage

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class Interface {
 public:
  virtual ~Interface() = default;
  virtual int Compute(int x) const = 0;
};

class MockInterface : public Interface {
 public:
  MOCK_METHOD(int, Compute, (int x), (const, override));
};

TEST(ExampleTest, BasicMockUsage) {
  MockInterface mock;

  ON_CALL(mock, Compute(_))
      .WillByDefault(testing::Return(10));

  EXPECT_CALL(mock, Compute(5))
      .Times(1)
      .WillOnce(testing::Return(15));

  // Will return 15 as per EXPECT_CALL
  int result1 = mock.Compute(5);
  EXPECT_EQ(result1, 15);

  // Returns default 10 as per ON_CALL
  int result2 = mock.Compute(7);
  EXPECT_EQ(result2, 10);
}
```

### Using NiceMock to Suppress Warnings

```cpp
using ::testing::NiceMock;

NiceMock<MockInterface> nice_mock;

EXPECT_CALL(nice_mock, Compute(7)).WillOnce(testing::Return(20));

// Calling Compute with unexpected value won't print warnings
int value = nice_mock.Compute(42);
```

### Sequence Expectations

```cpp
using ::testing::InSequence;

TEST(SequenceTest, EnforcesCallOrder) {
  MockInterface mock;
  InSequence seq;

  EXPECT_CALL(mock, Compute(1));
  EXPECT_CALL(mock, Compute(2));

  mock.Compute(1);  // OK
  mock.Compute(2);  // OK
}
```

---

## 7. Troubleshooting & Tips

### Common Issues

- **Uninteresting call warnings:** If you see warnings about uninteresting mock calls, consider whether the calls are expected. Use `NiceMock` to suppress if appropriate, or add `EXPECT_CALL(...).Times(AnyNumber())`.
- **Unexpected call errors:** Occur when a call is made but no `EXPECT_CALL` matches the arguments.
- **Mock method not called:** Verify that your code exercised the mock and that expectations are properly specified before the code runs.
- **Mock methods not overriding base class:** Ensure methods are `virtual` and that `MOCK_METHOD` includes `(override)`.

### Best Practices

- Define clear and minimal expectations to avoid brittle tests.
- Use argument matchers like `_` or custom matchers to relax argument constraints.
- Use `.RetiresOnSaturation()` to avoid “sticky” expectations staying active after use.
- Wrap expectations in `InSequence` for strict call order when required.
- Use `ON_CALL` for default mock behaviors shared across tests.

### Performance Considerations

- Move mock class constructors and destructors to `.cc` files to reduce compilation time in large projects.
- Avoid excessive or overly complex expectations.

---

## 8. Next Steps & Related Content

### What’s Next?

- Start applying mocks in your unit tests for dependency isolation and precise interaction verification.
- Explore advanced features like custom matchers and actions.
- Familiarize yourself with test organization and parameterized testing to scale your testing efforts.

### Related Guides

- [Writing Your First Test & Mock](/getting-started/first-run-usage/writing-first-test)
- [Using Matchers for Powerful Validations](/guides/core-testing-patterns/using-matchers)
- [Mocking Best Practices & Death Tests](/guides/mocking-and-advanced-techniques/best-practices-and-death-tests)
- [Troubleshooting & Quick Validation](/getting-started/first-run-usage/troubleshooting-quick-validation)

### Resources

- Official GoogleMock documentation: https://google.github.io/googletest/gmock_for_dummies.html
- GoogleTest repository on GitHub: https://github.com/google/googletest

---

## 9. Additional Tips

- Use `Mock::VerifyAndClearExpectations(&mock_obj);` to manually verify mock expectations early if needed.
- To avoid memory leaks failing your tests, enable heap checker or use smart pointers for mock objects.
- Remember that expectations must be set before the calls to the mocks occur.

---

By following this guide, you will be equipped to create meaningful mock classes, specify exact or flexible call expectations, and manage mock object strictness to achieve robust, maintainable, and scalable C++ tests.
