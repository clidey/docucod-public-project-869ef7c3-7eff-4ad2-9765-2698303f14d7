---
title: "Mastering Matchers and Actions"
description: "Detailed exploration of matchers and actions—the backbone of expressive, flexible testing with GoogleMock. See how to use built-in and custom matchers, chain expectations, and define custom actions to simulate complex behaviors and data flows in tests."
---

# Mastering Matchers and Actions

Welcome to the essential guide for mastering matchers and actions in GoogleMock—the core tools that empower you to write expressive, flexible, and precise tests. This page explores how to leverage built-in and custom matchers to specify exactly what arguments your mocks should expect, chain these expectations logically, and define custom actions that simulate complex behaviors, allowing you to simulate real-world scenarios efficiently.

---

## Workflow Overview

### What This Guide Helps You Accomplish

This guide dives deep into the mechanics of matchers and actions in GoogleMock, offering practical knowledge to:

- Precisely match expected arguments in mocked function calls using built-in and custom matchers.
- Combine multiple matchers for complex argument verification scenarios.
- Chain multiple expectations and define order constraints through `InSequence` and `After` clauses.
- Define mock behaviors via built-in or user-defined custom actions.
- Understand the distinction between `EXPECT_CALL` and `ON_CALL` with their respective clauses.

### Prerequisites

Before proceeding, ensure:

- You have a working mock class with mocked methods defined using `MOCK_METHOD`.
- GoogleMock is correctly installed and configured in your project.
- Basic familiarity with C++ and GoogleTest assertions.
- Understanding of how to write simple `EXPECT_CALL` and `ON_CALL` statements.

### Expected Outcome

By following this guide, you will be able to:

- Accurately specify argument expectations for your mocks.
- Control invocation order and count with powerful cardinality and sequencing clauses.
- Customize mock method behaviors to return values, invoke callbacks, set output parameters, or throw exceptions.
- Extend GoogleMock with your own custom matchers and actions tailored to domain-specific requirements.

### Time Estimate & Difficulty

- **Time**: Approximately 30-45 minutes for a thorough reading and hands-on experimentation.
- **Difficulty**: Intermediate-level, suitable for testers and developers familiar with basic mocking concepts seeking to deepen expertise.

---

## Mastering Matchers

### What Are Matchers?

Matchers describe the criteria that arguments to mocked methods must satisfy for an expectation to be considered matched. Instead of hardcoding exact values, they let you specify flexible rules, from simple equality to complex predicates.

### Using Built-in Matchers

- The wildcard matcher `_` matches any argument.
- Equality matchers like `Eq(value)` match exact values.
- Ordering matchers such as `Lt()`, `Le()`, `Gt()`, `Ge()` match relational conditions.
- Logical combinators like `AllOf()`, `AnyOf()`, and `Not()` combine matchers for advanced checks.

```cpp
EXPECT_CALL(mock, Process(Ge(5), Not(Eq(10))));
```
This expects the first argument to be >=5 and the second argument not equal to 10.

### Matching Multiple Arguments as a Whole

Sometimes you need to create constraints involving multiple arguments simultaneously, for example, ensuring the first argument is less than the second. Use the `.With()` clause with multi-argument matchers:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // First < Second
```

You can also specify specific argument subsets using `Args<N1, N2, ...>(matcher)`.

### Custom Matchers

For domain-specific validations, define your own matchers using the `MATCHER` or `MATCHER_P` macros. For example:

```cpp
MATCHER(IsDivisibleBy7, "") { return (arg % 7) == 0; }
```
Usage:

```cpp
EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```
Custom matchers help keep test code clean and error messages descriptive.

### Matching Non-copyable Arguments

If an argument cannot be copied, wrap it with `Truly()` and supply a predicate:

```cpp
EXPECT_CALL(mock, Bar(Truly(IsEven)));
```
For references, use `SafeMatcherCast<T>()` to assist type conversion when needed.

### Tips and Best Practices

- Avoid over-specifying arguments — use `_` where the argument value is irrelevant.
- Compose matchers with logical combinators for expressive tests.
- When matching containers, prefer `ElementsAre()` or `UnorderedElementsAre()`.
- Ensure custom matchers are pure functions with no side effects.

---

## Understanding Expectation Clauses

### `EXPECT_CALL` Clauses Overview

After specifying `EXPECT_CALL(mock, method(matchers))`, you can chain clauses to refine the expectation:

- `.With(multi_argument_matcher)` – for multi-arg constraints (must be first if used).
- `.Times(cardinality)` – specify how many times the call should happen.
- `.InSequence(sequences...)` – enforce call order.
- `.After(expectations...)` – expectation ordering based on other calls.
- `.WillOnce(action)` – action to perform on the next matched call.
- `.WillRepeatedly(action)` – action to perform on all subsequent calls.
- `.RetiresOnSaturation()` – deactivate the expectation once saturated.

The order and usage restrictions are important; improper chaining will trigger runtime errors.

### Cardinalities (Call Counts)

Control how often an expectation matches with clauses like:

- `Times(1)` (default)
- `Times(AnyNumber())`
- `Times(AtLeast(n))`
- `Times(AtMost(n))`
- `Times(Between(m, n))`
- `Times(Exactly(n))` or `Times(n)`

Example:

```cpp
EXPECT_CALL(mock, Foo(_))
    .Times(AtLeast(2));
```

### Sequencing and Ordering

To enforce call order:

- Use `InSequence` blocks:

  ```cpp
  {
    InSequence s;
    EXPECT_CALL(mock, FirstCall());
    EXPECT_CALL(mock, SecondCall());
  }
  ```

- Use explicit `Sequence` objects:

  ```cpp
  Sequence seq1, seq2;
  EXPECT_CALL(mock, Setup()).InSequence(seq1);
  EXPECT_CALL(mock, Execute()).InSequence(seq1, seq2);
  EXPECT_CALL(mock, Cleanup()).InSequence(seq2);
  ```

- Use `.After(expectation)` clause to specify calls must occur after other expectations.

### Sticky vs Retiring Expectations

Expectations remain active even after meeting their expected call count ("sticky") unless:

- `.RetiresOnSaturation()` is used to disable the expectation once saturated.
- Expectations inside `InSequence` blocks retire automatically once the sequence advances.

### Common Pitfalls

- Forgetting `.RetiresOnSaturation()` when expecting multiple sequential `WillOnce()` actions leads to early failures.
- Ordering expectations incorrectly will cause unexpected call errors.

---

## Defining and Using Actions

### What Are Actions?

Actions specify what the mock method does when called: return a value, modify arguments, throw exceptions, invoke callbacks, or user-defined behaviors.

### Built-in Actions

| Action                | Description                                   |
|-----------------------|-----------------------------------------------|
| `Return(value)`       | Return a specified value.                      |
| `ReturnRef(variable)` | Return a reference to a variable.             |
| `ReturnPointee(ptr)`  | Return the object pointed to by a pointer.    |
| `SetArgPointee<N>(v)` | Set the Nth argument's pointee to value v.    |
| `DeleteArg<N>()`      | Delete the Nth argument (must be pointer).    |
| `DoDefault()`         | Use the default action (from ON_CALL or built-in). |
| `Throw(exception)`    | Throw an exception.                            |

Example:

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(42));

EXPECT_CALL(mock, GetRef())
    .WillRepeatedly(ReturnRef(my_var));

EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(7), Return(true)));
```

### Using Functions and Lambdas as Actions

You can specify arbitrary functions, functors, or lambdas:

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(Invoke([](int val) { return val * 2; }));
```

### Chaining Actions

Use `DoAll()` to perform multiple actions in sequence (all but last return `void`):

```cpp
EXPECT_CALL(mock, DoSomething(_))
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)));
```

### Actions for Move-only Types

For methods taking or returning move-only types like `std::unique_ptr`, use lambdas or return move-wrapped values via `ByMove()` (from recent GoogleMock versions).

### Advanced Action Adaptors

- `WithArg<N>(action)` passes specific argument as the only parameter to the inner action.
- `WithArgs<N1, N2, ...>(action)` passes a selected tuple of arguments.
- `WithoutArgs(action)` ignores all arguments.
- `InvokeArgument<N>(args...)` calls the Nth argument as a callback.

### Writing Custom Actions

You can define your own actions using `ACTION` macros or by implementing the action interface manually when built-in actions are insufficient.

Example:

```cpp
ACTION(IncrementArg1) { (*arg1)++; return *arg1; }
```
Usage:

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg1());
```

---

## ON_CALL vs EXPECT_CALL

### ON_CALL

Defines default behavior for mock methods without asserting that they must be called.

```cpp
ON_CALL(mock, GetName()).WillByDefault(Return("John"));
```

- Cannot have `.Times()` clause.
- Uses `.WillByDefault()` to specify behavior.

### EXPECT_CALL

Defines an expectation that the method will be called with specific arguments, times, and order, and specifies what to do on those calls.

Use `EXPECT_CALL` if your test must verify the call happens.

### Best Practice

- Use ON_CALL to set common default behaviors once, typically in mock constructor or fixture setup.
- Use EXPECT_CALL sparingly in tests to assert important interactions.

---

## Practical Examples

### Example 1: Specifying Argument Matchers

```cpp
using ::testing::_, ::testing::Gt, ::testing::Return;

EXPECT_CALL(mock, Process(Gt(10)))
    .WillOnce(Return(true));
```
Expect `Process()` is called with an argument greater than 10 and returns true.

### Example 2: Chaining Multiple Expectations in Sequence

```cpp
using ::testing::InSequence;
Using ::testing::Return;

{
  InSequence seq;

  EXPECT_CALL(mock, Initialize())
      .WillOnce(Return(true));
  EXPECT_CALL(mock, Execute())
      .WillOnce(Return(42));
  EXPECT_CALL(mock, Cleanup())
      .WillOnce(Return());
}
```
Calls must occur in the order: Initialize, Execute, Cleanup.

### Example 3: Custom Matcher

```cpp
MATCHER(IsPositiveEven, "is a positive even number") {
  return arg > 0 && arg % 2 == 0;
}

EXPECT_CALL(mock, Compute(IsPositiveEven()));
```

### Example 4: Using Actions to Set Output Parameters and Return Value

```cpp
EXPECT_CALL(mock, GetData(_, _))
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)));
```
Sets the first pointer argument's pointed value to 10 and returns true.

---

## Troubleshooting & Tips

### Common Issues

- **Overlapping Expectations**: Newly added expectations override older ones. Always place more specific expectations last.
- **Forget Retiring Saturated Expectations**: Without `.RetiresOnSaturation()`, saturated expectations remain active causing call count errors.
- **Improper Clause Order**: Misordering `.With()`, `.Times()`, `.InSequence()`, `.WillOnce()`, `.WillRepeatedly()`, `.RetiresOnSaturation()` will result in runtime errors.
- **Unexpected Calls**: Ensure all invoked mock methods have matching expectations or default actions.
- **Incorrect Matcher Types**: Use `SafeMatcherCast` to adjust matcher types when needed.

### Best Practices

- Use wildcard matcher `_` liberally to avoid brittle tests.
- Leverage `InSequence` or explicit `Sequence` objects to enforce call order.
- Use `ON_CALL` for default behaviors shared across tests.
- Define custom matchers for clarity and reuse.
- Prefer lambdas or callable objects for complex custom actions.

### Performance Consideration

Moving large expectation sets or complex custom actions may impact compilation time. Define complex mocks and actions in dedicated source files to optimize this.

---

## What's Next?

- Explore the [Using Mocks: Patterns and Best Practices](https://google.github.io/googletest/guides/mocking-and-advanced-techniques/using-mocks) guide for advanced design patterns.
- Learn about [Advanced Mocking Patterns & Test Design](https://google.github.io/googletest/guides/mocking-and-advanced-techniques/advanced-mocking-patterns) to write highly maintainable tests.
- Deep dive into [Custom Matchers and Actions](https://google.github.io/googletest/concepts/extending), to create powerful extensions.
- Understand the [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) and [Actions Reference](https://google.github.io/googletest/reference/actions.html) for complete lists and details.


---

<Source url="https://github.com/google/googletest" paths={[{"path": "docs/reference/mocking.md", "range": "35-206"}, {"path": "docs/gmock_cook_book.md", "range": "40-460"}, {"path": "docs/reference/actions.md", "range": "20-122"}, {"path": "googlemock/test/gmock-spec-builders_test.cc", "range": "90-395"}]} branch="main" />
