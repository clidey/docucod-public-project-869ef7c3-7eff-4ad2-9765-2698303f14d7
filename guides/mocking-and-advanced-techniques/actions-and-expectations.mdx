---
title: "Configuring Actions & Expectations"
description: "Deep-dive into ON_CALL, EXPECT_CALL, and specifying argument matchers, call cardinalities, and custom actions. Illustrates how to gain fine-grained control over mock behavior and validate interactions."
---

# Configuring Actions & Expectations

Deep-dive into ON_CALL, EXPECT_CALL, and specifying argument matchers, call cardinalities, and custom actions. This guide illustrates how to gain fine-grained control over mock behavior and validate interactions using GoogleMock.

---

## Workflow Overview

### Task Description
Learn how to configure mock behaviors and expectations in your tests using `ON_CALL` and `EXPECT_CALL` statements. This document explains how to specify argument matchers, control call counts, sequence calls, and define custom actions to closely control mock interactions.

### Prerequisites
- Familiarity with GoogleMock basics such as creating mock classes and mock objects.
- Understanding of the interface being mocked and the testing use cases.

### Expected Outcome
After completing this guide, you will be able to:
- Define default behaviors with `ON_CALL`.
- Specify precise expectations on method calls using `EXPECT_CALL`.
- Use argument matchers to validate parameters.
- Control call cardinalities (number of times a method is called).
- Manage order of calls with sequences and partial orderings.
- Use custom and built-in actions for flexible mock responses.

### Time Estimate
Approximately 20-30 minutes.

### Difficulty Level
Intermediate

---

## Detailed Instructions

### 1. Understanding `ON_CALL` and `EXPECT_CALL`

- **`ON_CALL`** defines the <u>default behavior</u> for methods when they are called, but does <strong>not</strong> set an expectation that the method must be called.
- **`EXPECT_CALL`** both defines behavior and sets an expectation that a method <u>will be called</u> matching the specified criteria.

> **Best Practice:** Use `ON_CALL` to specify default stub behavior for mock methods, and reserve `EXPECT_CALL` for verifying specific interactions.

### 2. Writing `ON_CALL`

Syntax:
```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher) // Optional
    .WillByDefault(action);  // Required
```
- `.With()` applies an additional matcher on all arguments combined (tuple matcher).
- `.WillByDefault()` defines the default action, such as `Return()`, a lambda, or other built-in/custom actions.

> If a mock method is called but no expectation matches, the `ON_CALL` defined action handles the call.

### 3. Writing `EXPECT_CALL`

Syntax:
```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_arg_matcher)       // Optional; only once
    .Times(cardinality)            // Optional; only once
    .InSequence(sequences...)      // Optional; multiple times
    .After(expectations...)        // Optional; multiple times
    .WillOnce(action)              // Optional; multiple times
    .WillRepeatedly(action)        // Optional; once
    .RetiresOnSaturation();        // Optional; once
```

- `.With()` restricts the expectation to calls whose arguments as a whole match the given tuple matcher.
- `.Times()` controls how many times this call is expected:
  - `AnyNumber()`, `Exactly(n)`, `AtLeast(n)`, `AtMost(n)`, `Between(m, n)` supported.
- `.InSequence()` and `.After()` enforce call ordering.
- `.WillOnce()` and `.WillRepeatedly()` specify what the method does when called.
- `.RetiresOnSaturation()` retires the expectation after max calls,
  allowing later expectations to match.

> **Note:** By default, call cardinalities are inferred from the number of `.WillOnce()` and `.WillRepeatedly()` clauses if `.Times()` is omitted.

### 4. Specifying Argument Matchers

- Use exact values, e.g., `EXPECT_CALL(foo, Bar(5));`
- Use wildcards `_` for ignoring arguments.
- Use built-in matchers (e.g., `Gt()`, `Le()`, `NotNull()`).
- Combine matchers using `AllOf()`, `AnyOf()`, `Not()`, etc.
- Use `.With()` for matching combined argument tuples, e.g. `EXPECT_CALL(foo, Baz(_, _)).With(Lt());` means first argument < second.

### 5. Handling Overloaded Methods

- If your mock's method is overloaded, provide explicit parameter lists.
- Use `Const()` to disambiguate const vs non-const overloaded methods.

Example:
```cpp
EXPECT_CALL(foo, OverloadedMethod(5));            // Non-const
EXPECT_CALL(Const(foo), OverloadedMethod(5));     // Const version
```

### 6. Controlling Call Cardinalities

- Use `.Times()` with cardinalities such as `Exactly(3)`, `AtLeast(1)`, or `AnyNumber()` to control expected call counts.
- Setting `.Times(0)` asserts that a call must never occur.

If `.Times()` is omitted, gMock infers cardinaility: 
- No `.WillOnce()` or `.WillRepeatedly()` implies `Times(1)`.
- `.WillOnce()` clauses without `.WillRepeatedly()` imply `Times(n)`, where n is the count of `.WillOnce()`.
- `.WillRepeatedly()` with `.WillOnce()` implies `Times(AtLeast(n))`.

### 7. Defining Actions: What Should the Mock Do?

- Use `.WillOnce(action)` to specify the behavior for a particular call.
- Use `.WillRepeatedly(action)` for behavior after `.WillOnce()` calls are exhausted.
- Built-in actions include `Return()`, `ReturnRef()`, `SetArgPointee<N>(value)`, `Invoke()`, `DoAll()`, etc.
- You can specify lambdas or functors for custom behavior.

Example:
```cpp
EXPECT_CALL(mock, GetValue())
     .WillOnce(Return(10))
     .WillRepeatedly(Return(20));
```

### 8. Managing Call Order

- Use `InSequence` object to put expectations in strict sequential order:
  ```cpp
  {
    InSequence seq;
    EXPECT_CALL(mock, Foo());
    EXPECT_CALL(mock, Bar());
  }
  ```
- Use `.After()` clauses to specify partial ordering, with `Expectation` or `ExpectationSet`.

### 9. Retiring Expectations

- Without `.RetiresOnSaturation()`, an expectation remains active even after being saturated, causing failures on excess calls.
- Use `.RetiresOnSaturation()` to make expectation inactive once saturated, allowing fallback to other expectations.

### 10. Use Cases for `ON_CALL` vs `EXPECT_CALL`

- Use `ON_CALL` for defining default or fallback behavior, often set up once in constructor or test setup.
- Use `EXPECT_CALL` for specifying what calls must happen and how many times, usually prominently setting behavior and verification.

### 11. Dealing with Multiple Expectations on the Same Method

- Later `EXPECT_CALL`s override earlier ones (last wins).
- Place general (catch-all) expectations first and more specific expectations later.

Example:
```cpp
EXPECT_CALL(mock, DoSomething(_)).Times(AnyNumber());  // general fallback
EXPECT_CALL(mock, DoSomething(5)).Times(2);           // more specific
```
Calls to `DoSomething(5)` match the more specific expectation.

### 12. Tips & Best Practices

- Avoid over-specifying arguments to prevent brittle tests.
- Use `_` wildcard when argument value is irrelevant.
- Suppress warnings for uninteresting calls with `NiceMock` or `EXPECT_CALL(...).Times(AnyNumber())`.
- Verify expectations explicitly with `Mock::VerifyAndClearExpectations()` when mock lifetime is complex.
- Use descriptive `.Description()` to give human-readable names to expectations.
- Always set `ON_CALL` before passing mocks to code under test to avoid undefined behavior.

### 13. Troubleshooting Common Issues

- Unexpected calls occur when arguments don't match any `EXPECT_CALL` - examine your matchers carefully.
- Upper-bound violations when calls exceed `.Times()` limits - consider `.RetiresOnSaturation()` or `.Times(AnyNumber())`.
- Uninteresting calls warning indicate methods called without any expectation - define `ON_CALL` or use `NiceMock`.
- Ordering failures with `InSequence` and `After` - ensure sequences and expectations correctly express the intended order.

---

## Code Examples

### Basic Use of `ON_CALL` and `EXPECT_CALL`

```cpp
using ::testing::_;  // Wildcard matcher
using ::testing::Return;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), (override));
  MOCK_METHOD(void, DoSomething, (int x), (override));
};

TEST(FooTest, Example) {
  MockFoo mock;

  // Set default behavior returning 42 whenever GetValue is called
  ON_CALL(mock, GetValue()).WillByDefault(Return(42));

  // Expect DoSomething(5) to be called exactly twice
  EXPECT_CALL(mock, DoSomething(5)).Times(2);

  // Code under test
  mock.DoSomething(5);  // satisfies the expectation
  mock.DoSomething(5);  // satisfies the expectation

  EXPECT_EQ(mock.GetValue(), 42);  // Uses default action
}
```

### Using Argument Matchers and With Clause

```cpp
using ::testing::_;  // Wildcard
using ::testing::Lt; // Less than
using ::testing::Return;

EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt())  // first arg < second arg
    .Times(AnyNumber())
    .WillRepeatedly(Return(true));
```

### Sequencing Calls with `InSequence`

```cpp
using ::testing::InSequence;

{
  InSequence seq;

  EXPECT_CALL(mock, Start()).Times(1);
  EXPECT_CALL(mock, Process(5)).Times(1);
  EXPECT_CALL(mock, Finish()).Times(1);
}

// Calls to mock must be Start(), Process(5), then Finish()
```

### Specifying Return Values for Multiple Calls

```cpp
using ::testing::Return;

EXPECT_CALL(mock, GetX())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

---

## Troubleshooting & Tips

- **Problem:** Mock method unexpectedly calls the real implementation.
  - Ensure the method in the base class is `virtual`.

- **Problem:** Uninteresting call warnings appear.
  - Use `NiceMock` to suppress warnings or define catch-all `EXPECT_CALL(...).Times(AnyNumber())`.

- **Problem:** Tests fail due to incorrect call order.
  - Verify `InSequence` blocks and `.After()` clauses correctly define the order.

- **Problem:** Mock object leaks causing expectations not to verify.
  - Confirm that mocks have virtual destructors and are properly deleted.
  - Use `Mock::VerifyAndClearExpectations()` if necessary.

- **Tip:** Use `.RetiresOnSaturation()` to prevent excessive call warnings on repeated calls to the same expectation.

- **Tip:** When mocking overloaded methods, disambiguate using `Const()` or provide explicit matchers.

---

## Next Steps & Related Content

- **What’s Next:** Explore advanced mocking patterns, custom actions, and cardinalities for complex test scenarios.

- **Related Guides:**
  - [Mocking Basics: Using GoogleMock](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md)
  - [Writing Your First Test](https://github.com/google/googletest/blob/main/guides/getting-started/writing-your-first-test.md)
  - [Matchers Reference](https://github.com/google/googletest/blob/main/docs/reference/matchers.md)
  - [Actions Reference](https://github.com/google/googletest/blob/main/docs/reference/actions.md)

- **Advanced Topics:**
  - Controlling Call Ordering with `Sequence` and `After`
  - Defining Custom Matchers and Actions
  - Testing Asynchronous Behavior with Mocks

- **Resources:**
  - Official GoogleMock GitHub Repo: https://github.com/google/googletest
  - GoogleMock Cookbook: https://google.github.io/googletest/gmock_cook_book.html
  - GoogleTest and GoogleMock API References

---