---
title: "Optimizing Test Performance"
description: "Techniques for speeding up test suites, parallelizing execution, and best practices for maintaining fast feedback as codebases and test coverage scale."
---

# Optimizing Test Performance

Techniques for speeding up test suites, parallelizing execution, and best practices for maintaining fast feedback as codebases and test coverage scale.

---

## 1. Understanding the Need for Test Performance Optimization

As your codebase and test coverage grow, the time it takes to run tests can increase significantly, impacting developer productivity and continuous integration (CI) cycle times. Optimizing test performance ensures quick feedback loops, reduces developer frustration, and maintains high code quality without sacrificing coverage.

**Why optimize?**
- Faster CI builds and quicker development iterations.
- Enable running tests more frequently (e.g., on every commit).
- Support large-scale codebases where tests may number in the thousands.


## 2. Effective Strategies to Speed Up Test Suites

### 2.1. Use Lightweight Mocks and Fakes

Mocks are essential for unit tests, but inefficient or overly complex mocks can slow down test execution.
- Prefer simple mocks that only cover relevant interfaces.
- Use `NiceMock` or `StrictMock` appropriately to reduce noisy warnings and focus on meaningful interactions.
- In performance-critical areas, consider fakes or simpler stubs instead of complex mocks.

### 2.2. Minimize Expensive Setup and Teardown

Tests should avoid unnecessary initialization. Use test fixtures wisely.
- Share common expensive setup steps across multiple tests using fixtures.
- Avoid global state dependencies that slow initialization.
- Mock external dependencies to keep tests isolated and fast.

### 2.3. Parallelize Test Execution

Leverage parallel test runners and frameworks that support running tests concurrently.
- Organize tests so that they can run independently without race conditions.
- In GoogleTest and GoogleMock, tests are isolated by design, facilitating parallel execution.
- Use build system features or CI configurations to run tests in parallel shards.

### 2.4. Selective Test Execution

Run only tests relevant to your changes to save time.
- Use test filtering (`--gtest_filter=`) to limit test execution.
- Integrate test selection tools that analyze code changes to suggest relevant tests.

### 2.5. Avoid Over-Specifying Expectations

Overly strict expectations in mocks can lead to brittle and slow tests.
- Use `ON_CALL` for default behavior and reserve `EXPECT_CALL` for necessary verification.
- Avoid unnecessary `.Times()` constraints unless relevant.

## 3. Best Practices Maintaining Fast Feedback Loops

### 3.1. Structure Your Mocks for Speed

- Define mocks with only essential `MOCK_METHOD`s. Unneeded methods can slow compilation and test time.
- Consider moving mock implementations out-of-line to speed up compile time.

### 3.2. Use NiceMock and StrictMock Judiciously

- `NiceMock` suppresses warnings on uninteresting calls, reducing log noise and potentially speeding up test execution.
- `StrictMock` enforces all mock calls, which can catch undesired calls early but may slow tests due to failures.

### 3.3. Reuse Mocks Where Appropriate

- Avoid recreating mocks unnecessarily; reuse mocks where lifecycle allows.
- Carefully clear expectations and reset mocks between tests if reused.

### 3.4. Embrace Test Parallelization Using GoogleTest Tools

- GoogleTest supports running tests in parallel via test executables or test sharding.
- Configure your CI pipelines to exploit concurrency.

## 4. Practical Example: Using Sequences and RetiresOnSaturation to Manage Expectation Order for Efficient Tests

When tests require ordered interactions but still need to run efficiently, use `Sequence` and `.RetiresOnSaturation()` clauses:

```cpp
#include <gmock/gmock.h>

using ::testing::Sequence;
using ::testing::Return;

class MockTurtle {
 public:
  MOCK_METHOD(void, PenDown, (), ());
  MOCK_METHOD(void, Forward, (int distance), ());
  MOCK_METHOD(void, PenUp, (), ());
};

TEST(TurtleTest, DrawsLineInOrder) {
  MockTurtle turtle;
  Sequence s;

  EXPECT_CALL(turtle, PenDown()).InSequence(s);
  EXPECT_CALL(turtle, Forward(100)).InSequence(s).RetiresOnSaturation();
  EXPECT_CALL(turtle, PenUp()).InSequence(s);

  // Code that uses 'turtle' which calls these methods
}
```

This sets up strict call order for the relevant methods, ensures expectations retire once fulfilled, and avoids expectation stickiness that can slow down or complicate tests.

## 5. Troubleshooting Common Performance Issues

### Symptom: Tests Are Slower Than Expected

- Check if mocks have excess verbose logging (e.g., `--gmock_verbose=info`), which may add overhead.
- Verify if expensive setup occurs in every test instead of shared fixtures.
- Analyze whether tests depend on actual resources (database, network) instead of mocks.
- Confirm if tests are running sequentially when they could run in parallel.

### Symptom: Slow Compilation When Using Large Mocks

- Define mock constructors and destructors outside mock class (in .cc file) to avoid multiple instantiations.
- Limit number of mocked methods to those truly needed.
- Use forward declarations and type aliases to simplify mock declarations.

### Symptom: Flaky or Slow Tests with Threads

- Ensure mocks are accessed in thread-safe manner.
- Use synchronization primitives if your tests involve concurrent accesses.
- Avoid sharing mock objects across threads unless needed, or use GoogleMock's synchronization support.

## 6. Additional Resources

- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Recipes on mocks, actions, and matchers.
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html): Quick reference for mocking syntax.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html): Detailed documentation of mocks and expectations.

## 7. Summary

Optimizing test performance is a multi-faceted endeavor combining smarter mocking, efficient test design, parallel execution, and proper use of GoogleTest/GoogleMock features. Apply selective expectations, use test sequencing and retirement wisely, and structure tests for parallel runs to maintain fast feedback even at scale.

---

<AccordionGroup title="Tips and Best Practices">
<Accordion title="Use ON_CALL Over EXPECT_CALL When Possible">
`ON_CALL` defines default behavior without strict expectations, preventing brittle and slow tests due to over-specification. Reserve `EXPECT_CALL` for actual call verifications.
</Accordion>
<Accordion title="Parallel Test Execution">
Structure your tests to run independently and leverage your CI or build system's parallel test execution capabilities. Use GoogleTest flags like `--gtest_parallel` or shards via `--gtest_total_shards` to split test suites.
</Accordion>
<Accordion title="Avoid Large Mock Classes">
Mock only the required methods. Large mock classes slow compilation and test execution. Consider interface segregation and smaller abstractions.
</Accordion>
<Accordion title="Sharing Expectations Carefully">
When reusing mocks across multiple tests, clear expectations and default actions to prevent unexpected behavior and slowdowns.
</Accordion>
</AccordionGroup>

<Note>
Maintaining fast test feedback is crucial for developer productivity. Investing in test performance optimization ensures that tests continue to provide reliable, timely signals about your code correctness as your project evolves.
</Note>

## 8. Next Steps & Related Documentation

- **Mocking and Advanced Testing Techniques:** Deepen your knowledge about defining expectations and verifying behavior with GoogleMock.
- **Structuring and Organizing Tests:** Learn how to design test suites that scale efficiently.
- **Running Tests and Understanding Results:** Master parallel test execution and interpreting test outputs.

---

## References

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [GoogleTest Primer](https://google.github.io/googletest/primer.html#primer)

<Source url="https://github.com/google/googletest" branch="main" paths={[{"path": "docs/gmock_cook_book.md", "range": "1-750"},{"path": "docs/gmock_cheat_sheet.md", "range": "1-140"},{"path": "docs/reference/mocking.md", "range": "1-300"}]} />