---
title: "Integrating with Build Systems"
description: "Best practices for integrating GoogleTest and GoogleMock with popular C++ build systems like CMake and Bazel, including recommended project structure and practical pkg-config tips for smooth CI/CD adoption."
---

# Integrating with Build Systems

## Overview

This guide helps you integrate GoogleTest and GoogleMock into your C++ build system, focusing on two of the most popular build tools: CMake and Bazel. You will learn best practices for project structure, linking, and practical `pkg-config` usage to achieve smooth build workflows, both in local environments and continuous integration/deployment (CI/CD) pipelines.

### Prerequisites

- Familiarity with C++ build processes and tooling
- A C++ project set up with either CMake or Bazel
- Access to GoogleTest/GoogleMock source code or installed libraries
- CMake version 3.14 or later (for advanced CMake integration)

### Expected Outcome

By following this guide, you will be able to:

- Seamlessly add GoogleTest and GoogleMock to your C++ build system
- Properly link test binaries with GoogleTest and GoogleMock libraries
- Use `pkg-config` for automatic compiler and linker flags management
- Set up project structures conducive to CI/CD workflows

### Time Estimate

Approximately 20â€“30 minutes, depending on your familiarity with CMake or Bazel.

### Difficulty Level

Intermediate

---

## Integrating with CMake

### 1. Standalone or Embedded Build

GoogleTest provides out-of-the-box CMake build scripts. You can choose between:

- **Standalone build:** Build GoogleTest/GoogleMock separately and link the binaries.
- **Embedded build:** Add GoogleTest as a subdirectory in your existing project CMake.

#### Standalone Build Steps

```bash
# Clone and checkout a stable release
git clone https://github.com/google/googletest.git -b v1.17.0
dcd googletest
mkdir build && cd build
cmake ..
make
sudo make install  # Optional: installs to /usr/local/ by default
```

This builds both GoogleTest and GoogleMock by default.

If you only want GoogleTest:

```bash
cmake .. -DBUILD_GMOCK=OFF
```

#### Embedded Build Best Practice

In your main project `CMakeLists.txt`:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)

# For Windows, force runtime linkage consistency
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(googletest)

add_executable(my_test_suite test/my_test_suite.cpp)
target_link_libraries(my_test_suite PRIVATE gtest_main gmock_main)
enable_testing()
add_test(NAME my_test COMMAND my_test_suite)
```

This integration downloads and builds GoogleTest automatically as part of your project, ensuring consistent compiler and linker settings across your tests.

### 2. Linking Libraries

- Use `gtest_main` if you want to use GoogleTest's default main() function.
- Use `gmock_main` if you are also using GoogleMock functionality.
- Link test executables against these targets.

Example:

```cmake
target_link_libraries(my_test PRIVATE gtest_main gmock_main)
```

### 3. Handling Visual Studio Runtime Mismatch

On Windows with MSVC, runtime mismatch errors may occur because GoogleTest defaults to static runtimes while Visual Studio uses dynamic runtimes.

Fix this with:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

before fetching or adding GoogleTest.

### 4. C++ Standard Version

GoogleTest requires C++17 or later. Make sure your project sets:

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

or the equivalent compiler flags.

### 5. Using pkg-config with CMake

GoogleTest installs `.pc` files for `pkg-config`. You can use these to get compile and link flags:

```cmake
find_package(PkgConfig REQUIRED)
pkg_search_module(GTEST REQUIRED gtest_main)

add_executable(my_test test/sample_test.cpp)
target_compile_options(my_test PRIVATE ${GTEST_CFLAGS})
target_link_libraries(my_test PRIVATE ${GTEST_LDFLAGS})

enable_testing()
add_test(NAME my_test COMMAND my_test)
```

> **Tip:** Prefer `target_compile_options()` with `${GTEST_CFLAGS}` over direct include directories to get macro definitions and pthread flags automatically.

### 6. Troubleshooting pkg-config

If `pkg-config` cannot find GoogleTest, ensure that your `PKG_CONFIG_PATH` includes the directory where GoogleTest installed the `.pc` files, such as `/usr/local/lib64/pkgconfig`:

```bash
export PKG_CONFIG_PATH=/usr/local/lib64/pkgconfig:$PKG_CONFIG_PATH
```

---

## Integrating with Bazel

### 1. Using GoogleTest via Workspace

Add the official GoogleTest Bazel workspace in your `WORKSPACE` file:

```starlark
http_archive(
    name = "com_github_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.11.0.zip"],
    strip_prefix = "googletest-release-1.11.0",
)
```

### 2. Declare Dependencies

In your `BUILD` files, use `cc_test` or `cc_binary` targets with `deps`:

```starlark
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = ["@com_github_google_googletest//googletest:googletest_main"],
)
```

or for GoogleMock:

```starlark
cc_test(
    name = "my_mock_test",
    srcs = ["my_mock_test.cc"],
    deps = ["@com_github_google_googletest//googlemock:googlemock_main"],
)
```

### 3. Build and Run

Run your tests with:

```bash
bazel test //path/to:my_test
```

---

## Recommended Project Structure

Organizing your project with test source code in a dedicated `test/` directory can streamline configuration and maintenance.

Example:

```
project-root/
  src/
    ... production sources ...
  test/
    my_test_suite.cpp
  CMakeLists.txt or BUILD
```

This practice clearly separates production and test code, aids CI configuration, and simplifies linking.

---

## Practical Tips & Best Practices

- **Use subdirectory integration in CMake** to ensure consistent compile settings.
- **Prefer linking with `gtest_main` or `gmock_main`** for convenience rather than defining your own `main()`.
- On Windows, remember to **use `gtest_force_shared_crt`** to avoid runtime linkage errors.
- **Use `pkg-config` for compiler/linker flags** if you want a distribution-friendly setup that works well with multiple build systems.
- For CI/CD pipelines, **fetch GoogleTest at configure time** rather than checking in source code.
- Always **use C++17 or newer** for GoogleTest compatibility.

---

## Troubleshooting Common Issues

<AccordionGroup title="Troubleshooting">
<Accordion title="CMake can't find GoogleTest package">
Make sure you installed GoogleTest and your `PKG_CONFIG_PATH` points to the folder containing `.pc` files. You can temporarily set the path:

```bash
export PKG_CONFIG_PATH=/usr/local/lib64/pkgconfig
```

Also confirm your CMake version is 3.14 or higher to support `FetchContent_MakeAvailable`.
</Accordion>

<Accordion title="Runtime library mismatch error on Windows">
Enable the shared CRT runtime in your `CMakeLists.txt` before fetching GoogleTest:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

This aligns runtime linkage with your project.
</Accordion>

<Accordion title="Linker errors related to pthreads">
GoogleTest relies on pthreads on many platforms. When building manually, ensure to link with `-pthread` or use CMake which handles it automatically.
</Accordion>

</AccordionGroup>

---

## Next Steps & Related Content

- Explore [Building and Running Tests guide](/guides/getting-started/build-run) for detailed workflows.
- Learn how to configure test execution in [Configuring Test Execution](/getting-started/project-setup/configuration-options).
- For advanced mocking integration, see [Advanced Mocking Patterns](/guides/core-testing-workflows/advanced-mocking-patterns).
- Consult the [Troubleshooting Common Issues](/getting-started/validation-troubleshooting/troubleshooting) page for deeper problem resolution.

---