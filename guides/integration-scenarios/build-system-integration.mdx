---
title: "Integrating with CMake and Bazel"
description: "Step-by-step instructions for integrating GoogleTest and GoogleMock into CMake and Bazel-based projects. Covers adding dependencies, directory structure recommendations, and troubleshooting common integration issues."
---

# Integrating with CMake and Bazel

## Overview

This guide provides clear, actionable steps for integrating **GoogleTest** and **GoogleMock** into your C++ projects that use either **CMake** or **Bazel** as their build system. It covers how to add the necessary dependencies, set up the recommended project directory structure, link your test binaries appropriately, and troubleshoot common integration issues.

Whether you are starting fresh or adding GoogleTest/GoogleMock to an existing project, this guide helps you configure your build system to seamlessly compile and run tests using these frameworks.

---

## Prerequisites

- Familiarity with your project's build system (CMake or Bazel).
- Existing C++ project source code where you want to add testing.
- Access to clone or download GoogleTest and GoogleMock sources or installed packages.
- C++17 or newer compiler support.
- For CMake: Version 3.13 or newer (ideal 3.14+ for FetchContent).

---

## Expected Outcome

By following this guide, you will have GoogleTest and GoogleMock integrated into your project so that:

- Your C++ test targets can find and link against GoogleTest and GoogleMock libraries.
- You can write tests using GoogleTest and mocks using GoogleMock.
- Your build system builds and runs test executables smoothly.
- Common pitfalls during integration are avoided.

---

## Integration with CMake

GoogleTest and GoogleMock offer well-supported CMake build scripts. Integration can be done either by building them as part of your project or by linking installed libraries.

### Step 1: Add GoogleTest and GoogleMock Sources or Use Installed Packages

- **Option A: Use Installed Libraries**

  Use CMake's `find_package` to locate GoogleTest/GoogleMock on your system:

  ```cmake
  find_package(GTest CONFIG REQUIRED)
  find_package(GMock CONFIG REQUIRED)
  ```

  Then link your test targets against `GTest::gtest`, `GTest::gtest_main`, `GMock::gmock`, or `GMock::gmock_main`.

- **Option B: Build from Source as Part of Your Project**

  Use CMake's `FetchContent` module to download and include GoogleTest/GoogleMock automatically during your build:

  ```cmake
  include(FetchContent)
  FetchContent_Declare(
    googletest
    URL https://github.com/google/googletest/archive/refs/tags/v1.17.0.zip
  )
  set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)  # For Visual Studio shared CRT
  FetchContent_MakeAvailable(googletest)
  ```

  This will add GoogleTest and GoogleMock subprojects that you can target.

### Step 2: Add Test Executable and Link Libraries

Define your test executable using `add_executable` and link with GoogleMock libraries:

```cmake
add_executable(my_tests test/my_tests.cpp)
target_link_libraries(my_tests PRIVATE gmock_main) # gmock_main includes gmock and gtest_main
```

- Use the `gmock_main` target if you want to use the prebuilt main() function that initializes GoogleMock and GoogleTest.
- Otherwise, link with `gmock` and provide your own main() that calls `testing::InitGoogleMock`.

### Step 3: Include Headers

Ensure your test files include GoogleTest and GoogleMock headers:

```cpp
#include <gtest/gtest.h>
#include <gmock/gmock.h>
```

CMake targets `gmock` and `gmock_main` include the correct include directories for you.

### Step 4: Build and Run Tests

- Build your project as usual (`cmake --build <build_dir>`).
- Run your tests by executing the test binary or use `ctest` if enabled.

### Recommended Directory Structure

Organizing your tests and external dependencies can ease maintenance:

```
/project-root/
  ├── CMakeLists.txt        # Your main project build script
  ├── src/                  # Production source code
  ├── tests/                # Test source code
  │    ├── CMakeLists.txt   # Test-specific build rules
  │    └── my_tests.cpp
  ├── third_party/          # Optional: if vendoring googletest
       └── googletest/
```

### Troubleshooting Common CMake Issues

- **Linker errors related to pthread:** Ensure `FindThreads` is used and linked properly; GoogleTest CMake script handles this for you.

- **Mismatched CRT errors on Visual Studio:** Set `gtest_force_shared_crt` option to ON.

- **Undefined references to `main`:** When linking tests, link with `gmock_main` or provide your own main function.

- **Include path errors:** Verify that `target_include_directories` is properly set or use the interface target `gmock_main`/`gmock` for includes.

---

## Integration with Bazel

Bazel provides native support for GoogleTest and GoogleMock via workspace rules.

### Step 1: Declare GoogleTest and GoogleMock in Your `WORKSPACE`

Add the following to your `WORKSPACE` file to pull GoogleTest and GoogleMock:

```python
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.zip"],
    strip_prefix = "googletest-release-1.17.0",
)

load("@com_google_googletest//:bazel/gtest.bzl", "gtest_deps")
gtest_deps()
```

This fetches and makes gtest available.

### Step 2: Add GoogleTest and GoogleMock Dependencies in Your `BUILD` Files

In your test target BUILD file, add dependencies on `@com_google_googletest//:gmock_main` or other targets:

```python
cc_test(
    name = "my_tests",
    srcs = ["my_tests.cpp"],
    deps = ["@com_google_googletest//:gmock_main"],
)
```

- Use `gmock_main` to get the main function implementation.
- Alternatively, if you provide your own `main`, depend on `gmock`.

### Step 3: Write and Compile Tests

Write tests normally using GoogleTest and GoogleMock APIs. Bazel automatically detects `cc_test` targets and runs them with `bazel test //...`.

### Recommended Directory Structure

Standard Bazel layout works well:

```
/project-root/
  ├── WORKSPACE
  ├── BUILD
  ├── src/
  │   ├── BUILD
  │   └── ...
  ├── tests/
      ├── BUILD
      └── my_tests.cpp
```

### Troubleshooting Common Bazel Issues

- **Missing dependencies:** Confirm your `deps` include `gmock_main` or `gmock` targets.

- **Link errors:** Make sure you do not mix static and shared builds inconsistently.

- **Test failures to run:** Bazel requires proper test tags and environment.

---

## Best Practices and Tips

- Prefer linking with `gmock_main` to simplify test executables (avoids writing your own `main()`).
- Keep tests isolated in a dedicated folder with dedicated build files.
- Use CMake's `FetchContent` or Bazel's `http_archive` to automate dependency management.
- Ensure consistent compiler flags for GoogleTest and your code to avoid ABI issues.
- Use C++17 or later as GoogleTest requires modern C++ support.

---

## Troubleshooting Integration Issues

<AccordionGroup title="Common Issues and Solutions">
<Accordion title="Missing main() linker error">
Link against `gmock_main` or `gtest_main` libraries if you don't define your own `main()` function.
</Accordion>
<Accordion title="Undefined references to pthreads or threads">
Check that your build system is linking against pthreads or system threading libs; CMake handles this if you use official targets.
</Accordion>
<Accordion title="Incorrect include paths">
Verify that your test targets depend on `gmock` or `gmock_main` targets so include directories are added automatically.
</Accordion>
<Accordion title="Mismatched runtime library errors on Windows">
Set `gtest_force_shared_crt` option ON in CMake or match your project runtime settings.
</Accordion>
</AccordionGroup>

---

## Code Example: Minimal CMakeLists.txt

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject CXX)

# Enable testing
include(CTest)

# Fetch GoogleTest & GoogleMock
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/v1.17.0.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests tests/my_tests.cpp)
target_link_libraries(my_tests PRIVATE gmock_main)
add_test(NAME my_tests COMMAND my_tests)

```

## Code Example: Minimal Bazel BUILD File

```python
cc_test(
    name = "my_tests",
    srcs = ["my_tests.cpp"],
    deps = ["@com_google_googletest//:gmock_main"],
)
```

---

## Useful References

- [GoogleMock README](https://github.com/google/googletest/blob/main/googlemock/README.md) — Overview and detailed features of GoogleMock.
- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) — Fundamental concepts for using GoogleTest.
- [GoogleMock CMakeLists.txt](https://github.com/google/googletest/blob/main/googlemock/CMakeLists.txt) — Reference for CMake project structure and options.
- [GoogleMock Main Source](https://github.com/google/googletest/blob/main/googlemock/src/gmock_main.cc) — Example main() implementation.
- [Integrating with Build & CI Systems](https://github.com/google/googletest/blob/main/overview/audience-usecases-integration/integration-points.md) — Additional integration details.

---

## Next Steps

- After integrating GoogleTest and GoogleMock, start writing your test cases by exploring the [Writing Your First Test](../getting-started-guides/writing-your-first-test) guide.
- Learn advanced mocking techniques in the [Mocking Patterns and Verification](../core-testing-workflows/working-with-mocks) guide.
- Troubleshoot build and setup issues with the [Troubleshooting Setup Issues](../project-setup-validation/troubleshooting-setup) guide.


---

This completes your setup to use GoogleTest and GoogleMock in CMake and Bazel-based projects, enabling robust C++ testing with minimal fuss and maximum reliability.
