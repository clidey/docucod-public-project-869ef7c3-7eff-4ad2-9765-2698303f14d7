---
title: "Setting Up Expectations and Actions"
description: "Learn to specify and verify function call expectations, define actions (returned values, side effects), and handle call ordering and cardinality in mocks for full control of test interactions."
---

# Setting Up Expectations and Actions in GoogleMock

## Overview
This guide empowers you to precisely specify and verify function call expectations, define mock method behaviors with various actions, and control call ordering and cardinality in GoogleMock. By mastering these capabilities, you gain full control over test interactions, allowing robust verification of your code’s behavior and flexible simulation of dependent components.

---

## 1. Understanding Expectations and Actions

- **Expectations** define how many times and in what manner a mock method should be called.
- **Actions** define what a mock method should do when called, such as returning values or modifying arguments.
- GoogleMock uses `EXPECT_CALL` to set expectations and `ON_CALL` to set default method behaviors without enforcing call counts.


### Key Concepts

- `EXPECT_CALL(mock_object, Method(matchers))` sets an expectation, optionally including:
  - `.Times(cardinality)` – how many times the call should occur.
  - `.InSequence(sequence)` – order constraints.
  - `.After(expectations)` – partial order dependencies.
  - `.WillOnce(action)` and `.WillRepeatedly(action)` – behaviors on invocation.
  - `.RetiresOnSaturation()` – automatic deactivation after expected calls.

- `ON_CALL(mock_object, Method(matchers))` sets default behavior via `.WillByDefault(action)`, without imposing call counts.


## 2. Prerequisites

- Familiarity with C++ and basic testing concepts.
- A mock class defined with `MOCK_METHOD` macros.
- Include `#include <gmock/gmock.h>` in your test.
- Basic understanding of matchers and actions (see gMock Cookbook and Mocking Reference).


## 3. Expected Outcome

After completing this guide, you will be able to:
- Precisely specify expectations on mock method calls regarding arguments, call counts, and call order.
- Define custom behaviors for mock method invocations, including sequences of actions.
- Manage call ordering via sequences and partial orders.
- Handle cases of uninteresting, unexpected, or excessive mock calls.


## 4. Time Estimate

Plan about 15–30 minutes to thoroughly learn and practice these concepts.


---

## Step-by-Step Instructions

### Step 1: Setting Up Basic `EXPECT_CALL` Expectations

Define method call expectations with argument matchers:
```cpp
EXPECT_CALL(mock_object, Method(ArgMatchers...))
    .Times(Exactly(3))     // Expect exactly 3 calls
    .WillOnce(Return(42))  // Return 42 on 1st call
    .WillRepeatedly(Return(0));  // Then 0
```
- Omitting `.Times()` defaults to exactly once or derives count from actions.
- Use `_` matcher to accept any argument.


**Result:** The mock will raise errors if called fewer or more times than specified, or with non-matching arguments.


### Step 2: Using `ON_CALL` for Default Behavior

Use `ON_CALL` to specify default behaviors without asserting calls:
```cpp
ON_CALL(mock_object, Method(_))
    .WillByDefault(Return(-1));
```
- Useful for defining common fallback behavior.
- Does not cause test failures if the call is never made.


**Result:** Calls matching `ON_CALL` will run specified behavior unless overridden by an `EXPECT_CALL`.


### Step 3: Controlling Call Order with Sequences

Define an `InSequence` block or use `Sequence` objects to require call order:
```cpp
Sequence s1, s2;
EXPECT_CALL(mock, MethodA())
    .InSequence(s1, s2);
EXPECT_CALL(mock, MethodB())
    .InSequence(s1);
EXPECT_CALL(mock, MethodC())
    .InSequence(s2);
```
or
```cpp
{
  InSequence seq;  // Anonymous sequence
  EXPECT_CALL(mock, Step1());
  EXPECT_CALL(mock, Step2());
  EXPECT_CALL(mock, Step3());
}
```
- Calls on the same sequence must occur in declaration order.
- Multiple sequences impose a partial order; calls must respect all.


**Result:** Calls outside the specified order will cause expectation failures.


### Step 4: Specifying Cardinalities and Timing

Specify how many times a method can be called:
| Cardinality          | Meaning                   |
|---------------------|---------------------------|
| `Times(AnyNumber())` | Any number of calls       |
| `Times(AtLeast(n))`  | At least *n* calls        |
| `Times(AtMost(n))`   | At most *n* calls         |
| `Times(Between(m,n))`| Between *m* and *n* calls |
| `Times(Exactly(n))`  | Exactly *n* calls         |

**Example:**
```cpp
EXPECT_CALL(mock, Foo(42))
    .Times(AtLeast(1));
```

If uses `.WillOnce()` clauses, GoogleMock infers cardinality accordingly.


### Step 5: Setting Multiple Actions on Expectations

Define sequential behaviors for each call:
```cpp
EXPECT_CALL(mock, Func(_))
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```
- First call returns 1, second returns 2, all subsequent calls return 3.
- Without `WillRepeatedly()`, calls after `WillOnce()`s run out use default action.


### Step 6: Controlling Expectation Lifetime

Use `.RetiresOnSaturation()` to auto-retire an expectation once saturated:
```cpp
EXPECT_CALL(mock, Method(5))
    .Times(2)
    .RetiresOnSaturation();
```
- Once called twice, it's no longer matched; later calls go to other expectations or cause errors.


### Step 7: Refining Argument Matching with `.With()` Clause

Use `.With(matcher)` to add a multi-argument matcher over all arguments as a tuple:
```cpp
EXPECT_CALL(mock, Compare(_, _))
    .With(Lt());  // First argument less than the second
```
- `.With()` must appear first and only once per expectation.
- Enables constraints across multiple arguments beyond individual matchers.


### Step 8: Handling Overloaded Methods

Use `Const()` wrapper or specify explicit matchers to disambiguate overloaded methods:
```cpp
EXPECT_CALL(Const(mock), GetData()).WillOnce(Return(42)); // for const version
```


### Step 9: Managing Uninteresting and Unexpected Calls

- **Uninteresting calls**: Methods called without matching `EXPECT_CALL`. By default, cause warnings but not failures.
- Use `NiceMock<T>` to suppress these warnings.
- Use `StrictMock<T>` to treat them as failures.

**Tip:** Use `EXPECT_CALL(...).Times(AnyNumber())` as a catch-all to mark uninteresting calls as expected if needed.


---

## Examples

### Example 1: Basic Expectation and Action
```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), ());
};

TEST(FooTest, ReturnsCustomValue) {
  MockFoo foo;
  EXPECT_CALL(foo, GetValue())
      .Times(2)
      .WillOnce(Return(42))
      .WillOnce(Return(100));

  EXPECT_EQ(foo.GetValue(), 42);
  EXPECT_EQ(foo.GetValue(), 100);
}
```

---

### Example 2: Setting Default Behavior
```cpp
ON_CALL(foo, GetValue())
    .WillByDefault(Return(-1));

EXPECT_CALL(foo, GetValue())
    .Times(1)
    .WillOnce(Return(10));

// First call to GetValue() returns 10.
// Later calls return -1, the default.
```

---

### Example 3: Ordered Calls with Sequence
```cpp
Sequence s;
EXPECT_CALL(foo, Initialize()).InSequence(s);
EXPECT_CALL(foo, Execute()).InSequence(s);
EXPECT_CALL(foo, Finish()).InSequence(s);

// 'Initialize' must happen before 'Execute', which must happen before 'Finish'.
```

---

### Example 4: Using `.With()` Clause
```cpp
EXPECT_CALL(foo, Compare(_, _))
    .With(Lt());  // Matches calls where first arg is less than second

foo.Compare(3, 5);  // Matches
foo.Compare(7, 1);  // Does not match, causes failure if called
```

---

## Troubleshooting & Tips

- **Errors on Unexpected Call**: Check if all expected calls are specified correctly and in right order.
- **Too Few / Too Many Calls**: Adjust `.Times()` cardinalities or action chains.
- **Confusing Matchers**: Use verbose `--gmock_verbose=info` mode to trace call matching.
- **Uninteresting Call Warnings**: Consider `NiceMock` or explicit catch-all `EXPECT_CALL` to suppress.
- **Expectations Overwritten**: The **last** matching `EXPECT_CALL` applies; order your expectations accordingly.
- **Avoid Over-Specification**: Set only necessary expectations to keep tests maintainable.


## Best Practices

- Use `ON_CALL` for specifying general default behaviors.
- Use `EXPECT_CALL` to assert calls that your test **must** verify.
- Prefer `InSequence` or `Sequence` to enforce critical call order only.
- Use `.RetiresOnSaturation()` when expectations should auto-disable post fulfillment.
- Beware mocking overloaded methods; disambiguate properly.
- Avoid setting expectations after the mock has been used.
- Verify mocks explicitly with `Mock::VerifyAndClearExpectations()` if needed.


---

## Next Steps & Related Content

- Explore [gMock Cookbook](docs/gmock_cook_book.md) for recipes and advanced patterns.
- Understand [Matchers](reference/matching.md) for sophisticated argument checking.
- Learn about [Actions](reference/actions.md) for custom mock behaviors.
- Review [Mocking Basics](guides/mocking-and-advanced-scenarios/mocking-basics) for foundational concepts.
- Study call ordering and cardinalities in more depth ([Cardinalities](reference/mocking.md#EXPECT_CALL.Times), [Sequences](reference/mocking.md#EXPECT_CALL.InSequence)).


---

For comprehensive coverage, also review the examples and test cases in the [GoogleMock source](https://github.com/google/googletest/tree/main/googlemock) that illustrate setting up expectations and actions.


---

## Quick Reference

| Keyword         | Description                          |
|-----------------|------------------------------------|
| `ON_CALL`       | Set default action, no call count   |
| `EXPECT_CALL`   | Set expectation and behavior        |
| `.Times()`      | Specify call count cardinality      |
| `.WillOnce()`   | Set action for a single call        |
| `.WillRepeatedly()` | Set action for repeated calls    |
| `.InSequence()` | Define call order dependency        |
| `.After()`      | Define partial order dependency     |
| `.With()`       | Multi-argument matcher constraint   |
| `.RetiresOnSaturation()` | Auto-retire after saturation |

---

## Important Resources

- [gMock Cookbook](docs/gmock_cook_book.md) – Practical recipes and tips
- [Mocking Reference](docs/reference/mocking.md) – API details
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md) – Quick syntax refresher
- [GoogleTest Primer](overview/product-intro-core-concepts/what-is-googletest)

---

## References

- GoogleMock source files: `gmock-spec-builders.h`, `gmock-spec-builders.cc`
- Test examples in `gmock-spec-builders_test.cc` and `gmock_output_test_.cc`
- Verbose output examples: See `gmock_output_test_golden.txt`



