---
title: "Getting Started with Mocks"
description: "Step through the process of defining mock classes, using simple expectations, and integrating mocks into your test suites to enable effective isolation of code under test."
---

# Getting Started with Mocks

Step through the process of defining mock classes, using simple expectations, and integrating mocks into your test suites to enable effective isolation of code under test.

---

## 1. Introduction to Mocking

Using mocks in your tests allows you to simulate and control the behavior of complex or external dependencies. This isolation lets you verify interactions, control outcomes, and test error handling without relying on real implementations.

This guide focuses exclusively on how to define mock classes, specify expectations and behaviors, and use those mocks in your tests with GoogleTest's gMock framework.

---

## 2. Prerequisites

Before proceeding, ensure:

- You have a working GoogleTest and GoogleMock installation.
- You are familiar with basic C++ and GoogleTest test writing.
- Your interfaces or classes to be mocked have virtual methods; mocking requires virtual functions.

You can validate your setup using the [Validation: Run Your First Test](../prep-requirements-installation/validation-first-test.md) guide.

---

## 3. Defining Mock Classes

### 3.1 Creating a Mock Class

To create a mock class:

1. Derive a class from the interface or base class you want to mock.
2. In the `public:` section, define mock methods using the `MOCK_METHOD` macro.

For example, given an interface `Turtle`:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual void GoTo(int x, int y) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};
```

You create a mock like this:

```cpp
#include <gmock/gmock.h>  // Include the GoogleMock header.

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

**Important:**
- Always place `MOCK_METHOD` in the public section.
- For const methods, add `(const)` in the 4th parameter.
- Add `(override)` for methods overriding virtual functions (recommended).

### 3.2 Handling Types With Commas

If an argument or return type contains commas (e.g., `std::pair`, `std::map`), wrap the type in parentheses or use a type alias:

```cpp
class MockFoo {
 public:
  MOCK_METHOD((std::pair<bool, int>), GetPair, ()); // Correct
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool)); // Correct

  // Or use type aliases
  using BoolIntPair = std::pair<bool, int>;
  MOCK_METHOD(BoolIntPair, GetPair, ());
};
```

---

## 4. Using Mocks in Tests

### 4.1 Typical Workflow

1. Import gMock names:

  ```cpp
  using ::testing::Return;
  using ::testing::_;  // For matchers
  ```

2. Create mock objects:

  ```cpp
  MockTurtle turtle;
  ```

3. Define expectations and default behaviors using `EXPECT_CALL` and `ON_CALL`.

4. Exercise your production code that depends on these mocks.

5. Upon test completion or mock destruction, gMock automatically verifies your expectations.

### 4.2 Setting Expectations with EXPECT_CALL

Declare the expected calls to methods on your mock with:

```cpp
EXPECT_CALL(mock_object, Method(matchers))
    .Times(cardinality) // optional
    .WillOnce(action)   // optional
    .WillRepeatedly(action); // optional
```

- **Matchers:** Use literals or matchers like `_` (wildcard), `Eq(value)`, or complex predicates.
- **Cardinality:** How many times the method is expected to be called. Defaults to `Times(1)` if omitted.
- **Actions:** What to do when the method is called. Examples include `Return(value)`, `ReturnRef(variable)`, or lambdas.

Example:

```cpp
EXPECT_CALL(turtle, Forward(100))
    .Times(AtLeast(1))
    .WillRepeatedly(Return());  // void-returning method
```


### 4.3 Setting Default Behaviors with ON_CALL

Set what a mock method should do *by default* when called without explicit expectations:

```cpp
ON_CALL(mock_object, Method(matchers))
    .WillByDefault(action);
```

Unlike EXPECT_CALL, ON_CALL does not require the method to be called.

Example:

```cpp
ON_CALL(turtle, GetX())
    .WillByDefault(Return(0));
```

---

## 5. Specifying Expectations in Detail

### 5.1 Matchers

Matchers specify what arguments the calls are expected to receive. Common examples:

- `_`: matches anything.
- `Eq(value)`: matches equal to `value`.
- `Ge(value)`: matches values greater or equal to `value`.
- `Pointee(m)`: matches pointers whose pointed-to value matches matcher `m`.

### 5.2 Cardinalities

Control how many times a method call should occur:

| Cardinality              | Meaning                                   |
|--------------------------|-------------------------------------------|
| `AnyNumber()`            | Any number of times                        |
| `AtLeast(n)`             | At least n times                           |
| `AtMost(n)`              | At most n times                            |
| `Between(m,n)`           | Between m and n times                      |
| `Exactly(n)` or `n`       | Exactly n times                            |
| `Times(0)`               | Should never be called                     |

### 5.3 Actions

Define what happens when a mock method is called:

- `Return(value)`: Returns a copy of `value`.
- `ReturnRef(variable)`: Returns a reference to `variable`.
- `ReturnPointee(pointer)`: Returns the object pointed by `pointer`.
- `Invoke(functor)`: Invokes the given callable.
- `DoAll(action1, action2, ...)`: Runs multiple actions in sequence.
- `SetArgPointee<index>(value)`: Sets the pointed-to value of argument at `index`.

Example:

```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

---

## 6. Ordering and Cardinality Best Practices

### 6.1 Ordering Calls

By default, gMock matches calls in any order. To enforce call order:

- Use the `InSequence` helper to group expectations that must occur in order:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock_obj, Func1());
  EXPECT_CALL(mock_obj, Func2());
}
```

- Use `.InSequence(seq1, seq2)` clause for partial or complex orderings.

### 6.2 Retiring Expectations

By default, expectations remain active (sticky) even after saturation (calls equal to the expected count). Use `.RetiresOnSaturation()` to retire expectations automatically when satisfied:

```cpp
EXPECT_CALL(mock_obj, Func())
    .Times(1)
    .RetiresOnSaturation();
```

---

## 7. Handling Uninteresting, Unexpected, and Excessive Calls

- **Uninteresting calls**: Calls to mock methods with no expectations. These emit warnings but do not fail tests by default.
- **Unexpected calls**: Calls matching no expectation; fail tests immediately.
- **Excessive calls**: Calls to methods beyond the expected count; cause failure.

**Tip:** Use `NiceMock<T>` to suppress warnings on uninteresting calls, or `StrictMock<T>` to treat uninteresting calls as failures.

---

## 8. Advanced Techniques

### 8.1 Delegating to Fakes or Real Implementations

You can delegate mock method calls to an existing fake or real object for default behavior:

```cpp
ON_CALL(mock_obj, Func(_))
    .WillByDefault([this](auto&&... args) { return fake_.Func(std::forward<decltype(args)>(args)...); });
```

### 8.2 Mocking Overloaded Methods

Disambiguate overloaded methods using the full signature or `Const()` wrapper for const overloads:

```cpp
EXPECT_CALL(mock_obj, Overloaded(An<int>()));
EXPECT_CALL(Const(mock_obj), Overloaded(5));
```

### 8.3 Using Matchers on Multiple Arguments as a Whole

Use `.With(multi_arg_matcher)` to specify constraints over all arguments together:

```cpp
EXPECT_CALL(mock_obj, Func(_, _))
    .With(Lt());  // first argument < second argument
```

---

## 9. Verifying and Clearing Mocks

Explicitly verify and remove mock expectations before destruction if needed:

```cpp
ASSERT_TRUE(Mock::VerifyAndClearExpectations(&mock_obj));
```

Use `Mock::VerifyAndClear(&mock_obj);` to additionally clear default actions.

Avoid setting expectations after verification.

---

## 10. Common Troubleshooting

<AccordionGroup title="Common Issues and Solutions">
<Accordion title="Uninteresting Call Warnings">
Warnings about unexpected mock calls without expectations are normal if no EXPECT_CALL is set. Use `NiceMock` or add general EXPECT_CALL with `Times(AnyNumber())` to suppress.
</Accordion>
<Accordion title="Too Many or Too Few Calls">
Adjust `Times()`, `.WillOnce()`, and `.WillRepeatedly()` clauses carefully; mismatches lead to failures. Use verbose flag `--gmock_verbose=info` to debug.
</Accordion>
<Accordion title="Mock Method Not Called">
Ensure your mocks are not leaked and destroyed properly to trigger verification. Consider calling `Mock::VerifyAndClearExpectations()` manually in complex cases.
</Accordion>
<Accordion title="Ambiguous Overloaded Methods">
Use `Const()` or explicit matcher casts to disambiguate overloaded mock methods.
</Accordion>
</AccordionGroup>

---

## 11. Example: Testing with a Mock Turtle

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
};

TEST(PainterTest, CanDrawStraightLine) {
  using ::testing::AtLeast;

  MockTurtle turtle;
  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
  EXPECT_CALL(turtle, Forward(100));

  // Code under test
  turtle.PenDown();
  turtle.Forward(100);
}
```

---

## 12. Further Resources

- [Mocking Reference](../reference/mocking.md) for detailed API reference.
- [gMock for Dummies](../gmock_for_dummies.md) for beginner-friendly tutorial.
- [gMock Cheat Sheet](../gmock_cheat_sheet.md) for quick commands and syntax.
- [gMock Cookbook](../gmock_cook_book.md) for recipes and advanced patterns.

---

## 13. Summary

By following this guide, you will be able to:

- Define your mock classes using `MOCK_METHOD`.
- Specify expectations with `EXPECT_CALL` including argument matchers, call count, and actions.
- Set default behaviors using `ON_CALL` without setting expectations.
- Control order of expected calls and handle sequences.
- Differentiate and handle unexpected, uninteresting, and excessive calls.
- Use advanced features like delegation, overload disambiguation, and argument tuple matching.
- Perform manual mock verification and clearing.

Implementing mocks properly is vital for isolated, precise, and maintainable C++ unit tests.

---
