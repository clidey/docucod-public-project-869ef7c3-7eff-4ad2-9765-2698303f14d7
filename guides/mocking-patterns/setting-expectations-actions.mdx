---
title: "Setting Expectations and Actions"
description: "Learn to specify expected calls, argument matching, and default responses using EXPECT_CALL, ON_CALL, matchers, and actions. Includes real-world usage scenarios for controlling test flow and verifying side effects."
---

# Setting Expectations and Actions

Learn to specify expected calls, argument matching, and default responses using `EXPECT_CALL`, `ON_CALL`, matchers, and actions. Includes real-world usage scenarios for controlling test flow and verifying side effects.

---

## Overview

In GoogleMock, controlling how mock methods behave and are called is fundamental to building both robust and precise unit tests. This guide walks you through specifying expected function calls, matching their arguments, setting default behaviors, and invoking custom actions. You will gain hands-on knowledge of using `EXPECT_CALL` and `ON_CALL` macros, leveraging matchers to describe argument expectations, and attaching actions to shape mock responses and side effects.


### What You Will Learn

- How to define mock method expectations using `EXPECT_CALL`
- Setting up default method behavior with `ON_CALL`
- Using matchers to precisely specify argument constraints
- Applying actions to define mock method responses and side effects
- Controlling call cardinality and call order
- Handling advanced scenarios like retiring expectations and unexpected/uninteresting calls


### Prerequisites

- Basic familiarity with C++ and virtual methods/interfaces
- A mock class defined using GoogleMock's `MOCK_METHOD` macros
- `#include <gmock/gmock.h>` available in your test file


### Outcome

By completing this guide, you will confidently:

- Use `EXPECT_CALL` and `ON_CALL` to configure mock behavior
- Write assertions that validate how mock methods are called
- Use argument matchers to describe the expected inputs
- Control the number of calls and their order
- Customize return values and implement side effects


---

## Step-by-Step Instructions

<Steps>

<Step title="1. Use `EXPECT_CALL` to Set Expectations on Mock Methods">
Start by specifying which mock methods you expect to be called, how often, and with what arguments. `EXPECT_CALL(mock_object, Method(args))` sets an expectation that the method will be invoked with arguments matching `args`.

```cpp
EXPECT_CALL(turtle, Forward(100))
    .Times(AtLeast(1));
```

This example expects the `Forward` method to be called with the argument `100` at least once.

**Expected Result:** The test will fail if `Forward(100)` is never called.

**Tips:**
- You may omit `.Times()`; the default is to expect one call.
- Use `_` (wildcard) to accept any argument values.
- For overloaded methods, specify arguments to disambiguate.

</Step>

<Step title="2. Use `ON_CALL` to Define Default Actions">
Use `ON_CALL(mock_object, Method(args))` to specify default behavior for mock methods when you don't want to set strict expectations on call counts.

```cpp
ON_CALL(turtle, GetX())
    .WillByDefault(Return(10));
```

This ensures that any call to `GetX()` returns 10 unless overridden by an explicit `EXPECT_CALL`.

**Outcome:** This avoids warnings about uninteresting calls and sets a fallback return value.

**Best Practice:** Use `ON_CALL` for default behaviors and `EXPECT_CALL` when you want to verify interactions.

</Step>

<Step title="3. Specify Argument Matching Using Matchers">
GoogleMock supports expressive argument matchers to describe valid method arguments in expectations.

Examples include:

```cpp
using ::testing::_;          // Matches anything
using ::testing::Ge;         // Greater or equal
using ::testing::NotNull;    // Pointer is non-null

EXPECT_CALL(foo, Bar(Ge(5), _));  // First arg >= 5, second arg anything
```

You can combine matchers with logical operations like `AllOf()`, `AnyOf()`, and `Not()` for complex rules.

**Verify:** Verify that mock calls pass argument expectations or tests will fail.

</Step>

<Step title="4. Control Call Cardinality with `.Times()`">
Use `.Times(cardinality)` to control how many times a call is expected.

Common cardinalities:

- `Exactly(n)` or `n`: call exactly n times
- `AtLeast(n)`: call n or more times
- `AtMost(n)`: call up to n times
- `Between(m, n)`: call between m and n times (inclusive)
- `AnyNumber()`: call any number of times

Example:

```cpp
EXPECT_CALL(turtle, PenDown())
    .Times(2);
```

If the call count violates this condition, GoogleMock will report a failure.

</Step>

<Step title="5. Attach Actions to Mock Calls: `.WillOnce()` and `.WillRepeatedly()`">
Define what happens when a mock method is called:

- `.WillOnce(action)` specifies behavior for one call (can be chained for multiple calls)
- `.WillRepeatedly(action)` specifies behavior for all subsequent calls after `.WillOnce()`s

Example:

```cpp
using ::testing::Return;

EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(200))
    .WillRepeatedly(Return(300));
```

First call returns 100, second 200, and any further calls 300.

Actions can be:
- Returning values (`Return(value)`, `ReturnRef(variable)`, etc.)
- Invoking callbacks or lambdas
- Setting out parameters (`SetArgPointee`)
- Custom callable objects

</Step>

<Step title="6. Enforce Call Order Using Sequences and `.InSequence()`">
You can enforce that certain calls occur in order using sequences.

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(foo, Init());
  EXPECT_CALL(foo, Process());
  EXPECT_CALL(foo, Cleanup());
}
```

Alternatively, use `.InSequence(sequence)` to group expectations in a specific sequence object.

Calls matching these expectations must occur in the order specified or test fails.

</Step>

<Step title="7. Use `.RetiresOnSaturation()` to Deactivate Expectations">
When a call expectation should be considered finished after its expected calls occur, use `.RetiresOnSaturation()`.

Example:

```cpp
EXPECT_CALL(foo, Bar(42))
    .Times(2)
    .RetiresOnSaturation();
```

After 2 calls to `Bar(42)`, this expectation retires, so further calls wonâ€™t be matched against it (helpful when combined with catch-all expectations).

</Step>

<Step title="8. Handling Unexpected and Uninteresting Calls">
- **Unexpected calls**: Calls to methods not matching any `EXPECT_CALL` expectations result in test failures.
- **Uninteresting calls**: Calls to methods with no expectations specified generate warnings by default.

Use `NiceMock<T>`, `NaggyMock<T>`, or `StrictMock<T>` to adjust this behavior:

- `NiceMock`: suppresses warnings for uninteresting calls
- `NaggyMock`: (default) warns on uninteresting calls
- `StrictMock`: treats uninteresting calls as errors

Add catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` to accept any calls and avoid warnings.

</Step>

</Steps>

---

## Real-World Examples

### Example 1: Setting Expectations with Custom Matchers and Actions
```cpp
using ::testing::_;          // wildcard matcher
using ::testing::Return;
using ::testing::AtLeast;

TEST(FooTest, BehaviorExample) {
  MockFoo mock;

  // Default behavior for GetSize()
  ON_CALL(mock, GetSize()).WillByDefault(Return(5));

  // Expect Describe() called exactly 3 times with argument 5
  EXPECT_CALL(mock, Describe(5))
      .Times(3)
      .WillRepeatedly(Return("Category 5"));

  // Exercise code
  EXPECT_EQ("Category 5", mock.Describe(5));
}
```

### Example 2: Multiple Expectations with Ordering
```cpp
using ::testing::InSequence;
using ::testing::Return;

{
  InSequence seq;
  EXPECT_CALL(mock, Init())
      .Times(1);
  EXPECT_CALL(mock, Process())
      .Times(AtLeast(1));
  EXPECT_CALL(mock, Cleanup())
      .Times(1);
}

mock.Init();
mock.Process();
mock.Cleanup();
```

### Example 3: Side Effect with `SetArgPointee` and `DoAll`
```cpp
using ::testing::DoAll;
using ::testing::Return;
using ::testing::SetArgPointee;

EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));

int value = 0;
EXPECT_TRUE(mock.Mutate(true, &value));
EXPECT_EQ(5, value);
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting call warnings**: Usually caused by missing `EXPECT_CALL` or catch-all expectations. Resolve by adding `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` or use `NiceMock`.

- **Unexpected call failures**: Calls to mock methods with no matching `EXPECT_CALL`. Ensure correct matchers and expectations.

- **Too many or too few `.WillOnce()` actions**: Ensure the number of `.WillOnce()` calls matches the expected number of calls or provide a `.WillRepeatedly()`.

- **Ordering errors**: Ensure correct use of sequences or `.After()` clauses to enforce call order.

### Best Practices

- Use `ON_CALL` to define behavior; use `EXPECT_CALL` to verify calls.
- Use argument matchers (`_`, `Eq()`, `Ge()`, etc.) to avoid over-specification.
- Utilize `.RetiresOnSaturation()` to retire expectations and avoid sticky failures.
- For overloaded methods, explicitly specify argument matchers to avoid ambiguity.
- Avoid setting expectations after the code under test has exercised mocks.

### Performance Considerations

- Minimize the number of expectations to essential ones for clarity and speed.
- Use catch-all expectations where calls are numerous but not critical.

### Alternative Approaches

- Delegate to a real or fake implementation for complex behaviors, using `ON_CALL` with lambdas.
- Use sequences for strict ordering, but prefer partial ordering with `.After()` when appropriate to reduce brittleness.

---

## Next Steps & Related Content

- Explore **[Defining and Using Mocks](/guides/mocking-patterns/defining-using-mocks)** for creating your mock classes.
- Learn about **Matchers** for advanced argument matching: [Matchers and Expectations](/api-reference/mocking-api/matchers).
- Dive deeper into **Custom Actions and Invocations** to define behaviors beyond built-in ones.
- Control mock object strictness and lifecycle with **Mock Strictness and Object Lifecycle**.
- Explore **gMock Cookbook** and **Mocking Reference** for comprehensive recipes and API details.

---

For detailed APIs, visit the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html).


---