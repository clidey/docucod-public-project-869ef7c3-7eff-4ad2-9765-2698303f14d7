---
title: "Advanced Mocking Techniques"
description: "Covers advanced GoogleMock topics such as partial mocks, controlling strictness (NiceMock, StrictMock), using matchers for argument validation, and custom action patterns. Perfect for users who need more expressive or robust mock behavior."
---

# Advanced Mocking Techniques

GoogleMock offers powerful capabilities to control and extend mock behavior beyond the basics. This guide covers advanced topics such as partial mocks, strictness control (`NiceMock`, `StrictMock`), advanced argument validation with matchers, and custom action patterns. These techniques enable you to write more expressive and robust tests that can closely model complex real-world scenarios.

---

## Table of Contents

- [Overview](#overview)
- [Partial Mocks](#partial-mocks)
- [Controlling Mock Strictness](#controlling-mock-strictness)
  - [NiceMock](#nicemock)
  - [StrictMock](#strictmock)
- [Advanced Argument Validation with Matchers](#advanced-argument-validation-with-matchers)
  - [Multi-argument Matching with `.With()`](#multi-argument-matching-with-with)
- [Custom Actions](#custom-actions)
  - [Combining Actions with `DoAll()`](#combining-actions-with-doall)
  - [Writing Your Own Actions](#writing-your-own-actions)
- [Best Practices and Tips](#best-practices-and-tips)
- [Troubleshooting Common Issues](#troubleshooting-common-issues)
- [Next Steps & Related Content](#next-steps--related-content)

---

## Overview

This page builds on Google's foundational mocking constructs to guide you towards sophisticated uses of GoogleMock. Whether you need to mix real and mock implementations, control how strictly your mocks enforce expectations, validate arguments in complex ways, or create custom behaviors for your tests, this guide is your reference.

---

## Partial Mocks

Partial mocks let you mock only some methods of a class while calling through to the real implementations of others. This is useful when you want to intercept or control select interactions but leave the rest of the object’s behavior unchanged.

### How to Use Partial Mocks

1.  **Derive your mock class from the real class**.
2.  Use `MOCK_METHOD` only for methods you want to mock.
3.  Let non-mocked methods behave as usual.

### Example

```cpp
class RealWidget {
 public:
  virtual ~RealWidget() {}

  virtual int Compute(int x) {
    // Complex, real implementation.
    return x * x;
  }

  virtual bool Validate() {
    return true;
  }
};

class MockWidget : public RealWidget {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));
};

// Usage
MockWidget mock_widget;

// Mock only Compute(), real Validate() is called.
EXPECT_CALL(mock_widget, Compute(5)).WillOnce(Return(42));

int result = mock_widget.Compute(5);      // Returns 42
bool valid = mock_widget.Validate();      // Calls real Validate(), returns true
```

Partial mocks offer flexibility to test pivotal behaviors while leveraging existing implementations.

---

## Controlling Mock Strictness

GoogleMock provides three wrappers to adjust how strictly mock objects enforce expectations on uninteresting calls (calls without explicit `EXPECT_CALL`):

### NiceMock

Suppresses warnings for uninteresting calls. Use it to reduce noise and focus on expected interactions.

```cpp
using ::testing::NiceMock;

NiceMock<MockFoo> nice_mock;
EXPECT_CALL(nice_mock, ImportantMethod());
// Calls to other methods won't produce warnings.
```

### StrictMock

Treats uninteresting calls as failures, helping catch unwanted calls early.

```cpp
using ::testing::StrictMock;

StrictMock<MockFoo> strict_mock;
EXPECT_CALL(strict_mock, ImportantMethod());
// Calls to other methods cause test failures.
```

### How to Choose

- Use **`NiceMock`** for general testing to focus only on expected calls.
- Use **`StrictMock`** when you want to enforce that no unexpected calls happen.
- **Default mocks** are currently naggy, generating warnings on uninteresting calls.

### Important Notes

- Wrappers only affect *uninteresting* calls, not *unexpected* calls (calls that don’t match any expectation).
- Works only for mock methods declared using `MOCK_METHOD` directly in the mock class.
- Not compatible with nested strictness wrappers.

---

## Advanced Argument Validation with Matchers

GoogleMock's matcher framework allows precise validation of mock method arguments. When argument-by-argument matching is insufficient—such as when the relationship between arguments matters—you can use multi-argument matchers.

### Matching Multiple Arguments as a Whole with `.With()`

The `.With()` clause lets you specify a matcher that operates on all arguments as a tuple. This is powerful when the relationship between multiple arguments matters.

### Example

```cpp
EXPECT_CALL(mock_obj, SetPosition(_, _))
    .With(Lt());  // Expects first argument less than second
```

Or with an explicit matcher for tuples:

```cpp
EXPECT_CALL(mock_obj, Configure(_, _))
    .With(::testing::AllOf(
        ::testing::Args<0, 1>(\
            ::testing::Lt()),  // first < second
        ... other tuple-level constraints ...));
```

### Tips

- Use built-in tuple matchers like `Lt()`, `Ge()`, `AllOf()`, `AnyOf()`.
- Define your own predicates accepting `std::tuple` if needed.

---

## Custom Actions

Custom actions define what a mock method actually does when called. They are essential for simulating complex behaviors beyond simple return values.

### Combining Actions with `DoAll()`

Run multiple actions in sequence during a single call; only the last action’s return value is used.

```cpp
EXPECT_CALL(mock_obj, Method(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

Here, argument 0 is set to 5, and `true` is returned.

### Writing Your Own Actions

You can define actions as lambdas, functors, or by implementing interfaces:

```cpp
EXPECT_CALL(mock_obj, Compute(_))
    .WillOnce([](int x) { return x * x; });
```

For complex reusable logic, define a struct with `operator()` or implement `ActionInterface`.

### Advanced Use Cases

- Invoking callbacks passed as arguments using `InvokeArgument<N>(...)`.
- Ignoring return values with `IgnoreResult()`.
- Selecting specific arguments to pass to actions with `WithArgs<>`.

---

## Best Practices and Tips

- Use **partial mocks** sparingly; they can blur the line between unit and integration tests.
- Prefer **`NiceMock`** to reduce noise in routine testing.
- Apply **strict mocks** mainly when you want to detect unexpected calls proactively.
- When using `.With()`, make sure your tuple matcher correctly reflects the relationship among arguments.
- Use `RetiresOnSaturation()` to retire expectations when they are no longer valid after being satisfied.
- For move-only types like `std::unique_ptr`, use lambdas for custom actions to avoid compilation issues.

---

## Troubleshooting Common Issues

- **Uninteresting calls warnings:** Consider switching to `NiceMock` or adding catch-all expectations with `Times(AnyNumber())`.

- **Unexpected calls errors:** Check that your expectations precisely cover all expected argument patterns.

- **Action run out warnings:** Make sure the number of `WillOnce()` actions matches the number of expected calls or provide a `WillRepeatedly()` fallback.

- **Mock destructor not virtual warning:** Ensure the base classes you're mocking have virtual destructors to avoid undefined behavior.

- **Mock methods not overridden:** Verify `MOCK_METHOD` is in `public:` section and includes appropriate qualifiers.

---

## Next Steps & Related Content

- [Defining and Using Mock Objects](../mocking-patterns/defining-and-using-mocks) — Learn how to create mock classes and set basic expectations.
- [gMock Cookbook](../../docs/gmock_cook_book.md) — More recipes including custom matchers and advanced actions.
- [Matchers Reference](../../reference/matchers.md) — Explore the rich set of built-in argument matchers.
- [Actions Reference](../../reference/actions.md) — Deep dive into actions and how to write custom ones.
- [Controlling Mock Strictness](#controlling-mock-strictness) — Learn about managing uninteresting calls.
- [Using Sequences and Ordering](./organizing-tests) — Control order of expected calls.

For foundational knowledge or onboarding, see [Introduction to Mocking with GoogleMock](../mocking-patterns/introduction-to-mocking) and [Using GoogleMock in Tests](../basic-setup-first-test/using-googlemock).

---

This page fits into the broader Mocking and Matcher Patterns section, focusing specifically on elevating your mocking capabilities with GoogleMock's sophisticated features.

---

<Info>
  Remember: Always set expectations before exercising the code under test. Mistimed expectations can lead to undefined behaviors and obscure failures.
</Info>

---