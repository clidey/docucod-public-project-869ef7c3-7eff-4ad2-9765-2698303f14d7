---
title: "Advanced Mocking Techniques"
description: "Showcases advanced GoogleMock features such as custom matchers, composite actions, and handling legacy or hard-to-mock code. Provides best practices for readable, sustainable mock-based tests in real-world systems."
---

# Advanced Mocking Techniques

This guide showcases advanced GoogleMock features such as custom matchers, composite actions, and how to handle legacy or hard-to-mock code. It provides best practices for writing readable, maintainable mock-based tests applicable to complex, real-world systems.

---

## 1. Workflow Overview

### What You Will Achieve
You will learn to enhance your mock tests with advanced features that improve test expressiveness and maintainability. This includes defining **custom matchers** for complex argument validation, composing multiple **actions** to execute sequenced side effects, and strategies for dealing with legacy or otherwise difficult-to-mock code.

### Prerequisites
Before proceeding, you should be familiar with basic GoogleMock usage, including:
- Defining mock classes using `MOCK_METHOD`
- Writing simple expectations with `EXPECT_CALL`
- Using built-in matchers and actions

If you need to get up to speed, see the [Mocking Introduction](guides/mocking-patterns/introduction-to-mocking) and [Expectations, Actions, and Sequences](guides/mocking-patterns/expectations-actions-sequences) guides.

### Expected Outcome
By following this guide, you'll be able to:
- Create reusable and meaningful **custom matchers** tuned to your domain objects
- Implement **composite actions** to simulate complex behaviors during mock method calls
- Apply techniques to mock or wrap legacy or hard-to-test interfaces
- Improve your test codeâ€™s clarity and sustainability in large systems

### Time Estimate
Approximately 20-40 minutes depending on your familiarity with GoogleMock basics.

### Difficulty Level
Intermediate to Advanced

---

## 2. Advanced Mocking Features

### 2.1 Defining Custom Matchers

When built-in matchers are insufficient, custom matchers let you encode complex validation logic for mock method arguments.

#### Creating a Basic Custom Matcher
Use the `MATCHER` macros or implement the matcher interface for flexible, self-documenting checks.

```cpp
// Checks that an integer argument is divisible by 7
MATCHER(IsDivisibleBy7, "Checks divisibility by 7") {
  return (arg % 7) == 0;
}

// Usage
EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

#### Parameterized Custom Matchers
Define parameterized versions with `MATCHER_P`, allowing you to pass extra context:

```cpp
MATCHER_P(InClosedRange, range, "Checks if value is in range") {
  return arg >= range.first && arg <= range.second;
}

// Usage
EXPECT_CALL(mock, Bar(InClosedRange(std::make_pair(1, 10))));
```

#### Best Practices for Custom Matchers
- Provide meaningful failure messages by streaming diagnostics in your matcher.
- Keep matchers pure and side-effect free to avoid brittle tests.
- Share reusable matchers across tests for clarity.

Learn more about writing matchers in the [Matchers Reference](reference/matchers.md#custom-matchers).

### 2.2 Using Composite Actions

Composite actions let you chain multiple effects into a single mock method response.

#### `DoAll` Composite Action
Use `DoAll(a1, a2, ..., an)` to perform multiple actions sequentially, returning the result of the last one.

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(
        SetArgPointee<1>(5),    // Set 2nd argument to 5
        Return(true)));        // Return true
```

#### Other Composite Actions
- `IgnoreResult(a)`: Calls `a` and ignores its result, useful when action returns non-void but mock expects void.
- `WithArg<N>(a)`, `WithArgs<N1, N2>(a)`: Selects arguments to passthrough to an inner action.
- `WithoutArgs(a)`: Call an action with no arguments.

Combining actions lets you model complex side effects cleanly.

### 2.3 Handling Legacy or Hard-to-Mock Code

Legacy interfaces, non-virtual methods, or tightly coupled code can hamper mocking. Here are effective workarounds:

#### Delegating to a Fake or Real Object

Wrap the real implementation behind a mock that forwards calls unless overridden:

```cpp
class MockFoo : public Foo {
public:
  MOCK_METHOD(int, Bar, (int x), (override));

  MockFoo() {
    ON_CALL(*this, Bar)
        .WillByDefault([this](int x) { return real_.Bar(x); });
  }

private:
  Foo real_;
};
```

This preserves testability while reusing existing behavior.

#### Using Adapter Methods
If you cannot mock directly (e.g., due to move-only args), create a mock method with friendly signature and forward calls:

```cpp
class MockBuzzer : public Buzzer {
public:
  MOCK_METHOD(bool, DoShareBuzz, (Buzz* buzz, int64_t ts));

  bool ShareBuzz(std::unique_ptr<Buzz> buzz, int64_t ts) override {
    return DoShareBuzz(buzz.get(), ts);
  }
};
```

Set expectations on `DoShareBuzz` instead.

#### Mocking Non-Virtual Methods
Consider template-based mocking or design refactoring to code to interfaces if refactoring is feasible. Otherwise, see alternative mocking patterns in the [Mocking Reference](reference/mocking.md#mocking-non-virtual-methods).

### 2.4 Using Nice, Naggy, and Strict Mocks

You can control how uninteresting calls are handled:

- **NiceMock<T>**: suppresses warnings on uninteresting calls
- **NaggyMock<T>** (default): warns on uninteresting calls
- **StrictMock<T>**: treats uninteresting calls as errors

Example:

```cpp
NiceMock<MockFoo> nice_mock;
StrictMock<MockFoo> strict_mock;
```

Use them appropriately for test clarity and control.

---

## 3. Step-by-Step: Implementing an Advanced Mock Scenario

### Step 1: Define or Choose Mocks
Write your mock class with `MOCK_METHOD`. Wrap in `NiceMock` or `StrictMock` depending on your needs.

### Step 2: Define Custom Matchers if Needed
If argument logic is complex:

```cpp
MATCHER_P(IsWithinTolerance, tol, "Checks if value is within tolerance") {
  return fabs(arg - expected) <= tol;
}
```

Use in `EXPECT_CALL`.

### Step 3: Compose Multiple Actions
Use `DoAll` or other composite actions to produce side effects and return values:

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce(DoAll(
        SaveArg<0>(&saved_arg),
        SetArgPointee<1>(42),
        Return(true)
    ));
```

### Step 4: Set Expectations with Ordering or Partial Order
Use `InSequence` scope or `Sequence` objects combined with `InSequence()` or `After()` clauses to enforce call order.

### Step 5: Handle Legacy / Complex Code
Use delegation or adapter methods to make legacy interfaces testable.

### Step 6: Run and Verify
Run your tests and verify expectations are met. Use `Mock::VerifyAndClearExpectations(&mock)` if you want to verify earlier.

---

## 4. Examples

### Example 1: Custom Matcher with Parameter
```cpp
MATCHER_P(IsNear, expected, "Checks if value is near expected") {
  return fabs(arg - expected) < 0.01;
}

EXPECT_CALL(mock, Foo(IsNear(3.14))).Times(1);
```

### Example 2: Composite Action with DoAll
```cpp
EXPECT_CALL(mock, SetValue(_, _))
    .WillOnce(DoAll(
        SetArgPointee<1>(100),
        Return(true)
    ));
```

### Example 3: Delegating to a Fake Object
```cpp
class MockCalculator : public Calculator {
 public:
  MOCK_METHOD(int, Add, (int a, int b), (override));

  MockCalculator() {
    ON_CALL(*this, Add).WillByDefault([this](int a, int b) {
      return real_calculator_.Add(a, b);
    });
  }

 private:
  Calculator real_calculator_;
};
```

---

## 5. Troubleshooting & Tips

### Common Issues
- **Uninteresting call warnings**: Use `NiceMock` or add a catch-all `EXPECT_CALL` with `Times(AnyNumber())`.
- **Unexpected calls**: Ensure all anticipated calls have matching `EXPECT_CALL` specifications.
- **Call order failures**: Consider using `InSequence` or `After` to specify call ordering precisely.

### Best Practices
- Set expectations *before* exercising the mock to avoid undefined behavior.
- Use `RetiresOnSaturation` to make expectations retire automatically when saturated, preventing saturation errors in repetitive calls.
- Delegate to fakes or real implementations when mocking complex logic to reduce test maintenance.

### Performance Considerations
- Move mock class constructors/destructors out of headers to `.cc` files to speed up compilation.

### Alternative Approaches
- For non-virtual methods, use template mock classes or dependency injection patterns.

---

## 6. Next Steps & Related Content

- Dive deeper into foundational mocking in [Introduction to Mocking](guides/mocking-patterns/introduction-to-mocking).
- Learn about Expectations, Actions, and Call Sequences: [Expectations, Actions, and Call Sequences](guides/mocking-patterns/expectations-actions-sequences).
- Explore writing custom assertions and matchers: [Custom Assertions and Matchers](concepts/extensibility-integration/custom-assertions-matchers).
- Review [Mocking Reference](docs/reference/mocking.md) for a complete API overview.

---

## References

- [GoogleMock: Using Mocks](docs/gmock_for_dummies.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [Actions Reference](docs/reference/actions.md)
- [Matchers Reference](docs/reference/matching.md)
- [Nice, Naggy, Strict Mocks](docs/reference/mocking.md#NiceMock)

---

Happy mocking! Make your test suites expressive, maintainable, and robust with these advanced GoogleMock techniques.
