---
title: "Introduction to Mocking with GoogleMock"
description: "Introduces the core mechanics of mocking in C++, explains how to define mock classes and set expectations, and provides simple but realistic examples to illustrate common use cases, pitfalls, and error handling."
---

# Introduction to Mocking with GoogleMock

## Overview

This guide introduces the core mechanics of mocking in C++ using GoogleMock. It explains how to define mock classes, set expectations on mock methods, and demonstrates practical examples that illustrate common use cases, common pitfalls, and how to handle errors effectively.

By the end of this guide, you will understand how to create mock classes, specify method behaviors, verify method calls, and structure your mock usage to write precise and maintainable tests.

---

## 1. Understanding Mock Classes and Methods

### What is a Mock?
A **mock object** implements the same interface as a real object but allows you to specify and verify interactions at runtime. Unlike fakes, mocks do not have working implementations but are programmed with *expectations* to verify how they are used by your code.

### Defining a Mock Class
To create a mock class in GoogleMock:

- Derive from the interface or base class you want to mock.
- Use the `MOCK_METHOD` macro inside the `public:` section to mock virtual methods.

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetValue() const = 0;
  virtual void Process(int x) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, Process, (int x), (override));
};
```

**Key points:**
- `MOCK_METHOD` signature parallels the method declaration.
- The 4th parameter is a list of qualifiers like `(const, override)`.
- Place all mock method declarations in `public:` regardless of base method access modifiers.
- If the method signature contains commas (like template types), wrap the return type or argument types with parentheses or use type aliases to avoid parsing errors.

### Handling Overloaded and Template Methods
Mock all overloads explicitly. Use `using BaseClass::methodName;` if you mock only some overloads to avoid hiding others.

```cpp
class MockFoo : public Foo {
 public:
  using Foo::Add;  // Bring all overloads into scope

  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (double x), (override));
};
```

Template classes can be mocked similarly by mocking the virtual methods.

### Mocking Non-virtual Methods
GoogleMock supports mocking non-virtual methods using templates and unrelated mock classes, but this requires compile-time selection. Refer to the [gmock cookbook](docs/gmock_cook_book.md#MockingNonVirtualMethods) for details.

---

## 2. Setting Up Expectations: Verifying Interactions

Once your mock class is ready, you specify your expectations using `EXPECT_CALL` and optionally set default behaviors with `ON_CALL`.

### `EXPECT_CALL`
Use `EXPECT_CALL(mock_object, Method(matchers))` to:
- Set expectations on method calls
- Specify how many times the method should be called with `.Times(...)`
- Define return values or side effects with `.WillOnce(...)` and `.WillRepeatedly(...)`

#### Basic Syntax
```cpp
EXPECT_CALL(mock, GetValue())
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```
- The mock `GetValue()` is expected to be called three times.
- It will return 10 and 20 on the first two calls, then 30 on any subsequent calls.

#### Matchers
You can specify argument matchers or use `_` as a wildcard for "any value":

```cpp
EXPECT_CALL(mock, Process(_));  // Accepts any int argument
EXPECT_CALL(mock, Process(42)); // Only accepts argument 42
```

### `ON_CALL`
Use `ON_CALL` to define default behavior for mock methods **without** setting an expectation that the call will happen.

Example:

```cpp
ON_CALL(mock, GetValue()).WillByDefault(Return(5));
```

This sets the default return of `GetValue()` when no `EXPECT_CALL` matches.

### Combining `EXPECT_CALL` and `ON_CALL`
- `EXPECT_CALL` implies both behavior and expectation.
- `ON_CALL` sets default behavior without an expectation.

You should generally use `ON_CALL` to setup the usual behavior in your test fixture and `EXPECT_CALL` to validate specific calls in individual tests.

---

## 3. Common Clauses for `EXPECT_CALL`

### `.Times(Cardinality)`
Specifies how often you expect the method to be called:
- `Times(Exactly(n))` or `Times(n)` (default if you omit `.Times()`) means exactly `n` times.
- `AnyNumber()` means no limit.
- `AtLeast(n)` means at least `n` times.
- `AtMost(n)` means at most `n` times.
- `Between(m, n)` means between `m` and `n` inclusive.

### `.WillOnce(Action)` and `.WillRepeatedly(Action)`
Define what happens when the method is called:
- `.WillOnce(Return(value))` returns `value` once.
- `.WillRepeatedly(Return(value))` returns `value` for all subsequent calls.

Multiple `.WillOnce()` clauses can be chained to specify ordered results.

### `.InSequence(...)`
Groups expectations into a sequence that must be matched in order.

```cpp
Sequence s;
EXPECT_CALL(mock, Foo()).InSequence(s);
EXPECT_CALL(mock, Bar()).InSequence(s);
```
Means `Foo()` must be called before `Bar()`.

### `.After(expectation)`
Specifies that an expectation should occur only after one or more other expectations have been satisfied.

### `.RetiresOnSaturation()`
Indicates that the expectation should become inactive after it is saturated (max calls reached), allowing other expectations to match further calls.

---

## 4. Practical Examples

### Example 1: Simple Mock and Expectation

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));

  Painter painter(&turtle);
  ASSERT_TRUE(painter.DrawCircle(0, 0, 100));
}
```

### Example 2: Using `ON_CALL` to Set Default Behavior

```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(0));
```

This sets `GetX()` to return 0 if no expectation specifies otherwise.

### Example 3: Mocking Overloaded Methods

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (int times, double factor), (override));
};

EXPECT_CALL(mock, Add(42));          // Mocks single-arg version
EXPECT_CALL(mock, Add(3, 1.5));      // Mocks two-arg version
```

### Example 4: Setting Ordered Expectations

```cpp
Sequence s;
EXPECT_CALL(mock, Init()).InSequence(s);
EXPECT_CALL(mock, Execute()).InSequence(s);
EXPECT_CALL(mock, Finish()).InSequence(s);
```
This verifies the calls happen in the order: Init -> Execute -> Finish.

---

## 5. Common Pitfalls and How to Avoid Them

### Expectation Order and "Sticky" Expectations

Expectations in GoogleMock are "sticky" by default â€” they remain active even after reaching their call count limit. This may cause unexpected failures if you write multiple expectations that overlap.

**Tip:** Use `.RetiresOnSaturation()` or explicitly sequence your expectations using `InSequence` to prevent upper-bound violations and to control the order precisely.

### Uninteresting Calls

By default, calls to mocks without expectations produce warnings but not failures. To suppress these warnings where appropriate, use `NiceMock<YourMock>` which suppresses warnings for uninteresting calls, or add catch-all expectations like:

```cpp
EXPECT_CALL(mock, Method(_)).Times(AnyNumber());
```

### Matching Overloaded Methods

If you omit argument matchers on overloaded methods, compilation will fail with ambiguity errors. Always specify argument matchers or use the simpler mock interface technique to disambiguate.

### Mock Method Definition Location

Always place `MOCK_METHOD` declarations in the `public:` section of the mock class regardless of the base method access control. This avoids access issues with `EXPECT_CALL` and `ON_CALL` macros.

### Use Default Action Wisely

Set default actions with `ON_CALL` to avoid unexpected default return values leading to test failures.

### Mocking Move-only Types

GoogleMock supports move-only types such as `std::unique_ptr`, but you may need to use lambdas or specify lambdas in `WillRepeatedly` and `WillOnce` to correctly handle them.

---

## 6. Troubleshooting

**Q:** *My mock calls are generating "uninteresting mock function call" warnings, even though I set `ON_CALL`.*

**A:** This is normal because `ON_CALL` sets default behavior but *does not* set an expectation that the method should be called. To make an expectation, use `EXPECT_CALL`. To suppress warnings, use `NiceMock` or add catch-all expectations.

---

## 7. Best Practices & Tips

- Use `ON_CALL` for setting default behaviors common to many tests, and `EXPECT_CALL` sparingly for specific interaction checks.
- When mocking methods with overloaded versions, specify matchers explicitly to avoid ambiguity.
- Use sequences (`InSequence`) and `After` to define partial or total order of method calls to express intent clearly.
- Avoid over-specifying expectations which can make tests brittle.
- Use `RetiresOnSaturation` to control lifecycle and matching of expectations, especially when multiple expectations apply to the same method with overlapping arguments.
- When mocking non-virtual methods, consider template-based or compile-time techniques.

---

## 8. Next Steps

Explore these further topics to deepen your mastery:

- [Expectations, Actions, and Call Sequences](../mocking-patterns/expectations-actions-sequences.md)
- [Advanced Mocking Techniques](../mocking-patterns/advanced-mocking-features.md)
- [Matchers Reference](../reference/matchers.md)
- [Actions Reference](../reference/actions.md)

For the complete API and details join the [Mocking Reference](../reference/mocking.md) page.

---

## References

- GoogleMock Official GitHub: https://github.com/google/googletest
- gMock Cookbook: https://google.github.io/googletest/gmock_cook_book.html
- gMock for Dummies: https://google.github.io/googletest/gmock_for_dummies.html
- GoogleTest Primer and Guides (installation and configuration): see [Overview & Getting Started](../../overview/introduction-core-value/what-is-googletest.md)

---