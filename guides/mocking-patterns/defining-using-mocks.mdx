---
title: "Defining and Using Mocks"
description: "Hands-on guide to creating mock classes and methods in C++. Discover how to use the MOCK_METHOD macros, configure behaviors, and leverage the main mocking APIs to simulate dependencies in unit tests."
---

# Defining and Using Mocks

## Overview
This guide provides a hands-on approach for creating mock classes and methods in C++ using GoogleMock. You'll learn how to use the `MOCK_METHOD` macro to define mock methods, configure different mock behaviors, and use the main mocking APIs to simulate dependencies during unit testing. It helps bridge the gap between designing interfaces and verifying interactions in your tests.

---

## 1. Creating Mock Classes

### What is a Mock Class?
A **mock class** is a subclass of an interface or base class that fakes its behavior during tests. GoogleMock provides the `MOCK_METHOD` macro to automatically generate mock implementations for virtual methods.

### Defining a Mock Class

1. **Derive from the Interface:** Create a subclass inheriting from the interface or abstract base class.
2. **Use `MOCK_METHOD`:** Declare a mock for each virtual method you want to override using:

```cpp
  MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
```

- `ReturnType`: the method's return type.
- `MethodName`: the method name.
- `(Args...)`: parentheses-wrapped list of argument types.
- `(Specs...)`: optional method qualifiers such as `(const, override)`.

### Example: Mocking a Simple Interface
```cpp
#include <gmock/gmock.h>

class Turtle {
 public:
  virtual ~Turtle() = default;
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

**Tip:** Always define mock methods as `public:` to ensure `EXPECT_CALL` and `ON_CALL` macros can access them.

### Handling Commas in Types
If argument types or return types contain commas, wrap them in extra parentheses or use typedef aliases:

```cpp
class MockFoo {
 public:
  MOCK_METHOD((std::pair<int, int>), GetPair, ()); // Wrap with parentheses
  // Or use aliases
  using PairInt = std::pair<int, int>;
  MOCK_METHOD(PairInt, GetPairBetter, ());
};
```

### Mocking Overloaded Methods
Simply mock each overload explicitly using `MOCK_METHOD`. Use `Const()` wrapper to disambiguate const overloads:

```cpp
class Foo {
 public:
  virtual int GetValue() = 0;
  virtual int GetValue() const = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (override));
  MOCK_METHOD(int, GetValue, (), (const, override));
};

// In tests:
EXPECT_CALL(mock_foo, GetValue());        // non-const version
EXPECT_CALL(Const(mock_foo), GetValue()); // const version
```

### Mocking Class Templates
Mock class templates the same way:

```cpp
template <typename T>
class StackInterface {
 public:
  virtual ~StackInterface() = default;
  virtual void Push(const T& elem) = 0;
};

template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(void, Push, (const T& elem), (override));
};
```

### Mocking Non-Virtual Methods
GoogleMock can mock non-virtual methods by defining mock methods with the same signature *without* marking them as `override`. Mock classes then do not derive from the real class.

```cpp
class Concrete {
 public:
  void Foo(int x);
};

class MockConcrete {
 public:
  MOCK_METHOD(void, Foo, (int x)); // no override
};
```

### Virtual Destructors
Always ensure the base class destructor is virtual. Failing to do so leads to undefined behavior and memory leaks when mocking.

---

## 2. Using Mock Objects in Tests

### Typical Workflow:

1. **Import gMock Symbols:**

```cpp
using ::testing::_;  // matcher for any argument
using ::testing::Return;  // action for returning values
```

2. **Create Mock Objects:**

```cpp
MockTurtle mock_turtle;
```

3. **Set Default Behaviors (`ON_CALL`):**

```cpp
ON_CALL(mock_turtle, Forward(_)).WillByDefault(Return());
```

4. **Set Expectations (`EXPECT_CALL`):**

```cpp
EXPECT_CALL(mock_turtle, PenDown()).Times(1);
EXPECT_CALL(mock_turtle, Forward(10)).WillOnce(Return());
```

5. **Use Mock in Tested Code:**

```cpp
Painter painter(&mock_turtle);
painter.DrawCircle(0, 0, 10);
```

6. **Automatic Verification:**
When mock objects go out of scope, GoogleMock verifies all expectations.

### Example:

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;
using ::testing::_;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;
  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));

  Painter painter(&turtle);

  EXPECT_TRUE(painter.DrawCircle(0, 0, 5));
}
```

If `PenDown()` is never called, the test will fail with an informative message about the missing call.

### Default Actions vs. Expectations
- `ON_CALL`: Specifies **default behavior** when a method is called but no explicit expectation matches.
- `EXPECT_CALL`: Specifies **expectations** and behaviors for calls you want to observe.

`EXPECT_CALL` overrides `ON_CALL` behaviors for matching calls.

### Uninteresting Calls
If you call a mock method with no expectation or default behavior, GoogleMock issues warnings by default (naggy mode).

To suppress warnings, wrap your mock in `NiceMock`:

```cpp
NiceMock<MockTurtle> mock_turtle;
```

### Strictness Modes
- **NaggyMock (default):** Warns on uninteresting calls.
- **NiceMock:** Suppresses warnings.
- **StrictMock:** Treats uninteresting calls as test failures.

Example:

```cpp
using ::testing::StrictMock;
StrictMock<MockTurtle> strict_mock;
EXPECT_CALL(strict_mock, PenDown());
// Any call other than PenDown() results in test failure
```

### Verification Before Destruction
You can verify and clear expectations explicitly:

```cpp
ASSERT_TRUE(Mock::VerifyAndClearExpectations(&mock_turtle));
```

Use this technique when mock object's lifetime is unclear.

---

## 3. Configuring Mock Methods with `EXPECT_CALL`

- **Matchers:** Define argument matching using built-in or custom matchers. Use `_` if you don't care about a parameter.

- **Cardinalities:** Specify how many times a method is expected to be called. For example:
  - `Times(1)` - exactly once
  - `Times(AnyNumber())` - any number
  - `Times(AtLeast(n))`

- **Actions:** Define what happens when the expectation is matched.
  - `WillOnce(Return(value))` returns a value for one call.
  - `WillRepeatedly(Return(value))` for all calls after `WillOnce`s.

Example:

```cpp
EXPECT_CALL(mock_turtle, Forward(10))
    .Times(2)
    .WillOnce(Return())
    .WillOnce(Return());
```

### Ordering Expectations
Use `InSequence` block to enforce call orders:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Foo(1));
  EXPECT_CALL(mock, Bar(2));
}
```

The above requires `Foo(1)` to be called before `Bar(2)`.

### Combining Multiple Expectations
More specific expectations should follow more general ones to take precedence.

```cpp
EXPECT_CALL(mock, Foo(_)).Times(AnyNumber());
EXPECT_CALL(mock, Foo(5)).Times(2);
```
Here, calls `Foo(5)` match the second expectation.

---

## 4. Setting Default Behaviors with `ON_CALL`

Use `ON_CALL` to define **default actions** for mock methods when you don't want to require the call. Patterns include:

```cpp
ON_CALL(mock_turtle, GetX()).WillByDefault(Return(0));
```

`ON_CALL` requires `.WillByDefault()` clause.

Unlike `EXPECT_CALL`, `ON_CALL` does not set an expectation on how many times a method must be invoked.

This lets you reduce test brittleness by focusing on calls you care about.

---

## 5. Mock Objects with Different Strictness

- **Raw Mock:** Default behavior is naggy, warns on uninteresting calls.
- **NiceMock:** Subclass mock to suppress warnings on uninteresting calls.
- **StrictMock:** Subclass mock to treat uninteresting calls as failures.

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_mock;
```

These types are designed as templates that wrap your mock class while inheriting its interface and constructors.

---

## 6. Advanced Mock Features

### Delegating Calls to Fake or Real Objects
Sometimes you want mocks to delegate calls to a real or fake object:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, DoThis, (int), (override));

  MockFoo() {
    ON_CALL(*this, DoThis).WillByDefault([this](int x) {
      return real_.DoThis(x);
    });
  }

 private:
  Foo real_;
};
```

### Mocking Destructors
You cannot mock destructors directly with `MOCK_METHOD`. Use a helper method called in the destructor:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(void, Die, ());
  ~MockFoo() override { Die(); }
};

// Test
EXPECT_CALL(mock_foo, Die());
```

---

## 7. Best Practices & Tips

- **Set expectations before invoking methods.** Setting `EXPECT_CALL` after a method is called has undefined behavior.
- **Avoid mocking classes you don't own.** If you must, place mocks close to the owning code or use adaptors.
- **Use `NiceMock` except when you want warnings.**
- **Sequence expectations carefully to avoid brittle tests.** Use `InSequence` or `After()`.
- **Use custom matchers to validate complex argument properties.**
- **Explicitly verify mocks if their destruction is uncertain using `Mock::VerifyAndClearExpectations()`.**

---

## 8. Troubleshooting

- **Virtual destructor?** Ensure base class destructors are virtual to avoid leaks.
- **Uninteresting calls warnings?** Use `NiceMock` or add `EXPECT_CALL(...).Times(AnyNumber())` on those methods.
- **Unexpected call failures?** Check your expectations and argument matchers.
- **Mock not verifying?** Confirm mock objects are properly destroyed or verified explicitly.

---

## 9. References & Related Guides

- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md): Quick syntax reference.
- [gMock for Dummies](docs/gmock_for_dummies.md): Beginner friendly introduction to mocks.
- [Mocking Reference](docs/reference/mocking.md): Detailed API for mocking methods, expectations, and actions.
- [Setting Expectations and Actions](guides/mocking-patterns/setting-expectations-actions): How to define behaviors and verify calls.
- [Mock Strictness and Object Lifecycle](guides/mocking-patterns/mock-strictness-lifecycle): Handling strictness levels and lifecycle concerns.

---

## Summary
This guide immerses you in defining and using mocks with GoogleMock, focusing specifically on how to declare mock classes using the `MOCK_METHOD` macro, configure mock behaviors, and utilize the main mocking APIs. Designed to accelerate your unit testing experience, it covers everything from simple mock class creation to managing expectations, default actions, mock strictness, and delegation techniques.

By following this guide, you'll be able to:
- Create mock classes that replicate interfaces.
- Set precise expectations on method calls.
- Handle uninteresting and unexpected calls with appropriate strictness.
- Delegate mock behaviors to real or fake implementations when needed.

For next steps, consult guides on setting expectations and mock strictness to deepen your mastery.

---

<AccordionGroup title="Example: Basic Mock Class">
<Accordion title="Complete Example"> 
```cpp
#include <gmock/gmock.h>

class Widget {
 public:
  virtual ~Widget() = default;
  virtual int Size() const = 0;
  virtual void Draw(const std::string& label) = 0;
};

class MockWidget : public Widget {
 public:
  MOCK_METHOD(int, Size, (), (const, override));
  MOCK_METHOD(void, Draw, (const std::string& label), (override));
};

using ::testing::Return;
using ::testing::_;

TEST(WidgetTest, DrawsWithSize) {
  MockWidget mock;
  ON_CALL(mock, Size()).WillByDefault(Return(5));
  EXPECT_CALL(mock, Draw(_)).Times(1);

  // Code under test can now use mock
  SomeFunctionUsingWidget(&mock);
}
```
</Accordion>
</AccordionGroup>