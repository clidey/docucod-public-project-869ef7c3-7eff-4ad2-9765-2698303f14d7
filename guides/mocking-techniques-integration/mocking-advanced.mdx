---
title: "Advanced Mocking Patterns and Custom Actions"
description: "Harness GoogleMock's power by crafting custom actions, argument matchers, and using complex cardinalities. Tackle advanced dependency scenarios and learn how to combine mocking with parameterized and fixture-based tests."
---

# Advanced Mocking Patterns and Custom Actions

Harness the full power of GoogleMock by mastering advanced mocking techniques, crafting custom actions, and controlling intricate mock behaviors. This guide focuses exclusively on advanced mocking patterns and custom actions, empowering you to handle complex testing scenarios, combine mocking with parameterized and fixture-based tests, and fine-tune test interactions with precision.

---

## Workflow Overview

### What You Will Learn
This guide helps you extend basic mocking skills into advanced scenarios. You will learn how to:

- Create custom actions to define bespoke mock behaviors.
- Set up complex expectation sequences and partial orders using `Sequence` and `After` clauses.
- Tailor mock methods to behave differently based on argument matchers.
- Combine mocking with parameterized and fixture-based tests for reusable and robust test setups.
- Use built-in utilities like `DefaultValue`, `NiceMock`, `StrictMock`, and understand how to manage uninteresting calls.

### Prerequisites
- Familiarity with basic GoogleMock usage: creating mock classes, `MOCK_METHOD`, `EXPECT_CALL`, and `ON_CALL`.
- Understanding of matchers and actions from foundational docs like [gMock for Dummies](gmock_for_dummies.md) and [gMock Cookbook](gmock_cook_book.md).

### Expected Outcome
After completing this guide, you will be able to:
- Implement advanced interaction-based test behaviors in C++ using GoogleMock.
- Write custom actions that seamlessly integrate with GoogleMock expectations.
- Use sequences and partial ordering of mocks to control call order assertions.
- Create cleaner, maintainable mocks for complex interfaces.
- Troubleshoot common pitfalls in advanced mocking.

### Time Estimate
Approximately 30 to 45 minutes to digest and practice the patterns.

### Difficulty Level
Intermediate to Advanced

---

## Step-by-Step Instructions

### 1. Defining Mock Methods with Precise Behavior

GoogleMock offers extensive control over mocked methods:

- Use `MOCK_METHOD` to define mock methods, including handling complex signatures by wrapping return or argument types in parentheses or using `using` aliases when commas in types cause parsing issues.
- Always place `MOCK_METHOD` declarations in the `public:` section even if overriding protected or private methods.

```cpp
class MyMock {
 public:
  // Use parentheses around complicated types to avoid parsing errors
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());

  // Alternatively, use type aliases
  using MapType = std::map<int, double>;
  MOCK_METHOD(bool, CheckMap, (MapType, bool));
};
```

---

### 2. Using Custom Actions to Define Behavior

Default actions are limited. Custom actions allow fine-grained behavior:

- Define actions as lambdas, functors, or using `ACTION` macros.
- Actions can return values, modify arguments for side effects, or call real/fake objects.

#### Creating a Lambda-Based Custom Action

```cpp
EXPECT_CALL(mock_obj, Foo(_))
    .WillOnce([](int x) { return x * 2; });
```

#### Defining a Parameterized Action with ACTION_P

```cpp
ACTION_P(MultiplyBy, factor) {
  return arg0 * factor;
}

EXPECT_CALL(mock_obj, Foo(_)).WillOnce(MultiplyBy(3));
```

#### Combining Multiple Effects with `DoAll`

If you need both side effects and return value:

```cpp
EXPECT_CALL(mock_obj, Bar(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

---

### 3. Controlling Invocation Order and Repetition

GoogleMock provides mechanisms to specify the order and frequency of expected calls.

- **Sequences:** Use `Sequence` objects to enforce call order across multiple calls.

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Init()).InSequence(s1);
EXPECT_CALL(mock, Process()).InSequence(s1, s2);
EXPECT_CALL(mock, Cleanup()).InSequence(s2);
```

- **Partial Orders:** Use `.After()` to state expectations that certain calls happen after others.

```cpp
Expectation e1 = EXPECT_CALL(mock, Start());
Expectation e2 = EXPECT_CALL(mock, Update()).After(e1);
EXPECT_CALL(mock, Finish()).After(e2);
```

- **Retiring Expectations:** Add `.RetiresOnSaturation()` to disable an expectation after its call count limit.

- **Repeated Calls and Cardinality:** Use `.Times()`, `.WillOnce()`, `.WillRepeatedly()` to specify the number and behavior for multiple calls.

- **Default Inference:** If `.Times()` is omitted, GoogleMock infers cardinality from `.WillOnce()` and `.WillRepeatedly()` usage.

---

### 4. Setting Default Behaviors with `ON_CALL`

Use `ON_CALL` to specify the default behavior without setting expectations:

```cpp
ON_CALL(mock, Compute(_))
    .WillByDefault(Return(42));
```

- Unlike `EXPECT_CALL`, `ON_CALL` doesn't expect the method to be called but defines what happens if it is.
- You can chain `.With()` to specify multi-argument conditions.

---

### 5. Handling Move-Only Types

GoogleMock supports mocking methods that take or return move-only types. Use `MOCK_METHOD` normally:

```cpp
MOCK_METHOD(std::unique_ptr<Foo>, CreateFoo, (), (override));
```

- In actions, use lambdas to return new unique_ptrs on each call, to avoid moved-from objects.

```cpp
EXPECT_CALL(mock, CreateFoo())
    .WillRepeatedly([]() { return std::make_unique<Foo>(); });
```

Alternatively, delegate calls to a helper:

```cpp
class MockFoo {
 public:
  MOCK_METHOD(bool, DoShare, (Foo* foo), ());
  bool Share(std::unique_ptr<Foo> foo) {
    return DoShare(foo.get());
  }
};
```

---

### 6. Combining Mocking with Parameterized and Fixture-Based Tests

- Define mocks in test fixtures to reuse common setup.
- Use parameterized tests for testing variations while keeping mocks consistent.

Example:

```cpp
class MyTest : public ::testing::Test {
 protected:
  MockFoo mock_foo;

  void SetUp() override {
    ON_CALL(mock_foo, Bar()).WillByDefault(Return(5));
  }
};

TEST_F(MyTest, Example) {
  EXPECT_CALL(mock_foo, Bar()).Times(1);
  ...
}

class MyParamTest : public ::testing::TestWithParam<int> {
 protected:
  MockFoo mock_foo;
};

TEST_P(MyParamTest, ReturnsValue) {
  int param = GetParam();
  EXPECT_CALL(mock_foo, Bar()).WillOnce(Return(param));
  EXPECT_EQ(mock_foo.Bar(), param);
}
```

---

## Examples & Code Samples

### Example: Complex Ordering with `Sequence` and `After`

```cpp
Sequence s1, s2;
Expectation e1 = EXPECT_CALL(mock, Initialize());
EXPECT_CALL(mock, Step1()).InSequence(s1);
EXPECT_CALL(mock, Step2()).InSequence(s1, s2).After(e1);
EXPECT_CALL(mock, Step3()).InSequence(s2);
```

### Example: Custom Action to Transform Argument

```cpp
ACTION(SetToZeroIfNegative) {
  if (arg0 < 0) {
    arg0 = 0;
  }
}

EXPECT_CALL(mock, UpdateValue(_))
    .WillOnce(SetToZeroIfNegative());
```

### Example: Delegating to a Fake Implementation

```cpp
class FakeFoo : public Foo {
 public:
  int Compute(int x) override { return x * x; }
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Compute, (int), (override));

  void DelegateToFake() {
    ON_CALL(*this, Compute).WillByDefault(
        [this](int x) { return fake_.Compute(x); });
  }

 private:
  FakeFoo fake_;
};

// Usage:
MockFoo mock;
mock.DelegateToFake();
EXPECT_CALL(mock, Compute(3));
EXPECT_EQ(mock.Compute(3), 9);
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting call warnings:** When mock methods are called without expectations, GoogleMock warns by default. Use `NiceMock` to suppress or set `EXPECT_CALL(...).Times(AnyNumber())` to explicitly allow them.

- **Unexpected calls:** Calls that don't match any expectation cause test failures. Review your matchers and expectations.

- **Order violations:** Use `Sequence` or `.After()` to control call order. Violations produce clear error messages.

- **Move-only type errors:** Returning a `std::move`d value in `Return()` multiple times leads to issues; prefer lambdas that create fresh objects.

- **Compilation errors with commas in types:** Wrap with parentheses or use typedef/alias.

### Best Practices

- Prefer `ON_CALL` for setting default behaviors unless you need to verify the calls.
- Set specific expectations only where interactions matter to reduce test brittleness.
- Use `.RetiresOnSaturation()` to make expectations non-sticky when sequential call counts matter.
- Combine sequences and partial orders for complex interaction checks.
- When mocking overloaded functions, disambiguate using `Const()` or fully qualified matcher types.

---

## Next Steps & Related Content

- To build foundational skills, visit [Mocking for Dummies](gmock_for_dummies.md).
- For handy references on matchers and actions, consult the [gMock Cheat Sheet](gmock_cheat_sheet.md).
- Explore practical recipes in [gMock Cookbook](gmock_cook_book.md).
- Understand finer details of expectation management in [Mocking Reference](reference/mocking.md).
- Use [Test Fixtures and Parameterized Tests](guides/advanced-testing-and-best-practices/test-fixtures-parameterized.md) alongside mocks for scalable testing.

---

## Appendix: Summary of Key Fluent API Modifiers for `EXPECT_CALL` and `ON_CALL`

| Modifier             | Purpose                                            | Restrictions                    |
| -------------------- | ------------------------------------------------- | ------------------------------ |
| `.With(matcher)`     | Match arguments as a tuple (multi-argument)       | At most once, must be first    |
| `.Times(cardinality)`| Specify number of times expectation is met         | At most once, before sequences |
| `.InSequence(...)`   | Expectation belongs to sequence(s)                  | Any number, before After and Will clauses |
| `.After(...)`        | Expectation should occur after other ones           | Any number, before Will clauses          |
| `.WillOnce(action)`  | One-time action to perform when expectation matched | Any number                      |
| `.WillRepeatedly(action)` | Repeated action after WillOnce actions exhausted | At most once, last clause                |
| `.RetiresOnSaturation()` | Retire expectation after reaching upper bound    | At most once, last clause                |

---

This concludes the advanced guide for mocking patterns and custom actions using GoogleMock, equipping you with techniques and knowledge to build powerful, maintainable, and precise tests for complex C++ codebases.
