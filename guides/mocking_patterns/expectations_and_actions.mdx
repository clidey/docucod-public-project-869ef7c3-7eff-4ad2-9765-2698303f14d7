---
title: "Expectations, Actions, and Call Sequences"
description: "In-depth walkthrough of setting up ON_CALL, EXPECT_CALL, and actions, covering flexible matchers, call ordering, cardinalities, and specifying side effects. Recommended patterns for maintaining test reliability."
---

# Expectations, Actions, and Call Sequences

An essential guide to using GoogleMock’s expectations and actions, including setting up **ON_CALL** and **EXPECT_CALL**, utilizing matchers for argument validation, controlling call ordering with sequences, and defining side-effect behaviors. This guide provides patterns that keep your tests maintainable and reliable.

---

## 1. Understanding Expectations and Actions

### Purpose
This page is dedicated to helping you master the use of expectations (`EXPECT_CALL`) and default behaviors (`ON_CALL`) for mock methods in GoogleMock. It details how to flexibly match arguments, control call order and cardinality, and specify side effects or return values, ensuring your tests express exactly the interaction contracts you need to verify.

### Prerequisites
- Basic familiarity with GoogleMock mock classes and methods (see [Defining and Using Mocks](https://google.github.io/googletest/guides/mocking_patterns/defining_and_using_mocks.html)).
- Your project is configured with GoogleMock and can compile tests (refer to setup guides).

### Expected Outcome
By the end of this guide, you will confidently:
- Define expectations on mock methods that precisely match argument patterns.
- Differentiate when to use `EXPECT_CALL` versus `ON_CALL`.
- Control the order and frequency of mock method calls.
- Specify complex behaviors and side effects when mock methods are invoked.
- Write robust, maintainable tests that verify interactions without over-specifying.

### Estimated Time
Approximately 20-30 minutes for an initial read-through and practice with examples.

### Difficulty Level
Intermediate: assumes you have created mock classes and basic tests.

---

## 2. Setting Expectations with `EXPECT_CALL`

GoogleMock’s `EXPECT_CALL` declares that a particular mock method *must* be invoked with expected arguments and controls its behavior when called.

### Syntax Overview
```cpp
EXPECT_CALL(mock_object, MethodName(argument_matchers))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action)
    .InSequence(sequences)
    .After(expectations)
    .RetiresOnSaturation();
```

- `mock_object`: Your mock instance.
- `MethodName`: The method you expect to be called.
- `argument_matchers`: Matchers specifying what call arguments are acceptable.

### Best Practice: When to Use
- Use `EXPECT_CALL` when your test must verify that a call occurs with particular arguments.
- Avoid over-constraining by only specifying essential argument details.
- For example, when you want to ensure `Save()` is invoked exactly once:

```cpp
EXPECT_CALL(mock_storage, Save("config.json", _)).Times(1);
```

### Matchers
Matchers specify argument expectations. Use `_` to match any value, or built-in matchers such as `Ge()`, `NotNull()`, `Eq()`, and custom matchers for more precise control.

### Multiple Expectations
Multiple `EXPECT_CALL`s on the same method can coexist. The most recent matching expectation takes precedence. Order your expectations with the most specific last to avoid shadowing.

---

## 3. Defining Default Behaviors with `ON_CALL`

Unlike `EXPECT_CALL`, `ON_CALL` establishes the *default action* for a mock method without asserting that the call must happen.

### Syntax
```cpp
ON_CALL(mock_object, MethodName(argument_matchers))
    .WillByDefault(action);
```

### When to Use
- Use `ON_CALL` to set common or fallback behaviors shared across multiple tests.
- Do **not** use `ON_CALL` to expect or require calls; there will be no verification of invocation counts or order.

### Example
```cpp
ON_CALL(mock_database, Connect(_))
    .WillByDefault(Return(true));
```

This makes any `Connect` call return `true` unless overridden by an `EXPECT_CALL`.

---

## 4. Crafting Matchers for Argument Validation

Matchers are predicates that verify method call arguments during expectations.

### Simple Matchers
- `_`: Matches anything.
- `Eq(val)`: Matches exactly `val`.
- `Ge(val)`, `Le(val)`, `Gt(val)`, `Lt(val)`: Greater or less comparisons.
- `NotNull()`, `IsNull()`: Pointers' nullness.

### Combining Matchers
Use logical combinators:
- `AllOf(m1, m2)`: All conditions must hold.
- `AnyOf(m1, m2)`: Any condition holds.
- `Not(m)`: Negate matcher.

### Matching Multiple Arguments as a Tuple
Use `.With()` to match *all* arguments as a single tuple, enabling predicates that relate multiple parameters.

### Validating Object Members
Deep match object fields or properties:
```cpp
EXPECT_CALL(foo, Process(Field(&Bar::count, Ge(5))));
```

---

## 5. Controlling Call Ordering and Cardinality

### Cardinalities
Use `.Times()` to specify how many times an expected call occurs:
- `Exactly(n)` or `n`: Exactly n times.
- `AtLeast(n)`: Minimum n times.
- `AtMost(n)`: Maximum n times.
- `AnyNumber()`: No restrictions.
- `Between(m, n)`: Inclusive range.

Default behavior infers cardinality from actions specified.

### Ordered Calls
Wrap expectations in an `InSequence` block to enforce strict order:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

### Partial Ordering
For less brittle tests, use sequences and `.After()` clauses to impose partial orders between calls:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Init()).InSequence(s1, s2);
EXPECT_CALL(mock, Step1()).InSequence(s1);
EXPECT_CALL(mock, Step2()).InSequence(s2);
```

---

## 6. Specifying Actions and Side Effects

### Built-in Actions
- `Return(value)`: Return a value.
- `ReturnRef(variable)`: Return a reference.
- `ReturnPointee(pointer)`: Return the pointed-to value at call time.
- `SetArgPointee<N>(value)`: Set the value pointed to by argument N.
- `SetArrayArgument<N>(begin, end)`: Copy array into argument N.
- `DoAll(a1, a2, ...)`: Perform multiple actions in sequence, returning the last action’s result.

### Lambda, Functor, or Function as Action
You can specify any callable matching the mock method signature:

```cpp
EXPECT_CALL(mock, Func(_))
    .WillOnce([](int x) { return x * 2; });
```

### Invoking Callbacks passed as Arguments
Use `InvokeArgument<N>(args...)` to invoke the callable argument at position N:

```cpp
EXPECT_CALL(mock, DoAsync(_,_))
    .WillOnce(InvokeArgument<1>(result));
```

### Ignoring Action Results
For actions returning a value but used where `void` is needed, wrap with `IgnoreResult()`.

---

## 7. Best Practices for Reliable Tests

- **Prefer `ON_CALL` for default behavior**, `EXPECT_CALL` only for strict verification.
- Avoid excessive `EXPECT_CALL`s; each adds test fragility.
- Use `NiceMock` to suppress warnings for unexpected calls you don’t care about.
- Order `EXPECT_CALL`s so that more specific expectations are declared *after* more general ones.
- Use `RetiresOnSaturation()` to deactivate an expectation when saturated, keeping other expectations active.

---

## 8. Troubleshooting Common Issues

### Unexpected Calls
An unexpected call is when a method with some expectations is called with arguments not matching any expectation. It is always an error. Verify your matchers and argument values carefully.

### Uninteresting Calls
If a method has no expectations but is called anyway, it’s an uninteresting call. By default, gMock warns about it. Use `NiceMock` to suppress warnings, or add a catch-all expectation with:

```cpp
EXPECT_CALL(mock, Method(_)).Times(AnyNumber());
```

### Action Exhaustion
If you specify fewer `WillOnce()` actions than calls, gMock executes default action unless a `WillRepeatedly()` is defined. Warnings are issued if action count doesn't match cardinality.

### Over-Specified Tests
If you continually have to fix failing tests due to minor internal changes, consider relaxing argument matchers or call order constraints.

---

## 9. Next Steps & Related Topics

- Explore [Defining and Using Mocks](https://google.github.io/googletest/guides/mocking_patterns/defining_and_using_mocks.html) for mock class creation.
- Study the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for recipes on advanced mocking patterns.
- Review [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) for building complex matchers.
- Learn about [Actions and Return Values](https://google.github.io/googletest/reference/actions.html) for custom behaviors.
- Consult [Mocking Framework Setting Expectations](https://google.github.io/googletest/api/gmock_internal.html#EXPECT_CALL) for API details.

---

## 10. Additional Resources

- GoogleMock Main [README and Overview](https://github.com/google/googletest/blob/main/googlemock/README.md)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) – Beginner-friendly introduction
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) – Concise usage summary

---