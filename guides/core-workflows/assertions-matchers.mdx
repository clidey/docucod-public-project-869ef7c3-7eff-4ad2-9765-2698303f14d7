---
title: "Assertions and Matchers in Practice"
description: "A practical guide on using built-in assertions and matchers to express validation logic in tests, with scenarios for equality, floating point, exceptions, and custom matchers for more expressive tests."
---

# Assertions and Matchers in Practice

A practical guide on using built-in assertions and matchers to express validation logic in tests, with scenarios for equality, floating point, exceptions, and custom matchers for more expressive tests.

---

## 1. Introduction

This guide walks you through using **GoogleTest assertions** and **gMock matchers** effectively in your C++ tests. You'll learn how to express validation logic clearly and precisely, enabling robust and meaningful test assertions in various practical scenarios such as equality checks, floating-point comparisons, exception testing, and crafting custom matchers for more expressive tests.

---

## 2. Prerequisites

- A working GoogleTest and GoogleMock setup.
- Basic familiarity with writing tests in GoogleTest and setting up mocks using gMock.
- Knowledge of C++ and the syntax of test cases.

---

## 3. What You Will Achieve

- Confidently use built-in assertions like `EXPECT_EQ`, `EXPECT_FLOAT_EQ`, and `EXPECT_THROW`.
- Apply matchers such as `_`, `Eq()`, `AllOf()`, `AnyOf()`, and `Not()` to specify argument expectations and assert values.
- Use multi-argument matchers and compound matchers for granular control.
- Write custom matchers when built-in ones are insufficient, for domain-specific validation.

---

## 4. Time Estimate

Approximately **30-45 minutes** to read through and experiment with the examples.

---

## 5. Difficulty Level

Intermediate: Familiarity with unit testing and mocking is expected.

---

## 6. Using Built-in Assertions

GoogleTest provides numerous assertion macros for verifying code behavior. The primary assertions include:

### 6.1 Equality Assertions

- `EXPECT_EQ(val1, val2)`: Checks if `val1 == val2`.
- `EXPECT_NE(val1, val2)`: Checks if `val1 != val2`.
- For C strings, use `EXPECT_STREQ(str1, str2)` and `EXPECT_STRNE(str1, str2)`.

Example:

```cpp
EXPECT_EQ(result, expected_value);
EXPECT_STREQ(actual_cstr, "expected_string");
```

### 6.2 Floating Point Comparisons

Exact equality may fail due to rounding errors. GoogleTest provides specialized macros:

- `EXPECT_FLOAT_EQ(a, b)`: Checks `float` equality within 4 ULPs.
- `EXPECT_DOUBLE_EQ(a, b)`: Checks `double` equality within 4 ULPs.
- `EXPECT_NEAR(val1, val2, abs_error)`: Checks |`val1 - val2`| <= `abs_error`.

Example:

```cpp
EXPECT_NEAR(calculated_pi, 3.14159, 0.0001);
```

### 6.3 Exception Assertions

Verify whether code throws or does not throw exceptions.

- `EXPECT_THROW(statement, exception_type)`: Expects `statement` to throw the specified exception type.
- `EXPECT_ANY_THROW(statement)`: Expects any exception.
- `EXPECT_NO_THROW(statement)`: Expects no exceptions.

Example:

```cpp
EXPECT_THROW(FunctionThatThrows(), std::runtime_error);
```

### 6.4 Generalized Assertions with Matchers

Using `EXPECT_THAT(value, matcher)`, you can leverage expressive matchers for validation:

Example:

```cpp
EXPECT_THAT(string_value, StartsWith("Hello"));
EXPECT_THAT(value, AllOf(Gt(5), Lt(10)));
```

---

## 7. Essential gMock Matchers

Matchers form the backbone of argument expectations and value validations in GoogleMock and GoogleTest.

### 7.1 Wildcard Matchers

- `_` matches any value.
- `A<T>()` or `An<T>()` matches any value of type `T`.

### 7.2 Basic Comparison Matchers

- `Eq(v)` for equality.
- `Ne(v)` for inequality.
- `Lt(v)`, `Le(v)`, `Gt(v)`, `Ge(v)` for ordering comparisons.

Example:

```cpp
EXPECT_CALL(mock, Method(Eq(5)));  // Method called with 5.
EXPECT_CALL(mock, Method(Gt(10))); // Argument greater than 10.
```

### 7.3 Compound Matchers

- `AllOf(m1, m2, ...)`: Matches if all inner matchers match.
- `AnyOf(m1, m2, ...)`: Matches if any inner matcher matches.
- `Not(m)`: Negates matcher `m`.

Example:

```cpp
EXPECT_THAT(value, AllOf(Gt(0), Lt(100)));  // Value between 0 and 100.
EXPECT_THAT(text, Not(HasSubstr("error")));  // Text does not contain "error".
```

### 7.4 String Matchers

- `StartsWith(prefix)`, `EndsWith(suffix)`, `HasSubstr(substr)`.
- `StrEq(str)`, `StrNe(str)`, `StrCaseEq(str)` (case-insensitive equality).

Example: 

```cpp
EXPECT_THAT(username, StartsWith("user_"));
```

### 7.5 Container Matchers

- `ElementsAre(...)`: Matches sequential order and values in a container.
- `UnorderedElementsAre(...)`: Matches container elements disregarding order.
- `Contains(m)`: Checks if an element matches.

Example:

```cpp
EXPECT_THAT(vec, ElementsAre(1, 2, 3));
EXPECT_THAT(set, UnorderedElementsAre(3, 1, 2));
```

### 7.6 Pointer and Property Matchers

- `IsNull()`, `NotNull()` for pointers.
- `Pointee(m)`: Matches the pointee of a pointer.
- `Field(&Class::field, m)`: Matches a class member field.
- `Property(&Class::getter, m)`: Matches based on the return value of a getter method.

Example:

```cpp
EXPECT_CALL(mock, Foo(Pointee(Gt(5))));  // Argument points to value > 5.
EXPECT_THAT(obj, Field(&MyClass::id, Eq(42)));
```

### 7.7 Multi-argument Matchers and `With()` Clause

Use `With()` to match all arguments together as a tuple. For example, expect first argument less than second:

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .With(Lt());  // Match on tuple of arguments.
```

---

## 8. Setting Expectations with Assertions and Matchers

### 8.1 Using `EXPECT_CALL`

Use `EXPECT_CALL(mock_obj, Method(matchers...))` to set the expected calls on mocks.

Example:

```cpp
EXPECT_CALL(mock_turtle, Forward(Ge(10))).Times(3);
```

This expects `Forward` called with an argument >= 10 exactly 3 times.

### 8.2 Chaining Modifiers

You can chain clauses like `.With()`, `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()`, `.WillRepeatedly()`, and `.RetiresOnSaturation()` to tailor behavior.

Example combining clauses:

```cpp
EXPECT_CALL(mock, Calculate(_, _))
    .With(AllOf(Args<0>(Gt(0)), Args<1>(Le(100))))
    .Times(AtLeast(1))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

### 8.3 Using Assertions in Matchers

Matchers can be used with GoogleTest assertions such as `EXPECT_THAT()`.

Example:

```cpp
int value = GetValue();
EXPECT_THAT(value, AllOf(Ge(5), Le(10)));
```

### 8.4 Handling Floating-Point and Exceptions

- Use `EXPECT_FLOAT_EQ` and `EXPECT_DOUBLE_EQ` for approximate equality.
- Use `EXPECT_THROW` and `EXPECT_NO_THROW` to test exception throwing behavior.

---

## 9. Crafting Custom Matchers

When built-in matchers aren't enough, you can define your own matcher class or use the `MATCHER` macros for concise definitions.

### 9.1 Using `MATCHER` Macro

Define a simple matcher:

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}
```

Use it:

```cpp
EXPECT_CALL(mock, Foo(IsEven()));
EXPECT_THAT(value, IsEven());
```

### 9.2 Parameterized Matchers

Use `MATCHER_P` for matchers with parameters:

```cpp
MATCHER_P(IsMultipleOf, divisor, "checks divisibility") {
  return arg % divisor == 0;
}
```

Use it:

```cpp
EXPECT_THAT(value, IsMultipleOf(3));
```

### 9.3 Enhanced Failure Messages

Your matcher can explain failures:

```cpp
MATCHER_P(IsMultipleOf, divisor, "") {
  if (arg % divisor == 0) return true;
  *result_listener << "the remainder is " << (arg % divisor);
  return false;
}
```

This produces clearer messages on test failure.

---

## 10. Practical Examples

### 10.1 Equality Example

```cpp
EXPECT_EQ(my_mock.GetSize(), expected_size);
EXPECT_THAT(value, Eq(42));
```

### 10.2 Floating-Point Example

```cpp
EXPECT_FLOAT_EQ(calculated_value, expected_value);
EXPECT_NEAR(delta, 0.01, 0.001);
```

### 10.3 Exception Example

```cpp
EXPECT_THROW(FunctionThatThrows(), std::runtime_error);
EXPECT_NO_THROW(FunctionThatDoesNotThrow());
```

### 10.4 Using Matchers in EXPECT_CALL

```cpp
EXPECT_CALL(mock, Calculate(Ge(10), _))
    .WillOnce(Return(5));
```

### 10.5 Composing Matchers

```cpp
EXPECT_THAT(name, AllOf(StartsWith("Mr."), EndsWith("Smith")));
```

### 10.6 Custom Matcher Use

```cpp
MATCHER(IsPrime, "checks for prime numbers") {
  // Custom check
  return IsPrimeNumber(arg);
}
EXPECT_THAT(candidate, IsPrime());
```

---

## 11. Troubleshooting & Best Practices

- **Avoid Over-Specification:** Specify only necessary constraints to prevent brittle tests.
- **Use `ON_CALL` for Default Behavior:** Define default mock behavior with `ON_CALL` and reserve `EXPECT_CALL` for expected usage.
- **Suppress Uninteresting Call Warnings:** Use `NiceMock` to suppress these warnings when appropriate.
- **Retire Expectations Wisely:** Use `.RetiresOnSaturation()` to prevent expectations from lingering and causing unexpected failures.
- **Fail Fast:** Set expectations before exercising mock objects to catch issues immediately.
- **Proper Use of Matchers:** Match arguments precisely or use `_` when argument is unimportant.

Common issues:
- Using overloaded methods without disambiguation.
- Forgetting to specify `.WillByDefault()` in `ON_CALL()` causing runtime errors.

---

## 12. Next Steps & Additional Resources

- Explore the comprehensive [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) for quick syntax reference.
- Deepen your mocking expertise in the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html).
- Learn to write and use mocks effectively with [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html).
- Understand mock expectations and matchers in the [Mocking Reference](https://google.github.io/googletest/reference/mocking.md).

---

## 13. Summary

This guide equipped you with the practical knowledge needed to write powerful test validation logic in GoogleTest and GoogleMock using assertions and matchers. You learned how to use standard assertions for equality, floating-point precision, and exception validation, apply gMockâ€™s rich matcher set to express argument expectations, handle multi-argument matching, and create custom matchers for precise, domain-specific checks.

Consider this guide an essential stepping stone toward mastering unit test assertions and mocks integration for expressive, maintainable, and robust C++ tests.
