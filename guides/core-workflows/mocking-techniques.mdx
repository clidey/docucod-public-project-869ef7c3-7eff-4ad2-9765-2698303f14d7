---
title: "Effective Mocking Techniques"
description: "Best practices for building complex mock behavior, setting call expectations, sequencing, and dealing with uninteresting calls using NiceMock, NaggyMock, and StrictMock."
---

# Effective Mocking Techniques

Learn how to build sophisticated mock behaviors, control function call expectations, manage call sequences, and handle uninteresting mock calls effectively using GoogleMock's `NiceMock`, `NaggyMock`, and `StrictMock` wrappers.

---

## 1. Overview

### What You'll Achieve
By following this guide, you will master advanced techniques for crafting mocks that precisely represent complex interactions. You'll manage when and how mock methods are expected to be called, order these calls effectively, and handle unexpected or uninteresting calls gracefully.

### Prerequisites
- Familiarity with basic mocking concepts and mocking classes with `MOCK_METHOD` (see [Introduction to Mocking](../getting-started/introduction-to-mocking)).
- Understanding of `EXPECT_CALL` and `ON_CALL` mechanics.
- Basic knowledge of GoogleMock test syntax and matcher usage.

### Time Estimate
About 20-30 minutes to read and practice with examples.

### Difficulty Level
Intermediate

---

## 2. Managing Complex Mock Behavior

### 2.1 Creating Mock Classes with `MOCK_METHOD`
Mock classes are created by deriving from interfaces or classes to be mocked and using the `MOCK_METHOD` macro:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(ReturnType, MethodName, (Args...), (override));
};
```

- Place all `MOCK_METHOD` declarations in the `public` section, regardless of the original method's access.
- Wrap return or argument types with commas (like `std::pair<bool, int>`) either in parentheses or via `using` aliases to avoid parsing errors.

### 2.2 Mocking Specific Cases
- **Overloaded methods**: Mock them individually, and use `using` declarations to avoid hiding base class overloads.
- **Non-virtual methods**: Can be mocked by defining a mock class with unrelated class inheritance and matching signatures.
- **Free functions**: Cannot be mocked directly; consider wrapping in interfaces.

<Tip>
Always add `override` in `MOCK_METHOD` where applicableâ€”it clarifies intent and prevents subtle bugs.
</Tip>

## 3. Setting Call Expectations

### 3.1 Understand `ON_CALL` vs `EXPECT_CALL`
- **`ON_CALL`** sets default behavior _without_ setting an expectation that the call must happen.
- **`EXPECT_CALL`** sets an expectation that the method will be called with given arguments, potentially multiple times, and optionally orders it.

Use `ON_CALL` liberally to define default mock behavior.
Use `EXPECT_CALL` only when you want to *verify* that a specific call happens.

### 3.2 Best Practices for Expectations
- Prefer minimal effective expectations to avoid brittle tests.
- Use `.Times()` to specify cardinality, e.g., `.Times(AtLeast(1))`.
- Use `.WillOnce()` and `.WillRepeatedly()` to specify behavior per-call.
- Use `.RetiresOnSaturation()` to make expectations non-sticky after fulfillment.

### 3.3 Handling Uninteresting Calls
By default, calls to mock methods with no `EXPECT_CALL` produce warnings.

Control these warnings per mock object by instantiating with:

```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock;   // Suppresses warnings
NaggyMock<MockFoo> naggy_mock; // Prints warnings (default behavior)
StrictMock<MockFoo> strict_mock; // Treats uninteresting calls as errors
```

### 3.4 When to Use Each Mock Wrapper
- **`NiceMock`** for tests where uninteresting calls are okay, reducing noise.
- **`NaggyMock`** (default) while developing tests to notice unreviewed calls.
- **`StrictMock`** when you want to catch any call that was not explicitly expected and fail the test.

<Warning>
Use `StrictMock` cautiously; it can make tests overly fragile to implementation changes.
</Warning>

## 4. Sequencing and Ordering Expectations

### 4.1 Using `InSequence`
Group expectations to enforce the order in which calls occur:

```cpp
{
  ::testing::InSequence seq;

  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
  EXPECT_CALL(mock, ThirdCall());
}
```

Calls must happen in the declared order or the test fails.

### 4.2 Partial Ordering via `Sequence` Objects
For more complex partial ordering, create named `Sequence` objects:

```cpp
::testing::Sequence s1, s2;

EXPECT_CALL(mock, CallA()).InSequence(s1);
EXPECT_CALL(mock, CallB()).InSequence(s1, s2);
EXPECT_CALL(mock, CallC()).InSequence(s2);
```

This allows specifying DAG-like call order constraints.

### 4.3 Using `.After()`
Specify dependencies between expectations:

```cpp
using ::testing::Expectation;

Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Run()).After(e1);
```

`Run()` is expected only after `Init()` completes.

## 5. Call Behavior Customization

### 5.1 Actions
Inside `WillOnce()` or `WillRepeatedly()`, specify actions such as:

- `Return(value)` - return a value.
- `ReturnRef(ref)` - return by reference.
- `ReturnPointee(ptr)` - return the value pointed to by `ptr` at call time.
- `DoAll(actions...)` - execute multiple actions, returning the last one's result.
- `Invoke(function|lambda)` - invoke a user-provided callable.
- `SetArgPointee<index>(value)` - change output argument.

### 5.2 Delegating Calls
- To a **fake** object:

```cpp
class MockFoo : public Foo {
  MOCK_METHOD(int, DoThis, (int), (override));
  FakeFoo fake_;  // A fake object
  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault([this](int n) {
      return fake_.DoThis(n);
    });
  }
};
```

- To a **real** object:

```cpp
class MockFoo : public Foo {
 public:
  MockFoo() {
    ON_CALL(*this, DoThis).WillByDefault([this](int n) {
      return real_.DoThis(n);
    });
  }
  ...
 private:
  Foo real_;  // Actual real object
};
```

- To a **parent class** method:

```cpp
ON_CALL(mock, ConcreteMethod).WillByDefault([&mock](const ArgType& arg) {
  return mock.Foo::ConcreteMethod(arg);  // Avoid infinite recursion
});
```

## 6. Handling Uninteresting Calls

### 6.1 Definitions
- **Uninteresting call**: A call to a mock method with *no* matching `EXPECT_CALL` specified.
- **Unexpected call**: A call to a mock method where some `EXPECT_CALL` exists, but no expectation matches the arguments.

An uninteresting call triggers a warning (naggy) or is ignored (nice), or fails (strict).
An unexpected call is always an error.

### 6.2 Strategies to Manage Uninteresting Calls
- Use `NiceMock` to suppress warnings if they are noise.
- Use targeted `EXPECT_CALL(...).Times(AnyNumber())` to silence warnings for specific methods.

### 6.3 Suppressing Warnings Example

```cpp
EXPECT_CALL(mock, SomeMethod(_)).Times(AnyNumber());
```

This tells GoogleMock that you're okay with any number of calls.

## 7. Troubleshooting Common Issues

### 7.1 Unexpected Method Called
- Verify the arguments match the `EXPECT_CALL` matchers.
- Check ordering constraints if any sequences are used.

### 7.2 Uninteresting Call Warnings
- Confirm you intended to only `ON_CALL` for default behaviors.
- Use `NiceMock` if these calls are irrelevant to the test logic.

### 7.3 Overrun Action Warnings
- If more calls are made than `WillOnce()` provides, add `WillRepeatedly()` or increase `.Times()` cardinality.

<Tip>
Use `--gmock_verbose=info` flag to see detailed logs of mock calls and expectation matches, greatly aiding diagnosis.
</Tip>

## 8. Summary and Best Practices

- Use `ON_CALL` to define default behaviors.
- Use `EXPECT_CALL` *only* when verifying that calls must happen.
- Use `NiceMock` to keep tests less noisy about irrelevant calls.
- Use sequences (`InSequence`, `Sequence`) to enforce call ordering.
- Use `.RetiresOnSaturation()` to avoid sticky expectations causing false failures.
- Delegate to fakes or real objects if your mock's default implementation is complex.
- Prefer minimal and clear expectations to avoid brittle tests.

---

## References and Further Reading

- [gMock Cookbook for Complete Recipes](../docs/gmock_cook_book.md)
- [Mocking Reference](../docs/reference/mocking.md)
- [Introduction to Mocking Guide](../guides/getting-started/introduction-to-mocking.md)
- [Understanding Uninteresting vs Unexpected Calls](../docs/gmock_cook_book.md#uninteresting-vs-unexpected)
- [Mock Wrappers: NiceMock, NaggyMock, StrictMock](../docs/gmock_cook_book.md#NiceStrictNaggy)

---

## Appendix: Example

```cpp
#include <gmock/gmock.h>
using ::testing::_;  // wildcard matcher
using ::testing::NiceMock;
using ::testing::Return;

class Foo {
 public:
  virtual ~Foo() = default;
  virtual int DoSomething(int x) = 0;
  virtual void DoNothing() = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, DoSomething, (int x), (override));
  MOCK_METHOD(void, DoNothing, (), (override));
};

TEST(MockTest, Example) {
  // Create a NiceMock to suppress warnings on uninteresting calls.
  NiceMock<MockFoo> mock_foo;

  // Provide a default behavior for DoSomething.
  ON_CALL(mock_foo, DoSomething(_)).WillByDefault(Return(42));

  // Expect DoSomething(5) to be called once and return 10.
  EXPECT_CALL(mock_foo, DoSomething(5)).WillOnce(Return(10));

  // DoNothing calls are uninteresting and ignored silently because of NiceMock.

  int result = mock_foo.DoSomething(5);  // returns 10
  int default_result = mock_foo.DoSomething(7);  // returns 42

  mock_foo.DoNothing();  // No warning due to NiceMock

  EXPECT_EQ(result, 10);
  EXPECT_EQ(default_result, 42);
}
```

---

This example demonstrates key principles: using `NiceMock`, `ON_CALL` to set default behavior, and `EXPECT_CALL` to specify and verify specific calls.

---