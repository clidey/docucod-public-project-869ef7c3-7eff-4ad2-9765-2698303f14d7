---
title: "Writing and Using Mocks Effectively"
description: "A practical guide to creating and leveraging mock objects, including crafting expectations, stubbing behaviors, and selecting the right strictness levels for different testing needs. This page introduces key macros and patterns and demonstrates handling common mocking scenarios."
---

# Writing and Using Mocks Effectively

A practical guide to creating and leveraging mock objects, including crafting expectations, stubbing behaviors, and selecting the right strictness levels for different testing needs. This page introduces key macros and patterns and demonstrates handling common mocking scenarios.

---

## 1. Introduction to Mocking

Mocking is a powerful technique that allows you to simulate and control the behavior of dependencies in your C++ tests. By using mock objects, you can focus on testing a unit in isolation, verifying interactions, and tuning behavior dynamically.

This guide focuses on effective creation and use of mock objects in GoogleTest with GoogleMock (gMock).

---

## 2. Defining Mock Classes

GoogleMock provides the `MOCK_METHOD` macro to generate mock methods in a mock class. When defining a mock class:

- Always inherit from the class to mock (or implement its interface).
- Place `MOCK_METHOD` declarations in the `public:` section.
- Specify method signature pieces including return type, method name, argument list, and method qualifiers (like `const`, `override`).

### Example: Mocking a Simple Interface

```cpp
class Foo {
 public:
  virtual ~Foo() = default;
  virtual int GetSize() const = 0;
  virtual void Process(int data) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Process, (int data), (override));
};
```

### Notes:
- If the class being mocked has overloaded methods, mock each overload explicitly.
- Use parentheses around complex types with commas to avoid macro parsing errors.
- For class templates, mock them similarly by providing templated mock classes.

---

## 3. Setting Expectations on Mock Methods

Expectations define how many times and in what way mock methods are expected to be called.

### Typical Workflow
1. Instantiate the mock object.
2. Use `EXPECT_CALL` to declare expectations on mock methods.
3. Optionally set default behaviors with `ON_CALL`.
4. Exercise the code under test that interacts with the mocks.
5. GoogleMock automatically verifies expectations at mock destruction or on explicit verification.

### Syntax Overview:

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action)
    .InSequence(sequence1, sequence2)
    .After(expectation1, expectation2)
    .RetiresOnSaturation();
```


### Key Clauses:

- **`Times(cardinality)`**: How many times the method is expected. Examples include `Exactly(n)`, `AnyNumber()`, `AtLeast(n)`, `AtMost(n)`, and `Between(m, n)`.
- **`WillOnce(action)`**: Behavior for the next matching call.
- **`WillRepeatedly(action)`**: Behavior for all subsequent calls after `WillOnce` actions are used.
- **`InSequence(...)`**: Specifies that calls must occur in the order the expectations are declared within the referenced sequences.
- **`After(...)`**: Specifies that certain expectations must happen after other calls.
- **`RetiresOnSaturation()`**: Automatically disables the expectation after the expected calls have been satisfied.

### Example: Setting Expectations

```cpp
using ::testing::Return;

MockFoo mock;

EXPECT_CALL(mock, GetSize())
    .Times(3)
    .WillRepeatedly(Return(42));

EXPECT_CALL(mock, Process(5))
    .WillOnce(Return())
    .WillRepeatedly(Return());

// Use mock in the code under test.
```


### Best Practices
- Set expectations **before** exercising code that calls the mock.
- Use matchers (like `_`, `Eq()`, `Lt()`, `Ge()`) to specify argument constraints.
- Avoid over-specifying arguments to keep tests maintainable.

---

## 4. Using Default Behaviors with `ON_CALL`

While `EXPECT_CALL` sets an expectation with verification, `ON_CALL` specifies default behavior without requiring a call.

### Usage:

```cpp
ON_CALL(mock, MethodName(matchers...))
    .WillByDefault(action);
```

### Purpose:
- Allows you to provide default return values or actions for methods.
- Avoids warnings about uninteresting calls when a method is called with no explicit expectation.

### Example:

```cpp
using ::testing::Return;

MockFoo mock;
ON_CALL(mock, GetSize())
    .WillByDefault(Return(10));
```

Now calls to `mock.GetSize()` will return 10 unless overridden by `EXPECT_CALL`.

---

## 5. Choosing Mock Strictness Levels

GoogleMock supports three mock strictness levels that control behavior on uninteresting calls (methods called with no expectations). Uninteresting calls are:

- Calls to mock methods that have no `EXPECT_CALL` defined.

### Strictness Types:

| Mock Type               | Behavior on Uninteresting Calls                 | When to Use                                   |
|------------------------|------------------------------------------------|-----------------------------------------------|
| **NaggyMock** (default) | Prints a warning but allows the call.           | Use during active test development and debugging.
|
| **NiceMock<T>**         | Suppresses warnings, allows calls silently.     | For tests where you want to ignore irrelevant calls and keep output clean.
|
| **StrictMock<T>**       | Treats uninteresting calls as failures.         | When you want full coverage of method calls and the most strict check.

### Usage:

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock_foo;  // Suppresses warnings on uninteresting calls
StrictMock<MockFoo> strict_mock_foo;  // Treats uninteresting calls as failures
```

### Important Notes:
- `NiceMock` and `StrictMock` only work if mock methods are declared with `MOCK_METHOD` directly in the mock class (not inherited).
- Switching to strict mocks may cause brittle tests if mocks expect many calls to uninteresting methods.
- Consider using `NiceMock` for larger, more complex mocks to reduce noise.

---

## 6. Working with Matchers and Actions

Matchers specify criteria for expectation arguments. Actions define what the mock method does when called.

### Common Matchers
- `_`: Matches any argument.
- `Eq(value)`: Matches arguments equal to `value`.
- `Ge(value)`, `Le(value)`, `Lt(value)`, `Gt(value)`: Comparison matchers.

### Actions Reference
- `Return(value)`: Return a value.
- `ReturnRef(variable)`: Return a reference to a variable.
- `SetArgPointee<N>(value)`: Assign to output argument pointer.
- `Invoke(func)`: Call a function or functor.
- `DoAll(action1, action2, ...)`: Perform multiple actions sequentially.

For a full list of matchers and actions, see [Matchers Reference](../api_reference/core_testing_apis/matchers_reference) and [Actions Reference](../api_reference/core_testing_apis/actions_reference).

---

## 7. Testing Call Order and Cardinality

### Cardinality
Controls how many times a method is expected to be called.

- `Exactly(n)` or `Times(n)`: Call exactly n times.
- `AnyNumber()`: Any number of calls.
- `AtLeast(n)`: At least n times.
- `AtMost(n)`: At most n times.
- `Between(m, n)`: Between m and n times, inclusive.

### Call Ordering
- By default, expectations match calls in any order.
- Use sequences to enforce order:

```cpp
using ::testing::Sequence;
Sequence s;
EXPECT_CALL(mock, Foo()).InSequence(s);
EXPECT_CALL(mock, Bar()).InSequence(s);
```

- For partial orders, use `After`:

```cpp
Expectation e1 = EXPECT_CALL(mock, Foo());
EXPECT_CALL(mock, Bar()).After(e1);
```

---

## 8. Verifying and Resetting Mocks

Verification happens automatically when mock objects are destructed.

You can manually verify and clear expectations:

```cpp
using ::testing::Mock;

Mock::VerifyAndClearExpectations(&mock_obj);  // Verify and clear expectations
Mock::VerifyAndClear(&mock_obj);               // Verify, clear expectations and default actions
```

Use these only after you stop exercising the mock, never set new expectations after verification as it results in undefined behavior.

If a mock object is intentionally leaked (e.g., owned outside test scope), mark it as leaked to skip verification:

```cpp
Mock::AllowLeak(&mock_obj);
```

---

## 9. Advanced Topics and Tips

- **Mocking Move-Only Types:** GoogleMock supports mocking methods with `std::unique_ptr` and other move-only types.
- **Delegating Calls:** You can delegate mocks to real or fake objects to preserve behavior while verifying interactions.
- **Mocking Non-Virtual Methods:** Possible using templates and compile-time injection.
- **Checking Arguments:** Save arguments with `SaveArg<N>` to verify complex calls.

---

## 10. Troubleshooting Common Issues

- **Uninteresting Call Warnings:** Use `NiceMock` to suppress or add broad `EXPECT_CALL` to explicitly allow calls.
- **Unexpected Calls:** Verify arguments and the order of `EXPECT_CALL` statements.
- **Virtual Destructor Requirement:** Ensure base classes have virtual destructors to avoid leaks.
- **Overloaded Methods:** Mock all overloads to avoid hidden method warnings.
- **Performance:** Define constructor and destructor outside headers to speed compilation.

---

## 11. Summary

By defining mocks with `MOCK_METHOD`, setting clear expectations with `EXPECT_CALL`, and selecting the appropriate strictness level (`NiceMock`, `NaggyMock`, `StrictMock`), you create robust and maintainable tests. Use `ON_CALL` to provide default behaviors, and leverage matchers and actions to describe interactions precisely.

Always verify and clear mocks correctly and learn to handle common pitfalls like unexpected/uninteresting calls or overload ambiguities. The thoughtful use of sequences and cardinalities enforces correct call order and frequency.

---

## 12. Additional Resources

- [Matchers Reference](../api_reference/core_testing_apis/matchers_reference)
- [Actions Reference](../api_reference/core_testing_apis/actions_reference)
- [Mocking Reference](../api_reference/mocking_and_expectations/creating_mock_objects)
- [gMock for Dummies Guide](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

---

Feel free to explore the [GoogleTest User's Guide](https://google.github.io/googletest/) for broader context and to expand your mastery of C++ testing with GoogleTest and GoogleMock.