---
title: "Mocking Techniques and Patterns"
description: "Explores practical ways to use GoogleMock for dependency injection, controlling object behavior in tests, and verifying interactions. Demonstrates patterns for ON_CALL, EXPECT_CALL, and action/matcher combinations."
---

# Mocking Techniques and Patterns

This guide explores practical approaches to using GoogleMock for dependency injection, managing mock object behavior during tests, and verifying interactions effectively. You will learn how to utilize patterns involving `ON_CALL`, `EXPECT_CALL`, and combinations of actions and matchers to write robust, maintainable tests.

---

## 1. Understanding the Workflow

### Task Description
This page helps you master practical mocking techniques that enable precise control over mock objects in your tests. You will learn how to set default behaviors, specify exact call expectations, combine actions and matchers, and compose interaction patterns to ensure your tests verify component collaborations accurately.

### Prerequisites
- Basic understanding of GoogleMock and mock class definitions.
- Familiarity with mock methods, matchers for specifying expected arguments, and actions for defining mock responses.
- Access to a mock class you intend to use in your test.

### Expected Outcome
By following this guide, you'll be able to:
- Apply `ON_CALL` to set default mock method behaviors without enforcing call counts.
- Use `EXPECT_CALL` to declare expectations, including call counts, argument matching, and return behaviors.
- Combine multiple expectations and handle ordered vs unordered calls.
- Control mock method call policies through wrappers like `NiceMock`, `StrictMock`, and `NaggyMock`.

### Time Estimate
Allocate approximately 20-30 minutes to absorb the concepts and practice examples.

### Difficulty Level
Intermediate: assumes you have some experience writing tests with GoogleMock.

---

## 2. Core Techniques and Patterns

### Using `ON_CALL` for Default Behaviors
Set up default method behaviors to respond predictably without requiring those methods to be called.

```cpp
ON_CALL(mock_object, Method(matchers))
    .WillByDefault(Return(default_value));
```

- Only specify behaviors, no enforcement on whether the method must be called.
- Useful for setting common behavior shared across tests or in test fixture setup.
- When multiple `ON_CALL`s apply, the latest matching one takes precedence.

### Using `EXPECT_CALL` for Verified Calls
Declare expectations that specify which methods must be called, with what arguments and how often.

```cpp
EXPECT_CALL(mock_object, Method(matchers))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- Must be declared before the code-under-test exercises the mock.
- If omitted, GoogleMock assumes one call (`Times(1)`).
- Supports argument matchers for precise filtering.
- Allows sequencing (`InSequence`) and ordering with multiple expectations.

### Combining `ON_CALL` and `EXPECT_CALL`
- `ON_CALL`: establishes baseline default behavior.
- `EXPECT_CALL`: overrides for calls you intend to verify explicitly.

Use `ON_CALL` extensively to reduce boilerplate and tighten test focus, adding `EXPECT_CALL` only as needed:

```cpp
ON_CALL(foo, GetValue(_)).WillByDefault(Return(0));
EXPECT_CALL(foo, GetValue(5)).Times(1).WillOnce(Return(42));
```

### Controlling Call Ordering and Sequences

- Use `InSequence` to enforce exact call order:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

- Use sequences to define partial or complex orders across multiple mock objects:

```cpp
Sequence seq1, seq2;
EXPECT_CALL(mockA, Foo()).InSequence(seq1, seq2);
EXPECT_CALL(mockB, Bar()).InSequence(seq1);
EXPECT_CALL(mockB, Baz()).InSequence(seq2);
```

- Use `After` clauses to specify dependency on other expectations.

### Handling Multiple Expectations on the Same Method

GoogleMock matches the last matching expectation first. For example:

```cpp
EXPECT_CALL(mock, Func(_));          // #1
EXPECT_CALL(mock, Func(10)).Times(2); // #2
```

Calls to `Func(10)` will match expectation #2 first, falling back to #1 if #2 is saturated.

### Retiring Expectations

Use `.RetiresOnSaturation()` to make an expectation inactive once it has been met.

```cpp
EXPECT_CALL(mock, Foo()).Times(2).RetiresOnSaturation();
EXPECT_CALL(mock, Foo()); // catch-all for further calls
```

Without this, saturated expectations remain active and may cause upper-bound errors.

---

## 3. Practical Examples

### Example: Setting Default Behavior and Specific Expectations

```cpp
#include <gmock/gmock.h>
using ::testing::_;
using ::testing::Return;

class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (), ());
  MOCK_METHOD(int, GetRecordCount, (const std::string& table), ());
};

TEST(DatabaseTest, UsesMockDatabase) {
  MockDatabase mock_db;

  // Default: Connect returns true.
  ON_CALL(mock_db, Connect()).WillByDefault(Return(true));

  // Expect Connect to be called once.
  EXPECT_CALL(mock_db, Connect()).Times(1);

  // Expect GetRecordCount to be called with any string, returns 42.
  EXPECT_CALL(mock_db, GetRecordCount(_)).WillRepeatedly(Return(42));

  // Code under test elicits mock calls...
  mock_db.Connect();
  int count = mock_db.GetRecordCount("users");
  EXPECT_EQ(count, 42);
}
```

### Example: Ordered Calls

```cpp
TEST(SequenceTest, StrictOrderOfOperations) {
  MockDatabase mock_db;
  {
    InSequence s;
    EXPECT_CALL(mock_db, Connect());
    EXPECT_CALL(mock_db, GetRecordCount("users"));
    EXPECT_CALL(mock_db, GetRecordCount("orders"));
  }

  // Calls must be in order:
  mock_db.Connect();
  mock_db.GetRecordCount("users");
  mock_db.GetRecordCount("orders");
}
```

### Example: Using NiceMock to Ignore Uninteresting Calls

```cpp
#include <gmock/gmock.h>
using ::testing::NiceMock;

NiceMock<MockDatabase> mock_db;

EXPECT_CALL(mock_db, Connect()).Times(1);

// Calls to other methods without expectations don't raise warnings.
mock_db.Connect();
mock_db.GetRecordCount("anything");  // No warning
```

### Example: Delegating a Mock's Default Behavior to a Real Implementation

```cpp
class RealDatabase {
 public:
  bool Connect() { /* real connect code */ return true; }
  int GetRecordCount(const std::string& table) { /* real code */ return 10; }
};

class MockDatabase : public RealDatabase {
 public:
  MOCK_METHOD(bool, Connect, (), (override));
  MOCK_METHOD(int, GetRecordCount, (const std::string& table), (override));

  MockDatabase() {
    ON_CALL(*this, Connect()).WillByDefault([this]() { return real_.Connect(); });
    ON_CALL(*this, GetRecordCount(_)).WillByDefault(
        [this](const std::string& table) { return real_.GetRecordCount(table); });
  }

 private:
  RealDatabase real_;
};
```

With this, you can still specify `EXPECT_CALL` to verify calls, while behaving like the real database by default.

---

## 4. Best Practices and Tips

- **Prefer `ON_CALL` for default behaviors:** Avoid over-constraining tests unnecessarily.
- **Use explicit `EXPECT_CALL` sparingly:** Only when verifying actual call expectations.
- **Order matters:** Place more specific expectations after more general ones for proper overriding.
- **Use sequences to assert strict or partial order only when necessary:** Overly strict ordering can make tests brittle.
- **Suppress noisy warnings with `NiceMock`:** Use `NiceMock` for mocks with many uninteresting calls.
- **Use `RetiresOnSaturation()` to manage multiple overlapping expectations:** Helps prevent excessive call errors.
- **Avoid mocking classes you do not own:** To reduce maintenance overhead, mock interfaces you control.

---

## 5. Common Pitfalls & Troubleshooting

### Uninteresting Call Warnings
If you see `Uninteresting mock function call` warnings:
- Consider adding a catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());`
- Alternatively use `NiceMock` to silence them globally.

### Unexpected Calls
If the test fails with unexpected call errors:
- Verify that you have set correct `EXPECT_CALL`s before exercising the mock.
- Ensure argument matchers cover all expected cases.

### Too Many / Too Few Actions Warnings
- Check the number of `.WillOnce()` clauses matches your `Times()` expectation.
- Use `WillRepeatedly()` to define fallback behaviors for excess calls.

### Ordering Errors
- Use `InSequence` or `Sequence` properly to encode required call order.
- Avoid partial ordering when exact order is not required to reduce fragile tests.

---

## 6. Next Steps and Related Content

- **Defining and Using Mock Classes**: Learn how to define mock interfaces and use `MOCK_METHOD`.
- **Setting Expectations and Actions**: Deep dive on `EXPECT_CALL` and `ON_CALL` clauses.
- **Matchers for Arguments and Outcomes**: Explore the wide variety of argument matchers available.
- **Actions for Controlling Behavior**: Discover predefined and custom actions for mock methods.
- **Controlling Mock Call Policies**: Use `NiceMock`, `StrictMock`, and `NaggyMock` to manage uninteresting calls.

For a beginner-friendly start, consider:
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Your First Mock with GoogleMock](../getting-started/first-mock-example)

---

<AccordionGroup title="Key Patterns">
<Accordion title="Using ON_CALL for Default Behavior">
Use `ON_CALL` to specify the default action your mock methods should perform when called. This allows tests to pass even without explicit expectations.

```cpp
ON_CALL(mock, Method(_))
    .WillByDefault(Return(default_value));
```
</Accordion>
<Accordion title="Defining Precise Expectations with EXPECT_CALL">
Use `EXPECT_CALL` to enforce that certain mock methods are called with expected arguments and cardinalities.

```cpp
EXPECT_CALL(mock, Method(ArgMatcher))
    .Times(1)
    .WillOnce(Return(specific_value));
```
</Accordion>
<Accordion title="Sequences and Ordering">
Wrap multiple `EXPECT_CALL`s inside an `InSequence` block to enforce order:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
```
</Accordion>
<Accordion title="Managing Uninteresting Calls">
Suppress warnings about uninteresting calls using `NiceMock` or handle them strictly with `StrictMock`.

```cpp
NiceMock<MockClass> nice_mock;
StrictMock<MockClass> strict_mock;
```
</Accordion>
</AccordionGroup>

---