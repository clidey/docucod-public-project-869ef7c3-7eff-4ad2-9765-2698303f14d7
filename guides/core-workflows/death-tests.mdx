---
title: "Death Tests and Error Handling"
description: "Shows how to use death tests to verify that code fails as expected under certain conditions, helping ensure the correctness of error handling and precondition checks."
---

# Death Tests and Error Handling

This guide helps you write and understand death tests in GoogleTest, which verify that your code fails as expected under specific conditions. Death tests are critical to ensure your program’s assertions, error handling, and precondition checks behave correctly by terminating the process when necessary.

---

## What Are Death Tests?

Death tests are tests that verify that certain code triggers process termination (death), either by calling `exit()`, aborting, or being killed by signals. They ensure that failures such as assertion violations, invalid states, or fatal errors cause the program to stop immediately as intended.

> Note: Exceptions do **not** count as process death, since they can be caught and handled. For testing exceptions, see Exception Assertions.

---

## Why Use Death Tests?

Assertions or fatal checks guarantee program correctness by stopping execution when unexpected states occur. Testing these guarantees with death tests helps avoid continued execution in an inconsistent state that could lead to security or stability problems.

Death tests give you confidence that your error handling and validation statements function correctly and prevent undefined behavior or data corruption.

---

## How to Write a Death Test

GoogleTest provides macros to write death tests easily within your test functions. The macros take a block of code that is expected to die and a matcher for the error output.

### Commonly Used Macros

| Macro           | Behavior                                                                                       |
|-----------------|------------------------------------------------------------------------------------------------|
| `ASSERT_DEATH`  | Assert that `statement` causes process death and matches output; aborts current function on failure. |
| `EXPECT_DEATH`  | Expect that `statement` causes process death and matches output; continues on failure.           |
| `ASSERT_EXIT`   | Assert that `statement` causes process exit with a specific exit code predicate and output match; aborts function on failure. |
| `EXPECT_EXIT`   | Same as `ASSERT_EXIT` but continues on failure.                                                |
| `EXPECT_DEBUG_DEATH` | Runs like `EXPECT_DEATH` in debug mode, otherwise executes code normally without asserting death. |

### Simple Example

```cpp
TEST(MyDeathTest, ExampleUsage) {
  // Verify that foo crashes with an error message containing "error".
  ASSERT_DEATH(foo(), "error");

  // Verify a function exits normally with code 0 and prints "Success".
  EXPECT_EXIT(NormalExit(), ::testing::ExitedWithCode(0), "Success");

  // Verify a function is killed by SIGKILL and prints expected message.
  EXPECT_EXIT(KillProcess(), ::testing::KilledBySignal(SIGKILL), "unblockable signal");
}
```

### Matching Error Output

The second parameter is either 

- A regular expression that matches the program's stderr output during death
- A matcher (such as `ContainsRegex`) for flexible, expressive output checks

> Important: A plain string literal is interpreted as a regex pattern matched against stderr.

### Notes on `statement`

- `statement` can be a single statement or a compound block with braces.
- Avoid using fatal assertions inside `statement` as they may cause unexpected early returns.
- If the code in `statement` returns normally or throws an exception instead of dying, the test will fail.

---

## Understanding Death Test Styles

GoogleTest supports two styles of running death tests, controlled by the `--gtest_death_test_style` flag or programmatically via `GTEST_FLAG_SET(death_test_style, value)`:

| Style        | Behavior                                                                                          |
|--------------|--------------------------------------------------------------------------------------------------|
| fast         | The child process is forked then runs the death test statement immediately. Faster but less thread-safe. |
| threadsafe   | The child re-executes the entire test binary with flags for running only the death test. Safer with multithreading but slower. |

**You can set the style globally in `main()` or locally inside tests:**

```cpp
int main(int argc, char** argv) {
  testing::InitGoogleTest(&argc, argv);
  GTEST_FLAG_SET(death_test_style, "threadsafe");
  return RUN_ALL_TESTS();
}

TEST(MyDeathTest, ThreadsafeStyle) {
  GTEST_FLAG_SET(death_test_style, "threadsafe");
  ASSERT_DEATH(DoSomething(), "error message");
}

TEST(MyDeathTest, FastStyle) {
  GTEST_FLAG_SET(death_test_style, "fast");
  EXPECT_DEATH(DoSomething(), "error message");
}
```

---

## Important Usage Guidelines

### Test Naming

- Name any test suite that contains death tests with a `*DeathTest` suffix (e.g., `MyClassDeathTest`).
- This ordering helps GoogleTest run death tests before other tests due to possible threading concerns.

### Threads and Death Tests

- Death tests rely on forking, which is unsafe in multi-threaded contexts.
- GoogleTest detects if multiple threads are active and emits warnings.
- Use the `threadsafe` death test style if your test environment is multithreaded.

### Multiple Death Tests Per Line

- Avoid placing multiple death test macros on the same source code line, as it causes compilation errors.

### Memory Side Effects

- Since death tests run in a forked child process, any side effects (like modifying globals or freeing memory) aren't reflected in the parent process.
- Be cautious releasing resources in death tests.

### Exception Handling

- Death tests are not for testing exceptions. Use exception assertions like `EXPECT_THROW` for verifying exception behavior.
- Throwing an exception inside a death test statement causes the test to fail since an exception is not considered true death.

### Mock Objects in Death Tests

- If you use mocks and expect specific exit codes, allow mock leaks with `Mock::AllowLeak` to avoid false failures due to mock leaks.

---

## Working with Predicates for Exit Status

Death tests verify not just that a process dies but that it dies with expected conditions.

GoogleTest provides useful predicate classes for exit status checks:

| Predicate Class          | Description                                              |
|--------------------------|----------------------------------------------------------|
| `ExitedWithCode(code)`   | Checks the program exited normally with specified code.  |
| `KilledBySignal(signum)` | Checks the program was terminated by a specific signal.  |

Example:

```cpp
EXPECT_EXIT(my_func(), testing::ExitedWithCode(42), "Done");
EXPECT_EXIT(my_func(), testing::KilledBySignal(SIGSEGV), "Segfault");
```

You can also supply your own predicate function or functor returning `bool` from `int`.

---

## Debug Mode Death Tests

- `EXPECT_DEBUG_DEATH` and `ASSERT_DEBUG_DEATH` assertions check that a statement dies in debug builds but execute normally in non-debug builds.
- Side effects still occur in release mode, enabling differentiated behavior testing.

Example:

```cpp
TEST(MyTest, DebugDeathExample) {
  int side_effect = 0;
  EXPECT_DEBUG_DEATH({ side_effect = 1; abort(); }, "abort");
  #ifdef NDEBUG
  EXPECT_EQ(1, side_effect);  // Release mode, statement runs normally
  #else
  EXPECT_EQ(0, side_effect);  // Debug mode, statement aborts, no side effect
  #endif
}
```

---

## Practical Tips & Common Pitfalls

- **Use clear, specific error message matchers** to avoid false positives.
- **Remember that death tests only verify termination, not assertion failures.** Assertions like `EXPECT_*` that fail but don’t abort won't fail the death test.
- **Avoid code in death test statements that might return or throw,** as that means death is not detected.
- **Run death tests serially,** as they fork processes and can affect shared state.
- **Name your death tests correctly** to avoid unexpected ordering issues.

<Tip>
If your death test assertion is not triggering a failure as expected, check if the tested code returns or throws an exception instead of terminating the process.
</Tip>

<Tip>
You can customize death test behavior programmatically by setting the death test style flag (`death_test_style`) before calling `RUN_ALL_TESTS()`.
</Tip>

---

## Troubleshooting Death Tests

### Death Test Does Not Fail When Expected

- Confirm that the tested `statement` actually causes the process to terminate (via exit, abort, or crash).
- Check that the error output matches the regex or matcher provided.
- Make sure no early `return` or exception is thrown inside the `statement`.

### Compilation Errors on Multiple Death Tests in One Line

- Split multiple death test macros onto separate lines.

### Death Test Fails in Multithreaded Environment

- Switch to the "threadsafe" style for better thread safety.

### Death Test Output Is Cluttered or Unclear

- Use matchers like `ContainsRegex` to narrow down expected output.
- Pipe the test output to log files and inspect with line numbers.

<Tip>
Enable verbose output by running tests with `--gtest_verbose=info` to get detailed diagnostic messages during death tests.
</Tip>

---

## Example Death Test

```cpp
#include <gtest/gtest.h>

void FunctionThatDies() {
  fprintf(stderr, "Fatal error in FunctionThatDies\n");
  abort();
}

TEST(SampleDeathTest, DiesWithErrorMessage) {
  ASSERT_DEATH(FunctionThatDies(), "Fatal error");
}

int main(int argc, char** argv) {
  ::testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This test verifies that `FunctionThatDies()` aborts and outputs a message containing "Fatal error".

---

## Diagram: Death Test Execution Flow

```mermaid
flowchart TD
  Start([Test function with death test]) --> CheckThreadSafe[Check thread count]
  CheckThreadSafe -->|Multiple threads| Warn[Emit warning]
  CheckThreadSafe -->|One thread| Fork[Spawn child process]

  Fork --> ChildExec{Death test style}

  subgraph Child
    direction TB
    FastExec[Run test statement directly] --> ExitFast[_Exit()] 
    ThreadSafeExec[Re-exec test binary with flags] --> RunSingleTest
    RunSingleTest --> ExitThreadSafe[_Exit()]
  end

  ChildExec -->|fast| FastExec
  ChildExec -->|threadsafe| ThreadSafeExec

  Fork --> ParentWait[Parent waits for child process]
  ParentWait --> EvaluateResult[Analyze exit status and stderr]
  EvaluateResult --> Decision{Test Passed?}
  Decision -->|Yes| Success[Pass death test]
  Decision -->|No| Failure[Report failure]

  Success --> End([Return to test runner])
  Failure --> End
```

This flow depicts how a death test forks a child process that either runs the test statement directly (fast style) or re-executes the test binary with special flags (threadsafe style), then how the parent process waits, evaluates outcome, and reports results.

---

## Next Steps & Related Reading

- For more on assertions to check error conditions, see the [Assertions Reference](../api-reference/core-testing-apis/assertions.md#death).
- Learn about [Exception Assertions](../docs/advanced.md#ExceptionAssertions) for testing exception behaviors.
- Understand [Thread Safety and Death Tests](../docs/advanced.md#DeathTestsAndThreads) to manage multithreaded environments.
- Dive into [Advanced GoogleTest Topics](../docs/advanced.md) to master customized failure messages and predicate assertions.


---

## Additional Resources

- [Death Assertions Reference](../api-reference/core-testing-apis/assertions.md#death)
- [Regular Expression Syntax for Death Tests](../docs/advanced.md#RegularExpressionSyntax)
- [GoogleTest GitHub Repository](https://github.com/google/googletest)

---

This page focuses solely on the use and handling of death tests within GoogleTest, enabling you to write robust tests that verify your program fails correctly under failure conditions.