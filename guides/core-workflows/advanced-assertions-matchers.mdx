---
title: "Using Advanced Assertions and Matchers"
description: "Introduces expressive assertions and built-in matchers for robust test verification. Explains how to use and combine matchers to make tests more readable and meaningful."
---

# Using Advanced Assertions and Matchers

GoogleTest equips you with *advanced assertion macros* and an extensive library of *built-in matchers* that dramatically enhance your test verification capabilities. This guide introduces how to leverage expressive matchers to write readable, maintainable, and robust tests.

---

## 1. Why Use Advanced Assertions and Matchers?

When verifying the correctness of your code, simple assertions like `EXPECT_EQ` or `ASSERT_TRUE` can sometimes be inadequate or verbose, especially when testing complex data structures or behavior.

Matchers enable you to specify *what* you expect in a flexible and declarative manner:

- They allow matching against values with rich rules, not just equality.
- They improve failure messages by clarifying why a test failed.
- They compose elegantly to describe complex expectations.

Using matchers with assertions such as `EXPECT_THAT()` helps express intent clearly and provides insightful diagnostics in test failures.

---

## 2. Core Concepts

### Matchers

Matchers are objects or functions that predicate whether a value satisfies certain conditions.

For example, `Eq(42)` matches the integer value 42, `Gt(10)` matches values greater than 10, and `HasSubstr("foo")` matches strings containing 'foo'. They can be mixed and combined for expressive verification.

### Assertions Using Matchers

GoogleTest provides `EXPECT_THAT(value, matcher)` and `ASSERT_THAT(value, matcher)` to assert that `value` matches the specified matcher.

Example:

```cpp
EXPECT_THAT(result, StartsWith("ERROR"));
ASSERT_THAT(container, Each(Gt(0)));
```

---

## 3. Commonly Used Built-In Matchers

GoogleTest offers a rich set of built-in matchers to cover most testing scenarios with C++ types.

### Basic Comparison Matchers

| Matcher   | Meaning                        | Example                     |
| --------- | ------------------------------ | --------------------------- |
| `Eq(x)`   | Equals `x`                     | `EXPECT_THAT(val, Eq(5));`  |
| `Ne(x)`   | Not equals `x`                 | `EXPECT_THAT(val, Ne(0));`  |
| `Lt(x)`   | Less than `x`                  | `EXPECT_THAT(val, Lt(10));` |
| `Le(x)`   | Less than or equal to `x`      | `EXPECT_THAT(val, Le(5));`  |
| `Gt(x)`   | Greater than `x`               | `EXPECT_THAT(val, Gt(3));`  |
| `Ge(x)`   | Greater than or equal to `x`   | `EXPECT_THAT(val, Ge(7));`  |

### Predicate Matchers

- `_` matches any value (a wildcard matcher).
- `Not(m)` matches values that do *not* match matcher `m`.
- `Truly(pred)` converts any predicate (function or functor) to a matcher.

### Container Matchers

- `ElementsAre(...)` matches a container whose elements match given elements/matchers in order.
- `UnorderedElementsAre(...)` matches elements in any order.
- `Contains(m)` checks if at least one element matches `m`.
- `Each(m)` ensures every element matches `m`.
- `SizeIs(m)` checks the container's size matches `m`.
- `WhenSorted(m)` applies a matcher after sorting container.

Example:

```cpp
EXPECT_THAT(vec, ElementsAre(1, Gt(5), _));
EXPECT_THAT(set, UnorderedElementsAre(1, 2, 3));
EXPECT_THAT(map, Contains(Pair(Eq("key"), Gt(0))));
```

### String Matchers

- `StrEq(s)` compares strings for equality.
- `StrNe(s)` compares strings for inequality.
- `StrCaseEq(s)` and `StrCaseNe(s)` ignore case in comparison.
- `StartsWith(prefix)` asserts string prefix.
- `EndsWith(suffix)` asserts string suffix.
- `HasSubstr(substring)` asserts substring presence.

Example:

```cpp
EXPECT_THAT(s, StartsWith("Hello"));
EXPECT_THAT(s, HasSubstr("world"));
```

### Pointer Matchers

- `IsNull()` matches a null pointer (raw or smart).
- `NotNull()` matches non-null pointers.
- `Pointee(m)` matches a pointer to a value matching `m`.

### Optional and Variant Matchers

- `Optional(m)` matches an optional containing a value matching `m`.
- `VariantWith<T>(m)` matches a variant holding a value of type `T` matching `m`.

---

## 4. Combining Matchers for Expressive Tests

Matchers can be combined to form compound conditions:

- `AllOf(m1, m2, ...)` matches if *all* matchers match.
- `AnyOf(m1, m2, ...)` matches if *any* matcher matches.

Example:

```cpp
EXPECT_THAT(num, AllOf(Ge(0), Lt(100), Ne(42)));
EXPECT_THAT(str, AnyOf(StartsWith("Hello"), EndsWith("World")));
```

You can also combine matchers in multi-argument contexts using `With()`, `Args<>`, and more to test arguments as tuples.

---

## 5. Writing Custom Matchers

For cases where built-in matchers don't express your intent, you can define custom matchers using the `MATCHER` macros or by implementing the matcher interface.

### Simple Custom Matcher with `MATCHER`

```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

// Usage
EXPECT_THAT(value, IsEven());
```

### Parameterized Matcher with `MATCHER_P`

```cpp
MATCHER_P(HasAbsoluteValue, abs_val, "") {
  return std::abs(arg) == abs_val;
}

// Usage
EXPECT_THAT(x, HasAbsoluteValue(10));
```

### Adding Descriptions and Explanations

You can stream custom failure explanations to the `result_listener` inside matchers to provide detailed diagnostics.

---

## 6. Using Matchers with Mock Expectations

Matchers are frequently used in `EXPECT_CALL()` to specify argument constraints.

Example:

```cpp
EXPECT_CALL(mock_obj, Foo(AllOf(Ge(0), Lt(10))));
EXPECT_CALL(mock_obj, Bar(HasSubstr("test")));
```

The matcher syntax allows fine-grained control over expectations, enabling you to verify interactions precisely.

---

## 7. Best Practices

- Use matchers to express tests clearly and explicitly.
- Avoid over-constraining with too many argumentsâ€”only specify what matters.
- Combine matchers to build clear, powerful expectations.
- Use `EXPECT_THAT` in assertions for better failure messages.
- Define custom matchers for domain-specific checks.

---

## 8. Troubleshooting Common Issues

- **Matching fails unexpectedly:** Check argument types and whether the matcher is appropriate.
- **Ambiguous matchers with overloaded methods:** Use `MatcherCast<T>(m)` or specify the overload explicitly.
- **Uninteresting call warnings:** Use `NiceMock` to suppress, or add catch-all expectations.
- **Test failures with messages not clear:** Add detailed explanations in custom matchers or use verbose matchers.

---

## 9. Summary

By mastering GoogleTest's advanced assertions and matchers, you empower your tests to be expressive, resilient, and meaningful. Through composable matchers, precise argument validation, and rich diagnostic messages, you gain control over the accuracy and clarity of your test verifications.

For more detailed usage and examples, consult the [Matchers Reference](./matchers.md) and the [gMock Cookbook](./gmock_cook_book.md).

---

## Appendix: Code Examples 

### Using Basic Matchers

```cpp
#include <gmock/gmock.h>

using ::testing::Eq;
using ::testing::Gt;
using ::testing::HasSubstr;
using ::testing::Not;
using ::testing::_;

TEST(Example, BasicMatchers) {
  EXPECT_THAT(5, Eq(5));
  EXPECT_THAT(7, Gt(3));
  EXPECT_THAT("Hello World", HasSubstr("World"));
  EXPECT_THAT(10, Not(Lt(5)));
  EXPECT_THAT(3, _); // wildcard matcher
}
```

### Matching Containers

```cpp
using ::testing::ElementsAre;
using ::testing::UnorderedElementsAre;

std::vector<int> vec = {1, 2, 3};
EXPECT_THAT(vec, ElementsAre(1, 2, 3));
EXPECT_THAT(vec, UnorderedElementsAre(3, 2, 1));
```

### Custom Matcher Example

```cpp
MATCHER(IsDivisibleBy7, "") {
  return arg % 7 == 0;
}

EXPECT_THAT(21, IsDivisibleBy7()); // Passes
EXPECT_THAT(20, IsDivisibleBy7()); // Fails with message "is divisible by 7"
```

### Complex Matchers

```cpp
EXPECT_THAT(value, AllOf(Gt(5), Lt(10), Not(Eq(7))));
EXPECT_THAT(str, AnyOf(StartsWith("Hello"), EndsWith("World")));
```

---

# FAQs

**Q:** Can I match arguments in mock functions partially?

**A:** Yes, you can use wildcards `_`, partial matchers like `Property()`, `Field()`, and combine matchers such as `AllOf()`.

**Q:** How do I print my own types in matcher failure messages?

**A:** Overload the `operator<<` for your type to integrate with GoogleTest's printing.

**Q:** How can I test a method called multiple times with varying arguments?

**A:** Chain `.WillOnce()` actions with different matchers or use sequences with `.InSequence()`.

---

For deeper details, see [Matchers Reference](./matchers.md) and [gMock Cookbook](./gmock_cook_book.md).
