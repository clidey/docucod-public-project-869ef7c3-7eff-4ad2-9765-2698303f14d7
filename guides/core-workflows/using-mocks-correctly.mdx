---
title: "Best Practices for Mocking and Verification"
description: "Go beyond the basics to master the essential patterns for isolating collaborators with mocks. Learn about setting expectations, using ON_CALL and EXPECT_CALL, call counts, matchers, and managing strict/lenient mocks to ensure reliable and maintainable unit tests."
---

# Best Practices for Mocking and Verification

Master the art of creating reliable and maintainable unit tests by applying effective mocking and verification strategies. This guide walks you through setting expectations, distinguishing between default behaviors and explicit call requirements, leveraging call counts and matchers, and managing different strictness levels in mocks. Follow these practices to isolate collaborators properly, ensure predictable test outcomes, and maintain clean test suites.

---

## 1. Understanding Default Actions vs. Expectations

### What You Want to Achieve
- Define how your mock objects behave by default when methods are called but you don't necessarily want to verify these calls.
- Explicitly set expectations to verify that certain methods are called with specific arguments, exact call counts, and in certain orders.

### Key Practices
- Use `ON_CALL` to specify default behaviors without enforcing that the call must happen.
- Use `EXPECT_CALL` to both define behavior and enforce that calls happen as specified.

### Example
```cpp
using ::testing::Return;

MockFoo mock;

// Default behavior: GetSize returns 1 whenever called (but not required to be called)
ON_CALL(mock, GetSize())
    .WillByDefault(Return(1));

// Expect Describe(5) to be called exactly 3 times, returning "Category 5"
EXPECT_CALL(mock, Describe(5))
    .Times(3)
    .WillRepeatedly(Return("Category 5"));

EXPECT_EQ(processObject(&mock), "good");
```

---

## 2. Setting Expectations with `EXPECT_CALL`

### What You Want to Achieve
- Monitor calls to mock methods with precise control over arguments, call counts, call order, and returned values.

### Step-by-Step Instructions
1. **Specify the mock object and method:**
   ```cpp
   EXPECT_CALL(mockObject, MethodName(...))
   ```
2. **Define expected arguments using matchers:** Use `_` for any value or specialized matchers like `Eq()`, `Ge()`, etc.
3. **Set how often the method should be called using `.Times()`.**
4. **Define return values or actions with `.WillOnce()` and `.WillRepeatedly()`.**
5. **Optionally, specify calling order using `.InSequence()` or `.After()`.**

### Example
```cpp
EXPECT_CALL(mockTurtle, Forward(Ge(100)))
    .Times(2)
    .WillOnce(Return())
    .WillOnce(Return());

EXPECT_CALL(mockTurtle, PenDown())
    .Times(AtLeast(1));
```

### Outcomes
- Tests will fail if expectations are violated, i.e., methods are called fewer or more times than specified or with unexpected arguments.

---

## 3. Using `ON_CALL` to Configure Default Behaviors

### What You Want to Achieve
- Provide default behaviors for mock methods when you’re not explicitly verifying every call.

### How to Use
- Use `ON_CALL` before exercising the code under test.
- Use `.WillByDefault()` to specify the action.

### Example
```cpp
ON_CALL(mock, GetSize())
    .WillByDefault(Return(1));
```

### Practical Tips
- Use `ON_CALL` to set common return values shared across many tests.
- Don’t rely on `ON_CALL` alone to enforce call verification—use `EXPECT_CALL` for that.

---

## 4. Controlling Call Counts with Cardinalities

### Purpose
- Ensure methods are called the correct number of times, preventing over- or under-calling.

### Cardinalities to Use
| Cardinality          | Description                                 |
|----------------------|---------------------------------------------|
| `AnyNumber()`        | No limit on calls                            |
| `AtLeast(n)`         | Must be called at least *n* times            |
| `AtMost(n)`          | Called at most *n* times                      |
| `Between(m, n)`      | Called between *m* and *n* times inclusive   |
| `Exactly(n)` or `n`  | Called exactly *n* times                      |

### How to Define
- Use `.Times()` inside `EXPECT_CALL`.

### Example
```cpp
EXPECT_CALL(mock, Foo())
    .Times(Exactly(3));
```

### What Happens
- Test fails immediately if calls exceed limits.
- At end of test, failure if calls are fewer than expected.

---

## 5. Matching Arguments Effectively

### Goals
- Verify that mock methods are called with expected arguments.
- Avoid overspecifying and creating brittle tests.

### Techniques
- Use matchers like `_` for any argument.
- Use matchers like `Eq(value)`, `Lt(value)`, `NotNull()`, `Pointee(matcher)`, or custom predicates.
- Use `.With()` to match all arguments collectively.

### Examples
```cpp
// Matches any second argument
EXPECT_CALL(mock, Process(_, _));

// Matches a call where first argument is 5
EXPECT_CALL(mock, Process(5, _));

// Matches calls where first argument < second argument
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());
```

### Best Practices
- Only be as specific as needed.
- Use combined matchers for complex conditions.

---

## 6. Managing Strictness: NiceMock, NaggyMock, and StrictMock

### What You Want to Achieve
- Control how uninteresting calls (calls without expectations) are handled.

### Options
| Mock Type       | Behavior on Uninteresting Calls                      |
|-----------------|------------------------------------------------------|
| `NiceMock<T>`   | Suppresses warnings (silent)                         |
| `NaggyMock<T>`  | Default: warns on uninteresting calls                |
| `StrictMock<T>` | Treats uninteresting calls as test failures          |

### How to Use
```cpp
NiceMock<MockFoo> nice_mock;
NaggyMock<MockFoo> naggy_mock;
StrictMock<MockFoo> strict_mock;
```

### When to Use
- Use **NiceMock** for stable tests where warnings add noise.
- Use **NaggyMock** (default) during development to catch unexpected interactions early.
- Use **StrictMock** when tests must exactly verify every call.

### Caveats
- Strict mocks may require more frequent test updates on implementation changes.
- Nice and Strict mocks only apply to methods mocked *directly* in the mock class.

---

## 7. Controlling Call Order and Sequences

### When You Need It
- To verify calls occur in a specified sequence.
- To express partial ordering constraints on calls.

### How to Enforce Order
- Use `InSequence` object to wrap expectations that must run in order.
- Use `Sequence` objects with `.InSequence(sequence)` clauses for more complex orders.
- Use `.After()` to specify that some calls occur after others.

### Example
```cpp
using ::testing::InSequence;

{
  InSequence seq;
  EXPECT_CALL(mock, Init());
  EXPECT_CALL(mock, Run());
  EXPECT_CALL(mock, Cleanup());
}
```

### What Happens
- Calls to `Init()`, `Run()`, and `Cleanup()` must occur in that order.
- Out-of-order calls cause test failures immediately.

---

## 8. Retiring Expectations

### Why It Matters
- Some expectations should deactivate automatically once saturated to allow other expectations to match subsequent calls.

### How to Specify
- Use `.RetiresOnSaturation()` in the expectation chain.

### Example
```cpp
EXPECT_CALL(mock, DoWork())
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, DoWork())
    .Times(AnyNumber());
```

### Outcome
- First two calls match the first expectation.
- Further calls match the second.

---

## 9. Verifying Mocks Early and Controlling Leaks

### Verifying Expectations
- gMock automatically verifies expectations on mock destruction.
- To force verification earlier, use `testing::Mock::VerifyAndClearExpectations(&mock_obj);`.

### Avoiding Silent Leaks
- Leaking mocks suppress verification, leading to false positives.
- Mark intentional leaks with `testing::Mock::AllowLeak(&mock_obj);`.

### Example
```cpp
MockFoo* foo = new MockFoo;
EXPECT_CALL(*foo, DoSomething());
// ... use foo ...
Mock::VerifyAndClearExpectations(foo);
// now delete foo safely
```

---

## 10. Troubleshooting Common Issues

<AccordionGroup title="Common Problems and Solutions">
<Accordion title="Unexpected Calls or Argument Mismatches">
- Check if `EXPECT_CALL`s are set before exercising the mock.
- Run tests with `--gmock_verbose=info` to trace call matching.
- Verify matchers used correctly reflect expected arguments.
</Accordion>
<Accordion title="Too Many or Too Few Calls">
- Ensure `.Times()` cardinality matches your call count.
- Use `.RetiresOnSaturation()` if needed to make expectations non-sticky.
</Accordion>
<Accordion title="Warnings on Uninteresting Calls">
- Use `NiceMock` if warnings are unwanted.
- Add catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());` to silence warnings for methods.
</Accordion>
<Accordion title="Mock Method Not Called or Not Matching">
- Confirm the mock method signature matches exactly.
- If overloaded, disambiguate with argument types or `Const()` wrapper.
</Accordion>
</AccordionGroup>

---

## 11. Summary of Best Practices

- Favor `ON_CALL` for default behavior; use `EXPECT_CALL` for required calls.
- Use matchers judiciously to avoid brittle tests.
- Control call counts with `Times()` and use cardinalities fitting your scenario.
- Leverage `InSequence` and `After` for ordering when necessary.
- Manage mock strictness via `NiceMock`, `NaggyMock`, or `StrictMock`.
- Utilize `.RetiresOnSaturation()` to prevent sticky expectations from interfering.
- Always set expectations before code invocation.
- Run tests with verbose flags if debugging is required.

---

## 12. Additional Resources

- [gMock Cheat Sheet](https://github.com/google/googletest/blob/main/docs/gmock_cheat_sheet.md)
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md)
- [gMock for Dummies Guide](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md)
- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)
- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) (for overall test structure)

For comprehensive examples, see GoogleMock test suite and sample tests in the GoogleTest repository.

---

<p style="text-align:center; font-size:smaller; color:gray;">Explore <a href="/guides/core-workflows/using-mocks-correctly">Best Practices for Mocking and Verification</a> to elevate your C++ unit testing skills.</p>
