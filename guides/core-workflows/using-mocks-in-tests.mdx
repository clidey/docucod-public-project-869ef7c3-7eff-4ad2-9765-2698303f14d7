---
title: "Using Mocks in C++ Tests"
description: "Step-by-step guidance on leveraging GoogleMock to create, use, and configure mock objects for isolating units under test. Includes real-world mock usage scenarios, expectation setting, and integration with GoogleTest-style tests."
---

# Using Mocks in C++ Tests

## Workflow Overview

### Task Description
This guide provides **step-by-step instructions** to leverage GoogleMock (gMock) for creating, using, and configuring mock objects in C++ tests. It focuses specifically on how to define mock classes and set up expectations and behaviors for mock methods, enabling you to isolate units under test efficiently and verify interaction-based behaviors.

### Prerequisites
- A working GoogleTest and GoogleMock installation.
- Familiarity with basic C++ testing concepts.
- Interfaces or classes with virtual functions to mock.
- Inclusion of `<gmock/gmock.h>` in your test code.

### Expected Outcome
By following this guide, you will be able to:
- Define mock classes quickly using `MOCK_METHOD`.
- Instantiate mock objects in your tests.
- Configure expectations and default behaviors.
- Verify that the system under test interacts with its collaborators correctly.
- Use mock strictness controls to regulate uninteresting calls.

### Time Estimate
Approximately 20-30 minutes to understand and apply the workflows, depending on prior knowledge.

### Difficulty Level
Beginner to Intermediate

---

## Step-by-Step Instructions

### 1. Define Your Mock Class

To mock an existing interface or class, create a new class deriving from it. Inside the mock class, use the `MOCK_METHOD` macro to declare mock methods corresponding to the interface's virtual methods.

```cpp
#include <gmock/gmock.h>  // Include gMock

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};
```

**Best Practices:**
- Place all `MOCK_METHOD` macros in the public section.
- Always mark overridden virtual methods with `(override)`.
- For const methods, include `(const, override)`.
- For methods with unusual calling conventions (e.g., Windows COM), use `(Calltype(...))` qualifier.

---

### 2. Create Mock Objects in Tests

Instantiate your mock class in your test to simulate collaborators.

```cpp
TEST(ExampleTest, UsesMock) {
  MockFoo mock_foo;  // Create mock object
  // ... set expectations and behavior ...
}
```

---

### 3. Set Up Default Behaviors Using `ON_CALL`

`ON_CALL` lets you specify a **default behavior** when a mock method is called, but does **not** set an expectation that the method must be called.

```cpp
using ::testing::Return;

ON_CALL(mock_foo, GetSize())
    .WillByDefault(Return(10));
```

This ensures that if `GetSize()` is called without a matching `EXPECT_CALL`, it returns 10.

---

### 4. Set Expectations Using `EXPECT_CALL`

`EXPECT_CALL` sets an **expectation** that the mock method will be called with certain arguments, a specific number of times, and optionally with defined behavior.

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::AtLeast;

EXPECT_CALL(mock_foo, Describe("test"))     // Method expected with "test" argument
    .Times(3)                                 // Expected to be called exactly three times
    .WillRepeatedly(Return("Description"));

EXPECT_CALL(mock_foo, GetSize())               // Method expected with any arguments
    .Times(AtLeast(1))                         // At least one call
    .WillRepeatedly(Return(5));
```

**Tips:**
- Use `_` if you don't care about specific argument values.
- `.Times(0)` disallows the call.
- Multiple `EXPECT_CALL` statements can be created; the last matching takes precedence.
- To enforce call order, use the `InSequence` helper.

---

### 5. Use Mock Objects in Your Tests

Exercise your system under test by passing mock objects. GoogleMock will verify that expectations are met at test completion automatically.

```cpp
TEST(ExampleTest, UseMock) {
  MockFoo mock_foo;

  ON_CALL(mock_foo, GetSize()).WillByDefault(Return(1));

  EXPECT_CALL(mock_foo, Describe(5))
      .Times(3)
      .WillRepeatedly(Return("Category 5"));

  // Code under test uses mock_foo
  EXPECT_EQ(MyProductionFunction(&mock_foo), "good");
}
```

---

### 6. Control Mock Strictness

By default, mocks are "naggy" â€” uninteresting function calls (those without expectations) will print warnings. You can change this behavior using the following wrappers:

- **NiceMock<T>**: suppresses warnings for uninteresting calls.
- **NaggyMock<T>**: prints warnings (default behavior).
- **StrictMock<T>**: fails tests on uninteresting calls.

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_mock_foo;
EXPECT_CALL(nice_mock_foo, DoThing());
```

---

### 7. Verifying and Resetting Mocks Explicitly (Optional)

GoogleMock verifies expectations when mock objects are destructed. To verify earlier or manually clear expectations:

```cpp
using ::testing::Mock;

Mock::VerifyAndClearExpectations(&mock_foo);

// Or to clear expectations and default actions
Mock::VerifyAndClear(&mock_foo);
```

Avoid setting new expectations after verification to prevent undefined behavior.

---

## Examples & Code Samples

### Mocking a Normal Interface

```cpp
class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};
```

### Using the Mock in a Test

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;
using ::testing::_;

TEST(FooTest, DescribeReturnsExpectedString) {
  MockFoo mock;

  ON_CALL(mock, GetSize()).WillByDefault(Return(10));

  EXPECT_CALL(mock, Describe("item"))
      .Times(1)
      .WillOnce(Return("Describing item"));

  std::string result = mock.Describe("item");
  EXPECT_EQ(result, "Describing item");
}
```

### Creating Nice and Strict Mocks

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock;   // Suppresses warnings for uninteresting calls
StrictMock<MockFoo> strict_mock; // Treats uninteresting calls as errors
```

### Setting Expectations with Matcher, Cardinality, and Actions

```cpp
EXPECT_CALL(mock, DoSomething(Ge(5)))  // Expect arg >= 5
    .Times(AtLeast(2))                 // Called at least twice
    .WillRepeatedly(Return(true));    // Returns true for all calls
```

## Troubleshooting & Tips

### Common Issues

- **Virtual Destructors:** Make sure the base class has a virtual destructor; otherwise, mocks can cause memory leaks or undefined behaviors.
- **Order of Setting Expectations:** Always set `EXPECT_CALL` expectations before the mock method is invoked. Setting expectations afterwards leads to undefined behavior.
- **Uninteresting Calls:** Use `NiceMock` to suppress warnings if your tests legitimately ignore some calls.
- **Overloaded Methods:** When mocking overloaded methods, disambiguate them using the `Const()` wrapper or explicit casting.
- **Return Type Issues:** For methods returning references, use `ReturnRef()` instead of `Return()`.

### Best Practices

- Use `ON_CALL` to specify common default behavior shared across many tests.
- Use `EXPECT_CALL` to specify the exact interactions you want to test.
- Use `InSequence` to enforce call order when necessary.
- Avoid over-specifying expectations to keep tests maintainable.
- Prefer coding against interfaces and mocking those interfaces, not concrete classes.

## Next Steps & Related Content

- Explore the [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) for quick references.
- Learn more about setting actions and custom matchers in [Advanced Mocking: Actions and Matchers](https://google.github.io/googletest/guides/advanced_mocking.html).
- Deepen understanding of mock strictness modes in [Mock Strictness: Nice, Naggy, and Strict Mocks](https://google.github.io/googletest/gmock_cook_book.html#nice-strict-naggy).
- Start writing tests quickly with [Writing Your First Test](https://google.github.io/googletest/getting-started.html#writing-your-first-test).

---

For complete documentation and examples, visit official GoogleTest and GoogleMock sites.

---