---
title: "Effective Mocking Patterns"
description: "Practical guide to advanced mocking in GoogleMock: setting call expectations, using matchers, default actions and return values, sequences, and different mock strictness modes. Demonstrates how to create robust, maintainable mocks."
---

# Effective Mocking Patterns

A practical guide to advanced mocking in GoogleMock, this page helps you master setting call expectations, using matchers, default actions and return values, sequences, and strictness modes in mock objects. Through clear explanations and concrete code examples, you will learn how to create robust and maintainable mocks that precisely express your testing intent.

---

## Understanding Mocking with GoogleMock

Mocking allows you to simulate complex or unavailable components in your C++ tests by creating mock classes that mirror your interfaces. GoogleMock facilitates this with a rich syntax to specify which methods you expect to be called, with what arguments, how many times, and what they should return.

This guide dives deeper into effective patterns beyond the basics of creating mocks, focusing on:

- Setting precise method call expectations
- Using argument matchers flexibly
- Specifying default actions and return values
- Ordering expectations with sequences
- Managing strictness modes of mocks


## 1. Setting Call Expectations

The core mechanism for expecting mock method calls is `EXPECT_CALL`.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `mock_object`: Your mock instance.
- `MethodName`: The mocked method.
- `matchers...`: Specify expected argument values or patterns (using literals or matcher objects).
- `Times()`: How many times to expect the call.
- `WillOnce()` / `WillRepeatedly()`: Define return behaviors or side effects.

### Inferring Call Counts

If you omit `.Times()`, GoogleMock infers it:

- No `WillOnce` or `WillRepeatedly` → called exactly once.
- N `WillOnce` and no `WillRepeatedly` → called N times.
- N `WillOnce` and one `WillRepeatedly` → called at least N times.


## 2. Using Matchers for Argument Validation

Matchers in GoogleMock let you specify argument expectations beyond exact values.

- Use `_` to match any argument.
- Use built-in matchers like `Eq()`, `Gt()`, `Ne()`, `NotNull()`, `ElementsAre()`, and many more.
- Combine matchers with logical operators like `AllOf()`, `AnyOf()`, and negation `Not()`.
- Use `.With()` clause on expectations to match arguments as a tuple.

### Example

```cpp
EXPECT_CALL(my_mock, SetPosition(_, _))
    .With(Lt());  // First arg less than second arg
```

### Tips

- Omit argument list to expect calls with any arguments if method is not overloaded.
- Use `SafeMatcherCast<T>(m)` to cast matchers for implicit conversions.


## 3. Setting Default Actions and Return Values

By default, mock methods return default constructed values (`0`, `false`, `nullptr`). To customize default behavior:

- Use `ON_CALL` to set default actions without requiring the call.
- Use `WillByDefault()` clause with `ON_CALL`.
- Specify actions in `EXPECT_CALL` using `WillOnce()` and `WillRepeatedly()` for call-specific behavior.

### Example

```cpp
ON_CALL(my_mock, GetSize())
    .WillByDefault(Return(42));

EXPECT_CALL(my_mock, GetSize())
    .Times(AnyNumber());
```

### Default Value Override

You can globally override defaults per return type using `::testing::DefaultValue<T>::Set()`.


## 4. Controlling Call Order with Sequences and Partial Orders

By default, GoogleMock allows expectations to match calls in any order. To enforce call order:

### Full Order with `InSequence`

Wrap expectations in an `InSequence` block to require calls in the specified order.

```cpp
{
  ::testing::InSequence seq;

  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

### Partial Orders with `Sequence` Objects & `.After()`

For more complex ordering, use `Sequence` objects:

```cpp
::testing::Sequence seq1, seq2;

EXPECT_CALL(mock, A()).InSequence(seq1, seq2);
EXPECT_CALL(mock, B()).InSequence(seq1);
EXPECT_CALL(mock, C()).InSequence(seq2);
```

This means A happens before B and C, B and C can be unordered.

Use `.After()` to specify that an expectation occurs after others.


## 5. Managing Expectation Lifetime with Retiring

By default, expectations remain active even after their call count is saturated. This can cause subsequent matching calls to erroneously trigger failures.

Use `.RetiresOnSaturation()` to make an expectation inactive once fully satisfied, allowing later expectations to be matched properly.

```cpp
EXPECT_CALL(mock, Foo())
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, Foo())
    .Times(AnyNumber());
```

In this example, the first expectation is active only for two calls, any further calls match the second.


## 6. Strictness Modes: Nice, Naggy, and Strict Mocks

GoogleMock offers three modes controlling how uninteresting calls (calls to mock methods without an `EXPECT_CALL`) are handled:

| Mode      | Behavior on Uninteresting Calls                    | Use Case                             |
|-----------|---------------------------------------------------|------------------------------------|
| NiceMock  | Suppresses warnings; allows calls silently        | Least strict, good for stable tests |
| NaggyMock | Prints warnings on uninteresting calls (default) | Moderate strictness; debugging     |
| StrictMock| Treats uninteresting calls as failures            | Most strict; ensures full specification |

### Usage

Declare your mock as:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
```

Similarly for `NaggyMock` or `StrictMock`.

### Notes

- Strictness modes **only** affect uninteresting calls, not unexpected calls that violate expectations.
- They apply only to mock methods declared using `MOCK_METHOD` directly in the mock class.
- Using strict mocks helps catch unintended calls that tests do not expect.


## 7. Practical & Advanced Tips

- **Ordering of Expectations:** When using multiple `EXPECT_CALL`s with overlapping matchers, always place the more specific expectations after the general ones to avoid shadowing.

- **Mocking Move-Only Types:** Use lambdas or `WillOnce` callables to handle move-only types. Avoid `Return(std::move(...))` in `WillRepeatedly` since it'll cause runtime errors after first use.

- **Delegation:** Use `ON_CALL` with lambdas to delegate default mock behavior to fakes, real objects, or parent class implementations.

- **Sequences & Partial Orders:** Combine `InSequence` blocks with `.RetiresOnSaturation()` for fine-grained ordered expectations.

- **Suppressing Warnings:** Use `NiceMock` to suppress uninteresting call warnings; alternatively, add catch-all expectations with `.Times(AnyNumber())`.

- **Default Action Chains:** `WillOnce()` clauses execute in order for matching calls; once exhausted, `WillRepeatedly()` takes over.


## Code Examples

### Simple Expectation with Return Values

```cpp
EXPECT_CALL(mock, GetValue(5))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));

int result = mock.GetValue(5);  // returns 42 for first call, 0 thereafter
```

### Using Matchers and `.With()` Clause

```cpp
EXPECT_CALL(mock, SetLimits(_, _))
    .With(Lt())  // first arg < second arg
    .Times(1);

mock.SetLimits(4, 5);  // matches
mock.SetLimits(5, 4);  // fails
```

### Sequencing Calls with `InSequence`

```cpp
{
  ::testing::InSequence s;

  EXPECT_CALL(mock, Init());
  EXPECT_CALL(mock, Start());
  EXPECT_CALL(mock, Stop());
}

mock.Init();
mock.Start();
mock.Stop();
```

### Retiring Expectations on Saturation

```cpp
EXPECT_CALL(mock, Process(7))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, Process(_))
    .Times(::testing::AnyNumber());

mock.Process(7); // matches first expectation
mock.Process(7); // first expectation saturated and retires
mock.Process(7); // matches second expectation
```

### Using StrictMock to Enforce Full Specification

```cpp
using ::testing::StrictMock;

StrictMock<MockFoo> strict_mock;
EXPECT_CALL(strict_mock, ExpectedMethod()).Times(1);

strict_mock.ExpectedMethod();   // Ok
strict_mock.OtherMethod();      // Test fails on uninteresting call
```

---

## Troubleshooting

- **Call order errors:** If tests fail due to unexpected call order, verify use of `InSequence` or `.After()` clauses to enforce expected sequences.

- **Uninteresting call warnings:** Use `NiceMock` or add catch-all `EXPECT_CALL` with `.Times(AnyNumber())` to avoid noisy warnings.

- **Too many actions error:** Ensure the number of `WillOnce()` clauses does not exceed the specified `.Times()` upper bound.

- **Missing Return values:** For non-void mock methods, lack of a return action or default value triggers errors. Use `ON_CALL` or `DefaultValue<T>::Set()` to provide defaults.

- **Ambiguity with overloaded methods:** Use argument lists or the `Const()` wrapper to disambiguate amongst overloaded mock methods.


## Next Steps & Related Documentation

- [Mocking Reference](reference/mocking.md) — In-depth API explanation.
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md) — Quick syntax reference.
- [gMock Cookbook](docs/gmock_cook_book.md) — Advanced mocking recipes.
- [Using Mocks in Tests](guides/getting-started/first-mock-example) — Starting with mocks.
- [Matchers Reference](reference/matchers.md) — Explore argument matching.

---

For a seamless start, combine this guide with the Mocking Reference and gMock Cookbook to become a mock expert, writing precise, maintainable, and flexible tests in your C++ projects.
