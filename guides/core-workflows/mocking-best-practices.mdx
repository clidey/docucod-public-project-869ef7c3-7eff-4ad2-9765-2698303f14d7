---
title: "Mocking Best Practices"
description: "Covers the recommended patterns for using GoogleMock, including clean mock design, expectation strategies, common pitfalls, and improving test clarity and reliability."
---

# Mocking Best Practices

## Overview
Mock objects are a powerful tool in C++ testing, allowing you to isolate components and verify interactions precisely. This guide covers recommended patterns for using GoogleMock effectively, helping you design clean mocks, set robust expectations, avoid common pitfalls, and write tests that are clear and reliable.

By following these best practices, you will ensure your mock-based tests remain maintainable and expressive, even as your code evolves.

## 1. Design Clean Mocks

- **Code to Interfaces**: Always prefer mocking interfaces (pure virtual classes) rather than concrete classes. This insulates your tests from implementation details and improves test resilience.

- **Mock Only What You Own**: Avoid mocking types from external libraries or dependencies you do not control. Instead, wrap those dependencies with your own interfaces to keep mocks manageable.

- **Place MOCK_METHOD Definitions Publicly**: Regardless of the original method's access specifier (public, protected, private), declare mocked methods using `MOCK_METHOD` inside the `public` section of your mock class. This enables gMock's `EXPECT_CALL` and `ON_CALL` macros to access them.

- **Use Type Aliases to Handle Complex Signatures**: When mocking methods with template or comma-separated types (e.g. `std::pair`, `std::map`), wrap those types with a type alias or parentheses to avoid macro parsing issues:

  ```cpp
  using BoolIntPair = std::pair<bool, int>;
  MOCK_METHOD(BoolIntPair, GetPair, ());
  
  // Or using parentheses to protect commas
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  ```

- **Mock Overloads Carefully**: If a class has overloaded virtual methods, mock all versions you intend to use. To avoid hiding base class overloads not mocked, use `using Base::MethodName;` to bring them into scope.

  ```cpp
  class MockFoo : public Foo {
   public:
    using Foo::Add;
    MOCK_METHOD(int, Add, (Element x), (override));
  };
  ```

- **Delegate Where Appropriate**: For complex dependencies, consider delegating calls from mocks to fakes or even real objects to reuse behavior while still tracking interactions.

## 2. Set Expectations Strategically

- **Use `ON_CALL` for Default Behaviors**: Use `ON_CALL()` to define how a mock method behaves when called, without imposing call count constraints. This sets the baseline mock behavior.

- **Use `EXPECT_CALL` to Verify Interactions**: Use `EXPECT_CALL()` sparingly for calls you explicitly want to verify (e.g., expected number of invocations or argument values). Avoid bloating tests with unnecessary expectations to reduce test brittleness.

- **Prefer `NiceMock` for Less Noise**: By default, mocks warn about uninteresting calls that lack expectations. Wrap your mock class with `NiceMock<YourMock>` to suppress such warnings, keeping test output cleaner.

- **Use `StrictMock` Judiciously**: Use `StrictMock<YourMock>` to treat uninteresting calls as failures only when you want your tests to enforce stricter call contracts, understanding this will make tests more brittle but more precise.

- **Control Call Order with Sequences**: Use `::testing::Sequence` and `InSequence` to specify the order requirements of expected calls to prevent flaky tests due to unordered mocks.

- **Be Explicit with Argument Matchers**: Use matchers such as `_`, `Eq()`, `Ge()`, or custom matchers to flexibly match call arguments without over-specifying.

- **Avoid Overusing `.Times(AnyNumber())`**: While useful for ignoring call count, overusing this can mask bugs. Instead, prefer well-scoped expectations.

## 3. Avoid Common Pitfalls

- **Don't Mock Non-Virtual Methods Unless Using Advanced Techniques**: Regular mocking requires virtual methods. Use the high-perf dependency injection pattern when working with non-virtual methods.

- **Beware Sticky Expectations**: By default, expectations remain active ("sticky") even after matching the expected count, which can cause unexpected failures. Use `.RetiresOnSaturation()` to deactivate expectations once fulfilled.

- **Don't Add Expectations after Exercise**: Set all `EXPECT_CALL()` statements before calling code that interacts with the mocks. Adding expectations afterward results in undefined behavior.

- **Prevent Infinite Recursion with Delegates**: When delegating mocked calls to real or base implementations, explicitly call `BaseClass::Method()` to avoid recursive calls calling the mock again.

- **Handle Move-Only Types Carefully**: Use `MOCK_METHOD` normally to mock methods accepting or returning move-only types like `std::unique_ptr`. Use lambdas in `WillOnce` or `WillRepeatedly` to generate new returned objects on each call.

- **Use `WITH_CALLTYPE` in Windows Environments**: When mocking methods with specific calling conventions, use the `(Calltype(...))` specifier as needed.

## 4. Write Clear and Reliable Tests

- **One Expectation Per Test**: Focus each test on verifying one behavior or interaction. This makes debugging easier and tests less brittle.

- **Use Descriptive Test and Expectation Names**: Descriptive names make test logs easier to understand.

- **Use `EXPECT_CALL` Sparingly**: Set expectations only for calls important to the behavior under test.

- **Validate Matched Arguments with Matchers**: Use gMockâ€™s rich matcher library to ensure argument correctness without brittle exact matches.

- **Suppress Uninteresting Call Warnings with `NiceMock`**: To reduce noisy output, prefer `NiceMock` where possible.

- **Handle Side Effects Explicitly**: Use built-in actions like `SetArgPointee()`, `SetArrayArgument()`, or custom actions to simulate side effects on output parameters.

- **Use Sequences or `After()` When Necessary**: When order matters, express the constraints explicitly.

- **Avoid Over-Constraining the Test**: Overly strict expectations can lead to fragile tests that break on harmless refactoring.

## 5. Troubleshooting Tips

- **Unexpected Calls**: If a mock function is called without a matching expectation, gMock prints an error. Use `EXPECTED_CALL(...).Times(0)` to disallow calls if needed.

- **Uninteresting Calls Warning**: These happen when no expectation is set. Use `NiceMock` to suppress or add a general expectation with `.Times(AnyNumber())` to permit all calls.

- **Mock Methods Not Being Called**: Confirm the method is correctly mocked (virtual and with correct signature).

- **Compilation Errors With Complex Types**: Wrap complex return or argument types with parentheses or using type aliases to avoid comma parsing issues.

- **Verbose Logging**: Use `--gmock_verbose=info` to get detailed traces of mock call matching and internal gMock decisions.

- **Heap Checker Failures**: Ensure mocked classes have virtual destructors to avoid resource leaks.

- **Avoid Mixing `NiceMock` and `StrictMock`**: Nesting these or mixing with mocks containing base-class defined mock methods may yield inconsistent behavior.

## 6. Summary of Best Practices

| Practice                             | Recommendation                                    |
|------------------------------------|--------------------------------------------------|
| Mock Design                        | Mock interfaces, not concrete classes             |
| Method Access                     | Declare all `MOCK_METHOD` in public section       |
| Complex Types                     | Use type aliases or parentheses                    |
| Expectations                     | Use `ON_CALL` for behavior, `EXPECT_CALL` for verification |
| Mock Strictness                  | Use `NiceMock` by default, `StrictMock` when needed |
| Call Ordering                    | Use `Sequence` and `InSequence` to control order  |
| Argument Matching                | Use flexible matchers to avoid brittleness        |
| Side Effects                    | Use built-in actions like `SetArgPointee()`        |
| Avoid Over-Specifying            | Set the minimum expectations necessary            |
| Avoid Setting Expectations Late | Always set expectations before exercising mocks   |

## 7. Additional Resources

- **gMock Cookbook:** Practical recipes for defining mocks, using expectations, and advanced techniques.
- **gMock Cheat Sheet:** Quick reference for mock class definitions, expectations, and actions syntax.
- **gMock for Dummies:** Beginner-friendly introduction to mocking concepts with GoogleMock.
- **Mocking Reference:** Detailed description of gMock classes, macros, and facilities.
- **Strictness Modes:** Understanding `NiceMock`, `NaggyMock`, and `StrictMock` to manage uninteresting calls.

---

For a hands-on start, see the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) and get comfortable setting expectations with `EXPECT_CALL` and defining mock methods with `MOCK_METHOD`.

Use `NiceMock` wrappers to keep tests cleaner and use sequences to maintain call order when appropriate. Always code to interfaces, mock owned types, and prefer clarity over exhaustive verification to maintain sustainable test suites.

<Tip>
Remember: The best mocks are the simplest ones that verify exactly what you need and no more. This leads to tests that are robust, fast, and easy to maintain.
</Tip>