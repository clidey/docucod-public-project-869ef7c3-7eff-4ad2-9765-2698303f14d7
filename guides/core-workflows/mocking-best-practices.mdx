---
title: "Advanced Mocking Patterns and Best Practices"
description: "Explore robust patterns for using mocks, including setting call expectations, configuring actions (returning values, exceptions, etc.), and validating the number and order of calls. Includes advice for clean, maintainable mocking in large systems."
---

# Advanced Mocking Patterns and Best Practices

GoogleMock provides powerful and flexible tools for creating mock objects in C++, allowing you to specify expectations, control call behaviors, and verify interactions precisely. This guide focuses on advanced patterns and best practices for working with mocks effectively, including setting call expectations, configuring actions, managing call order and count, and ensuring clean, maintainable mocks in large systems.

---

## Overview

This guide helps you master advanced mocking techniques to:

- Define flexible and precise expectations on mock methods.
- Control the actions a mock should take (return values, side effects, exceptions).
- Validate the number and order of calls.
- Use strictness controls (`NiceMock`, `NaggyMock`, `StrictMock`).
- Apply best practices for clarity and maintainability in complex systems.

---

## Prerequisites

- Familiarity with basic GoogleMock usage:
  - Defining mock classes with `MOCK_METHOD`
  - Setting expectations with `EXPECT_CALL`
  - Using matchers to specify argument constraints
  - Basic understanding of mock method actions (`WillOnce`, `WillRepeatedly`)
- C++17 or later environment.

---

## Expected Outcome

By following this guide, you will:

- Confidently configure complex expectations and behaviors on your mock objects.
- Avoid common pitfalls such as overly brittle or noisy tests.
- Manage call order and dependencies safely and explicitly.
- Write mocking code that is easier to read, maintain, and extend.

---

# Table of Contents

1. [Setting Expectations (EXPECT_CALL)](#setting-expectations-expect_call)
2. [Controlling Mock Actions](#controlling-mock-actions)
3. [Call Counting and Cardinalities](#call-counting-and-cardinalities)
4. [Call Ordering and Sequencing](#call-ordering-and-sequencing)
5. [Strictness Controls: Nice, Naggy, and Strict Mocks](#strictness-controls-nice-naggy-and-strict-mocks)
6. [Retiring Expectations and Managing Saturation](#retiring-expectations-and-managing-saturation)
7. [Using ON_CALL for Default Behaviors](#using-on_call-for-default-behaviors)
8. [Best Practices and Clean Design](#best-practices-and-clean-design)
9. [Troubleshooting Common Issues](#troubleshooting-common-issues)
10. [Next Steps & Related Content](#next-steps--related-content)

---

## Setting Expectations (EXPECT_CALL)

Expectations define the set of calls your mock method is expected to receive with specific argument constraints and behaviors.

### Basic Usage

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `mock_object`: Your mock instance.
- `MethodName`: The mocked method.
- `matchers`: Argument matchers (e.g. `_`, `Eq(value)`, or custom matchers).
- Chainable clauses configure how many times and what the mock should do.

### Important Notes

- Expectations MUST be set *before* the mock object is used.
- If no `Times()` clause is supplied, GoogleMock infers it from the number of action clauses.
- Newer expectations override older ones when matching calls.

---

## Controlling Mock Actions

Actions define what happens when a mock method is called matching an expectation.

### Common Actions

- `Return(value)`: Returns a copy of `value`.
- `ReturnRef(variable)`: Returns a reference to `variable`.
- `Invoke(callable)`: Calls a function, method, lambda, or functor.
- `DoAll(actions...)`: Combines multiple actions, executing them in order.
- `SetArgPointee<N>(value)`: Sets the value pointed to by argument `N`.
- `ReturnPointee(pointer)`: Returns the value pointed to by `pointer` at call time.

### Using Lambdas or Functors

Specifying complex behavior is easier with lambdas.

```cpp
EXPECT_CALL(mock_object, MethodName(_))
    .WillOnce([](ArgType arg) { /* custom logic */ return something; });
```

---

## Call Counting and Cardinalities

Use `.Times()` to specify how often a method should be called.

| Cardinality       | Meaning                             |
| ----------------- | ---------------------------------- |
| `Exactly(n)` or `n`| Exactly `n` times                   |
| `AnyNumber()`      | Any number of calls (including 0)  |
| `AtLeast(n)`       | At least `n` times                  |
| `AtMost(n)`        | At most `n` times                   |
| `Between(m,n)`     | Between `m` and `n` times inclusive|

### Zero Calls - Asserting No Invocation

```cpp
EXPECT_CALL(mock, SomeMethod(_)).Times(0); // Must not be called
```

---

## Call Ordering and Sequencing

By default, calls can occur in any order. To enforce call order:

### 1. Using `InSequence` Object

Wrap expectations in the scope of an `InSequence` object to require calls occur sequentially in that order.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstMethod());
  EXPECT_CALL(mock, SecondMethod());
}
```

### 2. Using `Sequence` Objects

Define explicit `Sequence` objects and assign expectations via `.InSequence(s1, s2)`.

This allows expressing partial orderings and dependencies.

### 3. Using `.After()` Clause

Specify that one expectation occurs only *after* others have been satisfied.

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Run()).After(e1);
```

---

## Strictness Controls: Nice, Naggy, and Strict Mocks

Control how uninteresting calls (calls to mock methods without expectations) are treated.

| Mock Type            | Behavior on Uninteresting Calls                  |
| --------------------|-------------------------------------------------|
| `NiceMock<T>`       | Suppresses warnings, allows uninteresting calls.|
| `NaggyMock<T>`      | (default) warns on uninteresting calls.          |
| `StrictMock<T>`     | Treats uninteresting calls as errors.            |

### Usage

```cpp
NiceMock<MockFoo> nice_mock;
NaggyMock<MockFoo> naggy_mock;
StrictMock<MockFoo> strict_mock;
```

**Recommendation:**

- Use `NiceMock` for most maintainable tests.
- Use `NaggyMock` during development or debugging.
- Use `StrictMock` sparingly, only when you want strict enforcement.

---

## Retiring Expectations and Managing Saturation

### Sticky Expectations by Default

Expectations remain active (sticky) even after their upper bound is reached, which causes over-saturation errors on excessive calls.

### `.RetiresOnSaturation()` Clause

Make an expectation retire (become inactive) when saturated, allowing later expectations to match subsequent calls.

```cpp
EXPECT_CALL(mock, Method(5))
    .Times(2)
    .RetiresOnSaturation();
```

---

## Using ON_CALL for Default Behaviors

`ON_CALL` specifies default actions for mock methods when no expectations match.

```cpp
ON_CALL(mock_object, Method(_))
    .WillByDefault(Return(default_value));
```

- `ON_CALL` does not assert call expectations.
- It is often used in the test fixture setup for common behaviors.
- More specific `EXPECT_CALL`s override `ON_CALL`s.

---

## Best Practices and Clean Design

- **Set expectations before exercising mocks.** Avoid undefined behavior by not mixing calls and expectations.
- **Use `NiceMock` to suppress uninteresting call warnings** and keep output clean.
- **Use `.RetiresOnSaturation()` to avoid upper-bound errors in sequences or repeated calls.**
- **Use `InSequence` and `Sequence` to express call order only when relevant.** Partial orders reduce brittleness.
- **Use specific matchers only as needed.** Overly strict matchers make tests brittle.
- **Delegate to fakes or real objects when complex behaviors exist to reduce mock complexity.** See [gMock Cookbook Delegation](https://google.github.io/googletest/gmock_cook_book.html#DelegatingToFake).
- **Avoid mocking methods with excessive argument lists or undocumented behaviors.** Simplify with interface adapters.
- **Use actions judiciously, combining side effects with return values using `DoAll()`.**
- **Clear expectations when testing multiple stages using `Mock::VerifyAndClearExpectations()`.**

---

## Troubleshooting Common Issues

### Unexpected Calls

- Occur when a mock function is called without matching expectations.
- Remedy by adding an explicit `EXPECT_CALL` or relaxing specs.

### Excessive Calls

- When a call occurs more times than declared.
- Fix with `.Times()` and/or `.RetiresOnSaturation()`.

### Uninteresting Calls Warnings

- Appear when calls are made to methods with no `EXPECT_CALL`.
- Use `NiceMock` to suppress, or add broad `EXPECT_CALL` with `Times(AnyNumber())`.

### Actions Running Out

- Happen when the list of `WillOnce()` actions exhausts before expected calls are done.
- Remedy with `WillRepeatedly()` or by extending `WillOnce()` list.

### Complex Overloaded Interfaces

- Disambiguate with `Const()`, explicit matchers, or redesign the mock interface.

---

## Next Steps & Related Content

- **[Getting Started with GoogleMock](https://google.github.io/googletest/guides/getting-started/using-googlemock.html)**: Learn basic mock usage.
- **[Mock Method Definition and Expectations Reference](https://google.github.io/googletest/reference/mocking.html)**: Detailed API reference.
- **[gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)**: Recipes including delegation and advanced actions.
- **[Matchers Reference](https://google.github.io/googletest/reference/matchers.html)**: Understand argument matching.
- **[Actions and Side Effects](https://google.github.io/googletest/reference/actions_and_side_effects.html)**: Detailed info on specifying mock behaviors.
- **[Strictness Controls](https://google.github.io/googletest/reference/mock_strictness_controls.html)**: Manage uninteresting calls.


---

# Example: Combining Sequences and Retiring Expectations

```cpp
#include <gmock/gmock.h>

using ::testing::Sequence;
using ::testing::Return;
using ::testing::InSequence;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (int), ());
};

TEST(MockFooTest, OrderedBehaviorWithRetires) {
  MockFoo foo;
  Sequence s1, s2;

  EXPECT_CALL(foo, GetValue(1))
      .InSequence(s1, s2)
      .Times(1)
      .WillOnce(Return(10))
      .RetiresOnSaturation();

  EXPECT_CALL(foo, GetValue(2))
      .InSequence(s1)
      .Times(AnyNumber())
      .WillRepeatedly(Return(20));

  EXPECT_CALL(foo, GetValue(3))
      .InSequence(s2)
      .Times(AnyNumber())
      .WillRepeatedly(Return(30));

  EXPECT_EQ(10, foo.GetValue(1));
  EXPECT_EQ(20, foo.GetValue(2));
  EXPECT_EQ(30, foo.GetValue(3));
  // foo.GetValue(1) is now retired
  EXPECT_EQ(20, foo.GetValue(1));  // Falls back to expectation #2 (GetValue(2)) if args match
}
```

---

# Summary

This guide provides advanced workflows for GoogleMock:

- Precise setting and management of expectations using `EXPECT_CALL`.
- Specifying behaviors with actions like `Return` and `Invoke`.
- Controlling how many times methods are called using cardinality and `.Times()`.
- Ensuring call order with `Sequence`, `InSequence`, and `.After()`.
- Using strictness modifiers to manage uninteresting call warnings and errors.
- Retiring expectations for better call lifetime management.
- Practical advice on using `ON_CALL` for default/mock behaviors.
- Best practices for maintainability and troubleshooting tips.

Use these advanced patterns to write robust, readable, and maintainable tests with GoogleMock.

---

# References

- [GoogleMock Official Documentation](https://google.github.io/googletest/gmock_for_dummies.html)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions_and_side_effects.html)
- [Mock Strictness Controls](https://google.github.io/googletest/reference/mock_strictness_controls.html)

---

**Explore related guides:**
- Extending with GoogleMock
- Parameterized and Typed Tests
- Troubleshooting Common Setup Issues


---

_Last updated: GoogleTest version on branch `main`_
