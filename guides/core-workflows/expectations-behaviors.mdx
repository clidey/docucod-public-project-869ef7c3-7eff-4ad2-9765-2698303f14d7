---
title: "Setting Expectations and Behaviors"
description: "Understand how to specify and verify the number of calls, argument matchers, and actions using ON_CALL, EXPECT_CALL, and custom matchers to closely control and assert your mock's behavior."
---

# Setting Expectations and Behaviors

Understand how to specify and verify the number of calls, argument matchers, and actions using `ON_CALL`, `EXPECT_CALL`, and custom matchers to closely control and assert your mock's behavior.

---

## 1. Introduction

This guide focuses exclusively on the **Setting Expectations and Behaviors** page in GoogleMock. It helps you master how to define precise expectations on mock methods using `EXPECT_CALL` and specify default behaviors using `ON_CALL`. You will learn to control how mock methods respond to calls, how many times they are expected to be invoked, how to match their arguments, and specify their outputs or side effects.

By following this guide, you will gain confidence in crafting robust mock expectations that prevent test brittleness and ensure interaction correctness.

---

## 2. Prerequisites

Before proceeding, ensure you have:

- A working GoogleMock integration installed and configured in your C++ project.
- Mock classes defined using `MOCK_METHOD` for the methods you intend to mock.
- Basic knowledge of GoogleMock matchers ([Matchers Reference](reference/matchers.md)) and actions ([Actions Reference](actions.md)).
- Familiarity with test fixtures and the test execution flow of GoogleTest & GoogleMock.

If new to using mocks, consult the [Mocking Basics](guides/core-workflows/mocking-basics.mdx) and [Writing and Running Your First Test](guides/getting-started/writing-your-first-test.mdx) guides before this one.

---

## 3. Understanding ON_CALL and EXPECT_CALL

### Difference Between ON_CALL and EXPECT_CALL

- **`ON_CALL`**: Specifies the *default behavior* of a mock method when called with arguments matching certain criteria. It does **not** set an expectation that the call *must* happen.

- **`EXPECT_CALL`**: Specifies both the *expected frequency and behavior* of a mock method call. It asserts that a method **will be called** matching the specified argument matchers, number of times, and optionally in a particular order.

> **Best practice:** Use `ON_CALL` to configure normal behaviors shared across tests. Use `EXPECT_CALL` sparingly to verify specific interactions important to individual tests.

---

## 4. Specifying Expectations with EXPECT_CALL

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- **mock_object**: Instance of your mock class.
- **MethodName**: Mock method name.
- **matchers...**: Argument matchers for method parameters (use `_` to match any).
- **Times()**: How many calls are expected.
- **WillOnce() / WillRepeatedly()**: Actions that specify method behavior.

If `Times()` is omitted, GoogleMock infers the cardinality based on the number of actions you specify.

### Cardinality Options

- `Exactly(n)` or just `n`: Expect exactly `n` calls.
- `AtLeast(n)`: Expect *at least* `n` calls.
- `AtMost(n)`: Expect *at most* `n` calls.
- `Between(m, n)`: Expect between `m` and `n` calls.
- `AnyNumber()`: Any number of calls (including zero).

### Example

```cpp
using ::testing::Return;
EXPECT_CALL(foo, Bar(5))
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillOnce(Return(30));
```

This expects `foo.Bar(5)` to be called exactly 3 times, returning 10, then 20, then 30 respectively.

---

## 5. Setting Default Behavior with ON_CALL

### Basic Syntax

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .WillByDefault(action);
```

- Applies to calls matching the arguments but *does not* assert they must happen.
- Overridden by any matching `EXPECT_CALL`.
- Useful for setting default return values or side effects used in many tests.

### Example

```cpp
using ::testing::Return;
ON_CALL(foo, GetSize())
    .WillByDefault(Return(42));
```

This means `foo.GetSize()` will return 42 unless overridden by an expectation.

---

## 6. Argument Matchers

### Why Use Matchers?

Match specific argument values or patterns to verify calls:

- `_` is the wildcard matcher that matches any argument.
- Use built-in matchers like `Eq()`, `Ge()`, `Lt()`, etc. for validation.
- Combine matchers using `AllOf()`, `AnyOf()`, `Not()`, etc.

### Whole Argument Matching with `.With()` Clause

Use `.With(Matcher<std::tuple<Args...>>)` to assert combined constraints on *all* arguments simultaneously.

```cpp
EXPECT_CALL(foo, SetBounds(_, _))
    .With(Lt()); // Expects first arg less than second
```

---

## 7. Controlling Call Order and Dependencies

### Sequences

Group expectations into sequences to enforce a call order.

```cpp
Sequence s;
EXPECT_CALL(foo, Init()).InSequence(s);
EXPECT_CALL(foo, Run()).InSequence(s);
```

### After Clause

Specify an expectation that must occur after other expectations.

```cpp
Expectation e1 = EXPECT_CALL(foo, Connect());
EXPECT_CALL(foo, Send()).After(e1);
```

Both methods can be combined for complex orderings.

---

## 8. Specifying Actions (WillOnce, WillRepeatedly)

### Actions

Define what a mock method should do when called.

- `Return(value)`: Return a fixed value.
- `Invoke(callable)`: Call a function, lambda, or functor.
- `SetArgPointee<N>(value)`: Modify output argument N.
- `DoAll(...)`: Perform multiple actions (only the last returns value).

### Multiple Actions

Use multiple `WillOnce()` clauses for sequential, distinct behaviors.

```cpp
EXPECT_CALL(foo, GetValue())
    .WillOnce(Return(10))
    .WillRepeatedly(Return(20));
```

Means first call returns 10, subsequent calls return 20.

---

## 9. Common Pitfalls and Best Practices

### Evaluation Timing

- Both `EXPECT_CALL` and `ON_CALL` evaluate their arguments only *once* at expectation definition time.
- Avoid side effects in matcher or action expressions that depend on runtime state.

### Sticky Expectations

- Expectations remain active after their call count is saturated unless `.RetiresOnSaturation()` is specified.
- Use `.RetiresOnSaturation()` to make expectations retire (stop matching) after they are fulfilled.

### Ordering

- By default, expectations are unordered.
- Use `InSequence` or `.After()` to enforce ordering.

### Overlapping Expectations

- Later `EXPECT_CALL`s override earlier matches for matching calls.
- Place more specific expectations after more general ones.

### Debugging Tips

- Use `--gmock_verbose=info` to see detailed call match logs.
- Use `Mock::VerifyAndClearExpectations()` to force verification at a test point.

---

## 10. Advanced Topics

### Custom Matchers and Actions

You can create custom matchers and actions to express complex or project-specific conditions and behaviors (see the [gMock Cookbook](docs/gmock_cook_book.md#CustomMatcherClass) for examples).

### Mock Strictness

Suppress or escalate warnings on uninteresting calls using `NiceMock`, `NaggyMock` (default), or `StrictMock` wrappers ([More details](reference/core-apis/gmock-nice-strict-api.md)).

### Handling Move-Only Types

Recent gMock versions support mocking methods with move-only types like `std::unique_ptr` directly in `MOCK_METHOD` and action clauses.

---

## 11. Troubleshooting Common Issues

### Uninteresting Call Warnings

If you get warnings about uninteresting calls (calls with no matching `EXPECT_CALL`), you can:

- Add an `EXPECT_CALL` with `.Times(AnyNumber())` to allow them explicitly.
- Use `NiceMock` to silence such warnings on entire mock objects.
- Review if the call is accidental or test code is missing expectations.

### Too Many or Too Few Actions

Warnings indicating mismatch between cardinality and the count of actions means your configured `WillOnce`/`WillRepeatedly` clauses do not cover the expected calls:

- Align the cardinality with number of `WillOnce` clauses.
- Add `WillRepeatedly` for the default behavior after explicit calls.

### Order Constraint Violations

If you see expectation ordering errors, verify sequences and `After` clauses are correctly set to represent intended ordering.

### Using Matchers Correctly

- Every argument must have a matcher or be covered by an omitted list (treated as `_`).
- Matchers must be pure functions without side effects.
- Use `Const()` to disambiguate overloads on const methods.

---

## 12. Summary Example

```cpp
using ::testing::AtLeast;
using ::testing::Return;
using ::testing::_;
using ::testing::Sequence;

class MockFoo {
 public:
  MOCK_METHOD(int, Compute, (int input), (override));
};

TEST(MyTest, ComputeBehavior) {
  MockFoo mock;
  Sequence s;

  // Default behavior for any call
  ON_CALL(mock, Compute(_)).WillByDefault(Return(0));

  // Expect Compute called with 5 exactly twice
  EXPECT_CALL(mock, Compute(5))
      .Times(2)
      .WillOnce(Return(10))
      .WillOnce(Return(20))
      .RetiresOnSaturation()
      .InSequence(s);

  // Expect Compute called with 3 once
  EXPECT_CALL(mock, Compute(3))
      .WillOnce(Return(15))
      .InSequence(s);

  EXPECT_EQ(mock.Compute(5), 10);
  EXPECT_EQ(mock.Compute(5), 20);
  EXPECT_EQ(mock.Compute(3), 15);
  EXPECT_EQ(mock.Compute(5), 0); // Default action after expected 2 calls
}
```

This example sets a default action, an ordered sequence of specific expectations, and verifies order and output.

---

## 13. Further Learning and Next Steps

- Explore [Mocking Basics Guide](guides/core-workflows/mocking-basics.mdx) to understand mock class creation and usage.
- Dive into [Matchers Reference](reference/matchers.md) for comprehensive matcher options.
- Study the [Actions API](api-reference/mock-actions-cardinalities/gmock-actions.md) for extending mock behaviors.
- Learn about test verification and mock lifecycle management with `Mock::VerifyAndClear` and related functions.

For deeper mastery, check related guides on [Writing and Running Your First Test](guides/getting-started/writing-your-first-test.mdx) and [Structuring Effective Test Suites](guides/core-workflows/structuring-tests.mdx).

---

## References and Links

- [GoogleMock Mocking Reference](reference/mocking.md)
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [Matchers Reference](reference/matchers.md)
- [Actions API](api-reference/mock-actions-cardinalities/gmock-actions.md)
- [Mock Strictness Control](api-reference/core-apis/gmock-nice-strict-api.md)

---

## Practical Tips

- **Set expectations before exercising mock objects** to avoid undefined behavior.
- Use `.RetiresOnSaturation()` to avoid over-saturation errors when expectations have fixed call counts.
- Use `NiceMock` to suppress warnings on uninteresting calls during early test development.
- Use sequences and `After()` for strict or partial ordering of calls.
- Always provide `WillByDefault()` in `ON_CALL` to avoid exceptions on unexpected calls returning complex types.
- Make sure all overloaded methods are disambiguated using argument lists or `Const()` wrapper.

---

This guide positions you to harness the power of **setting expectations and behaviors** in GoogleMock effectively and reliably. Use it as a reference for implementing precise and maintainable mock specifications in your C++ tests.

---

<Check>
Make sure expectations are declared before the mock method usage for defined and predictable behaviors.
</Check>

<Note>
Remember that `EXPECT_CALL` not only defines behavior but asserts calls will happen; overusing it can cause brittle tests.
</Note>

<Tip>
When dealing with overloaded methods, use full argument matcher lists or the `Const()` wrapper to disambiguate.
</Tip>