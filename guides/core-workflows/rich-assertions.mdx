---
title: "Using Assertions and Matchers Effectively"
description: "Master the comprehensive set of assertions and matchers provided by GoogleTest and GoogleMock. This guide explains when to use fatal vs. non-fatal checks, custom assertions, and advanced matchers for deep value comparisons and intent-revealing tests."
---

# Using Assertions and Matchers Effectively

Master the comprehensive set of assertions and matchers provided by GoogleTest and GoogleMock. This guide explains when to use fatal vs. non-fatal checks, create custom assertions, and leverage advanced matchers for deep value comparisons and intent-revealing tests.

---

## 1. Overview of Assertions and Matchers

### What This Guide Helps You Accomplish
This guide empowers you to write clear, concise, and effective tests by mastering GoogleTest's and GoogleMock's rich set of assertion macros and matchers. You will learn how to choose the right assertions for your verification needs, use matchers to specify argument expectations precisely, and craft custom assertions to express complex test logic.

### Prerequisites
- Basic familiarity with GoogleTest and GoogleMock setup.
- Understanding of C++ testing concepts such as test fixtures and mock objects.
- Your project configured to use GoogleTest and GoogleMock.

### Expected Outcome
By following this guide, you will consistently write tests that express your intent clearly, generate actionable failure messages, and maintain resilience during code changes.

### Time Estimate
Approximately 30-45 minutes to read and practice with examples.

### Difficulty Level
Intermediate

---

## 2. Understanding Assertions: Fatal vs. Non-Fatal

Assertions in GoogleTest verify conditions in your code. They fall into two categories:

- **Fatal Assertions (`ASSERT_*`)**: Fail the current test immediately, skipping subsequent assertions or code blocks in the function.
- **Non-Fatal Assertions (`EXPECT_*`)**: Record failure but allow the test to continue, enabling multiple errors to be reported within the same test.

### Best Practices
- Use `ASSERT_*` when continuing the test after failure could cause crashes or invalid operations.
- Use `EXPECT_*` when subsequent verifications are independent and you want to see all failures.

### Examples
```cpp
TEST(SampleTest, BasicAssertions) {
  int x = 5;
  ASSERT_GT(x, 0) << "x must be positive to proceed"; // Fatal if false
  EXPECT_EQ(x, 5) << "x should be exactly 5";           // Non-fatal
  // More assertions can follow safely
}
```

### Explicit Failures and Success
- Use `FAIL()` to produce a fatal failure with a custom message.
- Use `SUCCEED()` to indicate explicit success; helpful in control flows where a test passes intentionally.

---

## 3. Using Matchers for Expressive Expectations

Matchers express constraints on arguments passed to functions, especially in mock objects.

### Built-in Matchers
GoogleMock offers matchers for:
- **Wildcards:** `_` matches any value, useful when argument value is irrelevant.
- **Comparison:** `Eq()`, `Ne()`, `Lt()`, `Le()`, `Gt()`, `Ge()` for equality and inequalities.
- **Ranges and Sets:** `Between()`, `AnyOf()`, `AllOf()`, `Not()` to compose complex logical matchers.
- **Containers:** `ElementsAre()`, `UnorderedElementsAre()`, and `Pair()` for collections.
- **Strings:** `StartsWith()`, `EndsWith()`, `HasSubstr()`, `MatchesRegex()`

#### Example: Expecting a Call with Specific Arguments
```cpp
EXPECT_CALL(mock_obj, DoSomething(Ge(10), StartsWith("foo"), _));
```
This expects the first argument to be >= 10, second to start with "foo", and anything in the third.

### Multi-Argument Matching
Use `.With()` to specify a matcher that verifies all arguments collectively.

```cpp
EXPECT_CALL(mock, Func(_, _))
    .With(Lt()); // First arg less than second
```

### Using Custom Predicate Matchers
For specialized validation, define predicates wrapped with `Truly()`:
```cpp
bool IsEven(int n) { return n % 2 == 0; }
EXPECT_CALL(mock, Process(Truly(IsEven)));
```

---

## 4. Choosing Assertions with Matchers: The `EXPECT_THAT` Macro

`EXPECT_THAT(value, matcher)` combines assertions with matchers for readable, precise checks.

```cpp
EXPECT_THAT(name, StartsWith("John"));
EXPECT_THAT(numbers, ElementsAre(1, _, 3));
```
It produces informative failure logs showing the failing expression, the value, and the matcher description.

---

## 5. Custom Assertions for More Complex Checks

When built-in assertions or matchers don’t suffice, create custom assertions that return `::testing::AssertionResult`.

### Writing a Predicate with Detailed Error Messages
```cpp
::testing::AssertionResult IsEven(int n) {
  if ((n % 2) == 0) return ::testing::AssertionSuccess();
  else return ::testing::AssertionFailure() << n << " is not even";
}
```
Use in test:
```cpp
EXPECT_TRUE(IsEven(value));
```
This provides failure messages like:
```
Value of: IsEven(value)
  Actual: false (3 is not even)
Expected: true
```

### Using Predicate Formatters
Use `EXPECT_PRED_FORMAT*` macros to write assertions with full control over failure messages:
```cpp
::testing::AssertionResult PredicateFormatter(
    const char* expr1, const char* expr2,
    int val1, int val2) {
  if (val1 < val2) return ::testing::AssertionSuccess();
  return ::testing::AssertionFailure() << expr1 << " (" << val1
       << ") is not less than " << expr2 << " (" << val2 << ")";
}

EXPECT_PRED_FORMAT2(PredicateFormatter, a, b);
```

---

## 6. Advanced Matcher Techniques

### Validating Object Members
- Use `Field(&Type::member, matcher)` to match object fields.
- Use `Property(&Type::method, matcher)` to match return value of const methods.

Example:
```cpp
EXPECT_CALL(mock, Process(Field(&Data::id, Eq(42))));
```

### Matching Pointer Values
- `Pointee(matcher)` matches the pointed-to value.
- `IsNull()` and `NotNull()` match pointer states.

Example:
```cpp
EXPECT_CALL(mock, HandleData(Pointee(StartsWith("Hello"))));
```

### Combining Matchers
Use combinators like `AllOf()`, `AnyOf()`, and `Not()` to build complex logical matchers:
```cpp
EXPECT_CALL(mock, Func(AllOf(Gt(5), Ne(10))));
```

### Sharing and Reusing Matchers
Assign complex matchers to variables and reuse them:
```cpp
Matcher<int> valid_range = AllOf(Gt(0), Lt(100));
EXPECT_CALL(mock, Check(valid_range));
EXPECT_CALL(mock, Verify(valid_range));
```

### Writing Custom Matcher Classes and Macros
GoogleMock provides `MATCHER` and `MATCHER_P` family macros to define reusable custom matchers.

Example:
```cpp
MATCHER(IsDivisibleBy7, "is divisible by 7") {
  return (arg % 7) == 0;
}
```

---

## 7. Best Practices for Using Expectations with Mocks

### Setting Expectations
- Use `EXPECT_CALL(mock, Method(args))` prior to exercising code to specify expected calls.
- Avoid over-specifying expectations to reduce test brittleness.
- Prefer using `ON_CALL` for default mock behavior and `EXPECT_CALL` only where calls should be verified.

### Cardinality and Ordering
- Use `Times()` to control expected call frequency.
- Use `InSequence` or `Sequence` objects to enforce call order when necessary.

### Ignoring Uninteresting Calls
- If you don’t care about calls to certain mock methods, do not set `EXPECT_CALL` on them. GMock will warn but allow the calls or use `NiceMock` to suppress warnings.

### Retiring Expectations
- Use `.RetiresOnSaturation()` when you want an expectation to become inactive after fulfilling the required number of calls.

### Using `WillOnce` and `WillRepeatedly`
- `WillOnce(action)` specifies behavior of the next matching call.
- `WillRepeatedly(action)` specifies behavior for all subsequent matching calls after `WillOnce`s are consumed.

Tip: Use lambdas or existing functions with `Invoke()` for flexible actions.

---

## 8. Troubleshooting Common Issues

### Unexpected or Uninteresting Calls
- Uninteresting calls (methods without expectations) generate warnings; to suppress, use `NiceMock` or add catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())`.
- Unexpected calls (calls not matching any expectation) cause errors.

### Overlapping Expectations
- GMock searches expectations in reverse order (last declared has higher priority).
- More general expectations should appear before more specific ones for correct behavior.

### Sticky Expectations
- Expectations remain active after reaching the call count unless `.RetiresOnSaturation()` is used.

### Handling Matchers with Overloaded Methods
- Use `Const()` or typed matchers (`TypedEq`, `Matcher<T>`) to disambiguate overloads.

### Debugging Mismatch Failures
- Run tests with `--gmock_verbose=info` to trace mock calls and expectations.

---

## 9. Summary

Assertions and matchers form the backbone of expressive and maintainable tests with GoogleTest and GoogleMock. Armed with this knowledge, you can precisely verify your code’s behavior and interactions with collaborators, crafting tests that communicate intent clearly and withstand change gracefully.

---

## 10. Resources & Next Steps

- **GoogleTest Assertions Reference:** Comprehensive list of assertions with examples.
- **GoogleMock Cookbook:** Recipes for using matchers, expectations, and actions.
- **Writing Your First Test:** Step into test writing basics.
- **Integrating Mocking with GoogleMock:** Learn to mock dependencies effectively.

You are encouraged to start writing tests using assertions and matchers as covered here and then deepen your expertise with custom assertions and advanced mock interactions.

---

## Appendix: Key Assertion Macros and Matchers

| Category           | Macro / Function               | Description                         |
|--------------------|-------------------------------|-----------------------------------|
| Fatal assertions    | `ASSERT_*`                    | Abort test on failure              |
| Non-fatal assertions| `EXPECT_*`                    | Continue test on failure           |
| Matchers           | `_`                           | Wildcard match                     |
| Comparison Matchers| `Eq()`, `Ne()`, `Lt()`, etc. | Relational match                   |
| Container Matchers | `ElementsAre()`, `UnorderedElementsAre()` | Check container contents          |
| String Matchers    | `StartsWith()`, `HasSubstr()`, `MatchesRegex()` | Text matching                    |
| Composite Matchers | `AllOf()`, `AnyOf()`, `Not()`| Logical composition                |
| Custom Matchers    | `MATCHER`, `MATCHER_P`        | User-defined expressive matchers  |


---

## Code Sample: Using `EXPECT_THAT` with Matchers and Custom Predicates

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AllOf;
using ::testing::Gt;
using ::testing::Lt;
using ::testing::StartsWith;
using ::testing::HasSubstr;
using ::testing::Not;
using ::testing::Pointee;
using ::testing::Truly;

// Predicate for even numbers with custom message
bool IsEven(int n) { return n % 2 == 0; }

TEST(DemoTest, MatcherExamples) {
  std::string name = "Johnny";
  std::vector<int> numbers = {1, 2, 3};
  int* ptr_value = new int(5);

  EXPECT_THAT(name, AllOf(StartsWith("John"), Not(HasSubstr("Smith"))));
  EXPECT_THAT(numbers, AllOf(testing::ElementsAre(1, 2, 3)));
  EXPECT_THAT(ptr_value, Pointee(Gt(3)));
  EXPECT_THAT(4, Truly(IsEven));

  delete ptr_value;
}
```

This example demonstrates matching strings with multiple conditions, container content verification, pointer value checking, and usage of a custom predicate wrapped inside `Truly`.

---
