---
title: "Advanced Mocking Patterns"
description: "Delve into more sophisticated mocking use cases with GoogleMock—custom actions, matchers, cardinalities, and call sequencing. Emphasizes proven patterns and best practices for writing expressive, reliable, and maintainable mocks."
---

# Advanced Mocking Patterns

Delve into more sophisticated mocking use cases with GoogleMock—custom actions, matchers, cardinalities, and call sequencing. This guide emphasizes proven patterns and best practices for writing expressive, reliable, and maintainable mocks.

---

## Workflow Overview

### What This Guide Helps You Accomplish

This guide unlocks advanced techniques in creating and managing mocks using GoogleMock. You'll learn how to:

- Define **custom actions** to specify complex mock behaviors.
- Use advanced **matchers** to express detailed argument conditions.
- Manage **cardinalities** to control how often mock methods are invoked.
- Control **call sequencing** to enforce order or partial order of expectations.
- Apply best practices to write mocks that are not only powerful but also maintainable over time.

### Prerequisites

Before diving into these advanced patterns, you should have:

- Familiarity with basic GoogleMock concepts such as defining mocks, using `EXPECT_CALL` and `ON_CALL`, and basic matchers.
- A C++17-compatible development environment with GoogleTest and GoogleMock set up.
- Completed introductory tutorials like [Basic Mocking with GoogleMock](/guides/getting-started/basic-mocking).

### Expected Outcome

By following this guide, you will be able to write mock classes and tests that better capture real use-case complexities, improving both coverage and test robustness. You'll control how mocks react in nuanced ways, validating interactions accurately and clearly.

### Time Estimate

Approximately 45-60 minutes to read through and practice examples.

### Difficulty Level

Intermediate to Advanced.

---

## Step-by-Step Guide to Advanced Mocking Patterns

### 1. Defining Custom Actions

Custom actions let you tailor the behavior of mocked methods beyond built-in return values.

- Use function callbacks, lambdas, or functors in `WillOnce()` and `WillRepeatedly()` to define actions.
- Example:

```cpp
using ::testing::_;
using ::testing::Invoke;

class MockFoo {
 public:
  MOCK_METHOD(int, Sum, (int x, int y), (override));
};

int Add(int x, int y) {
  return x + y;
}

TEST(MockFooTest, CustomAddAction) {
  MockFoo mock;
  EXPECT_CALL(mock, Sum(_, _))
      .WillOnce(Invoke(Add));  // Calls Add with mock arguments

  EXPECT_EQ(mock.Sum(3, 4), 7);
}
```

- Use `DoAll()` if you need to chain multiple actions (e.g., modify output parameters and return a value).

- For side effects that require parameters from the mock function's arguments, use built-in actions like `SetArgPointee<N>(value)`.


### 2. Writing and Using Advanced Matchers

Matchers specify which arguments should match a mock method call.

- Use built-in matchers like `_` (wildcard), `Eq()`, `Ge()`, `NotNull()`, and compose them with combinators like `AllOf()`, `AnyOf()`, and `Not()`.

- Use the `.With()` clause in `EXPECT_CALL` and `ON_CALL` to add multi-argument tuple matchers.

- Define custom matchers for complex argument validation using `MATCHER` and `MATCHER_P` macros.

Example: Enforce that the first argument is less than the second in a two-argument mock method:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // Lt() is a matcher for tuples in GoogleMock
```

- Use `SafeMatcherCast<T>(matcher)` to resolve type mismatches when necessary.

- When testing containers or complex structures, use matchers like `ElementsAre()`, `UnorderedElementsAre()`, and nested matchers.

### 3. Specifying Cardinalities to Control Call Counts

The `Times()` clause controls how many times a mock method is expected to be called.

- Use cardinalities such as `Exactly(n)`, `AtLeast(n)`, `AtMost(n)`, `Between(m, n)`, or `AnyNumber()`.

- If `Times()` is omitted, GoogleMock infers it based on the presence of `WillOnce()` and `WillRepeatedly()`.

- To disallow calls, specify `.Times(0)`.

Example: Expect `SetNumber(7)` to be called exactly twice and retire the expectation afterwards:

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
```

### 4. Managing Call Sequencing and Partial Orders

Control the order of mock calls to reflect expected sequences or partial orders.

- Use the `InSequence` RAII class to put **all expectations in scope** into one strict sequence.

- Use `Sequence` objects combined with `.InSequence()` to impose order among grouped expectations.

- Use `.After()` clauses to define arbitrary dependencies between expectations.

Example: enforce that `Reset()` occurs before `GetSize()` and `Describe()`, but `GetSize()` and `Describe()` can happen in any order:

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, Reset()).InSequence(s1, s2);
EXPECT_CALL(mock, GetSize()).InSequence(s1);
EXPECT_CALL(mock, Describe()).InSequence(s2);
```

### 5. Polishing Expectations with `RetiresOnSaturation()` and Repeated Actions

- By default, expectations are _sticky_ — they stay active even after their upper call limit is reached.

- Use `.RetiresOnSaturation()` if you want an expectation to become inactive after it is saturated (e.g., after two calls if `Times(2)`).

- Combine `WillOnce()` clauses with `WillRepeatedly()` to specify sequences of behaviors with fallback.

Example: Return incrementing values on successive calls:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, GetValue())
      .WillOnce(Return(10))
      .WillOnce(Return(20))
      .WillRepeatedly(Return(30));
}
```

### 6. Using NiceMock, NaggyMock, and StrictMock to Control Uninteresting Calls

- By default, mock objects are *naggy*: they warn on calls that have no `EXPECT_CALL`.

- Use `NiceMock<MockClass>` to suppress warnings on uninteresting calls.

- Use `StrictMock<MockClass>` to treat uninteresting calls as test failures.

Example:

```cpp
NiceMock<MockFoo> nice_mock;  // ignores uninteresting call warnings
StrictMock<MockFoo> strict_mock;  // error on uninteresting calls
```

**Note:** These classes only affect mock methods defined with the `MOCK_METHOD` macro directly in the mock class.

---

## Examples & Scenarios

### Example: Custom Action with Side Effect

```cpp
class MockProcessor {
 public:
  MOCK_METHOD(void, Process, (int* output), (override));
};

using ::testing::DoAll;
using ::testing::Return;
using ::testing::SetArgPointee;

TEST(ProcessorTest, SetsOutputAndReturns) {
  MockProcessor mock;

  EXPECT_CALL(mock, Process(_))
      .WillOnce(DoAll(SetArgPointee<0>(42), Return()));

  int result = 0;
  mock.Process(&result);
  EXPECT_EQ(result, 42);
}
```

### Example: Matching Multiple Arguments with `.With()` Clause

```cpp
EXPECT_CALL(mock, UpdatePosition(_, _))
    .With(Lt());  // First argument less than second
```

### Example: Enforcing Call Order with Sequence

```cpp
Sequence seq;
EXPECT_CALL(mock, FirstCall()).InSequence(seq);
EXPECT_CALL(mock, SecondCall()).InSequence(seq);
```

### Example: Delegating Default Behavior to a Fake Object Inside a Mock

```cpp
class FakeFoo : public Foo {
 public:
  char DoThis(int n) override { return (n > 0) ? '+' : '-'; }
  void DoThat(const char* s) override { ... }
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(char, DoThis, (int n), (override));
  MOCK_METHOD(void, DoThat, (const char* s), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault([this](int n) { return fake_.DoThis(n); });
    ON_CALL(*this, DoThat).WillByDefault([this](const char* s) { fake_.DoThat(s); });
  }

 private:
  FakeFoo fake_;
};
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting calls cause warnings or errors:** This usually means your mock method was called without an `EXPECT_CALL` or appropriate default `ON_CALL`.
  - *Solution:* Use `NiceMock` to suppress warnings or add a catch-all `EXPECT_CALL(...).Times(AnyNumber())`.

- **Too many or too few `WillOnce()` actions for the declared call count:** You will see warnings if your actions do not align with the expectation's cardinality.
  - *Tip:* Ensure the number of `WillOnce()` matches, or use a `WillRepeatedly()` fallback.

- **Ordering failures:** Calls are made out of order when expectations are sequenced.
  - *Tip:* Double-check your use of `InSequence`, `After`, or `EXPECT_CALL` ordering or sequencing.

- **Mock methods not called as expected:** Remember GoogleMock searches expectations from last to first; newer overrides older.
  - *Tip:* Order your expectations from general to specific accordingly.

- **Confusion with overloaded methods:** Use `Const()` wrapper or specify argument types with `Matcher<>` or `TypedEq<>` to disambiguate.

### Best Practices

- Favor **`ON_CALL`** to set default mock behavior and reserve **`EXPECT_CALL`** for calls you expect to verify.
- Use **`NiceMock`** in most cases to reduce noise from uninteresting calls.
- Restrict sequences only when necessary to avoid brittle tests.
- Keep custom actions and matchers simple and pure to avoid stale or opaque test failures.
- Clear or verify expectations explicitly with `Mock::VerifyAndClear()` if your mock outlives the test scope.

---

## Next Steps & Related Documentation

- [Basic Mocking with GoogleMock](/guides/getting-started/basic-mocking) — For foundational mocking workflows.
- [Matchers API](/api-reference/matchers-actions/matchers) — Deep dive into all built-in and custom matchers.
- [Actions API](/api-reference/matchers-actions/actions) — Full overview of actions including custom actions.
- [Cardinalities and Expectations API](/api-reference/advanced-customization/cardinalities-expectations) — Detailed usage of call count management.
- [Designing and Using Mock Objects](/concepts/mocking-model/mock-object-design) — Conceptual guidance.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Practical recipes with explanations and examples.

---