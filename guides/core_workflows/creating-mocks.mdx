---
title: "Mocking Functions and Classes"
description: "A workflow guide to creating mock objects for interfaces, specifying call expectations with cardinalities, using invocation actions, and enforcing strictness for uninteresting calls. Includes practical patterns for robust mocking and common pitfalls to avoid."
---

# Mocking Functions and Classes in GoogleMock

This guide provides a practical workflow for creating mock objects for interfaces, specifying call expectations using cardinalities, invoking actions upon method calls, and enforcing strictness for uninteresting calls. It includes robust mocking patterns and highlights common pitfalls to avoid.

---

## 1. Understanding Mock Classes and Methods

### What is a Mock Class?
A *mock class* simulates the interface of a real class but allows you to define behaviors and expectations on its methods for unit testing purposes.

### Defining Mock Methods
Use the `MOCK_METHOD` macro within your mock class to define mock methods that correspond to the interface methods you want to mock.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};
```

- Always place mock method definitions in the `public:` section, regardless of the original method's access level.
- Handle methods with commas in argument or return types carefully, either by wrapping types in parentheses or using type aliases.

### Mocking Overloaded and Template Methods
Mocking overloaded methods requires defining each overload explicitly.

```cpp
MOCK_METHOD(int, Add, (int x), (override));
MOCK_METHOD(int, Add, (int times, Element x), (override));
```

For class templates, mock them similar to regular classes with template syntax.

### Mocking Non-Virtual and Free Functions
- Non-virtual functions can be mocked by defining unrelated mock classes with matching method signatures.
- Free functions cannot be directly mocked; instead, wrap them into interfaces and mock the interface.

## 2. Creating Mock Objects with Different Strictness Levels

GoogleMock supports three categories of mock objects regarding uninteresting calls (calls to mock methods without expectations):

| Mock Type         | Behavior with Uninteresting Calls                            |
|-------------------|--------------------------------------------------------------|
| `NiceMock<T>`     | Suppresses warnings for uninteresting calls.                 |
| `NaggyMock<T>`    | Prints warnings for uninteresting calls (default behavior).  |
| `StrictMock<T>`   | Treats uninteresting calls as test failures.                  |

Example:

```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_foo;      // Warnings suppressed.
NaggyMock<MockFoo> naggy_foo;    // Warnings printed.
StrictMock<MockFoo> strict_foo;  // Uninteresting calls cause failures.
```

<Tip>
Use `NiceMock` for most tests to keep them resilient and maintainable. Reserve `StrictMock` for scenarios where you want to enforce tighter control over all mock interactions.
</Tip>

## 3. Setting Expectations using EXPECT_CALL

An *expectation* defines what calls your mock objects should receive, with which arguments, how many times, and what they should do when called.

### Basic Expectation Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `mock_object`: Instance of your mock.
- `MethodName`: The method on the mock you want to expect calls to.
- `matchers`: Specify argument matchers (e.g., `_` for wildcard, `Eq(value)`, `Lt(value)`).
- `Times`: How many times this call is expected (default inferred).
- `WillOnce` / `WillRepeatedly`: Specifies actions to perform on calls.

### Specifying Call Cardinalities

You can define how often the method is expected to be called:

| Cardinality          | Meaning                                      |
|----------------------|----------------------------------------------|
| `Exactly(n)` or `n`  | Call expected exactly *n* times.             |
| `AnyNumber()`        | Call any number of times.                     |
| `AtLeast(n)`         | Call at least *n* times.                      |
| `AtMost(n)`          | Call at most *n* times.                       |
| `Between(m, n)`      | Call between *m* and *n* times (inclusive). |

If omitted, GoogleMock infers the cardinality based on actions.

### Ordering Calls

- Use `InSequence` to enforce sequential order.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

- Use `Sequence` objects with `InSequence()` to express partial ordering.
- Use `.After()` to specify one expectation must occur after another.

### Using `.RetiresOnSaturation()`

When an expectation is met the maximum allowed number of times, `.RetiresOnSaturation()` marks it inactive to allow other expectations to match subsequently.

### Using `.With()` for Tuple Argument Matching

If argument relation spans multiple parameters, use `.With()` with a multi-argument matcher.

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt()); // Expects first argument less than second
```

## 4. Defining Mock Behavior using ON_CALL and Actions

- `ON_CALL` defines default behavior without requiring the method to be called.
- Use `WillByDefault()` to specify the default action.

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .WillByDefault(Return(value));
```

- `EXPECT_CALL` actions override `ON_CALL` defaults.
- Common built-in actions include `Return()`, `ReturnRef()`, `Invoke()`, `DoAll()`, `SetArgPointee()`, and `InvokeArgument()`.

### Performing Side Effects

Use actions like `SetArgPointee<N>(value)` to set output parameters or `DoAll()` to combine actions.

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

### Returning Values
- For reference return types, use `ReturnRef(variable)`.
- To return a live value that may change, use `ReturnPointee(&variable)`.

### Using Custom Lambdas or Functions

You can use any callable that matches the mock method signature.

```cpp
EXPECT_CALL(mock, DoWork(_))
    .WillOnce([](int n) { return n * 2; });
```

## 5. Best Practices and Common Pitfalls

- Always set expectations *before* exercising the code that calls mocks.
- Avoid over-specifying expectations; write only what’s necessary to verify behavior.
- Use `NiceMock` to suppress uninteresting call warnings if you don’t care about some calls.
- Use `.RetiresOnSaturation()` in loops or sequences where multiple expectations exist on the same method.
- When mocking methods with move-only types (like `std::unique_ptr`), prefer lambdas in `WillOnce()` and `WillRepeatedly()` for returning new instances.
- Avoid mixing mocking and real implementations indiscriminately; consider delegation patterns only when necessary.

## 6. Troubleshooting Mocking Issues

### Common Issues

- **Uninteresting Call Warnings:** Use `NiceMock` or add a catch-all `EXPECT_CALL(...).Times(AnyNumber())`.
- **Unexpected Calls:** Occur when arguments don’t match any `EXPECT_CALL`. Adjust matchers or add expectations.
- **Too Many or Too Few Actions:** GoogleMock warns if the number of `.WillOnce()` actions doesn’t match the expected cardinality.
- **Mock Method Not Called:** Verify the test flow and that the method is exercised.

<Tip>
If unsure why an expectation fails, run tests with `--gmock_verbose=info` to see matched calls and stack traces.
</Tip>

## 7. Examples

### Basic Mock Class and Expectation

```cpp
class FooInterface {
 public:
  virtual int GetSize() const = 0;
  virtual void DoSomething(int n) = 0;
  virtual ~FooInterface() = default;
};

class MockFoo : public FooInterface {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, DoSomething, (int n), (override));
};

TEST(FooTest, GetSizeReturns10) {
  MockFoo mock;
  EXPECT_CALL(mock, GetSize())
      .WillOnce(Return(10));

  int size = mock.GetSize();
  EXPECT_EQ(10, size);
}
```

### Expecting Calls with Cardinality and Sequence

```cpp
TEST(FooTest, CallsInSequence) {
  MockFoo mock;
  {
    InSequence seq;
    EXPECT_CALL(mock, DoSomething(1));
    EXPECT_CALL(mock, DoSomething(2));
  }

  mock.DoSomething(1);
  mock.DoSomething(2);
}
```

### Using ON_CALL for Default Behavior

```cpp
ON_CALL(mock, GetSize()).WillByDefault(Return(5));
```

### Handling Uninteresting Calls

```cpp
NiceMock<MockFoo> nice_mock;
// Warnings for uninteresting calls suppressed.
```

### Delegating Calls to a Fake Implementation

```cpp
class FakeFoo : public FooInterface {
 public:
  int GetSize() const override { return 42; }
  void DoSomething(int n) override { /* ... */ }
};

class MockFoo : public FooInterface {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, DoSomething, (int), (override));

  void DelegateToFake() {
    ON_CALL(*this, GetSize())
        .WillByDefault([this]() { return fake_.GetSize(); });
    ON_CALL(*this, DoSomething(_))
        .WillByDefault([this](int n) { fake_.DoSomething(n); });
  }

 private:
  FakeFoo fake_;
};

TEST(FooTest, DelegatesToFake) {
  MockFoo mock;
  mock.DelegateToFake();
  EXPECT_CALL(mock, GetSize()).Times(1);
  EXPECT_EQ(42, mock.GetSize());
}
```

---

## 8. References and Further Reading

- [GoogleMock Overview](https://google.github.io/googletest/gmock_for_dummies.html)
- [Expectations and Actions Reference](https://google.github.io/googletest/gmock_cook_book.html#setting-expectations)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [Mocking API Reference](../api-reference/mocking-api/defining-using-mocks)

---

This guide is part of the GoogleTest Mocking workflows series, recommended to read alongside the 'Introduction to Mocking' and 'Mocking with GoogleMock: Quickstart' guides.