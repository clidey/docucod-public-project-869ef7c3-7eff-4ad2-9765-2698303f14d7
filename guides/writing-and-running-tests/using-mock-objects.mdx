---
title: "Using Mock Objects Effectively"
description: "Step-by-step instructions for creating and using mock classes with GoogleMock, including defining mocks, setting expectations, and validating interactions."
---

### Using Mock Objects Effectively

#### Overview
This guide empowers you to create, configure, and utilize mock objects in GoogleMock effectively to control and verify the interactions between your code and its dependencies. By mastering mock class definitions, setting flexible expectations, customizing default behaviors, and leveraging ordering and call count constraints, you can write robust, maintainable tests that catch errors early and document intended interactions clearly.

---

#### Prerequisites
- Basic understanding of mock objects and their use in unit testing.
- Familiarity with C++ and virtual function overriding.
- A mock class defined using `MOCK_METHOD` macros with proper method signatures.
- GoogleMock (`#include <gmock/gmock.h>`) integrated into your project.

---

#### Expected Outcome
After completing this guide, you will be able to:
- Define mock methods correctly including const, override, and noexcept qualifiers.
- Set expectations for method calls with argument matchers, call counts, and behaviors.
- Configure default method behaviors using `ON_CALL`.
- Control call order using sequences and dependencies.
- Differentiate and handle uninteresting, unexpected, and excessive calls.
- Use common strategies to avoid brittle test designs.

---
#### Time Estimate
Approximately 20-40 minutes, depending on your familiarity with GoogleMock and C++ mocking concepts.

---

### 1. Defining Mock Classes

Mock classes are the foundation. Use `MOCK_METHOD` inside your mock class to declare mocked methods.

- Place all `MOCK_METHOD` declarations in the `public:` section, regardless of the base class method's original access.
- Syntax:
  ```cpp
  class MockTurtle : public Turtle {
   public:
    MOCK_METHOD(void, PenUp, (), (override));
    MOCK_METHOD(int, GetX, (), (const, override));
  };
  ```
- To mock methods with return or argument types having commas, either bracket them with parentheses or define a type alias.

---

### 2. Setting Expectations with EXPECT_CALL

`EXPECT_CALL` establishes what you expect your code to do with the mock.

#### Basic Syntax
```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- Use argument matchers like `_` (wildcard), `Eq()`, `Ge()`, `NotNull()`, etc.
- Omit `.Times()` to have GoogleMock infer:
  - If no actions, call expected once.
  - If n `WillOnce()`, expect n calls.
  - If `WillRepeatedly()` specified, expect at least n calls.

#### Controlling Call Counts
- `.Times(n)` expects exactly n calls.
- Use `AnyNumber()` to allow any number of calls.
- Use `AtLeast(n)`, `AtMost(n)`, or `Between(m, n)` for flexible count ranges.

#### Specifying Behavior
- `.WillOnce()` sets the action for a single matching call.
- `.WillRepeatedly()` sets a default action for subsequent calls.
- Chain multiple `WillOnce()` to specify different return values per call.

**Example:**
```cpp
using ::testing::Return;
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillRepeatedly(Return(200));
```

#### Best Practices
- Avoid over-specifying callsâ€”only check what matters.
- Consider using `.RetiresOnSaturation()` for expectations that should stop matching after saturation.
- For multiple expectations on a method, remember newer take precedence over older.

---

### 3. Defining Default Behavior with ON_CALL

`ON_CALL` sets the *default* behavior of a mock method, without setting an expectation that the method must be called.

```cpp
ON_CALL(mock_object, MethodName(matchers...))
    .WillByDefault(action);
```

- Used typically during mock setup (e.g., fixture setup).
- Does not restrict whether the method *must* be called.
- Use to suppress warnings from uninteresting calls or to provide fallback behavior.
- `.With()` clause can further restrict argument matching as in `EXPECT_CALL`.

---

### 4. Handling Argument Matching

- Use simple matchers such as `_`, `Eq(value)`, `Ge(value)`, etc.
- For complex conditions, combine matchers with `AllOf()`, `AnyOf()` or write your own predicate matcher using `Truly()`.
- To validate members/fields of argument objects, use `Field()` and `Property()` matchers.

**Example:**
```cpp
EXPECT_CALL(foo, Bar(Field(&MyStruct.value, Ge(5))));
```

- For matching pointers to values, use `Pointee(matcher)`.

---

### 5. Controlling Call Order

- By default, calls can occur in any order.
- To enforce ordering:
  - Use `InSequence` to group expectations that must occur sequentially.
  ```cpp
  {
    InSequence s;
    EXPECT_CALL(mock, Foo());
    EXPECT_CALL(mock, Bar());
  }
  ```
  - Use `.After(expectation_or_expectation_set)` to specify partial ordering.

---

### 6. Managing Mock Behavior Strictness

- `NiceMock<MockClass>` suppresses warnings on uninteresting calls.
- `NaggyMock<MockClass>` (default) warns on uninteresting calls.
- `StrictMock<MockClass>` treats uninteresting calls as test failures.

Choose based on how strict you want tests to be about unexpected interactions.

---

### 7. Common Patterns & Pitfalls

- **Retiring expectations:** Use `.RetiresOnSaturation()` to avoid expectation stickiness.
- **Multiple Calls with Different Results:** Chain `WillOnce()` actions.
- **Expecting No Calls:** Use `.Times(0)` to forbid specific calls.
- **Avoid Overspecification:** Use `ON_CALL` for default setups and minimal `EXPECT_CALL`s to test contract.
- **Overloaded Functions:** Specify argument types or use the `Const()` wrapper for const overloaded methods.

---

### 8. Verifying and Cleaning Up Mocks

- Mock objects automatically verify expectations upon destruction.
- You can force verification earlier with:
  ```cpp
  ::testing::Mock::VerifyAndClearExpectations(&mock_object);
  ```
- Use `::testing::Mock::AllowLeak(&mock_object);` to suppress leaked mock warnings, if necessary.

---

### 9. Troubleshooting Tips

- Unexpected call errors indicate a call was made that didn't match any `EXPECT_CALL`.
- Uninteresting calls happen without any `EXPECT_CALL`. These produce warnings unless using `NiceMock`.
- Excessive calls occur when the number of calls exceeds `.Times()` or inferred cardinality.
- Use `--gmock_verbose=info` for detailed output on mock calls and expectation matching.

---

### Examples

#### Defining a Basic Mock
```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

#### Setting Expectations
```cpp
MockTurtle turtle;
EXPECT_CALL(turtle, PenUp()).Times(1);
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

#### Controlling Order
```cpp
{
  InSequence seq;
  EXPECT_CALL(turtle, PenUp());
  EXPECT_CALL(turtle, GetX());
}
```

#### Using ON_CALL
```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(10));
```

#### Complex Matchers
```cpp
EXPECT_CALL(mock, Foo(Property(&Foo::bar, Ge(3))));
```

---

### Next Steps & Related Content
- Explore [Mocking Reference](/api-reference/core-apis/mocking) for detailed APIs.
- Review [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced recipes.
- Learn about [Matchers](reference/matchers.md) and [Actions](reference/actions.md) to customize your mocks.
- Consult [Controlling Mock Strictness and Behavior](/guides/test-design-and-best-practices/mock-strictness-and-behavior) for strategy tips.
- Use the [Troubleshooting Common Issues](/getting-started/validation-troubleshooting/common-issues) guide to resolve problems.

---

<Tip>
Remember: Set expectations before exercising the mock; do not set expectations after the tested code has invoked the mock. This ensures reliable, deterministic behavior.
</Tip>

<Warning>
Avoid defining mocks for classes you do not own or for methods not designed to be mocked, as this couples tests too tightly to implementation details.
</Warning>

---

