---
title: "Mocking Best Practices & Advanced Patterns"
description: "Master advanced mocking, including sequencing, call expectations, cardinalities, default behaviors, and strictness. See how to use NiceMock, StrictMock, and custom actions to build maintainable, flexible tests."
---

# Mocking Best Practices & Advanced Patterns

Master advanced mocking techniques in GoogleMock focused on sequencing, call expectations, cardinalities, and default behaviors. Learn how to wield NiceMock, StrictMock, and custom actions to build maintainable and flexible tests.

---

## 1. Introduction and Workflow Overview

### What You Will Achieve
This guide teaches you how to create advanced mock expectations and behaviors for complex C++ testing scenarios using GoogleMock. You'll learn to control:

- The order of calls using sequences
- The number of expected calls using cardinalities
- Default behaviors for unmatched calls
- The strictness levels of mocks with NiceMock, NaggyMock, and StrictMock
- Custom actions and call expectations to build robust, readable test suites

### Prerequisites
You should already be familiar with:

- Defining mocks with `MOCK_METHOD`
- Setting expectations using `EXPECT_CALL`
- Basic matcher usage

If needed, consult the [GoogleMock for Dummies guide](../guides/get-started/mocking-basics) for foundational knowledge.

### Expected Outcome
After completing this guide, you will:

- Skillfully use `Sequence` and `InSequence` to control call order
- Correctly specify call cardinality to prevent under- or over-calls
- Manage default actions using `ON_CALL` and understand when to expect calls
- Choose and apply mock strictness wrappers (`NiceMock`, `NaggyMock`, `StrictMock`)
- Employ advanced chaining of actions like `WillOnce` and `WillRepeatedly`
- Avoid common pitfalls around unexpected and uninteresting calls

### Time Estimate
Approximately 20–30 minutes of reading and experimentation with sample tests.

### Difficulty Level
Intermediate to Advanced

---

## 2. Controlling Call Order Using Sequences

GoogleMock lets you enforce the order of mock function calls precisely when needed.

### Scenario
You want to guarantee that certain method calls occur in a strict order or partial order.

### How to Use Sequences

#### Using `InSequence` Helper
An `InSequence` object scopes a block of expectations to be sequentialized implicitly.

```cpp
// Calls must occur in the order: Initialize, Process, Cleanup.
{
  InSequence seq;  // All ExpectCalls in this scope are sequenced

  EXPECT_CALL(mock, Initialize());
  EXPECT_CALL(mock, Process());
  EXPECT_CALL(mock, Cleanup());
}
```

This enforces the calls must occur in that order, or the test will fail.

#### Using `Sequence` Objects and `.InSequence()` Clause
For more complex partial ordering, explicitly create named sequences:

```cpp
Sequence s1, s2;

EXPECT_CALL(mock, Reset())
    .InSequence(s1, s2);   // Must occur before s1 and s2 calls
EXPECT_CALL(mock, GetSize())
    .InSequence(s1);       // Must occur after Reset, before calls in s2
EXPECT_CALL(mock, Describe())
    .InSequence(s2);       // Must occur after Reset, in s2 sequence
```

This creates a Directed Acyclic Graph (DAG) of expectations representing partial order:

- Reset() happens before GetSize() and Describe()
- GetSize() and Describe() may be unordered relative to each other

### Tips and Best Practices

- Nesting `InSequence` blocks nests sequences and adds hierarchy to call order.
- Chaining `.InSequence()` allows an expectation to be part of multiple sequences.
- Use `.RetiresOnSaturation()` to retire expectations once saturated for fluent ordering.

### Verification
If calls are out of order, GoogleMock will report "Unexpected mock function call" with call details.

---

## 3. Specifying Call Expectations and Cardinalities

Smart control of how often calls are expected improves test robustness.

### Understanding Cardinalities
Use `.Times()` to specify how many times an expectation should be met. Cardinalities include:

| Cardinality          | Meaning                             |
|----------------------|-----------------------------------|
| `Exactly(n)` or `n`  | Called exactly *n* times           |
| `AnyNumber()`        | Called zero or more times          |
| `AtLeast(n)`         | Called at least *n* times          |
| `AtMost(n)`          | Called at most *n* times           |
| `Between(m, n)`      | Called between *m* and *n* times  |

### Cardinalities are inferred when omitted:

- No `WillOnce` or `WillRepeatedly`: `Times(1)` is assumed.
- N `WillOnce` clauses and no `WillRepeatedly`: `Times(N)` is assumed.
- N `WillOnce` clauses and one `WillRepeatedly`: `Times(AtLeast(N))` is assumed.

### Enforcing Never Calls
Explicitly disallow a call:

```cpp
EXPECT_CALL(mock, Foo(_))
    .Times(0);  // Fails if called
```

### Handling Over- or Under-Calling
GoogleMock balances cardinalities with actions (`WillOnce`, `WillRepeatedly`) and warns or errors on violations.

- Excess calls to a method will produce errors unless default actions handle them.
- Calls fewer than minimum cardinality produce non-fatal failures after test completion.

### Retiring on Saturation
Use `.RetiresOnSaturation()` to make an expectation inactive once saturated:

```cpp
EXPECT_CALL(mock, Bar())
    .Times(2)
    .RetiresOnSaturation();
```

After two calls, further calls won't match this expectation, allowing others to match.

### Example
```cpp
Sequence s;
EXPECT_CALL(mock, DoA(1))
    .InSequence(s)
    .Times(1);
EXPECT_CALL(mock, DoA(2))
    .InSequence(s)
    .Times(1)
    .RetiresOnSaturation();

mock.DoA(1);  // Ok
mock.DoA(2);  // Ok
mock.DoA(2);  // Errors - outside Times
```

---

## 4. Managing Default Behaviors with ON_CALL

`ON_CALL` defines how mocks behave when calls occur but no expectation is set.

### When to Use ON_CALL
Use `ON_CALL` to specify default behavior for method calls you don't explicitly expect.

```cpp
ON_CALL(mock, GetSize())
    .WillByDefault(Return(42));
```

Unlike `EXPECT_CALL`, it does not assert calls must occur, only how to respond if they do.

### Ordering of ON_CALLs
More recent `ON_CALL` specifications take precedence. The last matching `ON_CALL` sets the behavior.

### Relationship With EXPECT_CALL
`EXPECT_CALL` takes precedence over `ON_CALL` for matching calls.

### Specifying Default Actions Without ON_CALL
GoogleMock uses built-in default actions for basic types;
for example, `int` returns `0`, `bool` returns `false`.

---

## 5. The Nice, the Naggy, and the Strict: Controlling Uninteresting Call Handling

GoogleMock’s mock strictness modifiers control warnings and errors for calls with no matching expectations.

| Modifier      | Behavior on Uninteresting Calls (no matching EXPECT_CALL)                      |
|-------------- |-------------------------------------------------------------------------------|
| `NiceMock<T>` | Suppresses all warnings/errors; uninteresting calls allowed silently          |
| `NaggyMock<T>`| Default; warnings are printed but no errors                                   |
| `StrictMock<T>`| Uninteresting calls cause test failures                                      |

### Usage
```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock;    // Ignores unexpected calls
NaggyMock<MockFoo> naggy_mock;  // Warns on unexpected calls
StrictMock<MockFoo> strict_mock; // Fails on unexpected calls
```

### Important Notes

- Applies only to *uninteresting* calls (no `EXPECT_CALL` exists). Unexpected calls (arguments don't match any expectation) always fail regardless.
- Only works for mock methods defined directly in the mock class via `MOCK_METHOD`.
- Mocks with virtual destructors work best.

### Choosing the Right Modifier

- Use `NiceMock` for maintainable, less brittle tests.
- Use `NaggyMock` when developing or debugging to get warnings.
- Use `StrictMock` sparingly to enforce strict call requirements.

---

## 6. Chaining Actions: `WillOnce()` and `WillRepeatedly()`

Specify detailed behaviors as calls occur.

### `WillOnce(action)`
Every call executes the next specified `WillOnce()` action. The number of `WillOnce()` clauses implies minimal cardinality if `Times()` is omitted.

### `WillRepeatedly(action)`
After all `WillOnce()` actions are used, `WillRepeatedly()` executes for subsequent calls.

### Example
```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))   // 1st call
    .WillOnce(Return(2))   // 2nd call
    .WillRepeatedly(Return(3));  // subsequent calls

EXPECT_EQ(mock.GetNumber(), 1);  // succeeds
EXPECT_EQ(mock.GetNumber(), 2);  // succeeds
EXPECT_EQ(mock.GetNumber(), 3);  // succeeds
EXPECT_EQ(mock.GetNumber(), 3);  // succeeds
```

### Actions With Side Effects
Be cautious with side effects inside `WillOnce()`. These clauses are evaluated once when expectations are set, not per call.

Use lambdas to produce per-call side effects or new values.

---

## 7. Practical Tips, Best Practices, and Common Pitfalls

### Tips

- **Specify expectations before exercising mocks**: Setting `EXPECT_CALL` after calls leads to undefined behavior.
- **Order your expectations with specificity in mind**: More specific expectations should be declared last to take precedence.
- **Use sequences only when call order matters**: Overusing strict sequences can lead to fragile tests.
- **Use `.RetiresOnSaturation()` for chains of ordered calls to avoid saturation issues.**
- **Leverage `ON_CALL` to tame uninteresting calls rather than blanket `EXPECT_CALL(...).Times(AnyNumber())`**.
- **Use `Mock::VerifyAndClearExpectations()` to perform intermediate verification and prevent leaks**.
- **For mocking const or overloaded methods, disambiguate using `Const()` or explicit matchers**.
- **Use `SaveArg` or `Action` chaining for complex side-effect mocks**.

### Common Pitfalls

- Forgetting to specify `.WillByDefault()` in an `ON_CALL` (mandatory).
- Chaining multiple `.With()` or `.Times()` clauses (allowed only once).
- Misplaced `.With()` clauses (must be the *first* clause in `EXPECT_CALL` or `ON_CALL`).
- Exceeding number of `WillOnce()` clauses relative to cardinality.
- Calling mocks after their dependencies or pre-requisites mock objects have been destroyed can cause subtle failures.
- Misuse of matchers or arguments leading to unmatched expectations.

---

## 8. Example Patterns

### Enforcing Call Order with Sequences
```cpp
using ::testing::Sequence;

Sequence s;
EXPECT_CALL(mock, Initialize()).InSequence(s);
EXPECT_CALL(mock, Process()).InSequence(s);
EXPECT_CALL(mock, Cleanup()).InSequence(s);
```

### Multiple Actions in a Call
```cpp
EXPECT_CALL(mock, LoadFile(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

### Suppressing Warnings With NiceMock
```cpp
using ::testing::NiceMock;

NiceMock<MockFoo> mock;
EXPECT_CALL(mock, Foo()).Times(AtLeast(1));
// No warnings for uninteresting calls elsewhere.
```

---

## 9. Troubleshooting

### Unexpected Mock Call Failures
- Verify arguments match expectation.
- Check call order and sequences.
- Enable verbose logging with `--gmock_verbose=info` for detailed call traces.

### Uninteresting Call Warnings
- Consider switching to `NiceMock`.
- Use catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` if calls are expected but not verified.
- Suppress with `--gmock_verbose=error` if appropriate.

### Timing and Race Conditions
- Avoid setting expectations while other threads are calling mocks.
- Synchronize threads in tests when necessary.

### Mock Leaks
- Use `Mock::AllowLeak(&mock_obj)` if an object should not be verified or deleted.
- Use `Mock::VerifyAndClearExpectations()` to verify mocks before destruction.

---

## 10. Where to Go Next

- Explore [gMock Cookbook](../guides/real-world-use-cases/mocking-patterns) for detailed scenarios.
- Review [Matchers Reference](../api-reference/matchers-and-actions/matchers-reference) for crafting argument specifications.
- Learn [Actions and Macros](../api-reference/matchers-and-actions/actions-and-macros) for customizing call behaviors.
- Understand [Mock Strictness Wrappers](../api-reference/mocking-framework/mock-strictness-wrappers) for nuanced control over uninteresting calls.
- Visit [Mocking Reference](../docs/reference/mocking.md) for a complete technical API overview.

---

## Appendices

### Summary of Key Mocking Methods

| Macro / Method   | Purpose                                        |
|------------------|------------------------------------------------|
| `MOCK_METHOD`    | Define a mock method in a mock class           |
| `EXPECT_CALL`    | Set expectations with cardinalities and behavior|
| `ON_CALL`        | Set default behavior without expectations      |
| `NiceMock`       | Suppress warnings for uninteresting calls      |
| `NaggyMock`      | Default mode: warn on uninteresting calls      |
| `StrictMock`     | Fail on uninteresting calls                    |
| `Sequence`       | Define sequences for ordered expectations      |
| `InSequence`     | Helper to create implicit sequence in scope    |
| `.Times`         | Specify expected call count                      |
| `.WillOnce`      | Define action for one call                       |
| `.WillRepeatedly`| Define action for subsequent calls              |
| `.RetiresOnSaturation` | Retire expectation once saturated           |

### Common Terminology

- **Uninteresting call**: A call to a mock method without any expectation. These may warn or error depending on strictness.
- **Unexpected call**: A call to a mocked method that doesn't match any expectation. Always an error.
- **Expectation**: A declared expectation on a mock method call.
- **Cardinality**: The number of times an expectation is allowed or required to be met.
- **Sequence**: An ordering construct that enforces call order.
- **Retirement**: When an expectation is made inactive after being satisfied.

---

### Further Reading and Resources

- [gMock for Dummies](../guides/get-started/mocking-basics)
- [gMock Cheat Sheet](../docs/gmock_cheat_sheet.md)
- [Legacy gMock FAQ](../docs/gmock_faq.md)
- [Actions Reference](../api-reference/matchers-and-actions/actions-and-macros)
- [Matchers Reference](../api-reference/matchers-and-actions/matchers-reference)
- GoogleTest/gMock official repo and README: [googletest](https://github.com/google/googletest)

---