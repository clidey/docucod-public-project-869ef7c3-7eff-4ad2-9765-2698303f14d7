---
title: "Effective Assertions & Custom Matchers"
description: "Explore strategies for writing expressive, robust, and reusable assertions. Learn about built-in matcher libraries and how to create your own matchers for advanced scenarios."
---

# Effective Assertions & Custom Matchers

Explore strategies for writing expressive, robust, and reusable assertions with GoogleTest. This guide covers the built-in matcher libraries and teaches you how to create your own custom matchers for advanced and precise testing scenarios.

---

## 1. Understanding Assertions and Matchers

GoogleTest uses assertions to verify that code behaves as expected. Beyond simple assertions (`EXPECT_EQ`, `ASSERT_TRUE`, etc.), GoogleTest leverages _matchers_ to express complex expectations about values and arguments elegantly.

- **Assertions** check conditions like equality, truthfulness, string patterns, floating-point closeness, exceptions, and more.
- **Matchers** provide expressive predicates to match values against complex criteria.

**Example: Basic Assertion with Matcher**

```cpp
EXPECT_THAT(value, StartsWith("Hello"));
```

This asserts that `value` starts with the string "Hello" using the matcher `StartsWith`.

---

## 2. How to Use Built-in Matchers

GoogleTest ships with a rich set of built-in matchers that can be used standalone or inside assertions like `EXPECT_THAT`.

### Common Matcher Examples

- `_` – wildcard matcher, accepts any value
- `Eq(val)` – checks equality to `val`
- `Ne(val)` – checks inequality
- `Ge(val)` – greater than or equal
- `Le(val)`, `Gt(val)`, `Lt(val)` – relational matchers
- `StartsWith(str)`, `EndsWith(str)`, `HasSubstr(str)` – string matchers
- `Pointee(m)` – matches the object pointed to by a pointer using matcher `m`
- `ElementsAre(...)` – for container elements matching specific matchers

### Example: Using Matchers in Mock Expectations

```cpp
EXPECT_CALL(mock_turtle, Forward(Ge(100)))  // Expect Forward called with arg >= 100
    .Times(1);
EXPECT_CALL(mock_turtle, GoTo(50, _));     // First arg must be 50, second any value
```

### Tips for Using Matchers

- Use `_` when the exact value is not important.
- Combine matchers using `AllOf()`, `AnyOf()`, and `Not()` for complex logic.
- Use `SafeMatcherCast<T>(m)` to resolve subtle type mismatches.

---

## 3. Creating Custom Matchers

Built-in matchers cover most needs, but custom matchers allow you to encode domain-specific rules and invariants.

### Quick Start: Using `MATCHER` Macros

Simplest way to create a matcher:

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}

EXPECT_THAT(n, IsDivisibleBy7());
```

The description string can be customized to enhance failure messages.

### Parameterized Matchers

For matchers that take parameters, use `MATCHER_P` and friends:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}

EXPECT_THAT(x, HasAbsoluteValue(10));
```

The failure message will include parameter values automatically.

### Writing Matchers with Rich Explanations

You can add detailed explanations to failures by optionally streaming info to the `result_listener`:

```cpp
MATCHER(IsDivisibleBy7, "") {
  if ((arg % 7) == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

### Polymorphic Matchers

Create matchers that can be used with multiple types by defining templated `MatchAndExplain` methods. Use helper functions like `MakePolymorphicMatcher()` when implementing manually.

---

## 4. Matching Complex Types and Containers

### Matching With `Field()` and `Property()`

You can match specific fields or properties of objects instead of whole objects:

```cpp
EXPECT_THAT(person, Field(&Person::age, Ge(18)));  // age >= 18
EXPECT_THAT(person, Property(&Person::Name, StartsWith("John")));  // Name starts with John
```

### Matching Containers

Use:

- `ElementsAre(...)` – matches container elements in order.
- `UnorderedElementsAre(...)` – matches elements ignoring order.
- `ElementsAreArray(...)` – matches elements from a C-style or STL array.

Example:

```cpp
EXPECT_CALL(mock, Foo(ElementsAre(1, Gt(0), _, 5)));
```

Matches containers that have exactly 4 elements: 1, greater than 0, anything, and 5.

---

## 5. Using Matchers to Validate Complex Arguments

When exact argument verification is difficult or involves multiple criteria:

- Use `SaveArg<N>(&variable)` inside actions to capture argument values for post-call inspection.
- Combine multiple assertions on saved arguments to get precise failure reasons.

```cpp
EXPECT_CALL(mock, SendValues)
    .WillOnce(DoAll(SaveArg<1>(&actual_array), SaveArg<2>(&actual_proto)));
...
EXPECT_THAT(actual_array, ElementsAre(1, 4, 4, 7));
EXPECT_THAT(actual_proto, EqualsProto(expected_proto));
```

---

## 6. Best Practices and Common Pitfalls

- **Use `ON_CALL` to set default behaviors and `EXPECT_CALL` to verify interactions.** Overuse of `EXPECT_CALL` can produce brittle tests.
- **Order your expectations carefully.** Last expectation takes precedence matching calls.
- **Use sequences or `.InSequence()` only when testing call ordering is important.** Avoid over-constraining tests.
- **Prefer `NiceMock` in tests where uninteresting calls can be safely ignored to reduce noisy warnings.**
- **Be careful using `.RetiresOnSaturation()` to retire expectations once they are satisfied to avoid conflicts.
- **Ensure your custom matchers have no side effects** as gMock may call matchers multiple times.
- **For overloaded methods, disambiguate with `Const()` or explicit matcher casts.**

---

## 7. Sample Code Snippets

### Defining a Mock Class with Overloaded and Const Methods

```cpp
class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(int type) = 0;
  virtual std::string Describe(const char* name) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (int type), (override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
};
```

### Setting Default Behavior and Expectations

```cpp
using ::testing::Return;
using ::testing::_;

MockFoo mock_foo;

ON_CALL(mock_foo, GetSize())
    .WillByDefault(Return(42));

EXPECT_CALL(mock_foo, Describe(_))
    .Times(2)
    .WillRepeatedly(Return("Mock description"));
```

### Custom Matcher Example

```cpp
MATCHER_P(IsMultipleOf, divisor, "") {
  return (arg % divisor) == 0;
}

EXPECT_THAT(value, IsMultipleOf(5));
```

### Matching Container Elements

```cpp
EXPECT_CALL(mock_foo, ProcessValues(ElementsAre(1, 2, 3)));
```

---

## 8. Troubleshooting Common Issues

### Unexpected Call Failures

- Check if all required expectations are set before exercising the mocks.
- Verify that matchers and argument lists are not overly restrictive.
- Run tests with `--gmock_verbose=info` to get detailed trace of mock calls.

### Uninteresting Call Warnings

- Use `NiceMock` to suppress warnings.
- Add catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` to express allowable calls explicitly.

### Overloaded Method Ambiguities

- Use `Const(mock_obj)` wrapper to disambiguate const overloaded methods.
- Use `SafeMatcherCast<T>` for matchers when type mismatches occur.

### Move-only Arguments

- Use lambdas or `WillOnce` with `Return(std::move(obj))` carefully.
- Refer to the gMock Cookbook on mocking move-only types.

---

## 9. Next Steps & Related Content

- Explore the [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) for a complete list of built-in matchers.
- Learn how to write [custom matchers](https://google.github.io/googletest/gmock_cook_book.html#WritingNewMatchersQuickly).
- Combine assertions with advanced [actions](https://google.github.io/googletest/reference/actions.html) from the Actions Reference.
- Refer to the [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) to solidify basic mocking concepts and workflows.
- For troubleshooting, consult the [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html).

---

## References

- [Assertions Reference](https://google.github.io/googletest/reference/assertions.html)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)

---

Enhance your tests by mastering expressive assertions and flexible matchers. Start small by using built-in matchers, then progressively create custom ones that precisely capture your testing intent.
