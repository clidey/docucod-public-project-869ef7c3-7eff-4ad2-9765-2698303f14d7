---
title: "Integrating with Build Systems and CI"
description: "Stepwise instructions for adding GoogleTest and GoogleMock to your build system (CMake, Bazel) and running tests in continuous integration pipelines."
---

# Integrating with Build Systems and CI

GoogleTest and GoogleMock provide powerful C++ testing frameworks that integrate smoothly into your build system and continuous integration (CI) pipelines. This guide walks you through adding GoogleTest and GoogleMock to your build environment using popular systems like CMake and Bazel, and shows you how to run tests effectively in CI workflows.

---

## 1. Preparing Your Build Environment

### Prerequisites
- A supported C++17 compiler on your platform.
- Installed build tools: CMake (version 3.14 or higher) or Bazel.
- Access to the GoogleTest source code repository or installed package.

### Expected Outcome
You will have GoogleTest and GoogleMock integrated into your build system, able to compile your tests and run them either locally or in an automated CI environment.

### Time Estimate
This integration process typically takes 15-30 minutes depending on familiarity.

---

## 2. Integrating with CMake

GoogleTest includes CMake support that allows both standalone builds and embedding into existing projects.

### Step 1: Adding GoogleTest as a Subdirectory

For the most robust integration, add GoogleTest and GoogleMock source code as part of your project:

1. Clone GoogleTest repository or add it as a git submodule:

```bash
git clone https://github.com/google/googletest.git
# or inside your repo
# git submodule add https://github.com/google/googletest.git third_party/googletest
```

2. In your `CMakeLists.txt`, add:

```cmake
# This imports the GoogleTest and GoogleMock projects
add_subdirectory(googletest)

# Your test executable
add_executable(my_test test_main.cpp my_tests.cpp)

# Link against GoogleTest and GoogleMock
target_link_libraries(my_test gtest_main gmock)

# Register your test for CTest
add_test(NAME my_test COMMAND my_test)
```

### Step 2: Using FetchContent (optional)

Alternatively, you can fetch GoogleTest at configure time using CMake's `FetchContent`:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/v1.17.0.zip
)
# For MSVC: avoid runtime mismatch
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_test test_main.cpp)
target_link_libraries(my_test gtest_main gmock)
add_test(NAME my_test COMMAND my_test)
```

### Step 3: Setting C++ Standard

Ensure your project targets at least C++17:

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

### Step 4: Building and Running Tests

Build your tests via CMake:

```bash
mkdir build && cd build
cmake ..
cmake --build .
ctest
```

This will compile GoogleTest, GoogleMock, your code, and run the tests registered via `add_test`.

### Visual Studio Runtime Library Note

If you encounter runtime library mismatch errors (e.g., static vs dynamic CRT), enable:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

before fetching or adding GoogleTest.

---

## 3. Integrating with Bazel

GoogleTest also supports Bazel build system integration.

### Step 1: Include GoogleTest in WORKSPACE

Add GoogleTest rules to your `WORKSPACE` file:

```bazel
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.tar.gz"],
    strip_prefix = "googletest-release-1.17.0",
)

load("@com_google_googletest//:bazel/setup.bzl", "gtest_repositories")
gtest_repositories()
```

### Step 2: Writing BUILD Files

In your project directory, create a `BUILD` file referencing GoogleTest targets:

```bazel
cc_test(
    name = "my_test",
    srcs = ["my_tests.cpp"],
    deps = ["@com_google_googletest//:gmock_main"],
)
```

### Step 3: Build and Run Tests

Build and run your tests with Bazel:

```bash
bazel test //path/to:my_test
```

Bazel handles downloading and building dependencies automatically.

---

## 4. Running Tests in Continuous Integration Pipelines

GoogleTest is well suited for CI environments and provides several features to support automated testing:

### Step 1: Run Tests with Flags

Use GoogleTest flags to customize test runs:

- `--gtest_output=xml:<output_path>` to produce XML reports consumable by CI tools.
- `--gtest_filter=<pattern>` to limit which tests run.
- `--gtest_repeat=<count>` to rerun tests multiple times (useful for flaky tests).
- `--gtest_shuffle` to randomize test order.

Example command:

```bash
./my_test --gtest_output=xml:reports/test_results.xml --gtest_filter=* --gtest_shuffle
```

### Step 2: Collect Test Reports

Configure your CI system to collect and parse generated XML reports for accurate test results display and analytics.

### Step 3: Use Sharding to Parallelize Tests

GoogleTest supports sharding, distributing tests across multiple machines:

- Set environment variables:
  - `GTEST_TOTAL_SHARDS`: total number of shards
  - `GTEST_SHARD_INDEX`: index of this shard (0-based)

Test runner will run a subset of tests assigned to the shard index.

### Step 4: Automate Build and Test

Integrate build and test commands in your pipeline scripts (e.g., Jenkinsfile, GitHub Actions) including setup of caching to speed up builds.

---

## 5. Best Practices and Troubleshooting

### Best Practices
- Always call `testing::InitGoogleMock(&argc, argv);` or `testing::InitGoogleTest(&argc, argv);` before `RUN_ALL_TESTS()` in your `main()`.
- Use `gtest_main` or `gmock_main` libraries to avoid writing your own main unless custom setup is required.
- Keep your GoogleTest and GoogleMock versions aligned to avoid incompatibilities.
- Use continuous integration flags to generate XML or JSON reports for better tooling integration.

### Common Troubleshooting

<AccordionGroup title="Common Issues and Solutions">
<Accordion title="Linker Errors with GoogleTest or GoogleMock">
Ensure that your target links against both `gtest` and `gmock` or `gtest_main` and `gmock_main`. Example:

```cmake
target_link_libraries(my_test gtest_main gmock)
```

Also verify that the GoogleTest sources or libraries are correctly included in your build.
</Accordion>
<Accordion title="Runtime Mismatches on Windows">
If you get errors like mismatched runtime libraries (e.g., `MTd_StaticDebug` vs `MDd_DynamicDebug`), set the CMake flag:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

before loading GoogleTest.
</Accordion>
<Accordion title="Tests Not Being Discovered or Run">
Make sure you are correctly registering the tests (using `TEST()`/`TEST_F()` macros) and that `RUN_ALL_TESTS()` is called.

Confirm that your test binary is built and executed with proper parameters and environment variables.
</Accordion>
</AccordionGroup>

---

## 6. Example: Complete CMake Integration

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/v1.17.0.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test_main.cpp my_tests.cpp)
target_link_libraries(my_tests gtest_main gmock)
add_test(NAME my_tests COMMAND my_tests)
```

Run your tests:

```bash
mkdir build && cd build
cmake ..
cmake --build .
ctest
```

---

## 7. Additional Resources

- [GoogleTest Primer](https://google.github.io/googletest/primer.html) - Starter guide for writing tests
- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) - Intro to mocking
- [CMakeLists.txt in googletest repo](https://github.com/google/googletest/blob/main/CMakeLists.txt) - Build scripts
- [GoogleTest API Reference](https://google.github.io/googletest/reference/) - Detailed API
- [Integration & Optimization Guides](../guides/integration-tips/build-system-integration.md) - For advanced build and CI usage

---

By following this guide, you will have a resilient, scalable test setup using GoogleTest and GoogleMock integrated into your development workflow and CI pipelines, enabling you to maintain high-quality C++ code with confidence.
