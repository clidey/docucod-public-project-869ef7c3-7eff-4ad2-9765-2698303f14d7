---
title: "Custom Assertions and Matchers"
description: "Demonstrates how to extend GoogleTest and GoogleMock by defining your own assertions and matchers. Covers when to use custom matchers and how to ensure clear, actionable failure messages."
---

# Custom Assertions and Matchers

This guide demonstrates how to extend GoogleTest and GoogleMock by defining your own assertions and matchers. Custom matchers make your tests more expressive, readable, and maintainable, and they help generate clear, actionable failure messages tailored to your needs.

---

## Why Use Custom Matchers?

- **Expressiveness:** Write expectations that read like natural language, capturing complex conditions more clearly than simple assertions.
- **Reusability:** Encapsulate commonly used verification logic once and use it across many tests.
- **Better Debugging:** Provide detailed failure messages that explain not just failure, but why it occurred.

---

## Writing Custom Matchers

GoogleTest provides a macro-based approach and an interface-based approach for defining matchers.

### Using the `MATCHER` and `MATCHER_P` Macros

These macros are the quickest way to write matchers.

- `MATCHER(Name, Description) { ... }` defines a parameterless matcher.
- `MATCHER_P(Name, Param, Description) { ... }` defines a matcher with one parameter.

Inside the body, `arg` refers to the value being matched, and with `MATCHER_P`, the parameter is accessible by the given name.

#### Example: Parameterless Matcher
```cpp
MATCHER(IsEven, "") {
  // Returns true if arg is even.
  return (arg % 2) == 0;
}

// Usage
EXPECT_CALL(mock_obj, Foo(IsEven()));
EXPECT_THAT(value, IsEven());
```

If the description string is empty (`""`), GoogleTest generates a default description from the matcher name.

#### Example: Parameterized Matcher
```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return (arg % divisor) == 0;
}

// Usage
EXPECT_CALL(mock_obj, Bar(IsDivisibleBy(3)));
EXPECT_THAT(number, IsDivisibleBy(5));
```

You can customize failure messages further by streaming information to `*result_listener` inside the matcher.

### Writing More Complex Matchers via Interfaces

For complex needs requiring more control (e.g., multi-parameter matchers, improved diagnostics), implement the matcher interface manually:

```cpp
class DivisibleByMatcher {
 public:
  explicit DivisibleByMatcher(int divisor) : divisor_(divisor) {}

  template <typename T>
  bool MatchAndExplain(T n, ::testing::MatchResultListener* listener) const {
    bool result = (n % divisor_) == 0;
    if (!result && listener) {
      *listener << "which has remainder " << (n % divisor_);
    }
    return result;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by " << divisor_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by " << divisor_;
  }

 private:
  const int divisor_;
};

// Factory function for convenience.
inline ::testing::Matcher<int> DivisibleBy(int divisor) {
  return ::testing::MakePolymorphicMatcher(DivisibleByMatcher(divisor));
}

// Usage
EXPECT_THAT(value, DivisibleBy(3));
```

---

## Using Matchers with Mock Expectations

Matchers are primarily used in calls to `EXPECT_CALL` for mocks and in assertions via `EXPECT_THAT`.

### Basic Matcher Use

```cpp
EXPECT_CALL(mock_obj, Method(Ge(5)));
EXPECT_CALL(mock_obj, Process(StartsWith("prefix")));
EXPECT_THAT(container, Contains(Key(Eq("foo"))));
```

### Multi-Argument Matcher with `.With()` Clause

`.With()` can be combined with `EXPECT_CALL` to match the entire tuple of arguments as a single entity.

```cpp
EXPECT_CALL(mock, Method(_, _))
    .With(Lt());  // expects first argument less than second
```

Refer to [Multi-argument Matchers](reference/matchers.md#MultiArgMatchers) for details.

---

## Best Practices for Custom Matchers

- **Keep Matchers Pure:** They must have no side effects and return consistent results for the same input.
- **Provide Good Descriptions:** Implement `DescribeTo` and `DescribeNegationTo` to produce informative messages.
- **Leverage Result Listeners:** Use the `MatchAndExplain` method's listener argument to provide detailed failure explanations.
- **Parameterize When Helpful:** Use `MATCHER_P` and variants for parametrized matchers to keep your tests flexible.
- **Avoid Over-Specification:** Match only the relevant aspects to keep tests maintainable.

---

## Advanced Matcher Examples

### Matching a Member Field

Use the `Field` matcher to check a specific member of a complex object.

```cpp
EXPECT_THAT(obj, Field(&MyClass::value, Ge(10)));
```

### Matching Container Elements

Matchers like `ElementsAre`, `Contains`, and `UnorderedElementsAre` can match container contents.

```cpp
EXPECT_THAT(vec, ElementsAre(Eq(1), Gt(0), _));
EXPECT_THAT(set, Contains(Ge(5)));
```

### Composite Matchers

Combine matchers with `AllOf`, `AnyOf`, and `Not`:

```cpp
EXPECT_THAT(val, AllOf(Ge(0), Le(10)));
EXPECT_THAT(str, AnyOf(StartsWith("abc"), EndsWith("xyz")));
EXPECT_THAT(num, Not(Eq(0)));
```

---

## Common Pitfalls and Troubleshooting

- **Uninteresting Calls Warning:** When a mock method is called without an `EXPECT_CALL`, gMock prints a warning. Use `ON_CALL` with `WillByDefault` to specify default behavior or use `NiceMock` to suppress warnings.
- **Matcher Type Mismatches:** Use `SafeMatcherCast<T>(m)` to ensure type compatibility for matchers.
- **Overloaded Methods:** Specify matchers with exact signatures or wrap them using helper functions like `TypedEq` or `An<T>()`.
- **Matching Non-Copyable Arguments:** Use `std::ref` wrapped values or custom predicates with `Truly()`.

---

## References and Further Reading

- [Matchers Reference](docs/reference/matchers.md)
- [gMock Cookbook: Writing New Matchers](docs/gmock_cook_book.md#NewMatchers)
- [Assertions Reference](docs/reference/assertions.md#EXPECT_THAT)
- [GoogleMock Mocking Reference](docs/reference/mocking.md)
- [Multi-argument Matchers](docs/reference/matchers.md#MultiArgMatchers)

---

By mastering custom assertions and matchers, you empower your test suite with precise, expressive, and maintainable verifications that reflect your domain logic clearly and concisely.
