---
title: "Integrating GoogleTest with Your Build System"
description: "How-to guide for integrating GoogleTest and GoogleMock into various build environments, including CMake and Bazel. Provides actionable techniques for keeping tests maintainable and buildable at scale."
---

# Integrating GoogleTest with Your Build System

## Workflow Overview

**Task Description:**
This guide provides clear, practical instructions to integrate GoogleTest and GoogleMock into your build environments, focusing on CMake and Bazel integration. It equips you to maintain testability and build stability at scale.

**Prerequisites:**
- Familiarity with your project's build system (CMake or Bazel)
- Installed CMake 3.13 or later (for CMake integration)
- Access to GoogleTest and GoogleMock source code or installed libraries
- A C++17-capable compiler

**Expected Outcome:**
You will be able to set up GoogleTest and GoogleMock correctly within your build environment, compile and run tests smoothly, and manage linking and dependency issues effectively.

**Time Estimate:** 15–30 minutes

**Difficulty Level:** Intermediate

---

## Step-by-Step Instructions

### 1. Integrating GoogleTest and GoogleMock with CMake

#### a. Standalone Build of GoogleTest with GoogleMock

1. **Clone the repository and navigate:**

    ```bash
    git clone https://github.com/google/googletest.git -b main
    cd googletest
    mkdir build && cd build
    ```

2. **Generate build files and include GoogleMock:**

    - To build both GoogleTest and GoogleMock (default):
    ```bash
    cmake ..
    ```

    - To build only GoogleTest (exclude GoogleMock):
    ```bash
    cmake .. -DBUILD_GMOCK=OFF
    ```

3. **Build the libraries:**

    ```bash
    make
    ```

4. **Install the libraries system-wide (optional):**

    ```bash
    sudo make install
    ```

5. **Verify installation:** Headers and libraries will typically be installed under `/usr/local/include` and `/usr/local/lib`.

#### b. Incorporate GoogleTest/GoogleMock into Your Existing CMake Project

##### Option 1: Use Installed Libraries

- Use `find_package(GTest CONFIG REQUIRED)` in your `CMakeLists.txt`:

    ```cmake
    find_package(GTest CONFIG REQUIRED)

    add_executable(my_test test_file.cpp)
    target_link_libraries(my_test GTest::gtest GTest::gmock_main pthread)
    ```

- Ensure your `CMakeLists.txt` includes correct include paths and links with either `gmock` or `gmock_main` (the latter provides `main()` function).

##### Option 2: Add GoogleTest and GoogleMock as Subdirectories

- Download or clone GoogleTest source code at a known location.
- In your project's `CMakeLists.txt`, add:

    ```cmake
    add_subdirectory(path/to/googletest)

    add_executable(my_test test_file.cpp)
    target_link_libraries(my_test gtest gmock_main pthread)
    ```

- This approach ensures consistent compiler flags and eases dependency management.

##### Practical Tips for CMake Integration:
- Always specify C++17 standard explicitly:

    ```cmake
    set(CMAKE_CXX_STANDARD 17)
    set(CMAKE_CXX_STANDARD_REQUIRED ON)
    ```

- On Windows, when mixing runtimes, use:

    ```cmake
    set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
    ```
to avoid runtime library conflicts.

- Link with pthread on Unix-like systems if required (often handled by CMake).

---

### 2. Integrating with Bazel

1. **Set up your workspace:**

- Use a `MODULE.bazel` file or `WORKSPACE` to pull GoogleTest and GoogleMock as external dependencies.

2. **Declare dependencies in BUILD files:**

- Create test targets that depend on `@com_google_googletest//:gtest` and `@com_google_googletest//:gmock`.

3. **Example BUILD target:**

```python
cc_test(
    name = "my_test",
    srcs = ["my_test.cpp"],
    deps = ["@com_google_googletest//:gtest_main", "@com_google_googletest//:gmock"]
)
```

4. **Run tests:**

```bash
bazel test //path/to:my_test
```

5. **Troubleshooting:**

- Confirm external repositories are fetched correctly.
- Adjust compiler options for C++17 support.

---

### 3. Linking GoogleMock Libraries

- Use `gmock_main` when you want GoogleMock to provide an entry point (`main()`) for tests.
- Use `gmock` if you provide your own `main()` function.

Example for CMake:

```cmake
add_executable(my_test test.cpp)
target_link_libraries(my_test gmock_main pthread)
```

---

### 4. Controlling Threading and Runtime Flags

- Define `-DGTEST_HAS_PTHREAD=1` or `0` explicitly if GoogleTest does not detect pthread properly.
- For building GoogleTest as a shared library, use `-DGTEST_CREATE_SHARED_LIBRARY=1` and `-DGTEST_LINKED_AS_SHARED_LIBRARY=1` when compiling your tests.

---

### 5. Verifying Your Integration

- Write a simple test (or use provided examples).
- Build and run tests with `ctest` or your build tool.
- Confirm tests execute and report results correctly.

---

## Examples & Code Samples

### Minimal CMake Example to Use GoogleMock

```cmake
cmake_minimum_required(VERSION 3.13)
project(MyProject LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add GoogleTest subdirectory if source is available
add_subdirectory(googletest) # path to googletest

add_executable(my_test my_test.cpp)

# Link against gmock_main for main() provided by GoogleMock
target_link_libraries(my_test gmock_main pthread)
```

### Sample Bazel BUILD Rule

```python
cc_test(
    name = "simple_test",
    srcs = ["simple_test.cpp"],
    deps = ["@com_google_googletest//:gmock_main"],
)
```

---

## Troubleshooting & Tips

### Common Issues

- **Linker errors:**
  - Ensure that you link with `gmock_main` or `gmock` and `pthread` on Unix.
  - On Windows, check runtime library (static vs dynamic) mismatch; use `gtest_force_shared_crt` to fix.

- **C++17 Compatibility:**
  - Your compiler and build system must support C++17.
  - Explicitly set `CMAKE_CXX_STANDARD` to 17.

- **Missing `main()` symbol:**
  - Link against `gmock_main` if you do not provide your own `main()`.

- **GoogleMock not included:**
  - When configuring with CMake, the `BUILD_GMOCK` option controls whether gMock is built.

### Best Practices

- Keep GoogleTest and GoogleMock versions synchronized.
- Prefer incorporating GoogleTest as a subdirectory for consistent build options.
- Always verify the environment and threading macros when cross-compiling or targeting embedded platforms.

### Performance Considerations

- Incremental builds improve by setting GoogleTest/GoogleMock as external dependencies.
- For shared libraries, linking dynamically may speed up build and load times.

### Alternative Approaches

- Fetch GoogleTest dynamically during configure with CMake’s `FetchContent`.
- Use package managers or pre-built binaries if available for your platform.

---

## Next Steps & Related Content

- Explore [Project Configuration](../getting-started/configuration-and-first-use/project-configuration) to configure paths and linking options.
- Learn how to write and run your first test in [Writing Your First Test](../guides/getting-started/your-first-test).
- Understand mocking with GoogleMock via [Basic Mocking with GoogleMock](../getting-started/configuration-and-first-use/using-googlemock-basics).
- For advanced customization of build, see [Integrating GoogleTest with Your Build System](../guides/advanced-usage-and-integration/integrating-into-builds).
- Troubleshoot common problems with [Resolving Build & Integration Issues](../getting-started/common-issues-and-troubleshooting/build-issues).

---

## References

- [GoogleTest GitHub Repository](https://github.com/google/googletest)
- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [GoogleTest Primer](../docs/primer.md)
- [GoogleMock gmock.h Header](../../googlemock/include/gmock/gmock.h)

---