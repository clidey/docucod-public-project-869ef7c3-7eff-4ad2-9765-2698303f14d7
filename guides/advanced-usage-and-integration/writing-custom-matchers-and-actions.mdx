---
title: "Writing Custom Matchers and Actions"
description: "Extend GoogleMock with your own matchers and actions to express unique expectations and behaviors. Provides real-world examples, recommended design patterns, and integration tips."
---

# Writing Custom Matchers and Actions

Extend GoogleMock with your own matchers and actions to express unique expectations and behaviors. This guide will help you create custom matchers and actions tailored to your testing needs, with practical examples, design recommendations, and integration advice.

---

## Why Write Custom Matchers and Actions?

GoogleMock provides a wide variety of built-in matchers and actions, but your testing scenarios might require more specific checks or behaviors:

- To verify complex object invariants that built-in matchers canâ€™t express succinctly.
- To implement domain-specific logic in expectations.
- To encapsulate reusable matching or action logic for clarity and maintainability.

By writing your own matchers and actions, you gain expressive power and can keep your test code clean and straightforward.

---

## Custom Matchers

### Overview

A matcher defines how to check whether an argument passed to a mock method satisfies some condition. Custom matchers implement this logic alongside descriptive failure messages for better diagnostics.

### How to Write a Matcher

You can write custom matchers easily using the `MATCHER` macros or by implementing the matcher interface directly.

#### 1. Using `MATCHER` Macros

These macros offer a concise way to define matchers, suitable for most cases.

- `MATCHER(name, description) { ... }` defines a parameterless matcher.
- `MATCHER_P(name, param, description) { ... }` defines a matcher with one parameter.
- `MATCHER_P2(name, p1, p2, description)` supports two parameters, and so on.

Inside the matcher body, the variable `arg` represents the value to be matched.

**Example:**

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}

// Usage:
EXPECT_CALL(mock_obj, Foo(IsDivisibleBy7()));
```

To enhance failure messages, you can print to `result_listener`:

```cpp
MATCHER(IsDivisibleBy7, "") {
  if ((arg % 7) == 0) return true;

  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

#### 2. Implementing Matcher Interfaces

For advanced use or when you want full control, implement a matcher class with these methods:

- `bool MatchAndExplain(const T& value, std::ostream* listener) const`: returns match result and optionally writes explanation.
- `void DescribeTo(std::ostream* os) const`: describes what the matcher expects.
- `void DescribeNegationTo(std::ostream* os) const`: describes the negation.

A factory function wraps your class to produce a `testing::Matcher<T>`.

**Example:**

```cpp
class DivisibleBy7Matcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    int remainder = n % 7;
    if (remainder == 0) return true;
    if (os != nullptr) *os << "the remainder is " << remainder;
    return false;
  }

  void DescribeTo(std::ostream* os) const { *os << "is divisible by 7"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is not divisible by 7"; }
};

inline testing::Matcher<int> DivisibleBy7() {
  return testing::MakeMatcher(new DivisibleBy7Matcher());
}
```

### Parameterized Matchers

You can define parameterized matchers with one or more parameters using `MATCHER_P`, `MATCHER_P2`, ..., or implement them similarly with templated classes.

### Best Practices for Writing Matchers

- Keep matchers pure and side-effect free.
- Provide meaningful description and negation strings.
- Use `result_listener` to report helpful match failure details.
- Prefer macros like `MATCHER` for simple cases.
- For frequently used matchers, implement interfaces for better error messages and extensibility.

---

## Custom Actions

### Overview

An action defines what a mock method does when invoked, e.g., returning a value, modifying arguments, or invoking callbacks.

### Defining Actions

Actions can be defined succinctly using the `ACTION` macros or by implementing the `ActionInterface`.

#### 1. Using `ACTION` Macros

- `ACTION(name) { /* statements that return a value */ }`
- `ACTION_P(name, param) { /* use param in statements */ }`
- `ACTION_Pk(name, p1, ..., pk) { /* implementation */ }`

Inside the action body, you can refer to arguments like `arg0`, `arg1`, etc.

**Example:**

```cpp
ACTION(IncrementArg1) { return ++(*arg1); }

// Usage:
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg1());
```

#### 2. Implementing `ActionInterface`

For advanced cases, define a class template that implements

```cpp
template<typename F>
class ActionInterface {
 public:
  virtual ~ActionInterface();
  virtual Result Perform(const ArgumentTuple& args) = 0;
};
```

and use `MakeAction()` to integrate it.

### Using Callables as Actions

You can use ordinary functions, functors, methods, or lambdas as actions with `Invoke()` or by directly passing them in `WillOnce()` or `WillRepeatedly()`.

**Example:**

```cpp
EXPECT_CALL(mock, DoThis(_, _))
    .WillOnce(Invoke(&MyFunction));

EXPECT_CALL(mock, DoThis(_))
    .WillRepeatedly([](int x) { return x * 2; });
```

### Chaining and Combining Actions

- `DoAll(a1, a2, ..., an)`: executes all actions `a1` to `an` in order, returns result of last.
- `IgnoreResult(a)`: performs the action `a` ignoring its return value.
- `WithArg<N>(a)`: calls action `a` with the `N`-th mock function argument.
- `WithArgs<N1,N2,...>(a)`: calls action `a` with selected arguments.
- `WithoutArgs(a)`: calls `a` without any arguments.

### Tips for Actions

- Actions should match the signature expected by the mocked method.
- For move-only types, prefer lambdas or functors over built-in actions.
- If you need to perform side effects, use `SetArgPointee`, `SaveArg`, or define custom actions.

---

## Examples

### Custom Matcher: IsEven

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

// Usage
EXPECT_CALL(mock_obj, SomeMethod(IsEven()));
```

### Custom Action: Increment Argument

```cpp
ACTION(IncrementArg0) { return ++(*arg0); }

// Usage
EXPECT_CALL(mock_obj, Modify(_))
    .WillOnce(IncrementArg0());
```

### Delegating to a Real Object with Custom Actions

```cpp
class RealFoo {
 public:
  int Compute(int x) { return x * 3; }
};

class MockFoo : public Foo {
 public:
  MockFoo() {
    ON_CALL(*this, Compute).WillByDefault([this](int x) {
      return real_.Compute(x);
    });
  }
  MOCK_METHOD(int, Compute, (int x), (override));

 private:
  RealFoo real_;
};
```

---

## Troubleshooting

- **Matcher fails unexpectedly**: Use `--gmock_verbose=info` to trace matcher invocations.
- **Action returning incorrect values**: Ensure `Return()` and other action inputs are evaluated correctly, especially with move-only types.
- **Warnings about uninteresting calls**: Use `NiceMock` or explicit `EXPECT_CALL(...).Times(AnyNumber())` to suppress if appropriate.
- **Custom matcher not printing useful messages**: Use the `result_listener` in your matcher to add diagnostics.
- **Compilation issues with custom matchers/actions**: Check that your signatures match expected types and avoid over-complicated templates unless needed.

---

## Next Steps & Related Content

- Explore the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for detailed patterns.
- Review [Matchers Reference](reference/matchers.md) for built-in matchers.
- Check [Actions Reference](reference/actions.md) for built-in actions.
- Learn about mock classes and expectations in [Mocking Reference](reference/mocking.md).
- See [Test Doubles with GoogleMock](guides/core-testing-workflows/test-doubles-with-googlemock.mdx) for usage best practices.

---

For detailed macro and interface specifications, see:
- [MATCHER Macros in `gmock-matchers.h`](googlemock/include/gmock/gmock-matchers.h)
- [ACTION Macros in `gmock-actions.h`](docs/reference/actions.md)

Thank you for extending GoogleMock! Your custom matchers and actions make your tests powerful and expressive.
