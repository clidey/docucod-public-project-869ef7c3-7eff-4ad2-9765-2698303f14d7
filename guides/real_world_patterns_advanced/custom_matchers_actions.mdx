---
title: "Creating Custom Matchers and Actions"
description: "Move beyond built-in tools by designing custom matchers and actions for your specific test requirements. Step-by-step instructions, common use cases, and best practices for creating reusable, composable testing logic."
---

# Creating Custom Matchers and Actions

Extend GoogleMock beyond its built-in capabilities by crafting custom matchers and actions tailored to your test scenarios. This guide will walk you through creating reusable, composable testing logic that meets your specific requirements.

---

## Why Create Custom Matchers and Actions?

Standard matchers and actions cover many common use cases, but sometimes your test logic requires fine-grained or domain-specific verification and behavior that built-in tools don't support. Custom matchers and actions enable:

- Expressing complex validation logic clearly and meaningfully.
- Reusing sophisticated checks or behaviors across multiple tests.
- Composing smaller matchers/actions into more expressive ones.

By integrating custom components, tests become more readable, maintainable, and robust.

---

## Creating Custom Matchers

### Matcher Basics

A matcher is a predicate object that tests whether a value meets certain criteria and provides descriptive failure messages. GoogleMock allows you to create:

- **Simple matchers using macros**
- **Advanced matchers by implementing matcher interfaces**
- **Polymorphic matchers usable across types**

### Simple Matchers with Macros

Use the `MATCHER` and `MATCHER_P` macros to create concise matchers without boilerplate.

#### Example: Basic Matcher Using `MATCHER`

```cpp
MATCHER(IsDivisibleBy7, "") {  
  return (arg % 7) == 0;
}
```

Use as:

```cpp
EXPECT_CALL(mock, SomeMethod(IsDivisibleBy7()));
```

If the match fails, you'll get a descriptive message automatically generated from the matcher name.

#### Adding Custom Failure Messages

You can enhance the matcher to output additional information:

```cpp
MATCHER(IsDivisibleBy7, "") {
  if ((arg % 7) == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

Now, the failure message will include the remainder for easier diagnosis.

#### Parameterized Matcher with `MATCHER_P`

Create matchers with parameters:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") { 
  return abs(arg) == value;
}
```

Use it like:

```cpp
EXPECT_CALL(mock, SomeMethod(HasAbsoluteValue(10)));
```

### Advanced Matchers by Implementing the Matcher Interface

If your matcher needs enhanced control or better diagnostics, define a class:

```cpp
class DivisibleBy7Matcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    const int remainder = n % 7;
    if (remainder != 0 && os != nullptr) {
      *os << "the remainder is " << remainder;
    }
    return remainder == 0;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by 7";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by 7";
  }
};

::testing::Matcher<int> DivisibleBy7() {
  return DivisibleBy7Matcher();
}
```

Integrate by calling `DivisibleBy7()` as a matcher.

### Polymorphic Matchers

For matchers that work across multiple argument types, template the `MatchAndExplain` method:

```cpp
class NotNullMatcher {
 public:
  using is_gtest_matcher = void;

  template <typename T>
  bool MatchAndExplain(T* p, std::ostream*) const {
    return p != nullptr;
  }

  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

NotNullMatcher NotNull() { return NotNullMatcher(); }
```

Use as `EXPECT_CALL(mock, Func(NotNull()));`

### Composite Matchers

Create matchers that take other matchers as parameters for advanced behavior.

Example: A matcher that checks if distance from a target meets a condition.

Refer to GoogleMock’s internal `DistanceFrom` for an example.

---

## Creating Custom Actions

Actions specify what a mock method does when invoked. You can create custom actions to:

- Perform complex side effects.
- Return computed values.
- Combine multiple behaviors.

### Simple Custom Actions with Macros

Use `ACTION` and `ACTION_P` macros in namespace scope.

#### Example: An increment action

```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}
```

Use as `.WillOnce(IncrementArg1());`

#### Parameterized Action

```cpp
ACTION_P(Add, n) { return arg0 + n; }
```

Use as `.WillOnce(Add(5));`

### Using Functions, Lambdas, or Functors as Actions

GoogleMock supports passing any callable type compatible with the mocked function's signature:

```cpp
EXPECT_CALL(mock, Func(_)).WillOnce([](int x) { return x * 7; });
```

This is often simpler than a macro for complex logic.

### Combining Multiple Actions

Use `DoAll(a1, a2, ..., an)` to execute actions sequentially during one method call. Only the last action’s return value is used.

```cpp
EXPECT_CALL(mock, Func(_)).WillOnce(
    DoAll(SetArgPointee<1>(5), Return(true)));
```

### Performing Side Effects on Arguments

Use built-in actions like `SetArgPointee<N>(value)` or `SetArrayArgument<N>(first, last)` to modify out-parameters or arrays.

Example to set the `int*` argument #1 to 5:

```cpp
EXPECT_CALL(mock, Func(_, _))
    .WillOnce(SetArgPointee<1>(5));
```

### Advanced Custom Actions

If you need complex state or behavior, implement `testing::ActionInterface<F>` where `F` is the function signature, and create an `Action<F>` from it.

Example skeleton:

```cpp
template <typename F>
class CustomAction : public testing::ActionInterface<F> {
 public:
  using Result = typename testing::internal::Function<F>::Result;
  using ArgumentTuple = typename testing::internal::Function<F>::ArgumentTuple;

  Result Perform(const ArgumentTuple& args) override {
    // Your logic
  }
};

// Factory function
template <typename F>
testing::Action<F> MakeCustomAction() {
  return testing::MakeAction(new CustomAction<F>());
}
```

### Using `Invoke` to Call A Function or Method

You can use `Invoke` to delegate mock calls to an existing function, functor, or method:

```cpp
EXPECT_CALL(mock, Func(_)).WillOnce(Invoke(&RealFunction));
```

Or invoke it without arguments:

```cpp
EXPECT_CALL(mock, Func(_)).WillOnce(InvokeWithoutArgs(&obj, &Class::Method));
```

### Ignoring Return Values

If your action returns a value but the mocked method returns `void`, use `IgnoreResult(action)` to discard the value:

```cpp
EXPECT_CALL(mock, Func(_))
    .WillOnce(IgnoreResult(Return(5)));
```

### Invoking a Callable Parameter

If your mock method has a callback/functor parameter, use `InvokeArgument<N>(args...)` to invoke the N-th argument passing specified arguments.

Example:

```cpp
EXPECT_CALL(mock, DoAsync(_, _))
    .WillOnce(InvokeArgument<1>(5));
```

### Selecting Subsets of Arguments for Actions

Sometimes you want to pass only certain arguments to an action. Use `WithArg<N>(action)` or `WithArgs<N1, N2, ...>(action)` as adapters.

Example:

```cpp
EXPECT_CALL(mock, Func(_, _, _))
    .WillOnce(WithArgs<0, 2>(Invoke(CustomFunction)));
```

### Creating Polymorphic Actions

For reusability across different mock function types, define an implementation class with a template `Perform` method, then create the polymorphic action using `MakePolymorphicAction()`.

```cpp
class ReturnSecondArgAction {
 public:
  template <typename Result, typename Args>
  Result Perform(const Args& args) const {
    return std::get<1>(args);
  }
};

auto ReturnSecondArg() {
  return testing::MakePolymorphicAction(ReturnSecondArgAction());
}
```

Use as `.WillOnce(ReturnSecondArg())`.

---

## Best Practices

- Define clear, readable matchers and actions that focus on test intent.
- Use parameterized versions for flexibility.
- Avoid over-specification by matching only necessary arguments.
- Document your custom matchers and actions well.
- Reuse commonly used matchers and actions by placing them in shared test utilities.

---

## Troubleshooting

- **Matcher never matches:** Ensure `MatchAndExplain` properly handles all expected inputs and does not always return false.
- **Action doesn’t execute:** Verify the callable is compatible with the mocked method's signature.
- **Unexpected call warnings:** Confirm expectations are set before exercising mocks.
- **Performance issues compiling custom macros:** Move complex mock class constructors/destructors into source files.

---

## Next Steps & Related Content

- Explore the [gMock Cookbook](gmock_cook_book.md) for detailed examples.
- Consult [Matchers Reference](reference/matchers.md) and [Actions Reference](reference/actions.md) for built-in components.
- Read [gMock for Dummies](gmock_for_dummies.md) to solidify foundational concepts.
- Leverage `NiceMock` and `StrictMock` for controlling warning behaviors in various scenarios.

---

Empower your tests with custom matchers and actions to precisely capture expected behaviors and interactions, enhancing test clarity and maintainability.