---
title: "Advanced Mocking Patterns"
description: "Delve into techniques such as using actions, matchers, and the different mock strictness modes (NiceMock, NaggyMock, StrictMock) to craft expressive, flexible, and maintainable mocks."
---

# Advanced Mocking Patterns

Delve into using actions, matchers, and controlling mock strictness modes—NiceMock, NaggyMock, StrictMock—to craft expressive, flexible, and maintainable mocks.

---

## Overview
This guide helps you master advanced mocking techniques in GoogleMock, enabling you to write tests with precise behavior control, robust argument matching, and clear expectations on mock usage. By following the instructions and tips here, you will gain the skill to:

- Customize mock method behaviors using _actions_
- Precisely control which function calls trigger expectations with _matchers_
- Manage mock object strictness via NiceMock, NaggyMock, and StrictMock to control warnings and errors on uninteresting calls

**Prerequisites:**
- Familiarity with basic GoogleMock usage (`MOCK_METHOD`, `EXPECT_CALL`, `ON_CALL`)
- Understanding of mock objects and setting basic expectations

**Expected Outcome:**
You will be able to build nuanced mock behaviors, express fine-grained expectations, and configure mock strictness modes to balance test fidelity and maintainability.

**Time Estimate:** 30-45 minutes

**Difficulty Level:** Intermediate to Advanced

---

## 1. Using Actions to Specify What Mock Methods Do

Mock methods are placeholders without real behavior. To define how a mocked method behaves when called, use _actions_.

### How to Specify Actions

Use `.WillOnce()` and `.WillRepeatedly()` clauses chained to `EXPECT_CALL()` to assign behaviors:

```cpp
EXPECT_CALL(mock_object, Method(args))
    .WillOnce(Return(value_1))
    .WillOnce(Return(value_2))
    .WillRepeatedly(Return(default_value));
```

- `.WillOnce()` specifies the action for each individual call, executed in order
- `.WillRepeatedly()` defines what happens after all `.WillOnce()` actions are used

**Example:** Return successive values for `GetX()` calls

```cpp
using ::testing::Return;

EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This means:
- First call returns 100
- Second call returns 150
- All subsequent calls return 200

### Available Built-In Actions
See the [Actions Reference](../actions.md) for complete options. Common ones include:
- `Return(value)`: returns a value
- `ReturnRef(variable)`: returns a reference
- `DoAll(action1, action2, ...)`: performs multiple actions in sequence
- `Invoke(function_or_lambda)`: calls a function or callable
- `SetArgPointee<N>(value)`: sets the N-th pointer argument to `value`

### Tips
- If you need an action to return changing values, use lambdas rather than `Return` with variables since the latter captures the value at expectation setup time.
- Chain multiple `WillOnce()` actions for different call sequences.

---

## 2. Using Matchers: Fine-Grained Argument Expectations

Matchers allow you to specify the arguments you expect for mock method calls, enabling verification of exactly how your code interacts with mocks.

### Basic Matchers
Use `_` wildcard to accept any argument value:

```cpp
EXPECT_CALL(mock, Method(_));
```

Use specific values or predicates to refine your expectations:

```cpp
using ::testing::Ge;
EXPECT_CALL(mock, Forward(Ge(100)));  // Forward called with argument >= 100
```

### Omitting Parameters for Non-Overloaded Methods
If a method is not overloaded, you can omit the parameter list in `EXPECT_CALL` to accept any arguments:

```cpp
EXPECT_CALL(mock, Forward);
```

### Multi-Argument Matchers with `.With()`
Allow matching all arguments as a tuple using `.With(Matcher<std::tuple<...>>)`:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // First argument less than second
```

Use helpers like `AllArgs()`, `Args<N1, N2>()` to target specific subsets.

### Combining and Custom Matchers
- Combine matchers using `AllOf()`, `AnyOf()`, and `Not()`.
- Define custom matchers with `MATCHER` macros or matcher classes.

**Example:** Match arguments by properties

```cpp
using ::testing::Field;
EXPECT_CALL(mock, DoSomething(Field(&Foo::value, 42)));
```

### Tips and Best Practices
- Specify only necessary argument constraints to avoid brittle tests.
- Matchers must be purely functional without side effects.

---

## 3. Controlling Call Frequency with Cardinalities

Specify how many times a method is expected to be called using `.Times()` with cardinality specifiers:

| Cardinality      | Meaning                                    |
|------------------|--------------------------------------------|
| `AnyNumber()`    | any number of calls allowed                 |
| `AtLeast(n)`    | expected at least `n` times                 |
| `AtMost(n)`     | expected at most `n` times                  |
| `Between(m, n)` | expected between `m` and `n` calls inclusive|
| `Exactly(n)` or `n` | expected exactly `n` times                  |

If `.Times()` is omitted, GoogleMock infers it from `.WillOnce()` and `.WillRepeatedly()`. 

### Explicitly banning calls

To disallow a call, set `.Times(0)`:

```cpp
EXPECT_CALL(mock, Method(_))
    .Times(0);
```

### Recommendations

- Specify cardinalities to capture intent precisely.
- Avoid over-specification that makes tests brittle.

---

## 4. Mock Strictness Modes: NiceMock, NaggyMock, and StrictMock

GoogleMock offers three strictness levels to control how uninteresting calls (calls with no `EXPECT_CALL`) are handled by the mock:

| Mode       | Behavior                                                                                      |
|------------|-----------------------------------------------------------------------------------------------|
| NiceMock   | Suppresses warnings about uninteresting calls; allows them silently                          |
| NaggyMock  | Prints warnings when uninteresting calls occur (default mode)                                |
| StrictMock | Treats uninteresting calls as test failures                                                 |

### How to Use Strictness Modifiers

Wrap your mock class with these templates:

```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockClass> nice_mock;   // Ignores uninteresting calls
NaggyMock<MockClass> naggy_mock; // Warns about uninteresting calls (default)
StrictMock<MockClass> strict_mock; // Errors on uninteresting calls
```

### Recommendations

- Use `NiceMock` by default for cleaner test output and maintainable tests.
- Use `NaggyMock` for debugging tests to find unexpected uninteresting calls.
- Use `StrictMock` sparingly when you want to enforce strict call constraints.

### Caveats

- These wrappers only affect mock methods defined directly in the mock class with `MOCK_METHOD`.
- They do not affect mock methods defined in base classes.
- Nesting these wrappers is not supported.

---

## 5. Best Practices & Common Pitfalls

- **Set expectations before exercising mocks** to avoid undefined behavior.
- **Balance specificity and flexibility:** don't over-specify argument matchers or call counts.
- Use `.RetiresOnSaturation()` on expectations to ensure they deactivate after reaching the expected call count.
- Avoid writing brittle tests that tie to implementation details such as call order unless required.
- Suppress uninteresting call warnings properly using `NiceMock` or catch-all `EXPECT_CALL` with `.Times(AnyNumber())`.
- Use `.With()` carefully; it must be the first clause in an expectation and used at most once.
- For overloaded methods, help disambiguate calls using wrapper functions like `Const()` or explicit matcher casting.

---

## 6. Troubleshooting Common Issues

### Expectation Failures
- Check if the arguments to the call match the specified matchers.
- Run tests with `--gmock_verbose=info` to see detailed mock call logs and trace matches.

### Uninteresting Call Warnings
- Use `NiceMock` to suppress warnings when these calls are intentional.
- Add catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` for methods you don't care about verifying.

### Actions Not Executing as Expected
- Remember that `.WillOnce(Return(n))` captures the value `n` during expectation setup — use lambdas for dynamic behavior.

### Multiple Expectations on the Same Method
- Remember, the last matching expectation declared is used (newer rules override older ones).
- Order `EXPECT_CALL`s such that more specific expectations come after general ones.

---

## 7. Next Steps & Related Content

- Review [Basic Mock Usage](guides/core-testing-workflows/mocking-basics.md) to solidify foundational skills.
- Explore [Matchers Reference](reference/matchers.md) to widen argument matching capabilities.
- Dive into [Actions Reference](reference/actions.md) to discover all action types.
- Learn about [Sequencing Calls](reference/mocking.md#EXPECT_CALL.InSequence) to manage call ordering.
- Consult [gMock Cookbook](docs/gmock_cook_book.md) for curated recipes combining these techniques.

---

## Additional Resources

- **GoogleMock for Dummies**: Introductory guide to get started with mocks.
- **Mocking Reference**: Detailed API reference for macros and classes.
- **gMock Cheat Sheet**: Quick syntax and command reference.

---

## Example - Combining Matchers, Actions, and Strictness

```cpp
using ::testing::_;  // wildcard matcher
using ::testing::AtLeast;
using ::testing::Return;
using ::testing::NiceMock;

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

// Use NiceMock to suppress warnings for uninteresting calls
NiceMock<MockTurtle> mock_turtle;

EXPECT_CALL(mock_turtle, PenDown())
    .Times(AtLeast(1));

ON_CALL(mock_turtle, GetX())
    .WillByDefault(Return(100));

// code under test invokes mock_turtle.PenDown() and mock_turtle.GetX()
```

This test ensures `PenDown()` is called at least once, `GetX()` returns 100 by default, and ignores other uninteresting calls without warnings.

---

End of guide.
