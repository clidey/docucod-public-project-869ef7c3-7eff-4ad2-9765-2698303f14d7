---
title: "Integrating with CMake and Bazel"
description: "Walks through setting up GoogleTest and GoogleMock with both CMake and Bazel, covering best practices for integration, dependency management, and automating test discovery and execution."
---

# Integrating with CMake and Bazel

This guide walks you through setting up GoogleTest and GoogleMock with both CMake and Bazel build systems. It covers essential best practices to help you correctly manage dependencies, automate test discovery, and execute tests smoothly in your C++ projects.

---

## Workflow Overview

### What This Guide Helps You Accomplish

This guide focuses exclusively on integrating GoogleTest and GoogleMock into your project using either CMake or Bazel. You'll learn how to configure your build files to

- Include GoogleTest and GoogleMock libraries properly
- Manage dependencies for both frameworks
- Set up automatic test discovery and execution
- Follow best practices to avoid common pitfalls

### Prerequisites

- Basic familiarity with CMake or Bazel build systems
- A C++ project initialized with either CMake or Bazel
- GoogleTest source code downloaded or accessible via package manager or repository

### Expected Outcome

After completing this guide, you will have a ready-to-build and run test environment that allows:

- Seamless integration of GoogleTest and GoogleMock with minimal manual build steps
- Automated inclusion of all test targets without individually listing each test
- Proper linking and inclusion of required headers and libraries

### Time Estimate

Setup time varies by familiarity but generally:
- 10-20 minutes for CMake integration
- 15-30 minutes for Bazel integration

### Difficulty Level

Intermediate â€“ knowledge of your build system (CMake or Bazel) is recommended.

---

## Integrating GoogleTest and GoogleMock with CMake

### Step 1: Add GoogleTest and GoogleMock as Dependencies

It's recommended to add GoogleTest and GoogleMock as submodules or external projects if not using a package manager. For example:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/release-1.12.1.tar.gz
)
# For backward compatibility where FetchContent_MakeAvailable is unavailable:
FetchContent_MakeAvailable(googletest)
```

### Step 2: Link Against `gtest`, `gtest_main`, `gmock`, and `gmock_main`

In your test executable's `target_link_libraries`, link to the appropriate libraries:

```cmake
target_link_libraries(my_test
  gtest
  gtest_main
  gmock
  gmock_main
  pthread  # if on POSIX
)
```

- `gtest` and `gtest_main` provide the GoogleTest framework and main() entrypoint.
- `gmock` and `gmock_main` provide GoogleMock plus a main() for mock-enabled tests.

### Step 3: Include the GoogleTest Headers

Make sure to add GoogleTest's include directories:

```cmake
target_include_directories(my_test PRIVATE ${gtest_SOURCE_DIR}/include)
```

If you are importing GoogleTest as an external project or subdirectory, this may be handled automatically.

### Step 4: Automate Test Discovery

Use `gtest_discover_tests()` (available in CMake 3.10+) to auto-discover and register tests:

```cmake
include(GoogleTest)
gtest_discover_tests(my_test)
```

This eliminates the need to manually add each test.

### Expected Results

- Your CMake project builds test binaries linked with GoogleTest and GoogleMock.
- Running `ctest` or executing the test binaries will list and run all defined tests.

### Common Pitfalls

- Forgetting to link `gmock_main` when using GoogleMock leads to undefined reference errors to `main()`.
- Missing `pthread` linkage on POSIX systems causes linker errors.
- Not including the GoogleTest directories results in unresolved headers.

---

## Integrating GoogleTest and GoogleMock with Bazel

### Step 1: Declare GoogleTest Workspace

Use Bazel Central Registry to pull in GoogleTest dependencies. In your `WORKSPACE` file:

```bzl
load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")

http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.12.1.tar.gz"],
    strip_prefix = "googletest-release-1.12.1",
)
```

### Step 2: Use GoogleTest Targets in Your `BUILD` Files

In your Bazel package's `BUILD` file, define your test targets linking against GoogleTest and GoogleMock:

```starlark
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = [
        "@com_google_googletest//:gtest",
        "@com_google_googletest//:gmock",
        "@com_google_googletest//:gmock_main",
    ],
)
```

- `gmock_main` provides the test `main()` for tests using GoogleMock.

### Step 3: Configure Your Environment

Make sure your test sources include the correct headers from `@com_google_googletest//:gtest` and `gmock`. Bazel manages the include paths.

### Step 4: Run and Discover Tests

Use Bazel to build and run tests:

```bash
bazel test //path/to:my_test
```

Bazel automatically discovers and runs tests labeled `cc_test`.

### Expected Results

- Your test builds successfully with all dependencies.
- `bazel test` automatically runs all your test targets with GoogleTest and GoogleMock integration.

### Common Pitfalls

- Forgetting to depend on `gmock_main` causes missing `main()` errors.
- Misconfigured workspace rules or wrong URLs can lead to download or version mismatches.

---

## Best Practices for Integration

- **Use `gmock_main` / `gtest_main` libraries** for tests to avoid writing your own `main()` function.
- **Automate test discovery** rather than manually listing tests.
- **Link all required libraries** (`gmock`, `gmock_main`, `gtest`, `gtest_main`) appropriately for your test types.
- **Use provided CMake modules or Bazel WORKSPACE rules** to keep dependencies consistent.
- **Enable multi-threaded build and test environment setups** if running tests in parallel.

---

## Troubleshooting Tips

| Problem                                         | Cause                                           | Solution                                   |
|------------------------------------------------|------------------------------------------------|--------------------------------------------|
| Linker errors: missing `main()`                 | Not linking to `gmock_main` or `gtest_main`    | Add `gmock_main` or `gtest_main` to linking libs |
| Include errors for `<gtest/gtest.h>` or `<gmock/gmock.h>` | Include paths missing or wrong                  | Ensure GoogleTest include directories are added correctly |
| Tests not discovered (CMake)                     | `gtest_discover_tests()` not called            | Add `gtest_discover_tests()` in CMakeLists.txt |
| Bazel build download or version mismatch errors | Incorrect or missing `http_archive` in WORKSPACE | Verify URLs and archive names, update if needed |

If you encounter other issues, consult the [Common Issues Guide](/getting-started/troubleshooting-validation/common-issues) and related GoogleTest and GoogleMock documentation.

---

## Next Steps & Related Content

- Write and run your first test with GoogleTest ([Get Started with Tests](../getting-started/configuration-first-run/write-first-test))
- Learn how to create mock classes with GoogleMock ([Mocking Basics](../guides/core-workflows/mocking-basics))
- Explore advanced assertions and matchers for more expressive tests ([Advanced Assertions and Matchers](../guides/core-workflows/advanced-assertions-matchers))
- Troubleshoot common integration and runtime issues ([Troubleshooting Common Issues](../getting-started/troubleshooting-validation/common-issues))

---

## References

- [GoogleTest Primer](../docs/primer.md)
- [GoogleMock for Dummies](../docs/gmock_for_dummies.md)
- [Mocking Cookbook](../docs/gmock_cook_book.md)
- [GoogleTest Architecture Overview](../overview/architecture-and-concepts/architecture-overview)
- [System Requirements](../getting-started/prerequisites-installation/system-requirements)


---

This guide is designed to fit within the GoogleTest documentation ecosystem, focusing specifically on build environment integration with CMake and Bazel to empower you in building reliable and maintainable test suites efficiently.

---