---
title: "Building and Running Tests in Real Projects"
description: "Comprehensive tutorial for setting up GoogleTest and GoogleMock in your build system (CMake, Bazel) and running tests on multiple platforms. Includes troubleshooting common integration issues."
---

# Building and Running Tests in Real Projects

## Overview

This tutorial guides you through integrating GoogleTest and GoogleMock into real-world C++ projects using popular build systems like CMake and Bazel. You will learn how to configure your builds for seamless test compilation and execution across multiple platforms. Additionally, we address common integration pitfalls with practical troubleshooting tips to ensure a smooth testing workflow.

---

## Prerequisites

Before proceeding, ensure you have the following in place:

- A C++17 capable compiler and development environment.
- GoogleTest and GoogleMock source code or installed packages.
- Basic familiarity with CMake or Bazel build systems.
- Your project’s source tree organized with accessible test source files.


## Expected Outcome

By following this guide, you will be able to:

- Incorporate GoogleTest and GoogleMock in your CMake or Bazel projects.
- Build and run your test suites efficiently on supported platforms (Linux, Windows, macOS).
- Recognize and resolve common build and linkage problems during integration.


## Estimated Time

Approximately 30-45 minutes, depending on familiarity with build systems and project complexity.

---

## Integrating GoogleTest and GoogleMock with CMake

GoogleTest provides a convenient official CMake build script making integration into your CMake project straightforward.

### Step 1: Add GoogleTest as a Subdirectory or Use Installed Package

#### Option A: Using Installed GoogleTest

If GoogleTest is installed on your system, use `find_package` to locate it:

```cmake
find_package(GTest CONFIG REQUIRED)
```

Then link your test targets with `GTest::gtest` and `GTest::gmock` or just `GTest::gtest` if you want to omit mocking.

#### Option B: Add GoogleTest as a Subdirectory

If you prefer to build GoogleTest as part of your project:

1. Download or submodule GoogleTest source inside your repository.
2. Add to your root `CMakeLists.txt`:

```cmake
add_subdirectory(path/to/googletest)
```

3. Link your test executable to `gtest_main` or `gtest` and `gmock` libraries.

### Step 2: Write Your Test Executable

Create a test source file, e.g., `test_example.cpp`, with your tests defined using GoogleTest.

### Step 3: Configure Your Test Target

Add the following target definition in your `CMakeLists.txt`:

```cmake
add_executable(my_tests test_example.cpp)
target_link_libraries(my_tests PRIVATE gtest_main gmock)
```

Alternatively, use `GTest::gtest_main` and `GTest::gmock` if using the `find_package` path.

### Step 4: Enable Testing and Add Test to CTest

Include:

```cmake
enable_testing()
add_test(NAME MyTests COMMAND my_tests)
```

This will let you run tests via `ctest` or your build tool.

### Step 5: Build and Run the Tests

Build your project:

```bash
mkdir build && cd build
cmake ..
make
```

Then run your tests:

```bash
ctest --verbose
./my_tests
```

### Step 6: Optional CMake Tweaks and Tips

- Use `-DBUILD_GMOCK=ON` or `OFF` as needed.
- On Windows, be mindful of runtime mismatches (`gtest_force_shared_crt` CMake option).
- Use `gtest_discover_tests()` for automatic test discovery (requires CMake 3.10+).

---

## Integrating GoogleTest and GoogleMock with Bazel

GoogleTest supports Bazel with native build files. The following steps will help you set up Bazel-based projects.

### Step 1: Declare GoogleTest as a Dependency

In your `WORKSPACE` file, add external repositories for GoogleTest and GoogleMock, if not yet added.

Example snippet:

```python
http_archive(
    name = "com_github_google_googletest",
    url = "https://github.com/google/googletest/archive/release-1.17.0.zip",
    strip_prefix = "googletest-release-1.17.0",
)
```

### Step 2: Define Test Targets

In your Bazel `BUILD` file, define your test binaries as follows:

```python
cc_test(
    name = "my_tests",
    srcs = ["test_example.cpp"],
    deps = ["@com_github_google_googletest//googletest:gtest_main",
            "@com_github_google_googletest//googlemock:gmock_main"],
)
```

### Step 3: Run Tests with Bazel

Execute:

```bash
bazel test //path/to:my_tests
```

### Step 4: Troubleshooting Bazel Builds

- Ensure Bazel version supports C++17.
- Properly configure dependency URLs and versions.
- Address platform-specific issues via `select()` or configuration flags.

---

## Running Tests Across Multiple Platforms

GoogleTest and GoogleMock support Linux, Windows, and macOS seamlessly.

### Platform Considerations

- **Linux/macOS:** Compatible out-of-the-box with GCC, Clang, and system build tools.
- **Windows:** Visual Studio support available; ensure runtime linkage (static vs dynamic) consistency.
- **Embedded Platforms (ESP, ESP32, NRF52):** Special main and loop handling via `testing::InitGoogleMock()` and `RUN_ALL_TESTS()`. Refer to platform-specific setup guides.

---

## Common Integration Issues and Troubleshooting

Integration in real projects can hit common snags. Here are troubleshooting tips for known issues:

### 1. Linker Errors (Undefined symbols or multiple definitions)

- Ensure GoogleTest and GoogleMock libraries are properly linked.
- Avoid multiple inclusions or static/dynamic runtime conflicts.
- Use consistent compiler flags, especially for runtime linkage on Windows.

### 2. Build Failures due to C++ Standard Mismatch

- Confirm your compiler supports C++17 and the build system specifies it.
- For CMake, use `set(CMAKE_CXX_STANDARD 17)` and `set(CMAKE_CXX_STANDARD_REQUIRED ON)`.

### 3. Tests Not Running or Not Being Discovered

- Verify `RUN_ALL_TESTS()` is called in your `main()`.
- For CMake, ensure tests are added to CTest using `add_test()`.
- Check if test executables are built and not excluded.

### 4. Runtime Failures or Crash on Test Execution

- Make sure test initialization via `testing::InitGoogleTest()` or `testing::InitGoogleMock()` occurs before `RUN_ALL_TESTS()`.
- For embedded or special platforms, follow platform-specific initialization.

### 5. GoogleMock and GoogleTest Version Compatibility

- Always use matching versions of GoogleTest and GoogleMock.
- Prefer building GoogleMock with GoogleTest together to avoid ABI issues.

### 6. Missing Headers or Include Paths

- Ensure your build system knows the location of GoogleTest and GoogleMock header files.
- For CMake, link the correct target or manually add include directories.

---

## Best Practices

- Use `gtest_main` or `gmock_main` libraries to avoid writing custom `main()` unless customization needed.
- For larger projects, integrate GoogleTest as a submodule or fetch content during CMake configuration to avoid version drift.
- Leverage `gtest_discover_tests()` in CMake for automatic test detection.
- Use `add_test()` or respective Bazel `cc_test` to register tests properly.
- Always check test outcomes by respecting exit codes of `RUN_ALL_TESTS()`.

---

## Example: Simple CMake Configuration Snippet

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/release-1.17.0.zip
)

# This prevents GoogleTest from overriding compiler/linker settings
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test_example.cpp)
# Link GoogleTest and GoogleMock libraries
target_link_libraries(my_tests PRIVATE gtest_main gmock)

enable_testing()
add_test(NAME MyTests COMMAND my_tests)
```

Run:

```bash
mkdir build && cd build
cmake ..
make
ctest --verbose
``` 

---

## Example: Simple Bazel BUILD File Snippet

```python
cc_test(
    name = "my_tests",
    srcs = ["test_example.cpp"],
    deps = [
        "@com_github_google_googletest//googletest:gtest_main",
        "@com_github_google_googletest//googlemock:gmock_main",
    ],
)
```

Run:

```bash
bazel test //path/to:my_tests
```

---

## Additional Resources and Next Steps

- [GoogleTest Primer](../getting-started/first-run-validation/create-first-test) — Start writing your first tests.
- [Build Configuration](../getting-started/setup-prerequisites-installation/build-configuration) — deeper dive into build system integration.
- [Troubleshooting Setup Issues](../getting-started/first-run-validation/troubleshooting-setup-issues) — for diagnosing build and link problems.
- [Core Testing Workflows](../guides/core-testing-workflows) — mastering test writing and validation.
- [Effective Mocking with GoogleMock](../guides/advanced-features-and-patterns/effective-mocking) — mock object integration and usage patterns.
- [Continuous Integration Setup](../guides/integration-and-optimization/continuous-integration-setup) — automate your test runs.

---

<Tip>
Building and running tests within existing projects requires careful configuration of your build system to provide the correct include paths and link targets. Always verify that `RUN_ALL_TESTS()` returns zero for all tests passing.
</Tip>

<Warning>
Make sure not to call `RUN_ALL_TESTS()` more than once in your test executable, as it conflicts with GoogleTest's advanced features and multi-threaded death tests.
</Warning>

<Note>
If using GoogleMock, prefer initializing your test run with `testing::InitGoogleMock()`, which initializes GoogleTest internally.
</Note>