---
title: "Setting Expectations and Actions"
description: "Demonstrates how to use EXPECT_CALL and ON_CALL macros to express expectations on mocks, specify cardinalities, and define return actions. Walks through examples for flexible and strict validations."
---

# Setting Expectations and Actions

This guide demonstrates how to use `EXPECT_CALL` and `ON_CALL` macros in GoogleTest's gMock framework to express expectations on mock methods, specify invocation cardinalities, and define actions to execute when those methods are called. It walks you through writing flexible and strict validations, enabling precise control over mock behavior.

---

## Workflow Overview

- **Task Description:** Learn to specify and control the behavior of mock methods using `EXPECT_CALL` for setting expectations and `ON_CALL` for default actions.
- **Prerequisites:** You must have a mock class defined with `MOCK_METHOD` macros for the methods you intend to mock. Basic familiarity with gMock mocking concepts is assumed.
- **Expected Outcome:** By completing this guide, you will be able to write tests that verify method calls on mocks with specific arguments, control how many times they are called, define their return values or actions, and handle call ordering.
- **Time Estimate:** 15-30 minutes.
- **Difficulty Level:** Intermediate

---

## 1. Understanding EXPECT_CALL and ON_CALL

### What They Are

- `EXPECT_CALL`: Sets an *expectation* that a particular method will be called on a mock object with specified arguments. You can control how many times the call occurs, the order, and what action is performed during the call. Failures occur if expectations are unmet.

- `ON_CALL`: Defines the *default behavior* of a mock method when it is called without a matching expectation. It *does not* set any expectation about the call occurring. It is useful for specifying common behaviors shared across tests to avoid over-specification.

### Key Differences

| Aspect                     | EXPECT_CALL                     | ON_CALL                        |
|----------------------------|--------------------------------|--------------------------------|
| Purpose                   | Set *expectations* (verify calls) | Set *default behavior* (no verification) |
| Requires Matching Arguments | Yes                            | Yes                            |
| Can Specify Call Count    | Yes (using `.Times()`)          | No                             |
| Failure on Unsatisfied Call | Yes                            | No                             |

---

## 2. Writing EXPECT_CALL Statements

You express expectations using the following pattern:

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)?
    .Times(cardinality)?
    .InSequence(sequences...)*
    .After(expectations...)*
    .WillOnce(action)*
    .WillRepeatedly(action)?
    .RetiresOnSaturation()?;
```

- Clauses marked with `?` are optional and can appear at most once.
- Clauses marked with `*` can appear zero or more times (with some restrictions).

### Important Clauses Explained

- `.With(matcher)`: Restricts calls to those whose whole argument tuple matches this matcher.
- `.Times(n)`: The expected number of calls (`Exactly(n)`). Can also take fuzzy cardinalities like `AnyNumber()`, `AtLeast(n)`, etc.
- `.InSequence(s)`: Specifies that calls are expected in the order defined by one or more sequences.
- `.After(expectation_or_set)`: Enforces partial ordering that this call occurs after another call(s).
- `.WillOnce(action)`: Defines action to perform for a single call.
- `.WillRepeatedly(action)`: Defines action for all subsequent calls after `WillOnce`s are exhausted.
- `.RetiresOnSaturation()`: Makes the expectation inactive once the call count is saturated.

### Example: Basic EXPECT_CALL with Return Values

```cpp
using ::testing::Return;

MockTurtle turtle;
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));

// Calls to turtle.GetX():
// 1st returns 100
// 2nd returns 150
// 3rd to 5th return 200
```

### Using Wildcard Matchers

If you only care about some arguments, use matcher `_` to accept anything.

```cpp
using ::testing::_;
EXPECT_CALL(turtle, GoTo(50, _)); // First arg must be 50, second anything
```

### Omitting Arguments

For non-overloaded methods, you may omit arguments to match any.

```cpp
EXPECT_CALL(turtle, PenDown); // expects any call to PenDown()
```

### Controlling Call Counts

```cpp
EXPECT_CALL(foo, Bar(_)).Times(0);  // Expect Bar() never called
EXPECT_CALL(foo, Bar(_)).Times(AnyNumber()); // Any number of times
EXPECT_CALL(foo, Bar(_)).Times(AtLeast(2)); // Call at least twice
```

---

## 3. Writing ON_CALL Statements

`ON_CALL` is used to provide default actions without verification.

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(matcher)?
    .WillByDefault(action);
```

- `.With()` clause is optional, `.WillByDefault()` clause is mandatory.
- Actions are like those used in `EXPECT_CALL` clauses.

### Example: Setting a Default Return Value

```cpp
using ::testing::Return;

ON_CALL(mock_turtle, GetX())
    .WillByDefault(Return(42));
```

This means if `EXPECT_CALL` doesn't explicitly override, calls to `GetX()` will return 42.

---

## 4. Ordering Calls

You can enforce the order of calls with sequences and partial orders.

### Using InSequence for Strict Order

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(mock, Foo());
  EXPECT_CALL(mock, Bar());
}
```
This requires `Foo()` is called before `Bar()`. Out-of-order calls fail the test.

### Using After() for Partial Ordering

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Validate()).After(e1);
```
Ensures `Validate()` is called only after `Init()`.

Sequences can be shared for more complex DAGs of expectations.

---

## 5. Defining Actions

When a mock method is called, you specify what it should do:

- `WillOnce(action)`: Perform action on one invocation.
- `WillRepeatedly(action)`: Perform action on all invocations after `WillOnce`s are used.

### Common Actions

- `Return(value)`: Return a value.
- `ReturnRef(variable)`: Return a reference to variable.
- `Invoke(function_or_lambda)`: Call a function or lambda.
- `DoAll(action1, action2, ...)`: Perform multiple actions in sequence.
- `SetArgPointee<N>(value)`: Set the N-th (0-based) argument's pointee to value.

### Example: Return Different Values Over Calls

```cpp
EXPECT_CALL(mock, GetCount())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));

// Calls return 1, then 2, then always 3.
```

### Example: Combining Side Effects

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

---

## 6. Multiple Expectations on Same Method

GoogleMock searches expectations in **reverse order** (newer overrides older) for matching calls. This enables setting general default expectations first, and then specific ones.

### Example: More Specific Matches Override

```cpp
EXPECT_CALL(turtle, Forward(_));               // General
EXPECT_CALL(turtle, Forward(10)).Times(2);     // Specific (must appear after general)
```

Calls to `Forward(10)` will match the specific expectation up to 2 times, then fall back to the general.

---

## 7. Retiring Expectations

By default, expectations remain active even after being saturated, causing failures on extra calls.

Use `.RetiresOnSaturation()` to deactivate an expectation after it reaches its upper limit.

Example:

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
```

The expectation matches only the first 2 calls. Further calls fall back to other expectations or fail.

---

## 8. Best Practices and Tips

- Prefer `ON_CALL` for defining default/mock behavior shared by many tests.
- Use `EXPECT_CALL` only when you want to verify that a call occurs.
- Avoid over-specifying arguments to keep tests resilient to implementation changes.
- For methods not interesting in a test, omit `EXPECT_CALL` or use `NiceMock` to suppress warnings.
- Use sequences or `.After()` to control call ordering only when necessary.
- Use `.RetiresOnSaturation()` to prevent unexpected failures due to repeated calls.
- For overloaded methods, help the compiler disambiguate by specifying argument types or using matchers explicitly.

---

## 9. Troubleshooting Common Issues

### Unexpected Call Failures

If your test fails reporting unexpected mock function calls, ensure:

- All expected calls are set up *before* exercising the code.
- Arguments of calls match the matchers in `EXPECT_CALL`s.
- Use `--gmock_verbose=info` flag to see detailed tracing of mock calls and expectations.

### Uninteresting Call Warnings

Warnings from calls without `EXPECT_CALL` can be suppressed by:

- Adding a catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());`
- Wrapping the mock with `NiceMock<>`.

Avoid suppressing these warnings by indiscriminately adding many `EXPECT_CALL`s.

### Retired Expectations Still Match

If you get failures about expectations still matching after saturation, consider adding `.RetiresOnSaturation()`.

### Overloaded Method Ambiguities

If the compiler reports ambiguous calls, specify argument matchers or use `Const()` for const overloads.

---

## 10. Advanced Usage Examples

### Sequence of Ordered Calls

```cpp
using ::testing::InSequence;

{
  InSequence s;
  EXPECT_CALL(mock, Initialize());
  EXPECT_CALL(mock, ProcessData(_));
  EXPECT_CALL(mock, Cleanup());
}
```

Calls must happen in `Initialize()`, then `ProcessData()`, then `Cleanup()` order.

### Multiple Actions on One Call

```cpp
EXPECT_CALL(mock, Update(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

Sets the output argument and returns a value in one call.

### Defining Default Actions for Specific Arguments

```cpp
ON_CALL(mock, Compute(_))
    .WillByDefault(Return(0));
ON_CALL(mock, Compute(42))
    .WillByDefault(Return(100));
```

`Compute(42)` returns 100; other calls return 0.

### Using EXPECT_CALL to Verify Call Counts

```cpp
EXPECT_CALL(mock, Close())
    .Times(1);
// Failure if Close() is called zero or more than once.
```

---

## 11. Related Documentation

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) – introduction to mock classes
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) – detailed reference for mocking macros and classes
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) – practical recipes for common mocking tasks
- [Writing Your First Test](https://google.github.io/googletest/guides/core-testing-workflows/writing-your-first-test.html) – getting started with basics of GoogleTest
- [Using Assertions Effectively](https://google.github.io/googletest/guides/core-testing-workflows/using-assertions-effectively.html) – write better test assertions
- [Mocking and Advanced Patterns](https://google.github.io/googletest/guides/mocking_and_advanced_patterns.html) – deeper techniques and patterns

---

## 12. Summary

Controlling mock behavior accurately with `EXPECT_CALL` and `ON_CALL` allows you to write expressive, maintainable, and robust tests. Use `EXPECT_CALL` to set explicit expectations and verification points, controlling call arguments, counts, and ordering. Use `ON_CALL` to define default fallback behavior without verification overhead, avoiding brittle tests. Mastering the order of calls, action chaining, and retention policies such as `RetiresOnSaturation` will ensure your tests correctly reflect desired interaction semantics.

<Tip>
Always set expectations **before** exercising the code under test to avoid undefined behavior.
</Tip>

<Tip>
Use the `--gmock_verbose=info` runtime flag to debug complex expectation matching and call resolution.
</Tip>

<Tip>
For overloaded methods, use argument matchers or the `Const()` wrapper to help the compiler resolve ambiguity.
</Tip>


---

# Code Examples

```cpp
// Define a mock class
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

// Set expectations
MockTurtle turtle;

// Expect PenDown to be called at least once
EXPECT_CALL(turtle, PenDown()).Times(::testing::AtLeast(1));

// Default behavior for GetX
ON_CALL(turtle, GetX()).WillByDefault(::testing::Return(0));

// Expect Forward to be called exactly twice with specific distances
EXPECT_CALL(turtle, Forward(100)).Times(2)
    .WillRepeatedly(::testing::Return());

// Use sequences for ordering
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}

// Call methods to satisfy expectations
turtle.PenDown();
turtle.Forward(100);
turtle.PenUp();
```

---

## References

- `Mock::VerifyAndClearExpectations()` for manual verification of mocks.
- `NiceMock` and `StrictMock` wrapper classes to control handling of uninteresting calls.

---