---
title: "Using Mocks to Isolate Dependencies"
description: "Introduce the principles and benefits of mocking. Learn how to define mock classes, specify expectations, and leverage GoogleMock's macros to test code in isolation, complete with practical C++ examples."
---

# Using Mocks to Isolate Dependencies

## Overview

Mocking is a powerful technique for isolating the code under test from its external dependencies. By substituting real objects with *mock objects*, you gain precise control over interactions, allowing you to verify how your code communicates with collaborators without invoking their actual implementations. This improves test reliability, speed, and clarity.

This guide introduces the principles and benefits of mocking with GoogleMock (gMock), demonstrates how to define mock classes, set expectations on mocks, and then test code that uses these mocks. Practical C++ examples illustrate core concepts and workflows.

---

## Why Use Mocks?

When writing unit tests, it's common for your code to depend on other components â€” databases, network servers, file systems, graphical APIs, or complex subsystems. Testing with the real collaborators can be slow, fragile, or even impossible in automation environments.

Mocks let you solve these problems by:

- **Removing real dependencies.** Substitute mocks to cut out costly or unavailable resources.
- **Making tests fast and reliable.** Tests no longer depend on external state, so they run quickly and deterministically.
- **Verifying interactions, not just results.** Confirm that your code calls the right methods, in the right order, with the right parameters.
- **Simulating edge cases and errors.** Easily induce failures or unusual responses from dependencies to test error handling.

By using mocks, you elevate your testing from verifying outcomes to validating collaboration contracts.

---

## Defining Mock Classes

Mocks in gMock are implemented as classes that inherit from the interface or base class of the real dependency. Using the `MOCK_METHOD` macro, you declare mock methods corresponding to the virtual methods you want to simulate.

### Steps to Create a Mock Class

1. **Derive a mock class from the interface or base class you want to mock.**
2. **In the public section, use `MOCK_METHOD` to mock each virtual method.**
3. **Specify the return type, method name, argument types, and any qualifiers such as `const` and `override`.**

### Example: Mocking a Turtle Interface

Suppose you have the following interface representing a drawing turtle:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual void GoTo(int x, int y) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};
```

You can define a mock class as follows:

```cpp
#include <gmock/gmock.h>  // Brings in gMock

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

**Tip:** Always ensure that the interface has a virtual destructor, so deletion via interfaces works correctly.

---

## Using Mocks in Tests

Once you've defined a mock class, writing tests with it follows a clear sequence:

1. **Import the necessary gMock symbols into your test file's namespace.**
2. **Create instances of your mock objects.**
3. **Set expectations with `EXPECT_CALL()`.** Specify how methods are expected to be called, how often, with what arguments, and what they should do.
4. **Invoke the code under test that uses the mocks.**
5. **Assert outcomes as necessary.**
6. **Let gMock automatically verify expectations when the mocks are destroyed.**

### A Simple Example

Using our `MockTurtle` from the previous section, let's write a test verifying that the `PenDown()` method is called when drawing:

```cpp
#include "path/to/mock_turtle.h"
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;        // Enables AtLeast() matcher

TEST(PainterTest, CallsPenDown) {
  MockTurtle turtle;               // Create a mock

  // Expect PenDown() to be called at least once
  EXPECT_CALL(turtle, PenDown())
      .Times(AtLeast(1));

  Painter painter(&turtle);       // The code under test uses the mock
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

If the method `PenDown()` is never called, the test fails with a clear error describing the unsatisfied expectation.

### Key Points about `EXPECT_CALL`

- Set expectations *before* the code that uses the mocks is exercised.
- You can specify:
  - **Argument matchers:** Define what argument values are expected (see Matchers section).
  - **Cardinalities:** How many times a call should happen (e.g., `Times(1)`, `AtLeast(n)`, `Times(0)` to forbid calls).
  - **Actions:** What the mock method should do when called (e.g., return values, invoke custom functions).
  - **Ordering constraints:** Enforce call sequences using `InSequence` or `After`.

---

## Setting Expectations

The heart of mocking lies in setting the *right* expectations.

### General `EXPECT_CALL` Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(argument_matchers...))
    .Times(cardinality)          // e.g., Times(1), Times(AnyNumber())
    .WillOnce(action)            // action for one call
    .WillRepeatedly(action)      // action for subsequent calls
    .InSequence(sequences...)    // constrain call order
    .After(expectations...)      // call should occur after others
    .RetiresOnSaturation();      // expectation retires when satisfied
```

Each clause modifies the expectation. For example:

- `Times(0)` - forbids the method call.
- `WillOnce(Return(value))` - specifies what to return on the next call.
- `InSequence` - organizes expectations in a strict order.

### Matchers: Specifying Expected Arguments

Matchers define precisely what argument values you expect.

- Use exact values or matchers like `_` (wildcard), `Eq(val)` (equals), `Ge(n)` (greater or equal), etc.

Examples:

```cpp
using ::testing::_;
using ::testing::Ge;
EXPECT_CALL(turtle, Forward(100));       // move forward 100 units
EXPECT_CALL(turtle, GoTo(50, _));         // go to x=50, y=anything
EXPECT_CALL(turtle, Turn(Ge(0)));         // turn with positive angle
EXPECT_CALL(turtle, GoTo);                 // any call to GoTo (non-overloaded)
```

### Cardinalities: How Often?

Control how many times calls are expected:

| Cardinality       | Meaning                                   |
| ----------------- | ----------------------------------------- |
| `Times(1)`        | Exactly once                              |
| `Times(0)`        | Never called (method is forbidden)        |
| `AtLeast(n)`      | At least *n* times                        |
| `AtMost(n)`       | At most *n* times                         |
| `Between(m, n)`   | Between *m* and *n* times                 |
| `AnyNumber()`     | Any number of calls (including zero)      |

If you omit `Times()`, gMock infers the cardinality from your `WillOnce` or `WillRepeatedly` clauses.

### Actions: What Should the Mock Do?

By default, mock functions return default-constructed values for their return type or do nothing if `void`.

You can specify custom actions:

- `Return(value)` - returns a specific value.
- `ReturnRef(variable)` - returns a reference.
- `Invoke(func)` - calls a real function or lambda.
- `DoAll()` - combine multiple actions.

Example:

```cpp
EXPECT_CALL(turtle, GetX())
    .Times(3)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

This means it returns 100, then 150, then 200 on all subsequent calls.

### Ordering Calls

To specify that mock calls must happen in order, use the `InSequence` class:

```cpp
{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

Calls must happen exactly in this order; otherwise, the test fails.

### Retiring Expectations

By default, expectations remain active even after the expected calls occur. This can cause errors if the method is called more times than expected.

To retire an expectation immediately after it's saturated, add `.RetiresOnSaturation()`:

```cpp
EXPECT_CALL(mock, Func(7))
  .Times(2)
  .RetiresOnSaturation();
```

The expectation becomes inactive after 2 calls, allowing other expectations to match subsequent calls.

---

## Practical Tips and Best Practices

- **Only mock interfaces or classes you own.** For external dependencies, create an adaptor interface if necessary.
- **Specify only those expectations critical to the test.** Avoid over-specification to prevent brittle tests.
- **Use `ON_CALL` to define default mock behaviors without adding strict call assertions.**
- **Use `NiceMock` to suppress warnings on uninteresting calls.**
- **Use `StrictMock` to treat uninteresting calls as errors, useful for very strict tests.**
- **Name your mocks and expectations clearly to aid debugging.**

---

## Common Pitfalls & Troubleshooting

<AccordionGroup title="Common Issues When Using Mocks">
<Accordion title="Unexpected method calls or mismatched expectations">
Your test fails because the code called a mock method with unexpected arguments or an unexpected number of times.

**Solution:** Check your `EXPECT_CALL` matchers and cardinalities. Use `--gmock_verbose=info` flag to trace mock calls.
</Accordion>

<Accordion title="Mock methods invoke the real method">
If a mock method accidentally calls the real implementation, ensure that the method you mock is `virtual`. Non-virtual methods cannot be mocked normally.
</Accordion>

<Accordion title="Warnings about uninteresting calls">
If you get warnings for calls to mock methods not covered by expectations:
- Use `EXPECT_CALL(...).Times(AnyNumber())` for catch-all expectations.
- Use `NiceMock` to suppress warnings.
- Use `StrictMock` to enforce strict behavior.
</Accordion>

<Accordion title="Leaks and no verification happens">
If your mock object is never deleted, checks for expectation satisfaction wonâ€™t run, possibly hiding errors.

**Solution:**
- Ensure mocks are destroyed properly.
- Call `Mock::VerifyAndClearExpectations(&mock)` explicitly if needed.
- Use heap checkers to detect leaks.
</Accordion>
</AccordionGroup>

---

## Example Walkthrough

The following example combines creating a mock, setting expectations, and testing behavior:

```cpp
#include "mock_turtle.h"
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::AtLeast;
using ::testing::Return;

class Painter {
 public:
  explicit Painter(Turtle* turtle) : turtle_(turtle) {}

  bool DrawCircle(int x, int y, int radius) {
    turtle_->GoTo(x, y);
    turtle_->PenDown();
    for (int i = 0; i < 360; ++i) {
      turtle_->Forward(radius);
      turtle_->Turn(1);
    }
    turtle_->PenUp();
    return true;
  }

 private:
  Turtle* turtle_;
};

TEST(PainterTest, DrawCircleCallsCorrectMethods) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, GoTo(_, _));       // Don't care about parameters
  EXPECT_CALL(turtle, PenDown())
      .Times(1);
  EXPECT_CALL(turtle, Forward(_))
      .Times(360);
  EXPECT_CALL(turtle, Turn(1))
      .Times(360);
  EXPECT_CALL(turtle, PenUp())
      .Times(1);

  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

This test confirms the `Painter` interacts with the `Turtle` mock exactly as expected.

---

## Next Steps & Related Content

- Explore the **[gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)** for an approachable introduction.
- Dive into **[Mocking Reference](reference/mocking.md)** for detailed API documentation.
- Learn advanced mocking patterns in **[gMock Cookbook](docs/gmock_cook_book.md)**.
- Understand matchers and actions to tailor mock behavior using **[Matchers](reference/matchers.md)** and **[Actions](reference/actions.md)**.
- Review **[Mock Strictness Modes](reference/mocking.md#NiceStrictNaggy)** (`NiceMock`, `StrictMock`) to control warning and error behavior on unexpected calls.

Make sure to combine this knowledge with your understanding of **writing tests** in GoogleTest and **organizing them** efficiently.

---