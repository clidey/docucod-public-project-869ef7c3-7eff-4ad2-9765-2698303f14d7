---
title: "Best Practices and Common Pitfalls"
description: "A curated set of recommendations for writing effective, clear, and maintainable tests with GoogleTest and GoogleMock. This guide lists common mistakes, anti-patterns, and practical solutions to recurring issues, ensuring test quality and code longevity."
---

# Best Practices and Common Pitfalls

A curated set of recommendations for writing effective, clear, and maintainable tests with GoogleTest and GoogleMock. This guide highlights common mistakes and anti-patterns along with practical strategies to avoid them, ensuring your tests stay robust and your codebase remains easy to evolve.

---

## 1. Designing Effective Tests

### 1.1 Write Independent and Small Tests

Tests should be independent of each other and small in scope to isolate failures clearly and speed up debugging.

- **Best Practice:** Each test must set up its own context and should not rely on side effects or shared state from other tests.
- **Common Pitfall:** Tests depending on global variables or shared mutable state often fail nondeterministically.

### 1.2 Prefer Test Fixtures for Shared Setup

If multiple tests require similar setup or teardown, use test fixtures to encapsulate shared code.

```cpp
class DatabaseTest : public ::testing::Test {
 protected:
  void SetUp() override {
    db_.Connect();
  }

  void TearDown() override {
    db_.Disconnect();
  }

  Database db_;
};

TEST_F(DatabaseTest, CanInsertRecord) {
  EXPECT_TRUE(db_.Insert(record));
}
```

- **Pro Tip:** Avoid using constructors for test setup if you rely on assertions, as constructor failures don’t abort tests cleanly. Use `SetUp()` instead.

### 1.3 Use Descriptive Test and Test Suite Names

Name test suites and tests to clearly describe the functionality under test and the specific condition.

- Avoid underscores (`_`) in test and suite names due to macro expansion issues.
- Use descriptive names to enhance readability and easier filtering.

---

## 2. Writing Assertions

### 2.1 Understand ASSERT_* vs EXPECT_*

- `ASSERT_*` macros generate **fatal failures** and abort the current test function immediately.
- `EXPECT_*` macros generate **nonfatal failures** and allow the test to continue.

**When to use:**
- Use `ASSERT_*` if the test cannot meaningfully continue without the assertion passing (e.g., pointer must not be null before dereferencing).
- Use `EXPECT_*` when you want to see multiple failures within a single test execution.

### 2.2 Use Rich Assertions for Clear Failures

GoogleTest offers a rich set of assertions for various checks — boolean, equality, string comparison, floating-point comparison, exception, death tests, and predicate-format assertions.

- Use `EXPECT_EQ` / `ASSERT_EQ` for comparing values.
- Use `EXPECT_STREQ` / `ASSERT_STREQ` for C strings.
- Use `EXPECT_THROW` / `ASSERT_THROW` for exception testing.

```cpp
EXPECT_EQ(result.size(), expected_size) << "Size mismatch";
EXPECT_THROW(Foo(), std::runtime_error);
```

### 2.3 Avoid Assertions in Constructors or Destructors

Due to C++ language limitations, fatal assertions cannot properly abort a test if placed in constructors or destructors.

- Instead, place test initialization in `SetUp()` and cleanup in `TearDown()` methods.

### 2.4 Use SCOPED_TRACE to Aid Debugging in Repetitive Calls

When assertions are inside helper functions called multiple times, use `SCOPED_TRACE` to add contextual failure messages.

```cpp
void Helper(int index) {
  SCOPED_TRACE("Index: " + std::to_string(index));
  EXPECT_TRUE(DoSomething(index));
}
```

This way, failure messages indicate which iteration or call triggered the failure.

---

## 3. Handling Test Failures and Control Flow

### 3.1 Fatal Failures Abort Only the Current Function

Unlike exceptions, `ASSERT_*` macros abort only the function where they are called.

- **Pitfall:** Calling `ASSERT_*` inside subroutines will not abort the caller test function, which may lead to crashes after the subroutine returns.

**Solutions:**
- Use `ASSERT_NO_FATAL_FAILURE(subroutine_call());` to fail if subroutine generated fatal failures.
- Check `if (testing::Test::HasFatalFailure()) return;` after subroutine calls.
- Install an event listener that throws exceptions on fatal failures when you want exception-like behavior.

### 3.2 Skip Tests at Runtime with `GTEST_SKIP()`

To conditionally skip tests (e.g., due to missing runtime preconditions), use `GTEST_SKIP()` in tests or fixtures:

```cpp
TEST(MyTest, OnUnsupportedPlatform) {
  if (!PlatformSupported()) {
    GTEST_SKIP() << "Feature not supported on this platform";
  }
  // Test logic...
}
```

---

## 4. Organizing Tests for Scalability

### 4.1 Group Related Tests Using Test Suites and Fixtures

Logical grouping improves discoverability and maintenance.

- Use the same test suite name for tests exercising the same component or feature.
- Reuse test fixtures with shared setup/teardown to increase test clarity.

### 4.2 Use Parameterized Tests for Repetitive Scenarios

When testing the same logic over different inputs or configurations, use parameterized tests (`TEST_P` and `INSTANTIATE_TEST_SUITE_P`).

```cpp
class FooTest : public testing::TestWithParam<int> {};

TEST_P(FooTest, HandlesValue) {
  int val = GetParam();
  EXPECT_TRUE(Process(val));
}

INSTANTIATE_TEST_SUITE_P(
  Values,
  FooTest,
  testing::Values(1, 2, 3, 4));
```

- Provide custom names for test parameters to make test reports more readable.

### 4.3 Use Typed Tests for Testing Multiple Implementations

When testing multiple types or implementations, use typed tests (`TYPED_TEST_SUITE` and `TYPED_TEST`). This avoids code duplication and ensures consistent coverage.

---

## 5. Writing and Using Mocks with GoogleMock

### 5.1 Define Mock Classes Using `MOCK_METHOD`

Define mock methods in the `public` section, matching signatures of real interfaces.

```cpp
class MockFoo : public FooInterface {
 public:
  MOCK_METHOD(void, DoSomething, (int x), (override));
};
```

### 5.2 Set Expectations Using `EXPECT_CALL`

Attach expectations *before* exercising the code under test.

```cpp
MockFoo mock;
EXPECT_CALL(mock, DoSomething(5))
    .Times(1)
    .WillOnce(Return());
```

- Chain modifiers `.Times()`, `.WillOnce()`, `.InSequence()`, etc. for flexible behaviors.
- Avoid setting expectations after the code has run.

### 5.3 Choose Appropriate Mock Strictness

- Use `NiceMock` to suppress warnings on unexpected calls when flexibility is desired.
- Use `StrictMock` to ensure no unplanned calls occur.

---

## 6. Troubleshooting Common Issues

### 6.1 Fixing Test Fails Due to Missing Default Constructors

GoogleTest requires fixture classes to be **default constructible**. If your fixture has non-default constructors or `const` members, define an explicit default constructor.

### 6.2 Handling Death Test Hangs or Crashes

Death tests run code in a child process; interactions with threads or external dependencies may cause hangs.

- Reduce pre-death-test thread creation.
- Use `GTEST_FLAG_SET(death_test_style, "threadsafe")` to increase reliability.
- Move all death test setup inside the death test statement.

### 6.3 Problems with Assertions Using User-Defined Types

GoogleTest attempts to print failure values. Define:

- An `operator<<` for `std::ostream`, **in the same namespace**, or
- `PrintTo()` or `AbslStringify()` overloads for better output.

---

## 7. Practical Tips and Guidelines

- **Disable broken tests temporarily with `DISABLED_` prefix** to keep the build green while fixing issues.
- **Use `EXPECT_THAT` with rich matchers** for expressive assertions replacing `EXPECT_EQ` in complex cases.
- **Return `RUN_ALL_TESTS()` from `main()`**; ignoring its return value causes false positives.
- **Set up test sharding and repetition** via flags (`GTEST_TOTAL_SHARDS`, `GTEST_REPEAT`) for CI scalability.

---

## 8. Further Resources

- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) for fundamentals.
- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) for mock basics.
- [Assertions Reference](https://github.com/google/googletest/blob/main/docs/reference/assertions.md) for comprehensive assertion macros.
- [Mocks Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) for detailed mock usage.

---

## Summary

Adhering to these best practices will empower you to write tests that are maintainable, reliable, and insightful. Avoid common pitfalls like interdependent tests, misuse of assertions, and unclear naming conventions. Leverage GoogleTest’s powerful features—fixtures, parameterized and typed tests, mocking capabilities, and comprehensive assertions—to build a robust test suite that scales with your project’s complexity.

---

### Callouts

<Tip>
Use `SCOPED_TRACE` to improve failure messages when reusing test helper functions.
</Tip>

<Warning>
Avoid `ASSERT_*` inside constructors or destructors.
</Warning>

<Note>
Remember to give test suites and tests names without underscores to prevent macro conflicts.
</Note>