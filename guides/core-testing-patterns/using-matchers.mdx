---
title: "Using Matchers for Powerful Validations"
description: "Deep dive into using matchers for expressive test validations, both built-in and custom. Explore practical matcher patterns for common C++ testing scenarios, including containers and floating-point comparisons."
---

# Using Matchers for Powerful Validations

## Workflow Overview

**Task Description:**
Learn how to use gMock's matchers to create precise and expressive validations in your tests. This guide dives into both built-in matchers and how to create custom matchers for advanced C++ testing scenarios, including container contents and floating-point comparisons.

**Prerequisites:**
- Basic familiarity with GoogleMock and mocking concepts
- Understanding of `EXPECT_CALL` and how to write mock classes
- A working GoogleMock setup in your C++ project

**Expected Outcome:**
By following this guide, you will be able to write effective matcher expressions to validate mock method call arguments with clear intent and robust checks. You will understand matcher composition, using predicates, handling pointers, containers, and floating-point comparisons.

**Time Estimate:** 20-40 minutes

**Difficulty Level:** Intermediate

---

## Step-by-Step Instructions

### 1. Use Simple Matchers for Flexible Argument Checks

Matchers allow you to specify criteria for expected arguments without exact values. For instance:

```cpp
using ::testing::Ge;
using ::testing::_;

EXPECT_CALL(foo, DoThis(Ge(5))).WillOnce(Return('a'));
EXPECT_CALL(foo, DoThat(_, NotNull()));
```

- `Ge(5)` matches any argument >= 5
- `_` matches any argument
- `NotNull()` ensures the pointer argument is not null

**Success Criteria:** Tests accept arguments meeting matcher criteria and fail with informative messages otherwise.

---

### 2. Combine Matchers for Complex Conditions

You can compose matchers to express detailed conditions:

```cpp
using ::testing::AllOf;
using ::testing::Ne;

EXPECT_CALL(foo, DoThis(AllOf(Ge(5), Ne(10))));
EXPECT_CALL(foo, DoThat(Not(HasSubstr("error")), _));
```

- `AllOf` requires all conditions to hold
- You can use `Not()`, `AnyOf()`, and other logical combinators

---

### 3. Match Multiple Arguments as a Single Tuple

When argument relationships matter (e.g., first argument less than second), use `.With()`:

```cpp
EXPECT_CALL(foo, InRange(Ne(0), _)).With(Lt());

// Or using all arguments more explicitly
EXPECT_CALL(foo, Blah).With(AllOf(Args<0,1>(Lt()), Args<1,2>(Lt())));
```

This matches calls where argument 0 < argument 1 and argument 1 < argument 2.

---

### 4. Use Predicates and Lambdas

You can define a function or lambda as a matcher predicate:

```cpp
using ::testing::Truly;

bool IsEven(int n) { return (n % 2) == 0; }
EXPECT_CALL(foo, Bar(Truly(IsEven)));
```

This matcher validates arguments based on your custom logic.

---

### 5. Validate Object Members with `Field()` and `Property()`

To check specific members or properties instead of entire objects:

```cpp
EXPECT_CALL(foo, Process(Field(&Foo::number, Ge(3))));
EXPECT_CALL(foo, Process(Property(&Foo::name, StartsWith("John "))));
```

- `Field` matches member variables
- `Property` matches the return value of getter methods

Both provide clear, maintainable checks.

---

### 6. Use Pointer Matchers

When dealing with pointer arguments, match either the pointer itself or the pointed value:

```cpp
EXPECT_CALL(foo, Bar(IsNull()));
EXPECT_CALL(foo, Baz(Pointee(Ge(10))));
```

- `IsNull()` and `NotNull()` match the pointer value
- `Pointee(m)` matches the value pointed to

Pointee supports nested pointers too, e.g., `Pointee(Pointee(Lt(3)))`.

---

### 7. Match Container Contents Expressively

Matchers for containers help validate collections easily.

- Use exact equality for entire containers:

```cpp
EXPECT_CALL(foo, Foo(Eq(expected_container)));
```

- Use `ElementsAre()` and `UnorderedElementsAre()` for item-wise checks:

```cpp
EXPECT_CALL(mock, Foo(ElementsAre(1, Gt(0), _, 5)));
EXPECT_CALL(mock, Foo(UnorderedElementsAre(1, Gt(0), _, 5)));
```

- For arrays or vectors of matchers and values, use `ElementsAreArray()` and `UnorderedElementsAreArray()`.

- Use `Pair()` to match key-value pairs in maps:

```cpp
EXPECT_THAT(m, UnorderedElementsAre(Pair("a", 1), Pair("b", 2)));
```

---

### 8. Share and Reuse Matchers

Complex matchers can be assigned to variables for reuse:

```cpp
Matcher<int> in_range = AllOf(Gt(5), Le(10));
EXPECT_CALL(foo, Bar(in_range));
EXPECT_CALL(bar, Baz(in_range));
```

Sharing matchers avoids repetition and improves readability.

---

### 9. Create Custom Matchers Quickly

Use `MATCHER` or `MATCHER_P` macros to create new matchers:

```cpp
MATCHER(IsDivisibleBy7, "") { return (arg % 7) == 0; }

EXPECT_CALL(foo, Bar(IsDivisibleBy7()));
```

Add detailed failure messages by streaming to `result_listener`:

```cpp
MATCHER(IsDivisibleBy7, "") {
  if ((arg % 7) == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

Use parameterized macros (e.g. `MATCHER_P`) to add parameters to matchers.

---

### 10. Use Floating-Point Matchers for Approximate Equality

Floating-point comparisons require tolerance. GoogleMock offers:

- `FloatEq()`, `DoubleEq()` for approximate equality with default ULPs
- `FloatNear()`, `DoubleNear()` for custom absolute error bounds
- Nan-sensitive variants like `NanSensitiveFloatEq()`

Example:

```cpp
EXPECT_CALL(foo, Compute(FloatNear(3.14, 0.001)));
```

These reduce brittle test failures due to floating-point imprecision.

---

## Examples & Code Samples

```cpp
#include <gmock/gmock.h>
using ::testing::_;  // wildcard matcher
using ::testing::Gt;
using ::testing::ElementsAre;
using ::testing::Pointee;
using ::testing::Field;
using ::testing::Return;

class MockFoo {
 public:
  MOCK_METHOD(void, Process, (const std::vector<int>& nums), ());
  MOCK_METHOD(bool, CheckValue, (int* val), ());
  MOCK_METHOD(void, LogEvent, (const Foo& foo), ());
};

// Usage
MockFoo mock;

// Match a vector with 3 elements: 1, any positive number, and 3.
EXPECT_CALL(mock, Process(ElementsAre(1, Gt(0), 3)));

// Check that pointer argument points to value greater than 10.
int x = 15;
EXPECT_CALL(mock, CheckValue(Pointee(Gt(10)))).WillOnce(Return(true));

// Validate a specific member of the object argument.
EXPECT_CALL(mock, LogEvent(Field(&Foo::status, "ok")));

// Exercise
std::vector<int> v{1, 20, 3};
mock.Process(v);
mock.CheckValue(&x);
Foo foo_obj; foo_obj.status = "ok";
mock.LogEvent(foo_obj);
```

---

### Defining a Custom Matcher with Parameter

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}

EXPECT_CALL(mock, Func(HasAbsoluteValue(5)));
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting call warnings:** If you see warnings about mock methods called without expectations, use `NiceMock` to suppress or add appropriate `EXPECT_CALL` or `ON_CALL`.
- **Overly strict expectations:** Avoid specifying more constraints than necessary; prefer flexible matchers over exact values unless precise check is needed.
- **Matcher type mismatches:** Use `SafeMatcherCast<T>(m)` to resolve type issues.
- **Null pointer handling:** Use `IsNull()` or `NotNull()` for pointer checks, and `Pointee()` for value checks.

### Best Practices

- Use `_` (wildcard) to ignore arguments you do not care about.
- Keep expectations clear and minimal to avoid brittle tests.
- Combine matchers to express complex logical conditions clearly.
- Leverage container matchers to validate collection contents efficiently.
- Use parameterized and custom matchers to encapsulate reusable validation logic.

### Performance Considerations

Matching can be expensive if complex matchers or nested container matchers are overused. Prefer simpler matchers or directly verify results where possible.

### Alternative Approaches

For very complex validation scenarios, consider:
- Splitting the validation into multiple expectations
- Using lambdas or custom callable actions in `WillOnce` to perform detailed checks

---

## Next Steps & Related Content

- Learn about [Actions for Mocked Behavior](https://google.github.io/googletest/gmock_cook_book.html#using-actions) to combine matchers with behaviors.
- Explore [Creating and Using Mocks](https://google.github.io/googletest/guides/mocking_and_advanced_techniques.html#creating-and-using-mocks) to build robust test doubles.
- Visit the [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) for a complete catalog of built-in matchers.
- For advanced needs, check out [Defining Custom Matchers and Actions](https://google.github.io/googletest/guides/mocking_and_advanced_techniques.html#defining-custom-matchers-actions).
- Review [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html#Using-Matchers) for real-world recipes and idiomatic usage tips.

---

This guide fits into the documentation structure under 'Core Testing Patterns' and complements the broader guides on writing tests, creating mocks, and configuring expectations. It is focused entirely on argument validation with matchers, supporting a powerful but user-friendly test writing experience.
