---
title: "Performance Optimization and Troubleshooting"
description: "Techniques to speed up test runs, minimize flaky tests, debug common issues, and make efficient use of advanced features such as parallelization and test shuffling. Includes troubleshooting checklists and diagnostic tips."
---

# Performance Optimization and Troubleshooting

## Overview
This page provides essential techniques to speed up your GoogleTest and GoogleMock test runs, reduce flaky tests, and debug common issues. It covers practical approaches for leveraging advanced features such as parallelization, test shuffling, and test repetition, alongside troubleshooting checklists and diagnostic guidance to make your test suites more efficient and reliable.

---

## Prerequisites
- Ensure your project is correctly configured with GoogleTest and GoogleMock, following the [Configuring Your Project](https://github.com/google/googletest/blob/main/docs/getting-started/setup-basics/configuring-project.md) guide.
- Familiarity with writing basic tests and mock classes using GoogleTest and GoogleMock.
- Access to your test binaries and development environment for applying flags and environment variables.

---

## Expected Outcome
By following the techniques and troubleshooting guidance on this page, you will:
- Accelerate the execution time of your tests.
- Minimize intermittent test failures (flaky tests).
- Use advanced test runner flags to fine-tune test execution order and parallelism.
- Diagnose and resolve common test and environment issues that affect performance.

## Time Estimate
Approximately 15-30 minutes to implement key optimizations and overview troubleshooting steps.

## Difficulty Level
Intermediate â€“ requires basic knowledge of GoogleTest usage and test runner environments.

---

## Step-by-Step Optimization and Troubleshooting

### 1. Speeding Up Test Runs

**a. Use Test Repetition to Catch Flaky Tests**

- Run your tests multiple times using the `--gtest_repeat=N` flag, where `N` is the number of iterations.
- Example:

```bash
./my_test --gtest_repeat=100
```

- This approach helps expose flaky tests by revealing intermittent failures.

- Consider using `--gtest_break_on_failure` alongside to halt and debug at the first failure.

**b. Shuffle Test Execution to Detect Interdependencies**

- Enable test shuffling with the `--gtest_shuffle` flag:

```bash
./my_test --gtest_shuffle
```

- By running tests in randomized order, you can uncover hidden dependencies between tests that cause failures.

- Retrieve the seed printed by GoogleTest after a run to reproduce a specific order with `--gtest_random_seed=SEED`.

**c. Utilize Test Sharding for Parallel Execution Across Machines**

- Divide test execution across multiple machines (shards) by setting these environment variables:

  - `GTEST_TOTAL_SHARDS`: total number of shards.
  - `GTEST_SHARD_INDEX`: shard number (0-based index).

- Each shard runs your test binary and executes a non-overlapping subset of tests, speeding up overall test runtime.

**d. Repeat Without Recreating Environments**

- Use `--gtest_recreate_environments_when_repeating=false` to avoid unnecessary setup/teardown when repeating tests in loops.


### 2. Minimizing Flaky Tests

- Flaky tests often result from dependencies on external conditions, timing issues, or inter-test pollution.

- Use test shuffling to reveal order dependencies.

- Apply test repetition to isolate flaky behavior.

- Use `GTEST_SKIP()` to conditionally skip tests at runtime when prerequisites are unmet, e.g.: 

```cpp
TEST(MyTest, SkipWhenUnsupported) {
  if (!SupportsFeature()) {
    GTEST_SKIP() << "Skipping because feature is unsupported";
  }
  ... test code ...
}
```

- Mark known flaky tests as `DISABLED_` temporarily to prevent noise, but schedule fixing them promptly.

---

### 3. Advanced Execution Control

**a. Filter Tests to Run a Subset**

- Use `--gtest_filter` or `GTEST_FILTER` environment variable to select tests by name, including positive and negative patterns.

- Example:

```bash
./my_test --gtest_filter=MyTestSuite.*-MyTestSuite.FlakyTest
```

- This runs all tests in `MyTestSuite` except `FlakyTest`.

**b. Stop on First Failure**

- Use `--gtest_fail_fast` or `GTEST_FAIL_FAST=1` to abort after first test failure, useful during debugging iterations.

**c. Utilize Disabled Tests**

- To run temporarily disabled tests (prefixed with `DISABLED_`), use `--gtest_also_run_disabled_tests`.

---

### 4. Debugging and Diagnosing Common Issues

**a. Verify Test Setup Correctness**

- Cross-check your build and linking configuration as described in [Configuring Your Project](https://github.com/google/googletest/blob/main/docs/getting-started/setup-basics/configuring-project.md).

- Run the Quick Validation Checklist from the [Quick Validation Checklist](https://github.com/google/googletest/blob/main/docs/getting-started/first-steps/quick-validation.md) guide.

**b. Interpret Test Output Carefully**

- Use verbose mode to get detailed logs for mocking using the flag:

```bash
--gmock_verbose=info
```

- Combine with `--gtest_stack_trace_depth=0` if you want to see only mock call traces without stack traces.

**c. Troubleshoot Death Tests Failures or Hanging**

- Death tests run in a child process. Avoid creating threads outside the death test to reduce flakiness.

- If unavoidable, consider setting death test style to `threadsafe`:

```bash
GTEST_FLAG_SET(death_test_style, "threadsafe");
```

or via command line:

```bash
--gtest_death_test_style=threadsafe
```

- Ensure your program is reentrant and deterministic due to the restart behavior in threadsafe style.

**d. Fix Uninteresting Call Warnings**

- Suppress warnings for uninteresting calls by wrapping mock objects in `NiceMock<T>`.

- Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
```

- For stricter tests, use `StrictMock<T>` to make uninteresting calls test failures.

**e. Common Compiler Errors with Assertions or Mocking**

- Fatal assertions (`ASSERT_*`) can only be used in `void` functions, not in constructors or destructors.

- If you see "void value not ignored as it ought to be," check that fatal assertions are not used improperly in non-void functions.

- For more information see [Assertion Placement](https://github.com/google/googletest/blob/main/docs/advanced.md#assertion-placement) and the FAQ section on this topic.

---

### 5. Best Practices for Efficient Test Suites

- Use `SetUpTestSuite()` and `TearDownTestSuite()` for expensive shared setup and teardown that applies to all tests in a suite to avoid repeated overhead.

- Prefer mock object default actions set via `ON_CALL()` for typical behaviors and reserve `EXPECT_CALL()` for actual call verification.

- Use proper test filtering and disabled tests strategically to optimize runtime and test result clarity.

- Regularly inspect flaky tests through repetition and shuffling.

- Leverage `RecordProperty()` inside tests to add custom metadata useful during report analysis.

---

## Troubleshooting Checklist

| Symptom                     | Suggested Action
|-----------------------------|-----------------
| Test execution is slow       | Use parallelization via test sharding or run fewer tests with `--gtest_filter`.
| Flaky tests occur            | Enable `--gtest_repeat` and `--gtest_shuffle` to detect and isolate.
| Unexpected mock call warnings| Use `NiceMock<T>` or add catch-all expectations.
| Death test fails or stalls   | Use threadsafe death test style or minimize external threads.
| Assertion macro compilation errors | Check function return types and avoid fatal assertions in non-void functions.
| Disabled tests are not running | Use `--gtest_also_run_disabled_tests` flag.

---

## Additional Tips

- Always check your test suite names and test names do not contain underscores `_` to avoid naming collisions and build errors.
- Consider progressively adding complexity: start with filtering and repetition before engaging parallelization or more complex sharding setups.
- Use `--help` on your compiled test executable to see a full list of available runtime flags.

---

## Next Steps & Related Content

- [Configuring Your Project](https://github.com/google/googletest/blob/main/docs/getting-started/setup-basics/configuring-project.md) for proper build setup.
- [Introduction to Mocking](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md) for better understanding mock usage.
- [Advanced Mocking Techniques](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) for handling complex test scenarios.
- [Quick Validation Checklist](https://github.com/google/googletest/blob/main/docs/getting-started/first-steps/quick-validation.md) to confirm your environment works correctly.
- [Troubleshooting & FAQ](https://github.com/google/googletest/blob/main/docs/getting-started/first-steps/troubleshooting.md) for common issues and fixes.

---

## References
- [GoogleTest Flags and Environment Variables](https://github.com/google/googletest/blob/main/docs/advanced.md#running-test-programs-advanced-options)
- [GoogleMock Expectation Syntax](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#expect_call)
- [GoogleTest Assertions Reference](https://github.com/google/googletest/blob/main/docs/reference/assertions.md)

---

## Practical Example: Running Tests with Repeat and Shuffle Flags

```bash
# Repeat tests 500 times to detect flaky behavior.
./my_test --gtest_repeat=500

# Shuffle tests to uncover order dependencies.
./my_test --gtest_shuffle

# Combine shuffle with a fixed seed to reproduce an order related failure.
./my_test --gtest_shuffle --gtest_random_seed=12345

# Run specific test suite with disabled tests included.
./my_test --gtest_filter=MyTestSuite.* --gtest_also_run_disabled_tests
```

---

## Troubleshooting Flaky Death Tests

If your death tests are flaky or hanging:

- Avoid creating additional threads in your tests or try to confine them inside `EXPECT_DEATH` macros.
- Use the threadsafe death test style for better isolation:

```cpp
GTEST_FLAG_SET(death_test_style, "threadsafe");
```

- Make sure your tests are deterministic and can run multiple times without side effects.

- Consult [Death Tests](https://github.com/google/googletest/blob/main/docs/advanced.md#death-tests) for in-depth information.

---

## Summary
This page equips you with actionable strategies to optimize your GoogleTest and GoogleMock test execution, reduce flaky behaviors, and diagnose frequent performance and operational issues. By adopting proper test repetition, shuffling, filtering, and sharding, you improve test reliability and speed. Combining these with effective logging and mock configuration techniques creates a robust testing workflow ready for scaling.

---