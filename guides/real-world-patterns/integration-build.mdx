---
title: "Integrating GoogleTest with CMake and Bazel"
description: "Hands-on guides for adding GoogleTest to your build system, including CMake and Bazel. This page provides end-to-end integration steps, sample configuration files, and advice for keeping tests maintainable in diverse environments."
---

# Integrating GoogleTest with CMake and Bazel

GoogleTest and GoogleMock are essential tools for C++ developers aiming to adopt a robust testing framework. Integrating these libraries seamlessly into your build system ensures efficient test compilation, linking, and execution. This guide provides you with practical, step-by-step instructions to set up GoogleTest and GoogleMock with CMake and Bazel, complete with sample files and best practices for maintainable test projects.

---

## 1. Why Integrate GoogleTest with Your Build System?

Before diving into configuration, understand the goals:

- Automate compilation and linkage of test executables including GoogleTest and GoogleMock.
- Enable simple invocation of tests via build commands or test runners.
- Manage dependencies so that changes in tests or tested code trigger appropriate rebuilds.
- Allow mocking capabilities through GoogleMock seamlessly linked into your tests.

This integration reduces manual overhead, enforces consistency, and accelerates development cycles.

---

## 2. Integrating with CMake

### 2.1 Prerequisites

- Have a C++17-compliant compiler.
- CMake 3.14 or later installed.
- Clone GoogleTest repository:

```bash
  git clone https://github.com/google/googletest.git -b main
```

### 2.2 Basic Setup

You can build GoogleTest and GoogleMock as part of your project or rely on a pre-installed version.

### 2.3 Adding GoogleTest and GoogleMock with `add_subdirectory`

Place GoogleTest source alongside your project or reference it explicitly.

Example `CMakeLists.txt` snippet:

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyTestProject CXX)

# Enable testing capabilities
include(CTest)  # Enables CTest testing driver

# Add GoogleTest's source. This adds targets gtest, gmock, and gmock_main.
add_subdirectory(googletest)

# Create your test executable
add_executable(my_tests test_main.cpp my_class.cpp)

# Link with gtest and gmock libraries
target_link_libraries(my_tests gtest gmock gmock_main pthread)

# Enable C++17 standard
target_compile_features(my_tests PRIVATE cxx_std_17)

# Register the test executable
add_test(NAME MyTestSuite COMMAND my_tests)
```

### 2.4 Building and Running Tests

Build:

```bash
mkdir build && cd build
cmake ..
make
```

Run tests:

```bash
ctest -V
# or simply
./my_tests
```

### 2.5 Using Installed GoogleTest

If GoogleTest is installed globally or via package manager, use `find_package`:

```cmake
find_package(GTest REQUIRED)

add_executable(my_tests test_main.cpp my_class.cpp)
target_link_libraries(my_tests GTest::gtest GTest::gmock GTest::gmock_main pthread)
```

### 2.6 Using the `gmock_main` Library

The special `gmock_main` library provides a ready-made `main()` that initializes GoogleMock and runs all tests.

Prefer linking this library when you want to avoid writing your own `main()` function.

**Example:** Linking with `gmock_main` simplifies test executables:

```cmake
target_link_libraries(my_tests gmock_main pthread)
```

See the [gmock_main.pc.in](googlemock/cmake/gmock_main.pc.in) for details on packaging.

---

## 3. Integrating with Bazel

### 3.1 Basic Setup

GoogleTest and GoogleMock have native Bazel support.

### 3.2 WORKSPACE Setup

Add these rules to load GoogleTest:

```bazel
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/main.zip"],
    strip_prefix = "googletest-main",
)
load("@com_google_googletest//:bazel/mock_deps.bzl", "gmock_deps")
gmock_deps()
```

### 3.3 BUILD File Example

In your test `BUILD` file, define tests like this:

```bazel
cc_test(
    name = "my_tests",
    srcs = ["test_main.cpp", "my_class.cpp"],
    deps = [
        "@com_google_googletest//:gtest_main",
        "@com_google_googletest//:gmock",
        "@com_google_googletest//:gmock_main",
    ],
    copts = ["-std=c++17"],
)
```

### 3.4 Running Tests

Run via Bazel:

```bash
bazel test //:my_tests
```

---

## 4. Sample GoogleMock Main Integration

When not linking with `gmock_main`, you must initialize GoogleMock manually.

Example `main()` to initialize GoogleMock and run all tests:

```cpp
#include <gmock/gmock.h>

int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);  // Initializes both GoogleMock and GoogleTest
  return RUN_ALL_TESTS();  // Runs all registered tests
}
```

Note: If you link with `gmock_main`, this main function is already provided.

---

## 5. Practical Tips and Best Practices

- **Use `gmock_main` when possible.** It saves boilerplate and ensures proper initialization.
- **Keep tests modular.** Include only necessary source files to speed up builds.
- **Order expectations carefully** when using mocks, as later expectations override earlier ones.
- **Enable `CTest` in CMake.** It allows standardized test execution.
- **In Bazel, use `cc_test` rules properly referencing GoogleTest targets** to leverage built-in support.
- **Check compiler and linker compatibility, especially on Windows:**
  - Use `-DGTEST_USE_OWN_TR1_TUPLE=0` if you encounter issues.
  - For Windows MSVC static libraries, see known workarounds on main vs `_tmain` (as noted in `gmock_main.cc`).
- **Link with `pthread` or equivalent threading libraries on POSIX platforms.**

---

## 6. Common Pitfalls

- **Forgetting to call `InitGoogleMock()`** if not using `gmock_main` results in tests not registering correctly.
- **Linking without `gmock_main` main** and without providing your own `main()` causes linker errors.
- **Missing `pthread` linkage** on Linux causes link errors.
- **Adding source files multiple times** in build configs causes slow builds and potential symbol conflicts.
- **Overly restrictive mocks** can cause tests to fail unexpectedly; specify expectations with precision but avoid being too narrow.

---

## 7. Example CMakeLists.txt

```cmake
cmake_minimum_required(VERSION 3.14)
project(ExampleTests CXX)

enable_testing()
add_subdirectory(googletest)

add_executable(example_test example_test.cc)

target_link_libraries(example_test gmock_main pthread)

target_compile_features(example_test PRIVATE cxx_std_17)

add_test(NAME ExampleTest COMMAND example_test)
```

---

## 8. References & Next Steps

- Guide: [Getting Started with GoogleTest](https://github.com/google/googletest/blob/main/docs/primer.md)
- Guide: [Setting Up and Running Your First Test](https://google.github.io/googletest/getting-started.html)
- Guide: [Configuring Expectations and Actions](https://google.github.io/googletest/gmock_cook_book.html)
- Sample Main File: see `googlemock/src/gmock_main.cc`
- Explore `gmock_main` library and `gmock_main.pc.in` for packaging details.

---

With this integration, you're set to write, build, and run comprehensive tests with GoogleTest and GoogleMock efficiently, making your C++ projects more robust and maintainable.
