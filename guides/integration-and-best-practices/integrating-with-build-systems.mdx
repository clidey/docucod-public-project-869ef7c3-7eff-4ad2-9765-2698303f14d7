---
title: "Integrating with Build Systems"
description: "Practical walkthroughs for integrating tests with CMake and Bazel, managing dependencies, and best practices for cross-platform builds. Includes tips for handling project structure and linking."
---

# Integrating with Build Systems

## Overview
This guide provides a practical walkthrough to help you integrate GoogleTest and GoogleMock into your C++ projects using common build systems—specifically CMake and Bazel. Proper integration is essential for managing dependencies, structuring your project effectively, ensuring smooth compilation and linking, and maintaining cross-platform compatibility.

You’ll learn how to configure your build environment, link tests correctly, and follow best practices to facilitate seamless testing workflows within your development cycle.

---

## 1. Prerequisites
- Ensure you have GoogleTest and GoogleMock source code available in your workspace.
- Have a working C++17 compiler compatible with your target platforms.
- Install CMake (version 3.14 or later) for CMake-based builds or Bazel for Bazel-based projects.
- Familiarity with your chosen build system’s basic commands and project layout.

---

## 2. Integrating GoogleTest and GoogleMock with CMake

### 2.1 Adding GoogleTest as a Subdirectory
Include GoogleTest and GoogleMock in your project by adding their source code as a Git submodule or downloading them into your repository tree.

```cmake
# In your CMakeLists.txt
add_subdirectory(third_party/googletest)  # Path to GoogleTest
```

This step automatically includes both GoogleTest and GoogleMock.

---

### 2.2 Linking Your Test Executable
Define your test target and link it against `gtest` and `gmock` libraries.

```cmake
add_executable(my_tests test/my_tests.cpp)
target_link_libraries(my_tests PRIVATE gtest gmock)
```

Alternatively, link with `gtest_main` or `gmock_main` to get the built-in `main()` function:

```cmake
target_link_libraries(my_tests PRIVATE gtest_main gmock)
```

This avoids writing your own `main()` for test executables.

---

### 2.3 Setting the C++ Standard
Ensure your project and GoogleTest use at least C++17.

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

---

### 2.4 Enabling Thread Support
GoogleTest uses pthreads on POSIX systems to ensure thread-safe tests. CMake's FindThreads module usually handles this.

If you encounter linking errors related to pthreads, verify that your environment supports threads and ensure required flags are passed:

```cmake
find_package(Threads REQUIRED)
target_link_libraries(my_tests PRIVATE Threads::Threads)
```

---

### 2.5 Sample Minimal CMakeLists.txt
```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add GoogleTest
add_subdirectory(third_party/googletest)

# Create test executable
add_executable(my_tests test/my_tests.cpp)

target_link_libraries(my_tests PRIVATE gtest_main gmock)

# Discover and run tests with CTest
enable_testing()
add_test(NAME MyTests COMMAND my_tests)
```

---

## 3. Integrating GoogleTest and GoogleMock with Bazel

### 3.1 Workspace Setup
Modify your `MODULE.bazel` or `WORKSPACE` file to include GoogleTest and GoogleMock dependencies:

```python
# Add GoogleTest as a dependency
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.zip"],
    strip_prefix = "googletest-release-1.17.0",
)
```

### 3.2 Build Rule Configuration
Create a `cc_test` rule in your BUILD file to build and run your tests.

```bazel
cc_test(
    name = "my_tests",
    srcs = ["my_tests.cc"],
    deps = ["@com_google_googletest//:gtest_main", "@com_google_googletest//:gmock"],
)
```

The `gtest_main` target provides a default `main` function, so you don't need to define one.

---

### 3.3 Running Tests
Use the Bazel command to run tests:

```bash
bazel test //path/to:my_tests
```

Results show pass/fail status, and detailed logging depending on your settings.

---

## 4. Managing Dependencies and Linking

### 4.1 Linking Order and Libraries
- Link GoogleMock library after GoogleTest, as GoogleMock depends on GoogleTest.
- Prefer linking with `gmock_main` or `gtest_main` when not providing your own `main()`.

### 4.2 Avoid Duplicate Symbols
- Ensure only one `main()` is linked in the final test executable.
- If you provide your own `main()`, link with `gmock` or `gtest`, not the `_main` variants.

### 4.3 Handling Static vs Shared Libraries
- By default, GoogleTest builds static libraries.
- To build shared libraries, direct your build system to enable `BUILD_SHARED_LIBS`.
- When linking with shared libraries, define `GTEST_LINKED_AS_SHARED_LIBRARY=1` in your compile flags.

---

## 5. Project Structure Best Practices

- Isolate your test sources from production code.
- Place external dependencies such as GoogleTest under `third_party` or equivalent.
- Keep a dedicated folder for all tests, e.g., `test/` or `tests/`.
- Group related tests in test suites reflecting production code modules.

---

## 6. Cross-Platform Compatibility Tips

- Confirm that your environment complies with C++17 standards.
- Use abstraction layers for environment-specific threading or platform quirks.
- Leverage CMake's and Bazel’s platform detection and toolchain features.
- Avoid platform-specific assumptions in your test code.

---

## 7. Troubleshooting Common Issues

<AccordionGroup title="Common Integration Issues">
<Accordion title="Linker Errors: Undefined References to GoogleTest Symbols">
- Check that you linked your test binary against both `gtest` and `gmock`.
- Confirm the order of linking; GoogleMock depends on GoogleTest.
- Verify your C++ standard is consistent across all targets.
</Accordion>
<Accordion title="Duplicate main() Definition Errors">
- If you write your own `main()`, do not link with `gtest_main` or `gmock_main`.
- If you want the default `main()`, link only with `gtest_main` or `gmock_main`.
</Accordion>
<Accordion title="Threading or Pthread-Related Build Failures">
- Ensure `find_package(Threads)` is called in CMake and linked.
- For Bazel, check if your environment supports pthreads.
- On Windows, make sure you don’t inadvertently set POSIX-only flags.
</Accordion>
</AccordionGroup>

---

## 8. Additional Recommendations

- Use `gtest_main` or `gmock_main` for ease, unless customization is required.
- Maintain consistent compiler and linker flags across your production and test builds.
- Use CTest with CMake for automated test discovery and execution.
- Integrate your test commands with your CI/CD pipelines.

---

## 9. Example Workflow: Building and Running GoogleTest with CMake

1. Initialize your project and place GoogleTest sources under `third_party/googletest`.
2. Create or update `CMakeLists.txt` as shown in section 2.5.
3. Build your test executable:

```bash
mkdir build && cd build
cmake ..
cmake --build .
```

4. Run tests with CTest:

```bash
ctest --output-on-failure
```

You should see test results grouped by test suites.

---

## 10. References and Next Steps
- Explore the [Quickstart & Installation Guide](/guides/getting-started/quickstart-installation) for initial setup.
- Learn [Writing Your First Test](/guides/getting-started/writing-your-first-test) to write effective tests.
- Review [Continuous Integration & Test Automation](/guides/integration-and-best-practices/continuous-integration-automation) for seamless integration.
- Consult the [System Requirements & Prerequisites](/getting-started/prerequisites-installation/system-requirements) to verify your environment.

---

<p align="center"><em>With these integration best practices and configurations, your GoogleTest and GoogleMock usage will be robust, maintainable, and ready for cross-platform development.</em></p>
