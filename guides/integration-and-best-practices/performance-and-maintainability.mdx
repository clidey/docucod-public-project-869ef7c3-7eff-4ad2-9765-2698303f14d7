---
title: "Performance and Maintainability in Testing"
description: "Practical strategies for writing fast, maintainable, and scalable tests using GoogleTest and GoogleMock. Includes guidance on test structure, avoiding flaky tests, and optimizing execution time for large suites."
---

# Performance and Maintainability in Testing

GoogleTest and GoogleMock provide powerful tools for creating fast, maintainable, and scalable test suites in C++. This guide offers practical strategies focused on writing tests that not only catch bugs effectively but also run efficiently and remain easy to maintain as your codebase grows. Explore techniques for structuring tests, avoiding flaky results, and optimizing execution for large test suites.

---

## 1. Workflow Overview

### Purpose
This guide helps developers design, write, and organize tests using GoogleTest and GoogleMock to maximize speed and maintainability.

### Prerequisites
- Understanding of GoogleTest basic concepts and macros (`TEST()`, `TEST_F()`, assertions).
- Basic familiarity with GoogleMock for mocking interfaces.
- A working C++ development environment with GoogleTest and GoogleMock integrated.

### Outcomes
After completing the strategies in this guide, you will:
- Write tests that isolate and cover your code reliably.
- Avoid common causes of flaky tests.
- Structure tests and mocks for readability and reusability.
- Efficiently scale test execution to large test suites.

### Time Expectation
Allow 30â€“60 minutes to internalize principles and begin restructuring your tests progressively.

### Difficulty Level
Intermediate: Requires familiarity with GoogleTest fundamentals and C++ testing concepts.

---

## 2. Best Practices for Test Structure

### Group Related Tests with Test Suites
- Use consistent, meaningful names for test suites and test cases to reflect the components or functions under test.
- Group logically related tests together using `TEST()` or `TEST_F()`.
- Avoid over-large suites; keep them focused to enhance clarity and isolation.

### Reuse Common Setup Using Test Fixtures
- Prefer test fixtures (`TEST_F()`) to share common setup and teardown code.
- Initialize test objects in the fixture's constructor or `SetUp()` method.
- Keep fixtures simple and focused to reduce maintenance overhead.

### Name Tests Clearly
- Avoid underscores in test suite and test names due to naming conflicts and reserved identifiers (see [Test Naming FAQ](faq.md#why-should-test-suite-names-and-test-names-not-contain-underscore)).
- Use descriptive names indicating the behavior or condition tested.

### Keep Tests Independent and Repeatable
- Do not rely on execution order; GoogleTest executes tests in an undefined order.
- Avoid shared mutable state across tests unless strictly controlled.
- Reset or recreate fixtures properly to prevent flaky results.

---

## 3. Avoiding Flaky Tests

### Use `EXPECT_` for Nonfatal Failures When Appropriate
- Prefer `EXPECT_*` assertions over `ASSERT_*` when you want to continue running tests and collect multiple failures.
- Use `ASSERT_*` only when continuing after failure does not make sense (e.g., must not dereference a null pointer).

### Avoid Side Effects in Tests
- Do not rely on static or global variables unless encapsulated and reset properly.
- Avoid tests that depend on timing or external resources (e.g., network, disk).

### Handle Multithreading Carefully
- GoogleTest is thread-safe on pthread systems but unsafe to call assertions concurrently on Windows.
- Design tests to run assertions from a single thread.

### Manage Death Tests Properly
- Name test suites with `*DeathTest` suffix when using death tests to ensure correct execution order and isolation.
- Be aware that death tests run in subprocesses and do not share memory with the parent process.

---

## 4. Optimizing Test Execution

### Use Shared Resources Wisely
- Use `SetUpTestSuite()` and `TearDownTestSuite()` to share read-only or expensive-to-create resources across all tests in a suite.
- Avoid sharing mutable resources among tests without proper synchronization.

### Use Value-Parameterized and Typed Tests
- Reduce test code duplication by using `TEST_P()`, `INSTANTIATE_TEST_SUITE_P()`, and typed tests to run the same test logic with varied data or types.
- Properly parameterize your tests to cover edge cases efficiently without exponentially increasing test count.

### Minimize Mock Complexity
- Use `ON_CALL()` to define default mock behaviors, reserving `EXPECT_CALL()` for verifying critical interactions.
- Prefer `NiceMock` to reduce noise from unexpected calls unless strict verification is necessary.

### Run Tests in Parallel or Sharded Environments
- GoogleTest supports sharding via environment variables (`GTEST_TOTAL_SHARDS` and `GTEST_SHARD_INDEX`) to distribute tests across machines.
- Use `--gtest_shuffle` to randomize test order and catch inter-test dependencies.

---

## 5. Writing Maintainable Expectations and Assertions

### Use Clear, Minimalist Matchers
- Match only what matters in arguments to prevent brittle tests.
- Use `_` matcher to ignore arguments where value does not affect test outcome.

### Avoid Over-Constraining
- Too many expectations make tests fragile to legitimate code refactoring.
- Use `Times(AnyNumber())` or open cardinalities where precise call counts are unnecessary.

### Sequence and Ordering
- Use `InSequence` blocks or `.InSequence()` clauses only when call order matters.
- Avoid ordering constraints when possible to keep tests resilient.

### Custom Actions and Delegation
- Leverage `WillOnce()`, `WillRepeatedly()`, and custom actions to delegate behaviors dynamically.
- When possible, delegate to real or fake implementations for more realistic test doubles.

### Handling Move-Only Types
- Mock methods accepting or returning move-only types like `std::unique_ptr` using `MOCK_METHOD` with compatible signatures.
- Use lambdas or callable objects for actions that create or consume move-only objects at runtime.

---

## 6. Practical Tips & Common Pitfalls

<Tip>
Always return the result of `RUN_ALL_TESTS()` from your `main()` function. Ignoring it can lead to incorrect test results being reported.
</Tip>

<Note>
Create fresh test fixtures for each test to avoid test contamination; GoogleTest automatically does this with `TEST_F()`.
</Note>

<Warning>
Using underscores in test suite or test names may cause conflicts or undefined behavior; follow naming guidelines strictly.
</Warning>

<Tip>
Suppress warnings about uninteresting calls by using `NiceMock` when you intentionally do not set expectations on all mock methods.
</Tip>

<Warning>
Avoid setting expectations after the mock methods are called. All `EXPECT_CALL()` must precede test execution on the mock.
</Warning>

---

## 7. Troubleshooting

### Test Not Running or Being Detected
- Verify test functions are declared using the `TEST()` or `TEST_F()` macros.
- Check naming conventions and source file inclusion in your build system.

### Flaky Tests Due to Shared State
- Ensure all shared state is reset or use test fixtures properly.
- Avoid static/global mutable variables affecting test results.

### Mock Method Called But Real Implementation Runs
- Confirm the method being mocked is declared `virtual`.
- Check correct `MOCK_METHOD` macro usage and override specifications.

### Expectation Failures Unclear
- Run tests with `--gmock_verbose=info` to see detailed call and expectation logs.
- Review overlap, order, and specificity of expectations.

---

## 8. Next Steps & Related Content

- Explore the [GoogleTest Primer](primer.md) to strengthen your foundation in writing tests.
- Deepen your mocking knowledge in the [Mocking with GoogleMock](mocking-with-googlemock.mdx) guide.
- Learn advanced assertion techniques in the [Writing Clear and Effective Assertions](writing-effective-assertions.mdx) guide.
- Investigate test parameterization strategies in the [Parameterized and Typed Tests](parameterized-and-typed-tests.mdx) guide.
- Review the [GoogleTest FAQ](faq.md) for quick resolutions to common questions.

---

## Glossary
- **Test Suite / Test Case**: A group of related tests.
- **Test Fixture**: A class providing common objects and setup for tests.
- **Mock**: A test double used to simulate and verify behavior of dependencies.
- **Flaky Tests**: Tests that pass or fail nondeterministically.
- **Cardinality**: The expected number of calls to a mock method.

---

## References
- GoogleTest Primer: [primer.md](primer.md)
- GoogleMock Cookbook: [gmock_cook_book.md](gmock_cook_book.md)
- gMock FAQ: [gmock_faq.md](gmock_faq.md)
- GoogleTest Advanced Guide: [advanced.md](advanced.md)
- Assertions Reference: [reference/assertions.md](reference/assertions.md)
- Mocking Reference: [reference/mocking.md](reference/mocking.md)
- GoogleTest FAQ (Naming): [faq.md#why-should-test-suite-names-and-test-names-not-contain-underscore](faq.md#why-should-test-suite-names-and-test-names-not-contain-underscore)

---