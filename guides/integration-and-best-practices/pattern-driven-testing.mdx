---
title: "Adopting Test Patterns and Anti-Patterns"
description: "A practical look at patterns that lead to maintainable, expressive, and reliable C++ tests, as well as common pitfalls to avoid when using GoogleTest and GoogleMock at scale."
---

# Adopting Test Patterns and Anti-Patterns

A practical look at patterns that lead to maintainable, expressive, and reliable C++ tests, as well as common pitfalls to avoid when using GoogleTest and GoogleMock at scale.

---

## Overview

Writing tests with GoogleTest and GoogleMock is powerful but requires care to ensure tests remain maintainable, expressive, and reliable as the codebase and test suite grow. This guide focuses on *test patterns* that promote clarity and longevity, alongside *anti-patterns* that lead to brittle, confusing, or unhelpful tests.

By embracing the right patterns and avoiding common pitfalls, you will create C++ tests that are easier to understand, refactor, and trust.

---

## 1. Test Patterns for Sustainable GoogleMock Usage

### 1.1 Define Clear and Focused Mock Interfaces

- Mock only what your test **actually depends on**. Avoid bloated mock classes with methods that tests do not care about.
- Use *narrow interfaces* that reflect meaningful collaboration boundaries.
- When mocking overloaded methods, mock all overloads you expect to be used to prevent surprises.

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, DoThing, (), (override));
  MOCK_METHOD(int, DoThing, (int), (override));  // Mock all overloads used
};
```

### 1.2 Use NiceMock as the Default Mock Strictness

- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Reserve `StrictMock<T>` for tests where you must detect any unexpected interaction.
- Avoid `NaggyMock<T>`, as it yields noisy warnings that often confuse rather than help.

```cpp
NiceMock<MockFoo> mock_foo;  // Less brittle and cleaner logs
```

### 1.3 Prefer ON_CALL for Default Behaviors

- Use `ON_CALL` to specify how mocks behave when methods are called without particular expectations.
- Use `EXPECT_CALL` sparingly, only when you want to verify *that* a call happens, its arguments, count, and order.

```cpp
ON_CALL(mock_foo, GetValue()).WillByDefault(Return(42));
EXPECT_CALL(mock_foo, DoAction(_)).Times(1);
```

### 1.4 Use Sequences and Partial Orders for Call Ordering When Needed

- To test order dependencies, group expectations within scoped `InSequence` blocks.
- For complex partial orders, use `Sequence` objects with `.InSequence()` and `.After()` to express dependency.

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Step1());
  EXPECT_CALL(mock, Step2());
}
```

### 1.5 Use `RetiresOnSaturation` to Avoid Sticky Expectations

- By default, an expectation is "sticky" and matches calls even after saturation.
- Use `.RetiresOnSaturation()` on expectations that should deactivate after fully used.

```cpp
EXPECT_CALL(mock, Fetch()).WillOnce(Return(1)).RetiresOnSaturation();
EXPECT_CALL(mock, Fetch()).WillRepeatedly(Return(0));
```

### 1.6 Delegate to Fakes or Real Objects to Reduce Mock Complexity

- When possible, use delegation techniques to reuse existing behavior rather than reimplement in mocks.
- Use `ON_CALL().WillByDefault(Invoke(fake, &Fake::Method));` to forward calls.

### 1.7 Control Matchers Explicitly and Sparingly

- Use `_` as a wildcard when exact argument values aren't critical.
- Use specialized matchers (`Eq()`, `Ge()`, `Field()`, `Pointee()`) to be precise but not over-specified.

### 1.8 Batch Expectations Logically

- Organize related expectations and actions together.
- Avoid scattering expectations throughout test bodies which harms readability.

---

## 2. Common Anti-Patterns and How to Avoid Them

### 2.1 Over-Specifying Expectations

- Setting expectations on calls you don't actually care about leads to brittle tests.
- Avoid `EXPECT_CALL` on every single mock method invocation; use `ON_CALL` for default behavior.

### 2.2 Creating Huge Monolithic Mocks

- Large mocks violate the single responsibility principle and hinder test isolation.
- Prefer multiple smaller mocks or interface segregation.

### 2.3 Ignoring Mock Object Lifetimes

- Leaking mocks or having mocks destroyed before expected verification can cause false positives.
- Use RAII, heap checkers, or `Mock::AllowLeak()` judiciously.

### 2.4 Forgetting Virtual Destructors

- Always ensure mocked interfaces have `virtual` destructors to avoid undefined behavior and leaks.

### 2.5 Ignoring Match Order in Multiple EXPECT_CALLs

- Remember newer expectations override older ones; place more specific expectations *after* general ones.

### 2.6 Suppressing Warnings by Blindly Adding EXPECT_CALLs

- Do not add `EXPECT_CALL(...).Times(AnyNumber())` just to silence "uninteresting call" warnings.
- Instead, use `NiceMock` to suppress warnings cleanly.

### 2.7 Neglecting Proper Use of `RetiresOnSaturation()`

- Failing to retire expectations when needed leads to confusing upper-bound errors.

### 2.8 Using StrictMock Excessively

- While strict mocks help detect unexpected calls, overusing them can cause brittle tests requiring unnecessary maintenance.

---

## 3. Practical Examples

### 3.1 Using NiceMock with Default Behavior

```cpp
#include <gmock/gmock.h>
using ::testing::NiceMock;
using ::testing::Return;

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, DoAction, (), (override));
};

TEST(FooTest, UsesNiceMock) {
  NiceMock<MockFoo> mock_foo;
  ON_CALL(mock_foo, GetValue()).WillByDefault(Return(42));
  EXPECT_CALL(mock_foo, DoAction()).Times(1);

  SomeFunctionUsingFoo(&mock_foo);
}
```

Expected outcome: No warnings on calls to `GetValue()`, `DoAction()` called once.

### 3.2 Sequencing Calls

```cpp
using ::testing::InSequence;

TEST(FooTest, SequencesCalls) {
  MockFoo mock_foo;
  {
    InSequence s;
    EXPECT_CALL(mock_foo, Initialize());
    EXPECT_CALL(mock_foo, Start());
    EXPECT_CALL(mock_foo, Shutdown());
  }

  // Code expected to call mocks in order: Initialize -> Start -> Shutdown
  RunAllStages(&mock_foo);
}
```

### 3.3 Preventing Sticky Expectations With `RetiresOnSaturation()`

```cpp
EXPECT_CALL(mock_foo, Process(_))
    .WillOnce(Return(true))
    .RetiresOnSaturation();
EXPECT_CALL(mock_foo, Process(_))
    .WillRepeatedly(Return(false));
```

When the first expectation is met once, it retires, and subsequent calls match the repeated expectation.

---

## 4. Tips for Effective Testing with GoogleMock

- **Always set expectations before exercising code**. Setting expectations after exercising the mock triggers undefined behavior.
- Verify mock destruction with heap checkers to ensure expectations are validated.
- Use `Mock::VerifyAndClearExpectations(&mock);` if you need manual verification early.
- Write focused tests verifying one aspect at a time.
- Prefer `ON_CALL` for common default actions, `EXPECT_CALL` only for behavioral checks.
- Use descriptive names for tests and expectations to clarify intent.

---

## 5. Troubleshooting Common Issues

### Symptom: Uninteresting mock function call warnings

- Cause: Method called without an associated `EXPECT_CALL`.
- Solution: Use `NiceMock` mocks or add an `EXPECT_CALL(...).Times(AnyNumber())` only if you want to document expected multiple calls.

### Symptom: Unexpected call errors

- Cause: Call does not match any `EXPECT_CALL`.
- Solution: Confirm expectations match call arguments correctly; add appropriate `EXPECT_CALL`s or default behaviors.

### Symptom: Tests failing due to too many calls

- Cause: Expectation cardinality exceeded.
- Solution: Use `.Times()` correctly and consider `.RetiresOnSaturation()` for one-time expectations.

### Symptom: Compilation errors with `MOCK_METHOD`

- Cause: Improper use of parentheses around return or argument types containing commas.
- Solution: Wrap types with commas in additional parentheses, or create type aliases for those types.

---

## 6. Next Steps & Further Reading

* Explore the [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) to deepen understanding of `EXPECT_CALL`, `ON_CALL`, and mock strictness control.
* Review the [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) for recipes on advanced usage and design patterns.
* Learn more about [structuring test suites](https://github.com/google/googletest/blob/main/guides/core-testing-workflows/structuring-test-suites.md) to scale test organization.
* Consult [Core Features at a Glance](https://github.com/google/googletest/blob/main/overview/getting-started-with-googletest/core-features-at-a-glance.mdx) for foundational knowledge.

---