---
title: "Integrating with CMake and Bazel"
description: "Detailed steps for adding GoogleTest to your CMake or Bazel project. Learn configuration basics, dependency management, and platform-specific considerations to ensure smooth test builds and integration."
---

# Integrating GoogleTest and GoogleMock with CMake and Bazel

This guide provides detailed, step-by-step instructions for adding **GoogleTest** and **GoogleMock** to your CMake or Bazel projects. You will learn how to configure your build system to manage dependencies, link necessary libraries, and handle platform-specific considerations that ensure smooth test builds and seamless integration.

---

## Workflow Overview

### Task Description
Enable testing in your C++ projects by integrating GoogleTest and GoogleMock frameworks through CMake or Bazel. This includes setting up dependencies, configuring build scripts, and ensuring your test binaries compile and run reliably.

### Prerequisites
- Basic familiarity with CMake or Bazel build systems.
- C++17-compliant compiler and environment.
- GoogleTest’s source (which includes GoogleMock) available in your project or accessible via FetchContent or external dependencies.

### Expected Outcome
- Your project will build test executables linked against GoogleTest and GoogleMock.
- Tests can be written using GoogleTest and GoogleMock APIs and run successfully.
- Proper handling of initialization, linking, and sharing of test main entry points.

### Time Estimate
Approximately 30–60 minutes depending on project complexity and existing build configuration.

### Difficulty Level
Intermediate — familiarity with build system configuration is necessary.

---

## Step-by-Step Instructions

### Integrating GoogleTest and GoogleMock with CMake

1. **Add GoogleTest source to your project:**

   - Use `add_subdirectory()` to include GoogleTest sources.

   ```cmake
   # Declare path to GoogleTest (and GoogleMock) sources
   set(gtest_dir "path/to/googletest")
   
   # Add GoogleTest (which includes GoogleMock)
   add_subdirectory(${gtest_dir})
   ```

2. **Configure project to link against GoogleTest and GoogleMock:**

   - Link with the appropriate targets `gtest` and `gmock`.
   - For example, to link your test executable:

   ```cmake
   add_executable(my_test test_file.cpp)
   target_link_libraries(my_test gtest gmock gtest_main)
   ```

3. **Use `gmock_main` if you want a pre-defined main function:**

   - GoogleMock provides `gmock_main` library which contains a `main()` suitable for test runners.
   - Link your test binary against `gmock_main` to avoid writing your own main.

   ```cmake
   target_link_libraries(my_test gmock_main)
   ```

4. **Threading Considerations:**
   - GoogleTest detects and enables pthread support if available.
   - CMake script handles pthread linking and compile flags automatically.

5. **Control compilation options (optional):**

   - You can control shared/static library builds using `BUILD_SHARED_LIBS` option.
   - Customize compiler warnings or exception settings if desired.

6. **Build and run tests:**

   - Build your project with CMake-generated build files then run the tests via:

   ```bash
   make my_test
   ./my_test
   ```

7. **Install Rules:**

   - GoogleMock’s CMake scripts include install targets if you intend to install the library.

### Sample Minimal `CMakeLists.txt`

```cmake
cmake_minimum_required(VERSION 3.13)
project(MyProject LANGUAGES CXX)

# Add GoogleTest sources
add_subdirectory(googletest)

# Your test executable
add_executable(my_tests test/my_tests.cpp)

target_link_libraries(my_tests gmock_main)

# Set C++17 standard
set_target_properties(my_tests PROPERTIES
                      CXX_STANDARD 17
                      CXX_STANDARD_REQUIRED ON)

# Enable testing
enable_testing()
add_test(NAME MyTests COMMAND my_tests)
```


---

### Integrating GoogleTest and GoogleMock with Bazel

1. **Add GoogleTest dependency to your `WORKSPACE`**:

```bazel
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.tar.gz"],
    strip_prefix = "googletest-release-1.17.0",
)
```

2. **Load GoogleTest and GoogleMock rules in your `BUILD` files:**

```bazel
load("@com_google_googletest//:bazel:gtest.bzl", "gtest_main")

cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = ["@com_google_googletest//:gmock_main", 
            "@com_google_googletest//:gtest_main"],
)
```

3. **Write your tests using GoogleTest and GoogleMock APIs:**

- Use `gmock_main` target in your test dependencies for ready-made test entry point.

4. **Build and run tests:**

```bash
bazel test //path/to:test_name
```

- Bazel handles compilation, linking, and running.

---

## Configuration Basics and Practical Tips

- When linking directly to `gmock_main`, you do **not** need to provide your own main function; otherwise, define and initialize GoogleMock manually in your `main()`.
- Always initialize GoogleMock (and implicitly GoogleTest) with `testing::InitGoogleMock(&argc, argv);`
- For embedded or Arduino-like platforms, use platform-specific entry points as indicated by `gmock_main.cc` and the provided configuration.
- For CMake, the `gmock` and `gmock_main` libraries are compiled with stricter compiler warnings enabled to catch potential issues early.
- Use FetchContent to automatically download GoogleTest sources during build if you prefer not to keep local copies.

---

## Troubleshooting & Common Pitfalls

- **Linker errors (e.g., unresolved symbol _main):**
  - Ensure you link with `gmock_main` if you do not provide your own main function.
  - For Windows, `main()` is used instead of `_tmain()` due to known MSVC linker issues.

- **Threading issues:**
  - Confirm that your build includes the pthread library on platforms that require it.
  - For CMake, ensure `GTEST_HAS_PTHREAD` is set appropriately if the auto-detection fails.

- **Multiple definitions:**
  - Avoid linking both `gtest_main` and `gmock_main` into the same executable; select only one main provider.

- **Compilation failures related to C++ standards:**
  - Prefer C++17 or later to avoid compatibility issues.

- **Tests not running:**
  - Confirm `InitGoogleMock()` or `InitGoogleTest()` is called before `RUN_ALL_TESTS()`.

---

## Example: Custom Main Function

If you prefer to control test initialization and add setup or teardown code, define your own `main()`:

```cpp
#include <gmock/gmock.h>

int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

Link this with GoogleMock and GoogleTest libraries, but do not link against `gmock_main` or `gtest_main` to avoid duplicate symbols.

---

## Platform-Specific Considerations

- On Arduino or embedded platforms like ESP8266, ESP32, or nRF52, the `gmock_main.cc` provides custom `setup()` and `loop()` functions that initialize and run tests in the embedded environment.
- For Windows Mobile, `gmock_main.cc` uses `_tmain` entry point.
- The GoogleMock source (`gmock_main.cc`) handles platform differences transparently – you should rarely need to change it.

---

## Next Steps & Related Content

- After successful integration, move on to [Writing Your First Unit Test](/guides/core-testing-workflows/writing-basic-tests) to author and run your test cases.
- Explore [Mocking Dependencies with GoogleMock](/guides/core-testing-workflows/using-mocks-in-tests) for advanced mock usage.
- Review the [Build System Integration](/guides/integration-and-best-practices/build-system-integration) guide for tips and best practices.
- Consult the official [GoogleTest README](https://github.com/google/googletest/blob/main/README.md) for more technical nuances.

---

## References

- [GoogleMock Main C++ Source (`gmock_main.cc`)](https://github.com/google/googletest/blob/main/googlemock/src/gmock_main.cc)
- [GoogleMock CMake Configuration (`CMakeLists.txt`)](https://github.com/google/googletest/blob/main/googlemock/CMakeLists.txt)
- [GoogleTest README - Build Instructions](https://github.com/google/googletest/blob/main/googletest/README.md)
- [GoogleMock README](https://github.com/google/googletest/blob/main/googlemock/README.md)

---