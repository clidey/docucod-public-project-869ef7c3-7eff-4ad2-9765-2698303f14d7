---
title: "Integration with Bazel and CMake"
description: "Walk through configuring GoogleTest and GoogleMock in Bazel and CMake projects. Includes setup advice, typical build files, and tips for sandboxed and cross-platform compilation."
---

# Integration with Bazel and CMake

## Overview

This guide walks you through how to integrate GoogleTest and GoogleMock into your C++ projects using popular build systems Bazel and CMake. You'll learn practical setup steps, typical build file configurations, and key tips for dealing with sandboxed and cross-platform builds. By the end, you'll have a working environment enabling smooth compilation, linkage, and test execution harnessing GoogleTest and GoogleMock capabilities.

---

## 1. Workflow Overview

### Task Description
Learn how to configure GoogleTest and GoogleMock within Bazel and CMake projects, including project setup, library linking, include path configuration, and running tests.

### Prerequisites
- A working C++ development environment supporting C++11 or later.
- Installed Bazel and/or CMake build tools.
- Familiarity with basic C++ project structures.

### Expected Outcome
You will successfully configure your project build files to compile GoogleTest and GoogleMock, link against their libraries, and run tests through your build system.

### Time Estimate
Approximately 30–60 minutes depending on experience and existing environment.

### Difficulty Level
Intermediate: Requires understanding of build systems and C++ compilation/linking.

---

## 2. Bazel Integration

GoogleTest and GoogleMock provide official Bazel BUILD configurations to facilitate integration.

### Step-by-Step Instructions

1. **Add GoogleTest and GoogleMock as dependencies**

   In your `WORKSPACE` file, point to the GoogleTest repository, for example:

   ```python
   http_archive(
       name = "com_google_googletest",
       urls = ["https://github.com/google/googletest/archive/release-1.13.0.tar.gz"],
       strip_prefix = "googletest-release-1.13.0",
   )
   ```

2. **Declare GoogleTest Targets in BUILD files**

   Include `gtest` and `gmock` targets from the workspace as dependencies in your Bazel BUILD files.

   Example `BUILD` snippet:

   ```python
   cc_test(
       name = "my_test",
       srcs = ["my_test.cc"],
       deps = [
           "@com_google_googletest//:gmock",
           "@com_google_googletest//:gtest_main",
       ],
   )
   ```

3. **Write tests using GoogleTest and GoogleMock in source files**

4. **Build and run tests**

   Run:

   ```bash
   bazel test //path/to:my_test
   ```

   Bazel will compile GoogleMock and GoogleTest dependencies as part of the build.

### Tips for Bazel
- Use `gmock_main` if you want GoogleMock’s supplied `main()` in your test binary.
- Bazel sandboxing can affect environment variables; avoid depending on them within tests.
- Use `bazel query` and `bazel cquery` to inspect dependencies.

---

## 3. CMake Integration

GoogleMock comes with community-maintained CMake build scripts enabling straightforward use.

### Step-by-Step Instructions

1. **Clone or include GoogleMock source tree in your project or fetch it externally**

2. **Add GoogleMock and GoogleTest to your CMake project**

   In your `CMakeLists.txt`, include:

   ```cmake
   # Specify minimum CMake version
   cmake_minimum_required(VERSION 3.13)

   # Add GoogleMock and GoogleTest
   add_subdirectory(path/to/googletest)

   # Add your test executable
   add_executable(my_test my_test.cc)

   # Link with gmock and gtest libraries
   target_link_libraries(my_test gmock_main gtest)
   ```

3. **Configure include directories automatically**

   The above `add_subdirectory` ensures headers and libraries for GoogleMock and GoogleTest are available to your build targets.

4. **Build your project**

   From your build directory:

   ```bash
   cmake ..
   make
   ```

5. **Run tests**

   Execute:

   ```bash
   ./my_test
   ```


### CMake Build Script Notes

- The official CMakeLists for GoogleMock handles strict compiler warnings and environment compatibility.
- You may control building GoogleMock tests by enabling the `gmock_build_tests` option.
- For shared library use, set `BUILD_SHARED_LIBS=ON`.

### Practical Tips
- Always use `gmock_main` if you want a self-contained test runner without defining your own `main()`.
- For projects that only need GoogleTest (no mocking), disable GoogleMock build with `-DBUILD_GMOCK=OFF`.
- Keep C++17 or newer specified via `set(CMAKE_CXX_STANDARD 17)` in your `CMakeLists.txt` for compatibility.

---

## 4. Typical Build File Examples

### Bazel BUILD file example

```python
cc_test(
    name = "example_test",
    srcs = ["example_test.cc"],
    deps = [
        "@com_google_googletest//:gmock",
        "@com_google_googletest//:gtest_main",
    ],
)
```

### CMakeLists.txt example snippet

```cmake
cmake_minimum_required(VERSION 3.13)
project(MyTests CXX)

# Add GoogleMock (which includes GoogleTest)
add_subdirectory(googletest)

add_executable(example_test example_test.cc)
target_link_libraries(example_test gmock_main gtest)
set_target_properties(example_test PROPERTIES CXX_STANDARD 17 CXX_STANDARD_REQUIRED ON)
```

---

## 5. Troubleshooting and Best Practices

### Common Issues
- **Linker errors** due to missing GoogleTest or GoogleMock libraries. Verify dependencies in build files and include paths.
- **Multiple main() symbols** when linking both `gmock_main` and your own `main()`. Use one or the other.
- **Sandbox restrictions** in Bazel causing missing environment variables or access denied errors. Avoid such dependencies or sandbox overrides.

### Best Practices
- Prefer `gmock_main` when using GoogleMock to simplify test runner implementation.
- Keep GoogleTest and GoogleMock versions in sync to avoid compatibility issues.
- Consider setting GoogleMock verbosity flags in test run arguments for detailed output (`--gmock_verbose=info`).

### Performance and Cross-Platform Considerations
- CMake’s strict compiler warnings keep dependencies error-free but may require tuning for your toolchain.
- Bazel integration supports cross-platform builds and sandboxing but requires explicit dependency declarations.

---

## 6. Next Steps & Related Content

- Review [Project Setup & Integration](getting-started/configuring-using-tests/project-setup-integration) for detailed guidance on project structures.
- Learn to [Write Your First Test Case](getting-started/configuring-using-tests/write-first-test-case) and run it.
- See [Optimizing Test Performance and Troubleshooting](guides/integration-and-best-practices/optimizing-tests-and-troubleshooting) for advanced tips.

---

## References

- [GoogleMock README](https://github.com/google/googletest/tree/main/googlemock/README.md)
- [GoogleTest Generic Build Instructions](https://github.com/google/googletest/blob/main/googletest/README.md)
- [Bazel BUILD files for GoogleTest/GoogleMock](https://github.com/google/googletest/tree/main/googlemock)
- [Official CMakeLists.txt for GoogleMock](https://github.com/google/googletest/blob/main/googlemock/CMakeLists.txt)

---

## Summary Diagram

```mermaid
flowchart TD

  subgraph Bazel Integration
    A[Define Workspace: Download GoogleTest & GoogleMock]
    B[Declare BUILD target with dependencies on @com_google_googletest//:gmock and gtest_main]
    C[Write tests in .cc files]
    D[Build and run tests with `bazel test`]
  end

  subgraph CMake Integration
    E[Include GoogleMock with add_subdirectory()]
    F[Add test executable targets]
    G[Link with gmock_main and gtest]
    H[Build with cmake and make]
    I[Run test binary directly]
  end

  A --> B --> C --> D
  E --> F --> G --> H --> I

  style A fill:#f9f,stroke:#333,stroke-width:2px
  style E fill:#afa,stroke:#333,stroke-width:2px

```

---

<Tip>
Ensure your build environment uses a C++17-compatible compiler and linkers. When integrating GoogleMock, using the `gmock_main` library simplifies your test runs by providing an out-of-the-box `main()`.
</Tip>

<Warning>
Do not define your own `main()` function if linking against `gmock_main` to avoid multiple definition errors.
</Warning>

<Note>
If building GoogleTest and GoogleMock as part of a larger project, consider using CMake's FetchContent or Bazel's `http_archive` to manage dependencies cleanly.
</Note>

<Check>
Verify your build artifacts include GoogleMock and GoogleTest symbols by inspecting linker verbosity or binary symbol tables to confirm successful linkage.
</Check>
