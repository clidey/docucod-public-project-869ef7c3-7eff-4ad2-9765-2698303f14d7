---
title: "Complex Matchers and Actions"
description: "Go beyond basics by leveraging advanced matchers and writing custom actions. See how to match complex data structures, chain expectations, and control mock behaviors for nuanced verification."
---

# Complex Matchers and Actions

Master the art of intricate verification with advanced GoogleMock matchers and custom actions. This guide shows you how to precisely match complex data structures, chain expectations for ordered verification, and manipulate mock behaviors to simulate nuanced interactions.

---

## Workflow Overview

- **Purpose**: Enable you to extend GoogleMock's flexibility by writing complex argument matchers and crafting custom actions that precisely control mock behavior.
- **Prerequisites**: 
  - Basic understanding of GoogleMock's mocking syntax and concepts ([see gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)).
  - Familiarity with defining simple mock methods using `MOCK_METHOD`.
- **Expected Outcome**: Gain ability to compose advanced matching conditions using multi-argument matchers, impose call order constraints with sequences and ExpectationSets, and write custom callable actions for sophisticated test scenarios.
- **Estimated Time**: 20-40 minutes to absorb core concepts and experiment with examples.
- **Skill Level**: Intermediate to Advanced

---

## Key Concepts and Techniques

### 1. Matching Complex Arguments

Use `.With()` clause with multi-argument matchers to enforce conditions spanning multiple parameters.

- `.With()` accepts a matcher of type `Matcher<std::tuple<A1, ..., An>>`, matching arguments as a whole tuple.
- This allows expressions like "first argument less than second" or validating combinations of parameters using custom predicates.

#### Example: Match arguments where first < second

```cpp
using ::testing::_;
using ::testing::Lt;
...
EXPECT_CALL(mock_obj, SetPosition(_, _))
    .With(Lt())  // Matches if arg0 < arg1
    .Times(1);
```

#### Advanced: Use `AllArgs` or `Args` to selectively match tuples

```cpp
using ::testing::AllOf;
using ::testing::Args;
using ::testing::Lt;
...
EXPECT_CALL(mock_obj, Blah)
    .With(AllOf(Args<0, 1>(Lt()), Args<1, 2>(Lt())));
```
This asserts `Blah` is called with args `x,y,z` where `x < y < z`.

---

### 2. Expectation Ordering and Partial Sequences

Define explicit call order expectations for mock methods using **sequences** and **Expectations**.

- **`InSequence`**: a helper object that places all expectations within its scope into one anonymous sequence.
- **`Sequence`**: named sequences specifying partial or full order constraints.
- **`Expectation` and `ExpectationSet`**: handles to specific expectations important for partial order with `.After()` clauses.

#### Example: Enforce Sequential Calls

```cpp
using ::testing::InSequence;

{
  InSequence seq;  // All expectations are ordered

  EXPECT_CALL(mock, Reset());
  EXPECT_CALL(mock, GetSize());
  EXPECT_CALL(mock, Describe());
}
```

#### Advanced: Partial Ordering with Multiple Sequences

```cpp
using ::testing::Sequence;
Sequence s1, s2;
EXPECT_CALL(mock, Reset()).InSequence(s1, s2);
EXPECT_CALL(mock, GetSize()).InSequence(s1);
EXPECT_CALL(mock, Describe()).InSequence(s2);
```

This implies `Reset` must be called before both `GetSize` and `Describe`, but `GetSize` and `Describe` can follow in any order.

#### Using `.After()` for DAG-like Order:

```cpp
Expectation e1 = EXPECT_CALL(mock, InitX());
Expectation e2 = EXPECT_CALL(mock, InitY());
EXPECT_CALL(mock, Describe()).After(e1, e2);
```
`Describe()` may only be called after both `InitX()` and `InitY()` are called.

---

### 3. Controlling Expectation Lifetime with `.RetiresOnSaturation()`

By default, expectations remain active and can match multiple calls once saturated, potentially causing failures on additional calls. To prevent this, add `.RetiresOnSaturation()` to automatically deactivate them after their expected calls.

Example:

```cpp
EXPECT_CALL(mock, GetConnection())
    .Times(3)
    .WillRepeatedly(Return(connection))
    .RetiresOnSaturation();
```

This allows three uses of this expectation; after the third call, it retires and no longer matches.

---

### 4. Crafting Custom Actions

Actions specify what happens when a mock method is invoked.

- Basic built-in actions include `Return()`, `ReturnRef()`, `SetArgPointee()`, `DoAll()`, and `Invoke()`.
- For highly custom side effects or behavior, define callable objects (functors or lambdas) with operator() matching the mocked method signature.
- Polymorphic and monomorphic action classes can be written by implementing `ActionInterface`.

#### Simple Lambda Action

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * x; });
```

#### Sequence of Side Effects with Return

```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(DoAll(SetArgPointee<0>(10), Return(true)));
```

#### Calling Provided Callback Argument

```cpp
EXPECT_CALL(mock, DoAsync(_, _))
    .WillOnce(InvokeArgument<1>(true));  // Invokes the 2nd argument
```

---

### 5. Leveraging `ON_CALL` vs. `EXPECT_CALL`

- `ON_CALL` sets the default action when a mock method is called, but does *not* enforce call expectations.
- `EXPECT_CALL` sets both the default action and the *requirement* that the method be called with the specified arguments and count.

Use `ON_CALL` to define general mock behavior applicable to many tests, and `EXPECT_CALL` to set specific call verifications.

---

## Practical Step-by-Step Example

<Steps>
<Step title="Define Mock with Complex Expectations">
Start by creating your mock class with `MOCK_METHOD` declarations for the methods to mock.
</Step>
<Step title="Set Multi-Argument Matcher">
Write an `EXPECT_CALL` with `.With()` to specify an argument relation that depends on multiple parameters.
</Step>
<Step title="Sequence Expectations">
Create one or more `Sequence` objects, then specify `.InSequence()` on each `EXPECT_CALL` to enforce order.
</Step>
<Step title="Use .After() for Partial Order">
If a call must only happen after certain calls, use `.After()` with specific expectations or sets.
</Step>
<Step title="Customize Behavior with Actions">
Provide `WillOnce()` or `WillRepeatedly()` with lambdas or defined actions to simulate desired mock responses.
</Step>
<Step title="Retire Saturated Expectations">
Apply `.RetiresOnSaturation()` to avoid unexpected calls matching saturated expectations.
</Step>
<Step title="Run Tests and Verify">
Run your test case as usual. GoogleMock will verify the order, count, and argument accuracy of mock calls automatically.
</Step>
</Steps>

---

## Best Practices & Troubleshooting

- **Use `.With()` for multi-argument constraints** rather than overly strict per-argument matching.
- **Choose expectations carefully:** Prefer fewer expectations with precise `.With()` clauses over many overlapping expectations.
- **Apply `.RetiresOnSaturation()`** to avoid call count saturation false positives.
- **Use `InSequence` or `Sequence` with `.After()` to express ordering**, especially in scenarios with complex call orders.
- **For custom mock behaviors, prefer lambdas or functors over legacy ACTION macros** for clarity and type safety.
- **Beware of side effects in matchers and actions:** They must be pure functions without modifying program state.
- **If your mock method accepts or returns move-only types,** specify actions via lambdas or callable objects rather than `Return()` with pre-constructed objects.
- **Suppress uninteresting call warnings** by using `NiceMock` if they are known and harmless.

### Common Pitfalls

- Forgetting to set expectations before calling mock methods leads to undefined behavior.
- Overlapping expectations without ordering can cause ambiguous matches and unexpected failures.
- Using `.With()` more than once in an expectation will fail - it must be used at most once and as the first clause.
- Misordering clauses `.Times()`, `.InSequence()`, `.After()`, `.WillOnce()` leads to syntax errors.

### Debugging Tips

- Run tests with `--gmock_verbose=info` to see match selection and argument dumps.
- Use `Mock::VerifyAndClearExpectations(&mock_obj)` to force verification at defined points.

---

## See Also

- [GoogleMock for Dummies Guide](https://google.github.io/googletest/gmock_for_dummies.html) — comprehensive beginner to intermediate introduction.
- [GoogleMock Mocking Reference](reference/mocking.md) — exhaustive details on macros and classes.
- [gMock Cookbook](docs/gmock_cook_book.md) — practical recipes including custom actions.
- [GoogleTest Assertions Reference](reference/assertions.md) — to complement verification techniques.

---

## Summary

This page deep dives into advanced GoogleMock capabilities by showing how to match complex argument conditions with `.With()`, enforce sophisticated call order using sequences and expectation partial orders, and create custom callable actions for rich mock behavior.

Mastering these techniques enables you to write tests that validate real-world interactions in your code with precision and clarity.

---