---
title: "Writing Custom Assertions and Matchers"
description: "Detailed explorations on extending GoogleTest with user-defined assertions and matchers for expressive, reusable tests, with guidance on printing, formatting, and integrating complex test expectations."
---

# Writing Custom Assertions and Matchers

Extending GoogleTest with your own assertions and matchers empowers you to write expressive, reusable tests that provide clear, meaningful feedback. This guide walks you through the techniques for defining custom assertions and matchers, handling printing and formatting, and integrating complex expectations smoothly into your test suites.

---

## 1. Introduction to Custom Assertions and Matchers

GoogleTest offers a rich set of built-in assertions and matchers. Yet, in complex scenarios, you often need to define custom predicates or fine-tuned matching behaviors. Custom assertions and matchers allow you to:

- Encapsulate complex logic in a readable way.
- Generate informative failure messages.
- Reuse the logic across multiple tests.

Before you dive into custom definitions, explore built-in matchers using `[Matchers Reference](reference/matchers.md)` and the `[gMock Cookbook](docs/gmock_cook_book.md)`, which contain practical examples.

---

## 2. Writing Custom Assertions

A *custom assertion* typically returns a `testing::AssertionResult` and allows you to produce detailed error messages.

### 2.1 Basic Pattern of a Custom Assertion

```cpp
#include <gtest/gtest.h>

// Returns a success or failure, with optional message.
testing::AssertionResult IsEven(int n) {
  if ((n % 2) == 0) return testing::AssertionSuccess();
  return testing::AssertionFailure() << n << " is odd";
}

TEST(NumberTest, IsEven) {
  EXPECT_TRUE(IsEven(4));  // Passes
  EXPECT_TRUE(IsEven(5));  // Fails with message "5 is odd"
}
```

### 2.2 Including Success Messages

To add optional success messages, stream additional info to `AssertionSuccess()`:

```cpp
testing::AssertionResult IsEven(int n) {
  if ((n % 2) == 0)
    return testing::AssertionSuccess() << n << " is even";
  return testing::AssertionFailure() << n << " is odd";
}
```

### 2.3 Using in Assertions

You use custom assertions with `EXPECT_TRUE()` or `ASSERT_TRUE()`:

```cpp
EXPECT_TRUE(IsEven(value));
```

Or to fail fatally and stop the current function:

```cpp
ASSERT_TRUE(IsEven(value));
```

---

## 3. Writing Custom Matchers

Matchers can be used inside `EXPECT_THAT()` and GoogleMock expectations to verify argument values with rich failure messages.

### 3.1 Defining Simple Matchers with `MATCHER` Macros

GoogleTest provides easy-to-use `MATCHER` macros defined in `gmock/gmock-matchers.h` for quick matcher creation.

- **`MATCHER(name, description)`** defines a parameterless matcher.
- **`MATCHER_P(name, param, description)`** defines a matcher parameterized on one argument.

#### Example: A Simple Matcher for Even Numbers

```cpp
#include <gmock/gmock.h>

MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

TEST(NumberTest, IsEvenMatcher) {
  EXPECT_THAT(4, IsEven());  // Passes
  EXPECT_THAT(5, IsEven());  // Fails with detailed message
}
```

The empty string in the macro means that the description is auto-generated from the matcher name.

#### Example: Parameterized Matcher

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return (arg % divisor) == 0;
}

TEST(NumberTest, IsDivisibleByMatcher) {
  EXPECT_THAT(10, IsDivisibleBy(5));  // Passes
  EXPECT_THAT(10, IsDivisibleBy(3));  // Fails
}
```

### 3.2 Custom Failure Messages and Explanations

Matchers can stream additional explanation to the `result_listener`:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  if ((arg % divisor) == 0) return true;
  *result_listener << "remainder is " << (arg % divisor);
  return false;
}
```

### 3.3 Using Matchers Within GoogleMock

Matchers are foundational to specifying mock method expectations:

```cpp
EXPECT_CALL(mock, Foo(IsDivisibleBy(3))).Times(2);
```

They help constrain the arguments your mocks accept.

---

## 4. Advanced Custom Matcher Techniques

### 4.1 Implementing Matchers as Classes

For full control and better compiler diagnostics, implement the matcher interface manually:

```cpp
#include <gmock/gmock-matchers.h>

class DivisibleByMatcher {
 public:
  using is_gtest_matcher = void;  // Required marker for gMock

  explicit DivisibleByMatcher(int divisor) : divisor_(divisor) {}

  template <typename T>
  bool MatchAndExplain(T n, std::ostream* os) const {
    if (n % divisor_ == 0) return true;
    if (os) *os << "which is divisible by " << divisor_;
    return false;
  }

  void DescribeTo(std::ostream* os) const { *os << "is divisible by " << divisor_; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is not divisible by " << divisor_; }

 private:
  const int divisor_;
};

inline ::testing::Matcher<int> DivisibleBy(int divisor) {
  return ::testing::MakeMatcher(new DivisibleByMatcher(divisor));
}
```

This approach is more verbose but can improve error reporting and matcher reuse.

### 4.2 Composite Matchers

You can combine matchers logically with `AllOf()`, `AnyOf()`, `Not()`, and others:

```cpp
EXPECT_THAT(x, ::testing::AllOf(::testing::Ge(5), ::testing::Le(10)));
```

Or build your own composite matcher by storing sub-matchers and combining their results.

### 4.3 Polymorphic Matchers

Use polymorphic matchers when they can match multiple argument types. See the source and `MATCHER` macro design for examples.

---

## 5. Using Matchers as Predicates

You can use matchers as predicates in standard algorithms or predicates, via `Matches()`:

```cpp
std::vector<int> v = {1, 2, 3, 4};
EXPECT_EQ(2, std::count_if(v.begin(), v.end(), Matches(::testing::Ge(3))));
```

---

## 6. Custom Assertions vs. Custom Matchers

| Aspect             | Custom Assertions                          | Custom Matchers                        |
|--------------------|-------------------------------------------|--------------------------------------|
| Typical use        | Define pass/fail with messages             | Used inside `EXPECT_THAT` or mock expectations |
| Return type        | `testing::AssertionResult`                  | Boolean result via `MatchAndExplain`|
| Expressiveness     | Synchronous assertion logic                 | Matchers describe expectations and can be composed |
| Diagnostic detail  | Can provide rich failure messages           | Rich failure explanations and can describe negations |

Design your logic to focus on matching semantics when possible for reusability.

---

## 7. Controlling Printing and Descriptions

Good diagnostic messages dramatically improve debugging:

- Implement `DescribeTo()` and `DescribeNegationTo()` in your matcher to explain the expected condition.
- Use the `result_listener` in `MatchAndExplain()` to provide additional details when a match fails.
- Use `PrintToString(value)` to convert values to strings for error messages.

---

## 8. Example: Writing a Custom Matcher for a Struct

Consider matching a struct with multiple fields:

```cpp
struct Point {
  int x, y;
};

MATCHER_P2(EqualsPoint, x_val, y_val, "") {
  if (arg.x == x_val && arg.y == y_val) return true;
  *result_listener << "has x = " << arg.x << ", y = " << arg.y;
  return false;
}

TEST(PointTest, MatchesCorrectly) {
  Point p{3, 5};
  EXPECT_THAT(p, EqualsPoint(3, 5));  // Passes
  EXPECT_THAT(p, EqualsPoint(1, 2));  // Fails, prints actual field values
}
```

This pattern helps keep tests clean and failure diagnostics informative.

---

## 9. Debugging Matchers

When writing complex matchers, verify:

- They are **pure functions** with no side effects.
- The failure message clearly explains why a match failed.
- They handle different value types appropriately.

Use the `--gmock_verbose=info` flag to get detailed mock call traces.

---

## 10. Additional Resources

- [Matchers Reference](docs/reference/matchers.md): Comprehensive list of built-in matchers.
- [gMock Cookbook](docs/gmock_cook_book.md): Practical recipes for defining and using mocks and matchers.
- [Advanced GoogleTest Topics](docs/advanced.md): Deep dive into assertions and testing utilities.
- [Mocking Reference](docs/reference/mocking.md): Detailed use of mock macros including `MOCK_METHOD` and `EXPECT_CALL`.

---

By mastering custom assertions and matchers, you create tests that are easier to write, maintain, and understand â€” making your test suite a powerful ally for ensuring code correctness and quality.

---

# Appendix: Common Patterns

### Using `EXPECT_THAT` with Custom Matchers

```cpp
EXPECT_THAT(value, CustomMatcher(params));
```

### Defining `MATCHER_P` with Custom Description

```cpp
MATCHER_P(IsBetween, bounds, absl::StrCat(negation ? "isn't" : "is", " between", bounds.a, " and ", bounds.b)) {
  return bounds.a <= arg && arg <= bounds.b;
}
```

### Using `With()` clause in Mocks for Argument-wide Matching

```cpp
EXPECT_CALL(mock, Func(_, _)).With(::testing::Lt());
```

Ensures that an entire tuple of arguments satisfies matcher `Lt`.

---

*Happy Testing!*