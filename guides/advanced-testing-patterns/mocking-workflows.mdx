---
title: "Mocking Workflows with GoogleMock"
description: "Explains how to create mock classes, set expectations, and verify behavior using GoogleMock. Covers advanced features like action and matcher customization, and strategies for isolating units under test."
---

# Mocking Workflows with GoogleMock

## Workflow Overview

### Task Description
This guide helps you effectively create mock classes, set expectations, verify mock object behavior, and utilize advanced GoogleMock features such as customized actions and matchers. It also provides strategies to isolate units under test using mocks.

### Prerequisites
- Familiarity with basic C++ and GoogleTest framework
- GoogleMock installed and integrated into your project
- Understanding of interfaces or abstract classes to mock

### Expected Outcome
By following this guide, you will be able to:
- Define mock classes using `MOCK_METHOD`
- Configure expectations and default behaviors using `EXPECT_CALL` and `ON_CALL`
- Customize mock behaviors with actions and matchers
- Use mock wrappers to control mock strictness (`NiceMock`, `StrictMock`, etc.)
- Apply best practices to write maintainable and robust unit tests

### Time Estimate
Approximately 30-45 minutes, depending on prior familiarity with GoogleMock.

### Difficulty Level
Intermediate

---

## Creating Mock Classes

1. **Define Your Mock Class Using `MOCK_METHOD`**

GoogleMock uses the `MOCK_METHOD` macro to generate mock methods in a mock class. The macro signature is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- Place `MOCK_METHOD` declarations in the `public:` section of your mock class, regardless of the access specifier of the base class methods.
- Use qualifiers such as `(const, override)` when mocking `const` or `override` methods.

```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

2. **Handle Types with Commas Properly**

If your return type or parameters include types with unprotected commas (e.g., `std::pair<bool, int>`), wrap them with parentheses or use type aliases:

```cpp
using BoolAndInt = std::pair<bool, int>;

class MockFoo {
 public:
  MOCK_METHOD(BoolAndInt, GetPair, ());
};
```

3. **Mock Overloaded Methods**

Declare each overload explicitly with appropriate signatures and qualifiers. Use `using` to bring base class overloads into scope if you don’t want to mock all variants:

```cpp
class MockFoo : public Foo {
 public:
  using Foo::Add;  // Prevents hiding overloads
  MOCK_METHOD(int, Add, (Element x), (override));
  MOCK_METHOD(int, Add, (int times, Element x), (override));
};
```

4. **Mock Class Templates**

You can mock template classes similarly, using `MOCK_METHOD` inside the template:

```cpp
template <typename Elem>
class MockStack : public StackInterface<Elem> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const Elem& x), (override));
};
```

5. **Mock Non-Virtual Methods**

Mocking non-virtual methods requires creating unrelated mock classes with matching method signatures and using templated dependency injection.

```cpp
class MockPacketStream {
 public:
  MOCK_METHOD(const Packet*, GetPacket, (size_t packet_number), (const));
  MOCK_METHOD(size_t, NumberOfPackets, (), (const));
};
```

Pass `MockPacketStream` as a template parameter for your test code.

6. **Avoid Mocking Concrete Classes Directly**

To ensure better test isolation and maintainability, prefer coding to interfaces, and mock those interfaces rather than concrete classes.

---

## Setting Expectations and Default Behaviors

### `EXPECT_CALL` – Defining Expectations

Use `EXPECT_CALL` to set expectations on mock methods, specifying how many times they should be called, with what arguments, and what actions to take.

```cpp
EXPECT_CALL(mock_object, MethodName(Matchers...))
    .Times(Cardinality)
    .WillOnce(Action)
    .WillRepeatedly(Action);
```

- The matchers specify which arguments to expect, e.g., `_` for any value, `Eq(val)` for exact match.
- Common cardinalities include `Times(1)`, `AtLeast(n)`, `AnyNumber()`.

Example:
```cpp
EXPECT_CALL(turtle, PenDown())
    .Times(AtLeast(1));
```

### `ON_CALL` – Setting Default Method Behaviors

`ON_CALL` defines what happens when a mock method is called but does not set expectations that it must be called:

```cpp
ON_CALL(mock_object, MethodName(Matchers...))
    .WillByDefault(Action);
```

Use `ON_CALL` for default actions and reserve `EXPECT_CALL` for calls you want to explicitly verify.

### Using Matchers for Argument Validation

Matchers allow flexible, expressive argument matching:
- `_` wildcard matches anything
- `Ge(5)` matches arguments >= 5
- Combine matchers using `AllOf()`, `AnyOf()`, `Not()`, etc.

Example:
```cpp
EXPECT_CALL(foo, DoThis(Ge(5)))
    .WillOnce(Return('a'));
```

### Ordering Expectations

To enforce call order, wrap expectations in an `InSequence` object:

```cpp
{
  InSequence seq;
  EXPECT_CALL(foo, FirstCall());
  EXPECT_CALL(foo, SecondCall());
}
```

### Transitioning Between Expectations

Use `.RetiresOnSaturation()` on an expectation to make it inactive after its max call count is reached. This allows subsequent matching by other expectations.

---

## Using Actions to Control Behavior

GoogleMock provides a rich set of actions to customize mock method responses.

### Common Actions
- `Return(value)`: Return a fixed value.
- `ReturnRef(variable)`: Return a reference.
- `ReturnPointee(pointer)`: Return the pointed-to value, evaluated at call time.
- `DoAll(...)`: Perform multiple actions in sequence, return last action's value.
- `Invoke(function)`: Call a function or lambda with the mock method’s arguments.
- `SetArgPointee<N>(value)`: Set the `N`-th output parameter’s pointed-to value.

Example with multiple actions:
```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

### Delegating
- Delegate mock calls to a fake or real object to reuse their implementation.

```cpp
ON_CALL(*this, Method()).WillByDefault([this]() {
  return real_.Method();
});
```

### Invoking Callbacks

Use `InvokeArgument<N>(args...)` to call a callable passed as an argument to the mock method.

```cpp
EXPECT_CALL(mock, DoSomething(_, _))
    .WillOnce(InvokeArgument<1>(5));
```

### Controlling Arguments to Actions

Use `WithArgs<N1, N2>(action)` to apply an action to selected arguments.

### Ignoring Arguments

When defining an action, mark unused arguments as `Unused` to simplify signatures.

### Sharing Actions

Reuse complex action objects by assigning them to variables to avoid redundant construction.

---

## Handling Strictness of Mocks

To control the handling of uninteresting method calls (calls without expectations), GoogleMock provides special mock wrappers:

- **NaggyMock<T>**: Default; prints warnings for uninteresting calls.
- **NiceMock<T>**: Suppresses warnings on uninteresting calls.
- **StrictMock<T>**: Treats uninteresting calls as failures.

These wrappers are template subclasses of your mock class.

### Usage:

```cpp
using ::testing::NiceMock;

NiceMock<MockFoo> nice_foo;
EXPECT_CALL(nice_foo, DoSomething());
// no warnings for uninteresting calls here
```

### Key Points
- Only affects uninteresting calls, not unexpected calls.
- Works only for methods mocked directly in the mock class.
- May require virtual destructors for proper behavior.

---

## Best Practices and Tips

- **Use `ON_CALL` by default** for setting common behavior, and `EXPECT_CALL` sparsely to verify only necessary interactions.
- **Avoid over-specification** to keep tests resilient to implementation changes.
- **Use `NiceMock`** in most cases to suppress noisy warnings.
- **Use sequences and `.RetiresOnSaturation()`** to manage ordered and non-sticky expectations.
- **Delegate to fakes or real objects** to simplify mock behavior when needed.
- **Set expectations before exercising code**; setting expectations after calling mock methods leads to undefined behavior.
- **Mock only virtual methods**, unless intentionally using non-virtual mock patterns.

---

## Troubleshooting

### Common Issues:
- **Uninteresting call warnings:** Use `NiceMock` or add a catch-all `EXPECT_CALL` with `Times(AnyNumber())`.
- **Overloaded methods ambiguity:** Use `using BaseClass::Method` or specify argument matchers explicitly.
- **Compilation errors with complex types:** Wrap complex types in parentheses or use `using` type aliases.
- **Unexpected calls failing tests:** Verify your expectations cover all call cases.
- **Destructor warnings or issues:** Ensure virtual destructors on base interfaces.

---

## Conclusion

Mastering mocking workflows with GoogleMock empowers you to write precise, maintainable, and robust unit tests for C++ projects.

For further depth, explore the following documentation:
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced recipes.
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) for quick reference.
- [Nice, Naggy, and Strict Mocks](https://google.github.io/googletest/api/gmock_nice_strict.html) for deep dive into strictness control.

---

## References

- [Defining and Using Mocks](../api-reference/mocking-apis/defining-mocks.md)
- [Matchers, Actions, and Customization](../api-reference/mocking-apis/matchers-actions.md)
- [Nice, Naggy, and Strict Mocks](../api-reference/mocking-apis/nice-strict-mocks.md)
- [Writing Your First Test](../../getting_started/first_test_run_validation/write_first_test.md)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

---