---
title: "Building Custom Assertions and Matchers"
description: "Extend GoogleTest to fit your domain by crafting bespoke assertion macros and matchers tailored to your data structures and business logic. This page will cover recommended extension points and how to maintain diagnostics clarity."
---

# Building Custom Assertions and Matchers

Extend GoogleTest to fit your domain by crafting bespoke assertion macros and matchers tailored to your data structures and business logic. This page covers recommended extension points, how to implement custom assertions and matchers, and guidance to maintain clarity in test diagnostics.

---

## Understanding the Need for Custom Assertions and Matchers

GoogleTest provides a rich set of built-in assertions and matchers to verify code behavior. However, your domain objects, business rules, or data structures may require specialized checks that are not expressible with the default macros.

By writing custom assertions and matchers, you can:

- Express intent clearly and succinctly in your test code.
- Reduce duplication and boilerplate across tests.
- Generate richer diagnostic messages upon failures.
- Integrate domain-specific validation seamlessly with the GoogleTest framework.

---

## Custom Assertions

### What is a Custom Assertion?

A custom assertion is a function or macro that encapsulates a specific test condition, returning a pass or fail indication with an explanatory message.

### How to Write a Custom Assertion

GoogleTest expects custom assertions to return a `testing::AssertionResult`. The easiest way to create one is to use the factory functions:

- `testing::AssertionSuccess()` to indicate a passed assertion
- `testing::AssertionFailure()` to indicate a failed assertion, optionally streaming detailed failure info

### Example: A Simple Custom Assertion for Even Numbers

```cpp
#include <gtest/gtest.h>

// Checks if a number is even.
testing::AssertionResult IsEven(int n) {
  if (n % 2 == 0) {
    return testing::AssertionSuccess();
  } else {
    return testing::AssertionFailure() << n << " is odd";
  }
}

// Test usage
TEST(NumberTest, EvenCheck) {
  EXPECT_TRUE(IsEven(4));  // Passes
  EXPECT_TRUE(IsEven(5));  // Fails with message: "5 is odd"
}
```

### Best Practices

- Always return `AssertionSuccess()` or `AssertionFailure()`.
- Use streaming (`<<`) to compose descriptive failure messages.
- Keep the assertion logic side-effect free and efficient.
- Return failure messages that help users quickly identify the problem.

---

## Custom Matchers

### What is a Custom Matcher?

Matchers allow expressive expectations on function arguments or values. You can compose matchers naturally with GoogleMock (gMock) and GoogleTest to create human-readable tests.

Custom matchers are classes or using macros that implement match logic and provide descriptive failure messages.

### Writing Custom Matchers with Macros

The simplest approach is to use the `MATCHER` family of macros provided by gMock:

- `MATCHER(name, description) { /* match logic here */ }`
- `MATCHER_P(name, param, description) { /* match logic using param */ }`
- Variants up to `MATCHER_P10` support multiple parameters.

These macros generate robust matchers with minimal boilerplate.

### Example: Custom Matcher to Check Divisibility by a Parameter

```cpp
#include <gmock/gmock.h>

// Matches numbers divisible by `divisor`.
MATCHER_P(DivisibleBy, divisor, "Checks if a number is divisible by divisor") {
  return (arg % divisor) == 0;
}

// Test usage
TEST(NumberTest, Divisibility) {
  EXPECT_THAT(10, DivisibleBy(5));  // Passes
  EXPECT_THAT(7, DivisibleBy(3));   // Fails with message showing unmatched condition
}
```

### Writing Custom Matchers as Classes

For complex scenarios, implement the matcher interface manually.

A matcher class must declare a nested typedef `using is_gtest_matcher = void;` and implement:

- `bool MatchAndExplain(const T& value, std::ostream* os) const` — returns true if matched, prints explanation if `os` is not `nullptr`.
- `void DescribeTo(std::ostream* os) const` — describes expected condition.
- `void DescribeNegationTo(std::ostream* os) const` — describes negated condition.

### Example: Custom Matcher as a Class

```cpp
#include <gmock/gmock.h>

class IsPositiveMatcher {
 public:
  using is_gtest_matcher = void;

  template <typename T>
  bool MatchAndExplain(const T& value, std::ostream* os) const {
    if (value > 0) return true;
    if (os) *os << "which is not positive";
    return false;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is positive";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not positive";
  }
};

inline testing::Matcher<int> IsPositive() {
  return testing::MakeMatcher(new IsPositiveMatcher());
}

// Test usage
TEST(NumberTest, PositiveCheck) {
  EXPECT_THAT(5, IsPositive());  // Passes
  EXPECT_THAT(-3, IsPositive()); // Fails with message
}
```

### Advantages of Using Classes

- Provides more control and type safety.
- Better for reusable library matchers.
- Enables caching or complex state.

### When to Use Which

- Use `MATCHER` macros for quick, simple matchers.
- Use class-based matchers for complex matching logic.

---

## Integrating Matchers with Assertions

GoogleTest's `EXPECT_THAT()` and `ASSERT_THAT()` macros use matchers to validate conditions with rich diagnostics.

Custom matchers integrate seamlessly with these macros.

Example:

```cpp
EXPECT_THAT(value, DivisibleBy(3));
ASSERT_THAT(ptr, testing::NotNull());
```

---

## Custom Assertion Macros

You can wrap common custom assertions in macros for better readability.

Example macro wrapping the earlier even check:

```cpp
#define EXPECT_IS_EVEN(val) \
  EXPECT_PRED_FORMAT1(IsEven, val)
```

Use the predicate-format version (`EXPECT_PRED_FORMAT`) to allow string message streaming.

---

## Writing Predicate-Format Assertions for Rich Diagnostics

Predicate-format functions return `testing::AssertionResult` and take the expression text as arguments, allowing very detailed failure reporting.

Example:

```cpp
testing::AssertionResult IsEvenPredicateFormat(const char* expr, int n) {
  if (n % 2 == 0) return testing::AssertionSuccess();
  return testing::AssertionFailure() << expr << " evaluates to " << n << ", which is odd";
}

// Usage:
EXPECT_PRED_FORMAT1(IsEvenPredicateFormat, value);
```

This approach yields failure messages showing the invoked expression text and values.

---

## Tips and Best Practices

- Keep custom assertions and matchers simple and well-named.
- Include detailed failure information to aid debugging.
- Avoid side effects in assertions and matchers.
- Use streaming to provide helpful failure context.
- Use existing assert and matcher macros to combine conditions.
- Provide negation descriptions (`DescribeNegationTo`) to support negated matchers.

---

## Common Pitfalls

- Failing to return an `AssertionResult` from custom assertions causes compilation issues.
- Neglecting streaming failure messages reduces test diagnostic quality.
- Using complex logic inside assertions or matchers that can fail silently.
- Forgetting to mark complex matchers with `using is_gtest_matcher = void;`.
- Omitting negation descriptions leads to confusing messages for `Not()` wrappers.

---

## Troubleshooting Tips

- If your custom assertion or matcher does not compile, verify function signatures and return types.
- Make sure to include the correct GoogleTest and gMock headers:
  - `#include <gtest/gtest.h>` for assertions
  - `#include <gmock/gmock.h>` for matchers
- Use `EXPECT_PRED_FORMAT` macros when you want to stream custom failure messages.
- To debug matcher failures, run your tests with verbose output (e.g., `--gmock_verbose=info`).

---

## Next Steps & Related Content

- To learn more about writing tests, see [Creating Your First Test](../getting-started-testing/creating-first-test).
- Explore built-in assertions in [Assertions Reference](reference/assertions).
- Deepen your understanding of matchers in [Matchers Reference](reference/matchers).
- For mocking, see [Mocking Reference](reference/mocking).
- For advanced test patterns, explore parameterized tests and fixtures.

---

### References

- [GoogleTest Assertions Reference](reference/assertions)
- [GoogleTest Matchers Reference](reference/matchers)
- [GoogleMock Cookbook](gmock_cook_book.md)
- [GoogleTest Advanced Topics: Custom Assertions](docs/advanced.md#custom-assertions)

---

## Summary

Custom assertions and matchers empower you to tailor GoogleTest to your project’s domain and improve test clarity. Starting with simple predicate functions returning `AssertionResult`, you can quickly create assertions with detailed failure messages. For expressive argument matching in mocks and expectations, leveraging `MATCHER` macros or implementing matcher classes is highly recommended. Use these tools to write maintainable, readable, and diagnostic-rich tests that articulate your domain logic clearly.

---