---
title: "Creating Custom Assertions and Matchers"
description: "Learn how to extend GoogleTest with custom assertion macros and how to write custom matchers in GoogleMock to increase test clarity, expressiveness, and coverage for complex or domain-specific logic."
---

# Creating Custom Assertions and Matchers

GoogleTest provides powerful macros and interfaces that let you extend its assertion and matching capabilities to suit complex or domain-specific testing needs. This guide will show you how to create custom assertion macros in GoogleTest and custom matchers in GoogleMock. Crafting these custom checks will enhance test clarity, improve failure messages, and help test unfamiliar or elaborate logic succinctly.

---

## Overview

### What You Will Learn
- How to define custom assertion macros in GoogleTest.
- How to write custom matchers in GoogleMock using the `MATCHER` macros.
- How to parameterize custom matchers for flexibility.
- Techniques to provide clear, expressive failure messages.

### Prerequisites
- Familiarity with writing basic tests using GoogleTest and GoogleMock.
- Basic experience with macros in C++.
- Understanding of matcher concepts and usage with `EXPECT_THAT`.

### Expected Outcome
By the end of this guide, you will be able to write custom matchers that can be used in your tests using `EXPECT_THAT()` or in mock expectations with `EXPECT_CALL()`. You will also understand how to create custom assertion macros that integrate smoothly with GoogleTest’s reporting system.

### Difficulty Level
Intermediate

---

## Creating Custom Matchers with GoogleMock

GoogleMock offers a family of macros to define custom matchers conveniently. These matchers let you build intuitive, reusable checks that seamlessly work within GoogleMock’s infrastructure.

### Basic Matcher: The `MATCHER` Macro

Define a matcher with the `MATCHER` macro at namespace scope:

```cpp
MATCHER(IsEven, "") {
  // 'arg' refers to the value being matched
  return (arg % 2) == 0;
}
```

- `IsEven` is the matcher name.
- The description string documents what the matcher matches (empty string here).
- The macro expands so you can reference `arg` (the value to verify) and optionally `arg_type`.

#### Using the Matcher

```cpp
EXPECT_THAT(my_value, IsEven());
EXPECT_CALL(mock, DoSomething(IsEven()));
```

If the assertion fails, GoogleMock prints:

```
Value of: my_value
Expected: is even
  Actual: 7
```

### Parameterized Matchers: `MATCHER_P` and Beyond

When you want matchers that take parameters, use `MATCHER_P`:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}
```

Usage:

```cpp
EXPECT_THAT(n, HasAbsoluteValue(10));
```

Gives failure output like:

```
Value of: n
Expected: has absolute value 10
  Actual: -9
```

You can define up to 10 parameters per matcher with `MATCHER_P2`, `MATCHER_P3`, ...

### Customizing Matcher Descriptions

The description string can dynamically describe the matcher behavior, including parameters and the negation state:

```cpp
MATCHER_P2(InClosedRange, low, hi,
  std::string(negation ? "is not" : "is") + " in range [" +
  testing::PrintToString(low) + ", " + testing::PrintToString(hi) + "]") {
  return low <= arg && arg <= hi;
}
```

- When negation is false, the matcher’s description might be "is in range [4, 6]".
- When negation is true, the matcher’s negation description might be "is not in range [4, 6]".

### Using Parameter Types in Matcher Body

Inside the matcher, parameter types are accessible as `<param_name>_type`. For example, if parameter `value` is passed, you can refer to `value_type`.

### Overloading Matchers

You can define multiple matchers with the same name but different parameter counts:

```cpp
MATCHER_P(Blah, a, "") { ... }
MATCHER_P2(Blah, a, b, "") { ... }
```

Users can then choose which to invoke based on their needs.

### Explaining Match Results

To add detailed failure explanations beyond the description, write messages to `result_listener`:

```cpp
MATCHER_P(EqualsLongString, str, "") {
  if (arg == str) return true;

  *result_listener << "the difference: " << DiffStrings(str, arg);
  return false;
}
```

This helps users see why the match failed, especially for complex types.

### Important Notes

- Matchers defined with `MATCHER*` macros must be at namespace scope.
- The type of `arg` is inferred by the compiler, making matchers polymorphic.
- To get more control over types and parameters, consider implementing `MatcherInterface` directly or using `MakePolymorphicMatcher()`, but this requires more work.

---

## Creating Custom Assertion Macros in GoogleTest

While GoogleMock's matchers work well for complex checks, GoogleTest also lets you create your own assertion macros when necessary.

### Predicate Assertions

GoogleTest has macros like `EXPECT_PRED1`, `EXPECT_PRED_FORMAT2`, etc., that let you write custom predicates to assert conditions.

- **Boolean predicate version:** The predicate returns `bool`. GoogleTest prints a default failure message including evaluated arguments.

```cpp
bool IsEven(int n) { return (n % 2) == 0; }
EXPECT_PRED1(IsEven, x);
```

- **Predicate-formatter version:** The predicate returns `AssertionResult` and lets you customize success/failure messages.

```cpp
testing::AssertionResult IsEvenResult(int n) {
  if ((n % 2) == 0) return testing::AssertionSuccess();
  else return testing::AssertionFailure() << n << " is odd";
}
EXPECT_PRED_FORMAT1(IsEvenResult, x);
```

The failure will include your message:

```
Value of: IsEvenResult(x)
  Actual: false (7 is odd)
Expected: true
```

### Defining Custom ASSERT Macros

It’s simplest to write a function or functor that returns an `AssertionResult` and then use the `EXPECT_PRED_FORMATn` or `ASSERT_PRED_FORMATn` macros.

If you prefer, write a macro wrapper that calls these predicates for concise integration.

### Tips for Assertion Messages

- Use streaming (`<<`) to build clear failure messages.
- Return `AssertionSuccess()` with message to get informative success messages if desired.
- Return `AssertionFailure()` with message to explain why a check failed.

### Common Pitfalls

- Avoid side effects inside predicates to ensure arguments are evaluated only once.
- Prefer matchers in complex scenarios, as they provide more readable error reports.

---

## Practical Examples

### Defining a Simple Custom Matcher

```cpp
#include <gmock/gmock.h>

using ::testing::MATCHER;

MATCHER(IsEven, "Checks if a number is even") {
  return (arg % 2) == 0;
}

TEST(MyTest, EvenCheck) {
  EXPECT_THAT(4, IsEven());  // Passes
  EXPECT_THAT(5, IsEven());  // Fails with message "Expected: is even"
}
```

### Parameterized Matcher

```cpp
MATCHER_P(HasSize, size, "Checks if container has specified size") {
  return arg.size() == size;
}

TEST(MyTest, ContainerSize) {
  std::vector<int> v = {1, 2, 3};
  EXPECT_THAT(v, HasSize(3));  // Passes
  EXPECT_THAT(v, HasSize(2));  // Fails
}
```

### Custom Assertion with `AssertionResult`

```cpp
#include <gtest/gtest.h>

testing::AssertionResult IsPositive(int n) {
  if (n > 0) return testing::AssertionSuccess();
  else return testing::AssertionFailure() << n << " is non-positive";
}

TEST(MyTest, PositiveCheck) {
  EXPECT_PRED_FORMAT1(IsPositive, 5);  // Passes
  EXPECT_PRED_FORMAT1(IsPositive, -3); // Fails and prints "-3 is non-positive"
}
```

---

## Troubleshooting & Tips

### Common Issues

- **Matcher not found:** Ensure that your `MATCHER` or `MATCHER_P` is defined at namespace scope and included.
- **Type errors:** Remember `arg_type` in matchers is inferred; your implementation must work for all types used.
- **Unclear failure message:** Use `result_listener` to add detailed failure information.
- **Parameter mismatches:** When using `MATCHER_P2`, `MATCHER_P3`, etc., verify parameters are correctly supplied.

### Best Practices

- Prefer writing reusable matchers over duplicating complex logic.
- Use parameterized matchers to generalize behavior.
- Utilize descriptive failure messages to guide debugging.
- When possible, leverage GoogleMock's `MATCHER` macros instead of hand-crafting full `MatcherInterface` implementations.

---

## Next Steps & Related Content

- Explore [GoogleMock Matchers Reference](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#NewMatchers) for advanced matcher creation.
- Use this knowledge to write expressive expectations in mock objects with `EXPECT_CALL`.
- Review [Advanced GoogleTest Topics](../advanced.md) for customizing predicate assertions.
- Learn about [Parameterized and Typed Tests](../advanced-testing-patterns/parameterized-and-typed-tests.md) to combine with custom matchers for comprehensive coverage.
- Investigate [Assertions Reference](../reference/assertions.md) for all available assertion macros.

---

## Summary

Creating custom assertions and matchers in GoogleTest and GoogleMock empowers you to write clearer, more maintainable tests tailored to your domain logic. Google's `MATCHER` macros facilitate quick matcher creation, enabling detailed, expressive test verification. Complemented by custom predicate assertions in GoogleTest, these tools help produce informative failure messages helping you swiftly identify problems.
