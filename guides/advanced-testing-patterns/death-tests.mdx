---
title: "Writing Death Tests"
description: "Learn to validate fatal error conditions using GoogleTest's death test mechanisms, ensuring your code reacts safely to critical failures. Includes coverage of correct-to-use cases, error output checking, and platform considerations."
---

# Writing Death Tests

Learn to validate fatal error conditions using GoogleTest's death test mechanisms, ensuring your code reacts safely to critical failures. Includes coverage of correct-to-use cases, error output checking, and platform considerations.

---

## Overview

Death tests are designed to verify that your code aborts or terminates as expected under fatal error conditions. These tests ensure that critical failures trigger process termination safely, preventing further damage or undefined behavior.

GoogleTest provides specialized macros and utilities to write death tests that run a piece of code in a subprocess and verify its termination status and error output.

### Why Use Death Tests?

Imagine you have assertions or checks in your code that call `abort()`, `exit()`, or cause fatal signals (like segmentation faults) when encountering invalid states. It's crucial to confirm that these failure paths behave as intended:

- The process terminates (doesn't continue silently).
- The termination is by the right exit status or signal.
- The error output (usually to `stderr`) matches expected error messages.

Death tests let you automate these validations.

---

## Prerequisites

Before writing death tests, ensure:

- You have GoogleTest properly installed and your project configured to link against it.
- Your test binary is invoked with the `--gtest_death_test_style` flag if you want to customize the style (`fast` or `threadsafe`).
- Your environment supports forking or spawning subprocesses (important for death test execution).
- If your code uses exceptions, verify catch-exceptions behavior as death tests trap exceptions to report failures.

Refer to the [Supported Platforms](https://github.com/google/googletest/blob/main/docs/overview/features-integration/supported-platforms.md) and [Prerequisites](https://github.com/google/googletest/blob/main/docs/getting-started/setup-overview/prerequisites-and-requirements.md) for details.

---

## Expected Outcome

By following this guide, you will be able to:

- Write death tests that confirm your code exits or aborts safely on error.
- Use GoogleTest macros like `ASSERT_DEATH()`, `EXPECT_DEATH()`, `ASSERT_EXIT()`, and `EXPECT_EXIT()` correctly.
- Match expected error messages and exit codes with flexible predicates.
- Understand and control death test styles (`fast` vs `threadsafe`).
- Handle platform-specific considerations and common pitfalls.

---

## Time Estimate

Expect to spend approximately 15-30 minutes to get comfortable with writing death tests, including writing initial tests and verifying their behavior.

---

## Difficulty Level

Intermediate: Requires familiarity with GoogleTest basics, subprocess behavior, and assertions.

---

# Writing and Using Death Tests

## 1. Writing a Basic Death Test

Death tests run a statement in a child process, expecting it to terminate the process. You can write tests that assert that your code aborts with a particular error message.

```cpp
TEST(MyDeathTests, AbortsOnInvalidInput) {
  ASSERT_DEATH(
      {
        // Code expected to abort.
        MyFunctionThatAborts(-1);
      },
      "Invalid input");  // Regex to match error message
}
```

- The *statement* inside the macro is executed in a subprocess.
- The second argument is a regular expression (or matcher) that matches the expected output to `stderr`.

## 2. Death Test Macros

GoogleTest provides several macros to write death tests:

| Macro                      | Description                                                       |
|----------------------------|-------------------------------------------------------------------|
| `ASSERT_DEATH(statement, regex)`  | Fails fatally if statement doesn't cause death or output mismatch. |
| `EXPECT_DEATH(statement, regex)`  | Same as above but non-fatal failure, allows the test to continue.  |
| `ASSERT_EXIT(statement, predicate, regex)` | Exits with a given predicate checked on exit status and matches output. |
| `EXPECT_EXIT(statement, predicate, regex)` | Non-fatal version of ASSERT_EXIT.                                  |
| `EXPECT_DEATH_IF_SUPPORTED` / `ASSERT_DEATH_IF_SUPPORTED` | Macros that only run death tests if platform supports it, else warns. |
| `EXPECT_DEBUG_DEATH` / `ASSERT_DEBUG_DEATH`       | Like death macros but active only in debug mode; in opt mode statement runs normally. |

## 3. Matching Exit Status

Use `ASSERT_EXIT`/`EXPECT_EXIT` when you want to precisely check the exit status or signal.

Example:

```cpp
EXPECT_EXIT(MyFunction(), testing::ExitedWithCode(0), "Success");
EXPECT_EXIT(MyFunction(), testing::KilledBySignal(SIGKILL), "Killed");  
```

- `ExitedWithCode(int)` verifies the process exited with the expected status code.
- `KilledBySignal(int)` verifies termination due to a signal (UNIX only).

## 4. Matching Error Output

The second parameter of death test macros (except `EXPECT_EXIT`) is a matcher or regex. It is matched against the child process `stderr` output. GoogleTest treats a raw string as a regular expression to match.

You can use:

- A string regex:

  ```cpp
  EXPECT_DEATH(MyFunc(), "Invalid argument");
  ```

- A `Matcher<const std::string&>` object, including `ContainsRegex()`, for more elaborate matching.

## 5. Using Compound Statements

You can include multiple lines in the death-test statement as a compound statement:

```cpp
ASSERT_DEATH({
  Foo();
  Bar();
  Baz();
}, "expected error");
```

The macro treats the block as a single statement.

## 6. Death Test Styles

GoogleTest supports two styles of death tests:

- **Fast style (`fast`)**: The child process runs the death test immediately after `fork()`. It's fast but not thread safe.
- **Threadsafe style (`threadsafe`)**: The child process re-executes the entire test binary with special flags to run only the death test. Slower but safer with multithreaded tests.

Set the style globally or per test using:

```cpp
GTEST_FLAG_SET(death_test_style, "threadsafe");
```

Note: On Windows, all death tests are threadsafe.

## 7. Platform Considerations

- Thread safety: death tests use `fork()` or process creation that may be unsafe if multiple threads run simultaneously.
- On Linux, `clone()` is used when available to improve safety.
- On Windows and Fuchsia, different mechanisms are used but always threadsafe.
- You must invoke your test binary with a path containing separators rather than just the binary name to ensure threaded death tests run correctly.

## 8. Testing for Exceptions Thrown in Death Tests

Death tests catch exceptions thrown from the statement and treat them as test failures.

```cpp
ASSERT_DEATH(throw std::runtime_error("fail"), "fail");
```

Exceptions escaping the death test macros cause failure.

## 9. Behavior and Side Effects

- Death test statements run in child processes; side effects to memory or variables are local and not seen in the parent process.
- Avoid returning or throwing exceptions inside death test statements; this is considered a failure.
- The output for death tests includes indented `[  DEATH   ]` markers to differentiate it.

## 10. Common Pitfalls and Tips

- Do not place multiple death test macros on the same line; this can cause compilation errors.
- Avoid assertions inside the death test statement that may cause returns or exceptions (such as `ASSERT_` failing).
- Use non-void functions carefully as death test statements.
- When using mocks inside death tests with expected exit codes, allow mock leaks using `Mock::AllowLeak()` due to the process termination aspect.
- Use the `SCOPED_TRACE` macro to attach useful context when invoking death tests in loops or subroutines.

---

# Step-by-Step Instructions

<Steps>
<Step title="Write Your Death Test">
Create a test suite whose name ends with `DeathTest` to avoid thread issues, e.g., `MyDeathTest`.

Then, inside a `TEST` or `TEST_F`, use `ASSERT_DEATH` or `EXPECT_DEATH` with the statement expected to terminate and the expected error message.

```cpp
TEST(MyDeathTest, ShouldAbortOnInvalidValue) {
  ASSERT_DEATH(MyFunc(-1), "Invalid value");
}
```

Verify the regex matches the actual error output.
</Step>

<Step title="Choose Death Test Style">
Decide whether to use `fast` or `threadsafe` style for your tests.

- `fast` is quicker but unsafe with threads.
- `threadsafe` is best for multithreaded environments.

Set style globally in `main()` or per-test:

```cpp
GTEST_FLAG_SET(death_test_style, "threadsafe");
```
</Step>

<Step title="Run and Validate the Test">
Build and run your test executable.

- The test will fork a child process running the statement.
- GoogleTest validates the exit status and stderr output.

On failure, detailed diagnostics will be shown including error messages.
</Step>

<Step title="Check for Common Failures">
If the test fails unexpectedly, inspect:

- Is the statement terminating the process?
- Does the stderr output match the expected regex?
- Are you using any `return` statements or exceptions inside the death test block?
- Ensure no other death test macros are on the same line.
</Step>
</Steps>

---

# Examples

## Example: Simple Death Test

```cpp
TEST(MyDeathTest, FailsOnNullptr) {
  ASSERT_DEATH(MyFunction(nullptr), "Null pointer");
}
```

## Example: Death Test with Exit Code

```cpp
TEST(MyDeathTest, ExitsCleanly) {
  EXPECT_EXIT(MyCleanupFunction(), testing::ExitedWithCode(0), "Cleanup completed");
}
```

## Example: Looping Death Tests with Trace

```cpp
TEST(MyDeathTest, FailsForNegativeInputs) {
  for (int i = -10; i < 0; ++i) {
    SCOPED_TRACE(testing::Message() << "Input: " << i);
    EXPECT_DEATH(MyFunction(i), "Negative input");
  }
}
```

## Example: Conditional Death Test

```cpp
// If death tests not supported, test runs but warns.
EXPECT_DEATH_IF_SUPPORTED(MyFatalFunction(), "Fatal error");
```

---

# Troubleshooting & Tips

### Common Issues

- **Death Test Does Not Detect Process Termination:**
  Ensure the death test statement actually causes process termination via `exit()`, `_Exit()`, `abort()`, or a fatal signal. Use `EXPECT_EXIT` with `ExitedWithCode` if you need to check specific codes.

- **Regex Match Failure:**
  Match against actual `stderr`. Use simple regex to avoid unsupported features. Check for multiline strings carefully.

- **Multiple Death Tests on Same Line:**
  Compile errors happen if multiple death test macros are placed on the same line. Always separate them explicitly.

- **Death Tests and Threads:**
  Forking in multithreaded programs can cause deadlocks or hangs. Use `threadsafe` style or ensure single-threaded context.

- **Mock Leak Detector Failure:**
  When mocking inside death tests and expecting specific exit codes, allow leaks with `Mock::AllowLeak()` to prevent false failures.

### Best Practices

- Name death test suites ending with `DeathTest` for ordering and thread safety.
- Use `ASSERT_DEATH` for critical failures that should abort the test immediately.
- Use `EXPECT_DEATH` when non-fatal failure is acceptable.
- Use `SCOPED_TRACE` extensively in loops or helper functions to get context in failure messages.
- Prefer `threadsafe` death test style unless performance is critical and test environment is single-threaded.

### Platform Considerations

- On Windows, death tests always run in the `threadsafe` style.
- On POSIX, the default is `fast`, but this can be changed.
- Ensure your test binaries are executed with full or relative paths containing separators for `threadsafe` style to work.

---

# Next Steps & Related Content

- Learn more at [Assertions Reference (Death Assertions section)](/docs/reference/assertions.md#death)
- Understand [Death Tests And Threads](https://github.com/google/googletest/blob/main/docs/advanced.md#death-tests-and-threads)
- Explore [Supported Platforms](https://github.com/google/googletest/blob/main/docs/overview/features-integration/supported-platforms.md)
- Refer to the [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) for introductory concepts
- Check out [Advanced Testing Patterns](https://github.com/google/googletest/blob/main/docs/guides/advanced-testing-patterns/parameterized-and-typed-tests.md)

---