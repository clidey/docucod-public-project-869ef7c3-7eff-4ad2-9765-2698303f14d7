---
title: "Isolating Dependencies with Google Mock"
description: "A step-by-step tutorial for mocking interfaces and dependencies in C++ with Google Mock, demonstrating core concepts like EXPECT_CALL, ON_CALL, and mock object lifecycle. Enables users to achieve comprehensive unit isolation."
---

# Isolating Dependencies with Google Mock

A step-by-step tutorial for mocking interfaces and dependencies in C++ with Google Mock, demonstrating core concepts like `EXPECT_CALL`, `ON_CALL`, and mock object lifecycle. This guide enables you to achieve comprehensive unit test isolation by simulating dependencies and verifying interactions precisely.

---

## Table of Contents
- [Introduction and Workflow Overview](#introduction-and-workflow-overview)
- [Creating Mock Classes](#creating-mock-classes)
- [Setting Expectations with EXPECT_CALL](#setting-expectations-with-expect_call)
- [Defining Default Behaviors with ON_CALL](#defining-default-behaviors-with-on_call)
- [Using Sequences and Ordering Calls](#using-sequences-and-ordering-calls)
- [Mock Object Lifecycles and Verification](#mock-object-lifecycles-and-verification)
- [Practical Example: Mocking a Turtle Interface](#practical-example-mocking-a-turtle-interface)
- [Common Pitfalls and Best Practices](#common-pitfalls-and-best-practices)
- [Troubleshooting](#troubleshooting)
- [Next Steps & Additional Resources](#next-steps--additional-resources)

---

## Introduction and Workflow Overview

Google Mock helps you isolate dependencies in unit tests by creating mock objects that mimic the behavior of real dependencies. This guide walks you through the essential steps to mock interfaces and dependencies, enabling you to verify interactions and control behavior for robust, independent tests.

### Prerequisites
- Basic understanding of C++ and virtual interfaces
- GoogleTest and GoogleMock installed and configured

### Expected Outcome
- Define mock classes for dependencies with `MOCK_METHOD`
- Set call expectations using `EXPECT_CALL`
- Define default behaviors with `ON_CALL`
- Control call order with sequences
- Verify whether mock expectations were met automatically or manually

### Time Estimate
Approximately 30 - 45 minutes for complete understanding and practice

### Difficulty Level
Intermediate C++ developers beginning unit testing with mocks

---

## Creating Mock Classes

Mock classes simulate real interface or abstract classes, enabling you to control methods' behaviors and verify their usage.

### Steps:
1. **Derive your mock class** from the interface or abstract base class you wish to mock.
2. **Use the `MOCK_METHOD` macro** in the public section to define each virtual function you want to mock.

### Syntax:
```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(ReturnType, MethodName, (ArgTypes...), (qualifiers));
};
```

For example, to mock a const method:
```cpp
MOCK_METHOD(int, GetSize, (), (const, override));
```

### Dealing with Edge Cases:
- **Commas in argument types** should be wrapped in extra parentheses or use type aliases.
- **Virtual destructor** in the base class is required to avoid undefined behavior.
- Mock methods of **private/protected** base methods must still be declared `public` in the mock.
- **Overloads** must be mocked individually, or exposed using `using` declarations to avoid hidden methods.

### Example:
```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

---

## Setting Expectations with EXPECT_CALL

`EXPECT_CALL` allows you to specify *which methods are expected* to be called on your mock object, with which arguments, how often, in what order, and what actions to undertake when called.

### Key Usage Points:
- Place all `EXPECT_CALL` statements **before** exercising the code that calls the mock.
- If argument values are irrelevant, use wildcard matcher `_` or omit args for non-overloaded methods.
- You can chain clauses after `EXPECT_CALL` to specify behavior:
  - `.Times()` — call count constraints
  - `.WillOnce()` and `.WillRepeatedly()` — specify actions or return values
  - `.InSequence()` — enforce call order inside sequences
  - `.After()` — specify partial call ordering
  - `.RetiresOnSaturation()` — retire expectations when saturated

### Basic Example:
```cpp
using ::testing::Return;
using ::testing::_;

MockTurtle turtle;
EXPECT_CALL(turtle, PenUp()).Times(1);
EXPECT_CALL(turtle, GetX()).WillOnce(Return(100));

// Exercise code
// The test will verify whether PenUp() was called exactly once
// and GetX() returns 100 the first time.
```

### Cardinalities Examples:
| Clause                | Meaning                                  |
|-----------------------|------------------------------------------|
| `Times(0)`            | Method is not expected to be called      |
| `Times(1)` (default)  | Method expected exactly once              |
| `AtLeast(n)`          | Called at least n times                   |
| `Between(m, n)`       | Called between m and n times inclusive   |
| `AnyNumber()`         | Call count not restricted                 |

### Actions Examples:
```cpp
EXPECT_CALL(foo, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```
This means the first call returns 1, second call 2, subsequent calls 3.

### Ordering Calls
- Use `InSequence` or `Sequence` objects to enforce call order (see [Ordering calls](#using-sequences-and-ordering-calls)).

---

## Defining Default Behaviors with ON_CALL

While `EXPECT_CALL` sets an expectation that a method **will** be called, `ON_CALL` defines the default behavior **if** the method is called, but **does not** set an expectation. Use `ON_CALL` for general mock method implementations and use `EXPECT_CALL` to verify specific calls.

### Usage:
```cpp
ON_CALL(mock_object, Method(matchers))
    .With(optional_multi_arg_matcher)
    .WillByDefault(action);
```

- `.With()` is optional
- `.WillByDefault()` **must** be specified once per `ON_CALL`

### Example:
```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(10));
```
This sets the default return to 10 for all calls to `GetX()`, unless overridden by an `EXPECT_CALL`.

### Best Practices:
- Use `ON_CALL` in test fixtures to set common default behavior
- Avoid unnecessary `EXPECT_CALL`s to minimize brittle tests
- Use `ON_CALL` to avoid warnings about "uninteresting calls"

---

## Using Sequences and Ordering Calls

You can specify that certain calls must occur in a particular order or partial order.

### Using `InSequence` Scope:
Wrap your `EXPECT_CALL`s inside a scope with `InSequence` object.

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```
The above requires that `FirstCall()` occurs before `SecondCall()`, but doesn't constrain order relative to calls outside this scope.

### Using Named `Sequence` Objects:
You can create named sequences to define partial orders across different mock objects:
```cpp
Sequence s1, s2;
EXPECT_CALL(foo, A()).InSequence(s1, s2);
EXPECT_CALL(bar, B()).InSequence(s1);
EXPECT_CALL(bar, C()).InSequence(s2);
```
This means that A must be called before B and C, and C before any subsequent calls in sequence s2.

### Using `.After()` Clause:
The `After()` clause lets you specify that one expectation must happen after others.

Example:
```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Process()).After(e1);
```
This means `Process()` call should occur after `Init()`.

---

## Mock Object Lifecycles and Verification

### Automatic Verification
Mocks automatically verify that all expectations are met upon destruction of the mock object.

### Manual Verification
You can manually verify expected calls and clear expectations and default actions:
```cpp
using ::testing::Mock;

Mock::VerifyAndClearExpectations(&mock_obj);
Mock::VerifyAndClear(&mock_obj); // Also clears default actions
```

### Allowing Leaks
If a mock object is intentionally leaked, suppress leak warnings:
```cpp
Mock::AllowLeak(&mock_obj);
```

---

## Practical Example: Mocking a Turtle Interface

Suppose you have a Turtle interface:
```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};
```

### Step 1: Define a mock
```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### Step 2: Set default behaviors
```cpp
MockTurtle mock_turtle;
ON_CALL(mock_turtle, GetX()).WillByDefault(Return(0));
```

### Step 3: Set specific expectations
```cpp
EXPECT_CALL(mock_turtle, PenDown()).Times(1);
EXPECT_CALL(mock_turtle, Forward(100)).Times(1);
```

### Step 4: Exercise your test subject with the mock

### Step 5: Automated verification happens on mock destruction

---

## Common Pitfalls and Best Practices

### Do:
- Use `MOCK_METHOD` in the public section, even for mocking private/protected methods
- Set `EXPECT_CALL` *before* calling the methods being tested
- Use `ON_CALL` for default behavior, `EXPECT_CALL` for verifying calls
- Use sequences and `After()` for reliable call ordering
- Prefer `RetiresOnSaturation()` for expectations with limited call counts

### Don't:
- Don't mock non-virtual methods unless using advanced techniques
- Don't use excessive or overly strict expectations, which cause fragile tests
- Don't set expectations after the code under test has exercised the mock
- Don't ignore uninteresting call warnings—handle them with `ON_CALL` or `NiceMock`

---

## Troubleshooting

### Uninteresting Calls Warning
Google Mock warns when a mock method is called without an `EXPECT_CALL`. To avoid this:
- Add an `ON_CALL` to specify default behavior
- Use `NiceMock` wrapper to suppress warnings

### Unexpected Calls
These occur when `EXPECT_CALL`s are set, but no expectation matches the call:
- Check argument matchers
- Adjust expectations or add catch-all `EXPECT_CALL(...).Times(AnyNumber())`

### Excessive Calls
Mock method called more times than expected:
- Adjust `Times()` clause or add `.RetiresOnSaturation()`

### Call Order Failures
If tests fail ordering expectations:
- Verify correct use of `InSequence` or `After`

### Mock Object Leak Warnings
If you see warnings about leaked mocks:
- Ensure mocks are deleted or use `Mock::AllowLeak()` if safe

---

## Next Steps & Additional Resources

- For detailed API references on mocking primitives, see the [Mocking Reference](reference/mocking.md).
- Learn how to create custom matchers and actions in [Creating Custom Matchers and Actions](/guides/advanced-testing-patterns/custom-matchers-actions).
- Explore writing sophisticated test suites with [Organizing and Scaling Test Suites](/guides/advanced-testing-patterns/test-organization-best-practices).
- Dive deeper into matching arguments with [Argument Matching and Custom Matchers](api-reference/matchers-and-actions/argument-matching).
- Understand assertion utilities in [Assertions and Verification Utilities](api-reference/matchers-and-actions/assertions-and-verification).

---

_Take advantage of GoogleMock’s powerful capabilities to fully isolate your unit tests by mocking dependencies, precisely controlling their behavior, and verifying their interactions with your code under test. This guide provides a strong foundation to start writing effective, reliable mock-based tests in C++._
