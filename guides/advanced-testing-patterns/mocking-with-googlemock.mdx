---
title: "Mocking with GoogleMock"
description: "Practical introduction to creating and using mock objects in C++ tests using GoogleMock, including defining mock classes, setting expectations, and verifying interactions—a must-read for effective interaction-based testing."
---

# Mocking with GoogleMock

## Introduction
This guide provides a practical introduction to creating and using mock objects in C++ tests using GoogleMock. You will learn how to define mock classes, set expectations on mock methods, and verify interactions between your code under test and its collaborators. Mastering these concepts is essential for effective interaction-based testing, which helps you ensure your code interacts with dependencies correctly.

---

## Prerequisites
- Familiarity with C++ and virtual function concepts.
- GoogleTest and GoogleMock libraries installed and properly configured in your development environment.
- Basic understanding of writing unit tests with GoogleTest.

---

## What You Will Achieve
By following this guide, you will be able to:

- Define mock classes easily using `MOCK_METHOD`.
- Set precise expectations on mock methods with `EXPECT_CALL`.
- Specify default behaviors with `ON_CALL`.
- Control the number, order, and parameters of expected calls.
- Use sequences and ordering constraints to specify call order.
- Customize mock behaviors with various actions.
- Improve test robustness by dealing effectively with uninteresting and unexpected calls.

---

## Estimated Time
30 - 45 minutes depending on your familiarity with testing frameworks.

---

## Difficulty Level
Intermediate

---

## Getting Started with Mock Classes

### Defining a Mock Class
A mock class in GoogleMock mimics the interface of an abstract or concrete class you want to test against. Use the `MOCK_METHOD` macro to declare mock methods.

```cpp
#include <gmock/gmock.h>

class Turtle {
 public:
  virtual ~Turtle() = default;
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual void Turn(int degrees) = 0;
  virtual void GoTo(int x, int y) = 0;
  virtual int GetX() const = 0;
  virtual int GetY() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(void, Turn, (int degrees), (override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(int, GetY, (), (const, override));
};
```

**Notes:**
- Always place `MOCK_METHOD` in the `public:` section.
- Add `(override)` to indicate you're overriding a virtual method.
- For `const` methods, specify `(const, override)`.
- For methods with commas in types, use parentheses or typedef aliases (see [Handling Unprotected Commas](#handling-unprotected-commas)).

### Handling Signature Complexity
If your return type or argument types contain commas (e.g. `std::pair<bool, int>`), wrap them in parentheses or use type aliases:

```cpp
class MockFoo {
 public:
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());  // Wrapping return type
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));  // Wrapping argument

  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());  // Using type alias
};
```

### Mocking Overloaded Methods
Mock all overloads explicitly to avoid base class hiding:

```cpp
class Foo {
 public:
  virtual int Add(int x);
  virtual int Add(double x) const;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (double x), (const, override));
  using Foo::Add;  // Bring base class overloads into scope
};
```

---

## Setting Expectations on Mock Methods

### Basic Syntax
Use the `EXPECT_CALL(mock_object, MethodName(matchers))` macro to specify expectations.

```cpp
EXPECT_CALL(mock_turtle, Forward(Ge(100)))  // Expects argument >= 100
     .Times(AtLeast(1))                      // Called at least once
     .WillOnce(Return())                      // Optional action
     .WillRepeatedly(Return());              // Optional repeated action
```

If `Times()` is omitted, GoogleMock infers it based on actions or defaults to once.

### Matchers
Matchers specify argument constraints.

- `_` matches anything.
- Use built-in matchers like `Eq()`, `Ge()`, `Lt()`, etc.
- Use custom matchers for complex validations.

Example:

```cpp
EXPECT_CALL(mock_turtle, GoTo(50, _));  // X must be 50, Y anything
```

### Actions
Actions define what the mock method does when called.

- Default actions return default constructed values if no actions are set.
- Use `WillOnce(action)` for one-time behaviors.
- Use `WillRepeatedly(action)` for repeated behaviors after `WillOnce`s.

Example:

```cpp
EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(100))
    .WillRepeatedly(Return(50));
```

### Ordering of Expectations
By default, expected calls may happen in any order.

To enforce strict order:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock_turtle, PenDown());
  EXPECT_CALL(mock_turtle, Forward(100));
  EXPECT_CALL(mock_turtle, PenUp());
}
```

### Matching Multiple Arguments as a Whole
Use `.With(matcher)` to match arguments collectively.

Example: Expect two arguments where the first is less than the second:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());
```

---

## Common Expectation Clauses

| Clause             | Description                                                 |
| ------------------ | -----------------------------------------------------------|
| `.With(matcher)`   | Match all arguments together as a tuple.                    |
| `.Times(cardinality)` | Specify how many calls are expected.                      |
| `.InSequence(sequences...)` | Expect calls in given sequence(s)                     |
| `.After(expectations...)` | Expect call after specified expectations.                |
| `.WillOnce(action)` | Run this action on one call.                               |
| `.WillRepeatedly(action)` | Run this action on all remaining calls.                  |
| `.RetiresOnSaturation()` | Retire expectation when saturated; useful for reuse.      |

---

## ON_CALL: Setting Default Behavior

`ON_CALL(mock_object, Method(matchers))` sets default behavior without expectation.

Example:

```cpp
ON_CALL(mock_foo, DoThis())
    .WillByDefault(Return(true));
```

The default action is overridden by any matching `EXPECT_CALL` actions.

Remember: each `ON_CALL` **must** specify `.WillByDefault()` exactly once.

---

## Using Sequences and Partial Ordering

### InSequence
Use `InSequence` object to enforce a sequence on all expectations in scope.

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Foo(1));
  EXPECT_CALL(mock, Bar(2));
}
// Foo(1) must happen before Bar(2)
```

### Sequence Objects and `.InSequence()`
Use explicit `Sequence` objects for partial ordering.

```cpp
Sequence s1, s2;
EXPECT_CALL(mock, A()).InSequence(s1, s2);
EXPECT_CALL(mock, B()).InSequence(s1);
EXPECT_CALL(mock, C()).InSequence(s2);
```

This specifies that A() happens before B() and C(), but B() and C() do not have any fixed order.

### After
Use `.After()` to specify that a call should happen after others.

```cpp
Expectation e1 = EXPECT_CALL(mock, InitX());
EXPECT_CALL(mock, InitY());
EXPECT_CALL(mock, Describe()).After(e1);
```

---

## Best Practices and Tips

- **Use `EXPECT_CALL` sparingly**: too many tight expectations make tests fragile.
- **Use `ON_CALL` for default behavior** and reserve `EXPECT_CALL` for interaction verification.
- **Order expectations from general to specific** because later ones override earlier ones.
- **Use sequences or `.After()` carefully** to avoid overly constraining test order.
- **Suppress unwanted warnings with `NiceMock`** if you are not interested in uninteresting calls.
- **Avoid mocking non-virtual methods unless necessary**, consider [mocking non-virtual](docs/reference/mocking.md#MockingNonVirtualMethods).
- **Be careful with complex argument matching** — use `With()`, custom matchers, or save arguments for later verification.

---

## Troubleshooting Common Issues

### Warning: Uninteresting Mock Function Calls
This means a mock method was called but no `EXPECT_CALL` matches it.
- Solution: Use `ON_CALL` to set a default or add an `EXPECT_CALL` with `.Times(AnyNumber())`.
- Use `NiceMock` to suppress these warnings if you don’t want to verify those calls.

### Failing Tests Due to Unexpected Calls
Means calls to mock methods were made that don’t match any `EXPECT_CALL`.
- Verify argument matchers in your expectations.
- Consider adding more general `EXPECT_CALL` rules to catch unexpected calls.

### Mock Methods Not Being Called or Verified
- Ensure that expectations are set *before* the mock methods are called.
- The mock object should be destroyed or verified via `Mock::VerifyAndClearExpectations()` to enforce verification.

### Issues With Overloaded Methods
- Use `using BaseClass::MethodName;` to bring in base overloads in mock.
- Disambiguate calls using `Const()` and explicit matchers.


---

## Extended Example: Defining and Using a Mock Class

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;
using ::testing::AtLeast;

// Interface class
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

// Mock class
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

// Code under test
class Painter {
 public:
  explicit Painter(Turtle* turtle) : turtle_(turtle) {}

  bool DrawLine() {
    turtle_->PenDown();
    turtle_->Forward(100);
    return (turtle_->GetX() == 100);
  }

 private:
  Turtle* turtle_;
};

// UNIT TEST
TEST(PainterTest, DrawLineWorks) {
  MockTurtle mock_turtle;

  // Default behavior (not strictly needed here)
  ON_CALL(mock_turtle, GetX()).WillByDefault(Return(100));

  // Expectations
  EXPECT_CALL(mock_turtle, PenDown()).Times(1);
  EXPECT_CALL(mock_turtle, Forward(100)).Times(1);
  EXPECT_CALL(mock_turtle, GetX()).Times(AtLeast(1));

  Painter painter(&mock_turtle);
  EXPECT_TRUE(painter.DrawLine());
}
```

---

## Useful References
- [GoogleTest Mocking Reference](docs/reference/mocking.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)
- [Legacy gMock FAQ](docs/gmock_faq.md)

---

## Next Steps
- Explore [`EXPECT_CALL`](docs/reference/mocking.md#EXPECT_CALL) modifiers for advanced control.
- Learn custom [Matchers](docs/reference/matchers.md) and [Actions](docs/reference/actions.md).
- Dive into sample tests to see mocks in action.
- Use `NiceMock` or `StrictMock` wrappers for specific uninteresting call policies.
- Understand how to mock move-only types and overloaded methods effectively.

---

## Summary
Mastering mock objects with GoogleMock empowers you to write interaction-focused C++ tests. Define mock classes with `MOCK_METHOD`, set expectations with `EXPECT_CALL`, specify behaviors with `ON_CALL`, and control call ordering and cardinality for precise verification. Leveraging sequences and actions lets you model real-world interaction patterns robustly, enhancing test reliability and clarity.

<Tip>
GoogleMock encourages *interaction-based testing*: instead of just checking outcomes, verify how your code collaborates with its dependencies.
</Tip>

---