---
title: "Testing for Failures and Error Conditions"
description: "Discover death tests, fatal and non-fatal failure strategies, and best practices for validating how code handles error cases. This guide also shows how to use GoogleTest to write assertions about application crashes, exceptions, and error output."
---

# Testing for Failures and Error Conditions

Discover death tests, fatal and non-fatal failure strategies, and best practices for validating how code handles error cases. This guide also shows how to use GoogleTest to write assertions about application crashes, exceptions, and error output.

---

## Overview

In robust software testing, it is vital to confirm that your code correctly handles error states and failure conditions without causing unexpected behavior. This page focuses explicitly on **testing failures and error conditions** using GoogleTest, including the use of **death tests** to assert expected process termination, strategies for catching fatal and non-fatal failures, and best practices for writing assertions that detect crashes, exceptions, and error outputs.

Whether you need to verify that invalid inputs cause your application to abort or that exceptions are thrown and handled as intended, this guide gives you actionable workflows and practical examples.

---

## Prerequisites

Before using this guide, ensure:

- You have [installed GoogleTest](https://github.com/google/googletest/blob/main/getting-started/setup-basics/installation-instructions.md) and integrated it into your C++ project.
- You are familiar with writing basic tests using GoogleTest assertions. See the [Writing Your First Unit Test](../core-testing-workflows/writing-your-first-test.md) guide for a practical introduction.
- Your project is set up to run tests using `RUN_ALL_TESTS()`.

---

## Expected Outcome

By completing this guide, you will be able to:

- Write **death tests** that verify your code terminates as expected on fatal error conditions.
- Distinguish between **fatal** and **non-fatal** failures in your test assertions.
- Catch expected failures inside test code using GoogleTest's special macros.
- Assert that exceptions are thrown or not thrown as expected.
- Validate that error output (e.g., messages printed to `stderr`) meets your expectations.

---

## Time Estimate

Allow approximately **30-45 minutes** to fully grasp the concepts, set up death tests, and try example failure scenarios.

---

## Difficulty Level

Intermediate: Requires comfort with C++ and basic GoogleTest usage.

---

# 1. Understanding Failure Types: Fatal vs Non-Fatal

GoogleTest differentiates assertion failures as **fatal** or **non-fatal**.

- **Fatal failures (ASSERT_*)** immediately abort the current function.
- **Non-fatal failures (EXPECT_*)** allow the function to continue running.

Testing for failure conditions involves using these assertions appropriately to test your code's error handling.

### Example: Non-Fatal vs Fatal Failure

```cpp
TEST(FailureTypesTest, NonFatalAndFatalFailure) {
  EXPECT_EQ(1, 2) << "Non-fatal failure, test continues.";
  ASSERT_EQ(3, 4) << "Fatal failure, test aborts at this point.";
  // The following line will not be executed due to ASSERT_ failure above
  EXPECT_TRUE(false) << "Will not be reached.";
}
```

---

# 2. Writing Death Tests to Validate Crashes and Abortions

## What Are Death Tests?

Death tests verify that given code causes the process to terminate, usually due to a fatal error or assertion failure.

They confirm important invariants such as precondition checks that must *halt* the program immediately on invalid states.

## GoogleTest Death Test Macros

- `EXPECT_DEATH(statement, regex)`: Verifies *statement* terminates the process with stderr output matching *regex*.
- `ASSERT_DEATH(statement, regex)`: Same as EXPECT_DEATH but aborts current function on failure.
- Variants include `EXPECT_EXIT` and `EXPECT_DEBUG_DEATH` for more specific scenarios.

## How to Write a Death Test

Use the macros in a test that calls code expected to kill the process.

Example:

```cpp
TEST(MyDeathTest, DiesOnInvalidInput) {
  EXPECT_DEATH(
      SomeFunctionThatShouldAbort(-1),
      "Error: invalid input");
}
```

The string parameter is interpreted as a regular expression matching the process stderr output.

## Important Tips

- Death tests often involve spawning child processes. Avoid running death tests in multi-threaded tests to reduce flakiness.
- Name your test suites ending with `DeathTest` to prioritize their execution before other tests.
- Avoid placing multiple death tests on the same line to prevent compilation errors.

## Supported Death Test Styles

- **Fast**: The test forks and immediately runs the death statement.
- **Threadsafe**: The test forks and execs a fresh process that runs only the death test. This is safer in multi-threaded environments.

Choose style via the `--gtest_death_test_style` flag, e.g., `fast` or `threadsafe`.

Example to set the style:

```cpp
int main(int argc, char** argv) {
  ::testing::InitGoogleTest(&argc, argv);
  GTEST_FLAG_SET(death_test_style, "threadsafe");
  return RUN_ALL_TESTS();
}
```

---

# 3. Catching Failures and Exceptions Inside Tests

GoogleTest provides utilities to test that certain code causes failures or exceptions, without terminating the entire test process.

## Using `EXPECT_FATAL_FAILURE` and `EXPECT_NONFATAL_FAILURE`

These special macros allow you to catch (within your tests) code segments that generate fatal or non-fatal failures.

### Example: Expecting a Fatal Failure

```cpp
EXPECT_FATAL_FAILURE(ASSERT_TRUE(false), "Expected fatal failure message");
```

This expects the code inside to generate a fatal failure whose message contains the given string.

## Handling Exceptions

If your code uses exceptions, GoogleTest provides:

- `EXPECT_THROW(statement, ExceptionType)`: Asserts the statement throws the specified exception type.
- `EXPECT_NO_THROW(statement)`: Asserts the statement does not throw.
- `EXPECT_ANY_THROW(statement)`: Asserts the statement throws any exception.

Example:

```cpp
EXPECT_THROW({ throw std::runtime_error("fail"); }, std::runtime_error);
EXPECT_NO_THROW({ int x = 1; });
```

Exceptional cases should be tested separately from death tests, as exceptions don't terminate the process.

---

# 4. Best Practices for Writing Failure-Detection Tests

- **Isolate failure tests**: Keep death tests in separate test suites named with the suffix `DeathTest`.
- **Avoid shared fixtures for death and non-death tests**: If you need to share fixture code use aliasing to separate death and regular tests.
- **Avoid returns or exceptions in death test statements**: Statements that return or throw exceptions abort the death test and cause it to fail.
- **Use streaming messages** after assertion macros to add extra diagnostics for complex conditions.
- **Use `SCOPED_TRACE`** to add contextual traces aiding diagnosing failures inside loops or subroutines.
- **Watch for thread interactions**: Death tests are sensitive to multiple threads running; read the guide on [Death Tests and Threads](../advanced.md#death-tests-and-threads) for deeper insight.

---

# 5. Practical Examples

### 5.1 Simple Death Test

```cpp
TEST(DivideByZeroDeathTest, Aborts) {
  EXPECT_DEATH(
      { int x = 1 / 0; },
      ".*divide by zero.*");
}
```

### 5.2 Death Test with Member Function

```cpp
class Foo { public:
  void Crash() { abort(); }
};

TEST(FooDeathTest, CrashAborts) {
  Foo foo;
  EXPECT_DEATH(foo.Crash(), ".*");
}
```

### 5.3 Expecting Exceptions

```cpp
TEST(ExceptionTest, ThrowsRuntime) {
  EXPECT_THROW(throw std::runtime_error("fail"), std::runtime_error);
}

TEST(ExceptionTest, DoesNotThrow) {
  EXPECT_NO_THROW(int x = 5;);
}
```

### 5.4 Catching Expected Failures inside Tests

```cpp
#include "gtest/gtest-spi.h"  // for failure catching macros

TEST(FailureCatchTest, DetectsFatalFailure) {
  EXPECT_FATAL_FAILURE(
      ASSERT_TRUE(false),
      "Expected fatal failure message");
}
```

---

# 6. Troubleshooting & Tips

**Common Issues:**

- **Death Test Not Executing or Hanging:**
  - Ensure your test binary path contains a directory separator (required for `threadsafe` death test style).
  - Confirm no unexpected threads are active before running a death test.
  - Avoid multiple death test assertions on the same source line.

- **Death Test Failures Due to Output Mismatch:**
  - Adjust regex patterns to accurately reflect the expected stderr output.
  - Use simple regex syntax supported by GoogleTest death tests.

- **Exceptions Escaping Death Tests:**
  - GoogleTest treats exceptions escaping death test macros as failures.
  - Enable or disable exception catching with flag `--gtest_catch_exceptions` if debugging.

- **Mock Objects in Death Tests:**
  - Call `Mock::AllowLeak()` for mocks used in death tests to avoid mock leak detector errors.

**Best Practices:**

- Set `--gtest_death_test_style=threadsafe` for stable death tests in multithreaded environments.
- Use `EXPECT_FATAL_FAILURE` and `EXPECT_NONFATAL_FAILURE` for testing helper functions or utility code that is expected to fail.
- Provide meaningful failure messages by streaming extra information with `<<` operator.
- Use `SCOPED_TRACE` to add context for failures inside loops or helper functions.

---

# 7. Next Steps & Related Content

- After mastering failure and death tests, explore [Advanced Assertions and Matchers](../core-testing-workflows/advanced-assertions-and-matchers.md) to write more expressive tests.
- Learn about [Parameterized and Typed Tests](../advanced-testing-patterns/parameterized-tests.md) to scale testing over input values and types.
- For mocking interactions during failure tests, see [Best Practices for Mocking and Stubbing](../mocking-and-test-doubles/best-practices-for-mocking.md).
- If you encounter setup problems, consult [Troubleshooting Installation & Setup](../../getting-started/troubleshooting-and-help/troubleshooting-installation.md).

---

# Reference

- [GoogleTest Assertions Reference](../reference/assertions.md) – details on assertion macros.
- [Death Assertions Section](../reference/assertions.md#death) within the assertions reference.
- [Advanced Guide: Testing for Failures and Error Conditions](../advanced.md#death-tests) (context and examples).

---

# Appendix: Key Macros for Failure and Death Testing

| Macro                     | Description                                           |
|---------------------------|-------------------------------------------------------|
| `EXPECT_DEATH()`           | Test that code terminates with matching error output. |
| `ASSERT_DEATH()`           | Same as EXPECT_DEATH but aborts on failure.           |
| `EXPECT_FATAL_FAILURE()`   | Expect fatal assertion failure inside code block.     |
| `EXPECT_NONFATAL_FAILURE()`| Expect non-fatal assertion failure inside code block. |
| `EXPECT_THROW()`           | Assert a block throws an exception of given type.     |
| `EXPECT_NO_THROW()`        | Assert a block does not throw exceptions.              |
| `EXPECT_ANY_THROW()`       | Assert a block throws any exception.                   |
| `SCOPED_TRACE()`           | Add trace context for debugging failure locations.    |

---

For hands-on examples, browse the [googletest/test/googletest-death-test-test.cc](https://github.com/google/googletest/blob/main/googletest/test/googletest-death-test-test.cc) source file, demonstrating common death test patterns.

---

## Additional Notes

- Death tests spawn subprocesses, so side effects in such code will not propagate to the parent.
- GoogleTest manages failure tracking per-test automatically.
- Failure macro streaming provides powerful diagnostics beyond simple assertions.

By applying this guide, you increase your test suite's robustness by verifying that your code fails safely and as expected under error conditions.
