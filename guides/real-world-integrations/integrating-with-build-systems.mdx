---
title: "Integrating with CMake, Bazel, and Custom Build Systems"
description: "Walkthroughs for adding GoogleTest and GoogleMock to CMake and Bazel projects, with insights on setup, linking, and troubleshooting. Includes tips for portability and working in large or heterogeneous codebases."
---

# Integrating with CMake, Bazel, and Custom Build Systems

## Overview

This guide walks you through integrating GoogleTest and GoogleMock into your build environment using popular build systems such as CMake and Bazel. It covers practical setup steps, linking strategies, and troubleshooting tips, helping you seamlessly add GoogleTest and GoogleMock to your projects while maintaining portability and scalability.

---

## 1. Preparing Your Environment

Before integrating GoogleTest and GoogleMock into your build system:

- **Prerequisites:** Ensure your system meets the minimum requirements, including C++17 support and a compatible compiler. Refer to the [System Requirements & Supported Platforms](https://github.com/google/googletest/tree/main/docs/getting-started/prerequisites-and-installation/system-requirements.md) for details.
- **Source Code:** Acquire the GoogleTest source code, which includes GoogleMock. You can clone the repository:

  ```bash
  git clone https://github.com/google/googletest.git -b v1.17.0
  ```

- **Build Tools:** Install CMake (version 3.13 or later) for CMake builds or Bazel for Bazel integration.

---

## 2. Integrating with CMake

GoogleTest and GoogleMock provide official CMake support that simplifies build integration.

### 2.1. Standalone GoogleTest/GoogleMock CMake Build

Follow these steps to build and use GoogleTest/GoogleMock as a standalone project:

1. **Create a Build Directory:**

   ```bash
   mkdir googletest/build
   cd googletest/build
   ```

2. **Generate Build Scripts:**

   - To build both GoogleTest and GoogleMock (recommended):

     ```bash
     cmake ..
     ```

   - To build only GoogleTest without GoogleMock:

     ```bash
     cmake .. -DBUILD_GMOCK=OFF
     ```

3. **Build the Projects:**

   ```bash
   make
   ```

4. **Install (Optional):**

   ```bash
   sudo make install
   ```

This process compiles the libraries and prepares them for use in your test projects.

### 2.2. Integrating GoogleTest/GoogleMock Into Your Existing Project

Instead of building GoogleTest separately, you can incorporate the source directly into your project's build to ensure consistent compiler and linker flags.

#### Add GoogleTest and GoogleMock as Subdirectories

```cmake
# Add GoogleTest/GoogleMock sources
add_subdirectory(path/to/googletest)

# Your test executable
add_executable(my_tests test1.cpp test2.cpp)

# Link your tests against GoogleTest or GoogleMock main libraries
target_link_libraries(my_tests gmock_main)
```

#### Linking Libraries Explained

- **`gtest`**: GoogleTest core library without `main()`.
- **`gtest_main`**: GoogleTest with a pre-defined `main()` to run tests.
- **`gmock`**: GoogleMock core library (depends on GoogleTest).
- **`gmock_main`**: GoogleMock with the `main()` function.

Use `gmock_main` when writing tests that use mocking; otherwise, use `gtest_main`.

### 2.3. Customizing the Build

- Enable building GoogleMock's own tests by setting `gmock_build_tests` to `ON`.
- The build uses strict warning settings to ensure high code quality.
- The CMake script handles compiler linking concerns, such as those found on Windows or special platforms.

### 2.4. Common Pitfalls & Troubleshooting

- **Linker errors on Windows:** Enable `gtest_force_shared_crt` to match your project's runtime.
- **Missing pthreads:** For Linux/macOS, ensure pthreads are linked, or force with `-DGTEST_HAS_PTHREAD=1`.
- **Macro conflicts:** Use `-DGTEST_DONT_DEFINE_*` flags if GoogleTest macros clash with your code.

<Tip>
For detailed configuration options, see the [GoogleTest README](https://github.com/google/googletest/blob/main/googletest/README.md).
</Tip>

---

## 3. Integrating with Bazel

GoogleTest and GoogleMock offer Bazel workspace rules to ease integration in Bazel-based projects.

### 3.1. Adding GoogleTest and GoogleMock to WORKSPACE

Add the following to your project’s `WORKSPACE` file:

```starlark
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.zip"],
    strip_prefix = "googletest-release-1.17.0",
)
```

### 3.2. Loading and Declaring Dependencies

In your `BUILD` files add dependencies on `@com_google_googletest//googletest` or `@com_google_googletest//googlemock` as needed.

```starlark
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = ["@com_google_googletest//googletest",
            "@com_google_googletest//googlemock"],
)
```

### 3.3. Running Tests with Bazel

Simply run:

```bash
bazel test //path/to:my_test
```

This runs your GoogleTest/GoogleMock tests and reports results in the Bazel CI workflow.

### 3.4. Bazel-Specific Tips

- Use `cc_test` for C++ test targets.
- Maintain source-level visibility by declaring explicit dependencies.
- Take advantage of Bazel's caching for fast incremental builds.

---

## 4. Supporting Custom Build Systems

If you use a build system other than CMake or Bazel, these guidelines help successfully integrate GoogleTest and GoogleMock.

### 4.1. Linking GoogleTest and GoogleMock

- Compile or link against the `gtest` and `gmock` static or shared libraries.
- Link with pthreads as necessary (Linux/macOS).
- If you rely on the provided main() to run tests, link with `gtest_main` or `gmock_main`.

### 4.2. Writing Your Own main()

If your build system or project requires it, write a `main` function like the following:

```c++
#include <gtest/gtest.h>

int main(int argc, char** argv) {
  ::testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

This initializes GoogleTest and runs all registered tests.

### 4.3. Handling Platform Variations

- On Arduino-like platforms (ESP8266, ESP32, NRF52), the entry points differ: use `setup()` and `loop()` instead of `main()`.
- For platforms like QuRT, `argc` and `argv` may be invalid; initialize GoogleTest without them.

Refer to `googletest/src/gtest_main.cc` and `googlemock/src/gmock_main.cc` for platform-specific examples.

### 4.4. Troubleshooting

<AccordionGroup title="Common Build System Issues">
<Accordion title="Linker Errors Related to Duplicate Main()">
Conflicts may arise if multiple `main()` implementations are linked. Only link with one of `gtest_main`, `gmock_main`, or provide your custom `main()`.
</Accordion>
<Accordion title="Missing pthread Symbols">
Ensure you link `-lpthread` on Linux/macOS to avoid unresolved pthread symbols.
</Accordion>
<Accordion title="Macro Naming Conflicts">
Prevent conflicts by using `-DGTEST_DONT_DEFINE_<MACRO>=1` to rename GoogleTest macros.
</Accordion>
</AccordionGroup>

---

## 5. Best Practices & Tips

- Prefer linking with `gtest_main` or `gmock_main` unless you require custom test initialization.
- Use CMake’s built-in support to manage dependencies and installation paths.
- On Windows, use the `gtest_force_shared_crt` option to align runtime libraries.
- Regularly update GoogleTest and GoogleMock to benefit from latest fixes and features.
- Leverage Bazel’s strict dependency model for better build isolation.
- Keep tests independent to ensure reliable results regardless of build environment.

---

## 6. Additional Resources

- [GoogleTest Primer](https://github.com/google/googletest/tree/main/docs/primer.md) — Learn basics of writing tests.
- [GoogleMock README](https://github.com/google/googletest/tree/main/googlemock/README.md) — Understand mocking features.
- [CMakeLists.txt Source](https://github.com/google/googletest/blob/main/googlemock/CMakeLists.txt) — Reference for advanced build configuration.
- [Troubleshooting Build Issues](https://github.com/google/googletest/tree/main/docs/getting-started/support-and-troubleshooting/troubleshooting-setup.md) 

---

Integrating GoogleTest and GoogleMock into your build system ensures you can write, run, and maintain reliable C++ tests efficiently. This guide equips you with the steps, examples, and troubleshooting advice necessary to get started and adapt to your project's environment confidently.
