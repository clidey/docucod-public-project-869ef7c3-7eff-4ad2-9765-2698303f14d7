---
title: "Integrating with Build Systems"
description: "Best practices for organizing and building tests using CMake and Bazel, addressing project structure, dependency management, and scalable integration. Covers key configuration patterns for CI and collaborative development."
---

# Integrating with Build Systems

## Workflow Overview

### Task Description
This guide helps you effectively organize and build your tests using CMake and Bazel build systems. It covers recommended project structures, dependency management best practices, key configuration patterns, and strategies for scalable integration tailored for CI environments and collaborative development.

### Prerequisites
- GoogleTest and GoogleMock source code available locally or accessible via dependency managers.
- Basic familiarity with C++ build systems, especially CMake or Bazel.
- Existing C++ project or test suite you want to integrate automated testing into.
- Installed C++17-capable compiler and standard build tools.

### Expected Outcome
By following this guide, you will be able to:
- Integrate GoogleTest and GoogleMock into your project build pipeline with minimal friction.
- Build and link tests correctly against the framework libraries.
- Use robust and maintainable project layouts that support growth.
- Configure CI-compatible build targets.

### Time Estimate
15â€“30 minutes, depending on existing project complexity and familiarity with the build systems.

### Difficulty Level
Intermediate

---

## Step-by-Step Instructions

### 1. Organize Your Project Structure
- Keep GoogleTest and GoogleMock source code separate but accessible to your build.
- Recommended layouts:
  - Embed GoogleTest/GoogleMock as a git submodule or Download it during build configuration.
  - Use a dedicated `third_party` directory or equivalent for external dependencies.
- Structure tests in their own directory tree to clearly separate them from production code.

### 2. CMake Integration

**A. Standalone GoogleTest Build**
- Clone the repository and create a build directory:
  ```bash
  git clone https://github.com/google/googletest.git -b v1.17.0
  cd googletest
  mkdir build && cd build
  cmake ..
  make
  sudo make install
  ```
- This builds both GoogleTest and GoogleMock by default.

**B. Incorporate GoogleTest Directly Into Your CMake Project**
- Use `add_subdirectory()` to include GoogleTest and GoogleMock into your build:
  ```cmake
  add_subdirectory(path/to/googletest)
  ```
- This ensures compiler settings remain consistent between your code and the test framework.

**C. Download GoogleTest During Configure Using FetchContent**
- Add this snippet in your top-level `CMakeLists.txt`:
  ```cmake
  include(FetchContent)
  FetchContent_Declare(
    googletest
    URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
  )
  set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
  FetchContent_MakeAvailable(googletest)
  ```

**D. Link Your Tests Against GoogleTest/GoogleMock**
- Create test executable targets and link:
  ```cmake
  add_executable(my_test test/my_test.cc)
  target_link_libraries(my_test GTest::gtest_main)  # or GMock::gmock_main
  add_test(NAME my_test COMMAND my_test)
  ```

**E. Use Provided Main Functions**
- Prefer linking with `gtest_main` or `gmock_main` to avoid writing your own `main()` function.
- If custom initialization is needed, implement your own `main()` using `InitGoogleTest()` or `InitGoogleMock()`.

### 3. Bazel Integration

- Add GoogleTest and GoogleMock as dependencies in your `WORKSPACE`:
  ```starlark
  http_archive(
      name = "com_google_googletest",
      urls = ["https://github.com/google/googletest/archive/release-1.11.0.tar.gz"],
      strip_prefix = "googletest-release-1.11.0",
  )
  ```
- In your BUILD files, declare test targets:
  ```starlark
  cc_test(
      name = "my_test",
      srcs = ["my_test.cc"],
      deps = ["@com_google_googletest//:gtest_main"],
  )
  ```

### 4. Manage Dependencies and Build Variants
- Use CMake options such as `BUILD_SHARED_LIBS` or `gtest_force_shared_crt` to match your project runtime linkage
- Use Bazel configuration flags to select debug/release variants
- Keep your test code modular and maintain dependency boundaries

### 5. Configure Continuous Integration
- Ensure the CI build cleans, configures, builds, and runs tests using standardized commands
- For CMake, script automated builds with:
  ```bash
  mkdir build && cd build
  cmake ..
  make
  ctest
  ```
- For Bazel, CI can invoke:
  ```bash
  bazel test //path/to:my_test
  ```
- Enable test filtering or parallel execution as needed

### 6. Verifying Your Setup
- Run a simple test executable and confirm tests execute and report results properly
- Verify that linking to `gtest_main` or `gmock_main` provides the proper entry point
- Confirm header paths, compiler flags, and runtime dependencies are resolved

---

## Examples & Configuration

### Example CMakeLists.txt Snippet
```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject LANGUAGES CXX)

# Fetch GoogleTest
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

# Enable testing
enable_testing()

# Define your test executable
add_executable(my_tests test/my_tests.cc)

target_link_libraries(my_tests
  GTest::gtest_main
  # Add other dependencies here
)

add_test(NAME MyTestSuite COMMAND my_tests)
```

### Example for Custom main() in C++
```c++
#include <gtest/gtest.h>

int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

### Bazel BUILD Example
```starlark
cc_test(
    name = "my_tests",
    srcs = ["my_tests.cc"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

---

## Troubleshooting & Tips

<AccordionGroup title="Troubleshooting Common Issues">
<Accordion title="Linker errors related to runtime library mismatch">
Check if you're mixing dynamic and static CRT linkage, especially on Windows. Use CMake option `gtest_force_shared_crt` to align runtimes.
</Accordion>
<Accordion title="Tests not discovered or failing to run">
Make sure test executables link properly with `gtest_main` or `gmock_main`. Confirm `InitGoogleTest()` or `InitGoogleMock()` is called if you write your own main.
</Accordion>
<Accordion title="Build fails due to missing pthreads">
Ensure that pthreads is available and properly detected by the build system. CMake configures this automatically; with custom scripts, add pthread flags manually.
</Accordion>
</AccordionGroup>

<Tip>
Use CMake's `add_subdirectory()` or FetchContent for seamless integration to avoid incompatibility issues from pre-built binaries.
</Tip>

<Tip>
For Bazel users, keep GoogleTest dependencies updated and pin versions to avoid breakage.
</Tip>

<Warning>
Avoid manually copying GoogleTest source into your project without a proper dependency strategy, as this can cause maintenance headaches and version conflicts.
</Warning>

---

## Next Steps & Related Content

- Proceed to [Writing Your First Unit Tests](/guides/getting-started/writing-your-first-tests) to create tests once your build is set up.
- Explore [Integration & Workflows](/overview/system-architecture-integrations/integration-and-workflows) for advanced CI workflows.
- Review [Installing and Setting Up GoogleTest & GoogleMock](/guides/getting-started/installing-and-setting-up) for detailed build and installation.
- Check out [Mocking Your First Functions](/guides/getting-started/mocking-your-first-functions) to begin using GoogleMock features.


---

## Diagram: CMake Integration Workflow
```mermaid
flowchart TD
  A[Start: Existing C++ Project] --> B[Add GoogleTest Source]
  B --> C{Choose Integration Method}
  C -->|Submodule or local copy| D[Add_subdirectory("googletest")]
  C -->|FetchContent Download| E[Configure FetchContent in CMakeLists.txt]
  D & E --> F[Configure Compiler & Linker Settings]
  F --> G[Define Test Executable Targets]
  G --> H[Link with GTest::gtest_main or GMock::gmock_main]
  H --> I[Run Tests with CTest or Executable]
  I --> J{Tests Passed?}
  J -->|Yes| K[Continue Development]
  J -->|No| L[Fix Issues and Retry]

  classDef decision fill:#f9f,stroke:#333,stroke-width:2px;
  class C,J decision;
```
