---
title: "Mocking Patterns and Best Practices"
description: "Guidance on using GoogleMock for real-world scenarios: defining good mocks, managing expectations, leveraging nice/strict/naggy mocks, and avoiding common pitfalls. Discusses best patterns for test reliability and minimizing mock brittleness."
---

# Mocking Patterns and Best Practices

This guide delivers practical guidance for effectively using GoogleMock in real-world testing scenarios. Learn how to define robust mocks, manage expectations strategically, utilize nice/naggy/strict mock variants appropriately, and avoid common pitfalls to ensure reliable, maintainable tests.

---

## 1. Understanding the Purpose of Mocking

Mocks let you simulate dependencies during testing, allowing you to:

- Verify interactions precisely (e.g., method calls, argument values, call counts).
- Isolate units of code, removing dependencies on external systems.
- Simulate unusual scenarios and error conditions.

**Goal:** Write tests that are reliable, clear in intent, and easy to maintain.

---

## 2. Defining Good Mocks

### 2.1 Mock Class Creation

Use `MOCK_METHOD` macros inside a public section of your mock class to define mocked methods matching the interface you want to mock:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, SetValue, (int v), (override));
};
```

**Best Practices:**

- Always mock `virtual` methods; non-virtual methods require special patterns.
- Include `override` and `const` qualifiers as appropriate.
- Use type aliases or parentheses to handle complex types with commas.
- Put all mock methods in `public` to enable usage of `EXPECT_CALL` and `ON_CALL`.

### 2.2 Mock Behavior and Expectations

- Use `ON_CALL` to define default behavior without expectation of invocation.
- Use `EXPECT_CALL` to set expectations about how and when methods should be called.

Example:

```cpp
ON_CALL(mock_foo, GetValue()).WillByDefault(Return(42));
EXPECT_CALL(mock_foo, SetValue(100)).Times(1);
```

---

## 3. Managing Mock Strictness: Nice, Naggy, and Strict Mocks

GoogleMock offers three mock strictness levels that control how uninteresting calls are handled:

| Mock Type  | Behavior on Uninteresting Calls                | Usage Recommendation                                 |
|------------|-----------------------------------------------|-----------------------------------------------------|
| `NiceMock` | Suppresses warnings, calls pass silently.     | **Default choice**; reduces test brittleness.       |
| `NaggyMock`| Prints warnings on uninteresting calls.       | Useful during test development and debugging.       |
| `StrictMock`| Fails tests on uninteresting calls.           | Use sparingly to enforce strict interaction checks. |

### How to Apply

Wrap your mock types:

```cpp
NiceMock<MockFoo> nice_mock;
NaggyMock<MockFoo> naggy_mock;
StrictMock<MockFoo> strict_mock;
```

**Remember:** These only affect uninteresting calls (no matching `EXPECT_CALL`). Expected calls (`EXPECT_CALL`) always induce errors on mismatch.

---

## 4. Patterns for Reliable Testing and Minimizing Brittleness

### 4.1 Use `ON_CALL` for Default Behavior

- Specify general default behavior for mocks using `ON_CALL` in setup or constructor.
- Avoid adding unnecessary `EXPECT_CALL` on methods you are not interested in testing explicitly.

### 4.2 Use `EXPECT_CALL` Only When Verification Is Needed

- Set expectations only on mock methods that you want to verify (call count, arguments).
- Avoid over-specification that locks down implementation details unnecessarily.

### 4.3 Handle Call Cardinalities Thoughtfully

- Use `Times()` with appropriate cardinalities, such as `Exactly(n)`, `AtLeast(n)`, `AnyNumber()`.
- For calls expected to happen a fixed number of times in sequence, use `.RetiresOnSaturation()` to avoid sticky expectations causing false failures.

Example:

```cpp
EXPECT_CALL(mock, DoThing())
    .Times(3)
    .RetiresOnSaturation();
```

### 4.4 Use Sequences for Ordering Constraints

To enforce call order without over-constraining:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

For more complex partial orderings, use `.InSequence()` with multiple `Sequence` objects or the `.After()` clause.

### 4.5 Avoid Overly Strict Mocks Unless Necessary

Strict mocks can make refactoring harder as every unexpected call fails.

Recommended approach:

- Use `NiceMock` as default.
- Use `NaggyMock` during active test debugging.
- Reserve `StrictMock` for critical interface tests that require rigid verification.

### 4.6 Simplify Complex Interfaces for Easier Mocking

If a method has many parameters or complex types, consider:

- Splitting methods with adapters to reduce arg complexity.
- Writing helper functions or delegating simplified methods in mock to improve readability.

---

## 5. Common Pitfalls and How to Avoid Them

### 5.1 Setting Expectations After Calls (Undefined Behavior)

Always set `EXPECT_CALL` before any code invokes the mocked method.

### 5.2 Overlapping Expectations Shadowing Each Other

Newer `EXPECT_CALL`s override older ones for matching calls. Place specific expectations after catch-all ones.

### 5.3 Forgetting to Make Base Class Destructors Virtual

Ensure all base interfaces have virtual destructors to avoid undefined behavior when deleting mocks.

### 5.4 Missing `.RetiresOnSaturation()` in Repeated Calls

Without `.RetiresOnSaturation()`, overlapping sticky expectations can cause unexpected call failures.

### 5.5 Misusing `ON_CALL` vs `EXPECT_CALL`

`ON_CALL` doesn't check whether a call happens. `EXPECT_CALL` does. Use `EXPECT_CALL` only when call verification is needed.

### 5.6 Ignoring Strictness Modifiers Limitations

`NiceMock`, `NaggyMock`, and `StrictMock` only affect mock methods defined **directly** in the mock class with `MOCK_METHOD`. Methods inherited from base mock classes may not behave as expected.

---

## 6. Practical Usage Examples

### 6.1 Defining a Mock Class

```cpp
#include <gmock/gmock.h>

class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(void, Disconnect, (), (override));
  MOCK_METHOD(std::string, Query, (const std::string& sql), (override));
};
```

### 6.2 Using NiceMock to Suppress Uninteresting Call Warnings

```cpp
using ::testing::NiceMock;
NiceMock<MockDatabase> mock_db;

ON_CALL(mock_db, Connect).WillByDefault(Return(true));

EXPECT_CALL(mock_db, Query("SELECT * FROM users"))
    .Times(1)
    .WillOnce(Return("User1, User2"));

// This won't generate warnings for other calls
mock_db.Connect("some_url");
mock_db.Query("SELECT * FROM users");
```

### 6.3 Enforcing Ordered Calls

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock_db, Connect("db_url"));
  EXPECT_CALL(mock_db, Query("SELECT * FROM config"));
  EXPECT_CALL(mock_db, Disconnect());
}
```

### 6.4 Handling Multiple Call Results

```cpp
EXPECT_CALL(mock_db, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### 6.5 Using `.RetiresOnSaturation()` to Prevent Sticky Expectations Problems

```cpp
using ::testing::Return;

EXPECT_CALL(mock_db, Connect)
    .WillOnce(Return(true))
    .RetiresOnSaturation();
EXPECT_CALL(mock_db, Connect)
    .WillOnce(Return(false))
    .RetiresOnSaturation();
```

---

## 7. Troubleshooting Tips

### Problem: Unexpected uninteresting call warnings

- Verify if you have `EXPECT_CALL`s for all methods you expect to be called.
- Use `NiceMock` to suppress warnings for uninteresting calls.
- Add catch-all expectations with `EXPECT_CALL(mock, Foo(_)).Times(AnyNumber())` if needed.

### Problem: Tests fail due to ordering

- Use `InSequence` or `Sequence` objects to specify call order.

### Problem: Calls returning unexpected values

- Check if you properly set default actions with `ON_CALL` or `WillRepeatedly`.

### Problem: Compilation errors with complex mocks

- Wrap complicated types containing commas in parentheses or use aliases.
- Mock only virtual methods; non-virtual require advanced techniques.

### Problem: Failing to verify all expectations

- Ensure mock objects are destroyed or verified after use.
- Use `Mock::VerifyAndClearExpectations(&mock_obj)` if manual verification is required.

---

## 8. Best Practices Summary

- Mock only virtual methods; define mocks in the public section.
- Use `ON_CALL` for specifying default behavior, `EXPECT_CALL` for expectations.
- Prefer `NiceMock` for everyday use; use `StrictMock` sparingly.
- Set expectations *before* exercising mocks.
- Use `.RetiresOnSaturation()` for sequential expectations.
- Use sequences to enforce call order only when necessary.
- Avoid over-specification to maintain test resilience.
- Name mocks clearly and place their definitions to minimize maintenance overhead.

---

## 9. Additional Resources

- [GoogleMock Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Mocking API Reference](../api-reference/mocking-and-matcher-api/mock-methods-api)
- [Matchers Reference](../api-reference/mocking-and-matcher-api/matchers-api)
- [Controlling Mock Strictness](../api-reference/mocking-and-matcher-api/nice-naggy-strict-mock-api)

---

<Info>
Remember: GoogleMock is designed for ease of use and maintainability in C++. Mock only what you need and aim for clarity over strictness.
</Info>
