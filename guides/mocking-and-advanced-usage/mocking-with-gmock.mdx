---
title: "Mocking Dependencies with GoogleMock"
description: "Step through the fundamentals of mocking in C++ using GoogleMock, including defining and using mock classes, setting expectations, and controlling mock behavior to isolate the code under test. The guide demonstrates key patterns for using mocks to improve test reliability."
---

# Mocking Dependencies with GoogleMock

This guide walks you through the fundamentals of mocking in C++ using GoogleMock. You'll learn how to define mock classes, set expectations on their methods, and control mock behavior to isolate the code under test for reliable and maintainable unit tests. Whether you're new to mocking or refining your approach, this guide provides clear, practical steps to boost your testing effectiveness.

---

## 1. Understanding Mocking and Mock Classes

Mock objects simulate the behavior of real dependencies, allowing you to verify interactions and control responses in tests. GoogleMock simplifies creating mocks for C++ classes and interfaces by generating mock methods automatically.

### Creating a Mock Class

1. Identify the interface or class you want to mock. It must have virtual functions (pure or virtual) to be mockable.
2. Derive a mock class from the interface.
3. Use the `MOCK_METHOD` macro inside the `public:` section of the mock class to declare mocked methods.

**Example:** Mocking a simple interface

```cpp
#include <gmock/gmock.h>

class Database {
 public:
  virtual ~Database() = default;
  virtual bool Connect(const std::string& url) = 0;
  virtual int Query(const std::string& query) = 0;
};

class MockDatabase : public Database {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(int, Query, (const std::string& query), (override));
};
```

<Tip>
Always declare your mock methods `public`, regardless of the access level in the base class. This enables GoogleMock's macros like `EXPECT_CALL` and `ON_CALL` to access them.
</Tip>

### Handling Special Cases

- **Mocking const methods:** Add `(const, override)` as the last parameter.
- **Mocking overloaded methods:** Declare each overload with `MOCK_METHOD` matching the signature precisely.
- **Methods with commas in arguments:** Wrap complicated return types or argument types in parentheses or use type aliases.

Example for overloaded methods:

```cpp
MOCK_METHOD(int, GetValue, (), (const, override));
MOCK_METHOD(int, GetValue, (int key), (override));
```

---

## 2. Setting Expectations on Mock Methods

Expectations specify how you expect your mock methods to be called during the test.

### The EXPECT_CALL Macro

Use `EXPECT_CALL(mock_object, Method(matchers))` to specify that a mock method is expected to be called with arguments matching `matchers`. You can then chain clauses to control call counts and behavior.

```cpp
EXPECT_CALL(mock_db, Connect("localhost"))
  .Times(1)
  .WillOnce(Return(true));
```

### Key Clauses and Their Usage

| Clause               | Purpose                                                        |
|----------------------|----------------------------------------------------------------|
| `.Times(n)`          | Expect the method to be called exactly `n` times.              |
| `.WillOnce(action)`  | Defines an action (e.g., return value) for a single call.       |
| `.WillRepeatedly(action)` | Defines default action for calls after all `WillOnce` calls. |
| `.InSequence(seq)`   | Expects calls in a specific sequence (can be combined).         |
| `.After(expectation)`| Specifies call ordering dependency on other expectations.      |
| `.RetiresOnSaturation()` | Retires the expectation when its max calls are reached.       |

### Common Usage Pattern

```cpp
using ::testing::Return;

EXPECT_CALL(mock_db, Query(_))
    .Times(AtLeast(1))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

This example expects `Query` to be called at least once; the first call returns `42` and all subsequent calls return `0`.

<Tip>
Prefer using matchers instead of concrete values when you don't care about specific arguments, e.g., `_` matches any argument.
</Tip>

---

## 3. Defining Default Behavior with ON_CALL

Sometimes you want to specify how a mock should behave without setting expectations on the calls themselves. Use `ON_CALL` to set default behaviors.

```cpp
ON_CALL(mock_db, Connect(_)).WillByDefault(Return(true));
```

This allows the mock to respond meaningfully but doesn't fail tests if the method is not called.

---

## 4. Controlling Call Order and Cardinality

### Sequencing Calls

Use `InSequence` objects or `.InSequence()` clause to enforce the order of calls.

```cpp
{
  testing::InSequence seq;

  EXPECT_CALL(mock_db, Connect(_));
  EXPECT_CALL(mock_db, Query(_));
}
```

This enforces `Connect` to be called before any `Query`.

### Cardinalities Summary

| Cardinality    | Meaning                                |
|----------------|----------------------------------------|
| `Times(n)`     | Exactly `n` calls                      |
| `AtLeast(n)`   | At least `n` calls                     |
| `AtMost(n)`    | At most `n` calls                      |
| `Between(m,n)` | Between `m` and `n` calls (inclusive) |
| `AnyNumber()`  | Any number of calls                    |

### Retiring Expectations

Use `.RetiresOnSaturation()` when an expectation becomes inactive once saturated. This avoids conflicts when multiple overlapping expectations exist.

---

## 5. Controlling Return Values and Actions

You can specify the behavior of mock methods when called using `WillOnce()` and `WillRepeatedly()` with predefined actions or custom functions.

### Common Actions

- `Return(value)`: Returns a fixed value.
- `ReturnRef(variable)`: Returns a reference.
- `DoAll(...)`: Chains multiple actions.
- `Invoke(callable)`: Calls a function, functor, or lambda.

**Example:** Returning dynamic values

```cpp
EXPECT_CALL(mock_db, Query(_))
    .WillRepeatedly([](const std::string& query) {
      if (query == "SELECT 1") return 1;
      return 0;
    });
```

### Mocking Move-Only Types

GoogleMock supports mocking methods returning or accepting move-only types like `std::unique_ptr`. For return values, prefer lambdas or `WillOnce` with `Return(std::move(...))`.

---

## 6. Best Practices and Tips

- **Use ON_CALL for default behaviors**: Only use `EXPECT_CALL` for methods you want to verify calls on.
- **Avoid over-specifying expectations**: Overly strict expectations cause brittle tests.
- **Use sequences sparingly**: Only when call order matters exactly.
- **Retire sticky expectations**: Use `.RetiresOnSaturation()` for expectations that should no longer be matched after fulfillment.
- **Suppress uninteresting call warnings**: Use `NiceMock` to suppress warnings; use `StrictMock` to turn warnings into errors.

---

## 7. Troubleshooting Common Issues

### Unexpected Method Calls

If a mock method is called without a matching `EXPECT_CALL`, GoogleMock reports an error or warning. Use `ON_CALL` to provide default behavior or add a catch-all `EXPECT_CALL` with `.Times(AnyNumber())`.

### Mock Method Not Being Called

Ensure that:

- You have set the expectation *before* exercising your code.
- The mock object is correctly injected or passed to the code under test.
- Matchers in `EXPECT_CALL` correctly represent the arguments passed at runtime.

### Compilation Errors with `MOCK_METHOD`

- Check method signatures for const, noexcept, and ref qualifiers.
- For argument types with commas, wrap them in parentheses or use type aliases.

### Mock Class Destructor

Ensure the base interface has a **virtual destructor** to avoid leaks and undefined behavior when deleting mock objects.

---

## 8. Next Steps & Related Content

- Explore **[Writing Your First Test](getting-started/first-test-usage/write-first-test.mdx)** to integrate mocks with tests.
- Learn advanced **Matchers** and **Actions** to customize expectations.
- Review **Mocking Best Practices** in the [gMock Cookbook](docs/gmock_cook_book.md).
- See **[Strictness Modes](api-reference/mocking-api/strictness-modes.mdx)** for controlling mock behavior rigorously.

---

## References

- [GoogleMock Reference - MOCK_METHOD, EXPECT_CALL, ON_CALL](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking API Overview](https://google.github.io/googletest/api/gmock_main.html)

---

This guide positions you to confidently mock dependencies in C++ using GoogleMock, enabling precise, flexible, and maintainable tests.
