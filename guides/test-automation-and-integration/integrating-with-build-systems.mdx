---
title: "Integrating with CMake and Bazel"
description: "Practical steps for integrating GoogleTest and GoogleMock with CMake and Bazel, including best practices for project setup, dependency management, and build configuration."
---

# Integrating with CMake and Bazel

## Overview

This guide delivers practical, step-by-step instructions to integrate GoogleTest and GoogleMock within projects using **CMake** and **Bazel** build systems. It focuses on project setup, dependency management, and build configuration specifically related to incorporating these testing frameworks efficiently and correctly.

Whether you are starting a new C++ project or integrating tests into an existing one, this guide will help you streamline your build setup for seamless test development and execution.

---

## Prerequisites

Before beginning integration:

- Ensure your development environment supports **C++17** or later.
- Have either **CMake** (minimum version 3.13 for GoogleMock, 3.14+ for FetchContent) or **Bazel** installed and configured.
- Familiarize yourself with basic concepts of GoogleTest and GoogleMock. Relevant foundational documents include the [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) and [GoogleMock Tutorial](https://github.com/google/googletest/blob/main/googlemock/README.md).

---

## Expected Outcome

By following this guide, you will be able to:

- Build and link GoogleTest and GoogleMock with your C++ projects using CMake or Bazel.
- Manage dependencies cleanly within your build files.
- Configure test targets for smooth test compilation and automated execution.

---

## Time Estimate

Integration setup typically takes about 15-30 minutes depending on familiarity with CMake or Bazel.

---

## Difficulty Level

Intermediate: Requires basic knowledge of C++ build systems and familiarity with GoogleTest and GoogleMock.

---

# Integrating with CMake

### 1. Standalone or Embedded Build

GoogleTest and GoogleMock can be:

- Built and installed as standalone projects.
- Incorporated as subdirectories in your project using CMake `add_subdirectory()`.

### 2. Using FetchContent (Recommended for Modern CMake)

CMake's `FetchContent` is the most robust way to integrate GoogleTest and GoogleMock sources directly.

**Example CMakeLists.txt snippet:**

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/release-1.17.0.zip
)
# This is required for Windows to avoid runtime conflicts
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test_main.cpp my_test.cpp)
target_link_libraries(my_tests PRIVATE gtest_main gmock)
add_test(NAME my_tests COMMAND my_tests)
```

**Key points:**

- This downloads, builds, and links GoogleTest and GoogleMock automatically.
- `gtest_main` library provides a default `main()` function for running tests; link it unless you provide your own.
- Using `add_test` with `ctest` integrates tests into CMake's testing system.


### 3. Manual Subdirectory Inclusion

Alternatively, copy the googletest and googlemock directories into your source tree and add:

```cmake
add_subdirectory(path/to/googletest)
add_executable(my_tests test_main.cpp my_test.cpp)
target_link_libraries(my_tests PRIVATE gtest_main gmock)
add_test(NAME my_tests COMMAND my_tests)
```

### 4. Link Libraries

Link your test executable against the libraries `gtest_main` and `gmock`:

- `gtest_main` includes the required `main()` for running tests.
- If you need a custom `main()`, link with `gtest` and/or `gmock` instead and provide your own function.

### 5. Configuring Tests

Use `add_test()` to register test executables with CTest:

```cmake
add_test(NAME MyTestSuite COMMAND my_tests)
```

This enables `ctest` or IDE integrations to discover and run your tests seamlessly.

---

## Best Practices for CMake Integration

- Use `FetchContent` for modern, flexible management of GoogleTest and GoogleMock.
- Ensure consistent compiler flags and C++ standards across GoogleTest and your project.
- Prefer building GoogleTest in a hermetic way with strict compiler settings to catch warnings and errors early.
- Avoid linking static and shared versions inconsistently.
- When using Windows, confirm `gtest_force_shared_crt` is enabled if your project uses dynamic runtime.
- Build tests separately from production code to optimize build times.

---

# Integrating with Bazel

### 1. Workspace Setup

In your `WORKSPACE` file, fetch GoogleTest and GoogleMock from the official GitHub repository:

```python
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.tar.gz"],
    strip_prefix = "googletest-release-1.17.0",
)
```

### 2. Load GoogleTest and GoogleMock Rules

Make sure `@com_google_googletest//:bazel` is loaded (the exact details depend on version but generally the `BUILD` files are provided).

### 3. Define Test Targets

In your `BUILD` file for your tests:

```python
cc_test(
    name = "my_test",
    srcs = ["my_test.cpp"],
    deps = [
        "@com_google_googletest//:gtest",
        "@com_google_googletest//:gmock",
    ],
)
```

- `cc_test` defines a test executable.
- `deps` includes GoogleTest and GoogleMock libraries.

### 4. Using `gmock_main` Equivalent

Bazel’s GoogleTest integration typically includes `gtest_main` and `gmock_main` targets. Link against `:gmock_main` to use the standard test runner main function.

### 5. Running Tests

Use Bazel command:

```
bazel test //path/to:test_target
```

to build and run your tests.

---

## Best Practices for Bazel Integration

- Use fixed release URLs for stable dependencies.
- Keep dedicated test targets separate from production build targets.
- Utilize Bazel’s test caching and parallel execution features.
- Refer to official Bazel GoogleTest integration documentation for updates and platform specifics.

---

# Troubleshooting & Tips

### Common Issues

- **Linker errors**: Verify you link against both `gtest` and `gmock` (or `gmock_main` if using standard main). Check symbol definitions.
- **Test discovery failures**: In CMake, `add_test()` must be correctly invoked. In Bazel, use `cc_test` targets.
- **Runtime initialization errors**: Always call `testing::InitGoogleMock(&argc, argv);` or use `gmock_main` library for automatic initialization.
- **Conflicting runtime libraries (Windows)**: Use `gtest_force_shared_crt` in CMake to align runtime linkage.

### Best Practices

- Use the `gmock_main` library or target unless customization of `main()` is essential.
- Keep GoogleTest and GoogleMock versions aligned to avoid ABI problems.
- Prefer isolated test binaries to avoid test pollution and improve reliability.

### Performance Considerations

- In CMake builds, consider building GoogleTest and GoogleMock as shared libraries for incremental compile speed improvement.
- Use CTest’s parallel execution features.
- In Bazel, leverage caching and incremental builds.

---

# Advanced Configuration

### Customizing Test Binaries

- Provide your own `main()` if you need initial setup or custom GoogleTest/GMock flag handling.
- When writing your own `main()`, initialize tests with:

```c++
int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

- Avoid calling `RUN_ALL_TESTS()` multiple times.

### Handling Platform Specifics

- On ARM-based or embedded platforms, verify support in latest versions.
- Confirm threading support (`-pthread` flags) when building on Linux/macOS.

---

# References & Further Reading

- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) — basics of writing and running tests.
- [GoogleMock README](https://github.com/google/googletest/blob/main/googlemock/README.md) — introduction to mocking.
- [CMake Integration README](https://github.com/google/googletest/blob/main/googletest/README.md#building-and-running-tests) — details on building with CMake.
- [GoogleTest GitHub Repo](https://github.com/google/googletest)
- [Bazel C++ Testing](https://docs.bazel.build/versions/master/be/c-cpp.html#cc_test) — documentation of Bazel test rules.

---

For more comprehensive build and system requirements, consult the [Supported Platforms & Requirements](../overview/adoption-and-integration/supported-platforms-and-requirements) documentation.

---