---
title: "Integrating GoogleTest with Build Systems"
description: "Comprehensive guidance on adding GoogleTest to CMake, Bazel, and other popular build systems. Includes strategies for dependency management, test discovery, and platform-specific considerations."
---

# Integrating GoogleTest with Build Systems

## Overview
This guide provides practical, step-by-step instructions to integrate GoogleTest into popular build systems such as CMake and Bazel, helping you manage dependencies, enable automatic test discovery, and handle platform-specific build considerations. Whether you are adding GoogleTest to a new project or incorporating it into an existing build, this documentation equips you with concrete strategies and examples to get your tests compiling and running efficiently.

---

## Prerequisites
- Familiarity with your chosen build system (e.g., CMake or Bazel).
- A C++17 compatible compiler environment.
- Basic understanding of GoogleTest concepts (tests, test suites, fixtures).

---

## Expected Outcome
By following this guide, you will:
- Integrate GoogleTest libraries and headers into your build.
- Configure your build system for test compilation and linking.
- Enable automatic test discovery and execution.
- Manage dependencies and platform-specific build flags.

---

## Time Estimate
Approximately 30 to 60 minutes depending on your build system’s complexity and familiarity.

---

## Difficulty Level
Intermediate

---

## 1. Integrating GoogleTest with CMake

### 1.1. Standalone GoogleTest Build
If you want GoogleTest as a separate dependency, follow these steps:

1. Clone the repository or download the source:

```bash
git clone https://github.com/google/googletest.git -b v1.17.0
dcd googletest
mkdir build && cd build
```

2. Generate native build scripts:

- To build **both GoogleTest and GoogleMock** (default):

```bash
cmake ..
```

- To build **only GoogleTest** (exclude GoogleMock):

```bash
cmake .. -DBUILD_GMOCK=OFF
```

3. Build the libraries using your local build tool (e.g., `make` on Unix):

```bash
make
```

4. Optionally, install:

```bash
sudo make install
```

This will generally install headers and libraries to `/usr/local`.

### 1.2. Adding GoogleTest to Your CMake Project

You have two main options to include GoogleTest headers and libraries:

#### a) Find Installed GoogleTest
If installed system-wide, link using `find_package`:

```cmake
find_package(GTest CONFIG REQUIRED)

add_executable(my_tests test_main.cpp test_foo.cpp)
target_link_libraries(my_tests GTest::gtest GTest::gtest_main)
```

#### b) Build GoogleTest as Part of Your Project Using `add_subdirectory`
Provides better compatibility regarding compiler and linker flags.

```cmake
# Assume googletest cloned inside your project's 'third_party' directory
add_subdirectory(third_party/googletest)

add_executable(my_tests test_main.cpp test_foo.cpp)
# Link with gtest_main for automatic main()
target_link_libraries(my_tests gtest_main)
```

### 1.3. Key Configuration Details

- **Thread Support:** If your environment supports pthread, CMake will link relevant libraries automatically. If not detected, set `-DGTEST_HAS_PTHREAD=0` or `1` as needed.
- **Shared vs Static Libraries:** Use the `BUILD_SHARED_LIBS` CMake option to build GoogleTest as shared or static libraries. This impacts linking.
- **Runtime Library Compatibility on Windows:** Use `-Dgtest_force_shared_crt=ON` to align GoogleTest runtime linkage with your project and avoid linker mismatches.

### 1.4. Example Simple CMakeLists.txt
```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Include GoogleTest
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/5376968f6948923e2411081fd9372e71a59d8e77.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test_main.cpp test_code.cpp)

target_link_libraries(my_tests gtest_main)

# Enable testing via CTest
enable_testing()
add_test(NAME my_tests COMMAND my_tests)
```

---

## 2. Integrating GoogleTest with Bazel

### 2.1. Adding GoogleTest as a Bazel Dependency
GoogleTest can be added by referencing it from an external workspace, or by vendoring the source.

Example `WORKSPACE` snippet:
```python
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.zip"],
    strip_prefix = "googletest-release-1.17.0",
    sha256 = "..."  # Use the actual SHA256 hash here
)
```

### 2.2. Using GoogleTest in BUILD Files
Set dependencies on the `@com_google_googletest` targets.

```python
cc_test(
    name = "my_test",
    srcs = ["my_test.cc"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

### 2.3. Notes
- Bazel’s test runner automatically discovers and runs tests labeled as `cc_test`.
- GoogleMock is included by default if you depend on `gmock_main`.

---

## 3. Handling Platform and Build Considerations

### 3.1. Platform-Specific Notes
- Windows users should be cautious about runtime library mismatches; CMake option `gtest_force_shared_crt` mitigates this.
- On Unix-like systems, make sure to link pthread when using multithreaded code or GoogleTest with thread support.

### 3.2. Managing Dependencies
- GoogleTest recommends using the same compiler and C++ standard as your project to avoid ABI issues.
- If you manually integrate GoogleTest, ensure header include paths and linking order are correct.

### 3.3. Using gtest_main vs Writing Your Own `main()`
- Linking against `gtest_main` or `gmock_main` provides a default `main()` function that initializes and runs all tests.
- Write your own `main()` only when you need custom initialization:

```cpp
int main(int argc, char** argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

---

## 4. Automating Test Discovery & Execution

- GoogleTest automatically registers all tests declared with `TEST()` and `TEST_F()` in the build.
- Running your test executable will discover tests and provide a summary report.
- Use CMake’s `enable_testing()` and `add_test()` or Bazel’s `cc_test` target to hook into your build system’s test runners.

---

## 5. Troubleshooting and Best Practices

### Common Issues and Solutions
- **Linker errors:** Verify linking order and that you link `gtest`, `gtest_main`, `gmock`, or `gmock_main` as appropriate.
- **Header not found:** Ensure `include_directories` or target include directories include GoogleTest headers.
- **Runtime mismatches:** Use consistent compiler flags and C++ standard versions.
- **Test execution not starting:** Confirm `InitGoogleTest` is called before `RUN_ALL_TESTS()`.

### Best Practices
- Prefer embedding GoogleTest into your project build (e.g., `add_subdirectory`) to avoid ABI incompatibilities.
- Use `gtest_main` or `gmock_main` libraries for ease of setup.
- For large projects, use FetchContent or git submodules to manage the GoogleTest dependency cleanly.
- Regularly update GoogleTest versions in your dependency manifests to benefit from fixes and enhancements.

---

## 6. Summary
Integrating GoogleTest with build systems revolves around correctly configuring library and header dependencies, managing platform-specific build options, and leveraging your build system’s test discovery capabilities. This includes standalone building, embedding sources, linking with `gtest_main` or `gmock_main`, and ensuring tests run smoothly in diverse environments.

---

## References
- [GoogleTest Primer](../primer.md)
- [Testing Reference: Writing and Running Tests](../reference/testing.md)
- [GoogleMock CMakeLists.txt](googlemock/CMakeLists.txt)
- [GoogleTest README: Generic Build Instructions](googletest/README.md)
- Official CMake Documentation: <https://cmake.org/cmake/help/latest/>
- Bazel documentation: <https://docs.bazel.build/>

---

## Example: Typical CMake Build Setup
```cmake
cmake_minimum_required(VERSION 3.14)
project(ExampleProject)

# Fetch GoogleTest
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/release-1.17.0.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_tests test_main.cpp my_code.cpp)

# Link to GoogleTest libraries
# gtest_main provides main() implementation
target_link_libraries(my_tests gtest_main)

enable_testing()
add_test(NAME MyTests COMMAND my_tests)
```

---

## Example: Custom main() Usage
Sometimes you need to customize initialization:

```cpp
#include <gtest/gtest.h>

int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  // Custom setup code here
  return RUN_ALL_TESTS();
}
```


---

This guide focuses on build system integration and dependency management; for writing tests and assertions, see the dedicated GoogleTest [Primer](../primer.md) and [Testing Reference](../reference/testing.md) pages.
