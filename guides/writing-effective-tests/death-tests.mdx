---
title: "Using Death Tests for Error Handling"
description: "Learn how to employ GoogleTest's death tests to verify that code exits or fails as expected under certain conditions. Includes practical examples and advice for safe, effective usage."
---

# Using Death Tests for Error Handling

This guide explains how to use GoogleTest's death tests to verify that your C++ code terminates as expected under specific error or failure conditions. Death tests are essential to ensure that code paths which intentionally abort or exit due to fatal errors behave correctly and produce the desired diagnostic output.

---

## 1. Understanding Death Tests: The Workflow Overview

### What This Page Covers
- **What is a death test?** A test that verifies your code causes the process to terminate (e.g., via `abort()`, `exit()`, or fatal errors).
- **When and why to write death tests?** To confirm assertions and error-handling code correctly stop execution with expected messages.
- **Practical examples** demonstrating how to write effective death tests using GoogleTest macros.
- **Best practices and known pitfalls** to help you write safe, maintainable death tests.

### Prerequisites
- Familiarity with C++ unit testing basics using GoogleTest.
- GoogleTest installed and configured in your project.
- Basic understanding of assertions and test fixtures.

### Expected Outcome
After completing this guide, you will confidently write death tests that:
- Detect whether specific code aborts or exits your program.
- Check for expected exit codes and error messages.
- Handle multithreading considerations and platform specifics.

### Time Estimate
15–30 minutes to understand concepts and implement your first death test.

### Difficulty Level
Intermediate

---

## 2. Writing and Running Death Tests: Step-by-Step Instructions

### Step 1: Identify Code That Should Cause Process Termination
Determine the parts of your code that are designed to fail fatally, such as:
- Failed assertions
- Explicit calls to `abort()`, `_Exit()`, or `exit()`
- Fatal error handling callbacks

### Step 2: Choose the Appropriate Death Test Macro
GoogleTest provides multiple macros for death tests:

| Macro               | Purpose                                              |
|---------------------|------------------------------------------------------|
| `ASSERT_DEATH`       | Fatal assertion if the code does not terminate       |
| `EXPECT_DEATH`       | Non-fatal expectation of termination                 |
| `ASSERT_EXIT`        | Check for specific exit codes and messages           |
| `EXPECT_EXIT`        | Non-fatal form of `ASSERT_EXIT`                       |
| `EXPECT_DEATH_IF_SUPPORTED` | Conditional use based on platform support            |
| `EXPECT_DEBUG_DEATH` | Like `EXPECT_DEATH` but only triggers in debug mode  |

> **Tip:** Use `ASSERT_*` macros when further execution after failure is unsafe.

### Step 3: Write the Death Test Code
Use a syntax similar to this example:

```cpp
TEST(ErrorHandlingDeathTest, FailsWithInvalidInput) {
  EXPECT_DEATH(
      SomeFunctionThatExplodes(-1),
      "Invalid input detected");  // regex matching stderr output
}
```

- The first parameter is the **statement** expected to cause death.
- The second parameter is a **matcher or regex** that matches the expected error message output to `stderr`.

You can also use compound statements:

```cpp
ASSERT_DEATH({
  Initialize();
  TriggerFatalError();
}, "Expected error message pattern");
```

### Step 4: Customize Exit Code Checks (Optional)
If you need to assert on the exact exit code or signal, use `ASSERT_EXIT` or `EXPECT_EXIT` with predicates:

```cpp
using ::testing::ExitedWithCode;
using ::testing::KilledBySignal;

TEST(MyDeathTest, ExitsWithZeroCode) {
  EXPECT_EXIT(NormalExit(), ExitedWithCode(0), "Success");
}

TEST(MyDeathTest, KilledBySIGKILL) {
  EXPECT_EXIT(KillProcess(), KilledBySignal(SIGKILL), "Sending unblockable signal");
}
```

### Step 5: Follow Naming Convention for Test Suites
Name your test suite with a `DeathTest` suffix to ensure proper ordering and thread safety:

```cpp
class MyComponentDeathTest : public ::testing::Test {};

TEST_F(MyComponentDeathTest, FatalCondition) {
  ASSERT_DEATH(MyFunction(), "fatal error");
}
```

### Step 6: Run Tests and Interpret Results
Run your test binary like any other GoogleTest tests. If a death test fails, GoogleTest will show:
- Whether the code failed to die
- If the exit status matched the predicate
- Whether the stderr output matched the regex

Successful death tests will show no failures.

---

## 3. Real-World Examples

### Example 1 — Simple Death Test with `EXPECT_DEATH`

```cpp
void CheckPositive(int n) {
  if (n <= 0) {
    fprintf(stderr, "Value must be positive\n");
    abort();
  }
}

TEST(CheckPositiveTest, DiesOnNegativeInput) {
  EXPECT_DEATH(CheckPositive(-10), "Value must be positive");
  EXPECT_DEATH(CheckPositive(0), "Value must be positive");
}
```

### Example 2 — Using `ASSERT_EXIT` to Check Exit Code

```cpp
void ExitSuccessfully() {
  fprintf(stderr, "Exiting now\n");
  _Exit(0);
}

TEST(ExitTest, ExitsWithCodeZero) {
  ASSERT_EXIT(ExitSuccessfully(), ExitedWithCode(0), "Exiting now");
}
```

### Example 3 — Death Test with Compound Statement

```cpp
TEST(ComplexDeathTest, CompoundStatement) {
  ASSERT_DEATH({
    int x = 42;
    ProcessInput(x);
  }, "Error processing input");
}
```

### Example 4 — Death Test with Mock Objects

If your death test involves mocks, ensure to allow leaks with
`Mock::AllowLeak` to prevent side effects from mock leak detectors:

```cpp
NiceMock<MyMock>* leaked_mock = new NiceMock<MyMock>;
Mock::AllowLeak(leaked_mock);
EXPECT_CALL(*leaked_mock, SomeMethod()).Times(1);
EXPECT_DEATH(leaked_mock->SomeMethod(), "fatal error");
```

---

## 4. Best Practices & Troubleshooting

### Best Practices
- **Name test suites with the `DeathTest` suffix** for safe ordering and threading behavior.
- **Use regex matchers carefully;** keep patterns specific to avoid false positives.
- **Avoid side-effects** inside the death test statement since they run in a separate process.
- **Do not put fatal assertions inside constructors or destructors** in death test code.

### Common Pitfalls
- **Unexpected live code:** If your death test does not terminate, verify the statement actually calls an exit or abort function.
- **Message mismatch:** Regex patterns are POSIX extended (on POSIX) or a subset of regex supported by GoogleTest.
- **Multiple threads warning:** Death tests spawn via `fork()` which can be unsafe in multi-threaded environments; keep death tests single-threaded.
- **Multiple death tests on one line:** Causes compilation failures; place each death test on its own line.

### Troubleshooting Tips
- Check if death tests are *supported* on your platform using `EXPECT_DEATH_IF_SUPPORTED`.
- Use `GTEST_FLAG_SET(death_test_style, "threadsafe")` or `"fast"` to change style if default causes problems.
- For failing death tests due to exit code, verify the exit code predicate matches actual exit status.
- If using mocks in death tests with expected exit codes, call `Mock::AllowLeak(mock_ptr);` to prevent false leak detection failures.

---

## 5. Next Steps & Related Content

- **[Death Assertions Reference](../reference/assertions.md#death):** Detailed API and macros for death tests.
- **[Writing Your First Test](../guides/getting-started-workflows/writing-first-test.md):** For beginners to GoogleTest basics.
- **[Building & Running Tests](../getting-started/first-test-usage-validation/building-running-tests.md):** How to compile and execute your tests.
- **[Troubleshooting & Validation](../getting-started/first-test-usage-validation/troubleshooting-validation.md):** For diagnosing common issues.
- **[Mocking Reference](../docs/reference/mocking.md):** If using mocks in your death tests or other tests.

---

## Additional Notes

### Platform Notes
- On Windows and some platforms, death tests always use a "threadsafe" style.
- On UNIX-like systems, you may choose between "fast" (fork and run) and "threadsafe" (fork, exec) styles.

### Regular Expressions
Death test regex uses POSIX extended syntax on POSIX-compliant systems, and a simplified regex support on Windows/Mac. Avoid unsupported constructs like grouping `( )`, union `|`, or repetition `{ }

### Example: Skipping Death Tests on Unsupported Platforms

```cpp
EXPECT_DEATH_IF_SUPPORTED(SomeFunction(), "error message");
```
This macro runs the death test only if supported.

---

By mastering death tests, you safeguard your code’s error-handling robustness, ensuring your program behaves predictably and fails loudly when it must, improving reliability and diagnosability.

---

For comprehensive details, consult the [Advanced GoogleTest Topics - Death Tests](../docs/advanced.md#death-tests) and the [Assertions Reference](../docs/reference/assertions.md#death).


---