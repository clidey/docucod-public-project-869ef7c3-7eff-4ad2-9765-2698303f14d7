---
title: "Building & Using Mocks"
description: "Gain practical experience with GoogleMockâ€™s MOCK_METHOD macros, ON_CALL, and EXPECT_CALL to simulate object interfaces and check interactions. See how to design mock classes, set expectations, and validate interactions in real code for true isolation."
---

# Building & Using Mocks

This guide empowers you with hands-on knowledge to build and use mocks effectively using GoogleMock's powerful macros and APIs. You will gain practical expertise with `MOCK_METHOD` to define mock class methods, `ON_CALL` to specify default behaviors, and `EXPECT_CALL` to declare and verify expectations. By mastering mock construction, expectation setup, and interaction verification, you will isolate your tests and validate code behavior with precision.

---

## 1. Understanding the Mocking Workflow

### What You Will Achieve
- Define mock classes that represent interfaces or dependencies.
- Specify default behaviors for mock methods using `ON_CALL`.
- Declare expectations on mock method calls with `EXPECT_CALL`.
- Verify mock interactions automatically at object destruction or manually.

### Prerequisites
- Familiarity with C++ virtual functions and interfaces.
- GoogleTest and GoogleMock installed and integrated into your development environment.
- Basic understanding of matchers in GoogleMock.

### Outcome
After completing this guide, you'll be confident in constructing mock classes, setting flexible and strict expectations, handling method behaviors, and debugging interactions to create robust, maintainable tests.

---

## 2. Defining Mock Classes

To start using mocks, you first create a mock class mirroring the interface or abstract class you want to simulate.

### Steps to Define a Mock Class

<Steps>
<Step title="Derive a Mock Class from the Interface or Abstract Class">
Create a class inheriting from your interface. For example, if you have an interface `Foo`:

```cpp
class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
  virtual bool Process(int elem, int count) = 0;
};
```

You define your mock as:

```cpp
#include <gmock/gmock.h>

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(bool, Process, (int elem, int count), (override));
};
```
</Step>
<Step title="Place MOCK_METHOD in the Public Section">
Always put your `MOCK_METHOD` declarations in the `public:` section regardless of original method access specifier to ensure access.
</Step>
<Step title="Handle Overloads and Special Qualifiers">
When mocking overloaded methods or const methods, specify qualifiers accordingly:

```cpp
MOCK_METHOD(int, Method, (), (const, override));  // for const methods
MOCK_METHOD(int, Method, (int arg), (override));  // overloaded with args
```
</Step>
</Steps>

<Note>
You can use `NiceMock`, `NaggyMock`, or `StrictMock` wrappers to control uninteresting call handling on your mocks (covered later).
</Note>

---

## 3. Setting Default Behaviors with `ON_CALL`

`ON_CALL` lets you specify what a mock should do when a certain method is called but you don't want to enforce that it must be called.

### How to Use `ON_CALL`

```cpp
ON_CALL(mock_object, MethodName(matchers))
    .With(multi_argument_matcher)  // optional
    .WillByDefault(action);
```

- `.With()` restricts the default only to calls matching a combined matcher on all arguments.
- `.WillByDefault()` **must** be used exactly once per `ON_CALL` to specify the behavior.

For example:

```cpp
using ::testing::Return;
using ::testing::_;

MockFoo foo;
ON_CALL(foo, GetSize())
    .WillByDefault(Return(10));  // By default, GetSize returns 10
```

### Important Notes
- Multiple `ON_CALL`'s on a method: the **last matching** `ON_CALL` takes precedence.
- `ON_CALL` does not set expectations on invocation count; calls may or may not happen.

---

## 4. Declaring Expectations with `EXPECT_CALL`

`EXPECT_CALL` specifies that a mock method is expected to be called with certain arguments, possibly multiple times, optionally with ordered constraints and custom actions.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers))
    .With(multi_argument_matcher)  // optional, at most once
    .Times(cardinality)            // optional, at most once
    .InSequence(sequences...)      // optional, any number of times
    .After(expectations...)        // optional, any number of times
    .WillOnce(action)              // optional, any number of times
    .WillRepeatedly(action)        // optional, at most once
    .RetiresOnSaturation();        // optional, at most once
```

### Setting Number of Calls (`Times`)
- `Times(n)` or `Times(Exactly(n))`: Exact number of calls.
- `Times(AnyNumber())`: zero or more calls allowed.
- `Times(AtLeast(n))` / `Times(AtMost(n))` / `Times(Between(m, n))`: flexible ranges.

If omitted, GoogleMock infers cardinality:
- No `WillOnce` or `WillRepeatedly`: inferred as `Times(1)`.
- `n` `WillOnce` clauses but no `WillRepeatedly`: inferred as `Times(n)`.
- `n` `WillOnce` plus one `WillRepeatedly`: inferred as `Times(AtLeast(n))`.

### Specifying Call Order

- Use `InSequence(sequence1, sequence2, ...)` to enforce calls happen in the order expectations are declared in these sequences.
- Use `After(expectation_or_set1, ...)` to ensure this expectation only matches after other expectations are satisfied.

Example:

```cpp
Sequence seq1, seq2;
EXPECT_CALL(foo, Init()).InSequence(seq1);
EXPECT_CALL(foo, Start()).InSequence(seq1, seq2);
EXPECT_CALL(foo, Stop()).After(expect_init, expect_start);
```

### Defining Method Behavior

Use actions to specify what happens when the expectation matches.

- `.WillOnce(action)`: sequence of one-time actions performed in order.
- `.WillRepeatedly(action)`: action performed for any subsequent calls after all `.WillOnce` are used.

Example:

```cpp
EXPECT_CALL(foo, GetValue())
    .WillOnce(Return(5))
    .WillOnce(Return(10))
    .WillRepeatedly(Return(20));
```

`foo.GetValue()` will return 5 the first time, 10 the second time, and 20 for the rest.

### Retiring Expectations

Use `.RetiresOnSaturation()` to mark an expectation as inactive after it satisfies its call count, allowing later expectations to match.

---

## 5. Writing a Complete Mock Test Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;
using ::testing::_;

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(int n) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (int n), (override));
};

TEST(FooTest, GetSizeReturnsExpected) {
  MockFoo foo;

  ON_CALL(foo, GetSize()).WillByDefault(Return(42));

  EXPECT_CALL(foo, GetSize()).Times(1);
  EXPECT_CALL(foo, Describe(5))
      .WillOnce(Return("number 5"));

  EXPECT_EQ(foo.GetSize(), 42);
  EXPECT_EQ(foo.Describe(5), "number 5");
}
```

This test:
- Defines a mock class.
- Sets default return value for `GetSize` via `ON_CALL`.
- Sets an expectation and behavior for `Describe` via `EXPECT_CALL`.
- Exercises the mock and verifies behavior.

---

## 6. Handling Overloaded Methods & Const Methods

Use the `MOCK_METHOD` macro carefully with overloaded or const methods to disambiguate:

```cpp
MOCK_METHOD(int, Func, (), (override));               // non-const
MOCK_METHOD(int, Func, (), (const, override));         // const
MOCK_METHOD(void, Update, (int x), (override));        // single arg
MOCK_METHOD(void, Update, (int x, int y), (override)); // overload with 2 args
```

When calling `EXPECT_CALL` on an overloaded method, specify arguments or use helpers like `Const()` wrapper:

```cpp
EXPECT_CALL(Const(mock_obj), Func());  // call const version
EXPECT_CALL(mock_obj, Update(5));       // call first overload
EXPECT_CALL(mock_obj, Update(_, _));    // call overloaded method with 2 args
```

---

## 7. Using `NiceMock`, `NaggyMock`, and `StrictMock`

These wrappers control the behavior of your mocks for uninteresting calls (calls to methods without `EXPECT_CALL` specs):

| Wrapper     | Behavior on Uninteresting Calls                      |
|-------------|-----------------------------------------------------|
| `NiceMock`  | Suppresses warnings (ignores uninteresting calls). |
| `NaggyMock` | Prints warnings (default behavior).                  |
| `StrictMock`| Treats uninteresting calls as errors (fail tests). |

Example:

```cpp
using ::testing::NiceMock;

NiceMock<MockFoo> nice_mock;
EXPECT_CALL(nice_mock, DoThing());
...
```

**Note:** These wrappers only affect calls on methods *without* expectations; calls that do not match any `EXPECT_CALL` are always errors.

---

## 8. Verifying and Resetting Mocks Manually

By default, expectations are verified automatically when mock objects are destructed. To verify expectations earlier or manually, use:

```cpp
// Verify expectations, clearing set expectations but not default ON_CALL behaviors.
bool result = Mock::VerifyAndClearExpectations(&mock_obj);

// Verify expectations, clearing both expectations and default ON_CALL behaviors.
bool success = Mock::VerifyAndClear(&mock_obj);

// Tell GoogleMock the mock object can be leaked without verification.
Mock::AllowLeak(&mock_obj);
```

**Tip:** Wrap `VerifyAndClearExpectations()` in assertions like `ASSERT_TRUE()` to halt on failure.


---

## 9. Best Practices & Common Pitfalls

- **Always set expectations before the code calls the mock methods.**  Setting expectations after calling methods leads to undefined behavior.
- Use `ON_CALL` for defining default mock behaviors without asserting calls.
- Use specific `EXPECT_CALL`s sparingly to enforce strict expectations; avoid over-constraining unless necessary.
- If your tests are overwhelmed with uninteresting call warnings, consider switching from default mock to `NiceMock`.
- When working with move-only types, use lambdas or functors with `WillOnce` / `WillRepeatedly` rather than `Return(std::move())`.
- Remember to mock destructors via auxiliary methods (e.g., a `Die()` method called from destructor) to verify destruction order.

<Tip>
To simplify mocking overloaded methods, help the compiler by specifying argument types or using `Const()` wrapper for const overloads.
</Tip>

<Tip>
Use sequences (`Sequence`, `InSequence`) and ordering clauses (`After`) to manage expectations with call order constraints cleanly.
</Tip>

<Warning>
Do not add expectations or call `EXPECT_CALL` after your code under test has already exercised the mock; this results in undefined behavior and hard-to-debug failures.
</Warning>

---

## 10. Troubleshooting Mock Usage

- **Your test throws or assertions fail about unexpected or excessive calls:**
  - Ensure `EXPECT_CALL` is set up properly *before* invoking the mock methods.
  - Verify argument matchers closely; missing or incorrect matchers cause expectations not to match.
  - If calls are happening out of expected order, verify sequences and `InSequence` usage.

- **Uninteresting call warnings flood your output:**
  - Add `EXPECT_CALL` with `Times(AnyNumber())` for commonly called-but-uninteresting methods.
  - Switch to `NiceMock` for quieter tests.

- **Expectations not checked because mock objects are leaked:**
  - Use smart pointers or ensure proper destruction of mock objects.
  - Use `Mock::VerifyAndClearExpectations()` for manual verification if destruction timing is uncertain.

- **Mock method does not return expected value:**
  - Verify that you have set `.WillOnce()` or `.WillRepeatedly()` with the correct return actions.
  - For move-only return types, prefer lambdas or callable objects returning fresh instances.

---

## 11. Next Steps & Related Documentation

- Explore the [Mock Class Definition & Method Mocking](/api-reference/mocking-apis/mock-class-definition) for more on `MOCK_METHOD` usage.
- Learn advanced mocking techniques with [Custom Actions & Matchers](/guides/mocking-advanced-usage/custom-actions-and-matchers).
- Control mock strictness via [Nice, Naggy, and Strict Mocks](/guides/mocking-advanced-usage/nice-strict-mocks).
- Understand argument matching and expectations in detail at [Mocking Reference](docs/reference/mocking.md).
- Review common patterns and troubleshooting in [Debugging Common Test Failures](/guides/real-world-patterns/debugging-common-failures).


---

## Appendix: Core Macros and Classes

### MOCK_METHOD
Defines a mock method inside a mock class:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
```

- `ReturnType`: return type of method.
- `MethodName`: the mock method name.
- `Args...`: argument types in parentheses.
- `Specs...`: qualifiers like `const`, `override`.

### ON_CALL
Specifies default behavior of a mock method without requiring it to be called.

### EXPECT_CALL
Declares an expectation on a mock method's call behavior and count.

### NiceMock / NaggyMock / StrictMock
Modifiers to control uninteresting call reporting.

### Sequence and InSequence
Controls the relative order of expected method calls.


---

For further examples, patterns, and best practices about building and using mocks, please consult the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html), and the [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) guide.


---

*This concludes the Building & Using Mocks guide.*
