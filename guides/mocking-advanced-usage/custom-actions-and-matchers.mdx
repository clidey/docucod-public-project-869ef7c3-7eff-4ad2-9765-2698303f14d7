---
title: "Custom Actions & Matchers"
description: "Take your mocks to the next level with custom actions and matchers, allowing precise control over function return values and verification logic. Learn how to define reusable patterns, compose advanced behaviors, and maintain test clarity even as complexity grows."
---

# Custom Actions & Matchers

Take your mocks to the next level with custom actions and matchers, allowing precise control over function return values and verification logic. Learn how to define reusable patterns, compose advanced behaviors, and maintain test clarity even as complexity grows.

---

## 1. Understanding the Role of Custom Actions and Matchers

When using GoogleMock, default actions and built-in matchers cover most common cases. However, complex tests often require tailoring behavior and arguments verification closely to your domain logic.

Custom actions customize what a mock method does when called — such as returning computed values, modifying output parameters, or invoking callbacks. Custom matchers let you define precise, reusable rules for validating function arguments beyond standard equality or simple predicates.

**Why bother?** Without custom actions and matchers, your tests can become cluttered with repetitive code, hard-to-maintain lambda expressions, or brittle assertions. Custom definitions unlock clarity, speed, and accuracy.

---

## 2. Defining Custom Actions

### Basic Concept

A custom action is a callable object (function, functor, or lambda) compatible with the mocked method’s signature. It replaces or supplements default return values and side effects.

### How to Create Custom Actions

#### Using Lambdas or Functions Directly

For simple needs, write a lambda or function that matches the mock method’s signature:

```cpp
EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce([](int x) { return x * 2; });
```

This returns twice the input parameter whenever `SomeMethod` is called.

#### Using Functor Structs

Define a struct with a call operator:

```cpp
struct MultiplyBy {  
  int factor;
  int operator()(int x) const { return x * factor; }
};

EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce(MultiplyBy{5});
```

This creates a reusable action that multiplies the argument by 5.

#### Advanced: Implementing `ActionInterface`

For highly complex cases, where you want an action reusable across various mock signatures, implement the `ActionInterface<F>` where `F` is the method signature. This approach is rare and beyond basic needs.

### Built-in Composite Actions

Combine multiple sub-actions using `DoAll()`, which performs actions in sequence and returns the value from the last:

```cpp
EXPECT_CALL(mock_obj, DoSomething(_))
    .WillOnce(DoAll(SetArgPointee<1>(10), Return(true)));
```

Here it sets output argument 1 to 10 and returns `true`.

### Practical Tips for Actions

- For mocking side effects (e.g., modifying output params), use built-in helpers like `SetArgPointee<N>(value)`.
- Use `Invoke()` to delegate calls to real functions, methods, or functors.
- Use `Return()`, `ReturnRef()`, or `ReturnPointee()` to return computed or live values.
- Use `InvokeArgument<N>()` to call a callable passed as an argument to the mock.

---

## 3. Creating Custom Matchers

### Purpose

Matchers verify function arguments to simplify and enrich expectation definitions beyond basic equality checks. When arguments are complex, custom matchers provide concise, readable validation that produces clear failure messages.

### Defining Matchers with Macros

GoogleMock offers convenient macros:

- `MATCHER(name, description)` defines a simple unary matcher.
- `MATCHER_P(name, param, description)` defines parameterized matchers.

Example:

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock_obj, Process(IsEven()));
```

### Writing Parameterized Matchers

Parameterized matchers accept arguments to customize their behavior:

```cpp
MATCHER_P(HasSum, expected_sum, "checks if foo.bar() + foo.baz() equals expected_sum") {
  return (arg.bar() + arg.baz()) == expected_sum;
}

EXPECT_CALL(mock_obj, Process(HasSum(10)));
```

### Matcher Class Implementation

For fine control, implement a matcher class with these methods:

- `bool MatchAndExplain(const T& value, std::ostream* os) const` — returns if value matches
- `void DescribeTo(std::ostream* os) const` — writes description
- `void DescribeNegationTo(std::ostream* os) const` — negated description

Wrap it in a factory function to return `testing::Matcher<T>` instances.

### Composite Matchers

Matchers may contain other matchers as parameters, such as `AllOf()`, `AnyOf()`, or custom composite behaviors.

### Guidance on Writing Matchers

- Matchers must be functional and free of side effects.
- Provide useful failure messages by streaming explanations.
- Keep matchers reusable and readable.

---

## 4. Practical Examples

### Example: Custom Action - Returning Computed Value

```cpp
EXPECT_CALL(mock_config, GetValue(_))
    .WillOnce([](int key) {
      return key * key;  // returns square of key
    });
```

### Example: Custom Matcher - Checks Sum of Fields

```cpp
MATCHER_P(HasSumOfFields, expected_sum, "checks sum of foo.bar() and foo.baz()") {
  return (arg.bar() + arg.baz()) == expected_sum;
}

EXPECT_CALL(mock_obj, Process(HasSumOfFields(42)));
```

### Example: Combining Matchers to Validate Complex Argument

```cpp
using ::testing::AllOf;
using ::testing::Field;
using ::testing::Gt;

EXPECT_CALL(mock_obj, HandleData(AllOf(
    Field(&MyData::count, Gt(0)),
    Field(&MyData::status, Eq("ok")))));
```

---

## 5. Best Practices and Tips

- Use `ON_CALL()` setting default actions sparingly; prefer `EXPECT_CALL()` for behavior verification.
- Use `RetiresOnSaturation()` on expectations that have limited valid calls to avoid sticky expectations.
- Suppress uninteresting call warnings using `NiceMock` when appropriate.
- Start with simple matchers and extend them with custom matchers as your tests grow in complexity.
- Document your custom matchers and actions clearly for other developers.

---

## 6. Troubleshooting Common Pitfalls

- **Uninteresting Calls Warning**: If you see warnings for calls without expectations, verify whether you need to set an explicit `EXPECT_CALL()` or use `NiceMock`.
- **Over-specified Expectations**: Overly strict expectations may fail on harmless changes; prefer using `Times(AnyNumber())` or matchers like `_` when argument values are irrelevant.
- **Confusing Failure Messages**: Improve custom matcher descriptions and explanations to aid diagnosis.
- **Incorrect Action Usage**: Ensure actions match the mock method’s signature, especially when using move-only types or references.

---

## 7. Next Steps & Related Content

- Dive deeper into the [Building & Using Mocks guide](/guides/mocking-advanced-usage/building-mocks) to learn about defining mocks and advanced behaviors.
- Explore [Matchers Reference](reference/matchers.md) and [Actions Reference](reference/actions.md) for extensive lists and documentation.
- Consult [Nice, Naggy, and Strict Mocks guide](/guides/mocking-advanced-usage/nice-strict-mocks) to understand controlling mock strictness.

---

## 8. Additional Resources

- Official GoogleMock documentation: https://google.github.io/googletest/gmock_cook_book.html
- Mocking Reference: https://google.github.io/googletest/reference/mocking.html
- gMock for Dummies: https://google.github.io/googletest/gmock_for_dummies.html

---