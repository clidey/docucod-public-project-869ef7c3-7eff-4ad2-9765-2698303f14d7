---
title: "Customizing Mock Behavior with Matchers and Actions"
description: "Learn how to set precise expectations on mock method calls using matchers, and dictate behavior with actions. Includes a walkthrough of built-in matchers/actions and examples for crafting custom variants for specialized scenarios."
---

# Customizing Mock Behavior with Matchers and Actions

Learn how to set precise expectations on mock method calls using matchers, and dictate behavior with actions. Includes a walkthrough of built-in matchers/actions and examples for crafting custom variants for specialized scenarios.

---

## Workflow Overview

### Task Description
This guide helps you master customizing mock behavior in GoogleMock by leveraging **matchers** to specify expected arguments and **actions** to define how mocked methods respond when called.

### Prerequisites
- Familiarity with C++ and virtual functions
- Basic understanding of GoogleMock mock classes and `MOCK_METHOD`
- GoogleMock and GoogleTest properly installed and configured

### Expected Outcome
By following this guide, you will know how to:
- Specify complex, precise criteria on mock method calls with built-in and custom matchers
- Define mock method behaviors using built-in and custom actions
- Combine matchers and actions for sophisticated testing scenarios
- Implement and use your own matchers and actions for special cases

### Time Estimate
Approximately 30-45 minutes

### Difficulty Level
Intermediate

---

## Step-by-Step Guide to Using Matchers and Actions

### 1. Defining Matchers to Set Expectations on Mock Calls

Matchers let you specify *what* argument values you expect for a mock method call. By default, a literal argument means equality matching. For flexibility, GoogleMock provides a rich set of built-in matchers.

#### Basic Usage:
```cpp
using ::testing::Return;
using ::testing::_;  // Matches anything
using ::testing::Ge; // Matches >= value

EXPECT_CALL(mock_obj, DoSomething(Ge(5)))
    .WillOnce(Return(true));
EXPECT_CALL(mock_obj, DoSomething(_))  // Matches any argument
    .WillRepeatedly(Return(false));
```

#### Tips:
- Use `_` to match any argument when you don't care about its value
- Use combinators like `AllOf()`, `AnyOf()`, and `Not()` to build complex matchers

---

### 2. Combining Matchers with `With()` Clause

If you need to express constraints across multiple arguments together, `.With()` accepts multi-argument matchers that examine all parameters as a tuple.

```cpp
using ::testing::Lt;
EXPECT_CALL(mock_obj, SetRange(_, _))
    .With(Lt());  // First argument must be less than second
```

This allows you to enforce relationships between multiple arguments.

---

### 3. Using Actions to Specify Mock Behavior

Actions define how a mock method behaves when called, e.g., returning values, modifying arguments, or invoking callbacks.

#### Common Built-in Actions:
| Action         | Description                               |
|----------------|-------------------------------------------|
| `Return(value)`| Return the specified value                |
| `ReturnRef(x)` | Return reference to `x`                   |
| `DoDefault()`  | Perform default action (usually returning default value) |
| `Invoke(f)`    | Call a callable `f` with mock arguments   |
| `SetArgPointee<N>(value)` | Set output argument pointed to by N-th parameter |
| `DoAll()`      | Sequence multiple actions, return last action's result |

#### Example:
```cpp
EXPECT_CALL(mock_obj, Compute(5))
    .WillOnce(Return(42));
EXPECT_CALL(mock_obj, Update(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(10), Return(true)));
```

---

### 4. Using `ON_CALL` vs `EXPECT_CALL`

- `ON_CALL`: Specifies default behavior but *does not* expect the call
- `EXPECT_CALL`: Specifies both behavior and an expectation that the call will occur

Use `ON_CALL` to set usual behaviors and `EXPECT_CALL` to check specific interactions.

---

### 5. Creating Custom Matchers

gMock supports easy creation of custom matchers for specialized needs.

#### Quick Custom Matcher using Macro:
```cpp
MATCHER_P(IsDivisibleBy, divisor, "Checks divisibility") {
  return (arg % divisor) == 0;
}

EXPECT_CALL(mock_obj, Process(IsDivisibleBy(7)));
```

#### Defining a Matcher Class:
```cpp
class SumIsMatcher {
 public:
  explicit SumIsMatcher(int expected_sum) : expected_sum_(expected_sum) {}

  bool MatchAndExplain(const Foo& obj, std::ostream* os) const {
    return (obj.bar() + obj.baz()) == expected_sum_;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "bar() + baz() equals " << expected_sum_;
  }
  void DescribeNegationTo(std::ostream* os) const {
    *os << "bar() + baz() does not equal " << expected_sum_;
  }

 private:
  int expected_sum_;
};

::testing::Matcher<const Foo&> SumIs(int expected_sum) {
  return ::testing::MakeMatcher(new SumIsMatcher(expected_sum));
}

EXPECT_CALL(mock_obj, HandleFoo(SumIs(10)));
```

---

### 6. Creating Custom Actions

You can define your own action by implementing `operator()` compatible with the mocked function signature or use the `ACTION` macros.

#### Using a Lambda as an Action:
```cpp
EXPECT_CALL(mock_obj, Compute(_))
    .WillOnce([](int x) { return x * 2; });
```

#### Defining a Parameterized Action:
```cpp
ACTION_P(AddValue, n) { return arg0 + n; }
EXPECT_CALL(mock_obj, GetValue())
    .WillOnce(AddValue(5));
```

---

### 7. Handling Overloaded and Const Methods

For overloaded methods, mock all relevant signatures explicitly. Use `using` statements if not mocking some overloads.

```cpp
MOCK_METHOD(int, Foo, (int x), (override));
MOCK_METHOD(int, Foo, (double y), (override));

using Base::Foo;  // To prevent hiding base class overloads
```

For const methods, add `(const, override)` qualifiers:

```cpp
MOCK_METHOD(int, GetX, (), (const, override));
```

---

### 8. Managing Call Order with Sequences and `After`

- Use `InSequence` block to enforce strict call order.
- Use `.After()` clauses with expectations to enforce partial ordering.

```cpp
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(mock, First());
  EXPECT_CALL(mock, Second());
}
```

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Cleanup()).After(e1);
```

---

### 9. Tips for Robust and Maintainable Mock Configurations

- Prefer using `ON_CALL` to set sensible defaults and `EXPECT_CALL` only for calls you want to verify.
- Use `NiceMock<T>` to suppress warnings on uninteresting calls.
- Use `.RetiresOnSaturation()` on expectations that should not remain active after being satisfied to avoid sticky expectations causing failures.
- When using complex matchers or actions repeatedly, assign them to variables and reuse instead of rebuilding.

---

## Examples

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_; 
using ::testing::Eq;
using ::testing::Gt;
using ::testing::DoAll;
using ::testing::SetArgPointee;

class MockFoo {
 public:
  MOCK_METHOD(bool, Process, (int a, int* b), ());
};

TEST(MockFooTest, ProcessBehavior) {
  MockFoo mock;

  // Set default ON_CALL behavior
  ON_CALL(mock, Process(_, _))
      .WillByDefault(DoAll(SetArgPointee<1>(10), Return(true)));

  // Expect call with first argument greater than 5, return true
  EXPECT_CALL(mock, Process(Gt(5), _))
      .WillOnce(Return(true));

  int val = 0;
  EXPECT_TRUE(mock.Process(6, &val));
  EXPECT_EQ(val, 10);
}
```

Custom matcher example:

```cpp
MATCHER_P(StartsWithPrefix, prefix, "checks string prefix") {
  return arg.find(prefix) == 0;
}

TEST(MockFooTest, CustomMatcher) {
  MockFoo mock;

  EXPECT_CALL(mock, Process(Eq(42), _));  // Using built-in Eq

  // Using custom matcher for stricter argument check
  EXPECT_CALL(mock, Process(StartsWithPrefix("abc"), _));
}
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting calls warning:** Use `NiceMock<T>` to suppress, or add an `EXPECT_CALL` with `Times(AnyNumber())`.
- **Too many or too few `WillOnce` actions:** Ensure the number of `WillOnce()` clauses matches the expected call count or use `WillRepeatedly()`.
- **Overloaded method ambiguity:** Provide exact matchers or `using` declaration to avoid overload hiding.
- **Const correctness:** Make sure to mock const-qualified methods with correct specifiers.

### Best Practices

- Use `ON_CALL` liberally to define default behavior; overusing `EXPECT_CALL` can make tests brittle.
- Prefer `.RetiresOnSaturation()` in sequences or when chaining expectations to avoid sticky expectations.
- Write custom matchers to enhance readability and reuse complex argument checks.
- Use `Invoke()` or lambdas for flexible and powerful actions beyond simple returns.

## Next Steps & Related Content

- Explore [Mocking and Advanced Testing Techniques](../guides/mocking-and-advanced-testing/mock-objects.md) for deeper mock usage.
- Read the [Matchers Reference](../api-reference/mocking-framework/matchers.md) for a comprehensive list of matchers.
- Study the [Actions Reference](../api-reference/mocking-framework/actions.md) to learn all possible mock method behaviors.
- Review [Best Practices for Reliable Mock-Based Tests](../guides/mocking-and-advanced-testing/test-doubles-best-practices.md) to improve test reliability and maintainability.

---

## References

- [gMock Cookbook - Matchers and Actions](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)

---