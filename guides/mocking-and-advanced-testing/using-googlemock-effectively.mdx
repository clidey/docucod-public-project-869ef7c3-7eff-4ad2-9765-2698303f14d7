---
title: "Using GoogleMock Effectively"
description: "A hands-on tutorial for introducing mocking into your tests with GoogleMock, covering how to create and configure mock classes, set call expectations, and assert on interactions using real-world patterns."
---

# Using GoogleMock Effectively

A hands-on tutorial for introducing mocking into your tests with GoogleMock, covering how to create and configure mock classes, set call expectations, and assert on interactions using real-world patterns.

---

## 1. Introduction

GoogleMock (gMock) provides a powerful and flexible way to define mock classes in C++ and assert how they should be invoked in your tests. This guide focuses on practical approaches to:

- Create and configure mock classes
- Set and control expectations on mock method calls
- Assert interactions using GoogleMock’s expressive syntax

By following this guide, you'll be ready to write robust, maintainable tests that effectively mock dependencies and verify interactions.

---

## 2. Prerequisites

Before proceeding, ensure:

- You have GoogleTest and GoogleMock integrated into your build system.
- Basic familiarity with C++ features such as classes, inheritance, and virtual functions.
- Understanding of unit testing fundamentals using GoogleTest (see the [GoogleTest Primer](../../guides/writing-and-running-tests/getting-started)).

---

## 3. Creating Mock Classes

Mock classes are C++ classes where methods are mocked using the `MOCK_METHOD` macro. This macro declares mock methods with specified signatures and qualifiers.

### Step 3.1: Define a Mock Class

- Derive your mock class from the interface or base class you want to mock.
- Use `MOCK_METHOD` to define each method you want to mock in the `public` section.
- When mocking `const`, `override`, `noexcept`, or reference-qualified methods, add the appropriate qualifiers in the macro's fourth parameter.

```cpp
class MockFoo : public FooInterface {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, SetValue, (int val), (override));
};
```

### Handling Commas in Types

If your method has argument or return types with commas (e.g., templates like `std::pair`), wrap the entire type in parentheses or define a type alias:

```cpp
using BoolAndInt = std::pair<bool, int>;

class MockExample {
 public:
  MOCK_METHOD(BoolAndInt, GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
};
```

### Special Cases

- Mock methods must always be declared `public` even if they override protected/private base methods.
- You can mock overloaded methods by declaring each overload using `MOCK_METHOD` with the appropriate signature.
- For non-virtual methods (Hi-perf dependency injection), the mock class need not inherit but must define mock methods with matching signatures.

---

## 4. Setting Expectations on Mock Methods

GoogleMock provides two primary macros for specifying interaction behaviors:

### 4.1 ON_CALL: Setting Default Behavior

 `ON_CALL(mock_object, Method(args...))` defines the default behavior of a mock method when called with matching arguments but does not expect the call.

Example:

```cpp
ON_CALL(mock_foo, GetValue()).WillByDefault(Return(42));
```

This specifies that calls to `GetValue()` will return `42` by default, without requiring the method to be called.

### 4.2 EXPECT_CALL: Setting Expectations

 `EXPECT_CALL(mock_object, Method(matchers...))` sets an expectation that the method will be called with arguments matching the given matchers.

Example:

```cpp
EXPECT_CALL(mock_foo, SetValue(Ge(10))).Times(1);
```

This expects that `SetValue` will be called exactly once with a parameter greater than or equal to 10.

### Chaining Clauses

Use option clauses with `EXPECT_CALL` to express detailed constraints:

```cpp
EXPECT_CALL(mock, Method(_))
    .Times(AtLeast(2))
    .WillOnce(Return(true))
    .WillRepeatedly(Return(false));
```

These clauses control how many times the call is expected, and what it should return or do on each invocation.

---

## 5. Understanding Expectations Behavior

### Cardinalities (`Times`)

Specify how many times a call is expected:

| Cardinality      | Meaning                                  |
|------------------|------------------------------------------|
| `Exactly(n)`     | Called exactly n times (default 1 if omitted) |
| `AtLeast(n)`     | Called at least n times                   |
| `AtMost(n)`      | Called at most n times                    |
| `Between(m, n)`  | Called between m and n times inclusive   |
| `AnyNumber()`    | Called any number of times                |

### Ordering Calls

Calls can be constrained to occur in a strict sequence with `InSequence`:

```cpp
{
  InSequence seq;
  EXPECT_CALL(foo, First());
  EXPECT_CALL(foo, Second());
}
```

or to define more complex partial orders using `InSequence` with multiple sequences or `.After()`.

### Sticky Expectations and Retiring

- By default, expectations are "sticky" — they remain active even after reaching the specified limits.
- Use `.RetiresOnSaturation()` to automatically retire an expectation when it is satisfied, so subsequent calls do not match it.

Example:

```cpp
EXPECT_CALL(foo, Bar())
    .WillOnce(Return(1))
    .RetiresOnSaturation();
EXPECT_CALL(foo, Bar())
    .WillRepeatedly(Return(0));
```

---

## 6. Setting Behavior Using Actions

Actions describe what happens when mock methods are invoked.

- Use `Return(value)` or `ReturnRef(object)` to return specific values.
- Use `DoAll()` to chain multiple actions.
- Use `Invoke()` to call functions, functors, or lambdas.
- Use `SetArgPointee<N>(value)` to modify output parameters.

Example:

```cpp
EXPECT_CALL(mock, Compute(42))
    .WillOnce(DoAll(SetArgPointee<1>(100), Return(true)));
```

---

## 7. Advanced Mock Types

GoogleMock offers three mock qualities to handle uninteresting calls differently:

| Mock Type       | Behavior on Uninteresting Calls                    |
|-----------------|---------------------------------------------------|
| `NiceMock<T>`   | Suppresses warnings for uninteresting calls       |
| `NaggyMock<T>`  | Warns on uninteresting calls (default behavior)    |
| `StrictMock<T>` | Makes uninteresting calls failures (errors)       |

Create a nice mock:

```cpp
NiceMock<MockFoo> mock_foo;
```

Use nice mocks when you want to focus only on expected interactions and suppress noise.

---

## 8. Common Patterns & Best Practices

### Prefer ON_CALL for Default Behavior

Use `ON_CALL` for behavior without verifying the call occurrence. Use `EXPECT_CALL` only where you need to verify the call happens.

### Specify Only Necessary Argument Matchers

Avoid over-specifying argument matchers. Use wildcards (`_`) when argument specifics are unimportant.

### Use Sequences to Enforce Call Order

Use `InSequence` blocks or `Sequence` objects with `.InSequence()` clauses to enforce call order when test logic depends on it.

### Retire Expectations When Appropriate

Use `.RetiresOnSaturation()` to avoid unexpected excessive call failures when reusing expectations for the same calls repeatedly.

### Control Mock Strictness to Reduce Test Noise

Prefer `NiceMock` for general testing. Use stricter mocks only when you want to assert that unexpected calls cause failures.

---

## 9. Troubleshooting

### Unexpected Calls

An unexpected call is one that matches no current `EXPECT_CALL`. GoogleMock prints failure with detailed mismatch info.

**Solution:** Verify your expectations cover all intended calls or add a catch-all `EXPECT_CALL` with wildcard matchers.

### Uninteresting Call Warnings

Warnings for calls to mock methods with no `EXPECT_CALL` (uninteresting calls).

**Solution:** Use `NiceMock` to suppress or add `EXPECT_CALL(...).Times(AnyNumber())` to explicitly accept calls.

### Too Many or Too Few Actions

Mismatch between the number of calls and the number of declared `WillOnce` actions.

**Solution:** Ensure the number of `WillOnce` calls matches or use `WillRepeatedly` for excess calls.

### Syntax Errors When Using `MOCK_METHOD`

Incorrect parentheses or comma placement causes compilation errors.

**Solution:** Wrap complex types with parentheses or use `using` type aliases for return or argument types with commas.

---

## 10. Example: Mocking a Simple Interface

```cpp
class Database {
 public:
  virtual ~Database() = default;
  virtual bool Connect(const std::string& url) = 0;
  virtual int GetRecordCount() const = 0;
};

class MockDatabase : public Database {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(int, GetRecordCount, (), (const, override));
};

using ::testing::Return;
using ::testing::_; 

TEST(DatabaseTest, ConnectAndQuery) {
  MockDatabase mock_db;

  ON_CALL(mock_db, Connect(_))
      .WillByDefault(Return(true));

  EXPECT_CALL(mock_db, GetRecordCount())
      .Times(1)
      .WillOnce(Return(42));

  EXPECT_TRUE(mock_db.Connect("db://localhost"));
  EXPECT_EQ(mock_db.GetRecordCount(), 42);
}
```

This test sets up the mock database to:

- Always succeed on `Connect` with any URL.
- Expect exactly one call to `GetRecordCount()` returning `42`.

---

## 11. Further Learning & Next Steps

- **GoogleMock for Dummies:** [https://google.github.io/googletest/gmock_for_dummies.html](https://google.github.io/googletest/gmock_for_dummies.html)
- **Mocking Reference:** Detailed API docs on mocking features.
- **Matchers and Actions References:** For mastering argument matching and action customization.
- **Mocking Cookbook:** Advanced recipes and best practices.
- **Best Practices for Mock-Based Testing:** Guidance on writing maintainable tests.

---

With these techniques, you're equipped to write precise and maintainable mocks that enhance your testing effectiveness. GoogleMock’s rich features and expressive syntax will help you verify interactions and design better components through testing.

---

# Appendix

For quick reference, here is the basic syntax for mocking, expecting, and specifying behaviors:

```cpp
// Define mock method
MOCK_METHOD(ReturnType, MethodName, (Args...), (qualifiers));

// Set default behavior, no expectation on calls
ON_CALL(mock_obj, Method(matchers...)).WillByDefault(action);

// Set expectation and behavior
EXPECT_CALL(mock_obj, Method(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

Replace `matchers...` with `_` to accept any argument.

**Remember:** Always set expectations *before* invoking methods on the mock.
