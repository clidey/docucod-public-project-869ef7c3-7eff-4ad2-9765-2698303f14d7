---
title: "Setting Expectations and Actions"
description: "Master the workflow for defining, customizing, and verifying expectations on mock objects. This guide covers ON_CALL vs EXPECT_CALL, cardinalities (times called), and custom actions to model a wide variety of behaviors."
---

# Setting Expectations and Actions

Master the workflow for defining, customizing, and verifying expectations on mock objects. This guide covers ON_CALL vs EXPECT_CALL, cardinalities (times called), and custom actions to model a wide variety of behaviors.

---

## Workflow Overview

### Task Description
This guide helps you understand how to specify the behavior and usage expectations of mock objects in GoogleMock. You will learn how to use `ON_CALL` to define default mock behaviors and `EXPECT_CALL` to set explicit expectations, control call frequency with cardinalities, and customize what happens during mock method invocations with actions.

### Prerequisites
- Familiarity with C++ and mocking concepts
- A mock class defined with `MOCK_METHOD` macros
- GoogleMock included in your project
- Basic understanding of matchers and mock method definitions

### Expected Outcome
After completing this guide, you will confidently:
- Distinguish between default mock behaviors (`ON_CALL`) and explicit expectations (`EXPECT_CALL`)
- Specify argument matchers for expected calls
- Control call cardinalities (how many times the mock methods should be called)
- Define precise mock behaviors using multiple actions
- Manage call ordering using sequences and prerequisites
- Handle common pitfalls related to expectation stickiness and specificity

### Time Estimate
Approximately 20-30 minutes to read and practice

### Difficulty Level
Intermediate (requires some experience with GoogleMock basics)

---

## Step-by-Step Instructions

### 1. Understand the Difference Between `ON_CALL` and `EXPECT_CALL`
- Use `ON_CALL(mock_object, Method(args))` to specify default actions for mock methods. It defines what the mock should *do* when called but does *not* require the method to be called.
- Use `EXPECT_CALL(mock_object, Method(matchers))` to set expectations that the method *will* be called with matching arguments. It also defines behavior, but primarily asserts the call occurrence.

### 2. Specify Matchers for Method Arguments
- When setting expectations, include matchers for method arguments to describe which calls you expect. For example:
```cpp
EXPECT_CALL(mock_turtle, Forward(100));
```
- Use the wildcard matcher `_` to accept any value if you don’t care about specific arguments:
```cpp
EXPECT_CALL(mock_turtle, GoTo(50, _));
```
- For methods with multiple arguments, you can specify matchers for each or omit the parameter list for non-overloaded methods to mean "accept any."

### 3. Control the Number of Expected Calls Using Cardinalities
- The `.Times()` clause controls how often the mocked method is expected to be called.
- Common cardinalities include `Times(1)` (default if omitted), `Times(0)` (never called), `AtLeast(n)`, `AtMost(n)`, and `AnyNumber()`.
- Examples:
```cpp
EXPECT_CALL(mock_turtle, PenDown()).Times(AtLeast(1));
EXPECT_CALL(mock_turtle, Turn(90)).Times(2);
EXPECT_CALL(mock_turtle, GoTo(_, _)).Times(AnyNumber());
```
- If you omit `Times()`, gMock infers expected call counts based on the number and type of `.WillOnce()` and/or `.WillRepeatedly()` actions provided.

### 4. Define the Behavior of Mock Methods Using Actions
- `.WillOnce(action)` specifies the behavior for a single call.
- `.WillRepeatedly(action)` sets the behavior for all subsequent calls after the `.WillOnce()` calls are exhausted.
- Example of returning different values in sequence:
```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```
- Actions can be custom lambdas, built-in actions like `Return()`, `Invoke()`, or side effect actions (e.g., `SetArgPointee<N>(value)`).

### 5. Handle Multiple Expectations on the Same Method
- When multiple expectations match the same method, gMock searches from the newest to the oldest and picks the first matching active expectation.
- Order your expectations from general to more specific (latest more specific) to avoid shadowing.
- Example:
```cpp
EXPECT_CALL(turtle, Forward(_));        // #1
EXPECT_CALL(turtle, Forward(10)).Times(2);  // #2
```
Calls to `Forward(10)` will match `#2` preferably.

### 6. Specify Call Order Using `InSequence` and `After`
- To enforce strict call order, use the `InSequence` object:
```cpp
{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```
- Use `.After()` to impose partial order dependencies:
```cpp
Expectation e1 = EXPECT_CALL(mock, InitA());
EXPECT_CALL(mock, InitB()).After(e1);
```

### 7. Manage Expectation Life Cycle with `.RetiresOnSaturation()`
- By default, an expectation is "sticky," meaning it remains active even after reaching its call upper bound.
- To disable stickiness and make an expectation retire immediately upon saturation, use:
```cpp
EXPECT_CALL(mock, SomeMethod())
    .Times(2)
    .RetiresOnSaturation();
```
This is helpful when you want to allow other expectations to match the method after this one is saturated.

---

## Examples & Code Samples

### Example: Defining Expectations with Multiple Actions and Cardinality
```cpp
using ::testing::Return;

MockTurtle turtle;
EXPECT_CALL(turtle, GetX())
    .Times(5)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```
This expects `GetX()` to be called 5 times, returning 100 on the first, 150 on the second, and 200 thereafter.

### Example: Catch-all Expectation with Any Arguments
```cpp
EXPECT_CALL(turtle, PenDown())
    .Times(AnyNumber())
    .WillRepeatedly(Return());
```
Allows any number of calls to `PenDown()` with any arguments.

### Example: Using `InSequence` to Enforce Call Order
```cpp
{
  InSequence seq;

  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

### Example: Using `.After()` to Impose Partial Order
```cpp
Expectation initA = EXPECT_CALL(mock, InitA());
EXPECT_CALL(mock, InitB()).After(initA);
```
Call to `InitB()` will only match after `InitA()` has been called.

### Example: Combining Expectations on the Same Method for Specific Arguments
```cpp
EXPECT_CALL(turtle, GoTo(_, _)).Times(AnyNumber());  // #1
EXPECT_CALL(turtle, GoTo(0, 0)).Times(2);             // #2
```
Allows any calls to `GoTo` but exactly two calls to `(0, 0)`.

---

## Troubleshooting & Tips

### Common Issues
- **Undefined Behavior When Setting Expectations After Calling Mock Methods:** Always set your `EXPECT_CALL` expectations *before* exercising the code that calls mocks.
- **Too Strict Expectations Cause Test Failures:** Avoid over-specification of argument matchers and cardinalities; only specify what matters.
- **Sticky Expectations Blocking Calls:** If you want an expectation to be "used up," use `.RetiresOnSaturation()`.
- **Ambiguous Overloaded Methods:** Use argument matchers for disambiguation or helper wrappers.
- **Uninteresting Call Warnings:** Either add catch-all `EXPECT_CALL(...).Times(AnyNumber())`, switch to `NiceMock`, or verify your expectations.

### Best Practices
- Use `ON_CALL` in test fixtures or setup code to provide common default behaviors.
- Use `EXPECT_CALL` sparingly for calls you actually want to verify happened.
- Order expectations from general to specific to leverage "newer overrides older" matching.
- Use sequences or `.After()` only when call order matters to avoid brittle tests.
- Prefer matchers like `_` or range matchers over exact values when arguments are not crucial.

### Performance Considerations
- Avoid unnecessary complex actions to keep tests fast.
- Cache repeated actions if they are stateless for performance.

### Alternative Approaches
- Use fake implementations instead of mocks when you want to simulate behavior without strict call verification.
- Use `MockFunction` when you need a mock for a `std::function` callback.

---

## Next Steps & Related Content

- Learn to write mocks with the [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html).
- Explore [Using Mocks in Unit Tests](../guides/mocking-and-advanced-testing/using-mocks-in-unit-tests) for deeper use.
- See [Setting Expectations and Actions](../guides/mocking-and-advanced-testing/setting-expectations-and-actions) for advanced usage.
- Understand argument matching by reading the [Matchers Reference](reference/matchers.md).
- Learn about [Actions](docs/reference/actions.md) for customizing mock behavior.
- Manage test flow and order with [Sequences and Ordering](docs/gmock_cheat_sheet.md#expectation-order).

---

# Summary
This guide empowers you to master the core workflow of defining expectations and behaviors on mock objects using GoogleMock’s `ON_CALL` and `EXPECT_CALL` macros. You will understand how to specify when, how often, and what mock methods should do during tests, utilizing cardinalities, actions, sequences, and ordering constraints effectively.

### Key Sections Covered
- Distinguishing `ON_CALL` vs `EXPECT_CALL`
- Specifying argument matchers
- Controlling call frequency with `.Times()` and cardinalities
- Defining mock behavior with `.WillOnce()` and `.WillRepeatedly()` actions
- Managing multiple and ordered expectations
- Handling stickiness of expectations and `.RetiresOnSaturation()`
- Troubleshooting common pitfalls and best practices

### Important Links and References
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [GoogleTest Mocking Reference](reference/mocking.md)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](docs/reference/actions.md)
- [gMock Cheat Sheet](docs/gmock_cheat_sheet.md)
- [Using Mocks in Unit Tests Guide](../guides/mocking-and-advanced-testing/using-mocks-in-unit-tests)

### Cross-References
- Related pages in Core Fundamentals: [Mocking and Matchers](overview/core_fundamentals/mocking_and_matchers.mdx)
- See [gMock Cookbook](docs/gmock_cook_book.md) for recipes and advanced scenarios
- Setup info: [Configuring Your Project](getting-started/setup-and-installation/configuring-your-project.mdx)

### Next Actions
- Start writing concrete mocks and tests using these techniques
- Explore advanced topics such as parameterized matchers and actions
- Use sequences and partial orders to precisely control call ordering in complex tests
- Investigate debug options like `--gmock_verbose=info` for detailed call tracing


