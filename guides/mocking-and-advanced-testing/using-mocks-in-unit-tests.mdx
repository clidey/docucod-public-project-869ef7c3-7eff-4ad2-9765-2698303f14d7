---
title: "Using Mocks in Unit Tests"
description: "A practical walkthrough on creating and using mock objects to isolate components, fake dependencies, and precisely control test scenarios. Covers the basics of mock creation, expectation specification, and behavior definition."
---

# Using Mocks in Unit Tests

This guide will walk you through the fundamentals of using mock objects in your unit tests with GoogleMock (gMock). Mocking lets you isolate components, fake dependencies, and precisely specify how collaborators behave — all key to robust, focused testing.

---

## Workflow Overview

### What This Guide Helps You Accomplish
- Learn how to design mock classes that stand in for real dependencies in your unit tests.
- Understand setting up expectations for method calls: how often, with what arguments, and what they return or do.
- Control mock behaviors using default actions and specific call responses.
- Create tests that verify interactions between components confidently and cleanly.

### Prerequisites
- A C++ development environment with GoogleTest and GoogleMock installed and configured.
- Familiarity with C++ virtual functions and interfaces.
- Basic knowledge of unit testing concepts.

### Expected Outcome
You will be able to create mock classes, instantiate mocks, define expectations on mock method calls, specify behaviors, and integrate these mocks in your unit tests.

### Time Estimate
15–30 minutes for initial mastery and practical trial.

### Difficulty Level
Beginner to Intermediate

---

## Step-by-Step Instructions

### Step 1: Define Your Mock Class

Mock classes inherit from interfaces or abstract base classes used in your code under test. Using the `MOCK_METHOD` macro, you define mock implementations of virtual methods.

Key points:
- The base class methods must be **virtual** (especially destructors).
- Place all `MOCK_METHOD` declarations in the `public:` section, even if methods are protected or private.
- Include qualifiers like `(const, override)` if overriding `const` methods.

**Example:**

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
  virtual bool Process(int elem, int count) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(bool, Process, (int elem, int count), (override));
};
```

**Tip:** Wrap complex argument or return types in parentheses to avoid macro parsing issues, or use `using` type aliases.

---

### Step 2: Create Mock Objects in Your Tests

Instantiate your mock classes in your unit test functions or fixtures.

```cpp
TEST(MyTestSuite, UsesMock) {
  MockFoo mock_foo;
  // Proceed with expectations and exercising code
}
```

---

### Step 3: Set Default Actions with `ON_CALL`

Default actions define how the mock behaves **when you are not explicitly checking** a given call.

- Use `ON_CALL(mock_object, Method(matchers)).WillByDefault(action);`
- Default actions allow your tests to run smoothly even when lots of calls are made with no strict expectations.

Example:

```cpp
using ::testing::Return;
ON_CALL(mock_foo, GetSize()).WillByDefault(Return(10));
```

Now, if `GetSize()` is called without an explicit expectation, it returns 10.

---

### Step 4: Set Expectations with `EXPECT_CALL`

Expectations specify which calls must happen, their arguments, how many times, and what happens.

General syntax:

```cpp
EXPECT_CALL(mock_object, Method(matchers))
  .Times(cardinality)
  .WillOnce(action)
  .WillRepeatedly(action);
```

**Key elements:**
- **Matchers** (like `_` for any argument) specify which calls this expectation applies to.
- **Cardinality**, e.g., `Times(1)` or `Times(AnyNumber())`, controls how often the call should happen.
- **Actions** define what the mock method returns or does.

Example:

```cpp
EXPECT_CALL(mock_foo, Describe("abc"))
    .Times(3)
    .WillRepeatedly(Return("Category abc"));
```

This expects that `Describe("abc")` will be called three times and each time returns the string.

**Advanced:** You can chain multiple `WillOnce()` for sequential behaviors.

---

### Step 5: Use Your Mock in the Code Under Test

Pass the mock object or a pointer/reference to it into the system component you want to test. Exercise methods on this component, which will interact with your mock, triggering expectations and actions.

Example:

```cpp
std::string result = MyProductionFunction(&mock_foo);
EXPECT_EQ(result, "expected result");
```

---

### Step 6: Allow GoogleMock to Verify Expectations

When your mock objects are destructed, GoogleMock automatically checks if all expectations were met. No extra calls are usually needed.

If you need to verify early, use:

```cpp
Mock::VerifyAndClearExpectations(&mock_foo);
```

**Note:** Don't define new expectations on a mock after it has been verified or used.

---

## Examples & Code Samples

### Full Example of Mocking a Simple Interface

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class Database {
 public:
  virtual ~Database() {}
  virtual bool Connect(const std::string& url) = 0;
  virtual std::string Query(const std::string& sql) = 0;
};

class MockDatabase : public Database {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(std::string, Query, (const std::string& sql), (override));
};

TEST(DatabaseTest, ConnectsAndQueries) {
  MockDatabase mock_db;

  ON_CALL(mock_db, Connect(_)).WillByDefault(Return(true));
  EXPECT_CALL(mock_db, Connect("db://localhost"));

  EXPECT_CALL(mock_db, Query("SELECT * FROM users"))
      .WillOnce(Return("user1,user2"));

  MyApp app(&mock_db);

  EXPECT_TRUE(app.Initialize("db://localhost"));
  EXPECT_EQ(app.GetUsers(), "user1,user2");
}
```

In this simplified test:
- We define default behavior for `Connect` to always succeed for any URL.
- We expect a specific call to `Connect` with the URL "db://localhost".
- We expect a call to `Query` with a particular SQL statement and specify the return data.
- The test verifies that `MyApp` uses these mock methods as expected.

---

## Troubleshooting & Tips

### Common Issues
- **Mock methods must be virtual:** Non-virtual methods cannot be mocked directly.
- **Uninteresting calls warnings:** If a mock method is called without an `EXPECT_CALL`, gMock warns by default. Use `NiceMock` to suppress these warnings or define `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())`.
- **Over-saturated calls:** If a mock method is called more times than specified in `Times()`, gMock fails the test.
- **Incorrect matchers:** Ensure your argument matchers align with the method signature and intended checks.
- **Order constraints:** Use `InSequence` or `After` clauses to enforce call ordering where necessary.

### Best Practices
- Prefer **`ON_CALL`** for default behavior; use **`EXPECT_CALL`** only to verify calls you care about.
- Keep expectations as loose as possible to avoid brittle tests.
- Use `NiceMock` when you want to avoid warnings about uninteresting calls.
- Use **sequences** (`InSequence`) to verify strict call orders.
- Use `RetiresOnSaturation()` if you want expectations to become inactive after being met.
- Avoid mocking concrete classes directly—prefer coding to interfaces.

### Performance Considerations
- Define mock constructors/destructors in `.cc` files to speed up builds with large mocks.
- Limit the number of expectations and elaborate matchers to those necessary for the test.

### Alternative Approaches
- Use **delegation** to real or fake implementations when behavior is mostly accurate but needs verification.
- For non-virtual methods, consider template-based mocking or other dependency injection techniques.

---

## Next Steps & Related Content

- **Setting Expectations and Actions:** Learn how to specify call counts, ordering, and complex behaviors.
- **Matchers Reference:** Explore the rich set of matchers to precisely validate function arguments.
- **Using GoogleMock: Basics:** For a practical primer on mocking basics.
- **Troubleshooting Common Setup Issues:** Solve build and linking troubles.
- **Writing Your First Test:** Combine mocking with test writing.
- **Mocking API Reference:** Dive into detailed macros and classes.

For quick syntax reference, see the [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html).

---

**Key Links:**
- [Mocking Reference](reference/mocking.md)
- [gMock Cookbook](docs/gmock_cook_book.md)
- [gMock for Dummies](docs/gmock_for_dummies.md)
- [Matchers Reference](reference/matchers.md)
- [Using Mocks in Unit Tests Guide](guides/mocking-and-advanced-testing/using-mocks-in-unit-tests)

---

<Info>
Remember: GoogleMock automatically checks expectations when the mock object is destroyed. If your mock objects are leaked or not properly destroyed, your tests might not catch violated expectations. Use `Mock::AllowLeak(&mock_object);` cautiously to bypass leaks only when intentional.
</Info>

<Warning>
Expectations must be set before the mock methods are called. Setting expectations after exercising the mock leads to undefined behavior.
</Warning>

<Check>
Best practice: Start with `ON_CALL` to define defaults and use `EXPECT_CALL` sparingly to verify critical interactions.
</Check>

---

### Visual Workflow Summary

```mermaid
flowchart TD
  A[Define Mock Class with MOCK_METHOD] --> B[Create Mock Object in Test]
  B --> C[Set Default Behavior with ON_CALL]
  C --> D[Set Expectations with EXPECT_CALL]
  D --> E[Exercise Code Under Test Using Mock]
  E --> F[GoogleMock Verifies Expectations on Destruction]
  F --> G[Explicit Verification Optional (Mock::VerifyAndClearExpectations)]
```

---

End of guide.