---
title: "Writing Custom Matchers and Actions"
description: "Step-by-step creation of custom matchers and actions to extend GoogleTest and GoogleMock, enabling expressive, domain-specific assertions and behaviors. Explains patterns for reusable and maintainable extensions."
---

# Writing Custom Matchers and Actions

Extend GoogleTest and GoogleMock beyond built-in capabilities by creating your own custom matchers and actions. This enables you to write expressive, domain-specific assertions and behaviors that integrate tightly with your code's unique requirements. This guide leads you through practical steps for designing reusable, maintainable custom matchers and actions that empower your tests.

---

## 1. Understanding the Purpose

Custom matchers allow you to define specialized logic that verifies complex properties of arguments passed to mock methods. Custom actions enable you to specify detailed behaviors mock methods perform beyond simple returns.

By writing your own, you gain:

- **Expressiveness**: Assert conditions that built-in matchers cannot cover.
- **Reusability**: Encapsulate common verification logic for multiple tests.
- **Clarity**: Simplify test code by abstracting detailed checks.

---

## 2. Writing a Simple Custom Matcher with `MATCHER` Macro

The easiest way to create a custom matcher is to use the `MATCHER` macro from GoogleMock. It defines a matcher with a clear syntax and auto-generates helpful failure messages.

### Step-by-Step

1. **Define the matcher in a namespace scope:**

    ```cpp
    MATCHER(IsEven, "") {
      return (arg % 2) == 0;
    }
    ```

2. **Use it in your tests:**

    ```cpp
    EXPECT_CALL(mock, SomeMethod(IsEven()));
    EXPECT_THAT(value, IsEven());
    ```

3. **Add custom failure messages:**

    You can stream more explanation by writing to a hidden `result_listener`:

    ```cpp
    MATCHER(IsEven, "") {
      if ((arg % 2) == 0) return true;
      *result_listener << "the remainder is " << (arg % 2);
      return false;
    }
    ```

### Notes

- `arg` refers to the value being matched.
- `arg_type` refers to its type (polymorphic).
- The string description can be left empty; GoogleMock will infer it.

---

## 3. Parameterized Matchers with `MATCHER_P` and Variants

If your matcher needs parameters, use `MATCHER_P`, `MATCHER_P2`, ..., up to `MATCHER_P10`.

### Example

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}

// Usage
EXPECT_THAT(number, HasAbsoluteValue(5));
```

### Best Practices

- Include parameter values in the description string to get meaningful error messages.
- Use `value_type` within the macro body to refer to parameter types.

---

## 4. Implementing Advanced Matchers Manually

For more control, define a matcher class implementing the matcher interface:

```cpp
class DivisibleBy7Matcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    int remainder = n % 7;
    if (remainder != 0 && os) *os << "the remainder is " << remainder;
    return remainder == 0;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by 7";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by 7";
  }
};

::testing::Matcher<int> DivisibleBy7() {
  return ::testing::Matcher<int>(new DivisibleBy7Matcher());
}
```

Use `DivisibleBy7()` in your expectations in the same way.

---

## 5. Writing Polymorphic Matchers

To support multiple types (polymorphism), template your matcher methods:

```cpp
template <typename T>
bool MatchAndExplain(T* p, std::ostream* os) const {
  return p != nullptr;
}
```

Use `MakePolymorphicMatcher` to wrap the class when exposing the matcher function.

---

## 6. Creating Custom Actions

When built-in actions like `Return()` or `SetArgPointee()` donâ€™t meet your needs, write custom actions by providing a callable object matching the mock function signature.

### Quick Example Using Lambdas

```cpp
EXPECT_CALL(mock, Compute(_))
    .WillOnce([](int x) { return x * 2; });
```

### More Structured Custom Action

```cpp
struct MultiplyBy {
  int factor;
  template <typename T>
  T operator()(T arg) { return arg * factor; }
};
...
EXPECT_CALL(mock, Compute(_))
    .WillOnce(MultiplyBy{3});
```

### Notes

- The callable can take no arguments if it ignores the mock method's parameters.
- For polymorphic actions usable with multiple mock method signatures, use `MakePolymorphicAction()`.

---

## 7. Best Practices for Custom Matchers and Actions

- **Keep matchers side-effect free:** Matchers may be called multiple times and in arbitrary order.
- **Use precise descriptions:** Great failure messages are invaluable.
- **Reuse matchers and actions:** Store complex matchers/actions in variables to avoid repetition and improve readability.
- **Consider composability:** Compose matchers using `AllOf()`, `AnyOf()`, and other combinators.
- **Program defensively:** Validate parameters inside matchers to prevent surprises.

---

## 8. Common Pitfalls and Troubleshooting

### Commas in Template Arguments

If argument types contain unprotected commas (e.g., `std::pair<int, int>`), wrap the type in extra parentheses or use `using` aliases to avoid macro parsing errors.

### Unexpected Behavior or Overloads

Ensure you disambiguate overloaded methods when using matchers or actions with custom types.

### Side Effects in Matchers

Avoid calling mock methods or modifying state from matcher code.

### Sharing Matchers and Actions

You can safely share matcher and action objects as they manage references internally.

---

## 9. Summary

Custom matchers and actions empower your tests to express domain-specific assertions precisely and perform complex behaviors in mocks. Start with simple `MATCHER` macros, move to parameterized `MATCHER_P` variants for added flexibility, and implement custom interfaces for advanced control. Complement them with custom actions written as lambdas or callables to control mock method behaviors fully.

Iteration and thoughtful design of these extensions improve test clarity, robustness, and maintainability.

---

## 10. See Also

- [gMock Cookbook - Writing New Matchers](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#writing-new-matchers)
- [gMock Cookbook - Writing New Actions](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#writing-new-actions)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)
- [Mocking Reference - Writing Expectations](https://google.github.io/googletest/reference/mocking.html#writing-expectations)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)

---

<Check>
Start your journey by defining simple custom matchers with `MATCHER`. Slowly increase complexity by adding parameters (`MATCHER_P`) and implementing matcher classes for fine-grained control. Use callable objects for actions and adhere to side-effect rules for robustness. Revisiting examples in the official gMock Cookbook deepens understanding.
</Check>
