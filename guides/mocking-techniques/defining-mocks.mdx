---
title: "Defining and Using Mock Classes"
description: "Step-by-step tutorial on using the MOCK_METHOD macros to create versatile mock classes. Covers method qualifiers, handling overloaded methods, and integrating mocks into your test suites."
---

# Defining and Using Mock Classes

This guide provides a practical, step-by-step tutorial on defining mock classes with Google Mock using the `MOCK_METHOD` macros. You'll learn how to handle method qualifiers, overloaded methods, and effectively integrate mocks into your test suites for reliable and maintainable C++ testing.

---

## 1. Overview of Defining Mock Classes

### What This Guide Covers
- How to use the `MOCK_METHOD` macro to create flexible mock class methods.
- Handling method qualifiers such as `const`, `override`, `noexcept`, and calling conventions.
- Strategies to mock overloaded methods.
- Integrating mock classes seamlessly into your test workflows.

### Prerequisites
- Familiarity with C++ virtual methods and inheritance.
- Basic understanding of unit testing concepts.
- Google Mock installed and working in your environment.

### Expected Outcome
After following this guide, you'll be able to define mock classes that correctly override interfaces or classes under test, manage various method signatures and qualifiers, and use these mock classes effectively in your tests.

### Difficulty Level
Intermediate - assumes experience with C++ and testing frameworks.

---

## 2. Creating a Basic Mock Class with `MOCK_METHOD`

Google Mock defines mock methods inside a mock class using the `MOCK_METHOD` macro. The macro's signature is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- **ReturnType**: The return type of the mocked method.
- **MethodName**: The name of the method.
- **Args...**: The argument list, enclosed in parentheses.
- **Qualifiers** (optional): Method qualifiers like `const`, `override`, `noexcept`, etc.

### Example: Simple Mock Class
Given an interface:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual int GetX() const = 0;
};
```

You can define a mock class as:

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

Note:
- Place `MOCK_METHOD` only in the `public` section, regardless of the base class's accessibility.
- The `override` qualifier assures the method overrides a virtual method.

---

## 3. Handling Method Qualifiers

The `MOCK_METHOD` macro supports several qualifiers to match method signatures exactly.

| Qualifier                  | Purpose                                                                        |
|----------------------------|--------------------------------------------------------------------------------|
| `const`                    | Makes the mocked method `const`. Required when mocking `const` methods.          |
| `override`                 | Indicates the method overrides a virtual method. Recommended for safety.       |
| `noexcept`                 | Marks the method as `noexcept`. Required if overriding a `noexcept` method.     |
| `Calltype(...)`            | Specifies the calling convention (e.g., `Calltype(STDMETHODCALLTYPE)` on Windows).
| `ref(&)` or `ref(&&)`      | Specifies reference qualifiers (for methods that are lvalue or rvalue reference qualified).

### Example: Mocking a `const` and `noexcept` Method
```cpp
class Foo {
 public:
  virtual int GetData() const noexcept = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetData, (), (const, noexcept, override));
};
```

---

## 4. Dealing with Commas in Template Arguments

Types containing commas (like `std::pair` or template classes with multiple parameters) break the macro parsing unless handled carefully.

### Solutions:

- **Parentheses Wrapping:** Wrap the type in an extra pair of parentheses:

  ```cpp
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));
  ```

- **Type Aliases:** Define an alias and use it:

  ```cpp
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
  using MapIntDouble = std::map<int, double>;
  MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
  ```

This keeps the macro expansion and C++ syntax clean.

---

## 5. Mocking Overloaded Methods

To mock overloaded methods, explicitly declare each overload using `MOCK_METHOD`.
Make sure to include the method qualifiers and argument types, so the compiler can distinguish the overloads.

### Example:
```cpp
class Foo {
 public:
  virtual ~Foo();
  virtual int Add(int x);
  virtual int Add(int times, int x);
  virtual int& GetBar();
  virtual const int& GetBar() const;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (int times, int x), (override));
  MOCK_METHOD(int&, GetBar, (), (override));
  MOCK_METHOD(const int&, GetBar, (), (const, override));
};
```

### Tip:
- If you mock some overloads and omit others, the omitted base class versions become hidden. Use `using Foo::Add;` inside your mock to avoid this.

---

## 6. Mocking Non-Virtual Methods

While not typical, gMock supports mocking *non-virtual* methods by defining mock classes unrelated to the real classes but with matching method signatures.

### Example:
```cpp
class ConcreteStream {
 public:
  void AppendPacket(Packet* packet);
  const Packet* GetPacket(size_t packet_number) const;
  size_t NumberOfPackets() const;
};

class MockStream {
 public:
  MOCK_METHOD(const Packet*, GetPacket, (size_t packet_number), (const));
  MOCK_METHOD(size_t, NumberOfPackets, (), (const));
};
```

Because these mocks are unrelated by inheritance, to use mocks effectively, you typically need template-based or compile-time polymorphism.

---

## 7. Integrating Mocks in Your Test Suite

Once you define your mock classes, you can instantiate and use them in your tests as follows:

### Typical usage workflow:

1. Include Google Mock headers:

   ```cpp
   #include <gmock/gmock.h>
   #include <gtest/gtest.h>
   ```

2. Use the mock class:

   ```cpp
   TEST(MyTest, Example) {
     MockFoo mock;

     EXPECT_CALL(mock, Add(5))
         .Times(1)
         .WillOnce(testing::Return(10));

     int result = mock.Add(5);
     EXPECT_EQ(result, 10);
   }
   ```

3. For uninteresting calls (mock method calls without expectations), consider using `NiceMock` or `StrictMock` wrappers if you want to control warnings or errors:

   ```cpp
   using ::testing::NiceMock;
   NiceMock<MockFoo> nice_mock;
   EXPECT_CALL(nice_mock, Add(5)).Times(1);
   ```

### Additional tips:
- Use `ON_CALL` to specify default behavior without setting expectations:

  ```cpp
  ON_CALL(mock, Add(_)).WillByDefault(testing::Return(0));
  ```

- Verify expectations are met automatically at mock destruction, or explicitly call:

  ```cpp
  testing::Mock::VerifyAndClearExpectations(&mock);
  ```

---

## 8. Common Pitfalls & Best Practices

- Always put mock method definitions in the `public:` section of the mock class.
- Use method qualifiers properly to match exactly the base class methods.
- Use `RetiresOnSaturation()` or sequences to manage expectations properly when multiple calls are expected.
- Avoid over-specifying expectations to reduce brittle tests.
- Use `using BaseClass::OverloadedMethod` to avoid hiding base class overloaded methods unintentionally.
- For methods returning references, use `ReturnRef()` instead of `Return()`.

<Tip>
When mocking overloaded methods, remember that missing a mock for an overload hides base methods and can lead to confusing compiler errors or test failures. Use `using` declarations to mitigate this.
</Tip>

<Warning>
Be cautious when mocking non-virtual methods as this requires patterns beyond inheritance and may complicate test design.
</Warning>

---

## 9. Troubleshooting

### Issue: Compilation errors due to commas in method argument types
- Wrap the argument type in extra parentheses or
- Create type aliases.

### Issue: Warning about overriding const parameters in MSVC
- MSVC treats const parameters top-level qualifier as insignificant; consider removing `const` from parameters that are passed by value.

### Issue: Unexpected warnings about uninteresting calls
- Use `EXPECT_CALL` to specify expected calls or use `NiceMock` to suppress warnings for uninteresting calls.

### Issue: Mock expectations not met
- Run tests with `--gmock_verbose=info` to see detailed expectation matching and invocation traces.

---

## 10. Example: Mocking a Complex Interface

```cpp
class Widget {
 public:
  virtual ~Widget() {}
  virtual std::pair<int, bool> GetStatus() const = 0;
  virtual bool Update(std::map<int, double> values, bool flag) noexcept = 0;
};

using StatusType = std::pair<int, bool>;
using MapType = std::map<int, double>;

class MockWidget : public Widget {
 public:
  // Using type aliases to handle commas safely
  MOCK_METHOD(StatusType, GetStatus, (), (const, override));
  MOCK_METHOD(bool, Update, (MapType values, bool flag), (noexcept, override));
};

TEST(WidgetTest, UpdateTest) {
  MockWidget mock;
  EXPECT_CALL(mock, GetStatus())
      .WillOnce(testing::Return(StatusType{42, true}));

  EXPECT_CALL(mock, Update(testing::_, testing::_))
      .WillOnce(testing::Return(true));

  auto status = mock.GetStatus();
  EXPECT_TRUE(status.second);
  bool updated = mock.Update({{1, 2.3}, {4, 5.6}}, true);
  EXPECT_TRUE(updated);
}
```

---

## 11. Summary

By mastering the `MOCK_METHOD` macro and understanding how to handle method qualifiers, overloaded methods, and integration details, you can write flexible and maintainable mock classes in Google Mock. This empowers you to create precise and robust unit tests that clearly express intent, handle complex interfaces, and integrate smoothly with Google Test.

---

## 12. Additional Resources
- [GoogleMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) - detailed mock usage patterns.
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) - full API details.
- [gMock for Dummies](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md) - beginner walkthrough.
- [Mocking Cheat Sheet](https://github.com/google/googletest/blob/main/docs/gmock_cheat_sheet.md) - quick syntax reference.

---

<Callout title="Remember">
Always place your `MOCK_METHOD` declarations in the `public` section **even if** the base method is private or protected; this is required for Google Mock internals to work correctly.
</Callout>