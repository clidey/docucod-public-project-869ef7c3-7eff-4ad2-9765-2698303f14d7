---
title: "Argument Matching and Advanced Matchers"
description: "Demonstrates how to use built-in and custom argument matchers to express precise test conditions. Covers composing matchers, custom types, and best practices for clear assertion reporting."
---

# Argument Matching and Advanced Matchers

This guide demonstrates how to use GoogleMock's built-in and custom argument matchers to express precise test conditions. It covers how to compose matchers, handle custom or complex types, and best practices for clear assertion reporting.

---

## Workflow Overview

### Purpose
This page focuses specifically on argument matching within expectations and default behaviors, detailing how to use and create sophisticated matchers to accurately express the conditions for mock method arguments in tests.

### Prerequisites
- Understanding of basic mock creation and setting expectations using `EXPECT_CALL` and `ON_CALL`.
- Familiarity with GoogleTest and GoogleMock basics.

### Expected Outcome
After completing this guide, you will be able to:
- Use built-in argument matchers effectively.
- Create custom argument matchers with and without parameters.
- Combine matchers logically for complex argument validation.
- Apply multi-argument matchers to validate tuples of arguments.
- Improve assertion messages with enhanced matcher descriptions.

### Time Estimate
15-30 minutes, depending on experience with GoogleMock and familiarity with C++ templates.

### Difficulty Level
Intermediate

---

## Step-by-Step Instructions

### 1. Use Built-In Argument Matchers

GoogleMock provides a variety of built-in matchers for common cases:

- Use `_` to match any value of the correct type.
- Use `Eq(value)` or simply the value itself to match exact equality.
- Use relational matchers like `Lt(value)`, `Le(value)`, `Gt(value)`, `Ge(value)`, and `Ne(value)` for relational conditions.
- Use pointer matchers like `IsNull()`, `NotNull()` to match null or non-null pointers.
- Use specialized matchers like `StrEq`, `StartsWith`, `EndsWith`, `HasSubstr` for strings.

**Example:**
```cpp
EXPECT_CALL(mock_object, FunctionName(Ge(5), _, StrCaseEq("hello")));
```


### 2. Use Multi-Argument Matchers (.With Clause)

Sometimes you want to match all arguments of a mock function as a single tuple to express correlations between arguments.

Use `.With(multi_arg_matcher)` where `multi_arg_matcher` matches a tuple of the function's arguments.

- `AllArgs(m)` applies matcher `m` to all arguments.
- `Args<N1, N2, ..., Nk>(m)` selects specific argument indices for matching.
- Use built-in multi-argument matchers like `Lt()`, `Eq()` (for tuples) or combine matchers yourself.

**Example:**
```cpp
EXPECT_CALL(mock, SetRange(Ne(0), _))
    .With(Lt());  // First arg less than second
```


### 3. Define Custom Matchers Using MATCHER and MATCHER_P Macros

When built-in matchers aren't enough, define custom matchers:

- `MATCHER(name, "description") { return bool_expr; }` defines a parameterless matcher.
- `MATCHER_P(name, param, "description") { return bool_expr; }` defines a matcher with one parameter.
- You can capture additional context and stream explanatory messages to `*result_listener`.
- Use `arg` to access the argument value to be matched.

**Basic Example:**
```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}
EXPECT_CALL(mock, SomeMethod(IsEven()));
```

**Parameterized Example:**
```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}
EXPECT_THAT(x, HasAbsoluteValue(10));
```


### 4. Combine Matchers for Complex Conditions

- Use `AllOf(m1, m2, ...)` to require all to match.
- Use `AnyOf(m1, m2, ...)` to match any.
- Use `Not(m)` to negate.
- Combine matchers for expressive and concise validation.

**Example:**
```cpp
EXPECT_CALL(mock, Foo(AllOf(Ge(0), Ne(10))));
```


### 5. Use Member and Pointer Matchers

- `Field(&Class::field, matcher)` matches an object's member field.
- `Property(&Class::method, matcher)` matches the result of a const getter.
- `Pointee(matcher)` matches the value pointed to by the pointer argument (works with raw or smart pointers).
- `Pointer(matcher)` matches pointer values.

**Example:**
```cpp
EXPECT_CALL(mock, Bar(Field(&Foo::number, Ge(3))));
EXPECT_CALL(mock, Baz(Pointee(Ne(0))));
```


### 6. Use Container Matchers for STL-like Containers

Common container matchers include:

- `ElementsAre(...)` matches container elements in order.
- `UnorderedElementsAre(...)` matches container elements ignoring order.
- `ElementsAreArray(...)` and `UnorderedElementsAreArray(...)` work with array or container inputs.
- `Contains(element)` expects the container to have at least one matching element.
- `Each(element)` expects all elements to match.
- `SizeIs(matcher)` checks container size.
- `Pointwise(matcher, container)` matches corresponding pairs.

**Example:**
```cpp
EXPECT_CALL(mock, ProcessVec(ElementsAre(1, 2, 3)));
EXPECT_CALL(mock, ProcessVec(UnorderedElementsAre(3, 1, 2)));
```


### 7. Cast Matchers Safely with SafeMatcherCast<T>

Sometimes matcher types don't exactly match argument types but are safely compatible. Use `SafeMatcherCast<T>(matcher)` to convert a matcher to a compatible type.

**Example:**
```cpp
Matcher<long> long_matcher = ...;
EXPECT_CALL(mock, Func(SafeMatcherCast<int>(long_matcher)));
```


### 8. Use Matchers as Predicates or in Assertions

- Use `EXPECT_THAT(value, matcher)` to assert a value matches a matcher.
- Use `Matches(matcher)` to convert a matcher to a predicate functor.

**Example:**
```cpp
EXPECT_THAT(vec.size(), Ge(3));
EXPECT_THAT(my_string, StartsWith("file_"));
int count = std::count_if(container.begin(), container.end(), Matches(Gt(0)));
```


## Examples & Code Samples

### Custom Matcher: Divisible by 7
```cpp
MATCHER(IsDivisibleBy7, "") {
  if (arg % 7 == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}

EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
EXPECT_THAT(value, IsDivisibleBy7());
```


### Composite Matcher
```cpp
EXPECT_CALL(mock, Foo(AllOf(Gt(5), Ne(10))));
```


### Member Field Matcher
```cpp
EXPECT_CALL(mock, Bar(Field(&Foo::number, Ge(3))));
```


### Pointwise Container Matcher
```cpp
std::vector<int> expected = {1, 4, 9};
EXPECT_CALL(mock, ProcessData(Pointwise(Eq(), expected)));
```


### Using SafeMatcherCast
```cpp
Matcher<long> m = Ge(5);
EXPECT_CALL(mock, Func(SafeMatcherCast<int>(m)));
```

---

## Troubleshooting & Tips

### Common Issues
- **Ambiguous Overloads:** When mocking overloaded methods, specify exact argument matchers or use `Const()` to disambiguate const overloads.
- **Matcher Type Mismatches:** Use `SafeMatcherCast` to avoid compilation errors due to subtle type incompatibilities.
- **Unexpected Matches:** Remember that `EXPECT_CALL`s are matched in last-defined order. Be mindful of overlapping matchers.

### Best Practices
- Use `.With()` sparingly and only once per expectation to improve clarity and correctness.
- Combine matchers logically to avoid overly stringent or overly lax argument expectations.
- Always provide meaningful description strings in custom matchers to improve failure diagnostics.
- Use member and property matchers for elegant validation of complex objects.

### Performance Considerations
- Matcher objects are cheap to copy; store complex matchers in variables to reuse.
- Custom matchers should be pure functions without side effects.

### Alternative Approaches
- When needing predicate-based matching with complex logic, use `Truly(predicate)`.
- Define polymorphic matchers when you want a matcher to apply to multiple types.

---

## Next Steps & Related Content

### What's Next?
- Explore [`Setting Expectations and Actions`](guides/mocking-techniques/expectations-and-actions) to learn how to tie matchers to behavior.
- Review [`Creating and Using Mock Objects`](guides/mocking-techniques/creating-mocks) for mock class definitions.
- Learn about custom actions and matchers in [`Defining Custom Actions and Matchers`](guides/advanced-and-integration/custom-actions-matchers).

### Related Guides
- [gMock for Dummies](docs/gmock_for_dummies.md): Clear introduction to mock basics.
- [Mocking Reference](docs/reference/mocking.md): Detailed macro and class reference.
- [Matchers Reference](docs/reference/matchers.md): Comprehensive matcher documentation.
- [gMock Cookbook](docs/gmock_cook_book.md): Recipes for common and advanced mock usage.

### Resources
- GoogleMock GitHub Repository: [https://github.com/google/googletest](https://github.com/google/googletest)
- Matcher Implementation Source: `googlemock/include/gmock/gmock-matchers.h`

---

<Check>
Remember: Use `ON_CALL` to define default mock behavior and `EXPECT_CALL` to set expectations you want to verify.
</Check>

<Check>
Matchers must be pure functions with no side effects.
</Check>

<Note>
`MATCHER` macros cannot be defined in local or member scopes; must be namespace-level.
</Note>

<Warning>
Passing arguments by reference in matchers means you must keep the referred objects alive until the matcher is used.
</Warning>

---