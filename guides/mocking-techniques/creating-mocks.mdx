---
title: "Creating and Using Mock Objects"
description: "How to define and implement mock classes for C++ interfaces using GoogleMock. Includes practical examples, setup, and cleanup patterns."
---

# Creating and Using Mock Objects

GoogleMock empowers C++ developers to create and implement mock classes for interfaces efficiently, enabling precise and flexible testing of interactions in complex systems. This guide walks you through defining mock classes for your C++ interfaces, setting up expectations and behaviors, and best practices for working with mocks.

---

## 1. Introduction

Mock objects mimic real object interfaces, allowing you to specify method call expectations, argument matching, call counts, returns, and invocation order without relying on real implementations. This enables fast, reliable, and focused testing of software components.

In GoogleMock, **mock classes** are user-defined C++ classes that inherit from interfaces or abstract classes, with methods replaced by mocked versions using the `MOCK_METHOD` macro. Mock objects are then instantiated in tests to verify interactions with your code.

---

## 2. Workflow Overview

- **Task Description**: Define, implement, and use mock classes to verify interactions with C++ interfaces using GoogleMock.
- **Prerequisites**:
  - An existing C++ interface or abstract class with virtual methods.
  - GoogleMock included and configured in your project.
  - Familiarity with C++ classes, inheritance, and virtual functions.
- **Expected Outcome**:
  - You will have a mock class that can replace the real interface in tests.
  - You will set up expectations on mocked methods and verify they are called as intended.
- **Time Estimate**: Approximately 15-30 minutes for initial setup and mock creation.
- **Difficulty Level**: Intermediate C++ knowledge assumed.

---

## 3. Defining a Mock Class

### 3.1 Basic Mock Class Definition

1. **Create a new class** that inherits from your interface or abstract class.
2. **For each virtual method to mock, add a `MOCK_METHOD` macro invocation** in the public section.

Syntax:

```cpp
MOCK_METHOD(return_type, MethodName, (argument_types), (specifiers));
```

- The first parameter is the method's return type.
- The second parameter is the method name.
- The third parameter is a parenthesized list of the method arguments.
- The optional fourth parameter consists of specifiers like `override`, `const`, and calling conventions.

Example: Mocking a simple graphics `Turtle` interface:

```cpp
#include <gmock/gmock.h>  // Include GoogleMock

class Turtle {  
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

After defining such a mock class, you can instantiate `MockTurtle` in tests, set expectations on its methods, and verify behavior.

### 3.2 Handling Complex Return Types and Unprotected Commas

If your method's return type or argument types contain commas (e.g., STL types like `std::pair`), wrap the type in an extra pair of parentheses or use type aliases:

```cpp
class MockFoo {
 public:
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((std::map<int, double>), bool));

  // Alternatively, use type aliases for clarity:
  using BoolAndInt = std::pair<bool, int>;
  MOCK_METHOD(BoolAndInt, GetPair, ());
  using MapIntDouble = std::map<int, double>;
  MOCK_METHOD(bool, CheckMap, (MapIntDouble, bool));
};
```

### 3.3 Mocking Const and Overloaded Methods

Add `(const, override)` in the specifiers for const methods. For overloaded methods, define mock methods for each overload explicitly. To avoid hiding base class methods, use `using BaseClass::MethodName;` to bring hidden overloads into scope.

```cpp
class Foo {
 public:
  virtual int Add(int x);
  virtual int Add(int x, int y);
  virtual int GetValue() const;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (int x, int y), (override));
  MOCK_METHOD(int, GetValue, (), (const, override));
  using Foo::Add;  // Bring hidden overloads into scope
};
```

### 3.4 Mocking Non-Virtual Methods (Hi-Perf Dependency Injection)

You can mock non-virtual methods by defining a separate mock class unrelated to the original one, with identical method signatures:

```cpp
class RealClass {
 public:
  void Process(int param);
  int GetValue() const;
};

class MockClass {
 public:
  MOCK_METHOD(void, Process, (int param));
  MOCK_METHOD(int, GetValue, (), (const));
};
```

Then use template injection or other compile-time techniques to substitute mocks in your code.

---

## 4. Using Mock Objects in Tests

1. **Import GoogleMock symbols and namespaces:**

```cpp
using ::testing::Return;
using ::testing::_;  // Wildcard matcher
```

2. **Create a mock object instance:**

```cpp
MockTurtle mock_turtle;
```

3. **Set expectations on mock methods:**

```cpp
EXPECT_CALL(mock_turtle, PenDown())
    .Times(1);  // Expect called exactly once
EXPECT_CALL(mock_turtle, Forward(100))
    .Times(1)
    .WillOnce(Return());  // Void return example
EXPECT_CALL(mock_turtle, GetX())
    .WillRepeatedly(Return(42));  // Always returns 42
```

4. **Exercise code under test that uses the mock:**

```cpp
painter.DrawCircle(&mock_turtle);
```

5. **Automatic verification:** GoogleMock verifies all expectations are met when the mock object is destroyed.

---

## 5. Setting Default Actions and Expectations

### 5.1 ON_CALL vs EXPECT_CALL

- `ON_CALL` specifies the default behavior when a mock method is called but does **not** set an expectation that the call must occur.
- `EXPECT_CALL` sets an expectation that a method **must** be called with specified argument matchers, and optionally controls the number of times and order.

Example:

```cpp
ON_CALL(mock_turtle, GetX())
    .WillByDefault(Return(10));  // Do this by default when GetX() is called

EXPECT_CALL(mock_turtle, Forward(100))
    .Times(1);  // Expect Forward(100) exactly once
```

### 5.2 Wildcards and Matchers

Use `_` to match any value for a method argument, or specify detailed matchers to constrain calls.

```cpp
EXPECT_CALL(mock_turtle, GoTo(50, _));  // X == 50, any Y
```

### 5.3 Controlling Call Counts

Use the `Times()` clause with cardinalities like:
- `Times(1)`, `Times(Exactly(n))` for exact count
- `Times(AtLeast(n))`, `Times(AtMost(n))` for ranges
- `Times(AnyNumber())` to allow any number

If omitted, GoogleMock infers the cardinality based on presence of `WillOnce` and/or `WillRepeatedly`.

### 5.4 Specifying Return and Side Effect Actions

Use `.WillOnce(...)` for specific call actions and `.WillRepeatedly(...)` for all subsequent calls.

```cpp
EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

For void methods or side effects, use actions like `SetArgPointee<N>(value)`, lambdas, or `Invoke()`.

---

## 6. Best Practices and Common Patterns

### 6.1 Where to Define Mock Classes

- Prefer placing mock classes in test or dedicated testing source files.
- For third-party interfaces, consider writing mock adaptor interfaces you own.

### 6.2 Use NiceMock, StrictMock, or NaggyMock Generators

- `NiceMock<T>` suppresses warnings on uninteresting calls.
- `NaggyMock<T>` (default) prints warnings on uninteresting calls.
- `StrictMock<T>` treats uninteresting calls as failures.

Use these wrappers to control warnings for your mocks:

```cpp
using ::testing::NiceMock;
NiceMock<MockTurtle> mock;
```

### 6.3 Ordering Calls

Use `InSequence seq;` block or `.InSequence()` clause to specify call order expectations.

### 6.4 Delegating Defaults to Fake or Real Objects

You can delegate your mock's default behavior to a "fake" or real implementation keeping the ability to verify calls. This requires setting `ON_CALL` with lambdas.

### 6.5 Mocking Destructors

Since destructors cannot be mocked directly, add a mock method `Die()` and call it in the destructor to verify destruction order.

---

## 7. Troubleshooting and Tips

- **Uninteresting Calls:** Warnings occur when a mock method is called without an expectation. Use `NiceMock` or add catch-all `EXPECT_CALL`s to suppress.
- **Order of Expectations:** The last matching `EXPECT_CALL` always takes precedence. Define more specific expectations after general ones.
- **Default Return Values:** By default, GoogleMock returns default values (0, false, nullptr). Use `ON_CALL` or `DefaultValue<T>` to customize.
- **Duplicated Calls:** Exceeding specified `Times()` results in errors.
- **Mock Leaks:** Use heap checker tools or call `Mock::AllowLeak(&mock_object)` to prevent false positives.

---

## 8. Next Steps & Related Content

- Explore [Setting Expectations](https://github.com/google/googletest/tree/main/docs/reference/mocking.md#EXPECT_CALL) in Mocking Reference.
- Learn advanced patterns in [Setting Expectations and Actions](https://github.com/google/googletest/tree/main/docs/gmock_cook_book.md).
- Consult [Mastering Assertions](https://github.com/google/googletest/tree/main/docs/guides/core-testing-workflows/using-assertions.md) for integrating mocks with assertions.
- Review the [Quickstart: CMake and Bazel](https://github.com/google/googletest/tree/main/docs/guides/getting-started/quickstart-cmake-bazel.md) to ensure environment is correctly set up for running mock tests.

---

## 9. Practical Example

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

using ::testing::Return;
using ::testing::_;

// Interface to be mocked
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

// Mock class
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

// Test example
TEST(PainterTest, DrawCircleCallsCorrectMethods) {
  MockTurtle mock_turtle;

  // Expect PenDown() to be called once
  EXPECT_CALL(mock_turtle, PenDown()).Times(1);

  // Expect Forward() called with any integer >= 0
  EXPECT_CALL(mock_turtle, Forward(_)).Times(5);

  // Provide a default return value
  ON_CALL(mock_turtle, GetX()).WillByDefault(Return(42));

  // Use mock in production code
  mock_turtle.PenDown();
  for (int i=0; i<5; ++i) {
    mock_turtle.Forward(10 * i);
  }
  EXPECT_EQ(mock_turtle.GetX(), 42);
}
```

This test verifies interactions with the mock object including expected call counts, behaviors, and returned values.

---

# References & Further Reading

- [Mocking Reference](https://github.com/google/googletest/tree/main/docs/reference/mocking.md): API and usage details.
- [gMock Cookbook](https://github.com/google/googletest/tree/main/docs/gmock_cook_book.md): Recipes and tips.
- [gMock for Dummies](https://github.com/google/googletest/tree/main/docs/gmock_for_dummies.md): Beginner-friendly introduction.
- [Structuring and Organizing Tests](https://github.com/google/googletest/tree/main/docs/guides/getting-started/test-structure-conventions.md): Organize mocks and tests effectively.

---