---
title: "Setting and Verifying Expectations"
description: "Learn how to control, specify, and verify call sequences and argument values using GoogleMock's expectation syntax. Includes ON_CALL and EXPECT_CALL patterns."
---

# Setting and Verifying Expectations in GoogleMock

GoogleMock uses expectations to specify how mock methods should be called during tests. This guide helps you control, specify, and verify mock call sequences and argument values using GoogleMock's expectation syntax. It details how to use `EXPECT_CALL` and `ON_CALL` patterns effectively to set default behaviors and strict expectations.

---

## 1. Overview of Setting Expectations

### What This Guide Helps You Achieve
- Define expectations for mock method calls including argument matching, number of calls, call order, and return values.
- Control default mock behaviors when exact calls are not explicitly expected.
- Verify that mocked functions are called as expected, reporting descriptive errors if they are not.

### Prerequisites
- Basic understanding of GoogleMock and how mock classes and methods are defined.
- Mock classes with `MOCK_METHOD` declarations ready for use.
- Include `<gmock/gmock.h>` and appropriate namespaces.

### Expected Outcomes
- Write clear `EXPECT_CALL` and `ON_CALL` statements that guide and verify mock interactions.
- Handle complex call orderings using sequences and dependencies.
- Avoid common pitfalls related to expectation ordering and call verification.

### Estimated Time
- Initial mastery: 15–30 minutes
- Advanced usage and custom scenarios: varies

### Difficulty Level
Intermediate

---

## 2. Key Concepts and Syntax

### 2.1 Using `EXPECT_CALL` to Set Expectations

The `EXPECT_CALL` macro specifies that a mock method **must** be called with arguments matching the given matchers, with precise control over how many times, order, and behavior.

**Basic Syntax:**
```cpp
EXPECT_CALL(mock_object, Method(arg_matchers...))
    .With(multi_arg_matcher)
    .Times(cardinality)
    .InSequence(sequence_objects...)
    .After(expectations...)
    .WillOnce(action)
    .WillRepeatedly(action)
    .RetiresOnSaturation();
```

- `.With()` restricts based on a matcher for the *whole* argument tuple.
- `.Times()` controls how many times the mock method is expected to be called.
- `.InSequence()` and `.After()` specify call ordering.
- `.WillOnce()` and `.WillRepeatedly()` define actions (e.g., return values).
- `.RetiresOnSaturation()` retires the expectation once saturated.

Clauses must appear in this order; most are optional.

#### Example: Simple Expectation
```cpp
using ::testing::Return;
EXPECT_CALL(turtle, GetX())
    .Times(3)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillOnce(Return(200));
```

This expects `GetX()` to be called thrice, returning 100, 150, and 200 respectively.

### 2.2 Using `ON_CALL` to Set Default Behaviors

While `EXPECT_CALL` sets *required* expectations, `ON_CALL` defines *default* behaviors when no `EXPECT_CALL` matches.

**Basic Syntax:**
```cpp
ON_CALL(mock_object, Method(arg_matchers...))
    .With(multi_arg_matcher)
    .WillByDefault(action);
```

- `.With()` is optional, restricting the default behavior by argument tuples.
- `.WillByDefault()` is *mandatory* to specify the default action.

#### Example: Setting a Default Action
```cpp
using ::testing::Return;
ON_CALL(turtle, GoTo(_, _))
    .WillByDefault(Return(true));
```

The mock `GoTo` returns `true` by default regardless of arguments.

---

## 3. Step-by-Step: Writing and Verifying Expectations

<Steps>
<Step title="Create the Mock Object">
Create an instance of your mock class.
```cpp
MockTurtle turtle;
```
</Step>
<Step title="Specify Default Behavior with `ON_CALL` (Optional)">
Set up general default behavior for methods that you don't want strict expectations on.
```cpp
ON_CALL(turtle, GetX()).WillByDefault(Return(0));
```
This avoids unwanted warnings for uninteresting calls.
</Step>
<Step title="Set Explicit Expectations with `EXPECT_CALL`">
Define specific expectations clearly:
- The method and its argument matchers.
- Optional clauses as needed to control calls.

Example:
```cpp
EXPECT_CALL(turtle, Forward(100)).Times(1).WillOnce(Return());
```

This expects exactly one call to `Forward(100)`.
</Step>
<Step title="Control Call Ordering with Sequences or `.After()`">
For ordered calls, use the `InSequence` helper or `.InSequence()` clause:

```cpp
{
  InSequence s;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

Alternatively, use `.After()` with named expectations to set partial orders.
</Step>
<Step title="Define Actions with `.WillOnce()` and `.WillRepeatedly()`">
Specify actions to define return values or side effects.
```cpp
EXPECT_CALL(turtle, GetX())
    .WillOnce(Return(5))
    .WillRepeatedly(Return(10));
```
This returns 5 the first time and 10 for subsequent calls.
</Step>
<Step title="Run Your Test and Let GoogleMock Verify">
Exercise your code that uses the mock.
GoogleMock will automatically check that all expectations are fulfilled when mocks are destructed.
If you want, explicitly verify earlier:
```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(&turtle));
```
</Step>
</Steps>

---

## 4. Common Patterns and Examples

### 4.1 Setting Expectations Without Arguments (Non-overloaded Methods)

For methods where you don't care about arguments:
```cpp
EXPECT_CALL(turtle, PenDown).Times(1);
```
This matches any call to `PenDown` with any arguments (only allowed for methods not overloaded).

### 4.2 Partial Ordering with Multiple Sequences

You can specify complex call order DAGs:
```cpp
Sequence s1, s2;
EXPECT_CALL(turtle, Turn(90)).InSequence(s1);
EXPECT_CALL(turtle, Forward(50)).InSequence(s1, s2);
EXPECT_CALL(turtle, PenUp()).InSequence(s2);
```
This requires `Turn(90)` before `Forward(50)`, and `Forward(50)` before `PenUp()`.

### 4.3 Expecting a Call to Never Happen

Use `.Times(0)`:
```cpp
EXPECT_CALL(turtle, PenUp()).Times(0);
```
If `PenUp()` is called, the test fails.

### 4.4 Setting an Expectation for a Move-Only Return Type

Use actions like `Return(std::move(object))` carefully:
```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillOnce(Return(std::make_unique<Buzz>(AccessLevel::kInternal)));
```
Don't repeat `Return(std::move(...))` inside `WillRepeatedly` unless you use a lambda to create a fresh object each time.

### 4.5 Combining Expectations for the Same Method

Define a general catch-all and specialized expectations:
```cpp
EXPECT_CALL(foo, DoIt(_)).Times(AnyNumber());
EXPECT_CALL(foo, DoIt(42)).Times(1);
```
The more recent expectation with matching arguments has precedence.

### 4.6 Verifying Complex Argument Relationships

Use `.With()` to match multiple arguments as a tuple:
```cpp
EXPECT_CALL(foo, Method(_, _))
    .With(Lt())  // First argument less than second
    .Times(1);
```

---

## 5. Troubleshooting & Best Practices

### Common Issues
- **`EXPECT_CALL` not set before calls:** GoogleMock requires expectations to be set **before** exercising code that invokes mocks.
- **Over-saturation:** Calling a mock method more times than expected results in failures or default value returns while logging warnings.
- **Missing default action:** If no `ON_CALL` or action is specified, and the return type has no default value, tests may terminate unexpectedly.
- **Ambiguous overloads:** Always specify arguments or disambiguate when matching overloaded methods.

### Best Practices
- Use `ON_CALL` to set default behavior; use `EXPECT_CALL` only to verify actual call expectations.
- Prefer `.RetiresOnSaturation()` to avoid sticky expectations that cause confusing upper-bound violations in sequences.
- For ordered calls, use `InSequence` or `.After()` clauses to clearly define call orders.
- Avoid mixing calls and expectations; keep setting expectations before code execution.
- Use `_` matcher for arguments you don't care about.
- To suppress warnings about uninteresting calls, consider using `NiceMock`.

### Performance Considerations
- Avoid redundant or conflicting expectations; too many overlapping expectations may slow down matching.
- Use sequences only when strictly necessary to enforce call order.

---

## 6. Next Steps and Related Content

- [Creating and Using Mock Objects](/guides/mocking-techniques/creating-mocks) — for defining mocks.
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — advanced mock usage.
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) — matchers for argument matching.
- [Actions Reference](https://google.github.io/googletest/reference/actions.html) — actions for specifying behavior.
- [Nice, Naggy, and Strict Mocks](/api-reference/mocking-framework/strictness-modes) — controlling warning and failure behavior.

---

## 7. Summary Example

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;
using ::testing::InSequence;

class MockTurtle {
 public:
  MOCK_METHOD(void, PenDown, ());
  MOCK_METHOD(void, PenUp, ());
  MOCK_METHOD(void, Forward, (int distance));
  MOCK_METHOD(int, GetX, (), (const));
};

TEST(TurtleTest, DrawsLineInOrder) {
  MockTurtle turtle;

  // Default behavior
  ON_CALL(turtle, GetX()).WillByDefault(Return(0));

  {
    InSequence seq;  // Enforce call order
    EXPECT_CALL(turtle, PenDown()).Times(1);
    EXPECT_CALL(turtle, Forward(100)).Times(1);
    EXPECT_CALL(turtle, PenUp()).Times(1);
  }

  // Exercise code that uses turtle
  turtle.PenDown();  // must be first
  turtle.Forward(100);
  turtle.PenUp();    // must be last

  EXPECT_EQ(0, turtle.GetX());  // Default action used
}
```

This example demonstrates default actions with `ON_CALL`, enforced call order with `InSequence`, and explicit call expectations.

---
