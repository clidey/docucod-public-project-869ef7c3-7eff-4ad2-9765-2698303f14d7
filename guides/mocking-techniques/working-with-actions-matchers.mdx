---
title: "Responding with Actions and Advanced Matchers"
description: "Learn to implement dynamic behaviors and custom responses using GoogleMock's action and matcher system. This guide covers action macros, composing complex match patterns, and ensuring flexible, maintainable test doubles."
---

# Responding with Actions and Advanced Matchers

Learn to implement dynamic behaviors and custom responses using GoogleMock's action and matcher system. This guide covers action macros, composing complex match patterns, and ensuring flexible, maintainable test doubles.

---

## Workflow Overview

### Task Description
This guide helps you understand how to control the behavior of mock methods in GoogleMock by responding with customizable actions and composing advanced matchers. You'll learn how to specify what mock functions do when called and how to tailor argument matching for complex scenarios.

### Prerequisites
- A C++ project integrated with GoogleTest and GoogleMock.
- Basic knowledge of mock classes, `EXPECT_CALL`, and `ON_CALL` usage.
- Familiarity with defining mock methods using `MOCK_METHOD`.

### Expected Outcome
After following this guide, you will be able to:
- Define actions using macros and built-in helpers.
- Chain and compose complex behaviors in mocks.
- Create advanced, reusable argument matchers.
- Handle common pitfalls with action evaluation and matcher usage.

### Time Estimate
Approximate time to digest and practice: 30-45 minutes.

### Difficulty Level
Intermediate to Advanced

---

## Step-by-Step Instructions

### 1. Define Mock Behaviors Using Actions

GoogleMock actions specify what a mock method does when invoked.

- Use **built-in actions** like `Return(value)`, `ReturnRef(variable)`, or `ReturnPointee(pointer)` to specify return values or references.
- Use **side-effect actions** such as `SetArgPointee<N>(value)`, `Assign(&var, value)`, or `DeleteArg<N>()` to manipulate arguments.
- Use **callable objects**, including functions, lambdas, or functors, to define arbitrary behavior with `Invoke()` or `InvokeWithoutArgs()`.

**Example: Defining a simple return action**
```cpp
using ::testing::Return;
...
EXPECT_CALL(mock_obj, GetValue())
    .WillOnce(Return(42));
```

**Example: Using a lambda to define behavior**
```cpp
EXPECT_CALL(mock_obj, ComputeSum(_, _))
    .WillOnce([](int x, int y) { return x + y; });
```

### 2. Define Parameterized Actions Using ACTION Macros

For reusable or parameterized custom actions, use the `ACTION` family of macros:

- `ACTION(Name)` — for actions without parameters.
- `ACTION_P(Name, param)` — for single-parameter actions.
- `ACTION_Pk(Name, p1, ..., pk)` — for multiple parameters.

Inside an `ACTION`, the `arg0`, `arg1`, ... variables refer to the mock function's arguments.

**Example: Basic action macro**
```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}
EXPECT_CALL(mock, Foo(_))
    .WillOnce(IncrementArg1());
```

**Example: Parameterized action macro**
```cpp
ACTION_P(AddValue, amount) {
  return arg0 + amount;
}
EXPECT_CALL(mock, Increment(_))
    .WillOnce(AddValue(5));
```

### 3. Use Composite Actions to Combine Behaviors

Sometimes an action must do multiple things — for example, modify arguments and return a value. Use `DoAll()` to compose such actions.

- The first N-1 sub-actions must return `void`.
- The last sub-action's return value becomes the action's return.

**Example: Set output parameter and return value**
```cpp
EXPECT_CALL(mock, Process(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

### 4. Select Arguments for Inner Actions

When invoking a function with fewer or reordered arguments than the mock method, use these adaptors:

- `WithArg<N>(action)` — invokes `action` with argument N.
- `WithArgs<N1, N2, ..., Nk>(action)` — invokes `action` with arguments N1, N2, ..., Nk.
- `WithoutArgs(action)` — invokes `action` with no arguments.

**Example: Select fewer args**
```cpp
EXPECT_CALL(mock, Foo(_, _)).WillOnce(WithArg<1>(Invoke(HelperFunction)));
```

### 5. Compose Matchers for Complex Argument Checking

GoogleMock matchers control which mock calls match expectations.

Advanced matchers can be defined and composed:

- Use standard matchers like `Eq()`, `Gt()`, `HasSubstr()`, `Contains()`, `ElementsAre()`, etc.
- Use combinators like `AllOf()`, `AnyOf()`, and `Not()` to combine matchers.
- Create custom matchers with `MATCHER()` and `MATCHER_P()` macros.

**Example: Combined matcher for arguments**
```cpp
EXPECT_CALL(mock, SetValue(AllOf(Gt(0), Lt(10))));
```

### 6. Use `ON_CALL()` to Set Default Actions Without Expectation

- `ON_CALL(mock, method(args)).WillByDefault(action);`
- Does not set an expectation that the method is called
- `EXPECT_CALL` overrides `ON_CALL` behavior when present

**Example: Set default behavior**
```cpp
ON_CALL(mock, GetName())
    .WillByDefault(Return("Default"));
```

### 7. Handle Overloaded Methods and Const Methods

- Use `Const(mock)` wrapper to specify const-qualified overloads
- Specify correct `MOCK_METHOD` signature with `(const, override)` etc.

**Example: Disambiguating const overloads**
```cpp
EXPECT_CALL(Const(mock), GetValue())
    .WillOnce(Return(10));
```

### 8. Implement Delegation Patterns

- You can delegate mock method calls to a real or fake instance by specifying behavior in `ON_CALL()` or `EXPECT_CALL()` using lambdas that call the delegate.

**Example: Delegating to a fake**
```cpp
ON_CALL(*this, Compute(_))
    .WillByDefault([this](int x) { return fake_.Compute(x); });
```

---

## Examples & Code Samples

### Example 1: Setting return values with `WillOnce` and `WillRepeatedly`
```cpp
using ::testing::Return;
MockFoo mock;
EXPECT_CALL(mock, GetCount())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));

// Calls return 1, then 2, then 3 onwards.
int c1 = mock.GetCount();  // 1
int c2 = mock.GetCount();  // 2
int c3 = mock.GetCount();  // 3
int c4 = mock.GetCount();  // 3
```

### Example 2: Custom action macro with parameters
```cpp
ACTION_P(Plus, n) {
  return arg0 + n;
}
EXPECT_CALL(mock, Compute(_))
    .WillOnce(Plus(5));

EXPECT_EQ(mock.Compute(4), 9);
```

### Example 3: Chaining side effects with `DoAll`
```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

### Example 4: Using argument selectors
```cpp
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(WithArg<1>(Invoke(ProcessSecondArg)));
```

### Example 5: Complex argument matching
```cpp
using ::testing::AllOf;
using ::testing::HasSubstr;
EXPECT_CALL(mock, Log(AllOf(HasSubstr("error"), HasSubstr("file"))));
```

### Example 6: Default action with `ON_CALL`
```cpp
ON_CALL(mock, Name())
    .WillByDefault(Return("default name"));
```

---

## Troubleshooting & Tips

- **Beware of side effects evaluated too early:** Actions in `WillOnce()` or `WillRepeatedly()` are evaluated once when the expectation is set, not every time the mock is invoked. Use lambdas or functors to defer computation.

- **Use `RetiresOnSaturation()` to avoid sticky expectations:** Without it, expectations stay active even if saturated, potentially causing failures on extra calls.

- **Avoid mocking non-virtual functions:** Prefer interfaces and mock those. Non-virtual can be mocked only through complex patterns.

- **Suppress warnings on uninteresting calls:** Use `NiceMock<T>` when you want warnings for unexpected calls suppressed.

- **Control verbosity:** Use `--gmock_verbose=info|warning|error` on the test command line to regulate mock output.

- **Use `With()` to match all arguments at once:** Useful when argument conditions involve relationships across arguments.

- **Check that `OnCall` and `ExpectCall` arguments are evaluated once:** Ensure any parameter with side effects is safe to evaluate once.

- **Design mocks with maintainability in mind:** Define custom matchers and actions to keep test code clean and expressive.


---

## Next Steps & Related Content

- Explore [Creating Mock Classes and Setting Expectations](/guides/mocking-techniques/mock-classes-expectations) for foundational mocking.
- Deepen matcher skills in [Matchers Reference](/reference/matchers.md).
- Learn advanced action composition in [Advanced & Custom Actions](/api-reference/mocking-apis/advanced-actions).
- Review [Using Assertions and Matchers](/guides/core-testing-workflows/using-assertions-matchers) for test validations.
- Consider mock strictness levels in [Mock Strictness: Nice, Naggy, and Strict Mocks](/guides/mocking-techniques/strictness-nice-mocks).
- For recipes and samples, see the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html).

---

## Additional Resources

- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [GoogleMock README](https://github.com/google/googletest/tree/main/googlemock)
- [Reference: Actions](../docs/reference/actions.md)
- [Reference: Mocking](../docs/reference/mocking.md)
- [gMock for Dummies](../docs/gmock_for_dummies.md)

---