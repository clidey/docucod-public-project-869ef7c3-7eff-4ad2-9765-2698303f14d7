---
title: "Defining Expectations and Verifying Behavior"
description: "Covers setting precise expectations for function call counts, argument patterns, and return values using matchers and cardinalities. Teaches robust verification for all mock interactions."
---

# Defining Expectations and Verifying Behavior

This guide empowers you to precisely specify how your mock objects should be interacted with in your tests. Using `EXPECT_CALL`, you set detailed expectations for function calls, including how often they occur, what arguments they take, and what they return. Additionally, you will learn how to robustly verify that your mocks were used as expected, catching violations immediately.

---

## Workflow Overview

- **Task Description**: This guide helps you confidently define exact expectations on mock functions, control their call counts and behaviors, and verify that your mocks fulfill these specifications in test executions.
- **Prerequisites**: A mock class with mock methods defined using `MOCK_METHOD`, basic knowledge of GoogleTest and GoogleMock syntax.
- **Expected Outcome**: You will be able to define expectations on mock calls with argument matchers, cardinality constraints, sequences, ordering clauses, and action clauses for return values or side effects. You will also know how verification happens.
- **Time Estimate**: 15-20 minutes to understand and try examples.
- **Difficulty Level**: Intermediate

---

## Step-by-Step Instructions

### 1. Writing Expectations with `EXPECT_CALL`

- Use the `EXPECT_CALL(mock_object, method(matchers...))` macro to specify that a mock method is expected to be called with arguments matching the provided matchers.
- If you omit matchers, `_` (wildcard) is assumed for all arguments, but only for non-overloaded methods.

```cpp
EXPECT_CALL(turtle, GoTo(50, _));  // Expect GoTo with x=50 and any y
EXPECT_CALL(foo, Bar);              // Expect Bar() with any args (non-overloaded)
```

- Chain modifiers to enhance the expectation:

  - `.With(matcher)`: Restrict expectation to calls where the full argument tuple matches `matcher`.
  - `.Times(cardinality)`: Specify how many times the call is expected (see cardinalities below).
  - `.InSequence(sequences...)`: Require calls to occur in order within one or more sequences.
  - `.After(expectations...)`: Require this call to occur after given expectations.
  - `.WillOnce(action)`: Specify the action on the first call (can chain multiple `.WillOnce()` for sequential calls).
  - `.WillRepeatedly(action)`: Specify action on all subsequent calls after `.WillOnce()` clauses.
  - `.RetiresOnSaturation()`: Deactivate expectation after it's saturated to allow other expectations to match.

Example:

```cpp
EXPECT_CALL(turtle, GetX())
    .Times(3)
    .WillOnce(Return(100))
    .WillOnce(Return(150))
    .WillRepeatedly(Return(200));
```

### 2. Understanding Matchers and Argument Patterns

- Matchers specify which arguments a call must have to match an expectation.
- Use `_` to match anything.
- Use built-in matchers like `Eq()`, `Ge()`, `Lt()`, or custom matchers.

```cpp
EXPECT_CALL(foo, DoThis(Ge(5)));  // Argument must be >= 5
EXPECT_CALL(foo, DoThat(_, NotNull()));  // Wildcard first arg, second not NULL
```

- To match the entire argument tuple, use `.With()` with a tuple matcher.

### 3. Controlling Call Counts with Cardinalities

- Cardinalities specify how many times the call is expected.
- Common ones include:
  - `Exactly(n)` or `n`: call exactly n times.
  - `AtLeast(n)`: call at least n times.
  - `AtMost(n)`: call at most n times.
  - `Between(m, n)`: between m and n times inclusive.
  - `AnyNumber()`: called any number of times.
- Omitting `.Times()` infers cardinality based on presence of `.WillOnce()` and `.WillRepeatedly()`.

### 4. Ordering Expectations

- By default, calls can match expectations in any order.
- To require order, use either:
  - **Sequences**: Use `.InSequence()` with `Sequence` objects.
  - **After clause**: `.After(expectation)` to specify partial ordering.

Example using sequence:

```cpp
Sequence s;
EXPECT_CALL(foo, Init()).InSequence(s);
EXPECT_CALL(foo, Run()).InSequence(s);
```

### 5. Specifying Actions for Calls

- Specify what a mock method should do when called:
  - Use `.WillOnce()` for actions on specific calls.
  - Use `.WillRepeatedly()` for all other calls.
- Actions include `Return()`, `Invoke()`, `SetArgPointee()`, lambdas, and more.

### 6. Using RetiresOnSaturation

- `.RetiresOnSaturation()` tells gMock to stop matching an expectation after it has been saturated.
- Useful for having fallback expectations take over after some calls.

Example:

```cpp
EXPECT_CALL(foo, SetNumber(_)).Times(AnyNumber());
EXPECT_CALL(foo, SetNumber(7)).Times(2).RetiresOnSaturation();
// The first two calls with argument 7 will match the last expectation,
// subsequent calls with 7 will fall back to the first.
```

### 7. Verifying Expectations Explicitly

- Mocks automatically verify expectations on destruction.
- You can verify and clear expectations explicitly using:

```cpp
bool success = Mock::VerifyAndClearExpectations(&mock_obj);
```

- Also clears default actions if using `Mock::VerifyAndClear()`.
- Avoid setting new expectations after verification.

### 8. Handling Unexpected and Uninteresting Calls

- Unexpected calls are calls to methods with expectations but with arguments that don't match any expectation.
- Such calls cause immediate errors.
- Uninteresting calls are calls to methods without any expectations. By default, warnings are issued.
- Use `NiceMock` to suppress warnings for uninteresting calls.
- Use `StrictMock` to treat uninteresting calls as errors.

### 9. Tips and Best Practices

- Set expectations *before* code under test exercises mocks to avoid undefined behavior.
- Use `_` wildcard matcher sparingly; over-using may lead to less strict tests.
- Use sequences and `.After()` for tests sensitive to call order.
- Use `.RetiresOnSaturation()` to avoid over-saturation errors elegantly.
- Leverage `.With()` to validate arguments as a tuple when multiple-argument relations are needed.

---

## Examples & Code Samples

### Simple `EXPECT_CALL` with argument matcher and return value

```cpp
using ::testing::Return;
using ::testing::_;

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(PaintTest, CallsPenDownAndGetX) {
  MockTurtle turtle;
  EXPECT_CALL(turtle, PenDown())
      .Times(1);
  EXPECT_CALL(turtle, GetX())
      .WillOnce(Return(10));

  painter.Paint(&turtle);
}
```

### Expecting calls in sequence:

```cpp
using ::testing::InSequence;
using ::testing::Return;

{
  InSequence seq;
  EXPECT_CALL(turtle, PenDown());
  EXPECT_CALL(turtle, Forward(100));
  EXPECT_CALL(turtle, PenUp());
}
```

### Using cardinalities and multiple actions:

```cpp
EXPECT_CALL(foo, GetCount())
    .Times(5)
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

### Using `After` to express partial order:

```cpp
Expectation e1 = EXPECT_CALL(foo, Init());
ExpectationSet es;
es += EXPECT_CALL(bar, Setup());
EXPECT_CALL(foo, Run()).After(e1, es);
```

### Verifying expectations explicitly:

```cpp
MockFoo mock;
EXPECT_CALL(mock, Method()).Times(2);

// Code exercising mock...

ASSERT_TRUE(Mock::VerifyAndClearExpectations(&mock));
```

---

## Troubleshooting & Tips

### Common Issues

- **Failure to meet call count:** Check your `.Times()` and `.WillOnce()` counts.
- **Unexpected calls:** Ensure all call variations are covered by `EXPECT_CALL`.
- **Over-saturated calls:** Use `.RetiresOnSaturation()` or adjust `.Times()`.
- **Too many or too few action clauses:** Follow rules about `.WillOnce()` and `.WillRepeatedly()`.
- **Warnings on uninteresting calls:** Use `NiceMock` or add catch-all expectations.

### Best Practices

- Use `ON_CALL` for setting default behaviors, reserving `EXPECT_CALL` for enforcing call expectations.
- Prefer `NiceMock` for less noisy tests; reserve `StrictMock` for enforcing strict call checks.
- Name expectations with `.Description()` for clearer error messages.
- Organize expectations and order constraints explicitly to avoid test brittleness.

### Performance & Optimization

- Move mock class constructor and destructor definitions into `.cc` files to speed up compilation.
- Avoid excessive complex matchers and actions to decrease compile and runtime overhead.

### Alternative Approaches

- Use `MockFunction<>` for mocking `std::function` or callbacks.
- Delegate calls to fakes or real objects to simplify mock behavior when needed.

---

## Next Steps & Related Content

- Proceed to [Introduction to Mocking](../guides/mocking-techniques/introduction-to-mocking) to learn how to create mock classes.
- Explore [Matching Arguments](../reference/mocking.md#MatcherList) for advanced matcher usage.
- Read about [Actions and Return Value Control](../reference/mocking-matching-actions/actions-and-more) to customize behavior.
- See [Mocking Patterns & Best Practices](../guides/mocking-techniques/mocking-patterns-and-best-practices) for practical usage tips.
- Validate your understanding with the [Validating the Test Environment](../../getting-started/first-steps-validation/quick-validation) guide.

---

## References

- [Google Mock - gMock for Dummies](../docs/gmock_for_dummies.md)
- [Mocking Reference](../docs/reference/mocking.md)
- [gMock Cookbook](../docs/gmock_cook_book.md)
- [Matchers Reference](../reference/matchers.md)
- [Actions Reference](../reference/actions.md)
- [Cardinalities List](../docs/gmock_cheat_sheet.md#CardinalityList)
- [Understanding Uninteresting vs Unexpected Calls](../docs/reference/mocking.md#uninteresting-vs-unexpected)

<Check>
Remember that `EXPECT_CALL()` sets expectations that must be met during test execution, while `ON_CALL()` only sets default behaviors without expectations.
</Check>
