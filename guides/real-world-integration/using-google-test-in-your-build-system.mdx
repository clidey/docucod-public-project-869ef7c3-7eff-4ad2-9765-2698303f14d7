---
title: "Using GoogleTest and GoogleMock in Your Build System"
description: "Covers practical integration steps with popular build tools (CMake, Bazel), source layout recommendations, and linking against the right test and mock libraries. Readers learn how to structure tests for maintainability and CI."
---

# Using GoogleTest and GoogleMock in Your Build System

## Overview

This guide will walk you through the practical steps to integrate GoogleTest and GoogleMock into your build environment. We cover popular build tools such as CMake and Bazel, offer recommendations for organizing your source tree for tests, and detail how to link against the appropriate test and mock libraries. Following this guide will help you create a maintainable test architecture that scales well, especially as you incorporate continuous integration (CI) pipelines.

---

## Prerequisites

- You should have a basic working knowledge of C++ development and your build system.
- Your environment must support C++17 or later (GoogleTest requires this standard).
- For CMake integration, install **CMake 3.14** or later.
- Familiarity with basic test writing using GoogleTest/GoogleMock is assumed.

---

## Expected Outcome

By completing these steps, you will have GoogleTest and GoogleMock correctly integrated into your build system. Your codebase will be structured to support test files cleanly alongside source code, and you will be able to build and link your tests with the right dependencies. Additionally, your tests will be ready to run seamlessly within your CI infrastructure.

---

## Time Estimate

Approximately 30–60 minutes depending on your experience with your build system and project setup.

---

## Difficulty Level

Intermediate – Requires understanding of CMake or Bazel build configurations, and basic familiarity with testing practices.

---

# Integration with CMake

GoogleTest includes built-in CMake support, and GoogleMock is bundled with GoogleTest starting from recent versions. This makes integration straightforward.

### 1. Using GoogleTest and GoogleMock as an External Project or Subdirectory

You have two main choices:

- **Download and build GoogleTest/GMock as an external project or submodule.**
- **Find an already installed library on your system.**

### 2. Standalone Build Example

Clone GoogleTest repository:

```bash
  git clone https://github.com/google/googletest.git -b v1.17.0
  cd googletest
  mkdir build
  cd build
  cmake ..
  make
  sudo make install
```

**Note:** By default, this builds both GoogleTest and GoogleMock. To build only GoogleTest without GoogleMock, pass `-DBUILD_GMOCK=OFF` to the `cmake` command.

### 3. Incorporating GoogleTest/GMock into Your Own CMake Project

There are two common strategies:

#### a) Using an Installed GoogleTest

If you have installed GoogleTest/GMock, you can reference it using `find_package`:

```cmake
find_package(GTest CONFIG REQUIRED)

add_executable(your_test test_main.cpp ...)
target_link_libraries(your_test PRIVATE GTest::gtest GTest::gmock GTest::gtest_main)
add_test(NAME your_test COMMAND your_test)
```

This links your test executable against GoogleTest and GoogleMock libraries and registers the test with CTest.

#### b) Using GoogleTest Source as Part of Your Build

This approach compiles GoogleTest/GMock directly as part of your project, which ensures consistent compiler and linker settings.

Add to your `CMakeLists.txt`:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/main.zip
)

# For Windows: Prevent overriding parent project's compiler/linker settings
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(googletest)

# Now link your tests
add_executable(your_test test_main.cpp ...)
target_link_libraries(your_test PRIVATE gtest gmock gtest_main)
add_test(NAME your_test COMMAND your_test)
```

### 4. Organizing Your Source Tree

- Place your tests in a dedicated test directory (e.g., `tests/` or `foo/test/`).
- Keep mock classes close to the tests that use them or in a shared mock directory.
- For large projects, consider subdirectories per component.

### 5. Linking Best Practices

- Link test executables against `gtest_main` to use the provided `main()` implementation.
- Link against `gmock` if you use mocking features.
- For pure GoogleTest usage without mocks, link only against `gtest` and `gtest_main`.

### 6. Handling Visual Studio Runtime Conflicts

- By default, GoogleTest links the runtime statically while Visual Studio projects often link it dynamically.
- To resolve potential LNK2038 errors, toggle the `gtest_force_shared_crt` CMake option:
  ```cmake
  set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
  ```

---

# Integration with Bazel

GoogleTest and GoogleMock are both supported with Bazel. Typically, GoogleTest is pulled as a dependency via Bazel's external dependencies.

### 1. Declaring Dependencies in BUILD files

You can add rules in your `BUILD` files for test targets:

```python
cc_test(
    name = "foo_test",
    srcs = ["foo_test.cc"],
    deps = [
        "@com_google_googletest//:gmock",
        "@com_google_googletest//:gtest_main",
        "//your_project/foo"
    ],
)
```

### 2. Source Layout Recommendations

- Place tests under a `tests/` folder or next to the source files with `_test.cc` suffix.
- Organize mocks either within the test package or in a shared `mocks/` directory.

### 3. Linking and Using in Bazel

- Use `@com_google_googletest//:gmock` to include GoogleMock.
- Use `@com_google_googletest//:gtest_main` for the default `main` function.

### 4. Continuous Integration

GoogleTest and GoogleMock integrate smoothly with Bazel’s build and test execution, enabling tests to be run during CI with minimal setup.

---

# Structuring Your Tests for Maintainability and CI

Proper source layout and build setup massively reduce test maintenance and improve scalability.

### 1. Source Layout Tips

- Keep test code separate from production code, ideally in dedicated directories.
- Group tests by component or feature to localize changes.
- Keep mocks close to the tests that need them to minimize coupling.

### 2. Build System Configuration

- Automate test discovery and execution by configuring `add_test` (CMake) or `cc_test` (Bazel).
- Use test labels and filters within CI to selectively run tests.
- Keep test dependencies minimal to speed up builds.

### 3. Linking Recommendations

- Link all tests against `gtest_main` or provide a common entry point.
- Ensure you link against `gmock` only where mocks are used, avoiding unnecessary dependencies elsewhere.

### 4. CI Integration Tips

- Set up your CI pipeline to run tests using the build tool’s native test runner.
- Capture and report test results to enable quick feedback.
- Use environment variables or flags to control verbosity and logging.

---

# Summary

Integrating GoogleTest and GoogleMock into your build system is straightforward with the support for CMake and Bazel. Proper source layout, linking against appropriate libraries, and following best practices reduce friction as your project grows. Incorporating tests into CI pipelines completes the workflow, enabling automated quality assurance.

---

# Additional Resources

- [GoogleTest CMake Integration](https://google.github.io/googletest/quickstart-cmake.html)
- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [GoogleTest GitHub Repo](https://github.com/google/googletest)

For CI integration, consult your CI documentation to run CMake tests with `ctest` or Bazel `bazel test` commands.

---

# Troubleshooting Common Build Issues

- **Linker errors involving GoogleTest or GoogleMock:**
  - Verify correct linking against `gtest`, `gmock`, and `gtest_main`.
  - Check for mismatched runtime library settings (static vs dynamic).

- **Compiler errors related to C++ standard:**
  - Ensure your compiler supports C++17.
  - Explicitly set the C++ standard in CMake with `set(CMAKE_CXX_STANDARD 17)`.

- **Uninteresting mock function call warnings:**
  - Use `NiceMock<T>` to suppress warnings or add `EXPECT_CALL(...).Times(AnyNumber())`.

- **Runtime failures in tests linked against GoogleMock:**
  - Make sure to call `testing::InitGoogleMock()` before running tests.

- **Bazel build failures:**
  - Confirm correct dependency on `@com_google_googletest` in your BUILD files.

---

# Example: Basic CMakeLists.txt for Tests Using GoogleTest/GoogleMock

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProjectTests LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/v1.17.0.zip
)
FetchContent_MakeAvailable(googletest)

enable_testing()

add_executable(my_test
  my_test.cc
  my_mock_classes.cc
)

target_link_libraries(my_test PRIVATE gtest gmock gtest_main)

add_test(NAME my_test COMMAND my_test)
```

---

# Example: Linking GoogleMock in Bazel BUILD File

```python
cc_test(
    name = "my_component_test",
    srcs = ["my_component_test.cc"],
    deps = [
        "@com_google_googletest//:gmock",
        "@com_google_googletest//:gtest_main",
        "//my_project/my_component",
    ],
)
```

---

# Troubleshooting Tips Summary

- Always **set expectations before exercising mocks**.
- Ensure **unique linking of `gmock` and `gtest_main`** per test executable.
- Avoid C++ standard mismatches between project and GoogleTest.
- Use **`gtest_force_shared_crt`** flag for Visual Studio C runtime compatibility.
- Structure source and tests for clarity and maintainability.

---

This guide equips you with practical steps and best practices to set up, organize, and link GoogleTest and GoogleMock in your build systems, ensuring reliable, maintainable testing and smooth CI integration.