---
title: "Creating Custom Actions and Matchers"
description: "Empowers users to extend GoogleMock for complex C++ scenarios by defining their own actions and matchers. Step-by-step instructions and real use-cases demonstrate how to improve test expressiveness for specialized domains."
---

# Creating Custom Actions and Matchers

Extend GoogleMock effortlessly by writing your own actions and matchers for complex, specialized C++ testing scenarios. This guide empowers you to improve the expressiveness and precision of your tests beyond built-in capabilities by defining reusable, domain-specific behaviors and argument validations.

---

## Workflow Overview

### What You Will Achieve
This guide shows you how to create custom GoogleMock **actions** (behaviors for mock methods) and **matchers** (criteria to validate method arguments) tailored to your application’s domain. These extensions enable more readable tests and greater control over interaction specifications.

### Prerequisites
- Familiarity with basic GoogleMock usage, including mocking classes and setting expectations with `EXPECT_CALL`.
- Understanding of C++ lambdas, templates, and operator overloading is beneficial but not mandatory.

### Expected Outcome
By following this guide, you will be able to:
- Define simple and parameterized custom matchers with clear failure messages.
- Implement monomorphic and polymorphic matchers for reusable argument validation.
- Write custom actions to specify complex mock method behaviors, including side effects.
- Compose existing actions into more complex sequences.

### Time Commitment
Approximate time: 30-45 minutes for initial mastery, more for advanced customization and extended use.

### Difficulty Level
Intermediate — requires some grasp of C++ and GoogleMock basics.

---

## Step-by-Step Instructions

### 1. Writing New Matchers

Matchers describe argument validation rules used in `EXPECT_CALL()`.

#### a. Using MATCHER Macros for Quick Matchers
Use `MATCHER` or `MATCHER_P` macros to define new matchers quickly:

```cpp
// Simple matcher that checks if a number is divisible by 7
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}

// Parameterized matcher checking absolute value
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}
```

Use them in tests:

```cpp
EXPECT_CALL(mock_obj, Func(IsDivisibleBy7()));
EXPECT_THAT(some_value, HasAbsoluteValue(5));
```

**What to expect:** Clear, human-readable failure messages, optionally enhanced by streaming diagnostic info inside matcher bodies.

#### b. Defining Custom Matcher Classes for Advanced Control
If you want more explicit control or to provide rich messages:

```cpp
class BarPlusBazEqMatcher {
 public:
  using is_gtest_matcher = void;

  explicit BarPlusBazEqMatcher(int expected_sum) : expected_sum_(expected_sum) {}

  bool MatchAndExplain(const Foo& foo, std::ostream* os) const {
    bool match = foo.bar() + foo.baz() == expected_sum_;
    if (!match && os) {
      *os << "bar() + baz() was " << (foo.bar() + foo.baz());
    }
    return match;
  }

  void DescribeTo(std::ostream* os) const { *os << "bar() + baz() equals " << expected_sum_; }
  void DescribeNegationTo(std::ostream* os) const { *os << "bar() + baz() does not equal " << expected_sum_; }

 private:
  const int expected_sum_;
};

::testing::Matcher<const Foo&> BarPlusBazEq(int expected_sum) {
  return BarPlusBazEqMatcher(expected_sum);
}
```

#### c. Polymorphic Matchers
Allow matchers flexible across types by making `MatchAndExplain` a template:

```cpp
class NotNullMatcher {
 public:
  using is_gtest_matcher = void;

  template <typename T>
  bool MatchAndExplain(T* p, std::ostream*) const { return p != nullptr; }

  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

inline PolymorphicMatcher<NotNullMatcher> NotNull() {
  return ::testing::MakePolymorphicMatcher(NotNullMatcher());
}
```

Use in your tests simply as `EXPECT_CALL(mock, Foo(NotNull()));`

---

### 2. Creating Custom Actions

Actions dictate what mocked methods actually do when called.

#### a. Simple Action Using Lambda or Functor
Use lambdas for straightforward custom behavior:

```cpp
EXPECT_CALL(mock, DoSomething(_))
    .WillOnce([](int arg) { return arg * 2; });
```

Or define a struct:

```cpp
struct MultiplyBy {
  int factor;
  template <typename T>
  T operator()(T arg) { return arg * factor; }
};
EXPECT_CALL(mock, Calculate(_)).WillOnce(MultiplyBy{7});
```

#### b. Defining Actions Using ACTION Macro
Write named actions with C++ code inside `ACTION`:

```cpp
ACTION(IncrementArg0) { (*arg0)++; return *arg0; }
EXPECT_CALL(mock, Func(_)).WillOnce(IncrementArg0());
```

Parameterized actions:

```cpp
ACTION_P(Add, n) { return arg0 + n; }
EXPECT_CALL(mock, Func(_)).WillOnce(Add(5));
```

#### c. Composite and Sequenced Actions
Compose multiple actions with `DoAll`:

```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

Invoke callables passed as mock arguments with `InvokeArgument`:

```cpp
EXPECT_CALL(mock, CallWithCallback(_))
    .WillOnce(InvokeArgument<0>(42));
```

---

### 3. Best Practices and Tips

- **Keep matchers pure:** Avoid side effects in your matcher code.
- **Use descriptive failure messages:** Override DescribeTo and output useful diagnostic info.
- **Reuse complex matchers and actions:** Assign to variables for clarity and maintainability.
- **Use `ReturnPointee()` to return live variable values:** Returns pointer values evaluated at call time.
- **When mocking non-virtual methods:** Use template-based dependency injection as described in the cookbook.
- **Chain and combine matchers as needed:** For example, `AllOf()`, `Not()`, `AnyOf()` for complex logic.
- **Use sequences and `After` for ordering expectations:** Specify exact or partial call order.

---

## Examples & Code Samples

### Custom Matcher Example

```cpp
MATCHER(IsEven, "Checks if a number is even") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock, Foo(IsEven()));
```

### Parameterized Matcher Example

```cpp
MATCHER_P(InRange, range, "Checks if value is in range") {
  return arg >= range.first && arg <= range.second;
}

EXPECT_CALL(mock, Bar(InRange(std::make_pair(1, 10))));
```

### Custom Action Example

```cpp
ACTION_P(SetToValue, value) {
  *arg0 = value;
}

EXPECT_CALL(mock, SetValue(_)).WillOnce(SetToValue(42));
```

### Using Invoke with a Member Function

```cpp
class Helper {
 public:
  int Compute(int x) { return x * 10; }
};

Helper helper;
EXPECT_CALL(mock, Compute(_)).WillOnce(Invoke(&helper, &Helper::Compute));
```

---

## Troubleshooting & Tips

### Common Issues

- **Matcher doesn’t compile or fails silently:** Ensure the matcher returns a `bool` and is pure without side effects.
- **Unintended overload ambiguity:** Use explicit typed matchers like `TypedEq<T>()` or specify argument types.
- **Return value issues in actions:** Use `ReturnRef()` for references and `ReturnPointee()` for live values.
- **Too many or too few actions:** Match the number of `WillOnce()` calls to expected invocations or use `WillRepeatedly()`.
- **Mock methods not called as expected:** Use `--gmock_verbose=info` to trace mock calls and matched expectations.

### Best Practices

- Define custom matchers when you want meaningful test failure messages related to domain logic.
- Use parameterized actions and matchers to increase reusability and reduce test duplication.
- Separate default behaviors (`ON_CALL`) from expectations (`EXPECT_CALL`) to avoid brittleness.

---

## Next Steps & Related Content

- Explore [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for practical recipes on mocking scenarios.
- Read [Matchers Reference](../api-reference/core-testing-apis/matcher-apis) to learn built-in matchers you can combine with your custom ones.
- Study [Actions Reference](../api-reference/core-testing-apis/actions-reference) for built-in actions and composing actions.
- Visit [Advanced Mocking Patterns and Best Practices](../guides/core-workflows/advanced-mocking-patterns) to learn about sequences and ordering.
- Review [Mocking Reference](../api-reference/core-testing-apis/mocking-apis-and-macros) for details on expectations and mock class definitions.

---

For further guidance, consult the official GoogleMock documentation and utilize `--gmock_verbose=info` when running tests to diagnose and verify usage of your custom actions and matchers.

---