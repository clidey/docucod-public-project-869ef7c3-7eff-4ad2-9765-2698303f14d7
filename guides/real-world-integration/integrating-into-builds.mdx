---
title: "Integrating with Build Systems"
description: "Practical examples and advice for integrating GoogleTest/GoogleMock into CMake, Bazel, and other common build systems. Includes handling dependencies and organizing project structure for seamless testing."
---

# Integrating with Build Systems

This guide offers practical, step-by-step instructions to integrate GoogleTest and GoogleMock into your C++ projects using common build systems like CMake and Bazel. It covers setup, dependency management, linking strategies, and organizing your project structure to enable seamless testing workflows.

---

## Workflow Overview

### Task Description
Help users embed GoogleTest/GoogleMock frameworks into their existing C++ build environments, specifically focusing on CMake and Bazel workflows. This ensures tests compile, link, and run correctly alongside application code.

### Prerequisites
- Basic familiarity with your chosen build system (CMake or Bazel).
- GoogleTest/GoogleMock source code or installed binaries.
- A C++17 compatible compiler environment.

### Expected Outcome
By following this guide, you will have GoogleTest/GoogleMock incorporated into your build system setup, enabling you to write, build, and run unit tests effectively within your project.

### Time Estimate
15-30 minutes depending on build system familiarity.

### Difficulty Level
Intermediate – requires understanding of build systems and C++ project structure.

---

## Step-by-Step Instructions

### 1. Integrating GoogleTest/GoogleMock with CMake

GoogleTest provides official CMake support designed for easy integration either as a standalone project or embedded within your project.

#### Step 1: Obtain GoogleTest Source
Clone or download GoogleTest from GitHub at the desired stable version:

```bash
git clone https://github.com/google/googletest.git -b v1.17.0
```

#### Step 2: Include GoogleTest in Your Project
The recommended approach is to add GoogleTest as a subdirectory in your CMake project to ensure consistency in compilation settings.

In your root `CMakeLists.txt`, add:

```cmake
add_subdirectory(path/to/googletest)
```

Replace `path/to/googletest` with the relative path where you cloned the repo.

#### Step 3: Link Test Targets Against GoogleTest
Create executable targets for your tests and link against `gtest_main` or `gmock_main` for automatic test main functions.

Example:

```cmake
add_executable(my_tests test_file.cpp)
target_link_libraries(my_tests gtest_main)  # For pure GoogleTest
# or
# target_link_libraries(my_tests gmock_main)  # If using GoogleMock

add_test(NAME my_tests COMMAND my_tests)
```

#### Step 4: Configure Compiler Settings
Ensure your C++ standard is set (GoogleTest requires C++17):

```cmake
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
```

For Visual Studio users who encounter runtime library mismatches, use the `gtest_force_shared_crt` option:

```cmake
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
```

This aligns your project's runtime linking with GoogleTest’s.

#### Step 5: Build and Run
Generate your build files and compile:

```bash
mkdir build && cd build
cmake ..
make
ctest  # Run tests
```

#### Optional: Installing GoogleTest
If you prefer to install GoogleTest system-wide (e.g. `/usr/local/`), use:

```bash
make install
```

Then, in your project, you can use:

```cmake
find_package(GTest REQUIRED)
target_link_libraries(my_tests GTest::gtest_main)
```

---

### 2. Integrating GoogleTest/GoogleMock with Bazel

Bazel build system support typically involves WORKSPACE and BUILD files configuration.

#### Step 1: Add GoogleTest/GoogleMock as External Repositories
Configure your `WORKSPACE` file to pull GoogleTest sources:

```starlark
http_archive(
    name = "com_google_googletest",
    url = "https://github.com/google/googletest/archive/release-1.11.0.zip",
    strip_prefix = "googletest-release-1.11.0",
)
```

Adjust the version and URL appropriately.

#### Step 2: Define Your Test Targets
Create `BUILD` files with tests using the `cc_test` rule. Link to the googletest target:

```starlark
cc_test(
    name = "my_test",
    srcs = ["my_test.cpp"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

For GoogleMock add:

```starlark
deps = ["@com_google_googletest//:gmock_main"]
```

#### Step 3: Run Tests
Use Bazel’s run command to execute your tests.

```bash
bazel test //path/to:my_test
```

---

### 3. Organizing Project Structure

- Place your tests in a dedicated directory, e.g., `tests/` or alongside source files.
- Ensure your build targets for tests depend on GoogleTest/GoogleMock appropriately.
- Maintain separation of test and production binaries.

---

## Practical Tips & Best Practices

- **Always link against `gtest_main` or `gmock_main`** when you want GoogleTest to provide the `main()` function for your test executable. Avoid redefining `main()` yourself unless you have specific reasons.

- **Use the same compiler and runtime settings** for your tests as your main application to prevent compatibility issues.

- For serious multi-threaded applications, confirm `GTEST_HAS_PTHREAD` macro status in your build.

- Prefer embedding GoogleTest directly in your project via subdirectory or FetchContent rather than manual copying, to ease updates and avoid version code drift.

- On Windows, ensure consistent runtime linkage (`/MD` vs `/MT`) to prevent runtime conflicts.

- When using Bazel, manage versions carefully and pin them in your `WORKSPACE` file for reproducible builds.

---

## Example CMake Integration

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add GoogleTest as a subdirectory
add_subdirectory(external/googletest)

# Define your test executable
add_executable(my_tests tests/my_tests.cpp)

# Link to GoogleTest main library
target_link_libraries(my_tests gtest_main)

# Register tests
enable_testing()
add_test(NAME my_tests COMMAND my_tests)
```

---

## Troubleshooting & Common Issues

<AccordionGroup title="Troubleshooting Common Integration Issues">
<Accordion title="Linker Errors Related to GoogleTest Symbols">
Make sure that you link your test binaries with `gtest_main` or `gmock_main` if you rely on the default test driver. Without this, linker errors for `main()` or test framework symbols will occur.
</Accordion>
<Accordion title="Runtime Library Mismatch on Windows">
Visual Studio link errors about differing runtime libraries (`MTd` vs `MDd`) mean that your test target and GoogleTest are using different runtime flags. Set `gtest_force_shared_crt` to `ON` in CMake to enforce consistent dynamic linking.
</Accordion>
<Accordion title="Tests Not Running or Being Discovered">
Confirm your test executables are linked correctly against GoogleTest. Also verify you are using the recommended macros like `TEST()` or `TEST_F()` and that tests are properly named.
</Accordion>
<Accordion title="Bazel Build Fails to Find GoogleTest"
>
Check that the external dependency repository in your `WORKSPACE` is properly declared and that your BUILD files link against the correct targets such as `@com_google_googletest//:gtest_main`.
</Accordion>
</AccordionGroup>

---

## Next Steps & Related Guides

- Explore [Writing Your First Tests](https://github.com/google/googletest/blob/main/docs/guides/getting-started/writing-basic-tests.md) for writing and structuring tests after integration.
- Consult [Test Macros and Fixtures](https://github.com/google/googletest/blob/main/docs/api-reference/core-testing-api/test-macros-and-fixtures.md) for advanced test organization.
- Review [Integration with Build Systems](https://github.com/google/googletest/blob/main/docs/overview/use-cases-integration/integration-with-build-systems.md) for additional advanced patterns.
- Consider reading the [Troubleshooting Common Setup Issues](https://github.com/google/googletest/blob/main/docs/getting-started/troubleshooting/common-setup-issues.md) for detailed error handling.

---

## References & Resources

- GoogleTest GitHub Repository: [https://github.com/google/googletest](https://github.com/google/googletest)
- Official CMakeLists.txt Script: Included in repository root.
- GoogleMock README: For mocking integration details.
- CMake Documentation: https://cmake.org/cmake/help/latest/
- Bazel Documentation: https://bazel.build/

---

This guide powers your journey from project setup to automated testing with GoogleTest and GoogleMock, ensuring your build systems streamline rather than stall your development.
