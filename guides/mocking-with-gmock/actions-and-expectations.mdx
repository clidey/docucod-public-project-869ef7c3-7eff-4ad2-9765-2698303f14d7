---
title: "Actions and Expectations"
description: "Master ON_CALL and EXPECT_CALL to specify mock behavior, control call sequences, and assert invocation frequencies. This guide explores argument matching, action templates, and best practices for readable, robust behavioral tests."
---

# Actions and Expectations

Master ON_CALL and EXPECT_CALL to specify mock behavior, control call sequences, and assert invocation frequencies. This guide explores argument matching, action templates, and best practices for readable, robust behavioral tests.

---

## 1. Understanding ON_CALL and EXPECT_CALL

At the heart of GoogleMock's behavior control are two macros:

- `ON_CALL`: Defines the default behavior of a mock method for argument patterns without asserting that calls must occur.
- `EXPECT_CALL`: Sets an expectation that a mock method will be called with specified arguments, controlling calls count and order.

GoogleMock separates behavior specification (`ON_CALL`) from expectation enforcement (`EXPECT_CALL`) — use `ON_CALL` to establish normal mock behavior and `EXPECT_CALL` to verify contract adherence.

<Tip>
Prefer using `ON_CALL` to set baseline, expected default behavior that won't cause test failures. Reserve `EXPECT_CALL` for when you want to assert that specific calls happen, how often, and in what order.
</Tip>

---

## 2. Setting Up Default Behavior with ON_CALL

### Purpose
`ON_CALL` lets you specify what should happen when a mock method is called with arguments matching certain patterns, without failing tests if these calls don't occur.

### Prerequisites
- A mock class with mocked methods declared via `MOCK_METHOD`.
- Include `<gmock/gmock.h>`.

### Using ON_CALL

```cpp
ON_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)   // optional
    .WillByDefault(action);
```

- `.With(multi_argument_matcher)`: Optional, restricts matching to argument tuples satisfying the multi-argument matcher.
- `.WillByDefault(action)`: Required, sets the action performed when the mock method is called.

### Example

```cpp
using ::testing::_;
using ::testing::Return;
using ::testing::Lt;

ON_CALL(my_mock, SetPosition(_, _))
    .With(Lt())
    .WillByDefault(Return(true));
```

This sets a default to return true when `SetPosition` is called with two arguments where the first is less than the second.

### Key Points
- `ON_CALL` affects the behavior only; if no matching `EXPECT_CALL` exists, calls to this method with matching arguments won't cause failures.
- Last matching `ON_CALL` takes precedence.
- Useful for common/default behaviors shared across tests.

---

## 3. Defining Expectations with EXPECT_CALL

### Purpose
`EXPECT_CALL` sets an expectation that a mock method will be called with matching arguments, specifying how many times, in which order, and with what behavior.

### Prerequisites
- A mock object with mocked methods.
- Include `<gmock/gmock.h>`.

### Basic Syntax

```cpp
EXPECT_CALL(mock_object, Method(matchers...))
    .With(multi_argument_matcher)    // optional, must be first clause
    .Times(cardinality)              // optional, once at most
    .InSequence(sequences...)        // optional, any number
    .After(expectations...)          // optional, any number
    .WillOnce(action)                // optional, any number
    .WillRepeatedly(action)          // optional, at most once
    .RetiresOnSaturation();          // optional, at most once
```

### Explanation of Clauses

- `.With()`: Restricts to calls matching the multi-argument matcher as a tuple. Must appear first if used.

- `.Times()`: Specifies the expected number of calls. Common options:
  - `Exactly(n)` or `n`: exactly `n` times
  - `AtLeast(n)`: at least `n` times
  - `AtMost(n)`: at most `n` times
  - `Between(m, n)`: between `m` and `n` times
  - `AnyNumber()`: any number of times

- `.InSequence()`: Associates the expectation with one or more `Sequence` objects to enforce call order.

- `.After()`: Specifies that this expectation should be matched only after other expectations have been satisfied.

- `.WillOnce()`: Specifies the action to take for each of the first calls that match this expectation. May be chained for multiple actions.

- `.WillRepeatedly()`: Specifies the action to take for all calls after the `WillOnce` actions are exhausted. Can only be used once.

- `.RetiresOnSaturation()`: Automatically deactivates this expectation after it reaches its maximum call count.

### Practical Example

```cpp
using ::testing::Return;
using ::testing::Sequence;

Sequence s1, s2;

EXPECT_CALL(my_mock, Reset())
    .InSequence(s1, s2)
    .Times(1);
EXPECT_CALL(my_mock, GetSize())
    .InSequence(s1)
    .WillRepeatedly(Return(42));
EXPECT_CALL(my_mock, Describe())
    .InSequence(s2)
    .WillRepeatedly(Return("Mock Object"));
```

This specifies a partial order on mock method calls and their behaviors.

---

## 4. Argument Matching

### Single Arguments

Use matchers to specify constraints on each argument individually (e.g., `_` for any value, `Eq(value)` for exact match).

```cpp
EXPECT_CALL(mock, Method(42, _));
```

### Multi-Argument Matching with `.With()`

Use `.With(matcher)` to treat all arguments as a tuple and match them as a whole.

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // First arg less than second
```

GoogleMock provides some built-in tuple matchers like `Lt()`.

<Tip>
Using `.With()` helps express relations among arguments that depend on each other.
</Tip>

---

## 5. Specifying Call Frequencies with `Times`

### Cardinalities

Use `Times()` to specify how many times you expect the method call.

Common examples:

| Cardinality          | Meaning                                  |
|---------------------|------------------------------------------|
| `AnyNumber()`       | Expect any number of calls                |
| `AtLeast(n)`        | At least *n* calls                       |
| `AtMost(n)`         | At most *n* calls                        |
| `Between(m, n)`     | Between *m* and *n* calls (inclusive)    |
| `Exactly(n)` or `n` | Exactly *n* calls                        |

### Inferred Cardinality

If `Times()` is omitted, the cardinality is inferred based on `WillOnce` and `WillRepeatedly`:

- No `WillOnce` nor `WillRepeatedly` → `Times(1)`
- `n` `WillOnce`s and no `WillRepeatedly` → `Times(n)`
- `n` `WillOnce`s with one `WillRepeatedly` → `Times(AtLeast(n))`

### Example

```cpp
EXPECT_CALL(mock, Foo())
    .Times(AtLeast(2));
```

### Special Case: Disallowing Calls

To ensure a method is *never* called:

```cpp
EXPECT_CALL(mock, Foo(_))
    .Times(0);
```

---

## 6. Defining Call Actions

### `WillOnce` and `WillRepeatedly`

- `WillOnce(action)` specifies what the mock should do on each matching call (can be chained).
- `WillRepeatedly(action)` specifies the action performed on all calls after `WillOnce`s are exhausted.

Example:

```cpp
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

Calls will return 1, then 2, then 3 for all subsequent calls.

### Available Actions

Refer to the [Actions Reference](reference/actions.md) for the full list, including:

- Returning values (`Return()`, `ReturnRef()`, etc.)
- Side effects (`SetArgPointee()`, `DeleteArg()`, etc.)
- Callable invocation (`Invoke()`, `InvokeWithoutArgs()`, etc.)

### Composite Actions

You can chain multiple actions using `DoAll()`:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

The last action's return value is used.

### Special Note on Move-Only Types

Mock methods and actions support move-only types (e.g., `std::unique_ptr`). Use lambdas or compatible functors in `WillOnce()` for these cases.

---

## 7. Sequencing Calls

### `InSequence` Object

Use `InSequence` to ensure expectations are met in a strict order:

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(mock, Foo(1));
  EXPECT_CALL(mock, Bar(2));
}
```

Calls must happen in the order declared.

### `InSequence` Clause

Assign expectations to sequences explicitly:

```cpp
Sequence seq1, seq2;
EXPECT_CALL(mock, A()).InSequence(seq1);
EXPECT_CALL(mock, B()).InSequence(seq1, seq2);
```

This enables DAG ordering of calls.

### `After` Clause

Specify partial ordering by indicating dependencies:

```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Execute()).After(e1);
```

The `Execute()` call is expected only after `Init()` is called.

---

## 8. Controlling Expectation Lifetime with `RetiresOnSaturation`

By default, an expectation remains active after reaching its call limit, causing "too many calls" errors. To deactivate an expectation when saturated:

```cpp
EXPECT_CALL(mock, Foo())
    .Times(2)
    .RetiresOnSaturation();
```

Once called twice, this expectation will retire and not match further calls.

---

## 9. Best Practices and Tips

- **Order your expectations carefully**: Newer, more specific `EXPECT_CALL`s override older ones.
- **Use `ON_CALL` for default behaviors** shared across tests to reduce verbosity.
- **Use `EXPECT_CALL` only when you want to assert behavior or call counts**.
- **For complex call order requirements, use `Sequence`, `InSequence`, and `After` to precisely control call ordering**.
- **Avoid over-specification to keep tests maintainable and robust**.
- **Use `NiceMock` or `StrictMock` to modify uninteresting call behavior** (suppress warnings or cause failures).
- **If you want to ignore calls to a method entirely, a catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` helps suppress uninteresting call warnings.**
- **Avoid mixing expectations and mock calls within the same test setup phase to prevent undefined behavior.**

<Tip>
Always specify expectations before exercising code that calls the mock; gMock requires pre-setting expectations to work correctly.
</Tip>

---

## 10. Troubleshooting Common Pitfalls

<AccordionGroup title="Common Issues and Solutions">
<Accordion title="Called Fewer or More Times Than Expected">
Sometimes a mock method is called fewer or more times than specified in `Times()`.
- Verify the right arguments and matchers are used.
- Run your tests with `--gmock_verbose=info` to trace mock calls and matched expectations.
- Use sequences or `After` to enforce call order if order matters.
</Accordion>
<Accordion title="Unexpected Call Fails">
If a call matches no expectations:
- Make sure `EXPECT_CALL`s cover all expected argument combinations.
- Add a catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` to accept unspecified calls if needed.
- Check for logical errors in calling code or expectations.
</Accordion>
<Accordion title="Uninteresting Call Warnings">
You see warnings when calling mocked methods without expectations:
- Use `ON_CALL` to set default behaviors for these methods.
- Use `NiceMock<T>` to suppress warnings for all uninteresting calls.
- Or explicitly allow uninteresting calls via `EXPECT_CALL(...).Times(AnyNumber())`.
</Accordion>
<Accordion title="Mismatched Argument Values">
When expectations fail due to argument mismatches:
- Use matchers like `_`, `AnyOf`, or custom matchers to relax matching.
- Use `With()` to match argument tuples when relationships matter.
- Use `SaveArg` to capture arguments for separate assertions.
</Accordion>
<Accordion title="Action Misuse">
If actions are producing compile or runtime errors:
- Ensure actions passed to `WillOnce` or `WillRepeatedly` match the mock method signature.
- Prefer lambdas or callables when dealing with move-only types.
- Use `DoAll` for multiple side-effects.
</Accordion>
</AccordionGroup>

---

## 11. Next Steps and Further Reading

- Explore [Mocking Reference](reference/mocking.md) for detailed APIs.
- Learn more about [Actions](reference/actions.md) to customize behaviors.
- Use [Matchers](reference/matchers.md) to fine-tune argument validation.
- Consult [gMock Cookbook](gmock_cook_book.md) for practical recipes and patterns.
- Use [gMock for Dummies](gmock_for_dummies.md) for beginner-friendly introduction.

---

## 12. Summary

This guide helped you master how to specify mock method behaviors and expectations using `ON_CALL` and `EXPECT_CALL`. You learned to control invocation patterns, argument matching, ordering, and call counts, along with best practices and troubleshooting.

---

## Appendix: Basic Sample Code

```cpp
#include <gmock/gmock.h>
using ::testing::Return;
using ::testing::_;

class MockFoo {
 public:
  MOCK_METHOD(int, GetValue, (), ());
  MOCK_METHOD(void, SetValue, (int), ());
};

TEST(MockTest, Example) {
  MockFoo mock;

  // Default behavior for GetValue: return 42
  ON_CALL(mock, GetValue())
      .WillByDefault(Return(42));

  // Expect SetValue to be called once with any int
  EXPECT_CALL(mock, SetValue(_)).Times(1);

  mock.SetValue(10);           // Expected call
  int val = mock.GetValue();  // Returns 42 (default)
  EXPECT_EQ(val, 42);
}
```

---