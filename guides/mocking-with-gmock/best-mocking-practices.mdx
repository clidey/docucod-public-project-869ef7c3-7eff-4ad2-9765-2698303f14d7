---
title: "Best Practices for Mocking"
description: "Consolidated advice and real-world strategies for effective use of mocks: minimizing brittleness, managing strictness levels, and documenting intentions. Includes tips for readable failure messages and integrating mock objects into complex test suites."
---

# Best Practices for Mocking

## Overview

This guide consolidates practical advice and real-world strategies for using mocks effectively in your tests with GoogleMock. It helps you minimize brittle tests, manage strictness levels of mock behavior, document mock intentions clearly, and integrate mock objects seamlessly into complex test suites. Following these best practices ensures maintainable, readable, and robust interaction-based testing.

---

## 1. Designing Reliable Mocks

### Balance Between Flexibility and Precision

- **Use ON_CALL for Default Behavior:** Define *default* behavior with `ON_CALL()` when you don't need to assert the call happens but want consistent responses.
- **Reserve EXPECT_CALL for Verification:** Use `EXPECT_CALL()` only when you need to verify that a method is *actually* called with specific arguments, cardinality, or order.

<Tip>
Avoid overusing `EXPECT_CALL` for every call; over-specification leads to brittle tests that break with impl changes.
</Tip>

### Avoid Overly Strict Expectations

- **Specify only what is necessary:** Match only relevant function arguments; use wildcards `_` for those irrelevant.
- **Avoid fixed call counts unless necessary:** Instead of expecting exact call counts, use cardinalities like `AtLeast()`, `AtMost()`, or `AnyNumber()` where appropriate.

### Use Sequences and Partial Ordering Wisely

- Use `InSequence` or `Sequence` objects when the *order* of calls matters.
- Use the `After` clause to establish partial ordering between expectations when only call order constraints exist between some calls.

<Note>
Creating unnecessarily strict call orders increases test fragility. Prefer partial ordering to strict sequencing.
</Note>

---

## 2. Managing Mock Strictness Levels

GoogleMock offers three main strictness levels:

| Level       | Behavior on Uninteresting Calls                   | When to Use                                   |
|-------------|--------------------------------------------------|-----------------------------------------------|
| `NiceMock`  | Ignores uninteresting calls (default action run without warnings) | Default choice for stable, maintainable tests |
| `NaggyMock` | Prints warnings on uninteresting calls           | Useful during test development or debugging    |
| `StrictMock`| Fails tests on uninteresting calls                | For critical tests where unexpected calls must be caught explicitly |

### Guidelines:

- Default to `NiceMock` unless you have a specific reason.
- Use `NaggyMock` temporarily when debugging to detect unanticipated interactions.
- Use `StrictMock` only when you want to enforce *all* interactions explicitly.

<Warning>
`NaggyMock` and `StrictMock` only affect *uninteresting* calls, not *unexpected* calls. Unexpected calls always cause failures.
</Warning>

---

## 3. Writing Clear, Readable Expectations

### Use Descriptions for Clarity

- Use `.Description()` in `EXPECT_CALL()` to give human-readable names to expectations to improve failure reports.

```cpp
EXPECT_CALL(mock, DoSomething(arg))
    .Description("Check effective DoSomething call")
    .Times(1);
```

### Prefer Matchers Over Concrete Values When Appropriate

- Matchers like `_` or semantic ones like `Ge()`, `NotNull()` increase test resilience.
- Combine matchers with `.With()` for multi-argument constraints when argument relations matter.

### Keep Expectations Focused

- Donâ€™t mix too many concerns in one expectation.
- Split complex expectations into simpler, composable ones.

<Info>
Readable, well-documented expectations improve test diagnostics and reduce maintenance overhead.
</Info>

---

## 4. Strategies to Minimize Brittle Tests

### Use `RetiresOnSaturation()` When Applicable

- Add `.RetiresOnSaturation()` on expectations expected to be matched a fixed number of times to avoid lingering state and false failures.

```cpp
EXPECT_CALL(mock, Foo(42))
    .Times(3)
    .RetiresOnSaturation();
```

### Avoid Fragile Argument Matching

- Match only what's relevant.
- For complex argument validation that could change, consider custom matchers or predicate matchers like `Truly()`.

### Avoid Overly Specific Order unless Required

- Using strict `InSequence` everywhere causes fragile tests.
- Use partial ordering (`After` or multiple `Sequence`s) when only some orders matter.

### Use `NiceMock` to Suppress Noisy Warnings

- When many mock methods are not under test in a given scenario, wrap mocks with `NiceMock` to avoid noise.

---

## 5. Integrating Mocks in Complex Test Suites

### Organize Mock Expectations

- Group related expectations together logically within test fixtures or helper functions.
- Name sequences and checkpoints for clarity in ordering.

### Use MockFunction for Callback Interfaces

- For testing code that takes `std::function` callbacks, use `MockFunction` to create mockable function objects with `Call()` methods.

### Use Checkpoints and Sequences to Validate Interaction Phases

- Insert checkpoints using mock calls to assert state or events in complex call flows.
- Use `InSequence` blocks or explicit `Sequence` objects for multi-phase interaction verification.

<Tip>
Test interaction phases make it easier to pinpoint where call order expectations break in large tests.
</Tip>

---

## 6. Best Practices for Failure Messages and Diagnostics

### Enable Verbose Output When Debugging

- Use `--gmock_verbose=info` to see detailed expectations and mock call matches.
- Combine with `--gtest_stack_trace_depth` to control stack trace detail.

### Use Descriptions and Custom Matchers for Meaningful Messages

- Assign `.Description()` names to expectations.
- Use custom matchers with detailed `MatchAndExplain()` for clear diagnostics.

### Diagnose Uninteresting vs Unexpected Calls

- Uninteresting calls occur when no expectation is set; may show warnings depending on mock strictness.
- Unexpected calls occur when an expectation exists but no match found; always cause failures.

---

## 7. Practical Tips & Common Pitfalls

<AccordionGroup title="Practical Tips & Common Pitfalls">
<Accordion title="Avoiding Double Evaluation of Expectation Arguments">
`ON_CALL()` and `EXPECT_CALL()` evaluate their arguments exactly once. Avoid side effects in arguments to prevent unexpected behavior.
</Accordion>
<Accordion title="Do Not Set Expectations After Mocks Are Exercised">
Expectations must be set *before* the mock methods are called. Setting expectations after exercising mocks leads to undefined behavior.
</Accordion>
<Accordion title="Mock Destructors via Die() Method">
Mocking destructors directly is unsupported. Instead, add a mock method such as `Die()`, call it from the destructor, and set expectations on it.
</Accordion>
<Accordion title="Return by Reference using ReturnRef()">
For mock methods returning references, use `ReturnRef()` instead of `Return()` to avoid dangling references or copies.
</Accordion>
<Accordion title="Use WillOnce() and WillRepeatedly() Wisely">
Use multiple `WillOnce()` calls for sequential actions and a single `WillRepeatedly()` for default behavior after `WillOnce()` actions are exhausted.
</Accordion>
</AccordionGroup>

---

## 8. Example: Effective Use of Mock Expectations

```cpp
using ::testing::_;  // Wildcard matcher
using ::testing::Return;
using ::testing::Sequence;

class MockCalculator {
 public:
  MOCK_METHOD(int, Add, (int a, int b), (override));
  MOCK_METHOD(int, Subtract, (int a, int b), (override));
};

TEST(CalculatorTest, VerifyAddSequence) {
  MockCalculator mock_calc;
  Sequence s;

  // Default Add returns 0
  ON_CALL(mock_calc, Add(_, _)).WillByDefault(Return(0));

  // Expect Add with specific args twice, in order
  EXPECT_CALL(mock_calc, Add(1, 2))
      .InSequence(s)
      .WillOnce(Return(3))
      .RetiresOnSaturation();

  EXPECT_CALL(mock_calc, Add(2, 3))
      .InSequence(s)
      .WillOnce(Return(5))
      .RetiresOnSaturation();

  // Calls in order
  EXPECT_EQ(3, mock_calc.Add(1, 2));
  EXPECT_EQ(5, mock_calc.Add(2, 3));
  
  // Other calls use default action
  EXPECT_EQ(0, mock_calc.Add(10, 20));
}
```

---

## 9. Troubleshooting Common Mocking Issues

### Unexpected Call Errors

- Check if there are missing `EXPECT_CALL` statements for the called method/arguments.
- Use catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber());` to allow unverified calls.

### Uninteresting Call Warnings

- Occur by default when a mock method is called without an expectation.
- Use `NiceMock` to suppress warnings if unimportant.
- If you want to verify calls, replace `ON_CALL` with `EXPECT_CALL`.

### Actions Running Out

- If `WillOnce()` calls run out without a `WillRepeatedly()`, gMock falls back to default action and warns.
- Add `.RetiresOnSaturation()` where appropriate to avoid this.

### Mock Verification Fails

- Verify that calls meet cardinality and ordering constraints.
- Use `Mock::VerifyAndClearExpectations(&mock)` to manually verify and reset.

---

## 10. Next Steps & Further Reading

- Dive into [Mock Object Basics](https://google.github.io/googletest/guides/mocking-with-gmock/mock-object-basics) for foundational knowledge.
- Explore [Actions and Expectations](https://google.github.io/googletest/guides/mocking-with-gmock/actions-and-expectations) for deeper usage.
- Learn about [Best Practices for Mocking](https://google.github.io/googletest/guides/mocking-with-gmock/best-mocking-practices) for continued mastery.
- Consult the full [GoogleMock Reference](https://google.github.io/googletest/reference/mocking) for complete API details.

---

## References

- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [GoogleMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Best Practices for Mocking Guide](https://google.github.io/googletest/guides/mocking-with-gmock/best-mocking-practices)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking)

---

# Summary

GoogleMock's `Best Practices for Mocking` guide provides essential strategies to create maintainable and effective mock-based tests. It covers designing mocks with appropriate expectations, managing mock strictness levels via `NiceMock`, `NaggyMock`, and `StrictMock`, writing clear and non-brittle expectations, and integrating mocks in complex test scenarios. The guide emphasizes practical tips for readable failure messages, managing call sequences, and troubleshooting common mocking problems.

**Key Sections Covered:**
- Designing Reliable Mocks
- Managing Mock Strictness Levels
- Writing Clear Expectations
- Minimizing Test Brittleness
- Integrating Mocks into Complex Suites
- Failure Diagnostics and Debugging Tips
- Practical Tips and Common Pitfalls
- Troubleshooting
- Example Use Cases
- Next Steps and References

**Important Links:**
- [Mock Object Basics](https://google.github.io/googletest/guides/mocking-with-gmock/mock-object-basics)
- [Actions and Expectations](https://google.github.io/googletest/guides/mocking-with-gmock/actions-and-expectations)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)

For foundational knowledge on mocks and test writing, see the GoogleTest Getting Started guides and the gMock for Dummies tutorial. Consider next reading Best Practices for Mocking to refine your test designs and integration patterns.