---
title: "Integrating GoogleTest with CMake and Build Systems"
description: "Step-by-step walkthrough for adding GoogleTest to CMake-based projects, handling dependencies, targets, and cross-platform considerations. Addresses common pitfalls and best practices for reliable build integration."
---

# Integrating GoogleTest with CMake and Build Systems

This guide provides a clear, actionable walkthrough for integrating GoogleTest into CMake-based projects. It covers dependency setup, target configuration, handling threading and macro definitions, cross-platform concerns, and common pitfalls to ensure a robust and reliable build environment.

---

## 1. What You'll Achieve

By following this guide, you will:

- Seamlessly add GoogleTest to your CMake project using both installed packages and FetchContent.
- Properly configure compile options, link flags, and dependencies.
- Navigate common errors related to `pkg-config` and threading support.
- Prepare your project for cross-platform and cross-compilation builds.
- Learn best practices for maintaining consistent build settings.

## 2. Prerequisites

Before starting, ensure you have:

- A compatible C++ compiler supporting at least C++17.
- CMake version 3.14 or higher.
- GoogleTest sources or an installed GoogleTest package.
- Basic familiarity with CMake and your platform's compiler/linker.

## 3. Adding GoogleTest to a CMake Project

### A. Using FetchContent to Download GoogleTest

This approach downloads and incorporates GoogleTest source during the CMake configuration step, enabling tight integration:

```cmake
cmake_minimum_required(VERSION 3.14)
project(my_project)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/03597a01ee50ed33e9dfd640b249b4be3799d395.zip
)

# For Windows: prevent overriding parent project’s settings
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)

FetchContent_MakeAvailable(googletest)

add_executable(hello_test hello_test.cc)
target_link_libraries(hello_test GTest::gtest_main)

include(GoogleTest)
gtest_discover_tests(hello_test)
```

- The `gtest_force_shared_crt` option ensures runtime linkage consistency on Windows.
- `GTest::gtest_main` provides the main entry point for tests.

### B. Linking with Installed GoogleTest via `find_package`

If GoogleTest is installed on your system (usually under `/usr/local` or a package manager path), you can locate and link it:

```cmake
find_package(GTest REQUIRED)

add_executable(testapp samples/sample3_unittest.cc)
target_link_libraries(testapp PRIVATE GTest::gtest_main)
```

### C. Leveraging `pkg-config` for Build Flags

GoogleTest installs `.pc` files specifying necessary include paths, macros, and linker flags. You can fetch these flags using `pkg-config` and apply them in CMake:

```cmake
find_package(PkgConfig)
pkg_search_module(GTEST REQUIRED gtest_main)

add_executable(testapp samples/sample3_unittest.cc)
target_compile_options(testapp PRIVATE ${GTEST_CFLAGS})
target_link_libraries(testapp PRIVATE ${GTEST_LDFLAGS})
```

**Tip:** Prefer `target_compile_options` with the `${GTEST_CFLAGS}` variable over using `target_include_directories` because `GTEST_CFLAGS` may include macros and threading flags (`-pthread`) required by internal GoogleTest headers.

Similarly, use `${GTEST_LDFLAGS}` rather than `${GTEST_LIBRARIES}` to retain `-L` and threading options during linking.

---

## 4. Handling Common Issues

### A. `pkg-config` Cannot Find GoogleTest

If you encounter errors such as:

```
-- Checking for one of the modules 'gtest_main'
CMake Error at /usr/share/cmake/Modules/FindPkgConfig.cmake:640 (message):
  None of the required 'gtest_main' found
```

This often means `pkg-config` cannot locate the `.pc` files. To fix this:

- Determine where GoogleTest was installed, for example:
  `/usr/local/lib64/pkgconfig`

- Export `PKG_CONFIG_PATH` to include that directory:

```bash
export PKG_CONFIG_PATH=/usr/local/lib64/pkgconfig
```

- Retry the build configuration.

### B. Ensuring Threading Support and Macros

GoogleTest requires pthread support for thread-safe test execution. If pthread detection fails:

- Define `-DGTEST_HAS_PTHREAD=1` in your compiler flags to manually enable pthread support.

- Ensure linker flags include `-pthread`.

When using CMake's built-in support or pkg-config, these flags are usually handled automatically.

### C. Cross-Compilation Considerations

When cross-compiling, GoogleTest’s pkg-config files may not correctly embed the sysroot path. To mitigate:

1. **Build and install GoogleTest into a sysroot, e.g.:**

```bash
mkdir build && cd build
cmake -DCMAKE_INSTALL_PREFIX=/usr ..
make -j install DESTDIR=/home/MYUSER/sysroot
```

2. **Set environment variables before using pkg-config:**

```bash
export PKG_CONFIG_ALLOW_SYSTEM_CFLAGS=yes
export PKG_CONFIG_ALLOW_SYSTEM_LIBS=yes
export PKG_CONFIG_SYSROOT_DIR=/home/MYUSER/sysroot
export PKG_CONFIG_LIBDIR=$PKG_CONFIG_SYSROOT_DIR/usr/lib64/pkgconfig
```

3. **Invoke `pkg-config` commands; the returned `-I` and `-L` flags will correctly embed sysroot paths.**

Refer to Diego Elio Pettenò's comprehensive tutorial for advanced cross-compiling with pkg-config: <https://autotools.io/pkgconfig/cross-compiling.html>

---

## 5. Best Practices and Recommendations

- **Use `target_compile_options` + `GTEST_CFLAGS`** instead of manually specifying includes or defining macros. This ensures all required flags (includes, macros, pthread options) are covered.

- **Use `target_link_libraries` + `GTEST_LDFLAGS`** for linking to maintain all necessary linker flags, including `-L` and threading libraries.

- **Keep consistent C++ standard settings (C++17 and above)** in your main project to avoid compatibility issues when linking GoogleTest.

- **On Windows, enable `gtest_force_shared_crt`** in CMake to prevent CRT runtime mismatches when linking GoogleTest.

- **Consider building GoogleTest as part of your main project with `FetchContent` or `add_subdirectory()`** for tighter integration and consistent compiler/linker settings.

- **Always verify your build environment detects pthread support correctly or force-enable it with macros if necessary.**

---

## 6. Example: Full Minimal CMakeLists.txt with FetchContent

```cmake
cmake_minimum_required(VERSION 3.14)
project(my_project)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)

FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/03597a01ee50ed33e9dfd640b249b4be3799d395.zip
)

set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(hello_test hello_test.cc)

target_link_libraries(hello_test GTest::gtest_main)

include(GoogleTest)
gtest_discover_tests(hello_test)
```

This setup:

- Downloads GoogleTest at configure time.
- Builds it inside your project.
- Links your test executable with `gtest_main`.
- Enables CMake test discovery and integration.

---

## 7. Troubleshooting

<AccordionGroup title="Common GoogleTest and CMake Issues">
<Accordion title="Error: None of the required 'gtest_main' found">
This error indicates that `pkg-config` cannot locate the GoogleTest `.pc` files. To fix:

- Confirm that GoogleTest is installed and `.pc` files exist.
- Set the `PKG_CONFIG_PATH` environment variable to include the directory with `.pc` files.
- Re-run CMake.
</Accordion>
<Accordion title="Linker errors related to pthread on Linux">
GoogleTest relies on pthread for threading support. If you see linker errors (e.g., undefined references to pthread functions):

- Ensure `-pthread` is added to both compiler and linker flags.
- Use pkg-config or CMake's `Threads` package to set these flags automatically.
- Alternatively, define `-DGTEST_HAS_PTHREAD=1`.
</Accordion>
<Accordion title="Runtime library mismatch errors on Windows (MSVC)">
Visual Studio projects commonly link the C runtime dynamically while GoogleTest's default is static linking.

- Enable `gtest_force_shared_crt` in your CMake setup to force dynamic linkage.
- This aligns runtime linking between your project and GoogleTest, preventing linker errors.
</Accordion>
</AccordionGroup>

---

## 8. Next Steps

- Read the [Quickstart: Building with CMake](quickstart-cmake.md) for a practical example and validation steps.
- Explore [Writing Your First Test](writing-your-first-test.md) to create runnable test cases.
- Learn about [Configuring GoogleTest](configuring-googletest.md) for advanced customization.
- Consult [Integration with Build and CI Systems](integration-workflow.md) for embedding GoogleTest in larger workflows.

---

## 9. Additional Resources

- GoogleTest official repository: [https://github.com/google/googletest](https://github.com/google/googletest)
- Diego Elio Pettenò’s cross-compiling pkg-config guide: <https://autotools.io/pkgconfig/cross-compiling.html>

---

Thank you for choosing GoogleTest. Your tests will now build and run reliably across platforms with medium to advanced integration confidence.

---

*This concludes the integration guide for GoogleTest with CMake.*