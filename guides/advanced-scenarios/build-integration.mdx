---
title: "Integrating with Build Systems"
description: "Practical advice for integrating GoogleTest and GoogleMock into real-world C++ build workflows using CMake, Bazel, and pkg-config. Learn how to set up, manage dependencies, and ensure your tests run reliably in CI/CD."
---

# Integrating with Build Systems

Practical advice for integrating GoogleTest and GoogleMock into real-world C++ build workflows using CMake, Bazel, and pkg-config. Learn how to set up, manage dependencies, and ensure your tests run reliably in CI/CD.

---

## Workflow Overview

### Purpose and Scope
This guide helps C++ developers incorporate GoogleTest and GoogleMock into their preferred build systems for efficient, scalable testing workflows. It focuses solely on integrating the testing frameworks within build environments such as **CMake**, **Bazel**, and **pkg-config**, enabling users to manage dependencies, automate test discovery, and streamline test execution within CI/CD pipelines.


### Prerequisites
- A C++ project with a supported compiler enforcing at least C++17.
- GoogleTest and GoogleMock source accessible or installed.
- Familiarity with your build system (CMake, Bazel, or pkg-config).


### Expected Outcome
- Your GoogleTest and GoogleMock tests are correctly built, linked, and executable via your build system.
- Smooth integration with continuous integration workflows.
- Ability to leverage `gtest_main` and `gmock_main` for automatic main() entry points.


### Time Estimate
- Initial integration setup: 15–30 minutes (depending on build system familiarity).

### Difficulty Level
- Intermediate: Assumes understanding of C++ build tools and basic knowledge of GoogleTest and GoogleMock concepts.

---

## Step-by-Step Integration Instructions

### 1. Integrating with CMake

CMake is the most common and recommended build system for GoogleTest and GoogleMock integration.

#### a. Using Installed GoogleTest/GoogleMock Libraries

1. **Find Installed Package:** Use `find_package` to locate the installed GoogleTest package.

```cmake
find_package(GTest CONFIG REQUIRED)
```

2. **Link Libraries:** Link your test target against the appropriate libraries.

```cmake
target_link_libraries(your_test_target PRIVATE GTest::gtest_main GTest::gmock)
```

3. **Add Tests:** Register your test executable to enable CTest integration.

```cmake
add_test(NAME your_test COMMAND your_test_target)
```

4. **Run Tests:** CTest can then run tests, or tests can be executed directly.

---

#### b. Building GoogleTest as Part of Your Project

1. **Use FetchContent:** Automatically download and add GoogleTest source during project configuration.

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/release-1.17.0.zip
)
# For Windows, match the runtime
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(your_test example_test.cpp)
target_link_libraries(your_test PRIVATE gtest_main gmock)
add_test(NAME example_test COMMAND your_test)
```

2. **Benefits:** Ensures consistent compiler flags and eliminates ABI mismatches.

---

#### c. Choosing Between gtest and gtest_main

- Use **`gtest_main`** or **`gmock_main`** libraries to get automatic `main()` functions.
- If you need custom setup or argument parsing, implement your own `main()` that calls `testing::InitGoogleTest` or `testing::InitGoogleMock` and then `RUN_ALL_TESTS()`.

Example `main()` boilerplate:

```cpp
int main(int argc, char **argv) {
  testing::InitGoogleTest(&argc, argv);
  return RUN_ALL_TESTS();
}
```

---

### 2. Integrating with Bazel

Bazel users can build and run GoogleTest and GoogleMock tests efficiently with native support.

#### a. Workspace Setup

- Add GoogleTest and GoogleMock as external dependencies using `http_archive` or equivalent workspace rules.

```python
http_archive(
    name = "com_google_googletest",
    urls = ["https://github.com/google/googletest/archive/release-1.17.0.zip"],
    strip_prefix = "googletest-release-1.17.0",
)
```

#### b. BUILD File Configuration

1. **Define Test Targets:** Use `cc_test` and link against GoogleTest and GoogleMock.

```python
cc_test(
    name = "your_test",
    srcs = ["your_test.cc"],
    deps = ["@com_google_googletest//:gtest_main", "@com_google_googletest//:gmock"]
)
```

2. **Run Tests:** Invoke with `bazel test //:your_test`.


---

### 3. Using pkg-config

For users on Linux and similar systems, pkg-config simplifies managing compiler and linker flags.

#### a. Installation

- Install the `gtest.pc` and `gmock_main.pc` pkg-config files, or build GoogleTest with CMake install to generate them.

#### b. Compile and Link

- Use pkg-config to obtain flags in your build scripts.

```bash
c++ $(pkg-config --cflags gmock_main) your_test.cpp $(pkg-config --libs gmock_main) -o your_test
```

- This automatically sets include and linker paths for GoogleTest and GoogleMock.

---

## Continuous Integration (CI) Tips

- Always run tests with `RUN_ALL_TESTS()` and do not ignore its return value to ensure CI accurately detects test failures.

- Use **JUnit XML output** to integrate test reports with CI systems by passing flags:

```bash
./your_test --gtest_output=xml:report.xml
```

- Cache downloaded sources and build artifacts in CI pipelines to improve performance.

- Consider building GoogleTest and GoogleMock as part of your project for reproducible builds across environments.

---

## Troubleshooting Common Integration Issues

<AccordionGroup title="Common Issues with Build Integration">
<Accordion title="Linker errors involving GoogleTest or GoogleMock">
- **Symptoms:** Undefined references to GoogleTest or GoogleMock symbols.
- **Cause:** Incorrect linking order or missing libraries.
- **Resolution:** Ensure your executable links with `gtest_main` or `gmock_main` libraries and that dependencies are correctly specified.
</Accordion>
<Accordion title="Multiple main() definitions errors">
- **Symptoms:** Linker reports multiple definitions of `main`.
- **Cause:** Linking both `gtest_main` and defining your own `main()`.
- **Resolution:** Use either `gtest_main` for automatic main or write your own main. Do not mix.
</Accordion>
<Accordion title="ABI mismatches on Windows with Visual Studio">
- **Symptoms:** Runtime crashes or linker runtime library mismatches.
- **Cause:** GoogleTest linked using a different runtime (static vs dynamic) than your project.
- **Resolution:** Use the `gtest_force_shared_crt` CMake option when building GoogleTest to match your project’s runtime linkage.
</Accordion>
</AccordionGroup>

---

## Best Practices

- Prefer **`gtest_main`** and **`gmock_main`** for simple integration to avoid writing custom `main()` functions.

- Embed GoogleTest and GoogleMock as part of your build system via FetchContent or Bazel workspace rules for version control and compatibility.

- Always verify your compiler supports **C++17** or higher as required by GoogleTest.

- When using CMake, register your test executables with `add_test()` to leverage CTest integration and simplify running tests.

- Leverage continuous integration environments by outputting test results in JUnit XML format.

- Use pkg-config only when you rely on system-installed versions of GoogleTest.

---

## Summary

This guide helped you integrate GoogleTest and GoogleMock into your C++ project's build workflow using CMake, Bazel, or pkg-config. It includes practical instructions for build setup, linking, test execution, and CI/CD considerations. Follow the troubleshooting tips and best practices to ensure reliable, maintainable test automation aligned with your build environment.

---

## Additional Resources

- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) — For test writing basics.
- [GoogleMock Introduction](https://github.com/google/googletest/blob/main/googlemock/README.md) — Learn mocking basics.
- [Supported Platforms & Build Systems](overview/integration-ecosystem/supported-platforms) — Verify platform compatibility.
- [Troubleshooting Common Setup Issues](getting-started/validation-troubleshooting/common-issues) — Resolve build and link errors.
- [CTest and CI Integration](overview/integration-ecosystem/integration-tooling) — Automate tests in CI pipelines.

---

## Example: Minimal CMake Setup for Tests

```cmake
cmake_minimum_required(VERSION 3.14)
project(MyProject CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/release-1.17.0.zip
)
set(gtest_force_shared_crt ON CACHE BOOL "" FORCE)
FetchContent_MakeAvailable(googletest)

add_executable(my_test test_file.cpp)
target_link_libraries(my_test PRIVATE gtest_main gmock)
add_test(NAME my_test COMMAND my_test)
```

Specify your test sources and adjust project settings as needed.


---

## Custom main() Example for GoogleMock

If you want to initialize GoogleMock explicitly, use:

```cpp
#include "gmock/gmock.h"
int main(int argc, char** argv) {
  testing::InitGoogleMock(&argc, argv);
  return RUN_ALL_TESTS();
}
```

Remember not to link `gmock_main` in this case, to avoid multiple `main()` errors.

---

## See Also
- [Using GoogleMock](guides/getting-started/integrate-mocking)
- [Writing Your First Test](getting-started/core-setup/first-test)
- [Organizing and Structuring Tests](guides/core-workflows/organizing-tests)

---

<Check>
Ensure all build configurations specify C++17 or higher, link against `gtest_main` or `gmock_main` as appropriate, and call `InitGoogleTest()` or `InitGoogleMock()` in your executable.
</Check>
