---
title: "Advanced Mocking: Cardinalities and Actions"
description: "Delves into advanced features for specifying expected call counts (cardinalities), creating complex side effects (actions), and refactoring mocks for advanced behaviors. Illustrates powerful techniques to test intricate interactions and control side effects."
---

# Advanced Mocking: Cardinalities and Actions

GoogleMock offers powerful tools to specify how many times mocked methods are expected to be called (*cardinalities*) and to define complex behaviors when those calls happen (*actions*). This guide dives deeper into advanced techniques to precisely control and verify function call counts, create intricate side effects, and refactor mocks for managing sophisticated interactions.

---

## 1. Workflow Overview

### Task Description
This guide helps you harness GoogleMock's advanced capabilities:
- Specify expected call counts with fine-grained cardinalities (e.g., exact, at least, between).
- Define complex side effects when mock methods are invoked through customized actions.
- Refactor and combine mocks to model advanced behaviors and test intricate interactions.

### Prerequisites
- Basic familiarity with GoogleMock mock class creation and `EXPECT_CALL`, `ON_CALL` macros.
- Understanding of matchers and simple mocking from guides like [Mocking Basics](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md) and [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md).
- Development environment with GoogleMock integrated.

### Expected Outcome
By following this guide, you'll be able to:
- Use cardinalities like `Exactly(n)`, `AtLeast(n)`, `AtMost(n)`, `Between(m, n)`, and combinations thereof to precisely set call count expectations.
- Employ multiple actions per expectation such as chaining side effects with `DoAll()`, returning variable values, or invoking callbacks.
- Control when expectations retire to avoid brittle tests.
- Implement custom cardinalities and actions for unique testing scenarios.

### Time Estimate
20-40 minutes, depending on your familiarity with GoogleMock.

### Difficulty Level
Intermediate to advanced.

---

## 2. Specifying Call Counts with Cardinalities

GoogleMock's cardinalities enable defining flexible expectations on how often a mock method is called. These are used primarily in `EXPECT_CALL().Times()` clauses.

### Built-in Cardinalities
- **`Exactly(n)`**: The method must be called exactly `n` times.
- **`AtLeast(n)`**: The method must be called at least `n` times.
- **`AtMost(n)`**: The method must be called at most `n` times.
- **`Between(m, n)`**: The call count must be between `m` and `n` inclusive.
- **`AnyNumber()`**: The method can be called any number of times (including zero).

### Usage Examples
```cpp
using ::testing::Exactly;
using ::testing::AtLeast;
using ::testing::AtMost;
using ::testing::Between;
using ::testing::AnyNumber;

EXPECT_CALL(mock_obj, Foo())
    .Times(Exactly(2));  // Exactly twice

EXPECT_CALL(mock_obj, Bar())
    .Times(AtLeast(1));  // One or more times

EXPECT_CALL(mock_obj, Baz())
    .Times(AtMost(3));   // Up to 3 times

EXPECT_CALL(mock_obj, Quux())
    .Times(Between(1, 4));  // Between 1 and 4 times

EXPECT_CALL(mock_obj, Corge())
    .Times(AnyNumber());    // Any number of times
```

### Behavior Checks
Cardinalities internally support queries like:
- `IsSatisfiedByCallCount(call_count)`: Whether the given call count satisfies the cardinality.
- `IsSaturatedByCallCount(call_count)`: Whether the call count has reached or exceeded the upper bound.
- `IsOverSaturatedByCallCount(call_count)`: Whether the call count exceeds allowed upper bound.

### Error Handling for Invalid Cardinalities
If invalid bounds are specified (e.g., negative numbers, max < min), GoogleMock emits fatal errors during test setup to alert you early.

### Custom Cardinalities
You can define your own cardinalities by implementing the `CardinalityInterface` and creating a factory via `MakeCardinality()`. For example, enforcing that calls occur an even number of times:

```cpp
class EvenCardinality : public ::testing::CardinalityInterface {
 public:
  bool IsSatisfiedByCallCount(int call_count) const override {
    return (call_count % 2) == 0;
  }

  bool IsSaturatedByCallCount(int /* call_count */) const override {
    return false;
  }

  void DescribeTo(std::ostream* os) const override {
    *os << "called even number of times";
  }
};

::testing::Cardinality EvenNumber() {
  return ::testing::MakeCardinality(new EvenCardinality);
}

// Later in your test:
EXPECT_CALL(mock_obj, Foo()).Times(EvenNumber());
```

### Descriptions
When test failures occur, GoogleMock provides human-friendly descriptions of cardinalities and actual call counts to make debugging easier:
- `called once`, `called twice`, `called X times`, or `never called`.
- Cardinalities are described in plain language, e.g., "called at least twice".

---

## 3. Creating and Composing Complex Side Effects with Actions

GoogleMock actions define what happens when a mock method is invoked, transforming mocks from simple placeholders to active participants in your tests.

### Basic Actions
- `Return(value)`: Returns a specified value.
- `ReturnRef(variable)`: Returns a reference to a variable.
- `ReturnPointee(pointer)`: Returns the value pointed to by pointer at call time.
- `SetArgPointee<N>(value)`: Sets the `N`-th output argument to a specified value.

### Combining Actions
Use `DoAll()` to sequence multiple actions in one call. Only the last action's return value is used:

```cpp
EXPECT_CALL(mock, MutateInt(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

This example sets the first argument pointed-to value to 5 and returns `true`.

### Actions as Callables
You may use existing functions, methods, lambdas, or functors directly as actions:

```cpp
EXPECT_CALL(mock, Compute(_, _))
    .WillOnce(Invoke(&MyComputeFunction));
```

The callable arguments must be compatible with the mock method signature.

### Invoking Callbacks Passed as Arguments
If your mock method takes function pointers, functors, or callbacks as arguments, you can invoke them on demand using `InvokeArgument<N>(args...)`:

```cpp
EXPECT_CALL(mock, DoAsyncCall(_, _))
    .WillOnce(InvokeArgument<1>(42));  // Invoke the second argument, passing 42
```

### Invoking Without Arguments
Invoke a functor or function without forwarding the mock's arguments with `InvokeWithoutArgs()`.

### Ignoring Return Values
Use `IgnoreResult()` to adapt actions returning non-void types to contexts expecting `void`.

### Selecting Arguments for Actions
When your callable requires fewer or differently ordered arguments than the mock method, use:
- `WithArg<N>(action)` - for single argument
- `WithArgs<N1, N2, ...>(action)` - for multiple selected arguments
- `WithoutArgs(action)` - for callables with no arguments

Example:
```cpp
EXPECT_CALL(mock, Foo(_, _, _))
    .WillOnce(WithArgs<0, 2>(Invoke(MyFunc)));
```

### Retiring Expectations
By default, expectations remain active even after they reach their upper bound (sticky). Use `.RetiresOnSaturation()` to retire an expectation when saturated, allowing further calls to match other expectations.

### Sharing Actions
Copy action objects efficiently to reuse them, but be careful sharing stateful actions as they can cause unexpected shared behavior.

---

## 4. Refactoring and Advanced Mock Behaviors

### Managing Multiple Expectations
GoogleMock searches expectations in reverse order to prioritize more specific or recent expectations over general ones. Use catch-all expectations (e.g., with `_` and `Times(AnyNumber())`) carefully to avoid shadowing more specific cases.

### Sequencing and Partial Ordering
- Use `InSequence` to enforce strict call order within a block.
- Use `Sequence` objects to express partial orders among expectations with `.InSequence()` and `.After()` clauses.

### Delegation
You can delegate behavior to a real object or complex fake for default behaviors, allowing mixing of mocks with working implementations. This is useful for legacy code or when partial mocking is necessary.

### Controlling Verbosity
Adjust `--gmock_verbose=[info|warning|error]` to control logging of mock calls and warnings during tests.

### Verification
GoogleMock automatically validates expectations when mocks are destroyed. You can force verification earlier with `Mock::VerifyAndClearExpectations(mock_object)`.

---

## 5. Practical Tips and Best Practices

- **Use cardinalities thoughtfully:** Avoid over-constraining call counts which may induce brittle tests.
- **Combine actions for side effects:** Use `DoAll()` to handle complex behaviors involving output parameters and returns.
- **Retire expectations when applicable:** Use `.RetiresOnSaturation()` to avoid unexpected failures from sticky expectations.
- **Match specific calls last:** Order your `EXPECT_CALL`s such that more specific matchers come after general ones for proper overriding.
- **Use sequences to express call order:** Avoid brittleness by sequencing only when order matters.

---

## 6. Example: Using Cardinalities and Complex Actions

```cpp
#include <gmock/gmock.h>
using ::testing::AtLeast;
using ::testing::Exactly;
using ::testing::Return;
using ::testing::SetArgPointee;
using ::testing::DoAll;

class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), ());
  MOCK_METHOD(bool, Query, (std::string query, std::string* result), ());
};

TEST(DatabaseTest, QueryCalledAtLeastTwice)
{
  MockDatabase mock;

  // Connect exactly once
  EXPECT_CALL(mock, Connect("db://localhost"))
      .Times(Exactly(1))
      .WillOnce(Return(true));

  // Query called at least twice
  EXPECT_CALL(mock, Query(_, _))
      .Times(AtLeast(2))
      .WillRepeatedly(
          DoAll(SetArgPointee<1>("query result"), Return(true)));

  // Exercise the mock
  EXPECT_TRUE(mock.Connect("db://localhost"));

  std::string output;
  EXPECT_TRUE(mock.Query("SELECT 1", &output));
  EXPECT_EQ(output, "query result");

  EXPECT_TRUE(mock.Query("SELECT 2", &output));
  EXPECT_EQ(output, "query result");
}
```

This test expects the connection to occur once and the query function to be called at least twice, always setting the output string and returning true.

---

## 7. Troubleshooting & Tips

### Common Issues
- **Over-saturation errors:** Usually caused by calling a method more times than specified. Consider `.RetiresOnSaturation()` if multiple calls beyond bound are expected.
- **Uninteresting call warnings:** Use `NiceMock<T>` to suppress warnings for irrelevant calls, or explicitly allow calls with `EXPECT_CALL(...).Times(AnyNumber())`.
- **Conflicting expectations:** Ensure that specific expectations are ordered after general catch-alls to avoid shadowing.
- **Default actions not firing:** Use `ON_CALL` to set appropriate default actions.

### Best Practices
- Prefer `ON_CALL` for default behaviors without expectations.
- Use `EXPECT_CALL` only when call verification is necessary.
- Avoid over-specification of argument matchers.
- Prefer sequences to enforce call order only when required.

### Performance Considerations
- Abstract heavy mock setups into test fixtures.
- Reduce the number of chained actions where possible.
- Define mock constructors/destructors in `.cc` files to speed up compilation.

---

## 8. Next Steps & Related Content

- Explore [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) for recipes on actions, matchers, and controlling mocks.
- Review [Setting Expectations & Cardinalities](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#EXPECT_CALL.Times) for official details.
- Learn about [Mocking Basics](https://github.com/google/googletest/blob/main/guides/core-workflows/mocking-basics.mdx) for foundation.
- Dive into [Writing New Actions](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#QuickNewActions) for custom behavior development.

---

For source and code examples, see the [gmock-cardinalities.cc](https://github.com/google/googletest/blob/main/googlemock/src/gmock-cardinalities.cc) and the unit tests in [gmock-cardinalities_test.cc](https://github.com/google/googletest/blob/main/googlemock/test/gmock-cardinalities_test.cc).

---

# Summary
This guide details how to specify call count expectations (cardinalities) and create complex side effects (actions) in GoogleMock. It covers built-in cardinalities like `Exactly`, `AtLeast`, `AtMost`, and `Between`, explains how to compose actions including chaining with `DoAll()`, and provides tips for managing expectations with `.RetiresOnSaturation()`. Key sections include Cardinalities, Actions, Refactoring Complex Behavior, Troubleshooting, and Practical Examples.

## Key Sections
- Specifying Call Counts with Cardinalities
- Creating and Composing Complex Side Effects with Actions
- Refactoring and Advanced Mock Behaviors
- Troubleshooting & Tips
- Practical Example

## Important Links & References
- [GoogleMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)
- [Mocking Reference: EXPECT_CALL.Times](https://github.com/google/googletest/blob/main/docs/reference/mocking.md#EXPECT_CALL.Times)
- [gmock-cardinalities.cc Implementation](https://github.com/google/googletest/blob/main/googlemock/src/gmock-cardinalities.cc)
- [gmock-cardinalities_test.cc Tests](https://github.com/google/googletest/blob/main/googlemock/test/gmock-cardinalities_test.cc)
- Related guides: [Mocking Basics](https://github.com/google/googletest/blob/main/guides/core-workflows/mocking-basics.mdx), [Writing New Actions](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#QuickNewActions)

## Next Steps
- Apply cardinalities to precisely control expected function call counts.
- Use `WillOnce`, `WillRepeatedly`, and `DoAll` to define realistic mock behaviors.
- Practice writing custom cardinalities or actions to model domain-specific needs.
- Consult troubleshooting sections for handling common pitfalls such as uninteresting calls and conflicts.
- Explore sequencing and partial ordering to manage call order constraints.