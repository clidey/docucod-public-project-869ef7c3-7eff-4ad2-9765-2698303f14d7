---
title: "Common Pitfalls, FAQ, and Troubleshooting"
description: "Addresses frequent questions, solutions to typical issues, and practical troubleshooting steps. Helps users overcome common hurdles efficiently, improving adoption and reducing frustration."
---

# Common Pitfalls, FAQ, and Troubleshooting

Efficiently navigating GoogleTest and GoogleMock requires knowing how to avoid common pitfalls, interpret errors, and troubleshoot typical problems. This guide addresses frequently asked questions, offers practical tips to overcome hurdles, and provides actionable troubleshooting steps to enhance your testing experience.

---

## 1. Common Pitfalls

### 1.1 Expectation Setup Must Precede Calls

- **What Happens:** All expectations via `EXPECT_CALL` must be set before the mock method is invoked.
- **Why It Matters:** GoogleMock relies on pre-declared expectations to monitor and verify calls correctly.
- **Avoid:** Writing code that sets `EXPECT_CALL` after the mock function has been called.

```cpp
EXPECT_CALL(mock_object, Method(_));   // Correct: Set first
mock_object.Method(arg);               // Call after

mock_object.Method(arg);               // Wrong: Called before expectation
EXPECT_CALL(mock_object, Method(_));   // Expectation set too late
```

### 1.2 Beware Sticky Expectations

- Expectations remain *active* even after they are satisfied (sticky by default).
- Without `.RetiresOnSaturation()`, calling the mock method beyond the expected count results in failures.
- Use `.RetiresOnSaturation()` or sequences to retire expectations and avoid upper-bound violations.

### 1.3 Over-specifying Expectations Leads to Brittle Tests

- Setting expectations too tightly (specific arguments, strict call counts) can break tests on unrelated changes.
- Favor specifying only necessary argument matchers, call counts, and ordering.
- Use `ON_CALL` to set default behaviors and `EXPECT_CALL` only when verification is needed.

### 1.4 Mock Methods Must Be Virtual

- Only virtual methods can be mocked using `MOCK_METHOD`.
- Non-virtual methods require special techniques like template mocks or interface wrappers.

### 1.5 Mock Objects Should Have Virtual Destructors

- Missing a virtual destructor can cause undefined behavior, including memory leaks.
- Always ensure the base class destructor is virtual when mocking.

### 1.6 Handling Overloaded Methods

- Mock all overloads if used, or bring other overloads into scope with `using` to avoid hiding them.

### 1.7 Correct Use of Matchers

- Use `_` to express "match anything" for uninterested arguments.
- Use specialized matchers (`Ge()`, `NotNull()`, `Contains()`, etc.) to clarify intent.
- When calling methods with reference parameters, use `std::ref()` inside matchers to match references.

### 1.8 Default Actions and Uninteresting Calls

- If no `EXPECT_CALL` is set for a method, calling it produces a warning (uninteresting call).
- Use `NiceMock` to suppress uninteresting call warnings, or add `.Times(AnyNumber())`.

### 1.9 Beware of Side Effects When Specifying Actions

- The expression inside `.WillOnce()` or `.WillRepeatedly()` is evaluated once when expectation is set, not on every call.
- Avoid side effects in the action arguments that should execute every time.

### 1.10 Mock Lifetime and Verification

- Mock expectations are verified on destruction of the mock object.
- If you allocate mocks on the heap and the object is leaked or not deleted, verification won't happen.
- Use `Mock::VerifyAndClearExpectations()` to force verification early if necessary.

---

## 2. Frequently Asked Questions (FAQ)

### Q2.1 When No Expectation Is Matched, Why Does My Test Fail?

- An unexpected call occurs if the method is called but arguments do not match any `EXPECT_CALL`.
- GoogleMock reports this as an error immediately.
- Fix your expectations to cover all allowed argument patterns or add a catch-all expectation with `_` matcher.

### Q2.2 Why Does gMock Warn About Uninteresting Calls?

- Uninteresting calls are method calls without corresponding `EXPECT_CALL`.
- By default, they produce warnings.
- You can suppress these by wrapping your mock in `NiceMock<>` or adding an all-encompassing `EXPECT_CALL` with `.Times(AnyNumber())`.

### Q2.3 How to Define a Mock for a Class That Has Non-Virtual Methods?

- gMock cannot mock non-virtual methods directly.
- Use interface abstractions, wrapper adaptors, or templates to enable mocking.

### Q2.4 How Can I Mock a Method that Returns a Move-Only Type (e.g., `unique_ptr`)?

- Use `MOCK_METHOD` as normal for move-only types.
- For return values, use lambdas in `.WillOnce()` / `.WillRepeatedly()` to create fresh objects each call.
- Avoid directly returning `std::move` inside repeated `Return()` expressions.

### Q2.5 Why Am I Getting Compiler Warnings on Const Parameters in Mock Signatures?

- C++ ignores top-level const on parameters, so declaring parameters as `const` or non-const is equivalent.
- Remove non-meaningful const qualifiers in mocks to avoid MSVC warnings.

### Q2.6 How Can I Control the Order of Calls to Mock Methods?

- Use the `InSequence` object to put expectations in a sequence.
- Use `.InSequence()` clause with sequences to express partial orders.
- Use `.After()` clauses for complex ordering constraints.

### Q2.7 Why Am I Seeing the Same Expectation Failure Message Twice?

- gMock prints expectation failures at the time of the violation and at test teardown.
- Although content may look repeated, they refer to different failure points.

### Q2.8 How Do I Suppress Verbose Output from gMock?

- Use the `--gmock_verbose=LEVEL` flag with levels `info`, `warning`, or `error`.
- The default is `warning`.
- Adjust verbosity to reduce noise during debugging.

### Q2.9 How to Mock Static or Free Functions?

- Not directly mockable in gMock.
- Abstract them behind an interface and mock the interface.

### Q2.10 What to Do When gMock Thinks Expectations Are Not Satisfied?

- Run tests with `--gmock_verbose=info` to see detailed call traces.
- Check argument matchers carefully.
- Confirm that calls happen in the expected order and quantity.

---

## 3. Troubleshooting

### 3.1 Test Fails Due to Unexpected Call

- **Symptom:** Failure message indicating function call count doesn't match expectation.
- **Cause:** Call made with arguments not covered by any `EXPECT_CALL`.
- **Fix:** Add matching `EXPECT_CALL` with appropriate argument matchers or catch-all `_` matcher.

### 3.2 Test Fails with Upper Bound Violated (Excessive Call)

- **Symptom:** Method called more times than allowed.
- **Cause:** `EXPECT_CALL` with restricted `.Times(n)` or `.WillOnce()` does not expect additional calls.
- **Fix:** Use `.RetiresOnSaturation()` to retire saturated expectations, or extend `.Times`.

### 3.3 Uninteresting Call Warning When Default Action Is Set

- **Symptom:** Warning despite `ON_CALL` default actions.
- **Cause:** `ON_CALL` defines behavior but does not set expectations.
- **Fix:** Add an `EXPECT_CALL(...).Times(AnyNumber())` to indicate expected calls without checks.

### 3.4 Mock Not Verified Because It Was Never Deleted

- **Symptom:** Test passes but expectations not checked.
- **Cause:** Mock object leaked or not destroyed.
- **Fix:** Ensure mocks are properly destructed or call `Mock::VerifyAndClearExpectations()` manually.

### 3.5 Compilation Errors with Complex Method Signatures in MOCK_METHOD

- **Symptom:** Errors on methods with types containing commas or templates.
- **Cause:** Unprotected commas confuse the macro.
- **Fix:** Wrap return or argument types in extra parentheses or use type aliases.

### 3.6 Overloaded Mock Methods Cause Ambiguity

- **Symptom:** Compiler ambiguity errors when mocking overloaded methods.
- **Fix:** Mock all overloaded versions or use `using BaseClass::MethodName` to expose overloads.

### 3.7 Runtime Errors When Returning Move-Only Objects in WillRepeatedly

- **Cause:** `Return(std::move(...))` can only be run once.
- **Fix:** Use a lambda to produce a new object on each call.

```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](StringPiece) { return std::make_unique<Buzz>(); });
```

### 3.8 Missing Virtual Destructor Causes Heapcheck Failures

- **Fix:** Make base class destructor virtual.

### 3.9 Expectation Not Matched Due to Argument References

- If argument is a reference, use `Ref()` matcher to compare objects by reference.

### 3.10 gMock Floods Output with Stack Traces on Crash

- gMock prints stack traces for uninteresting calls triggered by test crashes.
- To reduce noise, limit test threads or suppress certain log messages with expectations.

---

## 4. Best Practices and Tips

- Use `ON_CALL` to set default behaviors and reserve `EXPECT_CALL` for actual verifications.
- Use `NiceMock` when you want to ignore uninteresting calls.
- Use sequences and `.InSequence()` clauses to enforce call ordering only when necessary.
- Prefer simple argument matchers over exact matches to reduce test brittleness.
- Ensure mock objects are destructed so expectations get verified.
- Use `--gmock_verbose=info` to debug unexpected call failures.
- Delegate to fakes or real objects in tests when behavior differs but should be preserved.
- Use `RetiresOnSaturation()` to avoid sticky expectations pitfalls.
- Protect `MOCK_METHOD` macro arguments when they contain template commas.
- Use `SafeMatcherCast<T>()` when matching arguments with type conversions.

---

## 5. Additional Resources

- [GoogleTest Primer](../overview/product-intro-core-value/what-is-googletest.html) – Basic concepts and getting started.
- [Writing and Running First Test](../guides/getting-started/first-test.html) – Step-by-step tutorial.
- [Mocking Workflow with GoogleMock](../guides/mocking-best-practices/mocking-workflow.html) – Setting up and using mocks properly.
- [Mocking Patterns and Best Practices](../guides/mocking-best-practices/mocking-patterns.html) – Advanced guidance on writing robust mocks.
- [Mocking Reference](../docs/reference/mocking.md) – Detailed macro and class references.
- [GoogleMock FAQ](../docs/gmock_faq.md) – Answers to common questions and tricky situations.
- [GoogleMock Cheat Sheet](../docs/gmock_cheat_sheet.md) – Handy quick references.
- [GoogleMock Cookbook](../docs/gmock_cook_book.md) – Recipes for advanced mocking scenarios.

---

This guide synthesizes important knowledge to help you quickly identify, resolve, and avoid common issues with GoogleTest and GoogleMock, ensuring a smoother, more productive testing workflow.
