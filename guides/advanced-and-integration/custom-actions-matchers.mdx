---
title: "Defining Custom Actions and Matchers"
description: "Create your own actions and matchers to support unique testing scenarios, with principles for reusable and expressive test code."
---

# Defining Custom Actions and Matchers

Create your own actions and matchers to support unique testing scenarios, with principles for reusable and expressive test code.

---

## Overview

This guide helps you extend GoogleMock by defining custom actions and matchers tailored to your specific testing needs. By creating reusable, expressive, and maintainable components, you can accurately describe complex behaviors and argument validations in your tests that built-in matchers and actions cannot cover.

### Prerequisites
- Familiarity with GoogleMock basics: mock classes, `EXPECT_CALL`, `ON_CALL`.
- Understanding of matchers and actions concepts in GoogleMock.
- C++11 or later knowledge.

### Expected Outcome
By following this guide, you will be able to:
- Define simple and parameterized custom matchers using macros and classes.
- Create monomorphic and polymorphic matchers for flexible usage.
- Write custom actions using lambdas, functors, or action interfaces.
- Compose and combine matchers and actions effectively.

### Time Estimate
15-30 minutes, depending on familiarity and complexity of your custom needs.

### Difficulty Level
Intermediate to Advanced

---

## Defining Custom Matchers

Matchers define the conditions that mock function arguments must satisfy. While GoogleMock offers an extensive built-in matcher library, custom matchers enable you to extend functionality to perfectly fit your scenarios.

### Using `MATCHER` and `MATCHER_P` Macros

GoogleMock provides a family of macros to quickly define custom (parameterized) matchers:

```cpp
MATCHER(Name, "description") {
  // Use 'arg' as the input value.
  return /* boolean condition based on arg */;
}

MATCHER_P(Name, param, "description") {
  // Use 'arg' and 'param' inside here.
  return /* boolean condition */;
}
```

- `Name` is the matcher identifier.
- The description string documents behavior and appears in failure messages.

#### Example: Basic Matcher
```cpp
MATCHER(IsEven, "") {
  return (arg % 2) == 0;
}

// Usage:
EXPECT_CALL(mock_obj, Func(IsEven()));
```

This matcher matches integers that are even.

#### Example: Parameterized Matcher
```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}

// Usage:
EXPECT_THAT(expr, HasAbsoluteValue(10));
```

This checks if the argument's absolute value equals the specified parameter.

#### Improving Failure Messages
You can add custom failure details by streaming messages to the `result_listener` pointer:

```cpp
MATCHER(IsDivisibleBy7, "") {
  if (arg % 7 == 0) return true;
  *result_listener << "the remainder is " << (arg % 7);
  return false;
}
```

If this matcher fails, it will print the remainder providing helpful context.

### When to Use `MATCHER` Macros

- For quick, lightweight matchers that need flexible types.
- When you want straightforward behaviors that easily use `arg` and parameters.
- When you seek readable and maintainable test code with expressive failure messages.

### Advanced: Writing Matcher Classes

For complex or commonly reused matchers, you may want to define a matcher class manually for better control, better type-checking, and custom behaviors.

#### Requirements
- Declare `using is_gtest_matcher = void;` so GoogleMock recognizes it.
- Implement:
  - `bool MatchAndExplain(const T& value, std::ostream* listener) const` - returns whether the value satisfies the matcher; stream additional info to listener.
  - `void DescribeTo(std::ostream* os) const` - describes expected condition.
  - `void DescribeNegationTo(std::ostream* os) const` - describes negation.

#### Example: DivisibleBy7Matcher

```cpp
class DivisibleBy7Matcher {
 public:
  using is_gtest_matcher = void;

  bool MatchAndExplain(int n, std::ostream* os) const {
    if (n % 7 == 0) return true;
    if (os) *os << "the remainder is " << (n % 7);
    return false;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by 7";
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by 7";
  }
};

::testing::Matcher<int> DivisibleBy7() {
  return DivisibleBy7Matcher();
}
```

Now you can use `DivisibleBy7()` like any other matcher.

### Monomorphic vs Polymorphic Matchers

- **Monomorphic** matcher: matches only one type.
- **Polymorphic** matcher: can match multiple types by templating `MatchAndExplain`.

#### Example: Polymorphic NotNull matcher

```cpp
class NotNullMatcher {
 public:
  using is_gtest_matcher = void;

  template <typename T>
  bool MatchAndExplain(T* p, std::ostream*) const {
    return p != nullptr;
  }

  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

NotNullMatcher NotNull() {
  return NotNullMatcher();
}
```

Then you can write `EXPECT_CALL(mock, Foo(NotNull()));` regardless of pointer type.

---

## Defining Custom Actions

Actions specify what a mock method does when called (e.g., return a value, modify args). GoogleMock has many built-in actions but you can define your own for unique behaviors.

### Using Lambdas, Functions, and Functors

The easiest custom actions are callable objects compatible with the mock method signature.

```cpp
EXPECT_CALL(mock, Func(_))
  .WillOnce([](int x) { return x * 2; });
```

Or, with a functor:

```cpp
struct MultiplyBy {
  int factor;
  int operator()(int x) const { return x * factor; }
};

EXPECT_CALL(mock, Func(_)).WillOnce(MultiplyBy{3});
```

### Using `Invoke()` for Existing Functions or Methods

You can use existing functions:

```cpp
int Add(int a, int b) { return a + b; }
EXPECT_CALL(mock, Sum(_, _)).WillOnce(Invoke(Add));
```

Or methods on objects:

```cpp
class Helper {
 public:
  bool Check(int x);
};
Helper helper;
EXPECT_CALL(mock, Validate(_)).WillOnce(Invoke(&helper, &Helper::Check));
```

### Defining New Action Classes

For more control, implement an action class following the GoogleMock `ActionInterface`:

```cpp
template <typename F>
class ActionInterface {
 public:
  virtual ~ActionInterface();
  virtual typename FunctionTraits<F>::ResultType
      Perform(const typename FunctionTraits<F>::ArgumentTuple& args) = 0;
};
```

You then wrap your class instance using `MakeAction()` to create a usable action.

### Using `ACTION` and `ACTION_P` Macros

Macros provide concise ways to define actions:

```cpp
ACTION(IncrementArg1) { return ++(*arg1); }

ACTION_P(Add, n) { return arg0 + n; }
```

Then in tests:

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg1());
EXPECT_CALL(mock, Foo(_)).WillOnce(Add(5));
```

### Composite Actions

Use `DoAll()` to execute multiple actions in sequence, returning the last action's result:

```cpp
EXPECT_CALL(mock, Foo(_))
  .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

---

## Practical Tips & Best Practices

### Write Pure, Side-Effect-Free Matchers
All matchers must be pure functions: no side effects, deterministic match results.

### Use Parameterized Matchers for Reusability
Enable matcher polymorphism by parameterizing matchers with external values.

### Prefer Macros for Simple Matchers, Classes for Complex Cases
For simple predicates, `MATCHER` macros offer succinct code with built-in support for pretty failure messages. For intricate matchers or those needing custom internal state, write matcher classes.

### Use `result_listener` in Matchers for Rich Diagnostics
Stream descriptive messages in match failures to guide users effectively.

### Leverage GoogleMock's Combinators
Combine matchers with `AllOf()`, `AnyOf()`, and `Not()`. Compose actions with `DoAll()`, `WithArgs()`, and others for flexible behaviors.

### Be Careful When Returning Move-Only Types in Actions
Return fresh instances on every call using lambdas or custom functors; do not use `Return(std::move(...))` more than once.

### Use `RetiresOnSaturation()` When Appropriate
Avoid sticky expectations causing confusing failures by retiring expectations after the maximum calls.

---

## Examples

### Custom Matcher Using `MATCHER`

```cpp
MATCHER(IsEven, "checks if number is even") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock, Foo(IsEven()));
```

### Parameterized Matcher

```cpp
MATCHER_P(GreaterThan, limit, "is greater than the limit") {
  return arg > limit;
}

EXPECT_THAT(value, GreaterThan(10));
```

### Custom Action with Lambda

```cpp
EXPECT_CALL(mock, Process(_))
  .WillOnce([](int x) { return x * 10; });
```

### Using Existing Function as Action

```cpp
int Double(int x) { return 2 * x; }
EXPECT_CALL(mock, Process(_)).WillOnce(Invoke(Double));
```

### Delegating to a Fake in Mock Class

```cpp
class FakeFoo : public Foo {
 public:
  int Bar(int n) override { return n * 2; }
};
class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Bar, (int), (override));

  void DelegateToFake() {
    ON_CALL(*this, Bar).WillByDefault([this](int n) {
      return fake_.Bar(n);
    });
  }
 private:
  FakeFoo fake_;
};

// Usage:
MockFoo mock;
mock.DelegateToFake();
EXPECT_CALL(mock, Bar(5));
EXPECT_EQ(mock.Bar(5), 10);
```

---

## Troubleshooting

### Matcher Does Not Compile
- Check that the matcher class or macro uses `using is_gtest_matcher = void;`.
- Ensure types used inside the matcher are compatible with the argument types.

### Unexpected Matcher Behavior
- Verify that matchers are pure with no side effects.
- Use `result_listener` to add diagnostic info.
- Use `--gmock_verbose=info` to trace matcher evaluation.

### Action Causes Compilation Errors
- Confirm callable signature matches mock function signature.
- For lambdas, parameters can be marked `Unused` if not needed.
- For move-only types, use lambdas or functors returning fresh instances.

### Too Many or Too Few Actions Warning
- Confirm your `EXPECT_CALL` actions and `.Times()` cardinality are aligned.
- Use `.RetiresOnSaturation()` when appropriate.

### Mocking Private or Overloaded Methods
- Always declare mock methods in `public:` section.
- Use `using Base::Method;` to expose unmocked overloads.

### Test Fails Due to Uninteresting Calls
- Add catch-all expectations `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` if these calls are expected but not important.
- Or use `NiceMock` to suppress warnings.

---

## Next Steps & Related Content

- [Creating and Using Mock Objects](../guides/mocking-techniques/creating-mocks.md)
- [Argument Matching and Advanced Matchers](../guides/mocking-techniques/argument-matching.md)
- [Setting Expectations and Actions](../guides/mocking-techniques/expectations-and-actions.md)
- [Nice, Naggy, and Strict Mocks](../guides/mocking-techniques/strictness-and-mock-behavior.md)
- [GoogleMock Cookbook](docs/gmock_cook_book.md)
- [Matchers Reference](docs/reference/matchers.md)
- [Actions Reference](docs/reference/actions.md)

---

## References

- GoogleMock official documentation on [Defining Custom Matchers](docs/gmock_cook_book.md#NewMatchers)
- GoogleMock [Matcher Macros and Interfaces](googlemock/include/gmock/gmock-matchers.h)
- GoogleMock [Custom Actions](docs/gmock_cook_book.md#NewMonoActions), [Generic Actions](docs/gmock_cook_book.md#NewPolyActions)


