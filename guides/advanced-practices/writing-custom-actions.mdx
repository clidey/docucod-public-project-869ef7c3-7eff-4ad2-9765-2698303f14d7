---
title: "Creating Custom Actions and Matchers"
description: "Learn how to define your own actions and matchers for advanced scenarios, extending GoogleMock's capabilities to better fit domain-specific requirements."
---

# Creating Custom Actions and Matchers

Extend the flexibility of GoogleMock by defining your own actions and matchers tailored to your specific domain. This guide walks you through how to create custom behaviors and argument validators, empowering you to write expressive tests for advanced scenarios.

---

## 1. Why Create Custom Actions and Matchers?

While GoogleMock provides a rich set of built-in actions and matchers, sometimes your testing needs demand more precise or complex behaviors:

- **Custom actions** allow you to specify exactly what should happen when a mock function is called, beyond the standard `Return()`, `Invoke()`, or `SetArgPointee()`.
- **Custom matchers** let you write tailored predicates that verify specialized properties of arguments, often encapsulating complex logic or domain-specific conditions.

Building these custom components enables:

- Reuse of common complex setups
- Enhanced test readability by abstracting details
- Better failure messages with targeted explanations

---

## 2. Defining Custom Actions

### Overview

An action defines what a mocked method does upon invocation. You can create custom actions either by writing callable objects or by using provided macros that simplify action creation.

### Step-by-Step Guide

<Steps>
<Step title="Use a Lambda or Callable">
If your custom action fits within a single expression or function call, simply use a lambda or a functor with a compatible call signature.

```cpp
EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce([](int arg) { return arg * 2; });
```

This is often the simplest and most direct approach.
</Step>
<Step title="Implement a Struct with Operator()">
For more reuse or stateful behavior, define a struct with an `operator()` matching the mock method signature.

```cpp
struct MultiplyBy {
  int factor;
  int operator()(int input) const { return input * factor; }
};

EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce(MultiplyBy{5});
```

Stateful actions keep their parameters nicely encapsulated.
</Step>
<Step title="Use ACTION and ACTION_P Macros for Parameterized Actions">
When you want the action definition to appear more concise or need parameterized actions, define actions with:

- `ACTION(name)` for simple actions
- `ACTION_P(name, param)` for single-parameter actions
- `ACTION_Pk(name, p1, ..., pk)` for multiple parameters

Example:

```cpp
ACTION_P(Add, n) {
  return arg0 + n;  // arg0 is the first argument of the mock method
}

EXPECT_CALL(mock_obj, SomeMethod(_))
    .WillOnce(Add(3));
```

Note: These macros must be declared at namespace scope, outside of other functions or classes.
</Step>
<Step title="Use ACTION_TEMPLATE for Template-based Actions">
For advanced use cases requiring explicit template parameters, use `ACTION_TEMPLATE`. This macro enables template parameters beyond the usual value parameters.

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

EXPECT_CALL(mock_obj, SomeMethod(_, _))
    .WillOnce(DuplicateArg<1, unsigned char>(&saved_value));
```
</Step>
</Steps>

### Best Practices

- Prefer lambdas or callable objects when possible for simplicity and clarity.
- Use `DoAll` to combine multiple actions if necessary (e.g., set an output argument and return a value).
- Avoid unnecessary complexity that might make test failures harder to interpret.

---

## 3. Defining Custom Matchers

### Overview

Matchers validate whether arguments passed to mocked methods meet your criteria. While GoogleMock includes many built-in matchers, you can define custom matchers to express domain-specific rules clearly.

### Ways to Create Custom Matchers

<AccordionGroup title="Custom Matcher Techniques">
<Accordion title="MATCHER Macros (Quickest Way)">
`MATCHER(name, description)` defines a simple matcher with an inline match condition.

Example:

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock_obj, SomeMethod(IsEven()));
```

You can also write detailed failure messages by using `result_listener`.
</Accordion>
<Accordion title="MATCHER_P and MATCHER_Pk Macros (Parameterized Matchers)">
Parameterized matchers take arguments to the matcher:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return (arg % divisor) == 0;
}

EXPECT_CALL(mock_obj, SomeMethod(IsDivisibleBy(3)));
```

Supports up to 10 parameters.
</Accordion>
<Accordion title="Implementing Matcher Classes">
For maximum control:

- Create a class with a `bool MatchAndExplain(const T& arg, std::ostream*) const` method.
- Implement `DescribeTo(std::ostream*)` and `DescribeNegationTo(std::ostream*)`.
- Provide a factory function returning `Matcher<T>`.

Example:

```cpp
class DivisibleByMatcher {
 public:
  explicit DivisibleByMatcher(int divisor) : divisor_(divisor) {}

  bool MatchAndExplain(int n, std::ostream* os) const {
    const int remainder = n % divisor_;
    if (remainder != 0 && os) *os << "remainder is " << remainder;
    return remainder == 0;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by " << divisor_;
  }
  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by " << divisor_;
  }

 private:
  int divisor_;
};

inline ::testing::Matcher<int> DivisibleBy(int divisor) {
  return MakeMatcher(new DivisibleByMatcher(divisor));
}

EXPECT_THAT(value, DivisibleBy(7));
```
</Accordion>
</AccordionGroup>

### Matcher Implementation Tips

- Matchers must be **pure functions**: no side effects or reliance on mutable external state.
- Use matcher descriptions liberally to aid test failure message clarity.
- Use `Matches()` and `EXPECT_THAT()` macros to apply custom matchers.

---

## 4. Practical Examples

### Example: Custom Action to Log and Return a Value

```cpp
ACTION_P(LogAndReturn, val) {
  std::cout << "Mock method called with value: " << arg0 << std::endl;
  return val;
}

EXPECT_CALL(mock_obj, Compute(_))
  .WillOnce(LogAndReturn(42));
```
This will print a message when the method is called and return 42.

### Example: Custom Matcher to Verify String Prefix

```cpp
MATCHER_P(StartsWith, prefix, "checks string prefix") {
  return arg.compare(0, prefix.size(), prefix) == 0;
}

EXPECT_CALL(mock_obj, Process(StartsWith("Hello")));
```

### Using Compose Matchers

You can combine or compose your custom matchers with built-in ones:

```cpp
using ::testing::AllOf;
using ::testing::Gt;

EXPECT_CALL(mock_obj, SomeMethod(AllOf(StartsWith("Test"), Gt(3))));
```

---

## 5. Troubleshooting and Tips

<AccordionGroup title="Common Issues When Creating Custom Actions and Matchers">
<Accordion title="Actions Not Being Called or Resulting Incorrectly">
- Ensure your callable signature matches your mock function.
- When using move-only types with `WillOnce()`, the action can only be invoked once.
- For multiple actions, use `DoAll()` to chain side effects.
</Accordion>
<Accordion title="Matchers Not Matching as Expected">
- Confirm your `MatchAndExplain` method implements correct logic.
- Write clear `DescribeTo` messages to aid in test diagnostics.
- Remember matchers must be pure - avoid side effects.
</Accordion>
<Accordion title="Unintended Over-Matching or Shadowed Expectations">
- Remember GoogleMock matches expectations in reverse order; later ones shadow earlier.
- Use specific matchers later to override general ones.
- Use sequences and `.InSequence()` to control call ordering where necessary.
</Accordion>
</AccordionGroup>

<Tip>
Use `--gmock_verbose=info` when running tests to gain detailed insight into matcher and action application during mock invocations. This can help diagnose unexpected behavior in custom implementations.
</Tip>

---

## 6. Next Steps and Related Content

- Explore the [Mocking with GoogleMock guide](/guides/core-workflows/mocking-with-gmock) to deepen your understanding of mocking techniques.
- Review the [Using Advanced Matchers guide](/guides/core-workflows/using-matchers) to learn about composing and using matchers more effectively.
- Consult the [Actions Reference](../actions.md) for all built-in actions you can combine with your custom ones.
- Use the [Mocking Reference](../mocking.md) for detailed syntax of macros and classes involved.

---

By mastering custom actions and matchers, you unlock GoogleMock's full power to tailor mock behaviors precisely to your domain, enhancing your testsâ€™ expressiveness, robustness, and maintainability.
