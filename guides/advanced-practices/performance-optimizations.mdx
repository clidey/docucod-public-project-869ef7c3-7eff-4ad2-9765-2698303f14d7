---
title: "Performance Optimization Tips"
description: "Best practices for writing high-performance unit tests with GoogleTest and GoogleMock. Learn about minimizing test runtime, isolating slow tests, and optimizing mock behavior for scalability."
---

# Performance Optimization Tips

## Overview
This guide helps you write high-performance unit tests using **GoogleTest** and **GoogleMock**. You will learn best practices to minimize test runtime, isolate slow tests, and optimize mock behavior for scalability—ensuring your test suite remains fast and maintainable even as it grows.

## Prerequisites
- Familiarity with writing unit tests using GoogleTest and GoogleMock.
- Your project should already have working tests with GoogleTest/GoogleMock.
- Basic understanding of mocks, expectations, and test fixtures.

## What You Will Achieve
- Faster and more efficient test execution.
- Better isolation of slow or expensive tests.
- Scalable mock configurations that reduce test maintenance overhead.
- Clear visibility into trade-offs and common pitfalls.

## Estimated Time
Approximately 15-30 minutes to review and apply these optimization strategies.

---

## Reducing Test Runtime

### 1. Minimize Per-Test Setup
- Use shared fixture setup (`SetUpTestSuite()`) instead of per-test setup (`SetUp()`) for expensive resource initialization.
- Avoid re-initializing costly resources (DB connections, large objects) in every test.

### 2. Split Slow Tests
- Identify slow tests via test timing reports or using `--gtest_print_time`.
- Split complex tests into smaller focused ones to run in parallel or selectively.
- Tag slow tests (e.g., `DISABLED_` prefix) or use test filters to exclude them during quick runs.

### 3. Control Test Ordering and Isolation
- Use `InSequence` and `Sequence` objects to create order-dependent test flows only when necessary.
- Prefer test independence to allow parallel execution.

<Tip>
Use test parallelism tools or CI features that run tests in parallel to leverage minimized tests.
</Tip>

## Optimizing Mock Behavior

### 1. Use `ON_CALL` vs. `EXPECT_CALL` Appropriately
- `ON_CALL` defines default behaviors without setting call expectations, reducing the overhead of unmet expectations.
- Reserve `EXPECT_CALL` for cases where call frequency and arguments matter.

### 2. Use `NiceMock` to Suppress Unnecessary Warnings
- If you have many mock calls for which you don’t care about invocation, wrap mock objects with `NiceMock` to suppress uninteresting call warnings.

### 3. Limit the Number of Mock Methods
- Mock only the interface methods relevant to the test to reduce compilation time and runtime overhead.

### 4. Leverage Delegation Patterns
- Delegate mock calls to real or fake objects via `ON_CALL(...).WillByDefault()` to reuse existing behavior and avoid duplication.

### 5. Avoid Over-Specification
- Don’t set granular expectations or strict call orders unless necessary, to reduce brittleness.

### Example: Efficient Use of ON_CALL and EXPECT_CALL
```cpp
class MockDatabase : public DatabaseInterface {
 public:
  MOCK_METHOD(bool, Connect, (), (override));
  MOCK_METHOD(std::string, Query, (const std::string&), (override));
};

void SetupDefaultMockBehavior(MockDatabase& mock_db) {
  ON_CALL(mock_db, Connect()).WillByDefault(Return(true));
  ON_CALL(mock_db, Query(_)).WillByDefault(Return("default result"));
}

TEST(FooTest, HandlesQuery) {
  MockDatabase mock_db;
  SetupDefaultMockBehavior(mock_db);

  EXPECT_CALL(mock_db, Query("SELECT * FROM table"));  // Only this is expected

  Foo foo(&mock_db);
  foo.DoQuery();
}
```

## Best Practices

- **Use meaningful test names and fixtures** to quickly identify wastes in the test suite.
- **Profile test runtime periodically** using `--gtest_print_time=1` to find expensive tests.
- **Isolate external dependencies** with mocks to enable fast and reliable tests.
- **Avoid large mocks with many strict expectations**, which cause slow compilation and brittle tests.
- **Reuse mocks and test data setups** across tests where possible.

## Common Pitfalls

- Overusing `EXPECT_CALL` instead of `ON_CALL`, leading to excessive verification overhead.
- Mocking entire big concrete classes unnecessarily, causing slow compilation.
- Neglecting parallelism by keeping tightly coupled or order-dependent tests.
- Ignoring test failures caused by slow death tests or heavyweight fixtures.

<Tip>
When dealing with death tests, be aware that they run in isolated subprocesses and may affect runtime performance. Consider separating them from fast unit tests.
</Tip>

## Troubleshooting

### Test Runtime Is Still Too Slow?
- Review if any shared resources are reinitialized per test.
- Check for large volume of unmocked external calls or I/O.
- Profile with `--gtest_benchmark_test` or use external tools.

### Unexpected Mock Call Failures
- Verify if you over-specified expectations.
- Consider switching to `NiceMock` or loosen call cardinalities.

### Compilation Bottlenecks
- Move mock class constructor and destructor definitions to `.cc` files to speed up compile times.
- Mock fewer types and methods.

## Next Steps & Further Reading
- Explore [Mocking with GoogleMock](https://google.github.io/googletest/gmock_cook_book.html) for advanced mock optimizations.
- Use [Installing and Setup Guide](https://google.github.io/googletest/installation.html) to ensure correct build configurations for performance.
- Learn about [Test Fixtures and Parameterized Tests](https://google.github.io/googletest/primer.html#value-parameterized-tests) to structure tests for scalability.
- Refer to [Integration with CI Pipelines](https://google.github.io/googletest/integration.html) to automate running optimized tests.

---

## References
- [GoogleTest Primer](https://google.github.io/googletest/primer.html)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [GoogleTest Assertions Reference](https://google.github.io/googletest/reference/assertions.html)
- [Mocking with GoogleMock](https://google.github.io/googletest/gmock_for_dummies.html)
- [Optimizing Build with CMake](https://github.com/google/googletest/blob/main/googletest/cmake/internal_utils.cmake)

---

## Summary
This page is dedicated to sharing practical, actionable performance optimization tips for GoogleTest and GoogleMock users. It walks you through strategies to reduce test runtime by minimizing setup, isolating slow tests, and improving mock usage. The guidance aims to keep your test suite scalable, maintainable, and fast, empowering you to write efficient unit tests without sacrificing clarity or robustness.
