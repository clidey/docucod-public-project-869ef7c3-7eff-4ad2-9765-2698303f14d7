---
title: "Extending GoogleTest and GoogleMock"
description: "Advanced guide to customizing assertions, matchers, and integrating with third-party test runners or tools. Suited for teams building test infrastructure or adopting advanced test analytics workflows."
---

# Extending GoogleTest and GoogleMock

Advanced guide to customizing assertions, matchers, and integrating with third-party test runners or tools. Suited for teams building test infrastructure or adopting advanced test analytics workflows.

---

## 1. Workflow Overview

### Task Description
This guide walks you through extending GoogleTest and GoogleMock beyond their standard use. You'll learn how to write custom matchers and actions, integrate GoogleMock with external test tools or runners, and apply advanced expectations for complex test scenarios. This is essential for teams building sophisticated test infrastructures or implementing advanced test analytics workflows.

### Prerequisites
- Familiarity with basic GoogleTest and GoogleMock usage.
- Experience writing mock classes using `MOCK_METHOD` macros.
- Basic understanding of expectations, matchers, and actions in GoogleMock.
- Access to your project's GoogleMock-enabled test environment.

### Expected Outcome
After completing this guide, you will be able to:
- Create custom matchers and actions tailored to your types and domain.
- Manipulate mock behaviors with fine-grained control.
- Integrate GoogleMock’s assertions with third-party test runners or analytics tools.
- Use advanced expectation ordering and sequencing to reflect complex interaction patterns.

### Time Estimate
Expect to spend 45–75 minutes applying and experimenting with the techniques.

### Difficulty Level
Advanced

---

## 2. Extending GoogleMock: Practical Techniques

### 2.1 Writing Custom Matchers

Custom matchers enable you to express validation logic specific to your domain, beyond the built-in set.

**How-To:**
1. Use the `MATCHER` family of macros for quick matcher creation:

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}
```

2. For parameterized matchers, use `MATCHER_P` or higher arities:

```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return abs(arg) == value;
}
```

3. For full control and reusability, implement a custom matcher class:

```cpp
class BarPlusBazEqMatcher {
 public:
  using is_gtest_matcher = void;
  explicit BarPlusBazEqMatcher(int expected_sum) : expected_sum_(expected_sum) {}

  bool MatchAndExplain(const Foo& foo, std::ostream*) const {
    return (foo.bar() + foo.baz()) == expected_sum_;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "bar() + baz() equals " << expected_sum_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "bar() + baz() does not equal " << expected_sum_;
  }

 private:
  const int expected_sum_;
};

::testing::Matcher<const Foo&> BarPlusBazEq(int expected_sum) {
  return BarPlusBazEqMatcher(expected_sum);
}
```

**Tips:**
- Stream additional context in `MatchAndExplain` for richer error messages.
- Ensure matchers are *pure* (no side effects) as required by GoogleMock.

### 2.2 Writing Custom Actions

Custom actions define the behavior of a mock method beyond simple returns.

**Approach:**
- Use lambdas or functor structs with a call operator matching the mock method signature.

Example using a lambda:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int x) { return x * 7; });
```

Example using a functor:

```cpp
struct MultiplyBy {
  int multiplier;
  template <typename T>
  T operator()(T arg) { return arg * multiplier; }
};
EXPECT_CALL(mock, Foo(_)).WillOnce(MultiplyBy{7});
```

- For polymorphic actions usable with multiple function signatures, define a class with a templated `Perform` method and wrap with `MakePolymorphicAction()`.

### 2.3 Integrating with Third-Party Test Runners and Tools

GoogleTest and GoogleMock output and hook into test execution flows that can be extended for integration:

- Use GoogleTest's listener API (`::testing::TestEventListener`) to capture detailed test and assertion events.
- Extend or wrap GoogleMock's failure reporting to feed analytics or custom dashboards.
- Leverage command-line flags (e.g., `--gmock_verbose=info`) to control the level of detail GoogleMock outputs for monitoring or logging.

**Steps to integrate:**
1. Create a custom listener subclass and register it via `::testing::UnitTest::GetInstance()->listeners().Append()`.
2. In the listener, catch mock failures and extract their detailed messages.
3. Forward captured data via callbacks or logging systems to your analytics tool.

### 2.4 Advanced Control Over Expectations

Explore how to refine test expectations with:

- **Ordering Control:** Use `InSequence` and `After` clauses to define strict and partial call orders.

```cpp
Sequence s;
EXPECT_CALL(mock, Foo()).InSequence(s);
EXPECT_CALL(mock, Bar()).InSequence(s).After(foo_expectation);
```

- **Saturation Behavior:** Use `.RetiresOnSaturation()` to make expectations retire after being met to avoid conflicts.

- **Multiple Expectations:** Define overlapping or layered expectations, knowing that later definitions override earlier ones unless constrained by sequences.

- **Default Actions with `ON_CALL`:** Use to set fallback behaviors without enforcing call expectations.

### 2.5 Delegating and Combining with Real Objects or Fakes

Sometimes, mocks need to delegate actual work to a real or fake implementation for part of their behavior.

Example delegation to a fake class:

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(char, DoThis, (int n), (override));
  MOCK_METHOD(void, DoThat, (const char* s, int* p), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault([this](int n) {
      return fake_.DoThis(n);
    });
    ON_CALL(*this, DoThat).WillByDefault([this](const char* s, int* p) {
      fake_.DoThat(s, p);
    });
  }

 private:
  FakeFoo fake_;
};
```

Invoke `DelegateToFake()` before setting expectations.

### 2.6 Handling Move-Only Types

GoogleMock supports mocking methods with move-only types (e.g., `std::unique_ptr`):

- Define mock methods with `MOCK_METHOD` as usual.
- Use lambdas for `WillOnce` or `WillRepeatedly` actions to produce or consume move-only types dynamically.

Example:

```cpp
MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
EXPECT_CALL(mock_buzzer_, MakeBuzz("hello"))
    .WillOnce([](StringPiece text) {
      return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

Avoid returning move-only types with `Return(std::move(...))` repeatedly, as the source is consumed after the first call.

---

## 3. Examples & Code Samples

### 3.1 Custom Matcher Example

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

TEST(FooTest, EvenMatcher) {
  MockFoo mock;
  EXPECT_CALL(mock, Process(IsEven()));
  mock.Process(4);  // Passes
  mock.Process(3);  // Fails
}
```

### 3.2 Delegate to Fake Implementation

```cpp
class FakeCalculator {
 public:
  int Add(int x, int y) { return x + y; }
};

class MockCalculator : public Calculator {
 public:
  MOCK_METHOD(int, Add, (int x, int y), (override));

  void DelegateToFake() {
    ON_CALL(*this, Add).WillByDefault([this](int x, int y) {
      return fake_.Add(x, y);
    });
  }

 private:
  FakeCalculator fake_;
};

TEST(CalculatorTest, DelegatesToFake) {
  MockCalculator mock;
  mock.DelegateToFake();
  EXPECT_EQ(mock.Add(2, 3), 5);
}
```

### 3.3 Custom Action for Logging

```cpp
struct LogAction {
  void operator()(const std::string& msg) {
    std::cout << "Log: " << msg << std::endl;
  }
};

EXPECT_CALL(mock_logger, Log(_))
    .WillOnce(LogAction());
```

### 3.4 Setting Ordered Expectations

```cpp
using ::testing::Sequence;
Sequence s;
EXPECT_CALL(mock, Start()).InSequence(s);
EXPECT_CALL(mock, Process(_)).InSequence(s);
EXPECT_CALL(mock, Finish()).InSequence(s);
```

---

## 4. Troubleshooting & Best Practices

### Common Issues

- **Uninteresting Call Warnings:** When a mock method is called without an expectation (`EXPECT_CALL`), you get warnings. Use `NiceMock` to suppress warnings, or explicitly add a catch-all expectation.

- **Wrong Matchers:** Ensure matchers match argument types. Use `SafeMatcherCast<T>()` to help with type conversions.

- **Overlapping Expectations Conflicts:** When multiple expectations match a call, GoogleMock uses the latest defined one. Be careful with ordering and use `RetiresOnSaturation()` to control activation.

- **Mocking Non-Virtual Methods:** Use template-based techniques or interface wrappers since only virtual functions can be mocked normally.

- **Slow Compilation:** Move mock class constructor/destructor definitions to a `.cc` file.

### Best Practices

- Define mocks in `public:` sections, regardless of base method visibility.
- Avoid mocking concrete classes; prefer coding to interfaces.
- Use `ON_CALL()` for default behaviors and `EXPECT_CALL()` for expectations.
- Use `InSequence` and `After` for control over call ordering.
- When writing custom matchers and actions, keep them pure and simple.

### Performance Considerations

- Keep expectations succinct to avoid complex matcher evaluation overhead.
- Minimize heavy use of lambdas with captures in test bodies.

### Alternative Approaches

- Delegate to fakes or real objects when mocking complex behavior to reuse code.
- Mock `std::function` with `MockFunction` for callback-heavy code.

---

## 5. Next Steps & Related Content

- Explore the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for recipes on mocking techniques.
- Read the [Matchers Reference](reference/matchers.md) to expand matcher capabilities.
- Consult the [Mocking Reference](docs/reference/mocking.md) for detailed API usage.
- For integrating GoogleMock with CI and test runners, see [Integrating with CI/CD Pipelines](/guides/integration-and-advanced/ci-integration).
- Learn about [Mock Object Behaviors & Strictness](/api-reference/gmock-mock-api/mock-object-behaviors-and-strictness) to control test sensitivity.

---

## Additional Resources
- GoogleMock repository: [https://github.com/google/googletest](https://github.com/google/googletest)
- gMock for Dummies: https://google.github.io/googletest/gmock_for_dummies.html
- gMock Cheat Sheet: https://google.github.io/googletest/gmock_cheat_sheet.html

---

For detailed macro syntax and advanced concepts on `MOCK_METHOD`, `EXPECT_CALL`, `ON_CALL`, consult the [Mocking Reference](docs/reference/mocking.md).

---