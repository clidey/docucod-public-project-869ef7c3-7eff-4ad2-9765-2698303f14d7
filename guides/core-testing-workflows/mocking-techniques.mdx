---
title: "Mocking Techniques and Patterns"
description: "A practical guide to defining mocks, setting expectations, and specifying mock behavior with GoogleMock. Explore `EXPECT_CALL`, `ON_CALL`, sequencing, cardinalities, and advanced usage patterns for improved test clarity and maintainability."
---

# Mocking Techniques and Patterns

This guide offers pragmatic instructions to help you master defining mocks, setting expectations, and specifying mock behavior effectively with GoogleMock in C++. By following these patterns, you will enhance your test clarity and maintainability.

---

## 1. Workflow Overview

### What You Will Learn
- How to define mock classes using `MOCK_METHOD`
- How to set expectations with `EXPECT_CALL` and behavior with `ON_CALL`
- How to control call cardinalities and order using sequences
- Using strictness modes: nice, naggy, and strict mocks
- Advanced mocking patterns for flexible and readable tests

### Prerequisites
- Familiarity with C++ and basic unit testing concepts
- GoogleTest and GoogleMock installed and configured
- Understanding of interfaces and virtual functions in C++

### Expected Outcomes
- Confident definition of mock classes
- Ability to customize mock behavior with expectations and default actions
- Control over invocation order and call frequency
- Know how to handle uninteresting calls and strictness modes

### Estimated Time
- Around 30-45 minutes for a thorough read and hands-on practice

### Difficulty Level
- Intermediate: some experience with C++ testing frameworks recommended

---

## 2. Defining Mocks and Setting Behavior

GoogleMock enables you to create mock classes for interfaces so you can precisely control and verify interactions in your tests.

### Defining a Mock Class

Use `MOCK_METHOD` in your mock class to mock virtual functions. For example:

```cpp
#include <gmock/gmock.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
  virtual bool Process(int elem, int count) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(bool, Process, (int elem, int count), (override));
};
```

**Tips:**
- Place `MOCK_METHOD` declarations in the `public:` section always.
- If a method is `const`, add `(const)` in the specs.
- For overloaded methods, mock all versions or use `using` to avoid hiding.

### Creating Nice, Naggy, or Strict Mocks

GoogleMock provides wrappers to control how uninteresting calls are handled:

```cpp
using ::testing::NiceMock;
using ::testing::NaggyMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_foo;      // Ignores uninteresting calls silently.
NaggyMock<MockFoo> naggy_foo;    // Warns on uninteresting calls (default behavior).
StrictMock<MockFoo> strict_foo;  // Errors on uninteresting calls.
```

Choose the strictness depending on your need. Use `NiceMock` for less noise and `StrictMock` to enforce strict interaction checks.

---

## 3. Using Mocks in Tests

This section describes setting expectations and defining mock behavior during tests.

### Typical Mock Usage Pattern

1. Create the mock object.
2. Optionally set default actions with `ON_CALL` to define behavior for calls without explicit expectations.
3. Set expectations with `EXPECT_CALL` to specify the exact calls you expect.
4. Exercise code interacting with the mock.
5. Let test framework verify that expectations were met automatically at mock destruction.

### Setting Default Actions with `ON_CALL`

`ON_CALL` defines the default behavior of the mock method when invoked but does **not** set an expectation:

```cpp
ON_CALL(mock_foo, GetSize())
    .WillByDefault(Return(10));
```

This means calls to `GetSize()` will return `10` unless overridden by a matching `EXPECT_CALL`.

### Setting Expectations with `EXPECT_CALL`

`EXPECT_CALL` sets an expectation about how your mock method will be called, and specifies the action for the call:

```cpp
EXPECT_CALL(mock_foo, GetSize())
    .Times(3)
    .WillRepeatedly(Return(5));
```

**Key modifier clauses:**
- `.Times(n)`: how many times the method should be called
- `.WillOnce(action)`: action for the next matching call
- `.WillRepeatedly(action)`: action for all subsequent matching calls
- `.InSequence(seq)`: specify call order with sequences
- `.After(expectation)`: specify call order relative to expectations
- `.With(matcher)`: restricts arguments matching as a whole tuple
- `.RetiresOnSaturation()`: deactivates expectation after it's saturated

**Important:**
- The last matching active expectation is used when multiple matches exist.
- `EXPECT_CALL` must be set before exercising the mock.

### Matching Arguments

Use matchers to specify expected arguments:

```cpp
EXPECT_CALL(mock_foo, Process(::testing::Lt(10), _));
```

Use `_` as a wildcard matcher to ignore an argument.

### Controlling Call Order with Sequences

To require calls in order:

```cpp
using ::testing::Sequence;
Sequence s;
EXPECT_CALL(mock_foo, DoThis()).InSequence(s);
EXPECT_CALL(mock_foo, DoThat()).InSequence(s);
```

Calls to `DoThis()` must occur before `DoThat()`.

Alternatively, use `InSequence` scoped object:

```cpp
{
  InSequence seq;
  EXPECT_CALL(...);
  EXPECT_CALL(...);
}
```

### Specifying Cardinality

Cardinalities specify *how many* times a mock method is expected to be called:

| Cardinality        | Meaning                          |
|--------------------|---------------------------------|
| `AnyNumber()`       | Any number of times              |
| `AtLeast(n)`        | At least n times                 |
| `AtMost(n)`         | At most n times                  |
| `Between(m,n)`      | Between m and n times inclusive  |
| `Exactly(n)` or n   | Exactly n times                  |

If omitted, GoogleMock will infer cardinality from `WillOnce` and `WillRepeatedly` calls.

---

## 4. Best Practices and Advanced Use

### Recommended Mock Usage Pattern

```cpp
TEST(MockUseTest, Basic) {
  MockFoo foo;                           // #1 Create mock

  ON_CALL(foo, GetSize()).WillByDefault(Return(1));  // #2 Default action

  EXPECT_CALL(foo, Describe(5))            // #3 Expect specific calls
      .Times(3)
      .WillRepeatedly(Return("Category 5"));

  auto result = MyProductionFunction(&foo); // #4 Exercise code

  EXPECT_EQ(result, "good");            // #5 Verify results
}                                       // #6 Automatic check on destruction
```

### Delegating Calls

If you have a fake or real implementation, you can delegate mock default actions:

```cpp
ON_CALL(mock, Method)
    .WillByDefault([this](Args... args) {
      return real_.Method(args...);
    });
```

### Returning References

Use `ReturnRef(variable)` instead of `Return(variable)` for reference types.

### Customizing Default Return Values

Use `DefaultValue<T>::Set(value)` and `DefaultValue<T>::Clear()` to globally set the default return value of type `T`.

### Controlling Strictness

Use `NiceMock`, `NaggyMock`, or `StrictMock` wrappers to manage verbosity and treatment of uninteresting calls appropriately.

### Setting Up Complex Call Expectations

* Use `.With()` to apply a tuple matcher for argument constraints involving multiple parameters.
* Use `.After()` to specify calls that should occur only after certain other calls.
* Use `.RetiresOnSaturation()` to remove expectations after their cardinality saturation.

### Handling Overloaded Methods

Disambiguate with `EXPECT_CALL(Const(mock), Method(args))` for const methods and use `using` to unhide base class overloads if not all are mocked.

---

## 5. Troubleshooting Common Issues

### Uninteresting Calls

*Definition:* Calls to mock methods without any `EXPECT_CALL` set.

*Default:* Generate warnings (naggy) but do not fail the test.

**Solution:**
- Use `NiceMock` to suppress warnings.
- Add a catch-all `EXPECT_CALL` with `.Times(AnyNumber())` if these calls are expected.

### Unexpected Calls

*Definition:* Calls that do not match any active `EXPECT_CALL`.

*Effect:* Fail the test immediately.

**Solution:**
- Check if you forgot to set expectations.
- Adjust argument matchers to broaden expected calls.

### Calls Made Out of Order

*Symptoms:* Failures triggered when expectations declared with sequences or `.After()` are violated.

**Solution:**
- Ensure calls follow the intended order.
- Use sequences carefully to represent call dependencies.

### Over-saturation Errors

*Symptoms:* Mock method called more times than specified cardinality.

**Solution:**
- Adjust `.Times()` or use `.RetiresOnSaturation()` to avoid sticky expectations.
- Use `.WillRepeatedly()` after `.WillOnce()` to define behavior beyond specified calls.

### Mock Object Leak Warnings

*Cause:* Mock objects are not deleted, so expectations never verified.

**Solution:**
- Delete mocks properly or use stack instances.
- Use `Mock::AllowLeak(&mock)` if intentional.

### Verbosity Control

Use `--gmock_verbose=info|warning|error` to control log verbosity of mock call reports and warnings.

---

## 6. Additional Resources

- [GoogleMock Cheat Sheet](../docs/gmock_cheat_sheet.md): Quick references for macros and common idioms
- [Mocking Reference](../docs/reference/mocking.md): Detailed documentation of all mocking facilities
- [gMock for Dummies](../docs/gmock_for_dummies.md): Beginner-friendly conceptual guide
- [gMock Cookbook](../docs/gmock_cook_book.md): Extensive recipes and advanced mocking patterns
- [Mock Object Strictness Modes](../guides/advanced-and-integrations/mock-object-strictness.mdx): How to use nice, naggy, strict mocks

---

For comprehensive onboarding, start with this guide and then explore the conceptual and reference guides for deeper understanding of GoogleMock's powerful capabilities. Properly using mocks will empower you to write robust, clear, and maintainable unit tests.
