---
title: "Test Doubles with GoogleMock"
description: "Leverage GoogleMock to create mock objects, define expected interactions, and verify behaviors in isolation. Covers core usage of MOCK_METHOD, basic expectations (EXPECT_CALL), and typical use cases in C++ workflows."
---

# Test Doubles with GoogleMock

## Overview

This guide helps you leverage GoogleMock to create mock objects that simulate the behavior of real objects in your C++ tests. It covers how to define mocks using `MOCK_METHOD`, set expectations using `EXPECT_CALL`, and specify default behaviors with `ON_CALL`. You'll learn how to control interaction verification, handle argument matching, and configure mock behavior to isolate and validate your system's components effectively.

### Prerequisites
- Basic understanding of C++ and unit testing concepts.
- GoogleTest and GoogleMock installed and set up in your project.
- A mock class created using `MOCK_METHOD` macros (see the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html#creating-mock-classes) for details).

### Expected Outcome
By following this guide, you will be able to:
- Define mock methods with correct signatures.
- Set precise call expectations and control how mock methods behave.
- Use sequences and ordering constraints to specify call order.
- Handle default mock behaviors and differentiate between expectations and default actions.

### Time Estimate
Approximately 15-30 minutes depending on familiarity with mocking concepts.

### Difficulty Level
Intermediate – Familiarity with C++ mocking concepts is recommended.

---

## Step-by-Step Instructions

### 1. Define Mock Classes Using `MOCK_METHOD`

- Use the `MOCK_METHOD` macro inside your mock class to generate mock methods that correspond to virtual methods in interfaces or base classes.

```cpp
class MockFoo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, SetValue, (int x), (override));
};
```

- Place all `MOCK_METHOD` declarations in the `public:` section, regardless of the visibility of the original methods.
- Include necessary qualifiers such as `(const, override)` for overriding `const` methods.

> **Tip:** To mock methods with complex return types or arguments containing commas, wrap the types in parentheses or use type aliases to avoid parsing errors.

### 2. Set Default Behaviors with `ON_CALL`

- Use `ON_CALL` to define the default behavior of mock methods without imposing call expectations.

```cpp
ON_CALL(mock_foo, GetSize()).WillByDefault(Return(42));
```

- `.With()` can be used optionally after `ON_CALL` to match arguments as a tuple.
- `ON_CALL` statements generally go in the test fixture setup or mock constructor.

> **Best Practice:** Use `ON_CALL` for behavior you don't want to verify strictly, and reserve `EXPECT_CALL` for interactions you want to confirm explicitly.

### 3. Specify Expectations with `EXPECT_CALL`

- Use `EXPECT_CALL` to set expectations for specific method calls, argument matchers, and call counts.

```cpp
EXPECT_CALL(mock_foo, SetValue(10))
    .Times(1)
    .WillOnce(Return());
```

- You can omit argument matchers for non-overloaded methods to match any arguments.
- Chain clauses in the following order:
  - `.With()` – for multi-argument tuple matching (must be first if used).
  - `.Times()` – specify how many times the call is expected.
  - `.InSequence()` – add this expectation to one or more sequences.
  - `.After()` – specify that this call should happen after other expectations.
  - `.WillOnce()` – specify action for one-time invocation(s).
  - `.WillRepeatedly()` – specify action for subsequent invocations.
  - `.RetiresOnSaturation()` – retire expectation automatically once saturated.

> **Tip:** If you only use `WillOnce()`, the inferred `.Times()` is the number of `WillOnce()` calls. Otherwise, the inferred `.Times()` covers calls accordingly.

### 4. Control Call Order with Sequences

- Use `Sequence` objects to enforce call ordering.

```cpp
Sequence s1, s2;
EXPECT_CALL(mock_foo, Init()).InSequence(s1, s2);
EXPECT_CALL(mock_foo, Start()).InSequence(s1);
EXPECT_CALL(mock_foo, Stop()).InSequence(s2);
```

- You can also create an anonymous sequence using `InSequence` object for scoping:

```cpp
{
  InSequence seq;
  EXPECT_CALL(mock_foo, FirstCall());
  EXPECT_CALL(mock_foo, SecondCall());
}
```

### 5. Define Expectations for Partial Orders Using `.After()`

- When call sequences are complex or partial, use `.After()`:

```cpp
Expectation init = EXPECT_CALL(mock_foo, Init());
EXPECT_CALL(mock_foo, Start()).After(init);
```

- You can pass multiple `Expectation` or `ExpectationSet` objects to `.After()`. It ensures that all prerequisites were satisfied before matching this call.

### 6. Use Matchers to Specify Argument Expectations

- Match arguments in `EXPECT_CALL` or `ON_CALL` with built-in matchers or custom ones.
- Use underscore `_` to match any value.
- Combine matchers to form conditions (e.g., `AllOf()`, `Not()`, `Pointee()`).

```cpp
EXPECT_CALL(mock_foo, SetValue(Ge(0)));  // Args >= 0
EXPECT_CALL(mock_foo, Process(_));       // Any argument
```

- Use `.With()` to match all args as a tuple, allowing constraints across multiple arguments.

### 7. Specify the Behavior with Actions

- Use actions such as `Return()`, `ReturnRef()`, `Invoke()`, `DoAll()`, and `SetArgPointee()` inside `.WillOnce()` or `.WillRepeatedly()` clauses.

```cpp
EXPECT_CALL(mock_foo, Compute())
    .WillOnce(Return(5))
    .WillRepeatedly(Return(10));

EXPECT_CALL(mock_foo, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return()));
```

- Actions can be lambdas or functors as long as they match the method signature.

### 8. Verify and Reset Mocks Explicitly (Optional)

- Mocks are automatically verified when destructed.
- To verify earlier, call:

```cpp
bool success = Mock::VerifyAndClearExpectations(&mock_obj);
```

- To reset expectations and default actions:

```cpp
bool success = Mock::VerifyAndClear(&mock_obj);
```

> **Tip:** Do not set new expectations after verifying and clearing a mock.

---

## Examples

### Defining a Mock Class

```cpp
#include <gmock/gmock.h>

class MockDatabase {
 public:
  MOCK_METHOD(bool, Connect, (const std::string& url), (override));
  MOCK_METHOD(int, GetRecordCount, (), (const, override));
  MOCK_METHOD(void, Close, (), (override));
};
```

### Setting Expectations and Default Actions

```cpp
using ::testing::Return;
using ::testing::_;

TEST(DatabaseTest, ConnectAndQuery) {
  MockDatabase mock_db;

  // Default behavior when no expectation is set
  ON_CALL(mock_db, GetRecordCount()).WillByDefault(Return(10));

  // Expect Connect to be called once with specific argument
  EXPECT_CALL(mock_db, Connect("db://localhost"))
      .Times(1)
      .WillOnce(Return(true));

  // Expect GetRecordCount to be called at least once
  EXPECT_CALL(mock_db, GetRecordCount())
      .Times(testing::AtLeast(1));

  // Use mock
  ASSERT_TRUE(mock_db.Connect("db://localhost"));
  int count = mock_db.GetRecordCount();
  EXPECT_EQ(count, 10);
}
```

### Specifying Call Order

```cpp
Sequence seq;
EXPECT_CALL(mock_db, Connect(_)).InSequence(seq);
EXPECT_CALL(mock_db, GetRecordCount()).InSequence(seq);
EXPECT_CALL(mock_db, Close()).InSequence(seq);
```

### Using `.After()` for Partial Ordering

```cpp
Expectation connect_expectation = EXPECT_CALL(mock_db, Connect(_));
EXPECT_CALL(mock_db, GetRecordCount()).After(connect_expectation);
```

---

## Troubleshooting & Tips

### Common Issues
- **Unexpected calls:** You get errors if a mock method is called without matching any `EXPECT_CALL.` Verify your expectations cover all calls you intend to allow.

- **Overloaded methods:** When mocking overloaded methods, ensure you specify argument types fully.

- **Uninteresting call warnings:** If you get 'uninteresting call' warnings, consider using `NiceMock` or adding catch-all `EXPECT_CALL` with `Times(AnyNumber())`.

- **Compilation errors with commas in types:** Wrap types with commas in parentheses or use type aliases.

### Best Practices
- Use `ON_CALL` for default behaviors that should not fail the test if called zero or more times.
- Use `EXPECT_CALL` only when you want to assert a call happens.
- Group expectations that must happen in order inside an `InSequence` scope.
- Use `.RetiresOnSaturation()` to prevent sticky expectations causing unexpected failures.
- Suppress uninteresting call warnings for methods you don't want to explicitly expect by using `NiceMock`.

### Performance Considerations
- Move mock class constructors and destructors to `.cc` files to speed up compilation.

- Avoid over-using strict or naggy mocks; prefer `NiceMock` for maintainability.

### Alternative Approaches
- Use `MockFunction` to mock standalone functors or `std::function` types.
- Delegate calls to an existing fake or real object for more realistic behaviors.

---

## Next Steps & Related Content

- Explore [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for advanced usage patterns.
- Review the [Using Assertions and Matchers](../core-testing-workflows/using-assertions-and-matchers) guide to validate arguments.
- Read about [Effective Mock Behaviors](../core-testing-workflows/effective-mock-behaviors) for best practices on defining mock actions.
- Learn about [Test Discovery and Organization](../getting-started/test-discovery-and-organization) to manage your tests efficiently.

---

For full API details, reference the [Mocking API](../../api-reference/gmock-apis/mocking-api.md).

<Info>
Remember: `EXPECT_CALL` and `ON_CALL` macros include file and line information to help with debugging. Always specify expectations before exercising the code under test to avoid undefined behavior.
</Info>
