---
title: "Using Matchers and Actions"
description: "Practical guidance for leveraging built-in and custom matchers to express flexible expectations, and for using actions to control mock behaviors in tests."
---

# Using Matchers and Actions

Leverage GoogleMock's expressive matchers and powerful actions to flexibly define mock expectations and control mock behaviors in tests. This guide walks you through using built-in and custom matchers to specify argument patterns, and actions to dictate mock method behaviors upon invocation.

---

## Workflow Overview

- **Task Description**: Learn how to use matchers to express flexible expectations on mock method arguments and actions to define what mocks should do when called.
- **Prerequisites**: Basic familiarity with GoogleMock, having mock classes defined using `MOCK_METHOD`, understanding of `EXPECT_CALL` and `ON_CALL` usage.
- **Expected Outcome**: You will be able to write precise and maintainable expectations with matchers and specify custom mock behaviors with actions for robust unit tests.
- **Time Estimate**: 20-30 minutes to digest and practice the concepts.
- **Difficulty Level**: Intermediate

---

## 1. Understanding Matchers: What Arguments Do We Expect?

Matchers allow you to specify constraints on mock method arguments within `EXPECT_CALL` or `ON_CALL`. They answer the question: "Does this argument match a certain condition?" Here's how to use them effectively:

### 1.1. Exact and Wildcard Matching

- Specify exact argument values to expect:
  ```cpp
  EXPECT_CALL(mock, Foo(10));  // Argument must be exactly 10
  ```

- Use the wildcard `_` matcher to accept any value for an argument:
  ```cpp
  using ::testing::_;

  EXPECT_CALL(mock, Foo(_));  // Accepts any argument
  ```

### 1.2. Built-in Matchers for Conditions

Use built-in matchers like `Ge()`, `Le()`, `NotNull()`, `HasSubstr()`, etc., to express more complex conditions:

```cpp
using ::testing::Ge;
using ::testing::NotNull;
using ::testing::HasSubstr;

EXPECT_CALL(mock, ProcessValue(Ge(100))); // Argument >= 100
EXPECT_CALL(mock, SaveData(NotNull()));    // Pointer argument not null
EXPECT_CALL(mock, PrintMessage(HasSubstr("error"))); // String contains "error"
```

### 1.3. Combining Matchers

Combine matchers with `AllOf()`, `AnyOf()`, and `Not()` for complex conditions:

```cpp
using ::testing::AllOf;
using ::testing::Not;

EXPECT_CALL(mock, Bar(AllOf(Ge(10), Not(Le(15))))); // arg > 10 and arg > 15
```

### 1.4. Matching Multiple Arguments Together

- Use `.With()` in `EXPECT_CALL()` or `ON_CALL()` to match the complete set of arguments as a tuple:
  ```cpp
  EXPECT_CALL(mock, SetRange(_, _))
      .With(::testing::Lt());  // First arg less than second arg
  ```
- For partial multi-argument matching, use `Args<>` or `AllArgs()`.

### 1.5. Selecting Overloads & Const Methods

For overloaded methods or const-qualified methods, use `Const()` and explicit matcher casts to disambiguate:

```cpp
EXPECT_CALL(mock, OverloadedMethod(10));           // Non-const
EXPECT_CALL(::testing::Const(mock), OverloadedMethod(10));  // Const

using ::testing::An;
EXPECT_CALL(mock, Print(An<int>()));  // Match Print(int)
```

---

## 2. Using Custom and Complex Matchers

### 2.1. Defining Custom Matchers

Use `MATCHER` and `MATCHER_P` macros to create expressive custom matchers:

```cpp
MATCHER(IsDivisibleBy7, "Checks divisibility by 7") {
  return (arg % 7) == 0;
}

EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

### 2.2. Matching Object Members

Use `Field()` and `Property()` to match fields or return values of getters inside argument objects:

```cpp
EXPECT_CALL(mock, UpdateFoo(Field(&Foo::value, Ge(10))));
EXPECT_CALL(mock, UpdateFoo(Property(&Foo::GetValue, Eq(42))));
```

### 2.3. Matching Pointer Arguments

- Use `Pointee()` to match values pointed to by pointers or smart pointers:

```cpp
EXPECT_CALL(mock, Process(Pointee(Ge(5))));
```

- Automatically fails matching if the pointer is `nullptr`.

---

## 3. Controlling Number of Calls: Cardinalities

- Use `.Times()` to indicate expected number of calls:
  - `Times(1)`, `Times(AnyNumber())`, `Times(AtLeast(n))`, etc.
- If omitted, GoogleMock infers cardinalities based on `.WillOnce()` and `.WillRepeatedly()` clauses.
- To forbid calls, use `Times(0)`.

Example:
```cpp
EXPECT_CALL(mock, Foo(5))
    .Times(3)
    .WillRepeatedly(Return(true));
```

---

## 4. Actions: What Should the Mock Do?

Actions specify the behavior of mock methods when invoked. You select them via `WillOnce()`, `WillRepeatedly()`, or `WillByDefault()`.

### 4.1. Built-in Actions

Some common actions:

| Action             | Description                                         |
|--------------------|-----------------------------------------------------|
| `Return(value)`    | Return a value immediately.                         |
| `ReturnRef(variable)` | Return a reference to a variable.                  |
| `ReturnPointee(pointer)` | Returns value pointed by a pointer, evaluated on each call. |
| `Invoke(function)`  | Call a function, lambda, method, or functor.       |
| `DoAll(a1, a2, ..)`| Perform multiple actions in sequence, returning last result. |
| `SetArgPointee<N>(value)` | Set the output pointed to by the N-th argument to the given value. |
| `InvokeArgument<N>(args...)`| Invoke the N-th argument (a callable) with arguments provided. |
| `Throw(exception)`  | Throw an exception when the mock method is called. |

Example:
```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42));

EXPECT_CALL(mock, Process(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(100), Return(true)));
```

### 4.2. Using Lambdas and Callables

Provide your own function, lambda, or functor for precise behavior:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int n) { return n * 2; });
```

### 4.3. Sequencing Actions

Multiple actions in sequence can be specified with multiple `WillOnce()` calls followed by an optional `WillRepeatedly()`:

```cpp
EXPECT_CALL(mock, GetX())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### 4.4. Avoiding Common Pitfalls

- Evaluate side-effecting expressions outside the `Return()` call to avoid capturing wrong values.
- Use `ReturnPointee()` instead of `Return(std::ref())` if you want current values.
- Use `.RetiresOnSaturation()` if you want an expectation to become inactive after matching the expected number of calls.

---

## 5. Practical Examples

### 5.1. Using Matchers in `EXPECT_CALL`

```cpp
using ::testing::_;            // Wildcard matcher
using ::testing::Ge;           // Greater or equal matcher

class MockFoo {
 public:
  MOCK_METHOD(void, Process, (int x, int y), (override));
};

MockFoo mock;

// Expect Process() to be called with first argument >= 100
EXPECT_CALL(mock, Process(Ge(100), _));  

// Run code under test that calls mock.Process
```

### 5.2. Defining Custom Matcher

```cpp
MATCHER(IsEven, "Checks if a number is even") {
  return arg % 2 == 0;
}
EXPECT_CALL(mock, Process(IsEven()));
```

### 5.3. Setting Action with Lambda

```cpp
EXPECT_CALL(mock, GetData())
    .WillOnce([]() { return std::vector<int>{1, 2, 3}; });
```

### 5.4. Combining Actions with Side Effects

```cpp
using ::testing::DoAll;
using ::testing::SetArgPointee;
using ::testing::Return;

EXPECT_CALL(mock, Compute(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

---

## 6. Troubleshooting & Best Practices

### 6.1. Common Issues

- **Expectations not met**: Confirm `EXPECT_CALL` is declared before exercising mocks.
- **Over-strict matching**: Avoid over-specifying matchers; use `_` for arguments you don't care about.
- **Action evaluation pitfalls**: Actions like `Return(n++)` are evaluated once; use lambdas for dynamic behavior.

### 6.2. Best Practices

- Use `ON_CALL` to provide default mock behaviors without setting call count expectations.
- Use `EXPECT_CALL` only when you want to verify actual calls.
- Order expectations from general (catch-all) to more specific, since GoogleMock matches newest expectations first.
- Use `.RetiresOnSaturation()` to prevent expectations from blocking other matching calls after saturation.
- Utilize sequences (`InSequence`) to test call order where needed.

---

## 7. Next Steps & Related Content

- Explore [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) to learn available built-in matchers.
- Review [Actions Reference](https://google.github.io/googletest/reference/actions.html) for all action types.
- Study [Mocking and Setting Expectations](https://google.github.io/googletest/guides/core-testing-workflows/mocking-and-expectations.html) for a deeper understanding.
- Learn [Defining Custom Actions and Matchers](https://google.github.io/googletest/guides/advanced-usage-and-optimization/using-actions-and-custom-behaviors.html) for advanced testing needs.

---

## References

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [Actions Reference](https://google.github.io/googletest/reference/actions.html)