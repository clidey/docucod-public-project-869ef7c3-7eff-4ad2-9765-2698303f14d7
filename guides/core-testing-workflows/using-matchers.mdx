---
title: "Using Matchers for Flexible Validation"
description: "Learn to use matchers in GoogleTest and GoogleMock to write expressive and robust tests. Covers built-in matchers, composite matchers, and extending with custom matchers for advanced scenarios."
---

# Using Matchers for Flexible Validation

## Overview

This guide teaches you how to use matchers in GoogleTest and GoogleMock to write expressive, flexible, and robust tests. Matchers provide a powerful way to specify what arguments you expect in mock method calls or assertions beyond simple equality, allowing validation of a wide range of conditions, from simple comparisons to complex predicates.

You'll learn how to use built-in matchers, combine them into composite matchers, and define your own custom matchers for advanced verification scenarios.

---

## 1. Understanding Matchers

Matchers are predicates that validate a single argument or a set of arguments. They can be used in mock method expectations (`EXPECT_CALL`) or assertions (`EXPECT_THAT` and `ASSERT_THAT`) to verify the behavior of code under test.

Unlike writing manual comparison code, matchers make your tests more readable, maintainable, and provide descriptive failure messages.

### Prerequisites

- Familiarity with basic GoogleTest assertions like `EXPECT_EQ`.
- Basic understanding of mock objects and mocking in gMock.

### Expected Outcome

You will be able to express complex argument validation succinctly and readably in your tests, catch subtle bugs, and write clear test failure messages.

---

## 2. Using Built-in Matchers

GoogleTest and GoogleMock provide an extensive set of built-in matchers covering common validation needs.

### Wildcard Matchers

- `_` — matches any value of the correct type.
- `A<T>()` or `An<T>()` — matches any value of type `T`.

### Generic Comparison Matchers

- `Eq(value)` or just `value` — checks `argument == value`.
- `Ge(value)` — `argument >= value`.
- `Gt(value)` — `argument > value`.
- `Le(value)` — `argument <= value`.
- `Lt(value)` — `argument < value`.
- `Ne(value)` — `argument != value`.

### Pointer and Nullability Matchers

- `IsNull()` — matches null pointers.
- `NotNull()` — matches non-null pointers.
- `Pointee(matcher)` — matches if pointer points to a value matching `matcher`.

### String Matchers

Matchers work with C strings and std::string objects:

- `StartsWith(prefix)` — argument starts with `prefix`.
- `EndsWith(suffix)` — argument ends with `suffix`.
- `HasSubstr(substring)` — argument contains `substring`.
- `StrEq(string)` — argument equals string.
- `StrNe(string)` — argument does not equal string.
- `StrCaseEq(string)` — argument equals string ignoring case.

### Floating-point Approximate Matchers

- `DoubleEq(value)` and `FloatEq(value)` — match approximately equal floats/doubles.
- `DoubleNear(value, abs_error)` and `FloatNear(value, abs_error)` — match within absolute error.

### Exception Handling Matchers

- `Throws<E>()` — matches a callable that throws an exception of type `E`.
- `Throws<E>(matcher)` — matches callable throwing exception of type `E` that satisfies `matcher`.
- `ThrowsMessage<E>(matcher)` — matches callable throwing exception `E` with a message matching `matcher`.

---

## 3. Composite Matchers

Matchers can be combined to create more sophisticated validations.

- `AllOf(m1, m2, ...)` — all matchers must match.
- `AnyOf(m1, m2, ...)` — at least one matcher must match.
- `Not(m)` — negates matcher `m`.

For example, requiring a value to be greater than zero and less than 10:

```cpp
EXPECT_THAT(value, AllOf(Gt(0), Lt(10)));
```

You can also compose matchers on container elements:

- `ElementsAre(e0, e1, ..., en)` — container elements must match specified matchers in order.
- `UnorderedElementsAre(e0, e1, ..., en)` — container contains elements matching the given matchers in any order.
- `Each(m)` — every element in the container matches `m`.
- `Contains(m)` — container contains at least one element matching `m`.

### Example: Matching a Vector of Numbers

```cpp
EXPECT_CALL(mock, ProcessValues(ElementsAre(1, Gt(10), _)));
```

This expects `ProcessValues` to be called with a container where:
- First element == 1
- Second element > 10
- Third element can be anything

---

## 4. Matcher Adapters for Member and Object Properties

Matchers support inspecting nested properties or members:

- `Field(&Class::member, matcher)` — matches objects whose `member` matches `matcher`.
- `Property(&Class::property, matcher)` — matches objects for which the accessor `property()` returns a value that matches `matcher`.
- `Key(m)` — on pairs/maps, matches `first` element with matcher `m`.
- `Pair(m1, m2)` — matches pair objects whose first and second elements satisfy `m1` and `m2` respectively.

### Example

```cpp
EXPECT_THAT(obj, Field(&MyClass::id, Ge(5)));
EXPECT_THAT(map_obj, Contains(Key(Eq("foo"))));
```

---

## 5. Defining Custom Matchers

If the built-in matchers don't meet your needs, you can write custom matchers using `MATCHER` or `MATCHER_P` macros.

### Basic Custom Matcher

```cpp
MATCHER(IsEven, "is an even number") {
  return (arg % 2) == 0;
}

EXPECT_THAT(value, IsEven());
```

If the matcher fails, you get clear failure messages like:

```
Value of: value
Expected: is an even number
  Actual: 7
```

### Parameterized Custom Matcher

```cpp
MATCHER_P(IsDivisibleBy, divisor, "is divisible by " + std::to_string(divisor)) {
  return (arg % divisor) == 0;
}
EXPECT_THAT(value, IsDivisibleBy(3));
```

Custom matchers can also explain failure reasons with more detail by streaming explanations to `*result_listener` inside the matcher body.

---

## 6. Practical Examples

### Example 1: Matching Function Argument Exactly

```cpp
EXPECT_CALL(mock_obj, DoSomething(Eq(5)));
```

Automatically fails if `DoSomething` is called with any argument other than 5.

### Example 2: Matching a String That Starts with "Hello"

```cpp
EXPECT_THAT(greeting, StartsWith("Hello"));
```

### Example 3: Verifying a Method Called with a Container where All Elements Are Positive

```cpp
EXPECT_CALL(mock, ProcessNumbers(Each(Gt(0))));
```

### Example 4: Using Composite Matchers

Verify `value` is within the closed range 10 to 20, but not equal to 15.

```cpp
using ::testing::AllOf;
using ::testing::Ge;
using ::testing::Le;
using ::testing::Ne;
EXPECT_THAT(value, AllOf(Ge(10), Le(20), Ne(15)));
```

---

## 7. Best Practices and Tips

- Prefer explicit matchers such as `Eq(value)` rather than relying on implicit conversions that may cause unintended matches.
- Use `_` matcher for arguments you don’t care to verify to avoid brittle tests.
- When matching containers, be mindful of order-sensitive matchers (`ElementsAre`) versus order-insensitive (`UnorderedElementsAre`).
- Use `With` in `EXPECT_CALL` or `ON_CALL` to express complex multi-argument constraints on the full argument tuple.
- Avoid over-specification of matchers to keep tests maintainable and robust to implementation changes.
- Leverage custom matchers to encapsulate complex validation logic and improve test readability.

---

## 8. Troubleshooting Matchers

### Common Issues

- **Implicit conversion pitfalls:** Using `EXPECT_THAT(actual, expected_value)` may compile but cause unexpected behavior due to implicit conversions. Use `EXPECT_THAT(actual, Eq(expected_value))` instead.

- **Ambiguous matcher overloads:** If mocking overloaded methods, disambiguate by specifying the exact matcher type or use wrapper helpers like `Const()`.

- **Matcher purity requirement:** Matchers must be purely functional and side-effect free. Avoid using mock methods or stateful objects inside matcher evaluation.

- **Type mismatches:** Use `SafeMatcherCast<T>(m)` to cast matchers safely when argument types differ but are convertible.

### Verification

Always verify matcher logic with small unit test cases to ensure they correctly accept and reject intended values and produce helpful failure messages.

---

## 9. Next Steps

- Explore more complex mocking scenarios using matchers along with actions in the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html).
- Learn about writing effective test assertions combining matchers in [Assertions Reference](reference/assertions.md).
- Practice defining custom matchers to tailor validation to your domain.
- Dive into the [Matchers Reference](reference/matchers.md) for the full list of built-in matchers.

---

## Additional Resources

- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Matchers Reference](reference/matchers.md)
- [Mocking Reference](reference/mocking.md)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Testing with gMock Guide](guides/getting-started/first-mock-example.mdx)

---

## Summary

Use matchers to write expressive expectations that capture precisely the behaviors you want to verify. Leverage built-in matchers for common data types, compose matchers for complex conditions, and create custom matchers when necessary to maintain clear and concise test code. This makes your tests more resilient, easier to read, and provides rich failure information.

---

# Callouts & Tips

<Tip>
Prefer explicit matchers like `Eq(value)` over implicit equality checks to avoid surprises due to conversions.
</Tip>

<Tip>
Use composite matchers (`AllOf`, `AnyOf`, `Not`) to express complex argument conditions clearly.
</Tip>

<Warning>
Matchers must be pure functions without side effects. Do not call mock methods or alter external states inside matchers.
</Warning>

## Code Example Highlight

```cpp
// Expect a method called with a vector containing exactly 3 elements:
// first equal to 1, second greater than zero, and third is anything.
EXPECT_CALL(mock_obj, ProcessVector(ElementsAre(1, Gt(0), _)));

// Custom matcher to check if a number is even.
MATCHER(IsEven, "is an even number") {
  return (arg % 2) == 0;
}
EXPECT_THAT(value, IsEven());
```

---