---
title: "Mocking Dependencies with GoogleMock"
description: "Step-by-step instructions for defining mock classes, using the MOCK_METHOD macro, setting call expectations, and employing matchers and actions to control mock behavior. Includes typical usage patterns and common pitfalls."
---

# Mocking Dependencies with GoogleMock

Step-by-step instructions for defining mock classes, using the `MOCK_METHOD` macro, setting call expectations, and employing matchers and actions to control mock behavior. Includes typical usage patterns and common pitfalls.

---

## 1. Introduction

GoogleMock (gMock) is a powerful framework integrated with GoogleTest that allows you to create mock objects in C++. This page focuses specifically on mocking dependencies in your unit tests by defining mock classes and controlling their behavior and expectations using the macros and functions provided by GoogleMock.

By mastering this page, you will be able to define mocks for your dependencies, specify how they will be called, and dictate their responses to help isolate and thoroughly test your code.

---

## 2. Prerequisites

- You should have a basic understanding of GoogleTest and unit testing in C++.
- GoogleMock should be installed and configured in your project. For installation instructions, see the [Installation and Setup guide](/guides/getting-started/installation-setup).
- Familiarity with C++ virtual functions and basic inheritance concepts will help.

---

## 3. Defining Mock Classes

### 3.1 Create a Mock Class

Mocks are C++ classes inheriting from the interface or base class you want to mock. You define mocked methods by placing the `MOCK_METHOD` macro declarations inside the `public:` section. This macro generates the boilerplate needed to intercept calls and track expectations.

Example:

```cpp
// Given this abstract interface
class Foo {
 public:
  virtual ~Foo();

  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
  virtual std::string Describe(int type) = 0;
  virtual bool Process(Bar elem, int count) = 0;
};

// Define MockFoo by deriving from Foo and mocking methods
#include <gmock/gmock.h>

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(std::string, Describe, (int type), (override));
  MOCK_METHOD(bool, Process, (Bar elem, int count), (override));
};
```

### 3.2 Important Notes

- The destructor in the interface should be `virtual` for proper behavior.
- Always place `MOCK_METHOD` declarations in `public:` regardless of original access modifier.
- Use the fourth argument to `MOCK_METHOD` to specify method qualifiers such as `(const, override)`.
- For method signatures containing commas (e.g., templates), wrap the type with extra parentheses or define a type alias.

### 3.3 Mocking Class Templates

You can mock templates just like classes:

```cpp
template <typename Elem>
class StackInterface {
 public:
  virtual ~StackInterface();
  virtual int GetSize() const = 0;
  virtual void Push(const Elem& x) = 0;
};

template <typename Elem>
class MockStack : public StackInterface<Elem> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const Elem& x), (override));
};
```

---

## 4. Using Mock Objects in Tests

### 4.1 Typical Workflow

1. Import the GoogleMock symbols from the `testing` namespace.
2. Instantiate mock objects.
3. Define their behavior using `ON_CALL` (default behavior).
4. Set expectations using `EXPECT_CALL` (specify which calls are expected).
5. Exercise your code that uses the mock.
6. Let GoogleMock verify expectations upon mock destruction.

Example:

```cpp
using ::testing::Return;
using ::testing::_;

TEST(BarTest, DoesThis) {
  MockFoo foo;

  ON_CALL(foo, GetSize())
      .WillByDefault(Return(1));

  EXPECT_CALL(foo, Describe(5))
      .Times(3)
      .WillRepeatedly(Return("Category 5"));

  EXPECT_EQ(MyProductionFunction(&foo), "good");
}
```

### 4.2 Setting Default Behavior with `ON_CALL`

- Used to specify what a mock method should do when called without requiring that it actually gets called.
- Typically placed in a test fixture setup or mock constructor.
- Syntax:

  ```cpp
  ON_CALL(mock_object, Method(matchers...))
      .WillByDefault(action);
  ```

- Use this to avoid warnings for uninteresting calls.

### 4.3 Setting Expectations with `EXPECT_CALL`

- Specifies how many times and with what arguments a mock method is expected to be called.
- Also lets you set the action to perform when called.
- Syntax:

  ```cpp
  EXPECT_CALL(mock_object, Method(matchers...))
      .Times(cardinality)
      .WillOnce(action)
      .WillRepeatedly(action);
  ```

- Callers should always set expectations before exercising the tested code.

### 4.4 Controlling Uninteresting Calls with `NiceMock`, `NaggyMock`, and `StrictMock`

GoogleMock provides wrappers to control how uninteresting calls (calls on mock methods with no expectations) are handled:

- **`NiceMock<T>`**: suppresses warnings for uninteresting calls.
- **`NaggyMock<T>`**: (default) emits warnings for uninteresting calls.
- **`StrictMock<T>`**: treats all uninteresting calls as errors.

Example:

```cpp
using ::testing::NiceMock;

NiceMock<MockFoo> nice_foo;
EXPECT_CALL(nice_foo, DoThis());

// Calls to other methods of nice_foo won't generate warnings.
```

Be cautious when using strict mocks as they can cause brittle tests.

---

## 5. Setting Expectations, Matchers, and Actions

### 5.1 Using Matchers

Matchers specify what values or conditions you expect your mock functions to be called with.

Example with `_` matcher (matches anything):
```cpp
EXPECT_CALL(foo, Bar(_));
```

More specific matcher:
```cpp
EXPECT_CALL(foo, Calculate(Ge(10))); // argument >= 10
```

You can combine matchers and write custom predicates using `Truly()`. See the [Matchers Reference](reference/matchers.md).

### 5.2 Specifying Cardinality with `Times()`

Defines how many times a mock method is expected to be called.

Example:
```cpp
EXPECT_CALL(foo, Bar(_))
    .Times(3); // exactly 3 times
```

Other cardinalities include `AtLeast(n)`, `AtMost(n)`, `AnyNumber()`, and `Between(m, n)`.

If omitted, GoogleMock infers the cardinality based on presence of `WillOnce` and `WillRepeatedly` clauses.

### 5.3 Chaining Actions with `WillOnce()` and `WillRepeatedly()`

Control what the mock method should do when called. Multiple `WillOnce()` clauses specify behavior for successive calls; `WillRepeatedly()` defines what to do thereafter.

Example:

```cpp
EXPECT_CALL(foo, GetNumber())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));

// Returns 1 on first call, 2 on second, and 3 on all subsequent calls
```

### 5.4 Common Actions

- `Return(value)`: returns a copy of `value`.
- `ReturnRef(variable)`: returns reference to `variable`.
- `Invoke()`: calls a callable/lambda.
- `SetArgPointee<N>(val)`: sets N-th argumentâ€™s pointee to `val` (for output parameters).
- `DoAll()`: runs multiple actions sequentially.

---

## 6. Controlling Call Order and Sequencing

### 6.1 Using `InSequence` to Enforce Call Order

Wrap expectations with `InSequence` to require that calls occur in declaration order:

```cpp
{
  InSequence s;

  EXPECT_CALL(foo, Step1());
  EXPECT_CALL(foo, Step2());
  EXPECT_CALL(foo, Step3());
}
```

### 6.2 Using `Sequence` Objects for Partial Ordering

For partial ordering or imposing a DAG of dependencies on calls, use `Sequence` objects with `.InSequence(s1, s2, ...)`. This lets you control relative ordering between calls.

Example:

```cpp
Sequence s1, s2;
EXPECT_CALL(foo, A()).InSequence(s1, s2);
EXPECT_CALL(foo, B()).InSequence(s1);
EXPECT_CALL(foo, C()).InSequence(s2);
```

Means `A()` must precede both `B()` and `C()`, but `B()` and `C()` can be in any order.

### 6.3 Using `After()` to Specify Call Dependencies

Use `After()` on an expectation to specify that it can only occur after others:

```cpp
Expectation e1 = EXPECT_CALL(foo, InitX());
Expectation e2 = EXPECT_CALL(foo, InitY());
EXPECT_CALL(foo, Use())
    .After(e1, e2);
```

You can provide multiple expectations or `ExpectationSet`s.

---

## 7. Best Practices and Common Pitfalls

### 7.1 Define Expectations Before Exercising Code

Always set all `EXPECT_CALL` statements before invoking code that uses the mock to avoid undefined behavior.

### 7.2 Choose Matchers Wisely

Avoid over-specification of expectations which makes tests brittle. Use `_` for arguments you don't care about.

### 7.3 Use `NiceMock` to Silence Uninteresting Call Warnings

If you have mocks with many uninteresting calls that you don't care to specify, wrap the mock in `NiceMock`.

### 7.4 Beware of Sticky Expectations

Expectations stay active (sticky) even after their invocation count is met. Use `.RetiresOnSaturation()` if you want them to become inactive after saturation.

### 7.5 Use `EXPECT_CALL(...).Times(0)` to Disallow Calls

Explicitly deny calls to a mock method by setting its expected call count to zero.

### 7.6 Virtual Destructor Required

Ensure interfaces you mock have virtual destructors to avoid runtime errors and memory leaks.

---

## 8. Advanced Features

### 8.1 Delegating Calls to a Fake or Real Object

You can configure mocks to delegate calls to an existing fake or real implementation by setting default actions with lambdas that call into real methods.

### 8.2 Mocking Move-Only Types

Use C++11 idiomatic syntax to mock methods with move-only parameters or return types, e.g., `std::unique_ptr`.

### 8.3 Mocking Non-Virtual Methods

gMock supports mocking non-virtual functions by creating unrelated classes with methods matching the signatures.

### 8.4 Mocking Destructors

To monitor destruction, implement a mock method (e.g., `Die()`) and call it inside the destructor.

---

## 9. Troubleshooting

### 9.1 Unexpected or Uninteresting Calls

- If you get warnings about uninteresting calls, consider adding expectations or using `NiceMock`.

### 9.2 Mock Object Never Verified

If mock objects are not deleted, GoogleMock may never verify expectations. Use heap checkers or `Mock::VerifyAndClearExpectations` before object destruction.

### 9.3 Compilation Errors on Mock Methods

- Make sure you correctly wrap complex types or use type aliases in `MOCK_METHOD`.
- Check for macro collisions with method names, especially on Windows (can happen with Windows API).

### 9.4 Verbosity and Logging

Use the command-line flag `--gmock_verbose=[info|warning|error]` to control the verbosity of messages related to mocks.

---

## 10. Examples

### 10.1 Simple Mock Class and Test

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetValue() const = 0;
  virtual void SetValue(int v) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, SetValue, (int v), (override));
};

TEST(FooTest, ShouldCallSetValue) {
  MockFoo mock;

  EXPECT_CALL(mock, SetValue(5)).Times(1);
  ON_CALL(mock, GetValue()).WillByDefault(Return(5));

  // Code under test
  mock.SetValue(5);
  EXPECT_EQ(mock.GetValue(), 5);
}
```

### 10.2 Using NiceMock to Ignore Uninteresting Calls

```cpp
using ::testing::NiceMock;

NiceMock<MockFoo> nice_mock;
EXPECT_CALL(nice_mock, SetValue(10));

// Calls to other methods won't generate warnings
nice_mock.GetValue();
```

---

## 11. References and Further Reading

- [GoogleMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [GoogleMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Matchers Reference](reference/matchers.md)
- [Actions Reference](reference/actions.md)
- [GoogleTest Primer](../getting-started/first-test-and-validation/quickstart-primer)
- [Writing and Running Your First Test](../getting-started/first-test-and-validation/writing-and-running-your-first-test)
- [Troubleshooting Common Issues](../getting-started/first-test-and-validation/troubleshooting)

For integration and ecosystem info, consult the [Ecosystem Integration page](/overview/integration-and-ecosystem/ecosystem-integration).

---

## 12. Summary

In essence, this guide empowers you to create mock classes for dependencies with `MOCK_METHOD`, set their behavior and expectations with `ON_CALL` and `EXPECT_CALL`, and manage mock object behavior including call order, default actions, and strictness levels. With practical examples and key best practices, you gain precise control over interactions your code has with dependencies, making your unit tests reliable and maintainable.

