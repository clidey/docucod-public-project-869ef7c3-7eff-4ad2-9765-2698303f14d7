---
title: "Writing Death Tests"
description: "Shows how to construct tests that verify code failures and exits as expected, including practical tips for handling platform and debugging constraints."
---

# Writing Death Tests

## Overview

Death tests are designed to verify that certain code paths cause a program to terminate (i.e., "die") as expected, for example, by triggering fatal assertions, calling abort, or exiting with a specific status. This page guides you through constructing death tests that check whether your C++ code fails and exits properly under predefined conditions.

If your code contains assertions or error conditions that should cause termination, death tests ensure these conditions are correctly implemented and help avoid silent failures or undefined behavior.

---

## Prerequisites

- Basic familiarity with writing GoogleTest (`TEST`, `TEST_F`) test cases.
- GoogleTest and GoogleMock installed and set up in your C++ project.
- Understanding of assertions (fatal and non-fatal) and fundamental test macros.

---

## What You Will Achieve

By following this guide, you will:

- Learn how to write death tests using macros like `ASSERT_DEATH`, `EXPECT_DEATH`, `ASSERT_EXIT`, and `EXPECT_EXIT`.
- Understand how to check that a statement causes your process to terminate with expected messages.
- Handle platform-specific caveats and debugging constraints related to death tests.
- Learn best practices for writing robust, maintainable death tests.

---

## Expected Time

Approximately 15â€“30 minutes to write a simple death test and understand the key patterns.

---

## Difficulty Level

Intermediate. Some system programming concepts (process exit codes, signals) and test architecture awareness are helpful.

---

## Step-by-Step Guide

### Step 1: Choose an Appropriate Death Test Macro

- Use `ASSERT_DEATH(statement, regex)` or `EXPECT_DEATH(statement, regex)` to test that a statement causes abnormal termination (non-zero exit), and outputs stderr matching the provided regular expression.
- Use `ASSERT_EXIT(statement, predicate, regex)` or `EXPECT_EXIT(statement, predicate, regex)` to verify the exit status of the termination, where `predicate` is a functor or function verifying the exit code or signal.

### Step 2: Write Your Death Test

```cpp
TEST(MyDeathTest, ExitsOnInvalidInput) {
  ASSERT_DEATH(
      { MyFunctionThatShouldAbort(-1); },
      "Invalid input"  // Regex pattern to match on stderr output
  );
}
```

- The `statement` can be a single expression or a compound statement enclosed in braces.
- The `regex` string matches against the stderr output of the child process.

### Step 3: Use Predicates to Verify Exit Status (Optional for `EXPECT_EXIT`, `ASSERT_EXIT`)

GoogleTest provides predicates to verify exit status:

- `testing::ExitedWithCode(code)`: Checks if the process exited with a specific code.
- `testing::KilledBySignal(signum)`: Checks if the process was terminated by a specific signal (POSIX only).

Example:

```cpp
TEST(MyDeathTest, ExitsWithCodeZero) {
  EXPECT_EXIT(
      CleanShutdownFunction(),
      testing::ExitedWithCode(0),
      "Shutdown complete"
  );
}
```

### Step 4: Handle Exceptions Carefully

- Death tests expect process termination, not exceptions.
- If an exception escapes a death test statement, the test fails.
- Use `EXPECT_THROW` or `ASSERT_THROW` to test exceptions separately.

### Step 5: Avoid Common Pitfalls

- **Multiple death tests on the same line:** GoogleTest does not support multiple death test macros on the same line.
- **Side effects are not observable:** Because death tests run the statement in a separate process, changes are not reflected in the parent.
- **Thread safety warnings:** Death tests warn if more than one thread is running. It's best to run death tests in single-thread context.
- **Avoid `return` in death test statements:** Returning prematurely causes failure.

### Step 6: Stream Failure Messages

You can append messages to death tests using the streaming operator:

```cpp
EXPECT_DEATH(
    CallFunctionThatAborts(),
    "Abort triggered"
) << "Check invalid state handling";
```

This message is shown if the death test fails.

---

## Practical Examples

### Example 1: Basic Death Test

```cpp
TEST(DivideByZeroDeathTest, CrashesOnZero) {
  ASSERT_DEATH(Divide(10, 0), "Division by zero");
}
```

### Example 2: Death Test with Exit Code Predicate

```cpp
TEST(MyProcessDeathTest, ExitsWithCodeOne) {
  EXPECT_EXIT(Process::RunFailingTask(), testing::ExitedWithCode(1), "Error");
}
```

### Example 3: Death Test with Compound Statement

```cpp
TEST(CompoundDeathTest, DiesOnMultipleFailures) {
  EXPECT_DEATH(
      {
        Initialize();
        TriggerFatalError();
      },
      "Fatal error detected"
  );
}
```

### Example 4: Testing Functions with Parameters

```cpp
void DieIf(bool should_die) {
  if (should_die) abort();
}

TEST(ParamDeathTest, DiesWhenTrue) {
  EXPECT_DEATH(DieIf(true), "");
  EXPECT_NONFATAL_FAILURE(EXPECT_DEATH(DieIf(false), ""), "failed to die");
}
```

---

## Best Practices & Tips

- **Name your test suite with the suffix `DeathTest`** to organize death tests and ensure they run before other tests.
- **Use `SCOPED_TRACE`** to include traces for easier debugging, especially when death tests involve subroutine calls or loops.
- **Set `GTEST_FLAG_SET(death_test_style, "threadsafe")` in `main()`** for better thread safety when needed, trading some runtime.
- **Suppress side effects inside death test statements** as they will not affect the parent test process.
- **Allow leaks with `Mock::AllowLeak()`** if using mocks in death tests to avoid false leak reports.

---

## Troubleshooting Common Issues

### Death Test Fails Unexpectedly

- Verify the regular expression matches the exact error output.
- Ensure the death occurs on the statement under test.
- Avoid using functions that swallow signals or exceptions.

### Multiple Threads Warning

- GoogleTest logs a warning if multiple threads exist when a death test runs.
- Consider isolating the death test in a single-threaded environment or use the "threadsafe" death test style.

### Death Test Returns Early

- Returning from a death test statement causes test failure.
- Avoid `return` or exceptions escaping the statement under the macros.

### Platform Limitations

- On Windows, death tests always use the threadsafe mode via re-execution.
- On POSIX, you can set the death test style to "fast" (fork + run) or "threadsafe" (fork + exec).
- Regular expression support differs slightly; verify syntax compatibility.

---

## Next Steps & Related Content

- Explore the [Assertions Reference](../reference/assertions.md) for detailed information on death test macros and other assertions.
- Learn about [Exception Assertions](../advanced.md#exceptions) to test exceptions.
- Review the [Advanced GoogleTest Topics](../advanced.md#death-tests) for deeper understanding.
- Utilize the [Event Listener API](../advanced.md#extending-googletest-by-handling-test-events) to monitor death test execution.

---

## Additional Resources

- [GoogleTest Primer](../primer.md)
- [Assertions Reference](../reference/assertions.md#death)
- [Advanced GoogleTest Topics - Death Tests](../advanced.md#death-tests)
- [GoogleTest GitHub Repository](https://github.com/google/googletest)

---

## Summary

Death tests verify that specific code triggers program termination correctly and produce expected error messages. GoogleTest offers macros like `ASSERT_DEATH` and `EXPECT_EXIT` that run code in a subprocess, capturing output and exit statuses for validation. Proper use of these macros requires attention to threading, exceptions, and exit codes. This guide provides practical instructions, examples, best practices, and troubleshooting advice to confidently write effective death tests in C++ with GoogleTest.