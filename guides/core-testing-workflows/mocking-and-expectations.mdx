---
title: "Mocking and Setting Expectations"
description: "Step-by-step instruction to mocking interfaces and classes using GoogleMock. Includes writing mock methods, defining expectations, and best practices for verification."
---

# Mocking and Setting Expectations

## Overview

This guide provides a practical and comprehensive walkthrough on how to mock interfaces and classes using GoogleMock (gMock). You'll learn how to write mock methods using the `MOCK_METHOD` macro, define expectations with `EXPECT_CALL`, work with matchers and cardinalities, and apply best practices for verifying and controlling mocked behaviors.

Whether you're building tests that verify how your code interacts with dependencies, or simply simulating components for unit tests, this guide will empower you to precisely control and validate method calls.

---

## Prerequisites

- Familiarity with C++ and virtual functions.
- GoogleMock included in your test project (`#include <gmock/gmock.h>`).
- Basic understanding of unit testing and mocking concepts.

---

## Expected Outcome

By following this guide, you will:

- Be able to create mock classes with properly defined mock methods.
- Know how to set expectations on mock method calls, including argument matching and call counts.
- Understand how to specify and customize the behavior of mock methods.
- Master ordering and sequencing of mocked calls.
- Avoid common pitfalls and write maintainable, robust mock-based tests.

---

## Time Estimate

Approximately 15-30 minutes to read through, set up your first mocks, and try basic expectations.

## Difficulty Level

Intermediate - familiarity with C++ testing and object-oriented principles required.

---

## Step-by-Step Instructions

### 1. Define a Mock Class

To mock a class or interface, define a subclass and declare mock methods with the `MOCK_METHOD` macro.

- Syntax:

  ```cpp
  class MockFoo : public Foo {
   public:
    MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
  };
  ```

- Notes:
  - `MOCK_METHOD` must be declared **public**, regardless of the original method's access level.
  - Use the `(Specs...)` parameter to specify qualifiers such as `const`, `override`, `noexcept`, or calling conventions.

- Example (mocking a simple interface):

  ```cpp
  #include <gmock/gmock.h>

  class Turtle {
   public:
    virtual ~Turtle() {}
    virtual void PenUp() = 0;
    virtual int GetX() const = 0;
  };

  class MockTurtle : public Turtle {
   public:
    MOCK_METHOD(void, PenUp, (), (override));
    MOCK_METHOD(int, GetX, (), (const, override));
  };
  ```

### 2. Handle Types with Commas in Mock Method Signatures

If your return type or argument types include commas (e.g., `std::pair` or templated types), `MOCK_METHOD` will fail to parse unless you:

- Wrap the type in extra parentheses:

  ```cpp
  MOCK_METHOD((std::pair<bool, int>), GetPair, ());
  ```

- Or use type aliases:

  ```cpp
  using BoolInt = std::pair<bool, int>;
  MOCK_METHOD(BoolInt, GetPair, ());
  ```

### 3. Set Expectations Using `EXPECT_CALL`

Use `EXPECT_CALL` to specify that a mock method is expected to be called with certain arguments.

- Syntax:

  ```cpp
  EXPECT_CALL(mock_object, MethodName(Matchers...))
      .Times(cardinality)
      .WillOnce(action)
      .WillRepeatedly(action);
  ```

- Omitting `.Times()` will cause gMock to infer cardinality based on actions set.

- Example:

  ```cpp
  EXPECT_CALL(mockTurtle, PenUp())
      .Times(1);
  EXPECT_CALL(mockTurtle, GetX())
      .WillOnce(Return(42))
      .WillRepeatedly(Return(0));
  ```

### 4. Use Matchers to Specify Argument Constraints

Matchers control what argument values satisfy the expectation. Some common matchers:

- `_` matches any argument
- `Eq(value)` matches exact values (implicit if a plain value is used)
- `Ge(x)`, `Lt(x)`, `Ne(x)`, and other comparison matchers
- `NotNull()` matches non-null pointers

Example:

```cpp
EXPECT_CALL(mockObj, Foo(Ge(5), _));  // First arg >= 5, second arg anything
```

### 5. Controlling Call Order: Sequences

Use sequences to enforce call order for expectations.

```cpp
using ::testing::InSequence;
{
  InSequence s;
  EXPECT_CALL(mockFoo, FirstCall());
  EXPECT_CALL(mockFoo, SecondCall());
}
```

Calls must occur in declared order or tests will fail.

### 6. Define Default Behavior with `ON_CALL`

`ON_CALL` specifies how a method behaves by default, without asserting it must be called.

Example:

```cpp
ON_CALL(mockFoo, GetSize())
    .WillByDefault(Return(10));
```

- This is helpful to reduce verbosity when many calls are expected, but only some are specifically verified.

### 7. Use Mock Strictness to Control Uninteresting Calls

- By default, mocks warn on uninteresting calls (methods called without an `EXPECT_CALL`).
- Use `NiceMock<MockType>` to suppress these warnings.
- Use `StrictMock<MockType>` to treat uninteresting calls as test failures.

Example:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mockFoo;
```

### 8. Handle Overloaded Methods

Mock all overloads explicitly or use `using Base::Method` to avoid hiding overloads.

Example:

```cpp
MOCK_METHOD(int, Add, (int x), (override));
MOCK_METHOD(int, Add, (int times, int x), (override));
```

### 9. Handling Callbacks and Actions

Customize method behavior with `WillOnce()`, `WillRepeatedly()`, `Invoke()`, lambdas, and more (see [Using Functions as Actions](gmock_cook_book.md#FunctionsAsActions)).

### 10. Verify Mock Behavior

When your mock object is destroyed, gMock verifies that all expectations are met.
If you create mocks on the heap and hand ownership to tested code, call
`Mock::VerifyAndClearExpectations(&mock)` manually to force verification early.

Example:

```cpp
ASSERT_TRUE(::testing::Mock::VerifyAndClearExpectations(mock));
```

---

## Examples

### Example: Simple Mock with Expectations

```cpp
#include <gmock/gmock.h>
#include <gtest/gtest.h>

class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetValue(int x) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (int x), (override));
};

TEST(FooTest, ReturnsExpectedValue) {
  MockFoo mockFoo;

  EXPECT_CALL(mockFoo, GetValue(5))
      .WillOnce(::testing::Return(42));

  int result = mockFoo.GetValue(5);
  EXPECT_EQ(result, 42);
}
```

### Example: Enforcing Call Order with Sequences

```cpp
using ::testing::InSequence;

TEST(TurtleTest, CallsInOrder) {
  MockTurtle turtle;
  {
    InSequence s;
    EXPECT_CALL(turtle, PenDown());
    EXPECT_CALL(turtle, Forward(100));
    EXPECT_CALL(turtle, PenUp());
  }

  // Calls must happen in the above order
  turtle.PenDown();
  turtle.Forward(100);
  turtle.PenUp();
}
```

### Example: Mocking Const and Overloaded Methods

```cpp
class Bar {
 public:
  virtual int Get() = 0;
  virtual int Get() const = 0;
};

class MockBar : public Bar {
 public:
  MOCK_METHOD(int, Get, (), (override));
  MOCK_METHOD(int, Get, (), (const, override));
};

TEST(BarTest, ConstOverload) {
  MockBar mockBar;
  EXPECT_CALL(mockBar, Get())
      .WillOnce(::testing::Return(1));
  EXPECT_CALL(::testing::Const(mockBar), Get())
      .WillOnce(::testing::Return(2));

  EXPECT_EQ(mockBar.Get(), 1);
  EXPECT_EQ(static_cast<const MockBar&>(mockBar).Get(), 2);
}
```

---

## Troubleshooting & Tips

### Common Issues

- Method not virtual: gMock can only mock virtual methods.
- Missing `override` specifier on mock methods: recommended to avoid surprises.
- Commas in argument types: use parentheses or type aliasing.
- Uninteresting call warnings: consider using `NiceMock` or add `EXPECT_CALL` with `.Times(AnyNumber())`.
- Overloaded methods ambiguity: specify parameter types to resolve ambiguity.
- Mock objects not destructed: verification might be skipped, causing false positives.

### Best Practices

- Mock to interfaces, not concrete classes, to reduce coupling.
- Use `ON_CALL` to set default behaviors and `EXPECT_CALL` only to verify calls.
- Use sequences sparingly; only when call order matters.
- Avoid overly strict expectations to keep tests maintainable.

### Performance Considerations

- For large mock classes, define constructor/destructor in `.cc` files to speed up compilation.

### Alternative Approaches

- When mocking non-virtual methods, use templates and mock unrelated mocks (advanced).
- Mock free functions via abstract interfaces.

---

## Next Steps & Related Content

- Explore [Using Matchers and Actions](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#Matchers) for advanced argument matching.
- Learn [Best Practices for Mocking](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#mocking-best-practices) to write maintainable tests.
- See [GoogleTest Primer](../guides/getting-started/primer) for broader test writing principles.
- Consult the [Mocking Reference](../reference/mocking.md) for a detailed API overview.

---

## See Also

- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md)
- [gMock Cheat Sheet](https://github.com/google/googletest/blob/main/docs/gmock_cheat_sheet.md)
- [Understanding Uninteresting vs Unexpected Calls](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md#uninteresting-vs-unexpected)


---

*This page is part of the GoogleTest and GoogleMock documentation suite, focused specifically on mocking and setting expectations.*
