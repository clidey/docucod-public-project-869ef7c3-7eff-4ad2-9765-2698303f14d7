---
title: "Creating and Using Mocks with GoogleMock"
description: "Step through the process of defining mock classes, setting expectations, and verifying interactions. This guide demonstrates real-world mocking scenarios for isolating components and enhancing unit test precision."
---

# Creating and Using Mocks with GoogleMock

Step through the process of defining mock classes, setting expectations, and verifying interactions. This guide demonstrates real-world mocking scenarios for isolating components and enhancing unit test precision.

---

## 1. Introduction to Mocks in GoogleMock

Using GoogleMock, you can simulate the behavior of complex or external dependencies by creating mock classes. This allows you to:

- Isolate the unit under test from other components.
- Precisely define interactions (calls, order, arguments).
- Control return values and side effects.
- Verify that the expected interactions actually occur.

This page focuses on defining mock classes, specifying expectations on mock methods, setting default behaviors, and verifying call correctness with real usage examples.

---

## 2. Prerequisites

Before proceeding, you should have:

- A C++ project setup with GoogleTest and GoogleMock integrated.
- Basic familiarity with unit testing in GoogleTest.
- A target interface or class with virtual methods to mock.

For setup guidance, refer to the [Setting Up Your Test Environment](https://google.github.io/googletest/guides/getting-started/environment-setup) page.

---

## 3. Defining Mock Classes

### 3.1 Basic Mock Class Structure

A mock class should derive from the interface or class you want to mock. Within this class, use the `MOCK_METHOD` macro to define mock methods with the same signatures as the original virtual methods.

```cpp
#include <gmock/gmock.h>

class MockFoo {
 public:
  MockFoo() = default;

  MOCK_METHOD(char, Bar, (const std::string& s, int i, double x));
  MOCK_METHOD(bool, Bar2, (int x, int y));
  MOCK_METHOD(void, Bar3, (int x, int y));

 private:
  MockFoo(const MockFoo&) = delete;
  MockFoo& operator=(const MockFoo&) = delete;
};
```

Key points:

- Use `MOCK_METHOD(ReturnType, MethodName, (Args...))`.
- Always place mock methods in the `public:` section, even if mocking private or protected methods.
- Use `override` if overriding virtual methods from base classes.

### 3.2 Handling Commas in Types

If your method arguments or return types include commas (e.g., templates like `std::pair<int, int>`), wrap them in parentheses to prevent parsing errors:

```cpp
MOCK_METHOD((std::pair<int, int>), GetPair, ());
```

### 3.3 Mocking Overloaded Methods

Mock all overloaded variations explicitly in your mock class to avoid hiding base class overloads:

```cpp
MOCK_METHOD(int, Add, (Element x), (override));
MOCK_METHOD(int, Add, (int times, Element x), (override));
```

If not mocking some overloads, bring them into scope with `using BaseClass::MethodName;` to avoid compiler warnings.

---

## 4. Setting Expectations on Mocks

### 4.1 Basic Expectations

Use `EXPECT_CALL` to specify how a mock method is expected to be called:

```cpp
using ::testing::Return;

MockFoo foo;
EXPECT_CALL(foo, Bar2(0, _))  // Expect first arg == 0, anything for second.
    .Times(1)                  // Expect to be called once.
    .WillOnce(Return(true));   // Return true when called.
```

If the method is called with matching arguments, the specified action runs; otherwise, an error is reported.

### 4.2 Default Actions with `ON_CALL`

Use `ON_CALL` to specify default behaviors without setting expectations on call counts:

```cpp
ON_CALL(foo, Bar2(_, _))
    .WillByDefault(Return(false));
```

This sets the default action when an expectation is not explicitly set.

### 4.3 Argument Matchers

Use matchers like `_` (wildcard), `Ge()`, `Ne()`, or custom matchers to allow flexible matching:

```cpp
EXPECT_CALL(foo, Bar(Ge(5), _))
    .WillOnce(Return('a'));
```

### 4.4 Ordering and Sequences

To enforce call order, group expectations with `InSequence`:

```cpp
{
  InSequence s;
  EXPECT_CALL(foo, Bar(1));
  EXPECT_CALL(foo, Bar(2));
}
```

All calls must occur in this order.

---

## 5. Using Mocks in Tests

### 5.1 General Workflow

1. Create mock objects.
2. Use `ON_CALL` to set general default behaviors if needed.
3. Apply `EXPECT_CALL` to specify the expected calls and behaviors.
4. Exercise the code under test.
5. GoogleMock automatically verifies expectations when mocks are destroyed.

### 5.2 Example

```cpp
#include <gtest/gtest.h>
#include <gmock/gmock.h>

using ::testing::Return;
using ::testing::_;

class MockFoo {
 public:
  MOCK_METHOD(bool, Bar2, (int x, int y));
};

TEST(FooTest, BasicExpectation) {
  MockFoo foo;

  ON_CALL(foo, Bar2(_, _)).WillByDefault(Return(false));
  EXPECT_CALL(foo, Bar2(5, _)).WillOnce(Return(true));

  EXPECT_FALSE(foo.Bar2(0, 0));
  EXPECT_TRUE(foo.Bar2(5, 10));
}
```

This test sets a default to return false, expects one call with first argument 5 to return true, then verifies these expectations during test execution.

---

## 6. Advanced Mocking Scenarios

### 6.1 Delegating to a Fake or Real Object

You can delegate mock method calls to a real or fake implementation to combine interaction verification with actual behavior.

Example delegating to a fake:

```cpp
class FakeFoo : public Foo {
  char DoThis(int n) override { ... }
  void DoThat(const char* s, int* p) override { ... }
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(char, DoThis, (int n), (override));
  MOCK_METHOD(void, DoThat, (const char* s, int* p), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault([this](int n) {
      return fake_.DoThis(n);
    });
    ON_CALL(*this, DoThat).WillByDefault([this](const char* s, int* p) {
      fake_.DoThat(s, p);
    });
  }

 private:
  FakeFoo fake_;
};
```

### 6.2 Nice, Strict, and Naggy Mocks

- `NiceMock<MockClass>`: suppresses warnings about uninteresting calls.
- `NaggyMock<MockClass>`: warns about uninteresting calls (default).
- `StrictMock<MockClass>`: treats uninteresting calls as errors.

Use accordingly to control test output verbosity and strictness.

### 6.3 Handling Move-Only Types

You can mock methods returning or accepting move-only types (like `std::unique_ptr`) using the standard MOCK_METHOD syntax.

To handle returned move-only objects properly, use lambdas in your actions, not just `Return()`:

```cpp
EXPECT_CALL(mock, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
      return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

### 6.4 Verifying and Clearing Expectations

You can force verification before mock destruction:

```cpp
using ::testing::Mock;

Mock::VerifyAndClearExpectations(&mock_obj);
```

And suppress leak warnings if mocks live longer:

```cpp
Mock::AllowLeak(&mock_obj);
```

---

## 7. Debugging and Troubleshooting

### 7.1 Verbosity Levels

Control message verbosity with `--gmock_verbose=LEVEL` flag:

- `info`: Log all info, warnings, errors and call stack traces.
- `warning` (default): Warnings and errors, no stack traces.
- `error`: Only errors.

Verbose logging can help identify why expectations fail.

### 7.2 Common Issues

- **Unexpected calls:** Calls that don't match any active expectation cause errors.
- **Uninteresting calls:** Calls to methods without expectations cause warnings unless using `NiceMock`.
- **Saturated expectations:** Calling a method more times than expected leads to failure.

Make sure to set expectations **before** exercising code.

### 7.3 Tips

- Use catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())` to tolerate additional calls.
- Use sequences for ordered calls.
- Use `RetiresOnSaturation()` to automatically retire expectations when saturated.

---

## 8. Summary

Creating and using mocks with GoogleMock involves:

- Defining mock classes with `MOCK_METHOD` macros.
- Setting default behaviors with `ON_CALL`.
- Specifying precise expectations with `EXPECT_CALL`.
- Combining matchers, actions, and cardinalities to describe intended behaviors.
- Using sequences and ordering to enforce call order.
- Delegating to fakes, handling special types, and controlling verbosity.
- Performing verification automatically or manually.

Mastering these techniques enables robust, flexible, and precise unit testing.

---

## 9. Additional Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html)
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.html)
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [Understanding Uninteresting vs Unexpected Calls](https://google.github.io/googletest/gmock_cook_book.html#uninteresting-vs-unexpected)

---

## 10. Troubleshooting Tips

<AccordionGroup title="Common Troubleshooting Scenarios">
<Accordion title="Unexpected Mock Function Call">
When a mock function is called but no matching `EXPECT_CALL` exists, GoogleMock reports an unexpected call error.

**How to fix:**
- Review your `EXPECT_CALL`s to ensure expected calls match actual calls (check argument matchers).
- Add catch-all expectations using `_` matcher with `Times(AnyNumber())` if calls are allowed but not interesting.
</Accordion>
<Accordion title="Warnings About Uninteresting Calls">
Warnings appear when calling a mock method with no expectation or default action.

**How to fix:**
- Use `ON_CALL` to specify default behavior.
- Suppress with `NiceMock` if calls are harmless.
- Increase verbosity to `info` for diagnostic logging.
</Accordion>
<Accordion title="Calls Occurring Out of Order">
If using `InSequence` or `After`, calls happening in wrong order cause failures.

**How to fix:**
- Check your test logic and code flow to ensure order matches expectation.
- Refactor to relax ordering constraints if appropriate.
</Accordion>
</AccordionGroup>

---

## 11. Example Test Snippet with Mock and Expectations

```cpp
#include <gtest/gtest.h>
#include <gmock/gmock.h>

using ::testing::_;           // Matcher for any value.
using ::testing::Return;
using ::testing::InSequence;

class MockFoo {
 public:
  MOCK_METHOD(bool, Bar2, (int x, int y));
};

TEST(ExampleTest, UsesMock) {
  MockFoo foo;

  ON_CALL(foo, Bar2(_, _)).WillByDefault(Return(false));

  {
    InSequence seq;
    EXPECT_CALL(foo, Bar2(1, _))
        .WillOnce(Return(true));
    EXPECT_CALL(foo, Bar2(2, 2))
        .WillOnce(Return(true));
  }

  EXPECT_TRUE(foo.Bar2(1, 10));
  EXPECT_TRUE(foo.Bar2(2, 2));
  EXPECT_FALSE(foo.Bar2(3, 3));  // Uses default action
}
```

This example demonstrates defining a mock method, setting default behavior, ordering two expectations in sequence, and invoking the calls.
