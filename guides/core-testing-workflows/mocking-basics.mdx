---
title: "Mocking with GoogleMock"
description: "Stepwise instructions for creating and using mock objects, explaining key macros such as MOCK_METHOD, EXPECT_CALL, and ON_CALL to simulate dependencies, intercept function calls, and set expectations."
---

# Mocking with GoogleMock

GoogleMock (gMock) provides a powerful framework for creating mock objects in C++. This guide walks you through the essential steps to create and use mock classes, focusing on key macros such as `MOCK_METHOD`, `EXPECT_CALL`, and `ON_CALL`. You'll learn how to simulate dependencies, intercept function calls, and specify expectations on method invocations.

---

## 1. Introduction to Mocking

Mock objects are stand-ins for real objects that implement the same interface but allow fine-grained control over their behavior and expectations during tests. Using mocks helps isolate the unit under test, verify interactions, and simulate edge cases.

## 2. Creating Mock Classes

Mock classes are ordinary C++ classes derived from the interface or base class you want to mock. The key is to declare mock methods with the `MOCK_METHOD` macro inside the `public:` section of the mock class, regardless of how access is declared in the base class.

### 2.1 Declaring Mock Methods with `MOCK_METHOD`

The general syntax is:

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- `ReturnType`: The method's return type.
- `MethodName`: Name of the method to mock.
- `(Args...)`: Parenthesized list of method argument types.
- `(Qualifiers)`: Optional list of qualifiers like `const`, `override`, `noexcept`.

#### Example

Given an interface:

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual int GetX() const = 0;
};
```

Define a mock:

```cpp
#include <gmock/gmock.h>

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

#### Important Notes

- Use `override` if overriding a virtual method.
- Use `const` if the method is const.
- Wrap argument or return types with commas inside parentheses if they include commas (e.g., `std::pair<bool, int>`).

```cpp
MOCK_METHOD((std::pair<bool,int>), GetPair, ());
```

- You may alternatively use type aliases to simplify.

### 2.2 Mocking Overloaded Methods

Mock overloaded functions by mocking each signature separately.

```cpp
virtual int Add(int x);
virtual int Add(int times, int x);

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (int times, int x), (override));
};
```

If you don't mock all overrides, use `using Base::Method;` in your mock class to avoid hiding them.

### 2.3 Mocking Non-virtual Methods

gMock supports mocking non-virtual methods via high-performance dependency injection by defining a mock class unrelated to the real class but with matching method signatures.

Example:

```cpp
class ConcreteStream {
 public:
  void Append(int v);
  int Get(size_t i) const;
};

class MockStream {
 public:
  MOCK_METHOD(void, Append, (int v));
  MOCK_METHOD(int, Get, (size_t i), (const));
};
```

## 3. Setting Expectations with `EXPECT_CALL`

Use `EXPECT_CALL` to specify that a mock method is expected to be called with specific arguments, how many times, and what actions to perform.

### 3.1 Basic Syntax

```cpp
EXPECT_CALL(mock_object, Method(Matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `Matchers` define the arguments expected.
- `Times()` controls the number of calls.
- `WillOnce()` and `WillRepeatedly()` specify what actions the mock takes on the calls.

### 3.2 Argument Matchers

- Use precise matchers like `Eq(value)` or shorthand by specifying values.
- Use `_` to match any argument.

Example:

```cpp
EXPECT_CALL(turtle, Forward(100));  // Expect exact argument
EXPECT_CALL(turtle, GoTo(50, _));   // Match x=50 and any y
```

### 3.3 Cardinalities

- `Times(AnyNumber())`: any number of calls
- `Times(AtLeast(n))`: at least n calls
- `Times(AtMost(n))`: at most n calls
- `Times(Exactly(n))` or `Times(n)`: exactly n calls
- `Times(0)`: method must never be called

### 3.4 Actions

Control the returned values or side effects.

Common actions:

- `Return(value)`: return a specified value
- `ReturnRef(variable)`: return a reference
- `Invoke(function)`: invoke a callable
- `SetArgPointee<N>(value)`: set the Nth argument (by pointer) to value
- `DoAll(action1, action2, ...)`: chain multiple actions

Example:

```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42))
    .WillRepeatedly(Return(100));
```

### 3.5 Order of Expectations

By default, calls can occur in any order.

Use `InSequence` to enforce strict ordering:

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, Step1());
  EXPECT_CALL(mock, Step2());
}
```

Use `.After(other_expectation)` to specify a partial order or dependency.

### 3.6 Using Multi-argument Matchers

`With(matcher)` restricts the expectation to calls matching a tuple matcher over all arguments.

Example:

```cpp
EXPECT_CALL(mock, Func(_, _))
    .With(Lt()); // First arg less than second
```

## 4. Defining Default Behavior with `ON_CALL`

`ON_CALL` sets the default action for calls that don't match any `EXPECT_CALL`. It does not set any expectations.

Usage:

```cpp
ON_CALL(mock_object, Method(Matchers...))
    .With(multi_arg_matcher)  // optional
    .WillByDefault(action);
```

Example:

```cpp
ON_CALL(mock, GetX()).WillByDefault(Return(10));
```

Default actions are overridden by matching `EXPECT_CALL` actions.

## 5. Best Practices and Tips

- Prefer `ON_CALL` for setting common default behaviors shared across tests.
- Use `EXPECT_CALL` only when verifying calls is necessary.
- Suppress warnings for uninteresting calls by using `NiceMock<MockClass>`.
- Use `StrictMock<MockClass>` to treat uninteresting calls as errors.
- Use `RetiresOnSaturation()` to make expectations retire after Saturation.
- Avoid mocking classes you do not own; prefer mocking interfaces.
- Use `WillOnce` and `WillRepeatedly` clauses carefully to model exact call sequences.
- Set expectations *before* executing the code under test.

## 6. Practical Example

```cpp
#include <gmock/gmock.h>

class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};

TEST(PainterTest, CallsPenUp) {
  MockTurtle turtle;

  ON_CALL(turtle, GetX()).WillByDefault(::testing::Return(5));
  EXPECT_CALL(turtle, PenUp()).Times(1);

  // Code under test uses turtle...
  turtle.PenUp();

  // GetX isn't verified here, but calling it returns 5.
  EXPECT_EQ(turtle.GetX(), 5);
}
```

This example creates a mock turtle, sets a default return value for `GetX()`, expects that `PenUp()` is called exactly once, and verifies the behavior.

## 7. Troubleshooting Common Issues

- **Warning about uninteresting function calls**: Means you called a mock method without an `EXPECT_CALL`. Use `NiceMock` if you want to suppress warnings.
- **Linker errors or symbol not found**: Ensure virtual destructors on interfaces you mock.
- **Method called more or fewer times than expected**: Review `Times()` clause and expectations.
- **Confusion on overloaded methods**: Use explicit argument matchers or `using` declarations to avoid hiding base methods.

## 8. Additional Resources

- [gMock Cookbook](https://github.com/google/googletest/blob/main/docs/gmock_cook_book.md) — Recipes and advanced usages
- [gMock for Dummies](https://github.com/google/googletest/blob/main/docs/gmock_for_dummies.md) — Introductory guide
- [Mocking Reference](https://github.com/google/googletest/blob/main/docs/reference/mocking.md) — Detailed API
- [GoogleTest Primer](https://github.com/google/googletest/blob/main/docs/primer.md) — Getting started with tests

---