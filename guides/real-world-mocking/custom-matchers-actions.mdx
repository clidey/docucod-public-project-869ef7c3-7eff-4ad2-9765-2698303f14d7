---
title: "Defining Custom Matchers and Actions"
description: "Learn how to define custom matchers and actions to tailor GoogleMock to your application's needs. This guide explains the design and implementation of expressive, reusable test verifications and side effects, enabling more descriptive and versatile test cases."
---

# Defining Custom Matchers and Actions

Customize GoogleMock to fit your application's unique testing requirements by defining custom matchers and actions. This guide empowers you to create expressive, reusable, and precise verifications and side effects, leading to clearer and more versatile test cases.

---

## Workflow Overview

### Purpose
This guide helps you learn how to design and implement custom matchers and actions in GoogleMock, allowing you to extend the testing framework beyond built-in capabilities.

### Prerequisites
- Basic familiarity with C++ and GoogleMock
- Understanding of mock objects and standard GoogleMock expectations (`EXPECT_CALL`, `ON_CALL`)
- Experience writing simple tests in GoogleMock

### Expected Outcome
- Ability to write custom matcher classes and parameterized matchers
- Knowledge to create custom actions, including parameterized and polymorphic actions
- Understanding how to integrate these into your tests for more expressive verification and behavior specification

### Time Estimate
30-60 minutes to become comfortable with basic custom matchers and actions

### Difficulty Level
Intermediate

---

## Understanding Custom Matchers

Matchers define how GoogleMock compares an argument passed to a mock method with expected values or conditions. When built-in matchers aren't enough, custom matchers let you craft exact test requirements.

### Creating a Simple Custom Matcher Class

Define a class that implements the following interface:

- **`bool MatchAndExplain(const T& arg, std::ostream* listener) const`**: Returns whether the argument matches, optionally explaining failures.
- **`void DescribeTo(std::ostream* os) const`**: Describes matching criteria.
- **`void DescribeNegationTo(std::ostream* os) const`**: Describes conditions for negation.

Example:

```cpp
class DivisibleBy7Matcher {
 public:
  using is_gtest_matcher = void;  // Marker type for GoogleMock

  explicit DivisibleBy7Matcher(int divisor) : divisor_(divisor) {}

  bool MatchAndExplain(int n, std::ostream* os) const {
    bool matches = (n % divisor_) == 0;
    if (!matches && os != nullptr) {
      *os << "the remainder is " << (n % divisor_);
    }
    return matches;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "is divisible by " << divisor_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "is not divisible by " << divisor_;
  }

 private:
  const int divisor_;
};

::testing::Matcher<int> DivisibleBy7(int divisor) {
  return ::testing::MakeMatcher(new DivisibleBy7Matcher(divisor));
}
```

Usage:

```cpp
EXPECT_CALL(mock, Foo(DivisibleBy7(7)));
```

### Defining Parameterized Matchers with Macros

Use the `MATCHER_P` family of macros for quicker definition when your matcher has parameters:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "") {
  return (arg % divisor) == 0;
}
```

Benefits:
- Compact and readable
- Automatic integration with GoogleMock matcher system
- Allows custom failure messages referencing parameters

---

## Writing Custom Actions

Actions specify what a mock function should do when invoked. If built-in actions don’t meet your needs, custom actions can perform arbitrary side effects or return computed results.

### Basic Custom Action

Create a functor (class or lambda) with a compatible call operator matching your mock function's signature:

```cpp
struct MultiplyBy {
  int factor;

  int operator()(int x) const {
    return x * factor;
  }
};

EXPECT_CALL(mock, Foo)
    .WillOnce(MultiplyBy{5});  // On invocation, returns argument * 5
```

### Using Lambdas as Actions

Lambdas are often the easiest way to create inline custom actions:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce([](int x) { return x * 10; });
```

### Parameterized Actions (Legacy Macro Approach)

For actions with parameters, use `ACTION_P`, `ACTION_P2`, ..., up to 10 parameters:

```cpp
ACTION_P(Add, n) {
  return arg0 + n;
}

EXPECT_CALL(mock, Foo(_))
    .WillOnce(Add(10));  // Returns arg0 + 10
```

### Advanced Custom Actions with Templates

For precise control, implement `ActionInterface<F>`, where `F` is the mocked function signature:

```cpp
template <typename F>
class ActionInterface {
 public:
  virtual ~ActionInterface() = default;
  virtual typename Function<F>::Result Perform(
      const typename Function<F>::ArgumentTuple& args) = 0;
};
```

Use `MakeAction()` helper to create an `Action<F>` from your implementation.

### Polymorphic Actions

If your action can be used with different mock method signatures, define a polymorphic action by providing a template `Perform<Result, ArgumentTuple>()` method on your implementation class, and create it with `MakePolymorphicAction()`.

Example:

```cpp
class ReturnSecondArgumentAction {
 public:
  template <typename Result, typename ArgumentTuple>
  Result Perform(const ArgumentTuple& args) const {
    return std::get<1>(args);
  }
};

PolymorphicAction<ReturnSecondArgumentAction> ReturnSecondArgument() {
  return MakePolymorphicAction(ReturnSecondArgumentAction());
}
```

Usage:

```cpp
EXPECT_CALL(mock, Foo).WillOnce(ReturnSecondArgument());
```

---

## Practical Examples

### Custom Matcher Example: Check if an integer is a perfect square

```cpp
MATCHER(IsPerfectSquare, "checks if number is a perfect square") {
  int root = static_cast<int>(std::sqrt(arg));
  return root * root == arg;
}

EXPECT_CALL(mock, ProcessValue(IsPerfectSquare()));
```

### Custom Action Example: Set a flag and return a value

```cpp
struct SetFlagAndReturn {
  bool* flag;
  int return_value;

  int operator()() {
    *flag = true;
    return return_value;
  }
};

bool flag = false;
EXPECT_CALL(mock, Compute())
    .WillOnce(SetFlagAndReturn{&flag, 42});
```


---

## Best Practices and Tips

- Always provide informative descriptions in matchers for better diagnostics.
- Use parameterized matchers and actions to improve reuse and clarity.
- When an action has state, avoid sharing its instance across multiple expectations unless intended.
- Retire expectations when appropriate using `.RetiresOnSaturation()` to avoid sticky expectations.
- Prefer lambdas for simple actions to reduce boilerplate.

---

## Troubleshooting & Common Pitfalls

- **Matcher execution side-effects:** Matchers must be *pure functions* without side effects. Don't call mock methods inside matchers.
- **Action ownership and lifetime:** Actions passed to `WillOnce` or `WillRepeatedly` are copied or moved. Ensure lifetimes of referenced objects exceed the action's use.
- **Compilation errors with complex types:** Use type aliases or wrap comma-containing types in parentheses in `MOCK_METHOD` declarations.
- **Unintended expectation shadowing:** Newer expectations override older ones; order your `EXPECT_CALL`s from general to specific accordingly.
- **Retiring expectations:** If an expectation should not persist after being used, use `.RetiresOnSaturation()` to avoid unexpected failures.

---

## Next Steps & Related Documentation

- Learn more about [EXPECT_CALL](reference/mocking.md#EXPECT_CALL) and [ON_CALL](reference/mocking.md#ON_CALL).
- Extend your understanding of [Matchers](reference/matchers.md) for argument validation.
- Explore [Actions](reference/actions.md) for specifying mock behaviors.
- Consult [gMock Cookbook](docs/gmock_cook_book.md) for advanced usage patterns and recipes.
- Understand [Strict, Nice, and Naggy mocks](guides/real-world-mocking/strictness-modes) for controlling uninteresting call behavior.

---

## Summary

default

This guide has outlined how to define custom matchers and actions within GoogleMock, enabling you to tailor test verifications and behaviors precisely for your application’s needs. By leveraging matcher classes, parameterized macros, functional-style actions, and polymorphic templates, you can create robust, readable, and maintainable test suites.

---

## Additional Resources

* [GoogleMock Cheatsheey](docs/gmock_cheat_sheet.md)
* [Actions Reference](docs/reference/actions.md)
* [Mocking Reference](docs/reference/mocking.md)
* [gMock Cookbook](docs/gmock_cook_book.md)
* [Using the ON_CALL and EXPECT_CALL Macros](docs/reference/mocking.md#EXPECT_CALL and ON_CALL)

---



