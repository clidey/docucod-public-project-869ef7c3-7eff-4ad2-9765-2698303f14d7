---
title: "Complex Expectations and Actions"
description: "Walks through setting up advanced expectations and mock actions, such as sequencing, custom behaviors, repeated calls, and composite actions. Focuses on ON_CALL, EXPECT_CALL, and using the wide array of action utilities available in GoogleMock."
---

# Complex Expectations and Actions

This guide walks you through mastering advanced features of GoogleMock for setting up sophisticated expectations and mock behaviors. You'll learn how to sequence calls, customize mock actions, handle repeated calls, and combine actions to create comprehensive and maintainable test behaviors using `ON_CALL`, `EXPECT_CALL`, and a rich set of action utilities.

---

## Workflow Overview

### What This Guide Helps You Accomplish

You will learn how to define complex mock expectations and actions, harness gMock's syntax to express call sequences, manage default and repeated behaviors, and implement custom or composite actions to finely control your mocks' runtime behavior.

### Prerequisites

- Familiarity with basic GoogleMock usage including creating mock classes and setting simple expectations via `EXPECT_CALL` and default behaviors with `ON_CALL`.
- Basic understanding of matchers and actions.

### Expected Outcome

By following this guide, you will be able to:
- Express ordered, partial ordered, and dependent sequences of calls.
- Use actions to return values, invoke functions, modify arguments, and execute side effects.
- Combine multiple actions in one expectation.
- Handle advanced scenarios such as delegating to fakes or real objects.

### Time Estimate

Approximately 15-30 minutes to read and experiment with code examples.

### Difficulty Level

Intermediate to Advanced

---

## Step-by-Step Instructions

### 1. Setting Up Complex Expectations with `EXPECT_CALL`

GoogleMock uses `EXPECT_CALL` to specify expected calls on mock methods. Complex scenarios can be expressed by combining various clauses:

- `.Times()` to specify call count cardinality.
- `.InSequence()` and `InSequence` objects to enforce order among calls.
- `.After()` to specify dependencies between expectations.
- `.With()` to constrain the entire argument list as a whole.

#### Example: Using `InSequence` to Ensure Order

```cpp
using ::testing::InSequence;
using ::testing::Return;

InSequence seq;  // All expectations within this scope must be called in order

EXPECT_CALL(mock, Init()).WillOnce(Return(true));
EXPECT_CALL(mock, Execute(42)).WillOnce(Return(100));
EXPECT_CALL(mock, Cleanup()).WillOnce(Return());
```

This ensures that `Init()`, then `Execute(42)`, then `Cleanup()` occur in this order.

#### Example: Using `.After()` for Partial Order

```cpp
using ::testing::Expectation;

Expectation e1 = EXPECT_CALL(mock, Start());
Expectation e2 = EXPECT_CALL(mock, Setup()).After(e1);
EXPECT_CALL(mock, Run()).After(e1, e2);
```

Call to `Setup()` must happen after `Start()`, and `Run()` happens after both.

### 2. Using `ON_CALL` to Specify Default Actions

`ON_CALL` defines default behavior for a mock method without setting expectations. Use it to specify what your mock should do when no explicit expectation matches.

```cpp
ON_CALL(mock, GetValue())
    .WillByDefault(Return(42));
```

This causes calls to `GetValue()` without matching `EXPECT_CALL` to return `42`.

### 3. Defining Mock Actions

Actions define what a mock method does when invoked. Common actions include:

- `Return(value)` returns the given value.
- `ReturnRef(variable)` returns a reference to a variable.
- `ReturnPointee(pointer)` returns the value pointed by a pointer at call time.
- `SetArgPointee<N>(value)` sets an output argument by pointer.
- `Invoke(function_or_lambda)` invokes a function or lambda with the mock call arguments.
- `DoAll(action1, action2, ..., actionN)` runs multiple actions in order.

#### Example: Returning Different Values on Consecutive Calls

```cpp
EXPECT_CALL(mock, Foo())
    .WillOnce(Return(1))
    .WillOnce(Return(2))
    .WillRepeatedly(Return(3));
```

Returns 1 first call, 2 second call, then always 3.

#### Example: Setting Output Arguments and Returning a Value

```cpp
using ::testing::DoAll;
using ::testing::Return;
using ::testing::SetArgPointee;

EXPECT_CALL(mock, FillBuffer(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

Sets the first argument pointed-to value to 42 and returns true.

### 4. Combining Actions with `DoAll()`

Chain multiple side effects and return values:

```cpp
EXPECT_CALL(mock, Process(_, _))
    .WillOnce(DoAll(
        SaveArg<0>(&saved_arg),  // Save the first argument
        SetArgPointee<1>(10),   // Set the second argument to 10
        Return(true)            // Return true from the call
    ));
```

### 5. Delegating Calls to Fakes or Real Implementations

If you have a fake or real implementation to reuse inside your mock, delegate to it using lambdas:

```cpp
class FakeFoo : public Foo {
 public:
  char DoThis(int n) { ... }
  void DoThat(const char* s, int* p) { ... }
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(char, DoThis, (int n), (override));
  MOCK_METHOD(void, DoThat, (const char* s, int* p), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault([this](int n) { return fake_.DoThis(n); });
    ON_CALL(*this, DoThat).WillByDefault([this](const char* s, int* p) { fake_.DoThat(s, p); });
  }

 private:
  FakeFoo fake_;
};
```

### 6. Using Matchers for Complex Argument Matching

Use matchers in `EXPECT_CALL` or `ON_CALL` to specify argument constraints:

```cpp
EXPECT_CALL(mock, Foo(Ge(5), NotNull()));
EXPECT_CALL(mock, Bar(_, ElementsAre(1, 2, 3)));
```

For matching all arguments as a tuple, use `.With()`:

```cpp
EXPECT_CALL(mock, Func(_, _)).With(Lt());  // First arg < second arg
```

### 7. Working with Overloaded Methods and Const-qualified Methods

Specify which overload to mock and expect by fully declaring signatures and using `Const()` for const methods:

```cpp
MOCK_METHOD(int, GetValue, (), (const, override));
EXPECT_CALL(Const(mock), GetValue()).WillOnce(Return(5));
```

If a method is overloaded, prefer listing all overloads mocked or use `using BaseClass::Method;` in the mock.

### 8. Handling Uninteresting and Unexpected Calls

- **Uninteresting calls:** Calls without any matching `EXPECT_CALL`. They do not cause test failures by default but generate warnings.
- **Unexpected calls:** Calls with arguments not matching any expectation. They cause test failures.

To suppress uninteresting call warnings, instantiate your mock as `NiceMock<YourMock>`.
To treat uninteresting calls as errors, use `StrictMock<YourMock>`.

### 9. Verifying and Resetting Mocks Manually

You can verify and clear a mock's expectations before destruction:

```cpp
using ::testing::Mock;
Mock::VerifyAndClearExpectations(&mock);
Mock::VerifyAndClear(&mock); // Also clears default actions
```

Do **not** set new expectations after clearing.

---

## Examples & Code Samples

```cpp
#include <gmock/gmock.h>
using ::testing::*;

class MockService {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));
  MOCK_METHOD(void, Reset, (), (override));
};

TEST(ServiceTest, ComplexExpectationExample) {
  MockService mock;

  // Setup default behavior
  ON_CALL(mock, Compute(_)).WillByDefault(Return(0));

  // Setup sequence
  {
    InSequence seq;
    EXPECT_CALL(mock, Reset())
        .WillOnce(Return());
    EXPECT_CALL(mock, Compute(42))
        .WillOnce(Return(100));
    EXPECT_CALL(mock, Compute(100))
        .WillOnce(Return(200));
  }

  mock.Reset();      // Must be called first
  EXPECT_EQ(mock.Compute(42), 100);   // Then compute 42
  EXPECT_EQ(mock.Compute(100), 200);  // Then compute 100
}

// Delegating calls example
class FakeCalc {
 public:
  int Calculate(int n) { return n * 2; }
};

class MockCalc {
 public:
  MOCK_METHOD(int, Calculate, (int n), (override));

  void DelegateToFake() {
    ON_CALL(*this, Calculate(_))
      .WillByDefault([this](int n) { return fake_.Calculate(n); });
  }

 private:
  FakeCalc fake_;
};

TEST(CalcTest, DelegatesToFake) {
  MockCalc mock;
  mock.DelegateToFake();

  EXPECT_CALL(mock, Calculate(3));

  EXPECT_EQ(mock.Calculate(3), 6);  // Delegated to fake
  EXPECT_EQ(mock.Calculate(4), 8);  // Delegated to fake
}

// Action combining example
TEST(MockActionTest, DoAllAction) {
  MockService mock;

  int out_param = 0;

  EXPECT_CALL(mock, Compute(_))
      .WillOnce(
          DoAll(SetArgPointee<0>(123),  // Set output argument
                Return(1)));           // Return value

  int input = 0;
  EXPECT_EQ(mock.Compute(input), 1);
  EXPECT_EQ(input, 123);
}

// Using .With() for matching multiple arguments
TEST(MultiArgMatchTest, UseWithClause) {
  MockService mock;

  EXPECT_CALL(mock, Compute(_, _))
      .With(Lt());  // First argument < second argument

  // Provided in mock as Compute(int, int)
}
```

---

## Troubleshooting & Tips

### Common Issues

- **Warning on uninteresting calls:** If you see warnings about uninteresting calls, ensure you either add expectations if calls should be verified or use `NiceMock` to suppress warnings.
- **Upper bound violation:** If a mock function is called more times than allowed by `Times()`, you'll get failures. To avoid, use `RetiresOnSaturation()` or carefully adjust your cardinalities.
- **Ambiguous overloads:** When mocking overloaded functions, fully specify each overload or use `using` declarations to avoid hiding base class methods.

### Best Practices

- Use `ON_CALL` to specify common default behavior shared by tests.
- Use specific `EXPECT_CALL` in tests only when you want to verify calls.
- Use sequences for strict ordering; otherwise, rely on flexible matching.
- Retire expectations (`RetiresOnSaturation()`) to avoid sticky matching that causes excessive call failures.

### Performance Considerations

- Move mock class constructors and destructors out of headers to `.cc` files to speed up compilation.

### Alternative Approaches

- For complex interfaces with many parameters, consider redesigning the interface or adding wrapper methods to simplify mocking.

---

## Next Steps & Related Content

- Explore [Defining Custom Matchers and Mock Methods](/guides/mocking-masterclass/custom-matchers-mocks) to extend matching capabilities.
- Read [Mock Strictness: Nice, Naggy, and Strict Mocks](/guides/mocking-masterclass/mock-class-strictness) to better manage uninteresting call behavior.
- Study [Using Assertions Effectively](/guides/writing-effective-tests/assertions-best-practices) to improve test writing.
- Dive into [Advanced Matching Techniques](/guides/writing-effective-tests/advanced-matchers) for deeper control.

---

## References

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Mocking Reference](reference/mocking.md)
- [Actions Reference](reference/actions.md)
- [Matchers Reference](reference/matchers.md)
- [Legacy gMock FAQ](https://google.github.io/googletest/gmock_faq.html)

---