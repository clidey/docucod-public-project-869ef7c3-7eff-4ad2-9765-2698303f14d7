---
title: "Defining Custom Matchers and Mock Methods"
description: "Guidance on writing domain-specific matchers and tailoring mock methods to reflect your API, including usage and extension of MOCK_METHOD macros. Teaches techniques for intricate argument verification and behavior injection."
---

# Defining Custom Matchers and Mock Methods

This guide provides comprehensive instructions for creating domain-specific matchers and customizing mock methods in GoogleMock. It covers the use of the `MOCK_METHOD` macro to define mock methods that reflect your APIs precisely, along with advanced techniques for verifying complex arguments and injecting behavior.

---

## 1. Overview
### What You Will Achieve
- Learn how to define mock methods tailored to your specific function signatures, including handling constness, noexcept, and calling conventions.
- Understand how to create custom argument matchers to validate intricate or domain-specific argument properties.
- Master advanced usage of `EXPECT_CALL` and `ON_CALL` macros to set precise expectations and default behaviors on your mocks.

### Prerequisites
- Familiarity with basic GoogleMock concepts such as mock classes, `EXPECT_CALL`, and matchers.
- A mock class skeleton or interface you want to define mocks for.
- Basic C++ knowledge, especially about virtual functions, const methods, and move-only types.

### Expected Outcome
By the end of this guide, you will be able to:
- Define mock methods in your classes that accurately represent your API's contracts.
- Define complex conditional argument matching beyond simple equality or wildcards.
- Customize mock method behaviors with chained action clauses.

### Time Estimate
20-40 minutes depending on familiarity with GoogleMock.

### Difficulty Level
Intermediate to Advanced

---

## 2. Defining Mock Methods with `MOCK_METHOD`
GoogleMock provides the macro `MOCK_METHOD` to define mock methods inside your mock classes. It simplifies mocking virtual methods by generating boilerplate code.

### Basic Syntax
```cpp
MOCK_METHOD(return_type, method_name, (args...), (specifiers));
```

- `return_type`: The return type of the method being mocked.
- `method_name`: The name of the mock method.
- `(args...)`: Parenthesized list of argument types.
- `(specifiers)`: Optional method qualifiers such as `const`, `override`, `noexcept`, calling conventions, and reference qualifiers.

### Example: Basic Mock Class
```cpp
class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
  MOCK_METHOD(void, GoTo, (int x, int y), (override));
};
```

### Handling Types with Commas
Argument or return types containing commas—such as templated types—need parentheses or type aliases:
```cpp
using BoolInt = std::pair<bool, int>;
using MapIntDouble = std::map<int, double>;

class MockFoo {
 public:
  MOCK_METHOD((BoolInt), GetPair, ());
  MOCK_METHOD(bool, CheckMap, ((MapIntDouble), bool));
};
```

### Qualifiers
When overriding methods, include relevant qualifiers:
- **`const`** if the original method is `const`.
- **`override`** to mark as an override.
- **`noexcept`** if the method is marked `noexcept`.
- **`Calltype(...)`** for specifying calling conventions on platforms like Windows.
- Reference qualifiers: `ref(&)`, `ref(&&)` if applicable.

Example with qualifiers:
```cpp
MOCK_METHOD(int, Compute, (int x) , (const, override, noexcept));
```

### Mocking Private or Protected Methods
Declare mock methods in the `public:` section regardless of the base class access:
```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(void, Resume, (), (override));  // Base method was protected
  MOCK_METHOD(int, GetTimeout, (), (override));  // Base method was private
};
```

### Mocking Overloaded Methods
Simply mock each overload explicitly:
```cpp
MOCK_METHOD(int, Add, (int x), (override));
MOCK_METHOD(int, Add, (int times, Element x), (override));
MOCK_METHOD(const Bar&, GetBar, (), (const, override));
MOCK_METHOD(Bar&, GetBar, (), (override));
```
Use `using BaseClass::Method;` to unhide overloads if not mocked.

### Mocking Class Templates
Templates are mocked as normal classes:
```cpp
template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Push, (const T& x), (override));
};
```

### Mocking Non-Virtual Methods
You can mock non-virtual methods for dependency injection by creating unrelated mock classes with the same method signatures (omit `override`).

---

## 3. Setting Expectations and Default Actions
### Using `EXPECT_CALL` for Expectations
Expect that a mock method will be called meeting certain criteria:
```cpp
EXPECT_CALL(mock_obj, Method(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

Key points:
- If you omit `.Times()`, cardinality is inferred.
- Use matchers `_` or specific conditions to match arguments.
- Chain multiple `.WillOnce()` for sequential behavior.
- Use `.WillRepeatedly()` for persistent default return/behavior.

Example:
```cpp
EXPECT_CALL(mock_turtle, Forward(Ge(100)))
    .Times(AtLeast(1));

EXPECT_CALL(mock_turtle, GetX())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillRepeatedly(Return(30));
```

### Using `ON_CALL` for Default Behaviors
Sets default behavior for calls without setting expectations:
```cpp
ON_CALL(mock_obj, Method(matchers...))
    .WillByDefault(action);
```
Often used in test fixture setup to provide fallback behaviors.

**Tip:** Use `ON_CALL` for common behaviors and reserve `EXPECT_CALL` for verification.

---

## 4. Crafting Custom Matchers
Sometimes built-in matchers aren't enough for your domain-specific conditions.

### Defining Custom Matchers with `MATCHER` Macros
Use the `MATCHER` family of macros for easy matcher creation.

#### Basic Matcher
```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

EXPECT_CALL(mock, Foo(IsEven()));
```

#### Parameterized Matcher
```cpp
MATCHER_P(IsDivisibleBy, divisor, "checks divisibility") {
  return arg % divisor == 0;
}

EXPECT_CALL(mock, Foo(IsDivisibleBy(5)));
```

### Defining Matcher Classes Manually
For complex matchers, implement the matcher interface:
```cpp
class PrefixMatcher {
 public:
  explicit PrefixMatcher(std::string prefix) : prefix_(std::move(prefix)) {}

  template <typename T>
  bool MatchAndExplain(const T& value, std::ostream* listener) const {
    return value.compare(0, prefix_.length(), prefix_) == 0;
  }

  void DescribeTo(std::ostream* os) const { *os << "starts with " << prefix_; }
  void DescribeNegationTo(std::ostream* os) const {
    *os << "does not start with " << prefix_;
  }

 private:
  std::string prefix_;
};

inline testing::Matcher<std::string> StartsWith(const std::string& prefix) {
  return testing::MakeMatcher(new PrefixMatcher(prefix));
}
```

---

## 5. Complex Argument Verification
### Using `With` Clause
Match against argument tuples holistically:
```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(testing::Lt())  // first arg less than second
    .Times(1);
```

### Using Composite Matchers
Combine matchers with `AllOf()`, `AnyOf()`, `Not()`:
```cpp
EXPECT_CALL(mock, Foo(AllOf(Gt(5), Ne(10))));
```

### Validating Members or Properties
Use `Field()` or `Property()` to validate object fields or getter results:
```cpp
EXPECT_CALL(mock, Process(testing::Field(&User::id, Eq(42))));
EXPECT_CALL(mock, Process(testing::Property(&User::Name, StartsWith("John"))));
```

### Matching Pointer Values
Use `Pointee()` to match the value pointed to:
```cpp
EXPECT_CALL(mock, Foo(testing::Pointee(Gt(0))));
```

---

## 6. Injecting Behavior into Mock Methods
### Using `WillOnce` and `WillRepeatedly`
Specify the behavior of mock methods when called:
```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(Return(42))
    .WillRepeatedly(Return(0));
```

### Using Lambdas or Callable Objects
Implement complex logic inline:
```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce([](int x) { return x * 2; });
```

### Combining Multiple Actions
Use `DoAll()` to chain actions:
```cpp
EXPECT_CALL(mock, Mutate(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

### Handling Move-Only Types
Simply declare mock methods normally and use lambdas for behavior:
```cpp
MOCK_METHOD(std::unique_ptr<Buzz>, MakeBuzz, (StringPiece text), (override));
EXPECT_CALL(mock_buzzer, MakeBuzz(_))
    .WillRepeatedly([](StringPiece text) {
      return std::make_unique<Buzz>(AccessLevel::kInternal);
    });
```

---

## 7. Tips and Best Practices
- Always declare mock methods in the `public:` section.
- Use `ON_CALL` for default behaviors; reserve `EXPECT_CALL` to set expectations you intend to verify.
- When mocking overloaded methods, mock each overload explicitly and consider using `using` declarations to avoid hiding base methods.
- For methods with complex or numerous parameters, consider redispatching to simpler internal mock methods to make tests easier.
- Use `RetiresOnSaturation()` on chained `WillOnce()` expectations to avoid sticky expectation issues.
- Prefer sequences or multiple `WillOnce()` calls within a single expectation to express ordered calls.
- For mock methods returning references, use `ReturnRef()` instead of `Return()`.
- When matching complex arguments, choose matchers that reflect the precise conditions under test to avoid brittle tests.

<Info>
Note: Over-specifying expectations may lead to brittle tests and increased maintenance. Prefer specifying only needed properties in matchers and use wildcards (`_`) when unconcerned.
</Info>

---

## 8. Troubleshooting Common Issues

### Compilation Errors with `MOCK_METHOD`
- Check for argument types containing commas; wrap such types in parentheses or use type aliases.

### Overloaded Method Ambiguity
- Explicitly mock each overload to avoid ambiguity.
- Use `using BaseClass::Method;` to bring in overloads if some are not mocked.

### Uninteresting Call Warnings
- If a mock method is called without an `EXPECT_CALL`, GoogleMock will warn unless you suppress it using `NiceMock` or add a catch-all expectation with `Times(AnyNumber())`.

### Unexpected Calls
- Occur when mock methods are invoked with arguments that don't match any expectation.
- Reconsider your expectations and verify argument matchers.

### Issues with Move-Only Types
- Use lambdas or callable objects in `WillOnce`/`WillRepeatedly` to generate move-only return values.

### Action Constraints
- `SetArgPointee()` must be combined with `Return()` or other actions using `DoAll()` if the mock function has a non-void return type.

---

## 9. Next Steps & Related Content

- **Core Concepts & Terminology** - Understand foundational ideas behind mocking and assertions.
- **Mocking Basics Guide** - For introduction and getting started in writing mocks.
- **Advanced Matching Techniques** - Learn to build sophisticated matchers for precise tests.
- **Complex Expectations and Actions** - Deep dive into managing elaborate mock method behaviors and expectations flows.
- **Mock Strictness** - Position your mocks between Nice, Naggy, and Strict behaviors for best test resilience.
- **Writing Your First Test** - Practice applying mocks in a test scenario.

Explore [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for practical recipes and examples to enhance your mocking skills.

---