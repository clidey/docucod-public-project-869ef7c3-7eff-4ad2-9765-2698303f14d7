---
title: "Using Matchers for Flexible Expectations"
description: "Gain a deep understanding of built-in and custom matchers for argument matching and expectations. Walk through scenarios using standard and advanced matchers, ensuring tests are precise yet robust against brittle changes."
---

# Using Matchers for Flexible Expectations

## Overview

Matchers in GoogleMock provide powerful yet flexible ways to specify the arguments expected for mock method calls. They act as predicates that test the value or property of each argument, enabling you to write precise expectations without over-constraining your tests. This guide walks you through the use of built-in matchers, creating custom matchers, and applying advanced matcher composition techniques.

---

## 1. Why Use Matchers?

When setting expectations on mock methods, you often care about certain aspects of the arguments rather than their exact values. Matchers allow you to express those constraints succinctly:

- Match exact values
- Match by range or condition
- Match parts of complex objects
- Compose multiple matchers for sophisticated criteria

By using matchers, your tests become more robust against irrelevant changes and clearer to read.

---

## 2. Built-in Matchers: Common Use Cases

GoogleMock provides a rich set of predefined matchers that cover most day-to-day scenarios.

### 2.1 Wildcard Matcher: `_`

Matches any argument regardless of its value.

```cpp
EXPECT_CALL(mock_obj, DoSomething(_));  // Accepts any argument value
```

### 2.2 Equality Matchers

Exact match using `Eq(value)` or shorthand by passing a literal/value directly.

```cpp
EXPECT_CALL(mock_obj, ProcessData(Eq(5)));    // Matches calls with 5
EXPECT_CALL(mock_obj, ProcessData(5));         // Same as above
```

### 2.3 Comparison Matchers

Use `Gt()`, `Lt()`, `Ge()`, `Le()`, `Ne()` for relational comparisons.

```cpp
EXPECT_CALL(mock_obj, SetLevel(Ge(10)));   // Number >= 10
EXPECT_CALL(mock_obj, SetLevel(Lt(5)));    // Number < 5
```

### 2.4 String Matchers

- `StrEq()`: Case-sensitive equality
- `StrCaseEq()`: Case-insensitive equality
- `HasSubstr()`: Matches if substring is present
- `StartsWith()`, `EndsWith()`: Match string prefixes/suffixes

```cpp
EXPECT_CALL(mock_obj, Log(StrCaseEq("error")));  // Case-insensitive "error"
EXPECT_CALL(mock_obj, Message(HasSubstr("critical")));
```

### 2.5 Container Matchers

Matchers that validate container elements, for example:

- `ElementsAre(...)`: Matches sequences with exact elements in order.
- `UnorderedElementsAre(...)`: Elements must match but order is irrelevant.
- `Contains(...)`: Checks if container contains an element matching the matcher.

```cpp
EXPECT_CALL(mock_obj, ReceiveData(ElementsAre(1, 2, 3)));
EXPECT_CALL(mock_obj, ReceiveData(Contains(Ge(2))));  // Container contains an element >=2
```

### 2.6 Pointer Matchers

- `IsNull()`: Matches null pointers.
- `NotNull()`: Matches non-null pointers.
- `Pointee(m)`: Dereference pointer and check value with matcher `m`.

```cpp
EXPECT_CALL(mock_obj, SetPointer(IsNull()));
EXPECT_CALL(mock_obj, SetPointer(Pointee(Ge(10))));
```

### 2.7 Ref Matcher

Matches exact reference to a variable.

```cpp
int x = 42;
EXPECT_CALL(mock_obj, Process(Ref(x)));  // Matches argument referring to 'x'
```

---

## 3. Composing Matchers

### 3.1 Logical Combinators

- `AllOf(...)`: All matchers must match
- `AnyOf(...)`: At least one matcher must match
- `Not(m)`: Negates matcher `m`

```cpp
EXPECT_CALL(mock_obj, SetValue(AllOf(Ge(10), Lt(20))));  // Value in [10, 20)
EXPECT_CALL(mock_obj, SetFlag(AnyOf(Eq('A'), Eq('B'))));
EXPECT_CALL(mock_obj, SetLevel(Not(0)));
```

### 3.2 Multi-argument Matchers with `.With()`

`EXPECT_CALL` supports `.With(multi_arg_matcher)` to match tuple of all arguments.

```cpp
EXPECT_CALL(mock_obj, SetPosition(_, _))
    .With(Lt());  // First argument less than second
```

### 3.3 Field and Property Matchers

You can match specific members or properties of complex objects:

- `Field(&Class::member, matcher)` - matches member variable
- `Property(&Class::method, matcher)` - matches const getter property

```cpp
EXPECT_CALL(mock_obj, ProcessData(Field(&Data::id, Eq(42))));
EXPECT_CALL(mock_obj, ProcessData(Property(&Data::GetName, HasSubstr("foo"))));
```

### 3.4 Tuple and Pair Matchers

Matchers that work with tuples and pairs, enabling field-wise validation.

- `Pair(matcher_first, matcher_second)` matches a `std::pair`.
- `FieldsAre(...)` matches tuple or aggregate fields in order.

```cpp
EXPECT_CALL(mock_obj, ProcessMap(Contains(Pair(Ge(10), StartsWith("val")))));
EXPECT_CALL(mock_obj, ProcessTuple(FieldsAre(Eq(1), HasSubstr("foo"))));
```

### 3.5 Custom Predicates with `Truly()`

Allows you to use an arbitrary predicate function or functor.

```cpp
bool IsEven(int n) { return n % 2 == 0; }
EXPECT_CALL(mock_obj, ProcessData(Truly(IsEven)));
```

---

## 4. Writing Custom Matchers

For advanced or domain-specific needs, you can define your own matchers.

### 4.1 Using `MATCHER` Macros

The simplest way to define a matcher:

```cpp
MATCHER(IsDivisibleBy7, "") {
  return (arg % 7) == 0;
}

// Usage
EXPECT_CALL(mock_obj, ProcessData(IsDivisibleBy7()));
```

### 4.2 Parameterized Matchers

Matchers accepting parameters using `MATCHER_P`, `MATCHER_P2`, ...

```cpp
MATCHER_P(InRange, range, "checks if arg is in range") {
  return arg >= 0 && arg <= range;
}

EXPECT_CALL(mock_obj, SetLevel(InRange(10)));
```

### 4.3 Advanced Matchers

For greater control, implement matchers by deriving from GoogleMock’s `MatcherInterface`. This allows complex logic, better error messages, and explanation support.

See the [gMock Cookbook - New Matchers](gmock_cook_book.md#NewMatchers) for detailed examples.

---

## 5. Best Practices and Troubleshooting

### 5.1 Use the Right Matcher Granularity

Avoid over-specifying expectations. Match only what matters for the tested behavior.

### 5.2 Use `_` for Uninteresting Arguments

If an argument is not critical to your test, use `_` to keep your test robust.

### 5.3 Beware of Overlapping Expectations

Since `EXPECT_CALL`s are matched in reverse order, put more specific matchers after general ones.

### 5.4 Suppress Uninteresting Call Warnings

Use `NiceMock<>` wrappers if you want to suppress warnings about mock calls without expectations.

### 5.5 Debugging Matches

Run tests with the `--gmock_verbose=info` flag to get detailed information on matcher evaluations.

### 5.6 Handling Overloaded and Template Methods

Use explicit disambiguation techniques, like specifying the exact method signature, or use `Const()` for const overloads.

### 5.7 Casting Matchers

Use `SafeMatcherCast<T>(m)` if you need to convert matcher `m` to match arguments of type `T` safely.

---

## 6. Summary Example

```cpp
#include <gmock/gmock.h>
using ::testing::_;          // wildcard matcher
using ::testing::Eq;         // equality matcher
using ::testing::Ge;         // >= matcher
using ::testing::StartsWith; // string matcher

class MockFoo {
 public:
  MOCK_METHOD(void, Process, (int value, const std::string& name), (override));
};

TEST(FooTest, Example) {
  MockFoo mock;

  // Expect 'Process' called with value >= 10 and name starting with "foo"
  EXPECT_CALL(mock, Process(Ge(10), StartsWith("foo")));

  // Call that matches expectation
  mock.Process(15, "foobar");
}
```

---

## 7. Additional Resources

- [Matchers Reference](https://google.github.io/googletest/gmock_reference.html#matchers)
- [gMock Cookbook – Writing New Matchers](gmock_cook_book.md#NewMatchers)
- [Understanding Uninteresting vs Unexpected Calls](gmock_cook_book.md#uninteresting-vs-unexpected)
- [Mocking Patterns & Advanced Use Cases](guides/mocking-scenarios/using-matchers)

---