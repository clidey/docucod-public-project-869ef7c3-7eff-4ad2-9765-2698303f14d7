---
title: "Advanced Mock Behaviors and Actions"
description: "Explore GoogleMock’s expressive features for arranging complex behaviors, using action templates, custom matchers, and call sequences. Learn to verify call orders, use cardinalities, and assert complex call patterns."
---

# Advanced Mock Behaviors and Actions

Explore GoogleMock’s expressive features for arranging complex mock behaviors, composing actions, defining custom matchers, and asserting call sequences. This guide empowers you to orchestrate intricate interactions within your tests using GoogleMock's powerful syntax.

---

## 1. Introduction

This guide delves into advanced GoogleMock capabilities that let you define complex mock behaviors beyond simple return values and call counts. You'll learn how to:

- Specify sequences and partial orders of calls.
- Use action templates and combine actions effectively.
- Write custom matchers and parameterized matchers.
- Control expectation cardinalities precisely.
- Organize and verify call orders using sequences and dependencies.

By mastering these features, you can write tests that closely model real-world interactions and edge cases.

---

## 2. Organizing Calls with Sequences and Order Constraints

GoogleMock lets you specify the order in which mocked functions should be called using the following tools:

### 2.1 Sequence Objects

- Create one or more `Sequence` instances to define linear order constraints.
- Attach expectations to sequences with `.InSequence(sequence1, sequence2, ...)`.
- Calls belonging to the same sequence must occur in the order the expectations were set.

#### Example:
```cpp
using ::testing::Sequence;

Sequence s1, s2;

EXPECT_CALL(mock, Reset())
    .InSequence(s1, s2);
EXPECT_CALL(mock, GetSize())
    .InSequence(s1);
EXPECT_CALL(mock, Describe())
    .InSequence(s2);
```
This means that `Reset()` is expected before both `GetSize()` and `Describe()`, but `GetSize()` and `Describe()` can be called in any order relative to each other.

### 2.2 Anonymous Sequence via `InSequence` Object

- Wrapping `EXPECT_CALL`s within a scope of `InSequence` automatically adds them to a hidden sequence enforcing strict order.

```cpp
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

### 2.3 Ordering via `.After()` Clause

- Use `.After(expectations...)` to specify that a call must come after one or more other expectations or expectation sets.

Example with multiple prerequisites:

```cpp
using ::testing::Expectation;
Expectation e1 = EXPECT_CALL(mock, InitX());
Expectation e2 = EXPECT_CALL(mock, InitY());

EXPECT_CALL(mock, Describe())
    .After(e1, e2);
```

This asserts that `Describe()` is only called after both `InitX()` and `InitY()` calls have happened.

### 2.4 Combining Sequences and After

- You can mix `.InSequence()` and `.After()` to model partial orders with dependencies.
- Use `ExpectationSet` to group multiple expectations for `.After()` clauses.

### 2.5 Retiring Expectations with `.RetiresOnSaturation()`

- By default, expectations remain active even after their upper call limits are reached (sticky).
- Use `.RetiresOnSaturation()` to automatically retire an expectation once saturated, allowing other expectations to match later calls.

```cpp
EXPECT_CALL(mock, SetNumber(7))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, SetNumber(_))
    .Times(::testing::AnyNumber());
```
Here, after `SetNumber(7)` is called twice, the first expectation retires, and subsequent `SetNumber(7)` calls fall through to the catch-all expectation.

---

## 3. Defining Complex Mock Behaviors Using Actions

Actions define what the mock should do when a method is called.

### 3.1 Built-in Actions

- `Return(value)`: Return a value (copy taken at expectation setup).
- `ReturnRef(variable)`: Return a reference to a variable.
- `ReturnPointee(pointer)`: Return value pointed to by a pointer at call time.
- `DoDefault()`: Perform the default action (if any).
- `SetArgPointee<N>(value)`: Set the `N`th argument’s pointee to `value`.
- `DoAll(a1, a2, ...)`: Perform multiple actions sequentially; returns the last action’s result.
- `Invoke(callable)`: Invoke a callable with the mock’s arguments.
- `InvokeWithoutArgs(callable)`: Invoke a callable with no arguments.
- `InvokeArgument<N>(args...)`: Invoke the `N`th argument (callable) with `args`.
- `Throw(exception)`: Throw an exception when the mock function is called.

### 3.2 Combining Actions

Use `DoAll()` to chain side effects and return values succinctly.

```cpp
EXPECT_CALL(mock, DoSomething())
    .WillOnce(DoAll(SetArgPointee<0>(value), Return(true)));
```

### 3.3 Custom Actions

Write your own actions using:

- Lambdas or functors with call operators.
- The legacy `ACTION(name) { ... }` macro to define an action at namespace scope.
- `ACTION_P` macros to create parameterized actions.

Example:
```cpp
ACTION_P(IncrementArg1, n) {
  return *arg1 + n;
}
```

### 3.4 Move-Only Types

- GoogleMock supports move-only parameters and return types.
- Use lambdas or `WillOnce()`/`WillRepeatedly()` with move-aware callables.

### 3.5 Using Functions and Lambdas as Actions

- Use `Invoke()` to call existing functions or member functions.
- Use `InvokeWithoutArgs()` when the action ignores the mock method's arguments.

Example:
```cpp
EXPECT_CALL(mock, Compute(_, _))
    .WillOnce(Invoke(&MyClass::ComputeImpl, &my_object));
```

---

## 4. Setting Default Behaviors with `ON_CALL`

- Use `ON_CALL(mock, Method(matchers))` to specify behavior without enforcing call expectations.
- Chain `.WillByDefault(action)` to set the default behavior.

Example:
```cpp
ON_CALL(mock, Compute(_))
    .WillByDefault(Return(42));
```

- Precedence: `EXPECT_CALL` actions override `ON_CALL` defaults.
- `ON_CALL` can be used with `.With()` clause to apply multi-argument matchers.

---

## 5. Using Cardinalities and `Times()` Clause

Cardinalities specify *how many times* a mock method should be called.

| Cardinality        | Meaning                                                       |
|--------------------|---------------------------------------------------------------|
| `AnyNumber()`      | The method can be called any number of times.                  |
| `AtLeast(n)`       | At least *n* calls allowed.                                    |
| `AtMost(n)`        | At most *n* calls allowed.                                     |
| `Between(m, n)`    | Between *m* and *n* calls inclusive.                          |
| `Exactly(n)` or `n`| Exactly *n* calls required; zero means call must never happen. |

- Omitting `Times()` infers the cardinality based on `WillOnce()` and `WillRepeatedly()` clauses.
- Use `Times(0)` to mark that a method call should **never** happen.

---

## 6. Writing Custom Matchers

### 6.1 Purpose

Custom matchers let you express argument constraints that built-in matchers don’t cover.

### 6.2 Creating a Matcher

- Use `MATCHER(name, desc) { ... }` for simple matchers.
- Use `MATCHER_P(name, param, desc) { ... }` for parameterized matchers.

#### Basic Example
```cpp
MATCHER(IsDivisibleBy7, "") {
    return (arg % 7) == 0;
}
```

You can use it as:
```cpp
EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

### 6.3 Matcher Interface Requirements

Custom matchers implement:
- `MatchAndExplain(arg, os)` returning `bool` indicating match success.
- `DescribeTo(os)` describing expected behavior.
- `DescribeNegationTo(os)` describing negation.

### 6.4 Polymorphic Matchers

- Implement template methods to allow matching arguments of multiple types.

---

## 7. Controlling Mock Strictness with `NiceMock`, `NaggyMock`, and `StrictMock`

- **`NiceMock<T>`**: suppresses warnings for uninteresting calls.
- **`NaggyMock<T>`**: (default) warns on uninteresting calls.
- **`StrictMock<T>`**: fails tests on uninteresting calls.

Example:
```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> nice_mock;
```

- These wrappers inherit the constructors of the underlying mock class.
- Use them based on how strict you want your test to be about uninteresting calls.

---

## 8. Verifying and Resetting Expectations

- `Mock::VerifyAndClearExpectations(&mock_obj)` verifies and clears expectations but keeps default actions.
- `Mock::VerifyAndClear(&mock_obj)` verifies and clears all expectations and default actions.
- Call these methods before destroying mocks if you want deterministic verification.

---

## 9. Practical Tips and Best Practices

- Set expectations **before** exercising the mock.
- Use `.RetiresOnSaturation()` to prevent sticky expectation errors.
- Use sequences to enforce call order only when necessary.
- Use parameterized matchers to make complex argument checks concise.
- Delegate default actions with `ON_CALL` to reduce redundancies.
- Prefer `NiceMock` for tests where uninteresting calls are common and harmless.
- Call `Mock::AllowLeak()` if you intentionally want to leak a mock.

---

## 10. Example: Ordered Return Values With Retiring Expectations

```cpp
using ::testing::InSequence;
using ::testing::Return;

Sequence s;

EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(1))
    .RetiresOnSaturation()
    .InSequence(s);
EXPECT_CALL(mock, GetNumber())
    .WillOnce(Return(2))
    .RetiresOnSaturation()
    .InSequence(s);
EXPECT_CALL(mock, GetNumber())
    .WillRepeatedly(Return(3))
    .InSequence(s);

// Calls to mock.GetNumber() must returns 1, then 2, then 3 for all subsequent calls
```

---

## 11. References and Further Reading

- [Mocking Reference](../../docs/reference/mocking.md)
- [gMock Cheat Sheet](../../docs/gmock_cheat_sheet.md)
- [gMock Cookbook](../../docs/gmock_cook_book.md)
- [Defining Mocks](../../api-reference/mocking-framework/defining-mocks.md)
- [Setting Expectations](../../api-reference/mocking-framework/setting-expectations.md)
- [Strictness & Mock Behavior Modifiers](../../api-reference/mocking-framework/strictness-and-behavior-modifiers.md)

---

Embrace these advanced GoogleMock behaviors to precisely model your C++ object interactions, gain solid control over testing scenarios, and create reliable, understandable, and maintainable tests.


