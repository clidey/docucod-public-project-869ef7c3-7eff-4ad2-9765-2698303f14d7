---
title: "Creating and Using Mocks"
description: "Comprehensive instructions for defining mock classes, using the MOCK_METHOD macro, setting up expectations, and verifying interactions. Tackle real-world examples such as dependency injection and interface mocking."
---

# Creating and Using Mocks

This guide provides comprehensive instructions for defining mock classes using GoogleMock, applying the `MOCK_METHOD` macro, setting up expectations to verify interactions, and effectively using mocks in typical test scenarios. You will also find practical examples illustrating dependency injection and interface mocking.

---

## 1. Introduction to Mocks

Mock objects simulate behavior of real objects, allowing you to test interactions precisely without involving real dependencies. GoogleMock enables you to declaratively define mock classes that implement the same interfaces as production classes with minimal effort.

**Key benefits of using mocks:**
- Control over method call expectations (how many times, with which arguments)
- Ability to specify return values and side effects
- Enhanced test reliability by isolating dependencies
- Verification of interaction order and conditions

---

## 2. Defining a Mock Class

### 2.1 Basic Mock Class Setup

To create a mock class, derive it from the interface or base class you want to mock and declare each virtual method using the `MOCK_METHOD` macro inside the `public:` section.

```cpp
#include <gmock/gmock.h>  // Required for GoogleMock macros

class FooInterface {
 public:
  virtual ~FooInterface() = default;
  virtual int GetSize() const = 0;
  virtual void Process(const std::string& data) = 0;
};

class MockFoo : public FooInterface {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Process, (const std::string& data), (override));
};
```

**Important:** Always place `MOCK_METHOD` declarations in the `public:` section, even if the original function is `protected` or `private`. This makes the mock functions accessible for setting expectations.

### 2.2 Handling Complex Types with Commas

If your method's return type or argument type contains commas (e.g., template types), surround the type with extra parentheses or use type aliases:

```cpp
class MyMock {
 public:
  MOCK_METHOD((std::pair<int, bool>), GetPair, ());
  // Or using type alias
  using IntBoolPair = std::pair<int, bool>;
  MOCK_METHOD(IntBoolPair, GetPair, ());
};
```

### 2.3 Mocking Overloaded Methods

GoogleMock supports mocking overloaded methods. Declare each overload using `MOCK_METHOD`. If you mock some but not all overloads, bring the rest into scope using `using` to avoid hiding:

```cpp
class Base {
 public:
  virtual int Func(int x) = 0;
  virtual int Func(double x) = 0;
  virtual ~Base() = default;
};

class MockBase : public Base {
 public:
  using Base::Func;  // Bring other overloads into scope
  MOCK_METHOD(int, Func, (int x), (override));
  MOCK_METHOD(int, Func, (double x), (override));
};
```

### 2.4 Mocking Class Templates

You can mock class templates by templating your mock class and mocking methods as usual:

```cpp
template <typename T>
class StackInterface {
 public:
  virtual ~StackInterface() = default;
  virtual void Push(const T& elem) = 0;
  virtual T Pop() = 0;
};

template <typename T>
class MockStack : public StackInterface<T> {
 public:
  MOCK_METHOD(void, Push, (const T& elem), (override));
  MOCK_METHOD(T, Pop, (), (override));
};
```

### 2.5 Mocking Non-virtual Methods (High-Perf Dependency Injection)

For classes without virtual methods, you can mock independently with no inheritance. Use the same `MOCK_METHOD` syntax but omit `override`:

```cpp
class Concrete {
 public:
  void DoWork(int x);
  int GetValue() const;
};

class MockConcrete {
 public:
  MOCK_METHOD(void, DoWork, (int x));
  MOCK_METHOD(int, GetValue, (), (const));
};
```

Use templates or dependency injection in production and test code to swap the real vs mock implementations.

---

## 3. Using `MOCK_METHOD`

The `MOCK_METHOD` macro defines mocked methods with mock behavior. 

**Basic usage:**

```cpp
MOCK_METHOD(ReturnType, MethodName, (Args...), (Qualifiers));
```

- `ReturnType`: method return type
- `MethodName`: method name
- `(Args...)`: argument type list in parentheses
- `(Qualifiers)`: optional method qualifiers like `const`, `override`, `noexcept`, or calling convention specifiers

**Example:**

```cpp
MOCK_METHOD(std::string, GetName, (), (const, override));
MOCK_METHOD(void, Update, (int id, const std::string& data), (override));
```

**Qualifiers explained:**
- `const`: for methods declared `const`
- `override`: recommended for overriding virtual methods
- `noexcept`: if base method is marked `noexcept`
- `Calltype(...)`: set calling convention, e.g., `Calltype(STDMETHODCALLTYPE)` on Windows
- `ref(&)` or `ref(&&)`: reference qualifiers

---

## 4. Setting Expectations and Behaviors

Mocks verify expected interactions via the `EXPECT_CALL` macro where you specify:
- Which mock method will be called
- How many times it should be called
- Which arguments it should be called with
- What it should return or do when called

### 4.1 Basic Expectation Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `mock_object`: instance of the mock class
- `MethodName(matchers)`: method and argument matchers (
  use `_` for wildcard matcher)
- `.Times(...)`: how many times the method is expected
- `.WillOnce(...)`: specify behavior for the next matching call
- `.WillRepeatedly(...)`: specify behavior for all subsequent calls

### 4.2 Example: Setting Return Values

```cpp
using ::testing::Return;

EXPECT_CALL(mock_foo, GetSize())
    .Times(3)
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillOnce(Return(30));

int size1 = mock_foo.GetSize();  // returns 10
int size2 = mock_foo.GetSize();  // returns 20
int size3 = mock_foo.GetSize();  // returns 30
```

### 4.3 Argument Matchers

GoogleMock provides a rich set of matchers for argument validation:
- `_`: wildcard (matches any value)
- `Eq(value)`: matches arguments equal to `value`
- Comparison matchers: `Ge()`, `Le()`, `Gt()`, `Lt()`
- Pointer matchers: `NotNull()`, `IsNull()`, `Pointee(matcher)`
- Container matchers: `ElementsAre()`, `UnorderedElementsAre()`, etc.

Example matching any argument:

```cpp
EXPECT_CALL(mock_foo, Process(_));
```

### 4.4 Setting Default Behavior with `ON_CALL`

If you want to specify how a mock method behaves by default (when no explicit expectation matches), use `ON_CALL`:

```cpp
ON_CALL(mock_foo, GetSize()).WillByDefault(Return(5));
```

This doesn't require that the method must be called but defines what happens if it is.

### 4.5 Controlling Call Counts

Common cardinalities include:
- `Times(Exactly(n))` or `.Times(n)`: called exactly n times
- `Times(AtLeast(n))`: at least n times
- `Times(AtMost(n))`: at most n times
- `Times(AnyNumber())`: any number of times

If `Times()` is omitted, it is inferred from the actions provided.

### 4.6 Specifying Call Order

- Use `InSequence` to enforce a strict call order between expectations.

```cpp
{
  ::testing::InSequence s;
  EXPECT_CALL(mock_foo, Foo(1));
  EXPECT_CALL(mock_foo, Foo(2));
}
```

- Use `.After()` and `.InSequence()` clauses to express partial orders.

### 4.7 Complex Behaviors with Actions

Actions specify what the mock method does when called. Common actions include:
- `Return(value)`: return fixed value
- `ReturnRef(variable)`: return reference
- `Invoke(function_or_lambda)`: call custom function or lambda
- `DoAll(...)`: perform several actions in order
- `SetArgPointee<index>(value)`: set output parameter pointed by argument at index

Examples:

```cpp
using ::testing::Return;
EXPECT_CALL(mock_foo, GetName()).WillRepeatedly(Return("mocked"));

EXPECT_CALL(mock_foo, Update(_, _))
    .WillOnce(::testing::DoAll(SetArgPointee<1>(42), Return()));

EXPECT_CALL(mock_foo, ComputeValue(_))
    .WillOnce([](int x){ return x * 2; });
```

---

## 5. Working With Different Mock Strictness Levels

GoogleMock provides three strictness modifiers for mocks to control handling of uninteresting calls:

- `NiceMock<T>`: suppresses warnings about uninteresting calls
- `NaggyMock<T>`: prints warnings (default behavior)
- `StrictMock<T>`: treats uninteresting calls as test failures

Example:

```cpp
NiceMock<MockFoo> nice_mock;  // Ignores unexpected calls.
StrictMock<MockFoo> strict_mock;  // Fails on unexpected calls.
```

Use strict mocks only when you want very precise control or to catch unexpected interactions.

---

## 6. Practical Example: Mocking and Testing with Dependency Injection

Suppose you want to test a `Painter` class that draws using a `Turtle` interface.

### 6.1 Defining the Interface and Mock

```cpp
class Turtle {
 public:
  virtual ~Turtle() {}
  virtual void PenUp() = 0;
  virtual void PenDown() = 0;
  virtual void Forward(int distance) = 0;
  virtual int GetX() const = 0;
};

class MockTurtle : public Turtle {
 public:
  MOCK_METHOD(void, PenUp, (), (override));
  MOCK_METHOD(void, PenDown, (), (override));
  MOCK_METHOD(void, Forward, (int distance), (override));
  MOCK_METHOD(int, GetX, (), (const, override));
};
```

### 6.2 Using the Mock in Tests

```cpp
using ::testing::AtLeast;
using ::testing::_;
using ::testing::Return;

TEST(PainterTest, DrawsCircle) {
  MockTurtle turtle;

  EXPECT_CALL(turtle, PenDown()).Times(AtLeast(1));
  EXPECT_CALL(turtle, Forward(_)).Times(AtLeast(1));
  ON_CALL(turtle, GetX()).WillByDefault(Return(100));

  Painter painter(&turtle);
  EXPECT_TRUE(painter.DrawCircle(0, 0, 10));
}
```

This test verifies that `PenDown()` and `Forward()` are called correctly when drawing a circle.

---

## 7. Verification and Clearing Mocks

- All expectations on mocks are automatically verified when the mock object is destroyed.
- You can force verification earlier using:

```cpp
::testing::Mock::VerifyAndClearExpectations(&mock_obj);
```

- To clear both expectations and default actions:

```cpp
::testing::Mock::VerifyAndClear(&mock_obj);
```

- Avoid setting new expectations on a mock after verifying and clearing to prevent undefined behavior.

---

## 8. Troubleshooting & Best Practices

### 8.1 Common Pitfalls

- **Expectation Ordering:** Set all `EXPECT_CALL`s before exercising mocks, or behavior is undefined.
- **Uninteresting Calls:** If you don't want warnings on uninteresting calls, use `NiceMock` or add a catch-all `EXPECT_CALL` with `.Times(AnyNumber())`.
- **Return Types:** For reference return types, use `ReturnRef()`. For live values, use `ReturnPointee()`.
- **Commas in Types:** Wrap complex types with parentheses or define type aliases when using `MOCK_METHOD`.
- **Virtual Destructors:** Ensure base interfaces have virtual destructors to prevent leaks or incorrect behavior.

### 8.2 Tips for Effective Mocking

- Mock only interfaces you own or define adaptor interfaces.
- Use `ON_CALL` for default behavior and `EXPECT_CALL` only where you want verification.
- Use sequences to specify call order clearly.
- Combine actions with `DoAll()` when multiple side effects are needed.
- Explore rich matcher APIs for precise argument validation.

---

## 9. Additional Resources

For deeper understanding and advanced scenarios, see:

- [Mocking Reference](reference/mocking.md): detailed mock constructs and APIs
- [gMock Cheat Sheet](gmock_cheat_sheet.md): quick reference with examples
- [gMock Cookbook](gmock_cook_book.md): practical recipes and patterns
- [Strictness, Nice, and Naggy Mocks](guides/mocking-scenarios/strictness-and-nice-mocks.md): strictness controls

---

## 10. Summary

Creating and using mocks with GoogleMock involves:

- Defining mock classes with `MOCK_METHOD` macro
- Setting up expectations using `EXPECT_CALL` and optionally default behaviors with `ON_CALL`
- Using argument matchers to precisely specify called argument constraints
- Controlling number and order of calls via cardinalities and sequences
- Managing mock lifecycles with verification and clearing

This page is a central resource to master realistic mocking scenarios with GoogleMock.


---

## References

- [GoogleMock GitHub Repository](https://github.com/google/googletest/tree/main/googlemock)
- Related Documentation:
  - [gMock for Dummies](gmock_for_dummies.md)
  - [gMock Cookbook](gmock_cook_book.md)
  - [Mocking Reference](reference/mocking.md)
  - [Actions Reference](reference/actions.md)
  - [Matchers Reference](reference/matchers.md)
