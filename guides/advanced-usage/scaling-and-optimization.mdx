---
title: "Scaling, Performance, and Parallelism"
description: "Strategies for speeding up test execution, scaling to large test suites, utilizing parallelism, and optimizing build and run time. Covers tools and configurations to maintain fast feedback loops even as codebases and test suites grow."
---

# Scaling, Performance, and Parallelism

## Overview
This guide presents practical strategies and techniques to speed up your GoogleTest suite execution, scale efficiently to large test bases, and leverage parallelism and optimization features. You'll learn how to configure and utilize test sharding, parallel test runners, test filtering, and other best practices aimed at maintaining fast feedback cycles in growing projects.

---

## 1. Understanding Test Execution Performance

As your codebase and test suite grow, the time needed to build and run tests can increase substantially. To avoid slowing down your development workflow, it is crucial to adopt techniques that reduce overhead and exploit hardware capabilities.

### Key Considerations
- **Build Time vs. Run Time:** Optimize both your test compilation setup and test runtime execution.
- **Test Granularity:** Avoid overly large tests that block large portions of your suite and instead write smaller, isolated tests for better parallelism.
- **Dependency Isolation:** Use GoogleMock and test fixtures to isolate dependencies, reducing test runtime variability.

<Tip>
Starting with small, fast tests and incrementally scaling testing can help maintain responsiveness and spot bottlenecks early.
</Tip>

---

## 2. Leveraging Parallelism

### Running Tests in Parallel
GoogleTest supports running multiple tests in parallel to fully utilize CPU cores and speed up the feedback.

#### How to Utilize Parallelism

1. **Use `gtest-parallel` tool:** This external tool executes your test binary multiple times in parallel, splitting tests across workers to maximize CPU usage.

2. **Set environment variables for sharding:**
   - `GTEST_TOTAL_SHARDS`: Number of shards (workers) to split the tests into.
   - `GTEST_SHARD_INDEX`: The index of the current shard/run (zero-based).

3. **Run the test binary on each shard with correct environment variables set.** GoogleTest automatically selects tests to run for each shard.

##### Example:
```bash
export GTEST_TOTAL_SHARDS=4
export GTEST_SHARD_INDEX=0
./your_test_binary &

export GTEST_SHARD_INDEX=1
./your_test_binary &

export GTEST_SHARD_INDEX=2
./your_test_binary &

export GTEST_SHARD_INDEX=3
./your_test_binary &
wait
```

#### Benefits
- Divides tests evenly, ensuring every test runs exactly once across shards.
- Enables horizontal scaling by running shards on multiple machines.

<Note>
Sharding requires your tests to be independent and thread-safe.
</Note>

---

### Using `gtest-parallel`
[gtest-parallel](https://github.com/google/gtest-parallel) is a Python script that wraps your test executable and runs its tests concurrently with built-in test balancing and retries.

#### Setup and Usage
1. Clone the repository or install the tool.
2. Run your test binary with:
   ```bash
   gtest-parallel ./your_test_binary --worker_thread_count=NUMBER_OF_CORES
   ```

3. Optionally customize retries, timeouts, and other flags as needed.

#### Advantages
- Automatic test distribution with retry for flaky tests.
- Runs tests concurrently without modifying test code.

---

## 3. Test Filtering and Execution Control

To gain performance benefits by avoiding irrelevant tests, use test filtering and selective execution.

### Test Filtering
- Use `--gtest_filter` flag to specify patterns of tests to run or exclude.
  - Pattern syntax:
    - `*` matches any sequence of characters
    - `?` matches a single character
    - Separate multiple patterns with colons (`:`).

- Example: Run tests with names containing `Network` but exclude `NetworkSlow`:
  ```bash
  ./your_test_binary --gtest_filter=*Network*-*NetworkSlow*
  ```

### Running Disabled Tests
- Disabled tests have `DISABLED_` prefix in their names and are skipped by default.
- To include disabled tests, set the flag `--gtest_also_run_disabled_tests`.

### Stop on First Failure
- Use the flag `--gtest_fail_fast` to stop test execution immediately after the first failure, reducing overall run time when debugging.

---

## 4. Optimizing Build and Run Time

GoogleTest performance is also influenced by build configuration and test design.

### Build Optimization
- Compile tests with optimization flags matching your project.
- Use precompiled headers and incremental builds.

### Test Code Best Practices
- Write small, focused tests to maximize parallelization.
- Reuse expensive setup via test suite fixtures (`SetUpTestSuite()` and `TearDownTestSuite()`).
- Avoid global mutable state and external dependencies that cause unwanted serialization.

### Leveraging Test Suites and Fixtures
- Proper use of test fixtures to share setup and teardown improves performance by avoiding redundant work.
- Example:
```cpp
class DatabaseTest : public ::testing::Test {
 protected:
  static void SetUpTestSuite() {
    shared_db_connection_ = OpenDatabaseConnection();
  }
  static void TearDownTestSuite() {
    CloseDatabaseConnection(shared_db_connection_);
  }
  static DatabaseConnection* shared_db_connection_;
};
DatabaseConnection* DatabaseTest::shared_db_connection_ = nullptr;

TEST_F(DatabaseTest, QueryTest1) {
  EXPECT_TRUE(shared_db_connection_->Query("SELECT ..."));
}
```

---

## 5. Managing Multi-threaded Tests

GoogleTest and GoogleMock are thread-safe when enabled. However, care is needed when using threading alongside testing.

- Use the `GTEST_IS_THREADSAFE` macro to check if GoogleTest is compiled with thread support.
- Avoid races and shared mutable state in tests.
- Monitor failure reporting from multiple threads.
- Use the provided StressTest examples from GoogleTest and GoogleMock for verifying thread safety.

<Tip>
Ensure your environment (compiler, platform) supports multithreading and you run GoogleTest with thread-safety enabled for reliable multi-threaded tests.
</Tip>

---

## 6. Monitoring and Diagnosing Performance

Measure your test suite's time with options:
- Use the `--gtest_print_time=1` flag (default) to print elapsed time per test.
- Profile slow tests and refactor or split them.

Collect execution data for continuous monitoring.

---

## 7. Practical Example: Running Tests in Parallel With Sharding

Assume you have a test binary `foo_test` containing 1000 tests.

### Step 1: Decide number of parallel shards, e.g., 4.

### Step 2: Run 4 parallel instances with appropriate environment variables:

```bash
for i in {0..3}; do
  export GTEST_TOTAL_SHARDS=4
  export GTEST_SHARD_INDEX=$i
  ./foo_test &
 done
wait
```

### Step 3: Collect and aggregate results from all shards.

If your CI or test runner supports it, you can distribute shards across machines.

### Step 4: Use gtest-parallel for simpler orchestration:

```bash
gtest-parallel ./foo_test --worker_thread_count=4
```

---

## 8. Troubleshooting Common Issues

<AccordionGroup title="Troubleshooting">
<Accordion title="Tests Not Running in Parallel">
Verify `gtest-parallel` script usage or correct setting of `GTEST_TOTAL_SHARDS` and `GTEST_SHARD_INDEX`.
</Accordion>
<Accordion title="Test Failures Only on Parallel Runs">
Check for shared global state or unsafe concurrency.

Use GoogleMock and fixture isolation.
</Accordion>
<Accordion title="Build Times Are Slow">
Use build system caching, incremental builds, and limit test compilation units.
</Accordion>
<Accordion title="Sharding Skips Tests Od You Expect">
Confirm no filtering conflicts and that shard indices are in 0..N-1 range.
</Accordion>
</AccordionGroup>

---

## 9. Summary
- Use `gtest-parallel` or environment variables `GTEST_TOTAL_SHARDS`/`GTEST_SHARD_INDEX` to run tests in parallel.
- Filter and selectively run tests to reduce feedback time.
- Organize tests with fixtures and share setup to optimize execution.
- Monitor test times and diagnose bottlenecks.
- Validate thread-safety when running parallel or multi-threaded tests.

---

## 10. Additional Resources

- [GoogleTest Primer](https://google.github.io/googletest/primer.html) - basics of GoogleTest usage.
- [gtest-parallel GitHub](https://github.com/google/gtest-parallel) - parallel test runner tool.
- [GoogleTest Advanced Topics](../advanced.md) - detailed info on flags, fixtures, and assertions.
- [Mocking and Matcher Features](../../overview/feature-summary/mocking-and-matchers.mdx) - for mock testing strategies.

---

For continuous integration, consider integrating these approaches with your build and test automation pipelines to maximize scalability and maintain fast feedback.

---

# Appendix: Minimal Parallel Test Example
```bash
# Run your tests across 2 shards
export GTEST_TOTAL_SHARDS=2
export GTEST_SHARD_INDEX=0
./your_test_binary &

export GTEST_TOTAL_SHARDS=2
export GTEST_SHARD_INDEX=1
./your_test_binary &

wait
```