---
title: "Custom Assertions & Extending Matchers"
description: "Shows how to implement custom assertion macros and extend GoogleMock with user-defined matchers. Enables advanced users to tailor the frameworks to fit unique domain requirements."
---

# Custom Assertions & Extending Matchers

This guide empowers advanced GoogleMock users to implement custom assertion macros and extend GoogleMock's matcher capabilities. It reveals how to create user-defined matchers tailored to unique domain requirements, enabling precise and expressive test validations beyond the built-in set.

---

## Why Extend GoogleMock with Custom Assertions and Matchers?

As your testing needs evolve, you often require assertions that capture specific logic or constraints germane to your application domain. Rather than contorting built-in matchers to fit these needs, crafting custom matchers:

- Enhances test expressiveness and clarity
- Reduces repetitive test code and boilerplate
- Improves failure messages with domain-specific explanations

By writing custom assertions and matchers, you tailor GoogleMock to validate your code with exact intent, making your tests both robust and maintainable.

---

## Overview of Custom Assertions & Matchers

Custom matchers in GoogleMock can be created using several approaches, ranging from simple macros for quick cases to full-fledged polymorphic matcher classes for reusable, template-friendly matchers. Custom assertions wrap these matchers for convenient use within your tests.

### Matchers

GoogleMock matchers are separate from expectations but serve as the core building block for argument validation:

- **Custom Matcher Macros (`MATCHER` and `MATCHER_P`)**: Quick, concise matchers with embedded logic and customized failure strings.
- **Matcher Classes**: Explicit classes implementing the matcher interface for advanced behavior and polymorphism.
- **Composite Matchers**: Build matchers from sub-matchers to capture complex argument relationships.

### Assertions

Assertions like `EXPECT_THAT` utilize matchers to test values. Custom assertions help encapsulate commonly repeated `EXPECT_THAT` usage for domain-specific checks.

---

## Implementing Custom Matchers

### 1. Using `MATCHER` Macro for Basic Matchers

For simple, predicate-based validations, `MATCHER` macros provide a succinct way to define matchers that have automatic failure descriptions.

```cpp
MATCHER(IsEven, "checks if a number is even") {
  return (arg % 2) == 0;
}

// Usage:
EXPECT_CALL(mock_object, Func(IsEven()));
EXPECT_THAT(value, IsEven());
```

The `arg` variable holds the value being matched, and the matcher returns a boolean indicating success.

**Best Practice:** Add informative failure messages by streaming additional context to the `result_listener` argument.

### 2. Parameterized Matchers with `MATCHER_P`

If your matcher needs user-supplied parameters, `MATCHER_P` enables parameterization:

```cpp
MATCHER_P(IsDivisibleBy, divisor, "checks divisibility") {
  return (arg % divisor) == 0;
}

// Usage:
EXPECT_CALL(mock_object, Func(IsDivisibleBy(5)));
```

You may define up to 10 parameters with `MATCHER_P`, `MATCHER_P2`, ..., `MATCHER_P10`.

### 3. Writing Matcher Classes for Advanced Use Cases

For more control or reusable polymorphic matchers, implement a matcher class:

```cpp
class IsPositiveMatcher {
 public:
  using is_gtest_matcher = void;  // Required marker

  template <typename T>
  bool MatchAndExplain(const T& value, std::ostream* os) const {
    bool result = value > 0;
    if (!result && os != nullptr) {
      *os << "which is " << value << ", not positive";
    }
    return result;
  }

  void DescribeTo(std::ostream* os) const { *os << "is positive"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is not positive"; }
};

inline ::testing::Matcher<int> IsPositive() {
  return ::testing::MakePolymorphicMatcher(IsPositiveMatcher());
}

// Usage:
EXPECT_THAT(5, IsPositive());
```

This approach supports pattern matching for multiple types with customized messages.

### 4. Composite Matchers

You can create matchers that rely on other matchers, allowing complex validation logic.

```cpp
MATCHER_P(StartsAndEndsWith, substr, "string starts and ends with substr") {
  return ::testing::StartsWith(substr).MatchAndExplain(arg, nullptr) &&
         ::testing::EndsWith(substr).MatchAndExplain(arg, nullptr);
}
```

### 5. Writing Custom Actions

Although outside the direct scope, similar techniques apply for creating custom actions to define the behavior of mocked methods.

---

## Creating Custom Assertion Macros

Custom assertion macros wrap matchers with convenient syntax for your project’s domain:

```cpp
#define EXPECT_IS_EVEN(val) EXPECT_THAT(val, IsEven())
#define ASSERT_DIVISIBLE_BY(val, divisor) ASSERT_THAT(val, IsDivisibleBy(divisor))
```

Use them like standard GoogleTest assertions:

```cpp
EXPECT_IS_EVEN(x);
ASSERT_DIVISIBLE_BY(y, 3);
```

This encapsulates test intent clearly and facilitates reuse.

---

## Practical Tips & Best Practices

- Use `ON_CALL` to set default behaviors without enforcing call expectations.
- Prefer `EXPECT_CALL` only when you want to verify calls.
- Always put `MOCK_METHOD`s in `public:` sections regardless of base class visibility.
- For overloaded methods, mock all overloads or use `using` statements to avoid warnings.
- When using matchers inside composite matchers, ensure all are pure functions without side effects.
- When matching move-only types (like `std::unique_ptr`), use lambdas as return actions.
- Use `NiceMock` to suppress uninteresting call warnings, `StrictMock` to convert warnings to failures selectively.

---

## Common Pitfalls

- **Unprotected commas in types**: Wrap types with commas in extra parentheses or use type aliases.
- **Incorrect override qualifiers**: Always specify `(const, override)` when mocking const methods.
- **Expectations after verification**: Avoid setting expectations after verifying and clearing a mock.
- **Nesting NiceMock/StrictMock**: Not supported, can cause unexpected behavior.

---

## Verification & Cleanup

GoogleMock automatically verifies expectations when mocks are destructed. If needed, verify earlier using:

```cpp
::testing::Mock::VerifyAndClearExpectations(&mock_object);
```

Or allow exceptions by suppressing verification on leaked mocks for special cases.

---

## References & Next Steps

- Review the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for detailed recipes.
- Study the [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) for built-in matchers.
- Consult the [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html) for quick syntax reminders.
- After mastering custom matchers, explore creating mocks and setting expectations in `guides/getting-started/first-mock` and customizing behavior with `guides/essential-testing-patterns/mocking-best-practices`.

---

## Summary

Building robust tests tailored precisely to your application's needs becomes straightforward with GoogleMock's extensions for custom assertions and matchers. This guide equips you with practical methods and examples to author specialized checks that integrate seamlessly into your testing workflow.

---

## Sample Code Snippet: Defining and Using a Custom Matcher

```cpp
#include <gmock/gmock.h>

// Simple custom matcher that checks for even numbers
MATCHER(IsEven, "is an even number") {
  return (arg % 2) == 0;
}

// Parameterized matcher checking divisibility
MATCHER_P(IsDivisibleBy, divisor, "is divisible by given divisor") {
  return (arg % divisor) == 0;
}

class MockCalculator {
 public:
  MOCK_METHOD(int, Compute, (int));
};

TEST(CustomMatcherTest, UsesCustomMatcher) {
  MockCalculator calc;

  EXPECT_CALL(calc, Compute(IsEven()));
  EXPECT_CALL(calc, Compute(IsDivisibleBy(3)));

  EXPECT_THAT(calc.Compute(4), IsEven());        // passes
  EXPECT_THAT(calc.Compute(9), IsDivisibleBy(3)); // passes
}
```

---

## Additional Flags for Debugging and Tuning

GoogleMock supports flags to control its verbosity and behavior during testing:

- `--gmock_verbose=[info|warning|error]`: Control log verbosity for mock expectations and calls.
- `--gmock_catch_leaked_mocks=0|1`: Configure whether leaked mocks are reported.

These flags improve your debugging experience with detailed logs or concise output as preferred.

---

## Summary Diagram

```mermaid
flowchart TD
  A[Write Custom Matcher Class or Macro] --> B[Implement MatchAndExplain()]
  B --> C[Define DescribeTo() and DescribeNegationTo()]
  C --> D[Create Matcher Factory Function]
  D --> E[Use Matcher in EXPECT_CALL or EXPECT_THAT]
  E --> F[Tests Verify Custom Matcher Behavior]

  style A fill:#f9f,stroke:#333,stroke-width:2px
  style F fill:#9f9,stroke:#333,stroke-width:2px
```

---

If you encounter issues:

<Accordion title="Troubleshooting Custom Matchers">
- Verify the matcher does not cause side effects.
- Ensure your matcher class has the `is_gtest_matcher` typedef.
- For parameterized matchers, confirm descriptions include parameter values for clarity.
- Use lambdas or functors when dealing with move-only types.
</Accordion>

---

## Conclusion

Mastering custom assertions and matcher extensions unlocks GoogleMock’s fullest potential, letting you craft unit tests with precision and clarity tailored to your codebase’s unique semantics. This guide is your gateway to writing expressive, maintainable, and insightful tests.


---

For detailed API and usage examples, visit:
- [gMock Cheat Sheet](https://google.github.io/googletest/gmock_cheat_sheet.html)
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.html)
- [Writing First Mock Object](https://google.github.io/googletest/guides/getting_started.html#creating-your-first-mock-object)

