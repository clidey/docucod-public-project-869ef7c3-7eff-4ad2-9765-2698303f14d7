---
title: "Custom Matchers and Actions"
description: "A practical guide to creating and using custom matchers and actions. Learn to extend GoogleMock with your own predicates and behaviors to cover domain-specific test needs and make your tests more expressive."
---

# Custom Matchers and Actions

Extend your GoogleMock test suite by creating **custom matchers** and **custom actions**. This guide empowers you to expand gMock's expressive power, enabling domain-specific argument validations and bespoke mock behaviors beyond the built-in capabilities.

---

## Workflow Overview

### Task Description
Learn how to define and integrate your own matchers and actions in GoogleMock to test complex conditions on mock method arguments and control mock method behaviors with tailored responses.

### Prerequisites
- Familiarity with C++ and GoogleMock basics, including defining mocks with `MOCK_METHOD`.
- Understanding of `EXPECT_CALL`, `ON_CALL`, and built-in matchers and actions.
- A configured GoogleMock environment.

### Expected Outcome
By following this guide, you will:
- Create custom matchers that encapsulate specific argument validation logic.
- Implement advanced actions that can be used directly or parametrically in `EXPECT_CALL` and `ON_CALL`.
- Integrate custom matchers and actions to make tests more readable, maintainable, and precise.

### Time Estimate
Approximately 20-30 minutes to grasp key concepts and try practical examples.

### Difficulty Level
Intermediate.

---

## 1. Creating Custom Matchers

Matchers validate the arguments passed to mock methods. While GoogleMock provides many built-in matchers, custom matchers let you express domain-specific validations clearly and concisely.

### 1.1. Basic Custom Matcher Using the `MATCHER` Macro

The simplest way to write custom matchers is with the `MATCHER` macro. It defines a predicate that returns a boolean indicating success or failure of the match.

#### Example: Match Even Numbers
```cpp
MATCHER(IsEven, "Checks if a number is even") {
  return (arg % 2) == 0;
}

// Usage:
EXPECT_CALL(mock_object, Func(IsEven()));
```

The matcher name `IsEven()` is used inside expectations, and provides automatic failure descriptions.

### 1.2. Parameterized Matchers with `MATCHER_P`

You can parameterize matchers to accept arguments for flexible reuse.

#### Example: Match Values Equal to the Absolute Value
```cpp
MATCHER_P(HasAbsoluteValue, value, "") {
  return std::abs(arg) == value;
}

// Usage:
EXPECT_THAT(result, HasAbsoluteValue(10));
```

The description string can use the `negation` flag along with parameters to customize messages.

### 1.3. Advanced: Implementing Matcher Classes

For complex matchers, you may implement a class with `MatchAndExplain()`, `DescribeTo()`, and `DescribeNegationTo()` methods.

#### Minimal Structure
```cpp
class BarPlusBazEqMatcher {
 public:
  using is_gtest_matcher = void;
  explicit BarPlusBazEqMatcher(int expected_sum) : expected_sum_(expected_sum) {}

  bool MatchAndExplain(const Foo& foo, std::ostream* os) const {
    return (foo.bar() + foo.baz()) == expected_sum_;
  }

  void DescribeTo(std::ostream* os) const {
    *os << "bar() + baz() equals " << expected_sum_;
  }

  void DescribeNegationTo(std::ostream* os) const {
    *os << "bar() + baz() does not equal " << expected_sum_;
  }

 private:
  const int expected_sum_;
};

::testing::Matcher<const Foo&> BarPlusBazEq(int expected_sum) {
  return BarPlusBazEqMatcher(expected_sum);
}
```

Use this pattern for reusable, detailed matchers.

### 1.4. Important Notes for Matchers
- Matchers must be **pure functions**: no side effects or state changes.
- They should explain match failures in detail for easier debugging.
- You can compose matchers using built-in combinators like `AllOf`, `AnyOf`, and `Not`.

---

## 2. Creating Custom Actions

Actions define what happens when a mock method is called, such as returning values, invoking callbacks, or modifying output parameters.

### 2.1. Simple Custom Actions Using `ACTION` Macros

Define a custom action by writing an `ACTION` or `ACTION_P` macro, allowing you to specify the behavior.

#### Example: Increment an Argument Pointer (Argument #1)
```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}

// Usage:
EXPECT_CALL(mock_obj, Foo(_)).WillOnce(IncrementArg1());
```

### 2.2. Parameterized Custom Actions

Use `ACTION_P` and `ACTION_P2` for actions needing parameters.

#### Example: Add a Value to First Argument
```cpp
ACTION_P(Add, n) {
  return arg0 + n;
}

// Usage:
EXPECT_CALL(mock_obj, Foo(_)).WillOnce(Add(5));
```

### 2.3. Implementing ActionInterface for Advanced Cases

If you need fine control over the mock function signature, implement `ActionInterface<F>` directly, where `F` is the function type.

### 2.4. Polymorphic Actions

For actions usable with various function signatures, implement a class with a templated `Perform()` function and use `MakePolymorphicAction()`.

#### Example: Return the Second Argument
```cpp
class ReturnSecondArgumentAction {
 public:
  template <typename Result, typename ArgumentTuple>
  Result Perform(const ArgumentTuple& args) const {
    return std::get<1>(args);
  }
};

PolymorphicAction<ReturnSecondArgumentAction> ReturnSecondArgument() {
  return MakePolymorphicAction(ReturnSecondArgumentAction());
}

// Usage:
EXPECT_CALL(mock_obj, Foo).WillOnce(ReturnSecondArgument());
```

### 2.5. Using Lambdas and Callables as Actions

You can pass lambdas or callable objects directly to `WillOnce()` or `WillRepeatedly()`.

#### Example
```cpp
EXPECT_CALL(mock_obj, Foo(_))
    .WillOnce([](int x) { return x * 2; });
```

### 2.6. Composite Actions

- `DoAll(a1, a2, ..., an)`: Performs multiple actions sequentially; only last's return value is used.
- `IgnoreResult(action)`: Ignore the return value of a non-void action.
- `WithArg<N>(action)` and `WithArgs<N1, N2>(action)`: Pass selected argument(s) to inner action.
- `WithoutArgs(action)`: Perform action without arguments.

### 2.7. Invoking a Callable Argument

Use `InvokeArgument<N>(args...)` to invoke the Nth argument of the mock function if it is callable.

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(InvokeArgument<1>(5));
// Invokes the second argument with 5.
```

### 2.8. Tips on Writing Actions
- Actions are owned by gMock once installed; do not delete manually.
- When using stateful actions, be cautious about sharing the same action instance.

---

## 3. Practical Examples

### 3.1. Custom Matcher Example
```cpp
MATCHER_P(IsMultipleOf, factor, "Checks if argument is multiple of factor") {
  return arg % factor == 0;
}

TEST(MyTest, UsesCustomMatcher) {
  MockClass mock;
  EXPECT_CALL(mock, Foo(IsMultipleOf(3))).Times(2);

  mock.Foo(6);  // Matches
  mock.Foo(9);  // Matches
}
```

### 3.2. Custom Action Example
```cpp
ACTION_P(SetFlag, flag_ptr) {
  *flag_ptr = true;
  return true;  // Return for mock method with bool return type
}

TEST(MyTest, UsesCustomAction) {
  MockClass mock;
  bool flag = false;
  EXPECT_CALL(mock, Bar(_))
      .WillOnce(SetFlag(&flag));

  mock.Bar(42);
  EXPECT_TRUE(flag);  // Flag was set by the custom action
}
```

---

## 4. Troubleshooting & Tips

### Common Issues
- **Matcher Not Invoked/Silent Matches**: Ensure your matcher is **pure functional** and does not have hidden side effects.
- **Action Ownership Issues**: Always pass callable objects (lambdas or functors) by value; gMock takes ownership.
- **Confusing Match Failures**: Use detailed `DescribeTo()` and `MatchAndExplain()` to improve diagnostic output.

### Best Practices
- Favor `ON_CALL()` to set default mock behaviors and reserve `EXPECT_CALL()` for actual expectations.
- Be mindful of matcher evaluation cost; complex matchers might slow down tests.
- Use parameterized matchers and actions to avoid repetitive code.
- Use `RetiresOnSaturation()` when sequential expectations should not remain "sticky."

### Performance Considerations
- Custom actions that copy large objects may degrade performance; consider move semantics or references.
- Keep matchers lightweight; avoid heavy computations inside match predicates.

### Alternative Approaches
- Use built-in matchers like `Truly()` to wrap existing predicates for quick custom logic without full matcher class writting.
- Delegate mock method implementation to a real or fake object in your custom actions for tested behavior reuse.

---

## 5. Next Steps & Related Content

- Dive deeper into [Matchers Reference](../api-reference/mocking-api/matchers) to explore all built-in matchers.
- Learn about [Actions Reference](../api-reference/mocking-api/actions) for comprehensive action listings.
- Explore [Mocking Patterns and Mock Workflows](../guides/mocking-patterns) for practical mocking strategies.
- Advance to [Mock Strictness and Object Lifecycle](../guides/mocking-patterns/mock-strictness-lifecycle) to control mock behavior policies.
- Consult [gMock Cookbook](../docs/gmock_cook_book.md) for more recipes on custom matchers and actions.

---

## Summary
Custom matchers and actions are fundamental for expressing complex behaviors and validations in GoogleMock tests. By writing these, you tailor the mocking framework to your domain needs, making tests clearer, more maintainable, and robust.

<Tip>
For extensive examples and deeper understanding, always refer to the official [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) and [Matchers Reference](https://google.github.io/googletest/reference/matchers.html).
</Tip>