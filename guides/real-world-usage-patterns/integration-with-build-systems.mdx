---
title: "Integrating with CMake, Bazel, and CI"
description: "Demonstrates step-by-step integration of GoogleTest and GoogleMock into popular build systems like CMake and Bazel, and provides guidance for embedding test execution into continuous integration pipelines."
---

# Integrating GoogleTest and GoogleMock with CMake, Bazel, and Continuous Integration (CI)

This guide walks you through the practical steps needed to integrate GoogleTest and GoogleMock into your C++ projects using popular build systems like CMake and Bazel. Additionally, it provides guidance on embedding test execution into Continuous Integration (CI) pipelines to automate and streamline your testing workflow.

---

## 1. Workflow Overview

### Task Description
Learn how to integrate GoogleTest and GoogleMock into C++ projects using standalone or embedded CMake configurations, Bazel build workflows, and incorporate automated testing within CI environments.

### Prerequisites
- Familiarity with C++ project structure and basic build system usage.
- Installed CMake (version 3.13 or newer) and/or Bazel.
- Access to GoogleTest and GoogleMock source code.
- A CI system configured for your project (optional but recommended).

### Expected Outcome
After following this guide, you will:
- Successfully add GoogleTest and GoogleMock to your build setup.
- Build and link tests correctly with GoogleTest/GoogleMock libraries.
- Run tests locally and in CI.
- Understand customization options for integration.

### Time Estimate
Approximately 30–60 minutes depending on prior familiarity.

### Difficulty Level
Intermediate – assumes comfortable use of C++ build systems.

---

## 2. Step-by-Step Integration Instructions

### A. Integration with CMake

#### Step 1: Prepare Your Project
- **Clone or download** the GoogleTest repository, which includes GoogleMock by default.
- Create a directory inside your project for external dependencies or add it as a submodule.

#### Step 2: Add GoogleTest/GoogleMock to Your CMake Project
- Use CMake's `add_subdirectory()` to include GoogleTest and GoogleMock in your build.

Example snippet for your `CMakeLists.txt`:

```cmake
cmake_minimum_required(VERSION 3.13)
project(MyProject LANGUAGES CXX)

# Specify C++17 or higher
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add GoogleTest via subdirectory; adjust path as needed
add_subdirectory(external/googletest)  # assume googletest is cloned in external/

# Add your executable
add_executable(my_test test/my_test.cpp)

# Link with gtest_main (includes main()) OR gtest + your own main
target_link_libraries(my_test GTest::gtest_main)

# Enable testing and register test
enable_testing()
add_test(NAME MyTest COMMAND my_test)
```

#### Step 3: Options and Customizations
- To control GoogleMock build, set `-DBUILD_GMOCK=ON` or `OFF` when running cmake.
- If building GoogleMock standalone, link your tests to `gmock_main` or `gmock` libraries.
- For Visual Studio users, consider the `gtest_force_shared_crt` option to avoid runtime conflicts.

#### Step 4: Build and Run
- Generate your build system:
  ```bash
  mkdir build && cd build
  cmake .. -DBUILD_GMOCK=ON
  make
  ```
- Run tests:
  ```bash
  ctest
  ```
- Alternatively, run the test executable directly.

#### Step 5: Advanced Incorporation Methods
- You can use CMake’s FetchContent module to download GoogleTest at configure time.
- Example:

```cmake
include(FetchContent)
FetchContent_Declare(
  googletest
  URL https://github.com/google/googletest/archive/refs/tags/release-1.17.0.zip
)
FetchContent_MakeAvailable(googletest)

add_executable(my_test test/my_test.cpp)
target_link_libraries(my_test GTest::gtest_main)
```

This approach keeps dependencies managed outside your repository.

### B. Integration with Bazel

#### Step 1: Add GoogleTest via WORKSPACE
- Add GoogleTest as an external dependency using `http_archive` or equivalent.

Example `WORKSPACE` snippet:

```python
http_archive(
    name = "com_google_googletest",
    url = "https://github.com/google/googletest/archive/release-1.17.0.zip",
    strip_prefix = "googletest-release-1.17.0",
)
```

#### Step 2: Configure BUILD files
- Create `BUILD` files for your tests linking to `@com_google_googletest//:gtest_main` or `@com_google_googletest//:gmock_main`.

Example `BUILD`:

```python
cc_test(
    name = "my_test",
    srcs = ["my_test.cpp"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

- For mocking support, use `gmock_main` as needed.

#### Step 3: Build and Run Tests
- Run Bazel test command:
  ```bash
  bazel test //:my_test
  ```

#### Step 4: Troubleshooting
- Ensure your toolchain supports at least C++17.
- Verify Bazel cache and environment settings if tests don’t discover GoogleTest.

### C. Continuous Integration (CI) Integration

#### Step 1: Set Up Your CI Environment
- Ensure the build environment has all required tools (CMake, Bazel, compiler).
- Clone your repository including GoogleTest or configure dependency fetching.

#### Step 2: Build and Run Tests as Part of CI
- In your CI scripts (e.g., Jenkinsfile, GitHub Actions, GitLab CI):
  - Run build commands (`cmake` + `make` or `bazel build`).
  - Run tests using `ctest` or `bazel test`.

Example GitHub Actions snippet for CMake:

```yaml
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v3
    - name: Setup CMake
      uses: jwlawson/actions-setup-cmake@v1
    - name: Configure
      run: |
        mkdir build
        cd build
        cmake .. -DBUILD_GMOCK=ON
    - name: Build
      run: |
        cd build
        make -j$(nproc)
    - name: Run tests
      run: |
        cd build
        ctest --output-on-failure
```

#### Step 3: Collect and Report Test Results
- Most CI platforms can parse test result XML files.
- Configure GoogleTest’s output with `--gtest_output=xml:<filepath>` to generate reports.
- Pass flags to the test executable in your CI script, e.g.: 

```bash
ctest --test-command "./my_test --gtest_output=xml:test_detail.xml"
```

- Upload these artifacts or test reports to CI for review.

#### Step 4: Best Practices in CI
- Isolate test environments.
- Run tests in parallel if supported.
- Fail builds immediately on critical test failures.
- Cache build dependencies to speed up CI.

---

## 3. Practical Examples

### Example: Adding GoogleMock to CMake Project

```cmake
cmake_minimum_required(VERSION 3.13)
project(MyProject LANGUAGES CXX)

set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

# Add GoogleMock and GoogleTest
add_subdirectory(external/googletest)

add_executable(my_mock_test tests/mock_test.cpp)
# Link against GoogleMock main (includes GoogleTest too)
target_link_libraries(my_mock_test gmock_main)

enable_testing()
add_test(NAME MockTest COMMAND my_mock_test)
```

### Example: Bazel BUILD for GoogleTest

```python
cc_test(
    name = "example_test",
    srcs = ["example_test.cpp"],
    deps = ["@com_google_googletest//:gtest_main"],
)
```

---

## 4. Troubleshooting & Tips

### Common Issues
- **Linker Errors**: Ensure you link with `gtest_main` or write your own `main` and link with `gtest`. For mocks, link with `gmock_main`.
- **C++ Standard Mismatch**: Compiler must support C++17; mismatch can cause subtle errors.
- **Runtime Library Conflicts (Windows)**: Use `gtest_force_shared_crt` CMake option to unify runtimes.
- **Tests Not Executing**: Double-check `add_test()` registration and that your test executable runs correctly.

### Best Practices
- Prefer `gmock_main` for mocks as it provides a default test main function.
- Use CMake’s `FetchContent` for easier dependency management.
- Run tests regularly to catch CI integration issues early.

### Performance Considerations
- Enable parallel build and test where possible.
- Consider filtering tests via `--gtest_filter` in CI when focusing on critical paths.

### Alternative Approaches
- Use system package managers to install GoogleTest if available on your platform to simplify setup.
- For embedded platforms, consult corresponding platform-specific guides.

---

## 5. Next Steps & Related Content

- Explore the [Quickstart Installation Guide](/guides/getting-started/quickstart-installation) for detailed setup instructions.
- Learn how to write tests using [Writing Your First Test](/guides/getting-started/writing-your-first-test).
- Advance your mocking skills via [Basic Mocking](/guides/getting-started/basic-mocking) and [Advanced Mocking Patterns](/guides/writing-and-structuring-tests/advanced-mocking-patterns).
- Dive into troubleshooting common test failures with [Troubleshooting Common Test Failures](/guides/real-world-usage-patterns/troubleshooting-test-failures).
- Inspect the [System Architecture Overview](/overview/architecture-concepts/system-architecture) to understand the internals.

---