---
title: "Advanced Mocking Techniques"
description: "Tackle advanced scenarios such as partial mocks, strict and nice mocks, custom actions, and complex matcher compositions. Equip yourself to test challenging dependencies and edge cases with confidence."
---

# Advanced Mocking Techniques

Tackle advanced scenarios such as partial mocks, strict and nice mocks, custom actions, and complex matcher compositions. Equip yourself to test challenging dependencies and edge cases with confidence using GoogleMock (gMock).

---

## 1. Understanding Mock Strictness Levels

GoogleMock provides three levels of mock strictness that control how it treats calls to mock methods without explicit expectations:

### Naggy Mocks (Default Behavior)
- Warn about *uninteresting calls* (mock methods called without an `EXPECT_CALL`), but allow them to succeed.
- Useful during initial test development to catch unexpected interactions with warnings.

### Nice Mocks
- Suppress warnings on uninteresting calls completely.
- Ideal for ignoring irrelevant mock method calls, preventing noise in test output.
- Usage:

  ```cpp
  using ::testing::NiceMock;

  NiceMock<MockFoo> nice_mock;
  EXPECT_CALL(nice_mock, ImportantMethod());
  ...
  ```

### Strict Mocks
- Fail tests immediately on any uninteresting calls (unexpected calls without matching `EXPECT_CALL`).
- Most strict and useful when you want to catch every unexpected interaction.
- Usage:

  ```cpp
  using ::testing::StrictMock;

  StrictMock<MockFoo> strict_mock;
  EXPECT_CALL(strict_mock, ExpectedMethod());
  ...
  ```

<Note>
`NiceMock` and `StrictMock` only affect uninteresting calls, not unexpected calls.
</Note>

<Warning>
Be cautious using strict mocks as they can make tests brittle, increasing maintenance when tests fail due to minor refactors.
</Warning>


---

## 2. Partial Mocks: Combining Real and Mocked Behavior

GoogleMock supports *partial mocks*, where only some methods are mocked while others use the real implementation. This allows testing with real object functionality but still controlling or verifying selected method calls.

### How to Create a Partial Mock
- Derive a mock class from the real class.
- Use `MOCK_METHOD` macros to mock only selected virtual methods.
- Calls to non-mocked methods will use the real class implementation.

### Example:
```cpp
class RealClass {
 public:
  virtual ~RealClass() = default;
  virtual int Compute(int x) { return x * 2; }
  virtual void Log(const std::string& message) { /* real logging */ }
};

class MockPartial : public RealClass {
 public:
  MOCK_METHOD(int, Compute, (int x), (override));
  // Log() remains unmocked and uses RealClass impl
};

// Test usage:
MockPartial mock;
EXPECT_CALL(mock, Compute(5)).WillOnce(Return(42));
int result = mock.Compute(5);  // returns 42
mock.Log("Hello");           // real Log() is called
```

---

## 3. Custom Actions

Sometimes you need mock method behavior beyond simple returns â€” custom actions let you emulate complex side effects or logic.

### Defining Custom Actions
- Use lambdas, functors, or callable objects compatible with the mock method signature.
- Useful for side effects, modifying arguments, or dynamic returns.

### Examples:

**Lambda for dynamic return value based on argument:**
```cpp
EXPECT_CALL(mock, Func(_))
    .WillOnce([](int x) { return x * x; });
```

**Functor:**
```cpp
struct MultiplyBy {
  int factor;
  int operator()(int x) { return x * factor; }
};

EXPECT_CALL(mock, Multiply(_))
    .WillOnce(MultiplyBy{10});
```

### Using Built-in Actions to Modify Arguments or Return Values
- `SetArgPointee<N>(value)` to set an output pointer argument.
- `DoAll()` to chain multiple actions (side effects followed by return).

Example:
```cpp
using ::testing::DoAll;
using ::testing::Return;
using ::testing::SetArgPointee;

EXPECT_CALL(mock, FillBuffer(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(42), Return(true)));
```

This sets pointer argument 1 to 42 and returns `true`.

---

## 4. Complex Matcher Composition

Advanced mocking scenarios often require precise argument matching.

### Combining Matchers
- Use combinators like `AllOf()`, `AnyOf()`, `Not()` to combine matchers logically.
- Example:

```cpp
EXPECT_CALL(mock, Func(AllOf(Gt(5), Ne(10))));
```
Matches when argument > 5 and not equal to 10.

### Matching Multiple Arguments as Tuple
- The `.With()` clause in `EXPECT_CALL` lets you use a matcher on the whole argument tuple.
- Example: Ensuring first arg less than second.

```cpp
EXPECT_CALL(mock, SetRange(_, _))
    .With(Lt());  // Uses built-in matcher for tuples
```

### Custom Matchers
- Define new matchers with `MATCHER`, `MATCHER_P`, or implement the matcher interface.
- Useful for domain-specific or complex argument validation.

### Safe Casting Matchers
- Use `SafeMatcherCast<T>(matcher)` when argument types differ but conversion is valid.

---

## 5. Tips and Best Practices

- **Use `ON_CALL` for default behavior** whenever you don't care whether a function is called or not.
- **Prefer `EXPECT_CALL` only for expected method calls** you want to verify.
- **Use sequences (`InSequence`) or `After()` clause to enforce call order** when testing complex interactions.
- **Avoid over-specifying expectations** to keep tests maintainable.
- **Use `.RetiresOnSaturation()` with cardinalities** to avoid sticky expectations and make ordered calls easier to manage.
- **Leverage `NiceMock` to reduce noisy warnings** on less important mock calls.
- **Use `StrictMock` cautiously** for making errors visible but beware of brittle tests.

<Callout>
**Tip:** When mocking overloaded methods, ensure to mock all overloads or use `using` declarations to bring base overloads in scope.
</Callout>

---

## 6. Troubleshooting Common Issues

### Mock Method Calls Route to Real Methods Instead of Mocks
- Confirm the methods are declared `virtual` in base class.

### Uninteresting Call Warnings
- Occur when mock methods are called without matching `EXPECT_CALL`.
- Suppress using `NiceMock` or explicitly declare catch-all `EXPECT_CALL(mock, Method(_)).Times(AnyNumber())`.

### Multiple `WillOnce()` Run Out
- If the number of calls exceed specified `WillOnce()` clauses without a `WillRepeatedly()`, the default action triggers.
- Solution: Add a `WillRepeatedly()` clause or increase `Times()`.

### Mock Failures on Unmatched Calls
- Check matchers carefully; enable verbose logging `--gmock_verbose=info` for call traces.

### Compilation Issues Mocking Templates or Complex Types
- Use type aliases or parentheses around return/argument types with commas.

---

## 7. Next Steps & Related Content

- Explore [Introduction to Mocking](../intro-mocking) for the fundamentals.
- Dive deeper into [Specifying Expectations and Behaviors](../expectations-behaviors) to master call verification.
- Learn about [Matchers and Custom Matchers](../../api-reference/mocking-framework/matchers-and-custom-matchers) for flexible argument matching.
- Review [Mock Actions and Custom Actions](../../api-reference/mocking-framework/mock-actions-and-custom-actions) to extend mock behavior.

---

## References
- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html)
- [Using Assertions and Matchers](../writing-effective-tests/assertions-matchers)
- [GoogleTest Primer](../getting-started/primer)

---