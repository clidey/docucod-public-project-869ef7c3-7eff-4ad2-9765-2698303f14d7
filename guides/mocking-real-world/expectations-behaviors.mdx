---
title: "Specifying Expectations and Behaviors"
description: "Go beyond the basics by mastering the ON_CALL and EXPECT_CALL macros. Learn to define invocation counts, sequences, and default behaviors, and discover strategies for clear and effective tests."
---

# Specifying Expectations and Behaviors

Master the power of the `ON_CALL` and `EXPECT_CALL` macros to define precise behaviors and invocation expectations on your mock objects. This guide helps you specify invocation counts, sequences, default behaviors, and other aspects that make your tests clear, maintainable, and robust.

---

## Workflow Overview

### Task Description
This guide walks you through the practical usage of `ON_CALL` and `EXPECT_CALL` macros in GoogleMock to specify how mocked methods behave and how many times they are expected to be called. It focuses on setting default behaviors, defining invocation expectations, controlling call sequences, and managing expectation lifecycles.

### Prerequisites
- Familiarity with GoogleMock basics: defining mock classes and methods using `MOCK_METHOD`.
- Basic understanding of matchers and mock method call syntax.
- GoogleTest and GoogleMock installed and ready for use.

### Expected Outcome
By the end, you will be able to write precise and flexible mock specifications,:
- Define default mock method behaviors without enforcing call counts.
- Express exact or approximate invocation counts and control behaviors on each call.
- Organize expectations into sequences and partial orders.
- Handle expectation retirements to avoid brittle tests.
- Write clear, intention-revealing mock test code.

### Time Estimate
10-20 minutes for a first practical use; mastery may come with experience.

### Difficulty Level
Intermediate: assumes working knowledge of mock basics and C++ testing.

---

## Step-by-Step Guide

### 1. Define Default Behaviors with `ON_CALL`
Use `ON_CALL` to specify *what* a mock method should do when called, without asserting it must be called.

```cpp
ON_CALL(mock_object, Method(matchers))
    .WillByDefault(action);
```

- **Purpose:** Configure default method behavior for any matching calls.
- **Example:** Set a default return value.

```cpp
using ::testing::Return;
...
ON_CALL(my_mock, GetNumber())
    .WillByDefault(Return(42));
```

- **Details:**
  - `matchers` is optional; if omitted, matches any arguments.
  - Default actions are overridden by matching `EXPECT_CALL`s with their own actions.
  - Use sparingly to avoid over-constraining your tests.

### 2. Set Invocation Expectations with `EXPECT_CALL`
Use `EXPECT_CALL` to declare that a mock method is *expected* to be called a specific number of times (or with other invocation constraints), optionally customizing the behavior of those calls.

```cpp
EXPECT_CALL(mock_object, Method(matchers))
    .Times(cardinality)          // invocation count or range
    .InSequence(sequence...)     // order control
    .After(other_expectation)    // call ordering
    .WillOnce(action)            // first call behavior
    .WillRepeatedly(action)      // subsequent calls behavior
    .RetiresOnSaturation();      // retire expectation when done
```

- **Example:** Expect exactly 3 calls, returning different values:

```cpp
using ::testing::Return;
...
EXPECT_CALL(my_mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20))
    .WillOnce(Return(30));
```

- **Defaults:** Without explicit `Times()`, GoogleMock infers based on actions:
  - No `.WillOnce` or `.WillRepeatedly`: defaults to exactly one call.
  - Multiple `.WillOnce` clauses without `.WillRepeatedly`: number of calls equals the number of `.WillOnce`.
  - `.WillRepeatedly` present: call count is at least number of `.WillOnce`.

### 3. Control Invocation Counts
You can specify invocation counts precisely:

| Clause                 | Meaning                              |
|------------------------|------------------------------------|
| `Times(Exactly(n))` or `Times(n)` | Exactly n calls expected             |
| `Times(AtLeast(n))`    | Called at least n times              |
| `Times(AtMost(n))`     | Called at most n times               |
| `Times(Between(m,n))`  | Called between m and n times        |
| `Times(AnyNumber())`   | Zero or more calls                   |
| `Times(0)`             | Call should never happen             |

```cpp
EXPECT_CALL(mock, Func(_))
    .Times(2);  // Expect Func to be called twice
```

### 4. Organize Expected Calls in Sequences
Sometimes you need to enforce the **order** expectations are matched:

- Use `InSequence` object for *strict* sequential ordering:

```cpp
using ::testing::InSequence;
{
  InSequence seq;
  EXPECT_CALL(mock, FirstMethod());
  EXPECT_CALL(mock, SecondMethod());
}
```

- Use `.InSequence(seq1, seq2, ...)` to group expectations into sequences:

```cpp
using ::testing::Sequence;
Sequence s1, s2;
EXPECT_CALL(mock, Init()).InSequence(s1, s2);
EXPECT_CALL(mock, Process()).InSequence(s1);
EXPECT_CALL(mock, Finish()).InSequence(s2);
```

- Use `.After(expectation_or_set)` to specify partial order without strict sequences:

```cpp
Expectation e1 = EXPECT_CALL(mock, Start());
ExpectationSet es2 = ...;
EXPECT_CALL(mock, End()).After(e1, es2);
```

This allows flexible ordering (DAG) where some calls must happen only after others.

### 5. Define Call Actions
Specify what happens on calls matched by `EXPECT_CALL` using `WillOnce()` and `WillRepeatedly()`.

- `.WillOnce(action)` will apply to the *next* matched call, consuming one call.
- `.WillRepeatedly(action)` applies to all subsequent calls after all `.WillOnce` actions are used.

```cpp
EXPECT_CALL(mock, GetId())
    .WillOnce(Return(1))
    .WillRepeatedly(Return(2));
```

- Multiple `.WillOnce()` clauses are executed in order.
- You can specify no action; default actions will be taken.
- Don't specify `.WillByDefault()` with `EXPECT_CALL`; `.WillByDefault()` is only for `ON_CALL`.

### 6. Retire Expectations Explicitly
By default, expectations stay *active* (sticky) even after their call count upper bound is reached. This means calls exceeding the expected count will cause errors.

Use `.RetiresOnSaturation()` to mark an expectation as *retiring* as soon as its upper bound is hit, allowing later expectations to match:

```cpp
EXPECT_CALL(mock, Func(42))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, Func(_))
    .Times(AnyNumber());
```

Here, calls with argument `42` will match the first expectation twice, then retire, and later calls with `42` will match the catch-all expectation.

### 7. Combine Matchers with `.With()` and Other Modifiers
Both `ON_CALL` and `EXPECT_CALL` support `.With()` to match *all* arguments together as a tuple, supporting complex predicates.

Example:

```cpp
EXPECT_CALL(mock, SetPosition(_, _))
    .With(Lt());  // first argument less than second
```

- `.With()` must be the first modifier clause if used.

### 8. Verify and Clear Expectations
Normally, expectations are verified automatically when the mock object is destructed.

To manually verify or clear expectations:

```cpp
Mock::VerifyAndClearExpectations(&mock_object);
Mock::VerifyAndClear(&mock_object);  // Also clears ON_CALL defaults
```

Avoid setting expectations after verification or clearing.

### 9. Handling Uninteresting and Unexpected Calls
- Calls to mock methods without `EXPECT_CALL` are **uninteresting**; by default, warnings are printed and the default action is applied.
- Calls that do not match any existing `EXPECT_CALL` are **unexpected** and cause test failures.

Use `NiceMock<T>` to suppress uninteresting call warnings, or `StrictMock<T>` to turn uninteresting calls into failures.

---

## Examples & Code Snippets

### Example 1: Define Default Behavior Only
```cpp
ON_CALL(mock, Compute(_))
    .WillByDefault(Return(0));
// No expectation on invocation count
```

### Example 2: Expect Exactly 2 Calls with Different Returns
```cpp
EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(10))
    .WillOnce(Return(20));
```

### Example 3: Expect Calls in Sequence
```cpp
{
  InSequence seq;
  EXPECT_CALL(mock, Start()).Times(1);
  EXPECT_CALL(mock, Stop()).Times(1);
}
```

### Example 4: Partial Ordering with `.After()`
```cpp
Expectation e1 = EXPECT_CALL(mock, Init());
EXPECT_CALL(mock, Cleanup()).After(e1);
```

### Example 5: Retiring Expectations
```cpp
EXPECT_CALL(mock, Save(_))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, Save(_))
    .Times(AnyNumber());
```

### Example 6: Use of `.With()` for Aggregate Argument Matching
```cpp
EXPECT_CALL(mock, Process(_, _))
    .With(AllOf(Args<0,1>(Gt(0))));
```

---

## Troubleshooting & Tips

### Common Issues
- **Warnings on uninteresting calls:** Use `ON_CALL` to set default behavior or wrap mocks with `NiceMock`.
- **Unexpected call failures:** Verify arguments and invocation counts exactly match expectations.
- **Too many or too few WillOnce() actions:** Make sure `.Times()` matches the number of `.WillOnce()` clauses, or add `.WillRepeatedly()` where applicable.
- **Confusing call ordering errors:** Use `InSequence` or `.After()` clauses to clarify call order.

### Best Practices
- Use `ON_CALL` to configure default behaviors shared by multiple tests.
- Use `EXPECT_CALL` to assert critical interactions.
- Prefer `.RetiresOnSaturation()` when expectations should not be sticky.
- Organize expectations logically using sequences for strict ordering.
- Avoid overly specific matchers; prefer `_` for irrelevant arguments.
- Set expectations before exercising code.

### Performance Considerations
- Defining sequences and partial orders can improve test clarity but add complexity to matching logic; use moderately.
- Excessive numbers of `.WillOnce()` clauses may increase compile time.

### Alternative Approaches
- Delegate mock method behavior to real or fake implementations using lambdas inside `ON_CALL`.
- Use `NiceMock` and `StrictMock` templates to adjust verbosity and strictness.

---

## Next Steps & Related Content

- Explore the [Using Assertions and Matchers](../writing-effective-tests/assertions-matchers) guide to complement mock expectations.
- Learn about [Advanced Mocking Techniques](../mocking-real-world/advanced-mocking-patterns) for sophisticated mocking patterns.
- Review [Basic Configuration Options](../../getting-started/first-run-configuration-troubleshooting/basic-configuration-options) to set test framework-wide behavior.
- For troubleshooting, check [Troubleshooting Common Setup Issues](../../getting-started/first-run-configuration-troubleshooting/troubleshooting-common-setup-issues).
- Consult the [Mocking Reference](../reference/mocking) for full API documentation.

---

## References
- [ON_CALL and EXPECT_CALL Macros](../reference/mocking.md#macros)
- [gMock Cookbook - Knowing When to Expect](../gmock_cook_book.md#UseOnCall)
- [Matchers Reference](../reference/matchers)
- [Actions Reference](../reference/actions)

---

**Engage fully with these tools to write clear, maintainable mock tests that validate the contract your code promises—nothing more, nothing less.**
