---
title: "Advanced Mocking Patterns"
description: "Learn to apply advanced mocking techniques, such as custom actions, matchers, and controlling mock strictness. Use these patterns to model complex behaviors, focus tests on the right interactions, and enforce rigorous contracts."
---

# Advanced Mocking Patterns

Master advanced gMock mocking techniques in this guide focused solely on **advanced mocking patterns** to help you express complex behaviors, control mock strictness, and write precise, maintainable tests. Learn how to leverage custom actions, matchers, and strictness levels to craft mocks that model your code's real interactions and contracts.

---

## Overview

This guide equips you to take full advantage of GoogleMock's advanced features for mocking C++ classes and methods. By following these patterns, you will model sophisticated behaviors, focus your tests on essential interactions, and enforce rigorous contracts that improve test reliability and expressiveness.

### Prerequisites

- Familiarity with basic gMock concepts: mock class definitions, `MOCK_METHOD` macro, `EXPECT_CALL`, and `ON_CALL`.
- Understanding of matchers and actions (see the [Matchers Reference](../api-reference/advanced-behaviors/argument-matchers) and [Actions Reference](../api-reference/advanced-behaviors/mock-actions)).

### Expected Outcome

After completing this guide, you will: 

- Define mocks for complex classes including templates and overloaded methods.
- Use customized argument matchers and multi-argument conditions.
- Delegate mock behaviors to real or fake implementations for realistic testing.
- Control mock behavior strictness to catch or ignore uninteresting calls.
- Structure expectations with ordering constraints for interaction verification.

### Time Estimate

Around 20â€“30 minutes to read and experiment with the code examples.

### Difficulty Level

Intermediate to Advanced

---

## Core Advanced Techniques

### 1. Mocking Complex Classes and Methods

- **Handling Commas in Types:** Use parentheses or type aliases when argument or return types include commas.

  ```cpp
  class MockFoo {
  public:
    using BoolAndInt = std::pair<bool, int>;
    MOCK_METHOD(BoolAndInt, GetPair, ());
  };
  ```

- **Mocking Private/Protected Methods:** Always place `MOCK_METHOD` declarations in the public section even if the original methods are not.

- **Overloaded Functions:** Mock all overloads explicitly, or use `using BaseClass::Method;` to avoid hiding base methods.

  ```cpp
  MOCK_METHOD(int, Add, (int value), (override));
  MOCK_METHOD(int, Add, (int times, int value), (override));
  using BaseClass::Add;  // Bring base overloads into scope
  ```

- **Class Templates:** Mock template classes just like normal classes.

  ```cpp
  template <typename T>
  class MockStack : public StackInterface<T> {
  public:
    MOCK_METHOD(int, GetSize, (), (const, override));
    MOCK_METHOD(void, Push, (const T& x), (override));
  };
  ```

### 2. Controlling Mock Strictness: Nice, Strict, and Naggy

- Use `NiceMock` to suppress warnings on uninteresting calls.
- Use `StrictMock` to treat uninteresting calls as test failures.
- Default mocks are naggy and print warnings for uninteresting calls.

Example:

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

StrictMock<MockFoo> strict_mock;
EXPECT_CALL(strict_mock, DoSomething()); // Other calls will fail.

NiceMock<MockFoo> nice_mock;
EXPECT_CALL(nice_mock, DoSomething()); // Other calls will be silent.
```

**Best Practice:** Use nice mocks mainly; resort to strict mocks only when you want to catch unexpected calls rigorously.

### 3. Delegating Mock Calls

- **To Fakes:** You may have a complex fake implementation. Delegate mock methods to the fake to reuse behavior while verifying interactions.

  ```cpp
  class MockFoo : public Foo {
  public:
    MOCK_METHOD(char, DoThis, (int n), (override));
    void DelegateToFake() {
      ON_CALL(*this, DoThis).WillByDefault([this](int n) {
        return fake_.DoThis(n);
      });
    }
  private:
    FakeFoo fake_;
  };
  ```

- **To Real Objects:** Similar to fakes, but use a real implementation.

- **To Parent Class:** Call parent class methods in stub actions to retain default behavior.

### 4. Advanced Matchers

- Use `With()` clause to write matchers for the entire tuple of arguments.
- Compose complex matchers using `AllOf()`, `AnyOf()`, and `Not()`.
- Use `SafeMatcherCast<T>(m)` for safe matcher type conversions.
- Validating members: `Field(&Class::member, matcher)` and `Property(&Class::getter, matcher)` help you check parts of arguments.
- Use container matchers `ElementsAre()`, `UnorderedElementsAre()`, and `ElementsAreArray()` for collections.
- Define your own matcher classes for reusable invariant checks.

### 5. Custom Actions

- Combine multiple actions using `DoAll()`
- Use built-in actions like `SetArgPointee`, `SetArrayArgument`, or define your own lambdas and functor actions.

Example:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(42), Return(true)));
```

- Invoke function arguments using `InvokeArgument<N>(...)`.
- Use `IgnoreResult()` to adapt an action's return when needed.
- Apply `WithArgs` and `WithoutArgs` to tailor which arguments your action uses.

---

## Step-by-Step Instructions to Apply Advanced Mocking Patterns

<Steps>
<Step title="Define Complex Mock Methods">
Write your mock classes using `MOCK_METHOD` with correct parameters including `const`,`override`, and handle complicated type definitions by wrapping types or using aliases.
</Step>

<Step title="Choose Mock Strictness">
Decide if your tests need to catch unexpected calls (use `StrictMock`), suppress noise when uninteresting calls happen (use `NiceMock`), or keep default naggy behavior.
</Step>

<Step title="Delegate Behavior Where Appropriate">
If you have existing fake or real implementations for an interface, delegate mock method default actions to them using `ON_CALL` with lambdas capturing your delegates.
</Step>

<Step title="Write Precise Matchers and Expectations">
Compose argument matchers carefully: use single argument matchers, tuple matchers with `.With()`, and container matchers for collection parameters. Write expectations that reflect your verification targets precisely.
</Step>

<Step title="Define Custom Actions as Needed">
For operations that require side effects or composite behavior, use `DoAll` and build custom lambdas or functors. Use `Invoke` and `InvokeArgument` to integrate existing callback-based code.
</Step>
</Steps>

---

## Examples

### Mocking Overloaded Methods

```cpp
class Foo {
 public:
  virtual int Add(int x);
  virtual int Add(int times, int x);
  virtual const Bar& GetBar() const;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, Add, (int x), (override));
  MOCK_METHOD(int, Add, (int times, int x), (override));
  MOCK_METHOD(const Bar&, GetBar, (), (const, override));
};
```

### Using `StrictMock` to Fail on Unexpected Calls

```cpp
using ::testing::StrictMock;

StrictMock<MockFoo> mock;
EXPECT_CALL(mock, DoThis());
// Any call to a method other than DoThis() will cause failures
```

### Delegating Calls to a Fake

```cpp
class FakeFoo : public Foo {
  char DoThis(int n) override { ... }
};

class MockFoo : public Foo {
  MOCK_METHOD(char, DoThis, (int n), (override));

  void DelegateToFake() {
    ON_CALL(*this, DoThis).WillByDefault([this](int n) { return fake_.DoThis(n); });
  }
 private:
  FakeFoo fake_;
};
```

### Custom Matcher Class

```cpp
class DivisibleBy7Matcher {
 public:
  using is_gtest_matcher = void;
  bool MatchAndExplain(int n, std::ostream* os) const {
    if (n % 7 == 0) return true;
    if (os) *os << "the remainder is " << (n % 7);
    return false;
  }
  void DescribeTo(std::ostream* os) const { *os << "is divisible by 7"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is not divisible by 7"; }
};

::testing::Matcher<int> DivisibleBy7() {
  return DivisibleBy7Matcher();
}
```

### Setting Default Actions with `ON_CALL`

```cpp
ON_CALL(mock_foo, Compute(_))
    .WillByDefault(Return(42));
```

### Using Composite Actions

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting Call Warnings:** Seeing warnings means that a mock method was called without an expectation. Either add `EXPECT_CALL` or use `NiceMock` to suppress warnings.
- **Over-saturated Calls:** Calling a mock function more than expected triggers errors. Use `.RetiresOnSaturation()` if you want to allow additional calls to fall through.
- **Ambiguous Overloads:** Specify full argument lists or use `using Base::Method` in mocks for overloaded functions.
- **Mismatch in Matchers:** Use `--gmock_verbose=info` runtime flag to get detailed call matching trace helping debug matcher problems.

### Best Practices

- Prefer **using `ON_CALL` for setting default behavior**, and keep `EXPECT_CALL` only for calls you want to verify explicitly.
- Use `RetiresOnSaturation()` with ordered expectations to avoid sticky expectations causing conflicts.
- Structure expectations with sequences (`InSequence`) to verify strict order.
- Leverage matchers to avoid brittle tests by specifying only relevant argument constraints.

### Performance

- To speed up compilation of mock classes, declare and define the constructor and destructor of your mock in `.cc` files instead of inline in the header.

### Alternative Approaches

- When mocking non-virtual methods, use templated mocks with matching signatures but unrelated classes.
- For static/free functions, use interface wrappers or pass `std::function` and mock them.

---

## Next Steps & Related Content

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html): Extensive recipes for gMock.
- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html): Beginner-friendly introduction.
- [Matchers Reference](../api-reference/advanced-behaviors/argument-matchers): Detailed matcher usage.
- [Actions Reference](../api-reference/advanced-behaviors/mock-actions): Built-in and custom actions.
- [Mocking Reference](../api-reference/core-apis/mocking-and-methods): Core mocking APIs and concepts.

Explore these to deepen your mastery over GoogleMock and improve test expressiveness and resilience.
