---
title: "Using Mocks and Expectations"
description: "A deep-dive guide on leveraging GoogleMock for verifying interactions and isolating components via test doubles (mocks). Covers defining mock classes, setting up expectations, and using advanced matchers for argument verification."
---

# Using Mocks and Expectations

GoogleMock (“gMock”) empowers you to create mock objects that simulate the behavior of real objects in your tests. By setting **expectations** on these mocks, you precisely control and verify how your code interacts with its dependencies—ensuring correct calls, arguments, call order, and return values.

This guide takes you through the practical workflows of using mocks and setting expectations to build robust, expressive, and maintainable tests.

---

## Workflow Overview

- **Task Description:** Understand how to properly create and use mock objects with gMock, specify expectations on mock methods, and control their behavior to verify interactions in your tests.
- **Prerequisites:** 
  - Basic knowledge of C++ interfaces and virtual methods.
  - gMock installed and configured in your environment.
  - Familiarity with writing simple test cases.
- **Expected Outcome:**
  - Define mock classes using `MOCK_METHOD`.
  - Set up default behaviors with `ON_CALL`.
  - Create precise expectations with `EXPECT_CALL`.
  - Use matchers for flexible argument verification.
  - Control call sequences and cardinalities.
- **Time Estimate:** 20–30 minutes to grasp and apply the fundamentals; more for advanced scenarios.
- **Difficulty Level:** Beginner to Intermediate

---

## Step-by-Step Instructions

### 1. Define Your Mock Classes

- Derive a mock class from your interface (or class) whose behavior you want to simulate.
- Use the `MOCK_METHOD` macro to mock each virtual method you want to observe or control.

```cpp
#include <gmock/gmock.h>

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(void, Process, (int count), (override));
};
```

- **Tip:** Always put `MOCK_METHOD`s in the `public` section regardless of the original method's access level for compatibility with expectations.
- **Tip:** Use type aliases or extra parentheses to avoid parsing errors with complex types (e.g., templates with commas).

### 2. Create Mock Objects in Your Tests

- Instantiate mock objects in your test body or fixtures.

```cpp
MockFoo mock_foo;
```

- You can also create *nice*, *naggy* (default), or *strict* mocks to control warnings and errors on unexpected calls:

```cpp
using ::testing::NiceMock;
using ::testing::StrictMock;

NiceMock<MockFoo> nice_mock;
StrictMock<MockFoo> strict_mock;
```

- `NiceMock` suppresses warnings on uninteresting calls, `StrictMock` treats them as errors.

### 3. Set Default Behaviors on Mock Methods with `ON_CALL`

- Use `ON_CALL` to specify default behavior for mock methods without requiring to verify that the call happens.

```cpp
using ::testing::Return;
ON_CALL(mock_foo, GetSize()).WillByDefault(Return(10));
```

- This does not enforce the method to be called but ensures it returns the specified default.
- **Best practice:** Use `ON_CALL` in your test setup or constructor to configure common shared behavior.

### 4. Specify Expected Calls with `EXPECT_CALL`

- Use `EXPECT_CALL` to expect specific calls on your mocks and verify they occur as intended.

```cpp
EXPECT_CALL(mock_foo, Process(5)).Times(1);
```

- The syntax allows matching arguments using **matchers** to flexibly constrain expected calls:

```cpp
using ::testing::_;             // Matches anything
using ::testing::Ge;            // Greater or equal

EXPECT_CALL(mock_foo, Process(Ge(1)));
EXPECT_CALL(mock_foo, GetSize()).WillOnce(Return(5));
```

- If you don't care about arguments, use `_` or omit the argument list for non-overloaded methods:

```cpp
EXPECT_CALL(mock_foo, Process(_)).Times(2);
EXPECT_CALL(mock_foo, GetSize());  // Equivalent to Times(1)
```

- **Note:** `EXPECT_CALL` must be set before exercising the code that calls the mock.

### 5. Control Call Cardinalities with `Times`

- Define how many times an expected call should occur:

| `Times` Clause      | Description                             |
|--------------------|---------------------------------------|
| `Times(0)`         | Method must NOT be called.             |
| `Times(1)`         | Method called exactly once (default). |
| `Times(AnyNumber())` | Method can be called any number of times. |
| `Times(AtLeast(n))` | Method called at least `n` times.      |
| `Times(AtMost(n))`  | Method called no more than `n` times. |
| `Times(Between(m,n))` | Method called between `m` and `n` times inclusive. |

- When omitted, gMock attempts to infer the cardinality from the use of `.WillOnce()` and `.WillRepeatedly()`.

### 6. Specify Call Orders with `InSequence` and `After`

- To enforce calls happen in a specific order, use `InSequence`:

```cpp
{
  testing::InSequence s;
  EXPECT_CALL(mock_foo, Step1());
  EXPECT_CALL(mock_foo, Step2());
}
```

- Alternatively, use `After` to specify that calls must happen after other expectations:

```cpp
Expectation e1 = EXPECT_CALL(mock_foo, Init());
EXPECT_CALL(mock_foo, Use()).After(e1);
```

- You can combine these to describe complex partial orders.

### 7. Define Actions to Control Behavior with `WillOnce` and `WillRepeatedly`

- Actions describe what the mock method does when called.
- Use built-in actions like `Return(value)`, `ReturnRef(variable)`, or `Invoke(function)`.

```cpp
EXPECT_CALL(mock_foo, GetSize())
    .WillOnce(Return(5))
    .WillRepeatedly(Return(10));
```

- The first call returns 5, subsequent calls return 10.
- Combine multiple actions with `DoAll()`.

### 8. Verify and Tear Down

- Expectations are automatically verified when mock objects are destructed.
- Alternatively, invoke `testing::Mock::VerifyAndClearExpectations(&mock_obj)` to check earlier.
- Use `Mock::AllowLeak(&mock_obj)` if the mock is intentionally leaked.

---

## Examples

### Simple Mock Class and Expectation

```cpp
class Foo {
 public:
  virtual ~Foo() = default;
  virtual int GetValue() const = 0;
  virtual void Process(int n) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, Process, (int n), (override));
};

TEST(FooTest, UsesMock) {
  MockFoo mock;

  ON_CALL(mock, GetValue()).WillByDefault(testing::Return(42));
  EXPECT_CALL(mock, Process(testing::_)).Times(2);

  EXPECT_EQ(42, mock.GetValue());
  mock.Process(1);
  mock.Process(2);
}
```

### Using Matchers and Ordered Calls

```cpp
using ::testing::_;
using ::testing::Ge;
using ::testing::InSequence;

TEST(FooTest, ComplexExpectation) {
  MockFoo mock;
  {
    InSequence seq;
    EXPECT_CALL(mock, Process(Ge(0)));
    EXPECT_CALL(mock, Process(Ge(10)));
  }

  mock.Process(5);   // Matches first expectation
  mock.Process(15);  // Matches second expectation
}
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting call warnings:** You get warnings when a mock method is called without an `EXPECT_CALL`. Suppress with `NiceMock` or add an `EXPECT_CALL(...).Times(AnyNumber())` if calls are allowed without verification.

- **Ambiguous overloaded methods:** Always mock all overloads or use `using BaseClass::Method;` in mock class to avoid hidden methods.

- **Order failures:** If tests fail about call order, double-check sequencing clauses and use `InSequence` or `After` appropriately.

- **Compilation errors with commas:** Wrap template arguments containing commas in extra parentheses or use type aliases for clean `MOCK_METHOD` declarations.

- **Method visibility:** Always place `MOCK_METHOD` in `public` to allow expectations even when base method is private or protected.

### Best Practices

- Prefer `ON_CALL` to set default behavior and use `EXPECT_CALL` only when you want to verify calls.
- Use matchers to avoid brittle argument matching; avoid over-specifying.
- Apply `RetiresOnSaturation()` on expectations with upper bounds to avoid sticky expectations causing unexpected failures.
- Use sequences for strict ordering instead of relying on implicit ordering.
- Be cautious when mixing `NiceMock`, `NaggyMock` (default), and `StrictMock` as they vary in uninteresting call handling.

### Performance Considerations

- Define mock class constructor and destructor outside header files to speed up compilation.

### Alternative Approaches

- For non-virtual methods, use templates or dependency injection.
- For free functions, encapsulate calls in interfaces to mock via virtual methods.

---

## Next Steps & Related Content

- Deep dive into [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for recipes on advanced mocking.
- Learn how to create [custom matchers](https://google.github.io/googletest/gmock_cook_book.html#NewMatchers).
- Explore the [Actions Reference](../reference/actions.md) for rich mock action options.
- Understand [Matchers Reference](../api-reference/advanced-behaviors/argument-matchers.html).
- Read [Mocking Reference](../api-reference/core-apis/mocking-and-methods.html) for a comprehensive API overview.
- Integrate these concepts into your existing test workflow for robust interaction testing.

---