---
title: "Defining Custom Assertions and Actions"
description: "A hands-on guide to creating your own custom assertion macros and mock actions for highly specialized test requirements. Empower your tests with tailored validations and interaction sequences."
---

# Defining Custom Assertions and Actions

A hands-on guide to creating your own custom assertion macros and mock actions for highly specialized test requirements. Empower your tests with tailored validations and interaction sequences.

---

## 1. Understanding the Purpose of Custom Assertions and Actions

When the built-in assertions or mock actions in GoogleMock don't fully meet your needs, custom assertions and actions let you extend gMock's capabilities. This empowers your tests to precisely validate complex objects or perform specialized behaviors upon mock function calls.

Custom assertions focus on validating the arguments passed to mock methods, providing expressive and domain-specific failure messages.

Custom actions define how mocked functions behave during tests, enabling intricate side effects or return values beyond standard actions.

---

## 2. Preparing to Write Custom Assertions and Actions

### Prerequisites
- Familiarity with GoogleMock concepts: mock methods, expectations, matchers, and built-in actions.
- C++ knowledge, including templates and lambda expressions.
- An existing mock class or test code where custom validation or behavior is needed.

### Expected Outcome
After this guide, you will be able to:
- Define custom assertions using the MATCHER family of macros.
- Create parameterized and polymorphic assertions.
- Write custom mock actions using ACTION macros and class-based approaches.
- Invoke callable arguments within mock actions.

### Time Estimate
Approximately 30-45 minutes to read, understand, and apply the concepts.

### Difficulty Level
Intermediate to Advanced C++ testing practitioners.

---

## 3. Defining Custom Assertions

Custom assertions validate function arguments in ways not covered by built-in matchers.

### 3.1 Using MATCHER for Simple Custom Assertions

The simplest way to create a custom assertion is by using the `MATCHER` macro:

```cpp
MATCHER(IsDivisibleBy7, "Checks if a number is divisible by 7") {
  return (arg % 7) == 0;
}
```

Use in a test like:

```cpp
EXPECT_CALL(mock, Foo(IsDivisibleBy7()));
```

If the assertion fails, gMock prints a clear failure message, including the provided description.

### 3.2 Defining Parameterized Assertions with MATCHER_P and MATCHER_Pk

For assertions that depend on parameters:

```cpp
MATCHER_P(HasAbsoluteValue, value, "Checks if absolute value equals param") {
  return abs(arg) == value;
}
```

Usage:

```cpp
EXPECT_CALL(mock, Foo(HasAbsoluteValue(5)));
```

For multiple parameters, use `MATCHER_P2`, `MATCHER_P3`, ... up to `MATCHER_P10`.

### 3.3 Writing Polymorphic Matchers

Custom assertions often need to be polymorphic, usable for more than one argument type. Implement this as a class with a templated `MatchAndExplain()`:

```cpp
class NotNullMatcher {
 public:
  using is_gtest_matcher = void;

  template<typename T>
  bool MatchAndExplain(const T* p, std::ostream*) const {
    return p != nullptr;
  }

  void DescribeTo(std::ostream* os) const { *os << "is not NULL"; }
  void DescribeNegationTo(std::ostream* os) const { *os << "is NULL"; }
};

auto NotNull() { return testing::MakePolymorphicMatcher(NotNullMatcher()); }
```

---

## 4. Writing Custom Actions

Actions tell your mock method how to behave when called.

### 4.1 Using ACTION and its Variants

These macros define custom actions with or without parameters.

- `ACTION(Name) { statements; }` defines an action named `Name` with access to mock arguments as `arg0`, `arg1`, etc.
- `ACTION_P(Name, param) { statements; }` defines parameterized actions.
- Variants `ACTION_P2`, `ACTION_P3` ... accept multiple parameters.

Example:

```cpp
ACTION(IncrementArg1) {
  return ++(*arg1);
}
```

Use with:

```cpp
EXPECT_CALL(mock, Foo(_)).WillOnce(IncrementArg1());
```

### 4.2 Writing Fully Typed and Template Actions

For more control, implement `::testing::ActionInterface<F>` where `F` is the function type of the mock method. Implement `Perform()` method to execute the action.

Example:

```cpp
class IncrementArgumentAction : public ActionInterface<int(int*)> {
 public:
  int Perform(const std::tuple<int*>& args) override {
    int* p = std::get<0>(args);
    return ++(*p);
  }
};

Action<int(int*)> IncrementArgument() {
  return MakeAction(new IncrementArgumentAction);
}
```

### 4.3 Polymorphic Actions

Use `MakePolymorphicAction()` to build actions usable with multiple mock function signatures:

```cpp
class ReturnSecondArgumentAction {
 public:
  template <typename Result, typename ArgumentTuple>
  Result Perform(const ArgumentTuple& args) const {
    return std::get<1>(args);
  }
};

PolymorphicAction<ReturnSecondArgumentAction> ReturnSecondArgument() {
  return MakePolymorphicAction(ReturnSecondArgumentAction());
}
```

### 4.4 Using Callable Arguments Inside Actions

Mock functions might receive function pointers or functors as arguments. You often want to invoke these within your action. Use `InvokeArgument<N>(args...)`:

```cpp
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(InvokeArgument<1>(5)); // Invokes the 2nd argument as a callable with argument 5
```

Remember:
- Use `std::ref()` to pass references rather than copies.

### 4.5 Combining Multiple Actions

Use `DoAll()` to execute multiple side effects or behaviors in one action:

```cpp
EXPECT_CALL(mock, Foo(_))
    .WillOnce(DoAll(SetArgPointee<0>(5), Return(true)));
```

Only the last action's return value is used.

### 4.6 Ignoring Action Results

To use an action that returns a value in place of a void function or in `DoAll()`, use `IgnoreResult()`:

```cpp
EXPECT_CALL(mock, Foo()).WillOnce(IgnoreResult(Return(42)));
```

---

## 5. Practical Examples

### 5.1 Custom Assertion to Validate a Range

```cpp
MATCHER_P2(InClosedRange, low, high, "") {
  return low <= arg && arg <= high;
}

EXPECT_CALL(mock, Foo(InClosedRange(10, 20)));
```

### 5.2 Custom Action That Increments an Argument

```cpp
ACTION(IncrementArg0) {
  return ++(*arg0);
}

EXPECT_CALL(mock, SetCounter(_)).WillOnce(IncrementArg0());
```

### 5.3 Action Using InvokeArgument to Call a Callback Argument

```cpp
EXPECT_CALL(mock, DoAsync(_, _))
    .WillOnce(InvokeArgument<1>(true));
```

This calls the 2nd argument as a callable, passing `true`.

### 5.4 Parameterized Action Template (Copy K-th Argument to Output)

```cpp
ACTION_TEMPLATE(DuplicateArg,
                HAS_2_TEMPLATE_PARAMS(int, k, typename, T),
                AND_1_VALUE_PARAMS(output)) {
  *output = T(std::get<k>(args));
}

int n;
EXPECT_CALL(mock, Foo(_, _))
    .WillOnce(DuplicateArg<0, int>(&n));
```

---

## 6. Troubleshooting and Tips

### Common Issues

- **Mismatch in argument types:** Ensure your custom matcher or action signatures align strictly with the mocked function.
- **Unintended copies in InvokeArgument:** Use `std::ref()` for arguments that should be passed by reference.
- **Actions with move-only types:** Use lambda expressions or callables with `WillOnce()` which supports move-only types.
- **Expectations order confusion:** Remember latest matching expectations override previous; use sequences or multiple `WillOnce()` clauses to control order.

### Best Practices

- Use `MATCHER` macros for concise custom assertions with helpful failure messages.
- Keep the custom assertion's description expressive to aid debugging.
- Use parameterized and polymorphic matchers for reusable and generic assertions.
- Prefer lambdas or `ACTION` macros for simple actions; consider `ActionInterface` for complex scenarios.
- Use `DoAll()` to combine side effects and return values cleanly.
- Always test your custom assertions and actions in isolation first.

### Performance Considerations

- Custom actions and assertions involve virtual functions and templates; keep them lightweight.
- Excessive complexity in actions might slow down compilation and test execution.
- If actions or matchers are stateful and used repeatedly, consider sharing instances.

---

## 7. Next Steps & Related Content

- **Expanding Custom Assertions:** See [gMock Cookbook - Writing New Matchers](https://google.github.io/googletest/gmock_cook_book.html#WritingNewMatchers)
- **Advanced Actions:** Explore polymorphic and templated actions in [gMock Cookbook - Writing New Actions](https://google.github.io/googletest/gmock_cook_book.html#WritingNewActions)
- **Mocking with gMock:** Review the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for comprehensive recipes.
- **Built-in Actions Overview:** Check the [Actions Reference](https://google.github.io/googletest/reference/actions.html).
- **Matchers Reference:** Explore built-in and how to combine matchers at [Matchers Reference](https://google.github.io/googletest/reference/matchers.html).
- **Guides on Using gMock:** For foundational familiarity, read the [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) guide.

---

## Appendix: Summary of Key Macros and Functions

| Macro/Function         | Description                                  |
|------------------------|----------------------------------------------|
| `MATCHER(name, desc)`  | Defines a simple custom assertion matcher   |
| `MATCHER_P(name, param, desc)` | Parameterized matcher with 1 parameter         |
| `ACTION(name)`         | Defines a custom action                      |
| `ACTION_P(name, param)`| Parameterized custom action                  |
| `InvokeArgument<N>(args...)` | Invokes N-th mock function argument (callable) |
| `DoAll(a1, ..., an)`   | Combines multiple actions in sequence        |
| `IgnoreResult(action)` | Runs action but ignores its return value     |

Use these building blocks to implement highly specific test behaviors and expectations.
