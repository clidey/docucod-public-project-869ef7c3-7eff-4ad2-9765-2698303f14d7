---
title: "Mocking Best Practices & Patterns"
description: "Adopt proven patterns and recommendations for effective mocking, including tips for maintainability, minimal coupling, and avoiding common pitfalls."
---

# Mocking Best Practices & Patterns

## Overview

This guide presents proven patterns and practical recommendations to help you master mocking with GoogleMock. By adopting these best practices, you'll create maintainable, robust mocks with minimal coupling to implementation details, improving test reliability and ease of evolution.

## 1. Adopt the Right Mocking Philosophy

- **Mock what you own, not everything:** Prefer mocking interfaces you define rather than concrete classes from external libraries. This reduces brittle tests tightly coupled to implementation changes.
- **Code to interfaces:** Wrap concrete classes with your own interfaces tailored to your domain. Use mocks on these interfaces instead of the concrete classes.
- **Favor simple, focused interfaces:** Smaller interfaces with fewer methods enable easier mocking and clearer tests.

## 2. Define Your Mock Classes Correctly

- Always put `MOCK_METHOD` declarations in the `public:` section, regardless of the original access level in the base class. This enables `ON_CALL` and `EXPECT_CALL` from outside the mock.

  ```cpp
  class MyMock : public Base {
   public:
    MOCK_METHOD(void, Foo, (), (override));
  };
  ```

- Handle methods with commas in argument or return types by wrapping the type in parentheses or using `using` alias declarations:

  ```cpp
  using PairBoolInt = std::pair<bool, int>;
  MOCK_METHOD(PairBoolInt, GetPair, (), ());
  ```

- For overloaded methods, mock every overload you intend to use, and use `using Base::MethodName;` to bring hidden overloads into scope.

- Mock virtual destructors if you need to track object lifetime.

## 3. Make Expectations Clear and Maintainable

- Use `ON_CALL` to set default behaviors for mock methods _without_ implying a call expectation.
- Use `EXPECT_CALL` only when you want to verify the mock method will be called. Avoid unnecessarily strict expectations to reduce test brittleness.
- Prefer simpler matchers; avoid over-specification of argument expectations.

  ```cpp
  EXPECT_CALL(mock, Process(_))  // Matches calls with any argument
      .Times(AnyNumber());
  ```

- Control call order precisely using `InSequence` or `After` only when truly necessary.

- Use `.RetiresOnSaturation()` on expectations when the calls should not remain active after being satisfied, which reduces confusing errors due to sticky expectations.

## 4. Use Strictness Settings Wisely

- Understand the difference between **Naggy**, **Nice**, and **Strict** mocks:

  - **NaggyMock** (default): warns on uninteresting calls.
  - **NiceMock**: silently ignores uninteresting calls, reducing noise.
  - **StrictMock**: treats uninteresting calls as errors, enforcing strict contract validation.

- Default to using **NiceMock** in most cases for maintainability. Use **StrictMock** only when needed to detect unexpected interactions.

  ```cpp
  using ::testing::NiceMock;
  NiceMock<MyMock> mock;
  EXPECT_CALL(mock, Foo());
  ```

- Remember these modifiers only apply to mock methods _defined directly_ in the mock class.

## 5. Organize Complex Mock Behavior for Readability

- Use sequences or multiple expectations with `.WillOnce()` followed by `.WillRepeatedly()` to model evolving return behaviors.

- Simplify mock interfaces by redispatching complex methods with many arguments to simpler mocked methods with fewer parameters.

  ```cpp
  class MockLog : public LogSink {
    void send(...) override {
      Log(severity, file_path, std::string(message, len));
    }
    MOCK_METHOD(void, Log, (LogSeverity severity, const std::string& file, const std::string& message));
  };
  ```

- Delegate mock calls to fake or real objects when desired behavior is complex but mostly standard:

  - Use `ON_CALL` with lambdas forwarding calls to the real/fake.
  - Override particular calls using `EXPECT_CALL` as needed.

## 6. Handle Move-Only and Non-Virtual Methods Appropriately

- To mock methods with move-only arguments or return types, use C++11 gMock support with `MOCK_METHOD`. Use lambdas for actions returning new instances.

- For non-virtual methods, isolate them with templated code or dependency injection, as shown in the cookbook recipes.

- Avoid mocking concrete classes that are not designed for extension; instead, mock interfaces and adapt concrete classes.

## 7. Control and Chain Actions

- Combine actions with `DoAll()` to perform multiple effects in one expectation.
- Use `SetArgPointee()` and `SetArrayArgument()` to modify output arguments cleanly.
- Use callable objects, functors, lambdas with `Invoke()` to customize behaviors.
- Use `WithArgs<>` and related utilities to select which arguments to pass to the action.

## 8. Deal with Expectation Ordering and Partial Ordering

- Wrap sets of expectations in `InSequence` to enforce a strict call order.
- Use `EXPECT_CALL(...).After(...)` or `Sequence` objects to enforce partial orderings in complex flows.
- Prefer partial ordering when total call order is not essential, to reduce brittleness.

## 9. Use Diagnostic Tools to Debug Expectations

- Run tests with `--gmock_verbose=info` to get detailed traces on expectations and calls.
- Use the notification pattern and `Notification` objects to test asynchronous code synchronously.

## 10. Common Pitfalls to Avoid

- Do not define mock methods outside the `public:` section; this breaks call visibility.
- Avoid over-expecting calls, as tests will become brittle.
- Be careful with `Times()` and `WillOnce()`: each `WillOnce` corresponds to an expected call.
- Don't mix setting expectations (`EXPECT_CALL`) and invoking mock functions in an interleaved manner.
- Ensure that mocked classes have virtual destructors to avoid undefined behavior.
- Use `RetiresOnSaturation()` or sequences to avoid sticky expectations causing errors unexpectedly.

## Summary

By adhering to these best practices, you'll create clear, maintainable mock objects that yield robust and reliable tests. Strive to design clean interfaces, use the appropriate strictness level, and organize expectations for clear intent. Iterate on your mocks as your code evolves, favoring behavior and contract verification over internal implementation details.

---

## Additional Resources

- [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) — Recipes and examples for advanced mocking techniques.
- [Mocking Reference](https://google.github.io/googletest/reference/mocking.md) — Macro and class documentation.
- [Nice, Naggy, and Strict Mocks Guide](https://google.github.io/googletest/guides/mocking-advanced-techniques/nice-naggy-strict-mocks.html) — Understanding mock strictness levels.
- [Actions Reference](https://google.github.io/googletest/reference/actions.md) — Built-in actions and how to define your own.
- [Matchers Reference](https://google.github.io/googletest/reference/matchers.md) — Matchers to specify argument constraints.

For a comprehensive journey from beginner to advanced mock authoring, consult the [Mocking Advanced Techniques guides](https://google.github.io/googletest/guides/mocking-advanced-techniques/).

---

## Practical Tips

- Use `NiceMock` for mocks that may receive many uninteresting calls without cluttering test logs.
- Use `StrictMock` when you want to enforce the contract strictly and detect unexpected calls early.
- Prefer `ON_CALL` for default behaviors and `EXPECT_CALL` for calls you want to verify.
- For overloaded methods, mock all relevant overloads explicitly.
- To avoid confusion with sticky expectations, prefer `RetiresOnSaturation()` or use sequences.
- Use `SaveArg` or `SaveArgPointee` to verify complex arguments after calls.

---

This page exclusively covers patterns, practices, and recommendations for effective mocking to guide you toward writing maintainable and efficient tests using GoogleMock.