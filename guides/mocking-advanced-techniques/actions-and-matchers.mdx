---
title: "Actions and Matchers in Practice"
description: "Understand how to use and combine actions and matchers to write expressive mock expectations, simulate side effects, and validate complex argument patterns."
---

# Actions and Matchers in Practice

## Workflow Overview

### Task Description
This guide teaches you how to write expressive mock expectations in GoogleMock by combining **actions** and **matchers**. It helps you specify precisely how mock methods respond to calls, simulate side effects, and validate complex argument patterns.

### Prerequisites
- Basic understanding of GoogleMock and C++ mocking concepts.
- A mock class defined with `MOCK_METHOD` macros.
- GoogleTest and GoogleMock installed and set up in your environment.

### Expected Outcome
By following this guide, you will be able to:
- Construct accurate expectations using actions and argument matchers.
- Simulate return values, side effects, and complex behaviors.
- Validate function arguments with rich matcher expressions.
- Combine multiple actions for sophisticated mock behaviors.

### Time Estimate
Approximately 20-30 minutes to understand and practice the key techniques.

### Difficulty Level
Intermediate â€” assumes familiarity with GoogleMock basics.

---

## Step-by-Step Instructions

### 1. Writing Expectations with Matchers

Matchers define which arguments a mock method expects. They allow fine-grained validation beyond exact equality.

- Use `_` to allow any argument value.
- Use built-in matchers like `Eq()`, `Ge()`, `NotNull()`, etc., to specify constraints.

```cpp
using ::testing::_;
using ::testing::Eq;
using ::testing::Ge;

EXPECT_CALL(mock, DoThis(Eq(5)));    // Expect argument == 5
EXPECT_CALL(mock, DoThat(Ge(10)));   // Expect argument >= 10
EXPECT_CALL(mock, Foo(_, NotNull())); // First arg any, second arg non-null
```


### 2. Using Actions to Specify Mock Behavior

Actions define what a mock method should do when called. They can return values, modify arguments, invoke functions, or perform combined effects.

- Return a fixed value using `Return(value)`.
- Return references or values pointed to by pointers with `ReturnRef()` and `ReturnPointee()`.
- Set values for output arguments using `SetArgPointee<N>(value)`.
- Combine multiple actions using `DoAll(action1, action2, ..., actionN)`.
- Use lambdas/functors for custom actions with `Invoke()`.

```cpp
using ::testing::Return;
using ::testing::SetArgPointee;
using ::testing::DoAll;

EXPECT_CALL(mock, GetValue())
    .WillOnce(Return(42));  // Always returns 42

EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(5), Return(true)));

EXPECT_CALL(mock, Process(_)).WillOnce(Invoke([](int x) {
    // Custom logic here
    return x * 2;
}));
```

### 3. Combining Matchers and Actions for Flexible Behavior

- Use parameterized matchers and composite matchers to express complex argument constraints.

```cpp
using ::testing::AllOf;
using ::testing::Ne;
using ::testing::Lt;

EXPECT_CALL(mock, DoThis(AllOf(Ge(5), Ne(10))))  // Argument >= 5 and != 10
    .WillOnce(Return('a'));
```

- Validate multiple arguments as a tuple with `.With()` clause.

```cpp
EXPECT_CALL(mock, Func(_, _))
    .With(Lt())  // First argument less than the second
    .WillOnce(Return(true));
```

### 4. Setting Default Actions and Using ON_CALL

- Use `ON_CALL(mock, method(args))` to specify default behaviors without demanding calls.
- `ON_CALL` provides fallback actions when no expectations match.

```cpp
ON_CALL(mock, GetValue())
    .WillByDefault(Return(-1));  // Default return value
```

### 5. Controlling Call Counts and Sequencing

- Control how many times a method is called using `.Times()` clause with built-in cardinalities like `AtLeast()`, `Exactly()`, `AnyNumber()`.

```cpp
EXPECT_CALL(mock, DoThis(_)).Times(2);  // Expect 2 calls
```

- Enforce call order with `InSequence` or `.InSequence()`.

```cpp
{
  ::testing::InSequence seq;
  EXPECT_CALL(mock, FirstCall());
  EXPECT_CALL(mock, SecondCall());
}
```

### 6. Handling Side Effects

- Use actions like `SetArgPointee<N>()` to simulate modifying output arguments.
- Use `InvokeArgument<N>(args...)` to call callback arguments passed into the mock method.

```cpp
EXPECT_CALL(mock, Mutate(_, _))
    .WillOnce(SetArgPointee<1>(10));  // Sets second arg pointed value to 10

EXPECT_CALL(mock, RegisterCallback(_))
    .WillOnce(InvokeArgument<0>(42));  // Invoke the first argument as a callback
```

### 7. Verifying Complex Arguments

- To debug complex argument matching, save arguments using `SaveArg<N>(&destination)` and later verify them explicitly.

```cpp
std::vector<int> actual_vec;
EXPECT_CALL(mock, SendVector(_))
    .WillOnce(testing::SaveArg<0>(&actual_vec));
// After test run
EXPECT_THAT(actual_vec, ElementsAre(1, 2, 3));
```

---

## Examples & Code Samples

### Mocking a Method that Returns a Reference

```cpp
class MockFoo : public Foo {
 public:
  MOCK_METHOD(Bar&, GetBar, (), (override));
};

Bar bar_instance;
EXPECT_CALL(mock_foo, GetBar())
    .WillOnce(ReturnRef(bar_instance));
```

### Combining Multiple Actions

```cpp
EXPECT_CALL(mock, Update(_, _))
    .WillOnce(DoAll(SetArgPointee<1>(100), Return(true)));
```
This sets the second argument's pointed value to 100 and returns true.

### Using Lambdas as Actions

```cpp
EXPECT_CALL(mock, Calculate(_))
    .WillOnce([](int x) { return x * x; });
```

### Matching Complex Argument Patterns

```cpp
EXPECT_CALL(mock, Process(AllOf(Ge(0), Lt(10))))
    .WillOnce(Return(true));
```

### Using InvokeArgument to Call a Callback Argument

```cpp
EXPECT_CALL(mock, RegisterCallback(_))
    .WillOnce(InvokeArgument<0>(5));  // Calls callback with argument 5
```

### Ignoring Uninteresting Arguments

```cpp
EXPECT_CALL(mock, Process).Times(2);  // Ignore arguments, expect 2 calls
```

### Using `.With()` to Validate Multiple Arguments as a Whole

```cpp
EXPECT_CALL(mock, Compare(_, _))
  .With(Lt())  // First arg < second arg
  .WillOnce(Return(true));
```

---

## Troubleshooting & Tips

### Common Issues

- **Uninteresting calls warning:** If you see warnings that mock methods without `EXPECT_CALL` got called, either add proper expectations or use `NiceMock` to suppress warnings.
- **Overly rigid tests:** Avoid over-specifying matchers to prevent brittle tests that break after harmless code changes.
- **Method overload ambiguity:** Use specific matchers like `Const()` or type wrappers like `TypedEq<T>()` to disambiguate overloaded methods.
- **Reference return misuse:** Use `ReturnRef()` for mock methods returning references, not `Return()`.

### Best Practices

- Default to using `ON_CALL` for setting behaviors and `EXPECT_CALL` only when verifying calls.
- Define concise matchers that express intent clearly without over-specifying.
- Use `InSequence` to enforce call order only when necessary.
- Combine multiple actions with `DoAll()` when simulating complex behaviors.
- Use `SaveArg` to capture arguments for detailed validation.

### Performance Considerations

- Move mock class constructors and destructors to `.cc` files if compilation is slow.

### Alternative Approaches

- When mocking non-virtual methods, consider dependency injection templated by the mock type.
- Delegate mock default behaviors to fake or real objects when appropriate.

---

## Next Steps & Related Content

- Expand your knowledge by reading **Intro to Mocking with GoogleMock** to solidify mock class creation.
- Review **Matchers Reference** for a comprehensive list of argument matchers.
- Explore **Actions Reference** for the full suite of built-in actions.
- Use **Nice, Naggy, and Strict Mocks** to manage uninteresting calls rigorously.
- Apply **Mocking Best Practices & Patterns** for maintainable and robust unit tests.

---

## References

- [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) - Beginner-friendly introduction.
- [GoogleMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) - Practical recipes.
- [Matchers Reference](reference/matchers.md) - Full details on matchers.
- [Actions Reference](docs/reference/actions.md) - In-depth actions guide.
- [Mocking Reference](docs/reference/mocking.md) - GoogleMock macros, classes, and clauses.
- [Nice, Naggy, and Strict Mocks](guides/mocking-advanced-techniques/nice-naggy-strict-mocks)

---

## Summary

This documentation page provides a practical, user-focused guide to creating expressive mock expectations by combining actions and matchers in GoogleMock. It empowers you to simulate complex method behaviors, validate intricate argument patterns, and control mock method call expectations and side effects efficiently. The guide embraces examples, best practices, and troubleshooting advice to ensure users can confidently write maintainable and effective mock-based tests.