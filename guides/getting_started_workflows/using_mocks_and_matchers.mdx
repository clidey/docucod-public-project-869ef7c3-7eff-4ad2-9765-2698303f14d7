---
title: "Using Mocks and Matchers"
description: "Step-by-step guidance for employing GoogleMock to create mocks, set expectations, and use matchers in real-world scenarios, helping users simulate dependencies and verify interactions accurately."
---

# Using Mocks and Matchers

This guide provides practical, step-by-step instructions on how to use GoogleMock to create mock classes, define expectations, and employ matchers to simulate dependencies and verify interactions effectively. Whether you're new to mocking or want to deepen your mastery, this page focuses on the precise workflow and real-world scenarios that help you get the most from GoogleMock.

---

## 1. Workflow Overview

### What You Will Achieve

You will learn how to:
- Define mock classes using `MOCK_METHOD` macros.
- Configure behavior and expectations on mock objects.
- Use argument matchers to specify the criteria for method calls.
- Control invocation order and cardinality.
- Delegate default behaviors and handle complex scenarios.

### Prerequisites

You should have:
- A working C++ environment with GoogleMock installed.
- A basic understanding of virtual methods and C++ testing.
- Familiarity with writing simple GoogleTest unit tests.

### Expected Outcome

By following this guide, you will:
- Create flexible mock classes to replace real dependencies.
- Write precise expectations that verify correct interactions.
- Use matchers to finely control argument matching.
- Avoid common pitfalls and debugging headaches.

### Time Estimate

30-45 minutes, depending on your prior familiarity.

### Difficulty Level

Intermediate beginner â€” no advanced C++ knowledge required, but some experience with unit testing and mocks beneficial.

---

## 2. Defining Mock Classes

To start using mocks in GoogleMock, you create a mock class deriving from the interface or base class you want to mock.

### Essential Steps

1. **Include gMock header:**
    ```cpp
    #include <gmock/gmock.h>
    ```
2. **Declare mock class deriving from interface:**
    ```cpp
    class MockFoo : public Foo {
     public:
      MOCK_METHOD(ReturnType, MethodName, (Args...), (Specs...));
    };
    ```
3. **Use the `MOCK_METHOD` macro carefully:**
    - Put mock methods always under `public:`.
    - If your base method is `const` or has qualifiers, add `(const)`, `(override)`, `(noexcept)`, or other qualifiers in the 4th parameter.

### Handling Special Cases

- **Commas in types:** Wrap types with commas in parentheses or use type aliases:
    ```cpp
    // Wrap in parentheses
    MOCK_METHOD((std::pair<bool,int>), GetPair, ());

    // Or use alias
    using BoolIntPair = std::pair<bool,int>;
    MOCK_METHOD(BoolIntPair, GetPair, ());
    ```
- **Mocking overloaded methods:** Declare mocks for each overload with correct signatures and qualifiers.

### Example

```cpp
class Foo {
 public:
  virtual ~Foo() {}
  virtual int GetSize() const = 0;
  virtual std::string Describe(const char* name) = 0;
  virtual bool Process(Bar elem, int count) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetSize, (), (const, override));
  MOCK_METHOD(std::string, Describe, (const char* name), (override));
  MOCK_METHOD(bool, Process, (Bar elem, int count), (override));
};
```

---

## 3. Creating and Using Mock Objects

Once you have defined mock classes, you create mock objects in your tests and specify their behavior.

### Step-by-Step

1. **Create a mock object:**

    ```cpp
    MockFoo mock_foo;
    ```

2. **Optionally specify default behaviors with `ON_CALL`:**

    - Defines mock behavior but does *not* set expectations.
    - Useful for common default behavior shared between tests.

    ```cpp
    ON_CALL(mock_foo, GetSize())
        .WillByDefault(Return(10));
    ```

3. **Set expectations with `EXPECT_CALL`:**

    - Define *how* and *when* mock methods are expected to be called.

    ```cpp
    EXPECT_CALL(mock_foo, Process(_, 5))
        .Times(1)
        .WillOnce(Return(true));
    ```

4. **Exercise code under test:**

    The tested code calls the mock object's methods and the mock verifies the expected interactions.

5. **Automatic verification:**

    When the mock object destructs at the end of the test, it verifies all expectations are met.

### Using Nice, Naggy, and Strict Mocks

- `NiceMock<MockFoo>` suppresses warnings on uninteresting calls (default behavior ignored methods).
- `NaggyMock<MockFoo>` (default mock) warns on unexpected calls but lets tests continue.
- `StrictMock<MockFoo>` treats unexpected calls as failures.

Example of using a NiceMock:

```cpp
using ::testing::NiceMock;
NiceMock<MockFoo> mock_foo;
EXPECT_CALL(mock_foo, GetSize()).WillOnce(Return(20));
...
```

### Tip

Always define expectations **before** exercising the code. Setting expectations after calling methods leads to undefined behavior.

---

## 4. Setting Expectations with `EXPECT_CALL`

This is the core of mock behavior specification and verification.

### Syntax

```cpp
EXPECT_CALL(mock_object, MethodName(matchers...))
    .Times(cardinality)
    .WillOnce(action)
    .WillRepeatedly(action);
```

- `matchers...` specifies argument match criteria.
- `.Times()` controls how many times the method is expected to be called.
- `.WillOnce()` and `.WillRepeatedly()` specify the behavior.

### Matchers

- Use `_` as a wildcard matcher matching any argument value.
- Use built-in matchers like `Eq()`, `Ge()`, `Lt()`, `NotNull()`, `Pointee()`, and more to write specific constraints.
- Combine matchers with `AllOf()`, `AnyOf()`, `Not()`, etc.

### Cardinalities

Control call count with:

| Cardinality    | Meaning                            |
| -------------- | -------------------------------- |
| `Exactly(n)`   | Called exactly `n` times           |
| `AtLeast(n)`   | Called at least `n` times          |
| `AtMost(n)`    | Called at most `n` times           |
| `Between(m,n)` | Called between `m` and `n` times   |
| `AnyNumber()`  | Called zero or more times          |

Default if omitted: inferred from `.WillOnce()` and `.WillRepeatedly()`

### Actions

- Return a value with `Return(value)`.
- Return a reference with `ReturnRef(variable)`.
- Perform side effects with `SetArgPointee<N>(value)`, `Invoke()`, lambdas, or custom actions.
- Chain actions with `DoAll()`.

### Order and Sequences

- Use `InSequence` or `.InSequence(seq)` to enforce expected call order.
- Use `.After(expectation)` to specify execution order after other specific calls.
- Expectations are matched in reverse order of specification; more recent override prior ones.

### Example

```cpp
using ::testing::Return;
using ::testing::_;
using ::testing::InSequence;

MockFoo mock_foo;

{
  InSequence seq;  // Enforce order of calls inside this scope

  EXPECT_CALL(mock_foo, GetSize())
      .WillOnce(Return(5))
      .RetiresOnSaturation();
  EXPECT_CALL(mock_foo, Process(_, 10))
      .Times(2)
      .WillRepeatedly(Return(true));
}

// ... exercise code using mock_foo ...
```

---

## 5. Using Matchers for Argument Validation

Matchers control how argument values are checked.

### Common Matchers

| Matcher           | Description                   |
|-------------------|-------------------------------|
| `_`               | Matches anything              |
| `Eq(val)`         | Matches value equal to `val`  |
| `Ne(val)`         | Not equal to                  |
| `Lt(val)`, `Le(val)`, `Gt(val)`, `Ge(val)` | Less/greater comparisons |
| `Not(matcher)`    | Negation of matcher            |
| `Pointee(matcher)`| Value pointed to matches matcher|
| `Field(&member, matcher)` | Matches member field        |
| `Property(&getter, matcher)` | Matches getter return value |

### Matching Tuples and Multiple Arguments

- Use `.With()` to specify conditions involving multiple arguments as a whole tuple.
- Use `AllArgs(matcher)` or `Args<indices>(matcher)` for fine-grained control.

Example for matching related argument values:

```cpp
EXPECT_CALL(mock, Func(_, _))
    .With(::testing::Lt());
// Expect the first argument < second argument
```

---

## 6. Common Patterns and Best Practices

### Simplifying Complex Interfaces

You can create helper mock methods with trimmed argument lists and delegate calls from complex overloads to them. This simplifies expectations usage.

### Delegating to Real or Fake Objects

In cases where a mock only partially mocks behavior, delegate default actions to existing real or fake implementations with `ON_CALL`.

### Using NiceMock, StrictMock, NaggyMock

Choose the appropriate mock strictness:
- **NiceMock:** Suppresses warnings about uninteresting calls.
- **StrictMock:** Makes uninteresting calls failures.
- **NaggyMock:** Default, warns on uninteresting calls but continues.

### Retiring Expectations

Use `.RetiresOnSaturation()` when you want expectations to cease matching after their upper call limit is reached, avoiding sticky expectation errors.

### Using `ON_CALL` Effectively

Set default behaviors for mock methods without setting expectations. Use `ON_CALL` in test setup or constructors to prepare mocks before setting selective `EXPECT_CALL`s.

### Avoid Over-specification

Write only the necessary expectations to avoid brittle tests that break on harmless changes.

---

## 7. Troubleshooting

### Common Issues

- **Expectations Not Met:** Run tests with `--gmock_verbose=info` to trace mock calls.
- **Unexpected Calls:** Verify that your `EXPECT_CALL`s cover all intended calls.
- **Too Many or Too Few Actions:** Check that `.WillOnce()` and `.WillRepeatedly()` match `.Times()` cardinality.
- **Uninteresting Calls Warning:** Use `NiceMock` or add catch-all expectations with `_` and `.Times(AnyNumber())`.
- **Compilation Errors on Commas:** Wrap complex type parameters in parentheses or use type aliases with `MOCK_METHOD`.
- **Virtual Destructor Missing:** Ensure interfaces have virtual destructors to avoid leaks and undefined behavior.

### Verification and Clear

You can manually verify and clear expectations as needed with:

```cpp
EXPECT_TRUE(::testing::Mock::VerifyAndClearExpectations(&mock_obj));
EXPECT_TRUE(::testing::Mock::VerifyAndClear(&mock_obj));
```

Avoid adding expectations after verification or exercising the mock.

### Debugging Order and Match Failures

- Use sequences (`InSequence`) or `.After()` to enforce call ordering.
- Check argument matchers closely for mismatches.

---

## 8. Practical Examples

### Basic Mock Definition and Test

```cpp
class Foo {
 public:
  virtual int GetValue() const = 0;
  virtual void SetValue(int v) = 0;
};

class MockFoo : public Foo {
 public:
  MOCK_METHOD(int, GetValue, (), (const, override));
  MOCK_METHOD(void, SetValue, (int v), (override));
};

TEST(FooTest, BasicUsage) {
  MockFoo mock;

  ON_CALL(mock, GetValue()).WillByDefault(Return(42));
  EXPECT_CALL(mock, SetValue(5)).Times(1);

  // Code under test uses mock
  mock.SetValue(5);
  EXPECT_EQ(mock.GetValue(), 42);
}
```

### Using Matchers and Multiple Expectations

```cpp
using ::testing::_;
using ::testing::Gt;
using ::testing::Return;

EXPECT_CALL(mock, SetValue(Gt(0)))
    .Times(2)
    .WillRepeatedly(Return());
EXPECT_CALL(mock, GetValue())
    .Times(AtLeast(1))
    .WillOnce(Return(10))
    .WillRepeatedly(Return(20));

// The mock expects SetValue called with values > 0 twice
// GetValue returns 10 once, then 20 subsequently.
```

### InSequence Example

```cpp
{
  InSequence s;
  EXPECT_CALL(mock, SetValue(1));
  EXPECT_CALL(mock, SetValue(2));
  EXPECT_CALL(mock, SetValue(3));
}

// Calls must happen in the specified order.
```

### Retiring On Saturation

```cpp
EXPECT_CALL(mock, SetValue(100))
    .Times(2)
    .RetiresOnSaturation();
EXPECT_CALL(mock, SetValue(_))
    .Times(AnyNumber());

// The first two calls with argument 100 will match the first expectation,
// which retires after saturation. Subsequent calls to SetValue with 100
// are caught by the catch-all expectation.
```

---

## 9. Next Steps & Related Content

- Explore the [gMock Cookbook](https://google.github.io/googletest/gmock_cook_book.html) for recipes and live examples.
- Review the [Matchers Reference](https://google.github.io/googletest/reference/matchers.html) for detailed matcher capabilities.
- Study the [Mocking Reference](https://google.github.io/googletest/reference/mocking.html) for full macro and class documentation.
- Read the [gMock for Dummies](https://google.github.io/googletest/gmock_for_dummies.html) for an approachable introduction.
- Combine with the [Basic Test Workflow Guide](https://google.github.io/googletest/guides/basic_test_workflow.html) for full test development.

---

<Tip>
Using `NiceMock` helps reduce noisy warnings during early test development.
Ensure virtual destructors are declared to prevent memory leaks.
Always set expectations before exercising mock methods.
</Tip>

<Note>
Use `.RetiresOnSaturation()` to prevent sticky expectations causing spurious failures.
</Note>

<Warning>
Avoid setting expectations after code under test has called the mocks; this leads to undefined behavior.
</Warning>

